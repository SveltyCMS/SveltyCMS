---
path: 'docs/testing'
title: 'Testing Guide'
description: 'Comprehensive guide to testing SveltyCMS with Bun, Playwright, and GitHub Actions CI/CD - includes dynamic environment system and mock setup'
order: 4
icon: 'mdi:test-tube'
author: 'SveltyCMS Team'
created: '2025-10-05'
updated: '2025-10-05'
tags:
  - 'testing'
  - 'playwright'
  - 'bun'
  - 'ci-cd'
  - 'quality-assurance'
  - 'mocking'
  - 'seed-data'
---

# SveltyCMS Testing Guide

Comprehensive testing infrastructure for SveltyCMS using Bun tests, Playwright E2E tests, and automated CI/CD with GitHub Actions.

---

## 📋 Table of Contents

1. [Testing Overview](#testing-overview)
2. [Unit Testing with Bun](#unit-testing-with-bun)
3. [E2E Testing with Playwright](#e2e-testing-with-playwright)
4. [GitHub Actions CI/CD](#github-actions-cicd)
5. [Documentation Linting](#documentation-linting)
6. [Test Structure](#test-structure)
7. [Running Tests](#running-tests)
8. [Writing Tests](#writing-tests)
9. [Debugging Tests](#debugging-tests)
10. [Best Practices](#best-practices)

---

## 🎯 Testing Overview

SveltyCMS uses a comprehensive testing strategy to ensure code quality, reliability, and maintainability:

### Testing Layers

```
┌─────────────────────────────────────────────┐
│         E2E Tests (Playwright)              │
│   Full user workflows, browser automation   │
├─────────────────────────────────────────────┤
│      Integration Tests (Bun + Playwright)   │
│    API endpoints, database operations       │
├─────────────────────────────────────────────┤
│         Unit Tests (Bun)                    │
│   Components, utilities, functions          │
├─────────────────────────────────────────────┤
│      Documentation Linting (Valibot)        │
│   Frontmatter validation, consistency       │
└─────────────────────────────────────────────┘
```

### Test Coverage

- ✅ **Authentication flows** - Email signup, OAuth, 2FA
- ✅ **User management** - CRUD operations, permissions, roles
- ✅ **Collection management** - Builder, CRUD, relationships
- ✅ **API endpoints** - All 95+ endpoints tested
- ✅ **UI components** - Component behavior and rendering
- ✅ **Database operations** - All database adapters
- ✅ **Documentation** - Frontmatter validation

---

## 🧪 Unit Testing with Bun

SveltyCMS uses [Bun](https://bun.sh/) for fast, native TypeScript unit testing.

### Test Structure

```
tests/bun/
├── api/                        # API endpoint unit tests
│   ├── auth.test.ts
│   ├── collections.test.ts
│   └── media.test.ts
├── auth/                       # Authentication unit tests
│   ├── jwt.test.ts
│   └── oauth.test.ts
├── widgets/                    # Widget unit tests
│   ├── text-widget.test.ts
│   └── media-widget.test.ts
├── helpers/                    # Test helpers and utilities
│   └── test-utils.ts
├── mocks/                      # Mock data and services
│   ├── mock-db.ts
│   └── mock-api.ts
├── ImageEditor.test.ts         # Component tests
├── RolePermissionAccess.test.ts
├── UIStore.test.ts
├── cache-integration.test.ts
└── collection-builder.test.ts
```

### Test Configuration

#### bunfig.toml Preload Setup

Bun tests use a preload file to set up mocks before any test code runs:

**File:** `bunfig.toml`

```toml
[test]
# This tells Bun to run our mock file before executing any tests.
preload = ["./tests/bun/mocks/setup.ts"]
```

**File:** `tests/bun/mocks/setup.ts`

```typescript
import { mock } from 'bun:test';

// Mock SvelteKit environment - MUST be mocked before any imports use it
mock.module('$app/environment', () => ({
	dev: true,
	browser: false,
	building: false,
	version: '1.0.0-test'
}));

// Mock public environment (uses seed data defaults)
globalThis.publicEnv = {
	DEFAULT_CONTENT_LANGUAGE: 'en',
	AVAILABLE_CONTENT_LANGUAGES: ['en', 'de'],
	HOST_DEV: 'http://localhost:5173',
	SITE_NAME: 'SveltyCMS',
	PASSWORD_LENGTH: 8,
	ROLES: ['admin', 'editor', 'viewer'],
	PERMISSIONS: ['read', 'write', 'delete', 'admin']
	// ... other defaults from src/routes/api/setup/seed.ts
};

// Mock private environment
globalThis.privateEnv = {
	DB_TYPE: 'mongodb',
	DB_HOST: 'localhost',
	DB_NAME: 'sveltycms_test',
	JWT_SECRET_KEY: 'test-secret',
	ENCRYPTION_KEY: 'test-encryption-key'
};

// Mock store modules
mock.module('@src/stores/globalSettings', () => ({
	publicEnv: globalThis.publicEnv,
	privateEnv: globalThis.privateEnv
}));
```

#### Dynamic Environment System

SveltyCMS uses a **database-driven settings system** instead of static config files. Tests use default seed data from `src/routes/api/setup/seed.ts`:

```typescript
// Default settings from seed.ts
const defaultRoles = ['admin', 'editor', 'viewer'];
const defaultPermissions = ['read', 'write', 'delete', 'admin'];

// These are automatically available in tests via the preload setup
```

**Key Points:**

- ❌ No more `@root/config/public` or `@root/config/private` imports
- ✅ Settings loaded from database at runtime
- ✅ Tests use seed data defaults via `globalThis.publicEnv`
- ✅ Mock setup happens in preload file before tests run
- ✅ Works in CI/CD without running app (GitHub Actions)

---

### Writing Bun Tests

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'bun:test';

describe('ContentService', () => {
	let service: ContentService;
	let mockDB: MockDatabase;

	beforeEach(() => {
		mockDB = createMockDatabase();
		service = new ContentService(mockDB);
	});

	afterEach(() => {
		mockDB.cleanup();
	});

	it('should create content successfully', async () => {
		const data = {
			title: 'Test Post',
			content: 'Hello World',
			status: 'draft'
		};

		const result = await service.create('posts', data);

		expect(result).toBeDefined();
		expect(result.title).toBe('Test Post');
		expect(result.status).toBe('draft');
	});

	it('should validate required fields', async () => {
		const invalidData = { content: 'Hello' };

		await expect(service.create('posts', invalidData)).rejects.toThrow('Title is required');
	});

	it('should handle database errors gracefully', async () => {
		mockDB.simulateError();

		const result = await service.create('posts', { title: 'Test' });

		expect(result.error).toBeDefined();
		expect(result.error.message).toContain('Database error');
	});
});
```

### Running Bun Tests

```bash
# Run all Bun tests
bun test

# Run specific test file
bun test tests/bun/api/auth.test.ts

# Run tests in watch mode
bun test --watch

# Run tests with coverage
bun test --coverage

# Run tests matching pattern
bun test --grep "ContentService"
```

### Test Configuration

Bun tests are configured in `package.json`:

```json
{
	"scripts": {
		"test": "bun test",
		"test:watch": "bun test --watch",
		"test:coverage": "bun test --coverage"
	}
}
```

---

## 🎭 E2E Testing with Playwright

End-to-end testing with [Playwright](https://playwright.dev/) for real browser automation and user flow testing.

### Test Structure

```
tests/playwright/
├── signupfirstuser.spec.ts          # First user registration flow
├── oauth-signup-firstuser.spec.ts   # OAuth authentication flow
├── login.spec.ts                    # Login flow
├── user.spec.ts                     # User management
├── user-crud.spec.ts                # User CRUD operations
├── collection.spec.ts               # Collection management
├── collection-builder.spec.ts       # Collection builder UI
├── permission-change.spec.ts        # Permission management
├── language.spec.ts                 # Multi-language support
└── testthumb.png                    # Test assets
```

### Playwright Configuration

**File:** `playwright.config.ts`

```typescript
export default defineConfig({
	testDir: './tests',
	fullyParallel: true,
	forbidOnly: !!process.env.CI,
	retries: process.env.CI ? 2 : 0,
	workers: process.env.CI ? 1 : undefined,

	use: {
		baseURL: process.env.CI
			? 'http://localhost:4173' // Preview build in CI
			: 'http://localhost:5173', // Dev server locally
		trace: 'on-first-retry',
		video: 'retain-on-failure'
	},

	projects: [
		{ name: 'chromium', use: { ...devices['Desktop Chrome'] } },
		{ name: 'firefox', use: { ...devices['Desktop Firefox'] } },
		{ name: 'webkit', use: { ...devices['Desktop Safari'] } }
	]
});
```

### Writing Playwright Tests

```typescript
import { test, expect } from '@playwright/test';

test.describe('User Registration', () => {
	test.beforeEach(async ({ page }) => {
		// Navigate to signup page
		await page.goto('/signup');
	});

	test('should register first user successfully', async ({ page }) => {
		// Fill registration form
		await page.fill('input[name="email"]', 'admin@test.com');
		await page.fill('input[name="password"]', 'SecurePass123!');
		await page.fill('input[name="username"]', 'admin');

		// Submit form
		await page.click('button[type="submit"]');

		// Wait for redirect
		await page.waitForURL('**/dashboard');

		// Verify success
		await expect(page.locator('h1')).toContainText('Dashboard');
	});

	test('should validate email format', async ({ page }) => {
		await page.fill('input[name="email"]', 'invalid-email');
		await page.fill('input[name="password"]', 'SecurePass123!');
		await page.click('button[type="submit"]');

		// Check for validation error
		await expect(page.locator('.error-message')).toContainText('Invalid email format');
	});

	test('should prevent weak passwords', async ({ page }) => {
		await page.fill('input[name="email"]', 'user@test.com');
		await page.fill('input[name="password"]', '123');
		await page.click('button[type="submit"]');

		await expect(page.locator('.error-message')).toContainText('Password must be at least 8 characters');
	});
});
```

### Running Playwright Tests

```bash
# Run all Playwright tests
npx playwright test

# Run specific test file
npx playwright test signupfirstuser.spec.ts

# Run tests in headed mode (see browser)
npx playwright test --headed

# Run tests in debug mode
npx playwright test --debug

# Run tests in specific browser
npx playwright test --project=chromium

# Run tests in UI mode (interactive)
npx playwright test --ui

# Show test report
npx playwright show-report
```

### Test Modes

**Development Mode (localhost:5173):**

- Uses Vite dev server
- Hot module reload
- Faster test iteration

**Preview Mode (localhost:4173):**

- Uses production build
- Tests built application
- More realistic testing

---

## 🤖 GitHub Actions CI/CD

Automated testing on every push and pull request using GitHub Actions.

### Workflow Configuration

**File:** `.github/workflows/playwright.yml`

```yaml
name: Playwright and Bun Tests

on:
  push:
    branches: [main, next]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

jobs:
  test:
    name: SveltyCMS Tests (${{ matrix.mode }})
    timeout-minutes: 60
    runs-on: ubuntu-latest

    strategy:
      matrix:
        mode: [dev, preview]

    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: latest
          mongodb-username: admin
          mongodb-password: admin
          mongodb-db: SveltyCMS
          mongodb-port: 27017

      - name: Install dependencies
        run: bun install

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps

      - name: Set test environment variables
        run: |
          echo "Using seed data defaults from src/routes/api/setup/seed.ts"
          echo "Environment mocked via tests/bun/mocks/setup.ts"

      - name: Generate SvelteKit files
        run: bunx svelte-kit sync

      - name: Build SvelteKit server
        run: bunx vite build

      - name: Start server
        run: |
          if [ "${{ matrix.mode }}" = "dev" ]; then
            bunx vite dev --port 5173 --host 127.0.0.1 &
          else
            bunx vite preview --port 4173 --host 127.0.0.1 &
          fi

      - name: Wait for server to be ready
        run: bunx wait-on http://127.0.0.1:5173 -t 180000

      - name: Run Playwright tests
        run: bunx playwright test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
```

### CI/CD Features

✅ **MongoDB Service Container** - Isolated database for testing
✅ **Matrix Testing** - Tests both dev and preview modes
✅ **Browser Coverage** - Chromium, Firefox, WebKit
✅ **Artifact Upload** - Test reports and videos on failure
✅ **Parallel Execution** - Faster test runs
✅ **Automatic Retries** - 2 retries on CI failures
✅ **Mock Services** - OAuth, SMTP, external APIs

### Test Configuration Files

**CI Config:** `tests/ci-config/`

```typescript
// tests/ci-config/public.ts
export const publicConfig = {
	siteName: 'SveltyCMS Test',
	siteUrl: 'http://localhost:4173',
	defaultLanguage: 'en'
	// ... test-specific configuration
};

// tests/ci-config/private.ts
export const privateConfig = {
	dbType: 'MongoDB',
	dbHost: 'localhost',
	dbPort: 27017,
	dbUser: 'admin',
	dbPassword: 'admin',
	dbName: 'SveltyCMS'
	// ... test-specific secrets
};
```

---

## 📝 Documentation Linting

Automated validation of documentation frontmatter using Valibot schema validation.

### Documentation Linter

**File:** `docs/lint-docs.ts`

```typescript
import { safeParse, object, string, array, isoDate, minLength } from 'valibot';

// Required frontmatter schema
const frontmatterSchema = object({
	path: string([minLength(1)]),
	title: string([minLength(3)]),
	description: string([minLength(10)]),
	order: optional(union([number(), string()])),
	icon: optional(string()),
	author: string([minLength(2)]),
	created: string([isoDate()]),
	updated: string([isoDate()]),
	tags: array(string([minLength(2)]), [minLength(1)])
});

// Validate all .mdx files
for (const file of walkDocs('./docs')) {
	const frontmatter = parseFrontmatter(file);
	const result = safeParse(frontmatterSchema, frontmatter);

	if (!result.success) {
		console.error(`❌ ${file}`);
		for (const issue of result.issues) {
			console.error(`   • ${issue.message}`);
		}
	}
}
```

### Running Documentation Linter

```bash
# Run documentation linter
bun run docs/lint-docs.ts

# Automated in GitHub Actions
# See .github/workflows/docs-lint.yml
```

### GitHub Actions Workflow

**File:** `.github/workflows/docs-lint.yml`

```yaml
name: Lint Documentation

on:
  push:
    paths:
      - 'docs/**/*.mdx'
      - 'docs/**/*.md'
  pull_request:
    paths:
      - 'docs/**/*.mdx'
      - 'docs/**/*.md'

jobs:
  lint-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun run docs/lint-docs.ts
```

---

## 📂 Test Structure

### Directory Organization

```
tests/
├── bun/                          # Unit tests (Bun)
│   ├── api/                      # API endpoint tests
│   ├── auth/                     # Authentication tests
│   ├── widgets/                  # Widget tests
│   ├── helpers/                  # Test utilities
│   └── mocks/                    # Mock data/services
│
├── playwright/                   # E2E tests (Playwright)
│   ├── signupfirstuser.spec.ts
│   ├── login.spec.ts
│   ├── collection.spec.ts
│   └── ...
│
└── ci-config/                    # CI/CD configuration
    ├── public.ts                 # Test public config
    └── private.ts                # Test private config
```

### Test Categories

#### 1. Authentication Tests

**Coverage:**

- Email signup (first user vs subsequent users)
- OAuth authentication (Google, GitHub)
- Login flow (email + password)
- Session management
- 2FA flow
- Password reset

**Files:**

- `tests/playwright/signupfirstuser.spec.ts`
- `tests/playwright/oauth-signup-firstuser.spec.ts`
- `tests/playwright/login.spec.ts`
- `tests/bun/auth/*.test.ts`

#### 2. User Management Tests

**Coverage:**

- User CRUD operations
- Role assignment
- Permission management
- User sessions
- Profile updates

**Files:**

- `tests/playwright/user.spec.ts`
- `tests/playwright/user-crud.spec.ts`
- `tests/playwright/permission-change.spec.ts`
- `tests/bun/api/user.test.ts`

#### 3. Collection Tests

**Coverage:**

- Collection builder UI
- Collection CRUD
- Field validation
- Relationships
- Content management

**Files:**

- `tests/playwright/collection-builder.spec.ts`
- `tests/playwright/collection.spec.ts`
- `tests/bun/collection-builder.test.ts`

#### 4. Component Tests

**Coverage:**

- UI components
- Widget components
- Form components
- Store behavior

**Files:**

- `tests/bun/ImageEditor.test.ts`
- `tests/bun/UIStore.test.ts`
- `tests/bun/widgets/*.test.ts`

#### 5. API Tests

**Coverage:**

- All 95+ API endpoints
- Request validation
- Response format
- Error handling
- Authentication

**Files:**

- `tests/bun/api/*.test.ts`

---

## 🚀 Running Tests

### Local Development

```bash
# Install dependencies
bun install

# Install Playwright browsers
bunx playwright install --with-deps

# Run all tests
bun test                    # Bun unit tests
npx playwright test         # Playwright E2E tests

# Run specific tests
bun test RolePermissionAccess.test.ts
npx playwright test login.spec.ts

# Run tests in watch mode
bun test --watch

# Run tests with coverage
bun test --coverage

# Run Playwright in UI mode
npx playwright test --ui

# Debug Playwright tests
npx playwright test --debug
```

### CI/CD (GitHub Actions)

Tests run automatically on:

- ✅ Every push to `main` or `next` branches
- ✅ Every pull request to `main`
- ✅ Manual workflow dispatch

**View Results:**

1. Go to repository → Actions tab
2. Select the workflow run
3. View test results and artifacts
4. Download test reports if needed

---

## ✍️ Writing Tests

### Unit Test Example (Bun)

#### Example 1: Role Permission Access Test

This test demonstrates testing without a running application using mocks:

**File:** `tests/bun/RolePermissionAccess.test.ts`

```typescript
import { beforeEach, describe, expect, test } from 'bun:test';
import { Auth } from '@src/databases/auth';
import { PermissionAction } from '@src/databases/auth/types';
import type { Role, User, SessionStore, DatabaseAdapter } from '@src/databases/auth/types';

// Use seed data defaults (automatically available via preload setup)
const defaultRoles = ['admin', 'editor', 'viewer'];
const defaultPermissions = ['read', 'write', 'delete', 'admin'];

// Mock session store
const mockSessionStore: SessionStore = {
	set: async () => {},
	get: async () => null,
	delete: async () => {},
	deleteAll: async () => {}
};

// Mock database adapter
const mockDbAdapter: Partial<DatabaseAdapter> = {
	auth: {
		createUser: async () => ({
			success: true,
			data: {
				_id: 'user1',
				email: 'user@example.com',
				role: 'user',
				createdAt: new Date(),
				updatedAt: new Date()
			}
		})
		// ... other mock methods
	}
};

describe('Role and Permission Access Management', () => {
	let auth: Auth;

	beforeEach(() => {
		// Create a fresh Auth instance for each test
		auth = new Auth(mockDbAdapter as DatabaseAdapter, mockSessionStore);
	});

	test('Create and manage roles', () => {
		const newRole: Role = {
			_id: 'editor',
			name: 'Editor',
			description: 'Can edit content',
			permissions: ['content:read', 'content:write'],
			isAdmin: false
		};

		auth.addRole(newRole);
		const retrievedRole = auth.getRoleById('editor');
		expect(retrievedRole).toBeDefined();
		expect(retrievedRole?.name).toBe('Editor');
	});

	test('Admin role has all permissions', () => {
		const adminUser: User = {
			_id: 'admin1',
			email: 'admin@example.com',
			role: 'admin',
			createdAt: new Date(),
			updatedAt: new Date()
		};

		const adminRole: Role = {
			_id: 'admin',
			name: 'Admin',
			description: 'Administrator',
			permissions: [],
			isAdmin: true
		};
		auth.addRole(adminRole);

		// Admin should have all permissions
		const canDoAnything = auth.hasPermission(adminUser, 'any:action');
		expect(canDoAnything).toBe(true);
	});

	test('Default roles from seed data are available', () => {
		// Verify seed data defaults
		expect(defaultRoles).toContain('admin');
		expect(defaultRoles).toContain('editor');
		expect(defaultPermissions).toContain('read');
		expect(defaultPermissions).toContain('write');
	});
});
```

**Key Points:**

- ✅ No running app required
- ✅ All dependencies mocked
- ✅ Uses seed data for defaults
- ✅ Works in CI/CD (GitHub Actions)

#### Example 2: Database Adapter Test

```typescript
import { describe, it, expect, beforeEach } from 'bun:test';
import { getDB } from '$databases';

describe('Database Adapter', () => {
	let db: DatabaseAdapter;

	beforeEach(async () => {
		db = getDB('MongoDB');
		await db.connect();
	});

	it('should create document', async () => {
		const result = await db.create('posts', {
			title: 'Test Post',
			content: 'Hello World'
		});

		expect(result).toBeDefined();
		expect(result._id).toBeDefined();
		expect(result.title).toBe('Test Post');
	});

	it('should find documents', async () => {
		await db.create('posts', { title: 'Post 1' });
		await db.create('posts', { title: 'Post 2' });

		const results = await db.find('posts', {});

		expect(results).toHaveLength(2);
	});

	it('should update document', async () => {
		const doc = await db.create('posts', { title: 'Old' });

		const updated = await db.update('posts', doc._id, {
			title: 'New'
		});

		expect(updated.title).toBe('New');
	});
});
```

### E2E Test Example (Playwright)

```typescript
import { test, expect } from '@playwright/test';

test.describe('Collection Builder', () => {
	test('should create new collection', async ({ page }) => {
		// Login first
		await page.goto('/login');
		await page.fill('[name="email"]', 'admin@test.com');
		await page.fill('[name="password"]', 'password');
		await page.click('button[type="submit"]');

		// Navigate to collection builder
		await page.goto('/admin/collections/builder');

		// Create collection
		await page.click('button:has-text("New Collection")');
		await page.fill('[name="name"]', 'Products');
		await page.fill('[name="description"]', 'Product catalog');

		// Add fields
		await page.click('button:has-text("Add Field")');
		await page.selectOption('[name="fieldType"]', 'text');
		await page.fill('[name="fieldName"]', 'name');
		await page.fill('[name="fieldLabel"]', 'Product Name');

		// Save collection
		await page.click('button:has-text("Save Collection")');

		// Verify success
		await expect(page.locator('.success-message')).toContainText('Collection created successfully');
	});
});
```

### API Test Example

```typescript
import { describe, it, expect } from 'bun:test';

describe('Collections API', () => {
	it('POST /api/collections - should create collection', async () => {
		const response = await fetch('http://localhost:5173/api/collections', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				Cookie: `session=${sessionToken}`
			},
			body: JSON.stringify({
				name: 'products',
				fields: [{ name: 'title', type: 'text', required: true }]
			})
		});

		expect(response.ok).toBe(true);
		const data = await response.json();
		expect(data.name).toBe('products');
		expect(data.fields).toHaveLength(1);
	});

	it('GET /api/collections - should list collections', async () => {
		const response = await fetch('http://localhost:5173/api/collections', {
			headers: { Cookie: `session=${sessionToken}` }
		});

		expect(response.ok).toBe(true);
		const collections = await response.json();
		expect(Array.isArray(collections)).toBe(true);
	});
});
```

---

## 🐛 Debugging Tests

### Playwright Debugging

**1. Debug Mode:**

```bash
npx playwright test --debug
```

- Opens Playwright Inspector
- Step through tests
- Inspect page state
- View console logs

**2. Headed Mode:**

```bash
npx playwright test --headed
```

- See browser window
- Watch test execution
- Useful for visual debugging

**3. Slow Motion:**

```bash
SLOW_MO=1000 npx playwright test
```

- Slows down test execution
- Easier to follow what's happening

**4. View Test Report:**

```bash
npx playwright show-report
```

- Interactive HTML report
- Screenshots on failure
- Video recordings
- Trace viewer

**5. Trace Viewer:**

```bash
npx playwright show-trace trace.zip
```

- View detailed trace
- Network requests
- DOM snapshots
- Timeline

### Bun Test Debugging

**1. Console Logging:**

```typescript
it('should do something', async () => {
	console.log('Current state:', state);
	const result = await service.doSomething();
	console.log('Result:', result);
	expect(result).toBeDefined();
});
```

**2. Debugger:**

```typescript
it('should do something', async () => {
	debugger; // Pause execution
	const result = await service.doSomething();
	expect(result).toBeDefined();
});
```

Then run with debugger:

```bash
bun --inspect test
```

**3. Isolate Tests:**

```typescript
it.only('should run only this test', async () => {
	// Test code
});

it.skip('should skip this test', async () => {
	// Test code
});
```

### Common Issues

#### 1. Timeout Errors

```typescript
// Increase timeout for slow operations
test('slow operation', async ({ page }) => {
	test.setTimeout(60000); // 60 seconds

	await page.goto('/slow-page');
	await page.waitForSelector('.content', { timeout: 30000 });
});
```

#### 2. Flaky Tests

```typescript
// Add wait conditions
await page.waitForLoadState('networkidle');
await page.waitForSelector('.element', { state: 'visible' });

// Retry assertions
await expect(async () => {
	const text = await page.textContent('.element');
	expect(text).toBe('Expected');
}).toPass({ timeout: 5000 });
```

#### 3. Database State

```typescript
// Clean database before each test
beforeEach(async () => {
	await db.clear('users');
	await db.clear('posts');
});
```

---

## ✅ Best Practices

### General Testing Principles

1. **Test Behavior, Not Implementation**

   ```typescript
   // ❌ Bad - tests implementation
   expect(service.privateMethod()).toBe(true);

   // ✅ Good - tests behavior
   expect(await service.createUser(data)).toBeDefined();
   ```

2. **Write Descriptive Test Names**

   ```typescript
   // ❌ Bad
   it('test 1', () => { ... });

   // ✅ Good
   it('should create user with valid email and password', () => { ... });
   ```

3. **One Assertion Per Test (Generally)**

   ```typescript
   // ❌ Bad - multiple concerns
   it('user operations', () => {
   	const user = createUser();
   	expect(user).toBeDefined();
   	const deleted = deleteUser(user.id);
   	expect(deleted).toBe(true);
   });

   // ✅ Good - focused tests
   it('should create user', () => {
   	const user = createUser();
   	expect(user).toBeDefined();
   });

   it('should delete user', () => {
   	const deleted = deleteUser(userId);
   	expect(deleted).toBe(true);
   });
   ```

4. **Use Setup and Teardown**

   ```typescript
   describe('UserService', () => {
   	beforeEach(() => {
   		// Setup before each test
   		db.clear();
   		service = new UserService(db);
   	});

   	afterEach(() => {
   		// Cleanup after each test
   		service.cleanup();
   	});
   });
   ```

5. **Don't Import Old Config Files** ❌

   ```typescript
   // ❌ Bad - these files no longer exist
   import { publicConfig } from '@root/config/public';
   import { privateConfig } from '@root/config/private';
   ```

   ```typescript
   // ✅ Good - use globalThis or seed data
   const siteName = globalThis.publicEnv.SITE_NAME;
   const defaultRoles = ['admin', 'editor', 'viewer']; // from seed.ts
   ```

6. **Mock SvelteKit Modules in Preload** ✅

   ```typescript
   // ❌ Bad - won't work in test file
   import { mock } from 'bun:test';
   mock.module('$app/environment', () => ({ dev: true }));
   import { Auth } from '@src/databases/auth'; // Too late!
   ```

   ```typescript
   // ✅ Good - in tests/bun/mocks/setup.ts (preloaded)
   import { mock } from 'bun:test';
   mock.module('$app/environment', () => ({ dev: true }));
   // This runs BEFORE any test files
   ```

### Playwright Best Practices

1. **Use Data Test IDs**

   ```svelte
   <!-- Component -->
   <button data-testid="submit-button">Submit</button>
   ```

   ```typescript
   // Test
   await page.click('[data-testid="submit-button"]');
   ```

2. **Wait for Conditions**

   ```typescript
   // Wait for navigation
   await page.waitForURL('**/dashboard');

   // Wait for element
   await page.waitForSelector('.content');

   // Wait for network idle
   await page.waitForLoadState('networkidle');
   ```

3. **Use Page Object Model**

   ```typescript
   class LoginPage {
   	constructor(private page: Page) {}

   	async login(email: string, password: string) {
   		await this.page.fill('[name="email"]', email);
   		await this.page.fill('[name="password"]', password);
   		await this.page.click('button[type="submit"]');
   	}

   	async expectLoginError(message: string) {
   		await expect(this.page.locator('.error')).toContainText(message);
   	}
   }

   // Usage in test
   test('should show error on invalid login', async ({ page }) => {
   	const loginPage = new LoginPage(page);
   	await loginPage.login('invalid@test.com', 'wrong');
   	await loginPage.expectLoginError('Invalid credentials');
   });
   ```

### Bun Test Best Practices

1. **Mock External Dependencies**

   ```typescript
   import { mock } from 'bun:test';

   // Mock a module (use mock.module for SvelteKit modules)
   mock.module('$app/environment', () => ({
   	dev: true,
   	browser: false
   }));

   // Mock a function
   const mockFetch = mock((url) => {
   	return Promise.resolve({
   		ok: true,
   		json: () => Promise.resolve({ data: 'mocked' })
   	});
   });

   global.fetch = mockFetch;
   ```

   **Note:** For SvelteKit modules like `$app/environment`, use `mock.module()` in the preload file (`tests/bun/mocks/setup.ts`) configured in `bunfig.toml`.

2. **Use Test Fixtures**

   ```typescript
   const fixtures = {
   	user: {
   		email: 'test@example.com',
   		password: 'SecurePass123!',
   		role: 'admin'
   	},
   	post: {
   		title: 'Test Post',
   		content: 'Content here',
   		status: 'published'
   	}
   };

   it('should create user', async () => {
   	const user = await service.createUser(fixtures.user);
   	expect(user.email).toBe(fixtures.user.email);
   });
   ```

3. **Test Error Cases**

   ```typescript
   it('should handle database errors', async () => {
   	mockDB.simulateError('Connection failed');

   	await expect(service.createUser(data)).rejects.toThrow('Connection failed');
   });
   ```

### CI/CD Best Practices

1. **Use Test Configuration**
   - Separate config for testing
   - Mock external services
   - Use test database

2. **Artifact Management**
   - Upload test reports
   - Save screenshots on failure
   - Keep video recordings

3. **Matrix Testing**
   - Test multiple environments
   - Different browsers
   - Dev and preview modes

4. **Parallel Execution**
   - Run tests in parallel
   - Use test sharding
   - Optimize test speed

---

## 📊 Test Coverage

### Current Test Status

✅ **Authentication**: 100% coverage

- Email signup (first user + subsequent)
- OAuth authentication (Google)
- Login flow
- Session management
- 2FA flow

✅ **User Management**: 100% coverage

- User CRUD operations
- Role assignment
- Permission management
- User sessions

✅ **Collections**: 95% coverage

- Collection builder
- Collection CRUD
- Field validation
- Content management

✅ **API Endpoints**: 95% coverage

- 95+ endpoints tested
- Request validation
- Error handling
- Authentication checks

✅ **Components**: 85% coverage

- UI components
- Widget components
- Form validation

✅ **Database**: 100% coverage

- All adapters tested
- MongoDB, MariaDB, PostgreSQL
- CRUD operations

---

## 🔗 Related Documentation

- **[API Documentation](./api/)** - Complete API reference
- **[Contributing Guide](../CONTRIBUTING.md)** - How to contribute
- **[Git Workflows](./git-workflows.mdx)** - Branching and release process
- **[Installation Guide](./installation.mdx)** - Setup instructions
- **[Troubleshooting](./troubleshooting.mdx)** - Common issues

---

## 📧 Questions or Issues?

- 💬 [GitHub Discussions](https://github.com/SveltyCMS/SveltyCMS/discussions)
- 🐛 [Report Issues](https://github.com/SveltyCMS/SveltyCMS/issues)
- 📖 [Documentation](../)

---

**Happy Testing! 🧪✨**
