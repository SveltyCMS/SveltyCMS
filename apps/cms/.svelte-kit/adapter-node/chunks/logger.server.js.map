{"version":3,"file":"logger.server.js","sources":["../../../../../../shared/utils/src/logger.server.ts"],"sourcesContent":["/**\n * @file src/utils/logger.server.ts\n * @description Server-only logger with formatting, batching, rotation & masking\n *\n * Features:\n * - Level-based logging (fatal → trace)\n * - Smart terminal formatting & token highlighting\n * - Sensitive data masking\n * - Batched file writes with rotation & optional compression\n * - Configurable via env/public settings\n * - Graceful degradation & cleanup\n */\n\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\n\n// Browser detection - if imported in browser, export noop logger to prevent crashes\nconst IS_BROWSER = typeof window !== 'undefined';\n\nif (IS_BROWSER) {\n\t// Log a warning in development mode only (don't throw, just gracefully degrade)\n\tconsole.warn('[logger.server.ts] Server logger imported in browser - using noop fallback');\n}\n\n// Env helpers\nconst getEnv = <T>(key: keyof typeof publicEnv, fallback: T): T => {\n\ttry {\n\t\tconst v = publicEnv[key];\n\t\treturn v !== undefined ? (v as T) : fallback;\n\t} catch {\n\t\treturn fallback;\n\t}\n};\n\nconst LOG_LEVELS = getEnv('LOG_LEVELS', ['fatal', 'error', 'warn', 'info']);\nconst DISABLED = LOG_LEVELS.includes('none');\n\n// Log levels\ntype LogLevel = 'none' | 'fatal' | 'error' | 'warn' | 'info' | 'debug' | 'trace';\nconst LEVELS: Record<LogLevel, { prio: number; color: string }> = {\n\tnone: { prio: 0, color: '' },\n\tfatal: { prio: 1, color: '\\x1b[35m' }, // magenta\n\terror: { prio: 2, color: '\\x1b[31m' }, // red\n\twarn: { prio: 3, color: '\\x1b[33m' }, // yellow\n\tinfo: { prio: 4, color: '\\x1b[32m' }, // green\n\tdebug: { prio: 5, color: '\\x1b[34m' }, // blue\n\ttrace: { prio: 6, color: '\\x1b[36m' } // cyan\n};\n\nconst RESET = '\\x1b[0m';\nexport type LoggableValue = string | number | boolean | null | undefined | object | Date | Error;\n\nconst maxPrio = DISABLED ? 0 : Math.max(...LOG_LEVELS.map((l) => LEVELS[l as LogLevel]?.prio ?? 0));\n\n// Icons\nconst ICONS: Record<string, string> = {\n\tFATAL: '✗',\n\tERROR: '✗',\n\tWARN: '⚠',\n\tINFO: '●',\n\tDEBUG: '◆',\n\tTRACE: '○'\n};\n\n// Message token highlighting\nconst patterns = [\n\t{ re: /\\b\\d+(\\.\\d+)?(ms|s)\\b/g, color: '\\x1b[32m' }, // durations\n\t{\n\t\tre: /([a-f0-9]{24}|[a-f0-9]{32}|[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/gi,\n\t\tcolor: '\\x1b[33m'\n\t}, // IDs/UUIDs\n\t{ re: /\\/api\\/[^\\s]+/g, color: '\\x1b[36m' }, // API paths\n\t{ re: /\\b(true)\\b/g, color: '\\x1b[32m' },\n\t{ re: /\\b(false)\\b/g, color: '\\x1b[31m' },\n\t{ re: /\\b-?\\d+\\.?\\d*\\b/g, color: '\\x1b[34m' }\n];\n\nfunction colorMessage(msg: string): string {\n\tlet out = msg;\n\tfor (const { re, color } of patterns) {\n\t\tout = out.replace(re, `${color}$1${RESET}`);\n\t}\n\treturn out;\n}\n\n// Value formatting\nfunction formatValue(v: unknown): string {\n\tif (v === null) return '\\x1b[35mnull\\x1b[0m';\n\tif (v === undefined) return '\\x1b[90mundefined\\x1b[0m';\n\tif (typeof v === 'boolean') return v ? '\\x1b[32mtrue\\x1b[0m' : '\\x1b[31mfalse\\x1b[0m';\n\tif (typeof v === 'number') return `\\x1b[34m${v}\\x1b[0m`;\n\tif (typeof v === 'string') return colorMessage(v);\n\tif (v instanceof Date) return `\\x1b[36m${v.toISOString()}\\x1b[0m`;\n\tif (Array.isArray(v)) return `\\x1b[33m[${v.map(formatValue).join(', ')}]\\x1b[0m`;\n\tif (typeof v === 'object') {\n\t\tconst entries = Object.entries(v)\n\t\t\t.map(([k, val]) => `${k}: ${formatValue(val)}`)\n\t\t\t.join(', ');\n\t\treturn `\\x1b[33m{${entries}}\\x1b[0m`;\n\t}\n\treturn String(v);\n}\n\n// Sensitive data masking\nconst SENSITIVE = ['password', 'token', 'secret', 'key', 'authorization'];\nconst EMAILS = ['email', 'mail'];\n\nfunction mask(v: unknown, depth = 0): unknown {\n\tif (depth > 10) return '[Depth]';\n\tif (v === null || typeof v !== 'object') return v;\n\tif (v instanceof Date || v instanceof RegExp) return v;\n\tif (Array.isArray(v)) return v.map((item) => mask(item, depth + 1));\n\n\tconst masked: Record<string, unknown> = {};\n\tfor (const [k, val] of Object.entries(v)) {\n\t\tconst low = k.toLowerCase();\n\t\tif (SENSITIVE.some((s) => low.includes(s))) masked[k] = '[REDACTED]';\n\t\telse if (EMAILS.some((e) => low.includes(e)) && typeof val === 'string') {\n\t\t\tconst [local, domain] = val.split('@');\n\t\t\tmasked[k] = domain ? `${local.slice(0, 2)}***@${domain}` : '***';\n\t\t} else {\n\t\t\tmasked[k] = mask(val, depth + 1);\n\t\t}\n\t}\n\treturn masked;\n}\n\n// File ops (lazy loaded)\nlet stream: import('node:fs').WriteStream | null = null;\nlet modules: any = null;\n\nasync function getMods() {\n\tif (modules) return modules;\n\tmodules = {\n\t\tfs: await import('node:fs'),\n\t\tpath: await import('node:path'),\n\t\tzlib: await import('node:zlib'),\n\t\tstream: await import('node:stream/promises'),\n\t\tpromises: await import('node:fs/promises')\n\t};\n\treturn modules;\n}\n\nasync function ensureStream() {\n\tconst { path, fs } = await getMods();\n\tconst dir = 'logs';\n\tconst file = path.join(dir, 'app.log');\n\n\tif (!stream || stream.destroyed) {\n\t\tawait (await getMods()).promises.mkdir(dir, { recursive: true });\n\t\tstream = fs.createWriteStream(file, { flags: 'a' });\n\t}\n\treturn stream;\n}\n\nasync function rotate() {\n\tconst { path, promises, zlib, stream: sp } = await getMods();\n\tconst file = path.join('logs', 'app.log');\n\ttry {\n\t\tconst stat = await promises.stat(file);\n\t\tif (stat.size < 5 * 1024 * 1024) return; // 5MB\n\n\t\tif (stream) stream.end();\n\t\tconst ts = new Date().toISOString().replace(/[:.]/g, '-');\n\t\tconst rotated = `${file}.${ts}`;\n\t\tawait promises.rename(file, rotated);\n\t\tawait promises.writeFile(file, '');\n\n\t\tif (true) {\n\t\t\t// compression enabled\n\t\t\tconst src = (await getMods()).fs.createReadStream(rotated);\n\t\t\tconst dst = (await getMods()).fs.createWriteStream(`${rotated}.gz`);\n\t\t\tawait sp.pipeline(src, zlib.createGzip(), dst);\n\t\t\tawait promises.unlink(rotated);\n\t\t}\n\t} catch (e: any) {\n\t\tif (e.code !== 'ENOENT') console.error('Rotation failed:', e);\n\t}\n}\n\n// Batch queue\nconst queue: { level: LogLevel; msg: string; args: unknown[] }[] = [];\nlet timeout: NodeJS.Timeout | null = null;\n\nfunction flush() {\n\tif (!queue.length) return;\n\tconst batch = queue.splice(0, queue.length);\n\tconst lines = batch\n\t\t.map((e) => {\n\t\t\tconst ts = new Date().toISOString().slice(0, 19).replace('T', ' ');\n\t\t\tconst icon = ICONS[e.level.toUpperCase()] ?? '●';\n\t\t\tconst color = LEVELS[e.level].color;\n\t\t\tconst masked = e.args.map((a) => mask(a));\n\t\t\tconst args = masked.map(formatValue).join(' ');\n\t\t\tconst msg = colorMessage(e.msg);\n\t\t\treturn `${ts} ${color}${icon} [${e.level.toUpperCase().padEnd(5)}]${RESET} ${msg} ${args}`;\n\t\t})\n\t\t.join('\\n');\n\tensureStream()\n\t\t.then((s) => {\n\t\t\tif (s) rotate().finally(() => s.write(lines + '\\n'));\n\t\t})\n\t\t.catch((err) => console.error('Log write failed:', err));\n}\n\nfunction enqueue(level: LogLevel, msg: string, args: unknown[]) {\n\tif (DISABLED || LEVELS[level].prio > maxPrio) return;\n\n\tconst masked = args.map(mask);\n\tconst color = LEVELS[level].color;\n\tconst icon = ICONS[level.toUpperCase()] ?? '●';\n\tconst argsStr = masked.map(formatValue).join(' ');\n\tconst pretty = colorMessage(msg);\n\n\tconst ts = new Date().toISOString().slice(0, 19).replace('T', ' ');\n\tprocess.stdout.write(`${ts} ${color}${icon} [${level.toUpperCase().padEnd(5)}]${RESET} ${pretty} ${argsStr}\\n`);\n\n\tqueue.push({ level, msg, args: masked });\n\tif (queue.length >= 100) flush();\n\telse if (!timeout)\n\t\ttimeout = setTimeout(() => {\n\t\t\ttimeout = null;\n\t\t\tflush();\n\t\t}, 5000);\n}\n\n// Public logger - returns noop in browser or when disabled\nexport const logger =\n\tIS_BROWSER || DISABLED\n\t\t? {\n\t\t\t\tfatal: () => {},\n\t\t\t\terror: () => {},\n\t\t\t\twarn: () => {},\n\t\t\t\tinfo: () => {},\n\t\t\t\tdebug: () => {},\n\t\t\t\ttrace: () => {}\n\t\t\t}\n\t\t: {\n\t\t\t\tfatal: (m: string, ...a: unknown[]) => enqueue('fatal', m, a),\n\t\t\t\terror: (m: string, ...a: unknown[]) => enqueue('error', m, a),\n\t\t\t\twarn: (m: string, ...a: unknown[]) => enqueue('warn', m, a),\n\t\t\t\tinfo: (m: string, ...a: unknown[]) => enqueue('info', m, a),\n\t\t\t\tdebug: (m: string, ...a: unknown[]) => enqueue('debug', m, a),\n\t\t\t\ttrace: (m: string, ...a: unknown[]) => enqueue('trace', m, a)\n\t\t\t};\n"],"names":[],"mappings":"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"}