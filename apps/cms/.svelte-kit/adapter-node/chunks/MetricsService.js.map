{"version":3,"file":"MetricsService.js","sources":["../../../../../../shared/services/src/MetricsService.ts"],"sourcesContent":["/**\n * @file shared/services/src/MetricsService.ts\n * @description Unified metrics service for all middleware hooks\n *\n * ### Features\n * - Centralized metrics collection for all hooks\n * - High-performance counters with minimal overhead\n * - Automatic metric aggregation and reporting\n * - Thread-safe operations with atomic updates\n * - Memory-efficient with automatic cleanup\n * - Prometheus-style metrics export\n *\n * ### Categories\n * - **Requests**: Total requests, errors, response times\n * - **Auth**: Session validations, failures, cache hits/misses\n * - **API**: API requests, cache performance, rate limiting\n * - **Performance**: Hook execution times, bottlenecks\n * - **Security**: CSP violations, rate limit violations, auth failures\n *\n * @enterprise Optimized for high-throughput production environments\n */\n\nimport { logger } from '@shared/utils/logger';\nimport { building } from '$app/environment';\n\n// --- TYPES ---\n\nexport interface MetricSnapshot {\n\tname: string;\n\tvalue: number;\n\ttimestamp: number;\n\tcategory: string;\n\tlabels?: Record<string, string>;\n}\n\nexport interface MetricsReport {\n\ttimestamp: number;\n\tuptime: number;\n\trequests: {\n\t\ttotal: number;\n\t\terrors: number;\n\t\terrorRate: number;\n\t\tavgResponseTime: number;\n\t};\n\tauthentication: {\n\t\tvalidations: number;\n\t\tfailures: number;\n\t\tsuccessRate: number;\n\t\tcacheHits: number;\n\t\tcacheMisses: number;\n\t\tcacheHitRate: number;\n\t};\n\tapi: {\n\t\trequests: number;\n\t\terrors: number;\n\t\tcacheHits: number;\n\t\tcacheMisses: number;\n\t\tcacheHitRate: number;\n\t};\n\tsecurity: {\n\t\trateLimitViolations: number;\n\t\tcspViolations: number;\n\t\tauthFailures: number;\n\t};\n\tperformance: {\n\t\tslowRequests: number;\n\t\tavgHookExecutionTime: number;\n\t\tbottlenecks: string[];\n\t};\n}\n\n// --- METRICS COUNTERS ---\n\n/**\n * High-performance atomic counters for metrics collection.\n * Using simple objects for maximum performance in V8.\n */\nclass MetricsCounters {\n\t// Request metrics\n\trequests = { total: 0, errors: 0, totalResponseTime: 0 };\n\n\t// Authentication metrics\n\tauth = {\n\t\tvalidations: 0,\n\t\tfailures: 0,\n\t\tcacheHits: 0,\n\t\tcacheMisses: 0\n\t};\n\n\t// API metrics\n\tapi = {\n\t\trequests: 0,\n\t\terrors: 0,\n\t\tcacheHits: 0,\n\t\tcacheMisses: 0\n\t};\n\n\t// Security metrics\n\tsecurity = {\n\t\trateLimitViolations: 0,\n\t\tcspViolations: 0,\n\t\tauthFailures: 0\n\t};\n\n\t// Performance metrics\n\tperformance = {\n\t\tslowRequests: 0,\n\t\ttotalHookTime: 0,\n\t\thookExecutions: 0,\n\t\tbottlenecks: new Map<string, number>()\n\t};\n\n\t// Metadata\n\tlastReset = Date.now();\n\tstartTime = Date.now();\n}\n\n// --- METRICS SERVICE ---\n\n/**\n * Singleton metrics service for enterprise-grade performance monitoring.\n * Thread-safe and optimized for minimal overhead.\n */\nclass MetricsService {\n\tprivate counters = new MetricsCounters();\n\tprivate resetInterval: NodeJS.Timeout | null = null;\n\n\tconstructor() {\n\t\t// Auto-reset metrics every hour to prevent memory growth\n\t\tif (!building) {\n\t\t\tthis.resetInterval = setInterval(\n\t\t\t\t() => {\n\t\t\t\t\tthis.reset();\n\t\t\t\t},\n\t\t\t\t60 * 60 * 1000\n\t\t\t);\n\t\t}\n\t}\n\n\t// --- REQUEST METRICS ---\n\n\t/**\n\t * Increment total request counter.\n\t * Call this at the start of request processing.\n\t */\n\tincrementRequests(): void {\n\t\tthis.counters.requests.total++;\n\t}\n\n\t/**\n\t * Increment error counter.\n\t * Call this when a request results in an error.\n\t */\n\tincrementErrors(): void {\n\t\tthis.counters.requests.errors++;\n\t}\n\n\t/**\n\t * Record response time for performance analysis.\n\t * @param timeMs - Response time in milliseconds\n\t */\n\trecordResponseTime(timeMs: number): void {\n\t\tthis.counters.requests.totalResponseTime += timeMs;\n\n\t\t// Track slow requests (>2 seconds)\n\t\tif (timeMs > 2000) {\n\t\t\tthis.counters.performance.slowRequests++;\n\t\t}\n\t}\n\n\t// --- AUTHENTICATION METRICS ---\n\n\t/**\n\t * Increment authentication validation counter.\n\t * Call this for each session validation attempt.\n\t */\n\tincrementAuthValidations(): void {\n\t\tthis.counters.auth.validations++;\n\t}\n\n\t/**\n\t * Increment authentication failure counter.\n\t * Call this when session validation fails.\n\t */\n\tincrementAuthFailures(): void {\n\t\tthis.counters.auth.failures++;\n\t\tthis.counters.security.authFailures++;\n\t}\n\n\t/**\n\t * Record authentication cache hit.\n\t * Call this when session is found in cache.\n\t */\n\trecordAuthCacheHit(): void {\n\t\tthis.counters.auth.cacheHits++;\n\t}\n\n\t/**\n\t * Record authentication cache miss.\n\t * Call this when session must be fetched from database.\n\t */\n\trecordAuthCacheMiss(): void {\n\t\tthis.counters.auth.cacheMisses++;\n\t}\n\n\t// --- API METRICS ---\n\n\t/**\n\t * Increment API request counter.\n\t * Call this for each API request processed.\n\t */\n\tincrementApiRequests(): void {\n\t\tthis.counters.api.requests++;\n\t}\n\n\t/**\n\t * Increment API error counter.\n\t * Call this when an API request fails.\n\t */\n\tincrementApiErrors(): void {\n\t\tthis.counters.api.errors++;\n\t}\n\n\t/**\n\t * Record API cache hit.\n\t * Call this when API response is served from cache.\n\t */\n\trecordApiCacheHit(): void {\n\t\tthis.counters.api.cacheHits++;\n\t}\n\n\t/**\n\t * Record API cache miss.\n\t * Call this when API response must be generated.\n\t */\n\trecordApiCacheMiss(): void {\n\t\tthis.counters.api.cacheMisses++;\n\t}\n\n\t// --- SECURITY METRICS ---\n\n\t/**\n\t * Increment rate limit violation counter.\n\t * Call this when a request is rate limited.\n\t */\n\tincrementRateLimitViolations(): void {\n\t\tthis.counters.security.rateLimitViolations++;\n\t}\n\n\t/**\n\t * Increment CSP violation counter.\n\t * Call this when a CSP violation is detected.\n\t */\n\tincrementCSPViolations(): void {\n\t\tthis.counters.security.cspViolations++;\n\t}\n\n\t/**\n\t * Increment security violations counter.\n\t */\n\tincrementSecurityViolations(): void {\n\t\tthis.counters.security.cspViolations++; // Using CSP counter for now, can be extended\n\t}\n\n\t// --- PERFORMANCE METRICS ---\n\n\t/**\n\t * Record hook execution time for performance analysis.\n\t * @param hookName - Name of the hook\n\t * @param timeMs - Execution time in milliseconds\n\t */\n\trecordHookExecutionTime(hookName: string, timeMs: number): void {\n\t\tthis.counters.performance.totalHookTime += timeMs;\n\t\tthis.counters.performance.hookExecutions++;\n\n\t\t// Track potential bottlenecks (hooks taking >100ms)\n\t\tif (timeMs > 100) {\n\t\t\tconst current = this.counters.performance.bottlenecks.get(hookName) || 0;\n\t\t\tthis.counters.performance.bottlenecks.set(hookName, current + 1);\n\t\t}\n\t}\n\n\t// --- REPORTING ---\n\n\t// Generate a comprehensive metrics report\n\tgetReport(): MetricsReport {\n\t\tconst now = Date.now();\n\t\tconst uptime = now - this.counters.startTime;\n\n\t\t// Calculate rates with safe division\n\t\tconst safeRate = (numerator: number, denominator: number): number => (denominator > 0 ? (numerator / denominator) * 100 : 0);\n\n\t\tconst avgResponseTime = this.counters.requests.total > 0 ? this.counters.requests.totalResponseTime / this.counters.requests.total : 0;\n\n\t\tconst avgHookTime =\n\t\t\tthis.counters.performance.hookExecutions > 0 ? this.counters.performance.totalHookTime / this.counters.performance.hookExecutions : 0;\n\n\t\t// Get top bottlenecks\n\t\tconst bottlenecks = Array.from(this.counters.performance.bottlenecks.entries())\n\t\t\t.sort(([, a], [, b]) => b - a)\n\t\t\t.slice(0, 5)\n\t\t\t.map(([name]) => name);\n\n\t\treturn {\n\t\t\ttimestamp: now,\n\t\t\tuptime,\n\t\t\trequests: {\n\t\t\t\ttotal: this.counters.requests.total,\n\t\t\t\terrors: this.counters.requests.errors,\n\t\t\t\terrorRate: safeRate(this.counters.requests.errors, this.counters.requests.total),\n\t\t\t\tavgResponseTime\n\t\t\t},\n\t\t\tauthentication: {\n\t\t\t\tvalidations: this.counters.auth.validations,\n\t\t\t\tfailures: this.counters.auth.failures,\n\t\t\t\tsuccessRate: safeRate(this.counters.auth.validations - this.counters.auth.failures, this.counters.auth.validations),\n\t\t\t\tcacheHits: this.counters.auth.cacheHits,\n\t\t\t\tcacheMisses: this.counters.auth.cacheMisses,\n\t\t\t\tcacheHitRate: safeRate(this.counters.auth.cacheHits, this.counters.auth.cacheHits + this.counters.auth.cacheMisses)\n\t\t\t},\n\t\t\tapi: {\n\t\t\t\trequests: this.counters.api.requests,\n\t\t\t\terrors: this.counters.api.errors,\n\t\t\t\tcacheHits: this.counters.api.cacheHits,\n\t\t\t\tcacheMisses: this.counters.api.cacheMisses,\n\t\t\t\tcacheHitRate: safeRate(this.counters.api.cacheHits, this.counters.api.cacheHits + this.counters.api.cacheMisses)\n\t\t\t},\n\t\t\tsecurity: {\n\t\t\t\trateLimitViolations: this.counters.security.rateLimitViolations,\n\t\t\t\tcspViolations: this.counters.security.cspViolations,\n\t\t\t\tauthFailures: this.counters.security.authFailures\n\t\t\t},\n\t\t\tperformance: {\n\t\t\t\tslowRequests: this.counters.performance.slowRequests,\n\t\t\t\tavgHookExecutionTime: avgHookTime,\n\t\t\t\tbottlenecks\n\t\t\t}\n\t\t};\n\t}\n\n\t// Reset all metrics counters periodically to prevent memory growth\n\treset(): void {\n\t\tthis.counters = new MetricsCounters();\n\t\tlogger.trace('Unified metrics reset');\n\t}\n\n\t// Export metrics in Prometheus format for monitoring systems\n\texportPrometheus(): string {\n\t\tconst report = this.getReport();\n\t\tconst lines: string[] = [];\n\n\t\t// Request metrics\n\t\tlines.push(`# HELP svelty_requests_total Total number of requests`);\n\t\tlines.push(`# TYPE svelty_requests_total counter`);\n\t\tlines.push(`svelty_requests_total ${report.requests.total}`);\n\n\t\tlines.push(`# HELP svelty_requests_errors_total Total number of request errors`);\n\t\tlines.push(`# TYPE svelty_requests_errors_total counter`);\n\t\tlines.push(`svelty_requests_errors_total ${report.requests.errors}`);\n\n\t\t// Authentication metrics\n\t\tlines.push(`# HELP svelty_auth_cache_hit_rate Authentication cache hit rate`);\n\t\tlines.push(`# TYPE svelty_auth_cache_hit_rate gauge`);\n\t\tlines.push(`svelty_auth_cache_hit_rate ${report.authentication.cacheHitRate / 100}`);\n\n\t\t// API metrics\n\t\tlines.push(`# HELP svelty_api_cache_hit_rate API cache hit rate`);\n\t\tlines.push(`# TYPE svelty_api_cache_hit_rate gauge`);\n\t\tlines.push(`svelty_api_cache_hit_rate ${report.api.cacheHitRate / 100}`);\n\n\t\t// Security metrics\n\t\tlines.push(`# HELP svelty_security_violations_total Total security violations`);\n\t\tlines.push(`# TYPE svelty_security_violations_total counter`);\n\t\tlines.push(`svelty_security_violations_total{type=\"rate_limit\"} ${report.security.rateLimitViolations}`);\n\t\tlines.push(`svelty_security_violations_total{type=\"csp\"} ${report.security.cspViolations}`);\n\n\t\treturn lines.join('\\n') + '\\n';\n\t}\n\n\t// Cleanup resources when shutting down\n\tdestroy(): void {\n\t\tif (this.resetInterval) {\n\t\t\tclearInterval(this.resetInterval);\n\t\t\tthis.resetInterval = null;\n\t\t}\n\t}\n}\n\n// --- SINGLETON INSTANCE ---\n\n/**\n * Global metrics service instance.\n * Use this throughout the application for consistent metrics collection.\n */\nexport const metricsService = new MetricsService();\n\n/**\n * Cleanup function for graceful shutdown.\n * Call this when the application is shutting down.\n */\nexport const cleanupMetrics = (): void => {\n\tmetricsService.destroy();\n};\n\n// Cleanup on process exit (server-only)\nif (!building && typeof process !== 'undefined' && typeof window === 'undefined') {\n\tprocess.on('SIGTERM', cleanupMetrics);\n\tprocess.on('SIGINT', cleanupMetrics);\n}\n"],"names":[],"mappings":"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"}