{"version":3,"file":"Input17.js","sources":["../../../../src/widgets/custom/RemoteVideo/Input.svelte"],"sourcesContent":["<!--\n@file src/widgets/custom/RemoteVideo/Input.svelte\n@component\n**RemoteVideo Widget Input Component**\n\nProvides URL input with automatic video metadata fetching and preview from multiple platforms.\nPart of the Three Pillars Architecture for widget system.\n\n@example\n<RemoteVideoInput bind:value={videoData} field={{ allowedPlatforms: [\"youtube\", \"vimeo\"] }} />\n<!-- User enters URL → fetches metadata → shows preview with thumbnail and details\n\n### Props\n- `field: FieldType` - Widget field definition with allowed platforms configuration\n- `value: RemoteVideoData | null | undefined` - Video metadata object (bindable)\n- `error?: string | null` - Validation error message for display\n\n### Features\n- **Multi-Platform Support**: YouTube, Vimeo, Twitch, TikTok integration\n- **Automatic Metadata Fetching**: Debounced API calls for video information\n- **Rich Preview**: Thumbnail, title, channel, and duration display\n- **Security First**: Server-side metadata fetching with platform validation\n- **Loading States**: Visual feedback during API requests with spinner\n- **Error Handling**: Comprehensive error display for failed requests\n- **URL Validation**: HTML5 URL input with platform-specific validation\n- **Debounced Input**: Performance-optimized API calls (500ms delay)\n- **Accessibility**: Full ARIA support with loading and error states\n-->\n\n<script lang=\"ts\">\n\timport type { FieldType } from './';\n\timport { logger } from '@shared/utils/logger';\n\timport type { RemoteVideoData } from './types';\n\n\timport { debounce } from '@shared/utils/utils';\n\n\tlet { field, value, error }: { field: FieldType; value: RemoteVideoData | null | undefined; error?: string | null } = $props();\n\n\t// Local state for the URL input.\n\tlet urlInput = $state('');\n\t// Local state to temporarily hold fetched metadata before it's set to `value`.\n\tlet fetchedMetadata = $state<RemoteVideoData | null>(null);\n\tlet isLoading = $state(false);\n\tlet fetchError = $state<string | null>(null);\n\n\t// Effect to update local `urlInput` when parent `value` changes externally.\n\t$effect(() => {\n\t\tif (value?.url && value.url !== urlInput) {\n\t\t\turlInput = value.url;\n\t\t\tfetchedMetadata = value; // Also update fetchedMetadata if parent provides it.\n\t\t} else if (!value) {\n\t\t\turlInput = '';\n\t\t\tfetchedMetadata = null;\n\t\t}\n\t});\n\n\t// SECURITY: URL validation patterns to prevent SSRF attacks\n\tconst ALLOWED_PLATFORMS: Record<string, RegExp> = {\n\t\tyoutube: /^https?:\\/\\/(www\\.)?(youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]{11})/,\n\t\tvimeo: /^https?:\\/\\/(www\\.)?vimeo\\.com\\/\\d+$/,\n\t\ttwitch: /^https?:\\/\\/(www\\.)?twitch\\.tv\\/videos\\/\\d+$/,\n\t\ttiktok: /^https?:\\/\\/(www\\.)?tiktok\\.com\\/@[\\w.-]+\\/video\\/\\d+$/\n\t};\n\n\tfunction validateVideoUrl(url: string): { valid: boolean; error?: string } {\n\t\tconst rawPlatforms = field.allowedPlatforms || ['youtube', 'vimeo', 'twitch', 'tiktok'];\n\t\tconst allowedPlatforms: string[] = Array.isArray(rawPlatforms)\n\t\t\t? rawPlatforms\n\t\t\t: typeof rawPlatforms === 'string'\n\t\t\t\t? rawPlatforms.split(',').map((p: string) => p.trim())\n\t\t\t\t: [];\n\n\t\tconst isValid = allowedPlatforms.some((platform) => ALLOWED_PLATFORMS[platform]?.test(url));\n\n\t\tif (!isValid) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\terror: `Invalid or disallowed video URL. Allowed platforms: ${allowedPlatforms.join(', ')}`\n\t\t\t};\n\t\t}\n\t\treturn { valid: true };\n\t}\n\n\t// Debounced function to fetch video metadata from the server.\n\tconst fetchVideoMetadata = debounce.create((...args: unknown[]) => {\n\t\tconst url = typeof args[0] === 'string' ? args[0] : '';\n\t\tisLoading = true;\n\t\tfetchError = null;\n\t\tfetchedMetadata = null;\n\n\t\tif (!url) {\n\t\t\tisLoading = false;\n\t\t\treturn;\n\t\t}\n\n\t\t// SECURITY: Validate URL before making API call\n\t\tconst validation = validateVideoUrl(url);\n\t\tif (!validation.valid) {\n\t\t\tfetchError = validation.error || 'Invalid video URL';\n\t\t\tisLoading = false;\n\t\t\tvalue = null;\n\t\t\treturn;\n\t\t}\n\n\t\t// Async fetch wrapped in promise\n\t\t(async () => {\n\t\t\ttry {\n\t\t\t\t// Call API endpoint to fetch metadata securely\n\t\t\t\tconst response = await fetch('/api/remoteVideo', {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\t\t// Send a JSON object\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\turl,\n\t\t\t\t\t\tallowedPlatforms: field.allowedPlatforms\n\t\t\t\t\t})\n\t\t\t\t});\n\n\t\t\t\tconst result = await response.json();\n\n\t\t\t\tif (response.ok && result.success) {\n\t\t\t\t\tfetchedMetadata = result.data;\n\t\t\t\t\tvalue = result.data; // Bind the full metadata object back to the parent.\n\t\t\t\t} else {\n\t\t\t\t\tfetchError = result.error || 'Failed to fetch video metadata.';\n\t\t\t\t\tvalue = null; // Clear parent value on error.\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tlogger.error('Error fetching video metadata:', e);\n\t\t\t\tfetchError = 'An unexpected error occurred while fetching video data.';\n\t\t\t\tvalue = null;\n\t\t\t} finally {\n\t\t\t\tisLoading = false;\n\t\t\t}\n\t\t})();\n\t}, 500);\n\n\t// Trigger fetch when the URL input changes.\n\tfunction handleUrlInput() {\n\t\tfetchVideoMetadata(urlInput);\n\t}\n</script>\n\n<div class=\"input-container\" class:invalid={error || fetchError}>\n\t<label for={field.db_fieldName} class=\"label\">Video URL</label>\n\t<input\n\t\ttype=\"url\"\n\t\tid={field.db_fieldName}\n\t\tname={field.db_fieldName}\n\t\trequired={field.required}\n\t\tplaceholder={typeof field.placeholder === 'string' ? field.placeholder : 'e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ'}\n\t\tbind:value={urlInput}\n\t\toninput={handleUrlInput}\n\t\tclass=\"input\"\n\t\tclass:loading={isLoading}\n\t\taria-invalid={!!error || !!fetchError}\n\t\taria-describedby={error || fetchError ? `${field.db_fieldName}-error` : undefined}\n\t/>\n\n\t{#if error || fetchError}\n\t\t<p id={`${field.db_fieldName}-error`} class=\"error-message\" role=\"alert\">\n\t\t\t{error || fetchError}\n\t\t</p>\n\t{/if}\n\n\t{#if fetchedMetadata && !isLoading && !fetchError}\n\t\t<div class=\"video-preview\">\n\t\t\t<img src={fetchedMetadata.thumbnailUrl} alt={fetchedMetadata.title} class=\"thumbnail\" />\n\t\t\t<div class=\"details\">\n\t\t\t\t<h3>{fetchedMetadata.title}</h3>\n\t\t\t\t{#if fetchedMetadata.channelTitle}\n\t\t\t\t\t<p>By: {fetchedMetadata.channelTitle}</p>\n\t\t\t\t{/if}\n\t\t\t\t{#if fetchedMetadata.duration}\n\t\t\t\t\t<p>Duration: {fetchedMetadata.duration}</p>\n\t\t\t\t{/if}\n\t\t\t\t<a href={fetchedMetadata.url} target=\"_blank\" rel=\"noopener noreferrer\" class=\"watch-link\">Watch on {fetchedMetadata.platform}</a>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t/* Add styles for input, preview, thumbnail, details, and error messages */\n\t.input-container {\n\t\tposition: relative;\n\t\tpadding-bottom: 1.5rem;\n\t\twidth: 100%;\n\t}\n\t.input.loading {\n\t\t/* Add a loading spinner or indicator to the input */\n\t\tbackground-image: url('data:image/svg+xml;charset=utf8,<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zM12 4V2c-5.523 0-10 4.477-10 10s4.477 10 10 10v-2c-4.411 0-8-3.589-8-8s3.589-8 8-8z\" fill=\"%234A90E2\"/></svg>'); /* Replace with actual spinner SVG */\n\t\tbackground-repeat: no-repeat;\n\t\tbackground-position: right 8px center;\n\t\tbackground-size: 20px;\n\t\tanimation: spin 1s linear infinite;\n\t}\n\t@keyframes spin {\n\t\tfrom {\n\t\t\ttransform: rotate(0deg);\n\t\t}\n\t\tto {\n\t\t\ttransform: rotate(360deg);\n\t\t}\n\t}\n\t.video-preview {\n\t\tdisplay: flex;\n\t\tgap: 1rem;\n\t\tmargin-top: 1rem;\n\t\tborder: 1px solid #eee;\n\t\tpadding: 1rem;\n\t\tborder-radius: 8px;\n\t\talign-items: flex-start;\n\t}\n\t.thumbnail {\n\t\twidth: 120px;\n\t\theight: auto;\n\t\tflex-shrink: 0;\n\t}\n\t.details h3 {\n\t\tfont-size: 1.1em;\n\t\tfont-weight: bold;\n\t\tmargin-top: 0;\n\t\tmargin-bottom: 0.5rem;\n\t}\n\t.details p {\n\t\tfont-size: 0.9em;\n\t\tcolor: #555;\n\t\tmargin-bottom: 0.25rem;\n\t}\n\t.watch-link {\n\t\tcolor: #007bff;\n\t\ttext-decoration: underline;\n\t\tfont-size: 0.9em;\n\t}\n\t.error-message {\n\t\tposition: absolute;\n\t\tbottom: 0;\n\t\tleft: 0;\n\t\twidth: 100%;\n\t\ttext-align: center;\n\t\tfont-size: 0.75rem;\n\t\tcolor: #ef4444;\n\t}\n</style>\n"],"names":["$.attr","$.attr_class","$$renderer","$.escape"],"mappings":"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"}