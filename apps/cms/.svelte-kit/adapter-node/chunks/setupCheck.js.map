{"version":3,"file":"setupCheck.js","sources":["../../../../../../shared/utils/src/setupCheck.ts"],"sourcesContent":["/**\n * @file src/utils/setupCheck.ts\n * @description Centralized and memoized setup completion check utility.\n *\n * @improvements\n * - **Relative Imports:** Uses `../databases/db` instead of aliases to ensure safety when running inside `vite.config.ts`.\n * - **Namespace Imports:** Uses `fs` and `path` namespaces for consistency with other server utilities.\n * - **Robustness:** Stronger checks during dynamic imports.\n */\n\nimport fs from 'node:fs';\nimport path from 'node:path';\n\n// Memoization variable to cache the setup status.\nlet setupStatus: boolean | null = null;\nlet setupStatusCheckedDb = false;\n\nexport function isSetupComplete(): boolean {\n\tif (setupStatus !== null) {\n\t\treturn setupStatus;\n\t}\n\n\ttry {\n\t\t// Use process.cwd() to ensure we look at the project root\n\t\t// Support TEST_MODE for isolated testing without affecting live config\n\t\tconst configFileName = process.env.TEST_MODE ? 'private.test.ts' : 'private.ts';\n\n\t\t// In monorepo, process.cwd() might be apps/cms or apps/setup\n\t\t// Try current dir first, then look for workspace root\n\t\tlet workspaceRoot = process.cwd();\n\t\tif (\n\t\t\tworkspaceRoot.endsWith('apps/setup') ||\n\t\t\tworkspaceRoot.endsWith('apps/setup/') ||\n\t\t\tworkspaceRoot.endsWith('apps/cms') ||\n\t\t\tworkspaceRoot.endsWith('apps/cms/')\n\t\t) {\n\t\t\tworkspaceRoot = path.resolve(workspaceRoot, '../..');\n\t\t}\n\n\t\tconst privateConfigPath = path.join(workspaceRoot, 'config', configFileName);\n\n\t\tif (!fs.existsSync(privateConfigPath)) {\n\t\t\tsetupStatus = false;\n\t\t\treturn setupStatus;\n\t\t}\n\n\t\tconst configContent = fs.readFileSync(privateConfigPath, 'utf8');\n\n\t\t// Regex checks to ensure keys are not set to empty strings\n\t\t// Supports both Object property style (Key: \"Value\") and Variable assignment style (Key = \"Value\")\n\t\tconst hasJwtSecret = !/JWT_SECRET_KEY[:=]\\s*(\"\"|''|``)/.test(configContent);\n\t\tconst hasDbHost = !/DB_HOST[:=]\\s*(\"\"|''|``)/.test(configContent);\n\t\tconst hasDbName = !/DB_NAME[:=]\\s*(\"\"|''|``)/.test(configContent);\n\n\t\t// Config file exists and has values - assume setup complete for now\n\t\t// Database validation will happen asynchronously in isSetupCompleteAsync()\n\t\tsetupStatus = hasJwtSecret && hasDbHost && hasDbName;\n\t\treturn setupStatus;\n\t} catch (error) {\n\t\t// Log error here as it's an exceptional case during a critical check\n\t\tconsole.error(`[SveltyCMS] ❌ Error during setup check:`, error);\n\t\tsetupStatus = false;\n\t\treturn setupStatus;\n\t}\n}\n\n/**\n * Async version that also checks if database has admin users.\n * This is called from hooks after config check passes and database is initialized.\n */\nexport async function isSetupCompleteAsync(): Promise<boolean> {\n\t// 1. Fast fail: Check config file first\n\tif (!isSetupComplete()) {\n\t\treturn false;\n\t}\n\n\t// 2. Cache hit: If we've already checked the database, return cached result\n\tif (setupStatusCheckedDb) {\n\t\treturn setupStatus ?? false;\n\t}\n\n\ttry {\n\t\t// 3. Dynamic Import: Use relative path to avoid alias resolution issues in vite.config.ts\n\t\t// We perform this check lazily to prevent circular dependencies during boot\n\t\tconst db = await import('@shared/database/db');\n\t\tconst dbAdapter = db.dbAdapter;\n\n\t\t// Guard against uninitialized adapter\n\t\tif (!dbAdapter || !dbAdapter.auth) {\n\t\t\tif (process.env.NODE_ENV === 'development') {\n\t\t\t\tconsole.log('[setupCheck] Database adapter not ready yet');\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\n\t\t// 4. Data Verification: Check if admin users exist\n\t\tconst result = await dbAdapter.auth.getAllUsers({ limit: 1 });\n\t\tconst hasUsers = result.success && result.data && result.data.length > 0;\n\n\t\t// Update cache\n\t\tsetupStatus = hasUsers;\n\t\tsetupStatusCheckedDb = true;\n\t\treturn hasUsers;\n\t} catch (error) {\n\t\tconsole.error(`[SveltyCMS] ❌ Database validation failed during setup check:`, error);\n\t\t// Don't cache failures - allow retry on next request (e.g., if DB is temporarily down)\n\t\treturn false;\n\t}\n}\n\n/**\n * Invalidates the cached setup status, forcing a recheck on the next call.\n * @param clearPrivateEnv - Whether to clear private environment config (default: false)\n */\nexport function invalidateSetupCache(clearPrivateEnv = false): void {\n\tsetupStatus = null;\n\tsetupStatusCheckedDb = false;\n\n\tif (clearPrivateEnv) {\n\t\t// Use relative import here as well for consistency\n\t\timport('@shared/database/db')\n\t\t\t.then((db) => {\n\t\t\t\tif (typeof db.clearPrivateConfigCache === 'function') {\n\t\t\t\t\tdb.clearPrivateConfigCache(false);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch((err) => {\n\t\t\t\t// Ignore module load errors during invalidation, just log warning in dev\n\t\t\t\tif (process.env.NODE_ENV === 'development') {\n\t\t\t\t\tconsole.warn('[setupCheck] Could not clear private config cache:', err);\n\t\t\t\t}\n\t\t\t});\n\t}\n}\n"],"names":[],"mappings":";;AAcA,IAAI,cAA8B;AAClC,IAAI,uBAAuB;AAEpB,SAAS,kBAA2B;AAC1C,MAAI,gBAAgB,MAAM;AACzB,WAAO;AAAA,EACR;AAEA,MAAI;AAGH,UAAM,iBAAiB,QAAQ,IAAI,YAAY,oBAAoB;AAInE,QAAI,gBAAgB,QAAQ,IAAA;AAC5B,QACC,cAAc,SAAS,YAAY,KACnC,cAAc,SAAS,aAAa,KACpC,cAAc,SAAS,UAAU,KACjC,cAAc,SAAS,WAAW,GACjC;AACD,sBAAgB,KAAK,QAAQ,eAAe,OAAO;AAAA,IACpD;AAEA,UAAM,oBAAoB,KAAK,KAAK,eAAe,UAAU,cAAc;AAE3E,QAAI,CAAC,GAAG,WAAW,iBAAiB,GAAG;AACtC,oBAAc;AACd,aAAO;AAAA,IACR;AAEA,UAAM,gBAAgB,GAAG,aAAa,mBAAmB,MAAM;AAI/D,UAAM,eAAe,CAAC,kCAAkC,KAAK,aAAa;AAC1E,UAAM,YAAY,CAAC,2BAA2B,KAAK,aAAa;AAChE,UAAM,YAAY,CAAC,2BAA2B,KAAK,aAAa;AAIhE,kBAAc,gBAAgB,aAAa;AAC3C,WAAO;AAAA,EACR,SAAS,OAAO;AAEf,YAAQ,MAAM,2CAA2C,KAAK;AAC9D,kBAAc;AACd,WAAO;AAAA,EACR;AACD;AAMA,eAAsB,uBAAyC;AAE9D,MAAI,CAAC,mBAAmB;AACvB,WAAO;AAAA,EACR;AAGA,MAAI,sBAAsB;AACzB,WAAO,eAAe;AAAA,EACvB;AAEA,MAAI;AAGH,UAAM,KAAK,MAAM,OAAO,SAAqB,EAAA,KAAA,OAAA,EAAA,CAAA;AAC7C,UAAM,YAAY,GAAG;AAGrB,QAAI,CAAC,aAAa,CAAC,UAAU,MAAM;AAClC,UAAI,QAAQ,IAAI,aAAa,eAAe;AAC3C,gBAAQ,IAAI,6CAA6C;AAAA,MAC1D;AACA,aAAO;AAAA,IACR;AAGA,UAAM,SAAS,MAAM,UAAU,KAAK,YAAY,EAAE,OAAO,GAAG;AAC5D,UAAM,WAAW,OAAO,WAAW,OAAO,QAAQ,OAAO,KAAK,SAAS;AAGvE,kBAAc;AACd,2BAAuB;AACvB,WAAO;AAAA,EACR,SAAS,OAAO;AACf,YAAQ,MAAM,gEAAgE,KAAK;AAEnF,WAAO;AAAA,EACR;AACD;"}