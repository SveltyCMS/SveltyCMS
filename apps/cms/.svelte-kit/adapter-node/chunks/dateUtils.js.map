{"version":3,"file":"dateUtils.js","sources":["../../../../../../shared/utils/src/dateUtils.ts"],"sourcesContent":["/**\n * @file src/utils/dateUtils.ts\n * @description Date utility functions for SveltyCMS\n *\n * Provides:\n * - Type-safe conversion between Date objects and ISODateString\n * - Date validation utilities\n * - Consistent date handling across the application\n * - Database-agnostic date conversion helpers\n */\n\nimport { logger } from '@shared/utils/logger';\nimport type { ISODateString } from '@cms-types/content';\n\n// Type guard for ISODateString\nexport function isISODateString(value: unknown): value is ISODateString {\n\tif (typeof value !== 'string') return false;\n\tconst date = new Date(value);\n\treturn !isNaN(date.getTime()) && date.toISOString() === value;\n}\n\n// Convert Date to ISODateString with validation\nexport function dateToISODateString(date: Date): ISODateString {\n\tconst isoString = date.toISOString();\n\tif (!isISODateString(isoString)) {\n\t\tthrow new Error('Invalid date conversion');\n\t}\n\treturn isoString;\n}\n\n// Convert string to ISODateString with validation\nexport function stringToISODateString(dateString: string): ISODateString {\n\tconst date = new Date(dateString);\n\tif (isNaN(date.getTime())) {\n\t\tthrow new Error('Invalid date string');\n\t}\n\treturn dateToISODateString(date);\n}\n\n/**\n * Safe conversion of unknown value to ISODateString\n * Database-agnostic utility that handles various date representations from any database adapter\n * (Mongoose Date objects, PostgreSQL timestamps, SQLite strings, etc.)\n *\n * @param value - Unknown value from database query (Date object, ISO string, timestamp, etc.)\n * @returns ISODateString representation\n *\n * @example\n * const doc = await db.collection.findById(id);\n * const entity = {\n *   createdAt: toISOString(doc.createdAt),\n *   updatedAt: toISOString(doc.updatedAt)\n * };\n */\nexport function toISOString(value: unknown): ISODateString {\n\t// Handle Date objects (common from ORMs and document databases)\n\tif (value && typeof value === 'object' && 'toISOString' in value) {\n\t\treturn (value as Date).toISOString() as ISODateString;\n\t}\n\t// Handle already converted ISO strings (idempotent operation)\n\tif (typeof value === 'string' && isISODateString(value)) {\n\t\treturn value;\n\t}\n\t// Handle timestamps or date strings\n\tif (value) {\n\t\ttry {\n\t\t\treturn new Date(value as string | number).toISOString() as ISODateString;\n\t\t} catch {\n\t\t\tlogger.warn('Failed to convert value to ISODateString, using current date', { value });\n\t\t}\n\t}\n\t// Ultimate fallback: current date\n\treturn new Date().toISOString() as ISODateString;\n}\n\n/**\n * Validate and normalize date input\n * Accepts Date, ISODateString, number (timestamp in seconds or ms), or string\n */\nexport function normalizeDateInput(dateInput: Date | ISODateString | number | string): ISODateString {\n\tif (!dateInput) return dateToISODateString(new Date());\n\tif (dateInput instanceof Date) {\n\t\treturn dateToISODateString(dateInput);\n\t}\n\tif (typeof dateInput === 'number') {\n\t\t// If it's a 10-digit number, treat as seconds, else milliseconds\n\t\treturn dateToISODateString(new Date(dateInput < 1e12 ? dateInput * 1000 : dateInput));\n\t}\n\tif (typeof dateInput === 'string') {\n\t\t// Try to parse as ISO string or number\n\t\tconst num = Number(dateInput);\n\t\tif (!isNaN(num)) {\n\t\t\treturn dateToISODateString(new Date(num < 1e12 ? num * 1000 : num));\n\t\t}\n\t\treturn dateToISODateString(new Date(dateInput));\n\t}\n\treturn dateToISODateString(new Date());\n}\n\n// Current date as ISODateString\nexport function nowISODateString(): ISODateString {\n\treturn dateToISODateString(new Date());\n}\n\n/**\n * Convert ISODateString back to Date object\n * @param isoDate The ISODateString to convert\n * @returns A Date object\n */\nexport function isoDateStringToDate(isoDate: ISODateString): Date {\n\treturn new Date(isoDate);\n}\n\n/**\n * Format a date using a pattern string (e.g. \"yyyy-MM-dd\")\n * @param dateInput - Date, timestamp or ISO string\n * @param pattern - Format pattern\n * @param fallback - Fallback string if date is invalid\n */\nexport function formatDateString(dateInput: Date | number | string, pattern: string = 'yyyy-MM-dd', fallback: string = ''): string {\n\ttry {\n\t\tlet date: Date;\n\n\t\tif (typeof dateInput === 'number') {\n\t\t\tdate = new Date(dateInput > 1e12 ? dateInput : dateInput * 1000);\n\t\t} else if (typeof dateInput === 'string') {\n\t\t\tdate = new Date(dateInput);\n\t\t} else {\n\t\t\tdate = dateInput;\n\t\t}\n\n\t\tif (isNaN(date.getTime())) {\n\t\t\treturn fallback;\n\t\t}\n\n\t\tconst yyyy = date.getFullYear().toString();\n\t\tconst MM = (date.getMonth() + 1).toString().padStart(2, '0');\n\t\tconst dd = date.getDate().toString().padStart(2, '0');\n\t\tconst HH = date.getHours().toString().padStart(2, '0');\n\t\tconst mm = date.getMinutes().toString().padStart(2, '0');\n\t\tconst ss = date.getSeconds().toString().padStart(2, '0');\n\n\t\treturn pattern.replace('yyyy', yyyy).replace('MM', MM).replace('dd', dd).replace('HH', HH).replace('mm', mm).replace('ss', ss);\n\t} catch (error) {\n\t\tlogger.error('Error formatting date string:', error);\n\t\treturn fallback;\n\t}\n}\n\n/**\n * Format date for display with proper locale and timezone handling\n * @param dateInput - Date, timestamp or ISO string\n * @param locale - Locale to format for (default: system language)\n * @param options - Intl.DateTimeFormat options\n */\nexport function formatDisplayDate(\n\tdateInput: Date | number | string,\n\tlocale: string = 'en',\n\toptions: Intl.DateTimeFormatOptions = {\n\t\tyear: 'numeric',\n\t\tmonth: 'short',\n\t\tday: 'numeric',\n\t\thour: '2-digit',\n\t\tminute: '2-digit'\n\t}\n): string {\n\ttry {\n\t\tlet date: Date;\n\n\t\tif (typeof dateInput === 'number') {\n\t\t\t// Handle MongoDB timestamp (seconds vs milliseconds)\n\t\t\tdate = new Date(dateInput > 1e12 ? dateInput : dateInput * 1000);\n\t\t} else if (typeof dateInput === 'string') {\n\t\t\tdate = new Date(dateInput);\n\t\t} else {\n\t\t\tdate = dateInput;\n\t\t}\n\n\t\tif (isNaN(date.getTime())) {\n\t\t\treturn 'Invalid Date';\n\t\t}\n\n\t\treturn new Intl.DateTimeFormat(locale, options).format(date);\n\t} catch (error) {\n\t\tlogger.error('Error formatting date:', error);\n\t\treturn 'Invalid Date';\n\t}\n}\n\n/**\n * Format date for display in a relative way (e.g. \"2 hours ago\")\n * @param dateInput - Date, timestamp or ISO string\n * @param locale - Locale to format for\n */\nexport function formatRelativeDate(dateInput: Date | number | string, locale: string = 'en'): string {\n\ttry {\n\t\tlet date: Date;\n\n\t\tif (typeof dateInput === 'number') {\n\t\t\t// Handle MongoDB timestamp (seconds vs milliseconds)\n\t\t\tdate = new Date(dateInput > 1e12 ? dateInput : dateInput * 1000);\n\t\t} else if (typeof dateInput === 'string') {\n\t\t\tdate = new Date(dateInput);\n\t\t} else {\n\t\t\tdate = dateInput;\n\t\t}\n\n\t\tif (isNaN(date.getTime())) {\n\t\t\treturn 'Invalid Date';\n\t\t}\n\n\t\tconst formatter = new Intl.RelativeTimeFormat(locale, { numeric: 'auto' });\n\t\tconst seconds = Math.floor((Date.now() - date.getTime()) / 1000);\n\n\t\tif (seconds < 60) return formatter.format(-seconds, 'second');\n\t\tif (seconds < 3600) return formatter.format(-Math.floor(seconds / 60), 'minute');\n\t\tif (seconds < 86400) return formatter.format(-Math.floor(seconds / 3600), 'hour');\n\t\tif (seconds < 2592000) return formatter.format(-Math.floor(seconds / 86400), 'day');\n\t\tif (seconds < 31536000) return formatter.format(-Math.floor(seconds / 2592000), 'month');\n\n\t\treturn formatter.format(-Math.floor(seconds / 31536000), 'year');\n\t} catch (error) {\n\t\tlogger.error('Error formatting relative date:', error);\n\t\treturn 'Invalid Date';\n\t}\n}\n\n/**\n * Utility to parse ISO 8601 duration (e.g., \"PT3M20S\") into a human-readable format (e.g., \"3:20\").\n * This function can be used in the Display component if the duration is stored in ISO format.\n */\nexport function formatIsoDuration(isoDuration: string | undefined): string | undefined {\n\tif (!isoDuration) return undefined;\n\n\tconst regex = /PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/;\n\tconst matches = isoDuration.match(regex);\n\n\tif (!matches) return undefined;\n\n\tconst hours = parseInt(matches[1] || '0', 10);\n\tconst minutes = parseInt(matches[2] || '0', 10);\n\tconst seconds = parseInt(matches[3] || '0', 10);\n\n\tconst parts = [];\n\tif (hours > 0) parts.push(String(hours).padStart(2, '0'));\n\tparts.push(String(minutes).padStart(2, '0'));\n\tparts.push(String(seconds).padStart(2, '0'));\n\n\treturn parts.join(':');\n}\n"],"names":[],"mappings":";AAeO,SAAS,gBAAgB,OAAwC;AACvE,MAAI,OAAO,UAAU,SAAU,QAAO;AACtC,QAAM,OAAO,IAAI,KAAK,KAAK;AAC3B,SAAO,CAAC,MAAM,KAAK,QAAA,CAAS,KAAK,KAAK,kBAAkB;AACzD;AAGO,SAAS,oBAAoB,MAA2B;AAC9D,QAAM,YAAY,KAAK,YAAA;AACvB,MAAI,CAAC,gBAAgB,SAAS,GAAG;AAChC,UAAM,IAAI,MAAM,yBAAyB;AAAA,EAC1C;AACA,SAAO;AACR;AA0BO,SAAS,YAAY,OAA+B;AAE1D,MAAI,SAAS,OAAO,UAAU,YAAY,iBAAiB,OAAO;AACjE,WAAQ,MAAe,YAAA;AAAA,EACxB;AAEA,MAAI,OAAO,UAAU,YAAY,gBAAgB,KAAK,GAAG;AACxD,WAAO;AAAA,EACR;AAEA,MAAI,OAAO;AACV,QAAI;AACH,aAAO,IAAI,KAAK,KAAwB,EAAE,YAAA;AAAA,IAC3C,QAAQ;AACP,aAAO,KAAK,gEAAgE,EAAE,MAAA,CAAO;AAAA,IACtF;AAAA,EACD;AAEA,UAAO,oBAAI,KAAA,GAAO,YAAA;AACnB;AA2BO,SAAS,mBAAkC;AACjD,SAAO,oBAAoB,oBAAI,MAAM;AACtC;AAOO,SAAS,oBAAoB,SAA8B;AACjE,SAAO,IAAI,KAAK,OAAO;AACxB;AAQO,SAAS,iBAAiB,WAAmC,UAAkB,cAAc,WAAmB,IAAY;AAClI,MAAI;AACH,QAAI;AAEJ,QAAI,OAAO,cAAc,UAAU;AAClC,aAAO,IAAI,KAAK,YAAY,OAAO,YAAY,YAAY,GAAI;AAAA,IAChE,WAAW,OAAO,cAAc,UAAU;AACzC,aAAO,IAAI,KAAK,SAAS;AAAA,IAC1B,OAAO;AACN,aAAO;AAAA,IACR;AAEA,QAAI,MAAM,KAAK,QAAA,CAAS,GAAG;AAC1B,aAAO;AAAA,IACR;AAEA,UAAM,OAAO,KAAK,YAAA,EAAc,SAAA;AAChC,UAAM,MAAM,KAAK,SAAA,IAAa,GAAG,WAAW,SAAS,GAAG,GAAG;AAC3D,UAAM,KAAK,KAAK,QAAA,EAAU,WAAW,SAAS,GAAG,GAAG;AACpD,UAAM,KAAK,KAAK,SAAA,EAAW,WAAW,SAAS,GAAG,GAAG;AACrD,UAAM,KAAK,KAAK,WAAA,EAAa,WAAW,SAAS,GAAG,GAAG;AACvD,UAAM,KAAK,KAAK,WAAA,EAAa,WAAW,SAAS,GAAG,GAAG;AAEvD,WAAO,QAAQ,QAAQ,QAAQ,IAAI,EAAE,QAAQ,MAAM,EAAE,EAAE,QAAQ,MAAM,EAAE,EAAE,QAAQ,MAAM,EAAE,EAAE,QAAQ,MAAM,EAAE,EAAE,QAAQ,MAAM,EAAE;AAAA,EAC9H,SAAS,OAAO;AACf,WAAO,MAAM,iCAAiC,KAAK;AACnD,WAAO;AAAA,EACR;AACD;AAQO,SAAS,kBACf,WACA,SAAiB,MACjB,UAAsC;AAAA,EACrC,MAAM;AAAA,EACN,OAAO;AAAA,EACP,KAAK;AAAA,EACL,MAAM;AAAA,EACN,QAAQ;AACT,GACS;AACT,MAAI;AACH,QAAI;AAEJ,QAAI,OAAO,cAAc,UAAU;AAElC,aAAO,IAAI,KAAK,YAAY,OAAO,YAAY,YAAY,GAAI;AAAA,IAChE,WAAW,OAAO,cAAc,UAAU;AACzC,aAAO,IAAI,KAAK,SAAS;AAAA,IAC1B,OAAO;AACN,aAAO;AAAA,IACR;AAEA,QAAI,MAAM,KAAK,QAAA,CAAS,GAAG;AAC1B,aAAO;AAAA,IACR;AAEA,WAAO,IAAI,KAAK,eAAe,QAAQ,OAAO,EAAE,OAAO,IAAI;AAAA,EAC5D,SAAS,OAAO;AACf,WAAO,MAAM,0BAA0B,KAAK;AAC5C,WAAO;AAAA,EACR;AACD;"}