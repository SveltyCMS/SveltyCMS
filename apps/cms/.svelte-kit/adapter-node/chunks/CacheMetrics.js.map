{"version":3,"file":"CacheMetrics.js","sources":["../../../../../../shared/database/src/CacheMetrics.ts"],"sourcesContent":["/**\n * @file src/databases/CacheMetrics.ts\n * @description Cache performance metrics tracking and monitoring\n *\n * Features:\n * - Real-time hit/miss rate tracking\n * - Per-operation performance metrics\n * - Category-based statistics (query, schema, widget, etc.)\n * - Multi-tenant aware metrics\n * - Prometheus-compatible export format\n */\n\nimport { logger } from '@shared/utils/logger';\nimport type { ISODateString } from '@cms-types/content';\nimport { dateToISODateString } from '@shared/utils/dateUtils';\n\nexport interface CacheMetricSnapshot {\n\thits: number;\n\tmisses: number;\n\thitRate: number;\n\ttotalRequests: number;\n\tavgResponseTime: number;\n\tlastReset: ISODateString;\n\tbyCategory: Record<\n\t\tstring,\n\t\t{\n\t\t\thits: number;\n\t\t\tmisses: number;\n\t\t\thitRate: number;\n\t\t\tavgTTL: number;\n\t\t}\n\t>;\n\tbyTenant?: Record<string, { hits: number; misses: number; hitRate: number }>;\n}\n\nexport interface CacheEvent {\n\ttype: 'hit' | 'miss' | 'set' | 'delete' | 'clear';\n\tkey: string;\n\tcategory: string;\n\ttenantId?: string;\n\tresponseTime?: number;\n\ttimestamp: ISODateString;\n}\n\n// Tracks cache performance metrics with support for multi-tenant isolation\nexport class CacheMetrics {\n\tprivate hits = 0;\n\tprivate misses = 0;\n\tprivate totalResponseTime = 0;\n\tprivate requestCount = 0;\n\tprivate lastResetTime: ISODateString = dateToISODateString(new Date());\n\n\t// Category-based metrics (query, schema, widget, theme, media, content)\n\tprivate categoryMetrics = new Map<\n\t\tstring,\n\t\t{\n\t\t\thits: number;\n\t\t\tmisses: number;\n\t\t\ttotalTTL: number;\n\t\t\tttlCount: number;\n\t\t}\n\t>();\n\n\t// Tenant-specific metrics for multi-tenant isolation\n\tprivate tenantMetrics = new Map<string, { hits: number; misses: number }>();\n\n\t// Recent events for debugging (keep last 100)\n\tprivate recentEvents: CacheEvent[] = [];\n\tprivate readonly MAX_EVENTS = 100;\n\n\t// Records a cache hit\n\trecordHit(key: string, category: string, tenantId?: string, responseTime?: number): void {\n\t\tthis.hits++;\n\t\tthis.requestCount++;\n\n\t\tif (responseTime !== undefined) {\n\t\t\tthis.totalResponseTime += responseTime;\n\t\t}\n\n\t\t// Update category metrics\n\t\tconst catMetrics = this.categoryMetrics.get(category) || { hits: 0, misses: 0, totalTTL: 0, ttlCount: 0 };\n\t\tcatMetrics.hits++;\n\t\tthis.categoryMetrics.set(category, catMetrics);\n\n\t\t// Update tenant metrics\n\t\tif (tenantId) {\n\t\t\tconst tenantMetric = this.tenantMetrics.get(tenantId) || { hits: 0, misses: 0 };\n\t\t\ttenantMetric.hits++;\n\t\t\tthis.tenantMetrics.set(tenantId, tenantMetric);\n\t\t}\n\n\t\t// Record event\n\t\tthis.addEvent({ type: 'hit', key, category, tenantId, responseTime, timestamp: dateToISODateString(new Date()) });\n\t}\n\n\t// Records a cache miss\n\trecordMiss(key: string, category: string, tenantId?: string, responseTime?: number): void {\n\t\tthis.misses++;\n\t\tthis.requestCount++;\n\n\t\tif (responseTime !== undefined) {\n\t\t\tthis.totalResponseTime += responseTime;\n\t\t}\n\n\t\t// Update category metrics\n\t\tconst catMetrics = this.categoryMetrics.get(category) || { hits: 0, misses: 0, totalTTL: 0, ttlCount: 0 };\n\t\tcatMetrics.misses++;\n\t\tthis.categoryMetrics.set(category, catMetrics);\n\n\t\t// Update tenant metrics\n\t\tif (tenantId) {\n\t\t\tconst tenantMetric = this.tenantMetrics.get(tenantId) || { hits: 0, misses: 0 };\n\t\t\ttenantMetric.misses++;\n\t\t\tthis.tenantMetrics.set(tenantId, tenantMetric);\n\t\t}\n\n\t\t// Record event\n\t\tthis.addEvent({ type: 'miss', key, category, tenantId, responseTime, timestamp: dateToISODateString(new Date()) });\n\t}\n\n\t// Records a cache set operation with TTL for average tracking\n\trecordSet(key: string, category: string, ttl: number, tenantId?: string): void {\n\t\tconst catMetrics = this.categoryMetrics.get(category) || { hits: 0, misses: 0, totalTTL: 0, ttlCount: 0 };\n\t\tcatMetrics.totalTTL += ttl;\n\t\tcatMetrics.ttlCount++;\n\t\tthis.categoryMetrics.set(category, catMetrics);\n\n\t\tthis.addEvent({ type: 'set', key, category, tenantId, timestamp: dateToISODateString(new Date()) });\n\t}\n\n\t// Records a cache delete operation\n\trecordDelete(key: string, category: string, tenantId?: string): void {\n\t\tthis.addEvent({ type: 'delete', key, category, tenantId, timestamp: dateToISODateString(new Date()) });\n\t}\n\n\t// Records a cache clear operation\n\trecordClear(pattern: string, category: string, tenantId?: string): void {\n\t\tthis.addEvent({ type: 'clear', key: pattern, category, tenantId, timestamp: dateToISODateString(new Date()) });\n\t}\n\n\t// Adds an event to the recent events queue\n\tprivate addEvent(event: CacheEvent): void {\n\t\tthis.recentEvents.push(event);\n\t\tif (this.recentEvents.length > this.MAX_EVENTS) {\n\t\t\tthis.recentEvents.shift();\n\t\t}\n\t}\n\n\t// Gets current metrics snapshot\n\tgetSnapshot(): CacheMetricSnapshot {\n\t\tconst hitRate = this.requestCount > 0 ? this.hits / this.requestCount : 0;\n\t\tconst avgResponseTime = this.requestCount > 0 ? this.totalResponseTime / this.requestCount : 0;\n\n\t\tconst byCategory: Record<string, { hits: number; misses: number; hitRate: number; avgTTL: number }> = {};\n\t\tfor (const [category, metrics] of this.categoryMetrics.entries()) {\n\t\t\tconst total = metrics.hits + metrics.misses;\n\t\t\tbyCategory[category] = {\n\t\t\t\thits: metrics.hits,\n\t\t\t\tmisses: metrics.misses,\n\t\t\t\thitRate: total > 0 ? metrics.hits / total : 0,\n\t\t\t\tavgTTL: metrics.ttlCount > 0 ? metrics.totalTTL / metrics.ttlCount : 0\n\t\t\t};\n\t\t}\n\n\t\tconst byTenant: Record<string, { hits: number; misses: number; hitRate: number }> = {};\n\t\tfor (const [tenantId, metrics] of this.tenantMetrics.entries()) {\n\t\t\tconst total = metrics.hits + metrics.misses;\n\t\t\tbyTenant[tenantId] = {\n\t\t\t\thits: metrics.hits,\n\t\t\t\tmisses: metrics.misses,\n\t\t\t\thitRate: total > 0 ? metrics.hits / total : 0\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\thits: this.hits,\n\t\t\tmisses: this.misses,\n\t\t\thitRate,\n\t\t\ttotalRequests: this.requestCount,\n\t\t\tavgResponseTime,\n\t\t\tlastReset: this.lastResetTime,\n\t\t\tbyCategory,\n\t\t\tbyTenant: Object.keys(byTenant).length > 0 ? byTenant : undefined\n\t\t};\n\t}\n\n\t/**\n\t * Gets recent cache events for debugging\n\t */\n\tgetRecentEvents(limit = 50): CacheEvent[] {\n\t\treturn this.recentEvents.slice(-limit);\n\t}\n\n\t/**\n\t * Resets all metrics\n\t */\n\treset(): void {\n\t\tthis.hits = 0;\n\t\tthis.misses = 0;\n\t\tthis.totalResponseTime = 0;\n\t\tthis.requestCount = 0;\n\t\tthis.lastResetTime = dateToISODateString(new Date());\n\t\tthis.categoryMetrics.clear();\n\t\tthis.tenantMetrics.clear();\n\t\tthis.recentEvents = [];\n\t\tlogger.info('Cache metrics reset');\n\t}\n\n\t// Logs current metrics summary\n\tlogSummary(): void {\n\t\tconst snapshot = this.getSnapshot();\n\t\tlogger.info('Cache Metrics Summary', {\n\t\t\thitRate: `${(snapshot.hitRate * 100).toFixed(2)}%`,\n\t\t\thits: snapshot.hits,\n\t\t\tmisses: snapshot.misses,\n\t\t\ttotalRequests: snapshot.totalRequests,\n\t\t\tavgResponseTime: `${snapshot.avgResponseTime.toFixed(2)}ms`,\n\t\t\tcategories: Object.keys(snapshot.byCategory).length,\n\t\t\ttenants: snapshot.byTenant ? Object.keys(snapshot.byTenant).length : 0\n\t\t});\n\t}\n\n\t// Exports metrics in Prometheus format for monitoring systems\n\texportPrometheusFormat(): string {\n\t\tconst snapshot = this.getSnapshot();\n\t\tconst lines: string[] = [];\n\n\t\t// Overall metrics\n\t\tlines.push('# HELP cache_hit_rate Cache hit rate (0-1)');\n\t\tlines.push('# TYPE cache_hit_rate gauge');\n\t\tlines.push(`cache_hit_rate ${snapshot.hitRate.toFixed(4)}`);\n\n\t\tlines.push('# HELP cache_hits_total Total cache hits');\n\t\tlines.push('# TYPE cache_hits_total counter');\n\t\tlines.push(`cache_hits_total ${snapshot.hits}`);\n\n\t\tlines.push('# HELP cache_misses_total Total cache misses');\n\t\tlines.push('# TYPE cache_misses_total counter');\n\t\tlines.push(`cache_misses_total ${snapshot.misses}`);\n\n\t\tlines.push('# HELP cache_avg_response_time_ms Average cache response time in milliseconds');\n\t\tlines.push('# TYPE cache_avg_response_time_ms gauge');\n\t\tlines.push(`cache_avg_response_time_ms ${snapshot.avgResponseTime.toFixed(2)}`);\n\n\t\t// Category-based metrics\n\t\tfor (const [category, metrics] of Object.entries(snapshot.byCategory)) {\n\t\t\tlines.push(`# HELP cache_category_hit_rate_${category} Hit rate for ${category} category`);\n\t\t\tlines.push(`# TYPE cache_category_hit_rate_${category} gauge`);\n\t\t\tlines.push(`cache_category_hit_rate_${category} ${metrics.hitRate.toFixed(4)}`);\n\t\t}\n\n\t\treturn lines.join('\\n');\n\t}\n}\n\n// Singleton instance\nexport const cacheMetrics = new CacheMetrics();\n"],"names":[],"mappings":"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"}