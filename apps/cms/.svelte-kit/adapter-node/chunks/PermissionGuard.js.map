{"version":3,"file":"PermissionGuard.js","sources":["../../../../../../shared/components/src/PermissionGuard.svelte"],"sourcesContent":["<!--\n@file src/components/PermissionGuard.svelte\n@component\n**Enhanced PermissionGuard - Svelte 5 Optimized**\n\nPermission-based access control component with advanced features and security.\n\n@example Basic usage\n```svelte\n<PermissionGuard {config}>\n\t<ProtectedContent />\n</PermissionGuard>\n```\n\n@example Silent mode (no error messages)\n```svelte\n<PermissionGuard {config} silent>\n\t<ProtectedContent />\n</PermissionGuard>\n```\n\n@example Custom error messages\n```svelte\n<PermissionGuard \n\t{config}\n\tmessages={{\n\t\tinsufficientPermissions: 'Access denied',\n\t\trateLimited: 'Too many requests'\n\t}}\n>\n\t<ProtectedContent />\n</PermissionGuard>\n```\n\n@example With fallback content\n```svelte\n<PermissionGuard {config}>\n\t{#snippet children()}\n\t\t<ProtectedContent />\n\t{/snippet}\n\t{#snippet fallback()}\n\t\t<LoginPrompt />\n\t{/snippet}\n</PermissionGuard>\n```\n\n### Props\n- `config` (PermissionConfig): Permission configuration object\n- `messages` (object): Custom error messages\n- `silent` (boolean): Hide error messages (default: false)\n- `showLoadingState` (boolean): Show loading indicator (default: true)\n- `logDenials` (boolean): Log permission denials for security auditing (default: true)\n\n### Features\n- Comprehensive permission checking with admin override\n- Rate limiting support\n- Silent mode for security-sensitive components\n- Custom error messages\n- Optional fallback content via snippet\n- Loading state support\n- Security audit logging\n- Full ARIA accessibility\n- Type-safe with proper TypeScript\n-->\n\n<script lang=\"ts\">\n\timport { page } from '$app/state';\n\timport { fade } from 'svelte/transition';\n\timport type { PermissionConfig } from '@shared/database/auth/permissions';\n\timport type { Snippet } from 'svelte';\n\n\tinterface ErrorMessages {\n\t\trateLimited?: string;\n\t\tmissingConfig?: string;\n\t\tinsufficientPermissions?: string;\n\t\tloadingPermissions?: string;\n\t}\n\n\tinterface Props {\n\t\tconfig: PermissionConfig | undefined;\n\t\tmessages?: ErrorMessages;\n\t\tsilent?: boolean;\n\t\tshowLoadingState?: boolean;\n\t\tlogDenials?: boolean;\n\t\tchildren?: Snippet;\n\t\tfallback?: Snippet;\n\t}\n\n\tconst { config, messages = {}, silent = false, showLoadingState = true, logDenials = true, children, fallback }: Props = $props();\n\n\t// Default messages\n\tconst defaultMessages: Required<ErrorMessages> = {\n\t\trateLimited: 'Rate limit reached. Please try again later.',\n\t\tmissingConfig: 'Permission configuration is missing.',\n\t\tinsufficientPermissions: 'You do not have permission to access this content.',\n\t\tloadingPermissions: 'Loading permissions...'\n\t};\n\n\t// Merge with user-provided messages\n\tconst finalMessages = $derived({ ...defaultMessages, ...messages });\n\n\t// Derive permissions and admin status from page data\n\tconst permissions = $derived((page.data?.permissions || {}) as Record<string, any>);\n\tconst isAdmin = $derived((page.data?.isAdmin || false) as boolean);\n\tconst isLoading = $derived((page.data?.isLoadingPermissions || false) as boolean);\n\n\t// Get permission data for specific context\n\tconst permissionData = $derived.by(() => {\n\t\tif (!config?.contextId) {\n\t\t\treturn { hasPermission: false, isRateLimited: false };\n\t\t}\n\t\treturn permissions[config.contextId] ?? { hasPermission: false, isRateLimited: false };\n\t});\n\n\t// Determine access status\n\tconst hasPermission = $derived(isAdmin || permissionData.hasPermission);\n\tconst isRateLimited = $derived(permissionData.isRateLimited);\n\tconst shouldShowContent = $derived(!!config && hasPermission && !isRateLimited && !isLoading);\n\n\t// Denial reason (for logging)\n\tconst denialReason = $derived.by(() => {\n\t\tif (!config) return 'missing_config';\n\t\tif (isRateLimited) return 'rate_limited';\n\t\tif (!hasPermission) return 'insufficient_permissions';\n\t\treturn null;\n\t});\n\n\t// Log permission denials for security audit\n\t$effect(() => {\n\t\tif (logDenials && denialReason && config) {\n\t\t\tconsole.warn('[PermissionGuard] Access denied:', {\n\t\t\t\tcontextId: config.contextId,\n\t\t\t\treason: denialReason,\n\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\tuserAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'unknown'\n\t\t\t});\n\t\t}\n\t});\n\n\t// Get appropriate error message\n\tconst errorMessage = $derived.by(() => {\n\t\tif (!config) return finalMessages.missingConfig;\n\t\tif (isRateLimited) return finalMessages.rateLimited;\n\t\tif (!hasPermission) return finalMessages.insufficientPermissions;\n\t\treturn null;\n\t});\n\n\t// Determine icon for error state\n\tconst errorIcon = $derived.by(() => {\n\t\tif (!config) return '‚öôÔ∏è';\n\t\tif (isRateLimited) return '‚è±Ô∏è';\n\t\tif (!hasPermission) return 'üîí';\n\t\treturn '‚ùå';\n\t});\n\n\t// ARIA role for error messages\n\tconst errorRole = $derived(isRateLimited ? 'status' : 'alert');\n</script>\n\n{#if isLoading && showLoadingState}\n\t<!-- Loading state -->\n\t<div\n\t\tclass=\"flex items-center justify-center gap-2 rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-800\"\n\t\trole=\"status\"\n\t\taria-live=\"polite\"\n\t\ttransition:fade={{ duration: 200 }}\n\t>\n\t\t<div class=\"h-4 w-4 animate-spin rounded-full border-2 border-primary-500 border-t-transparent\" aria-hidden=\"true\"></div>\n\t\t<span class=\"text-sm text-gray-600 dark:text-gray-400\">\n\t\t\t{finalMessages.loadingPermissions}\n\t\t</span>\n\t</div>\n{:else if shouldShowContent}\n\t<!-- Authorized content -->\n\t{@render children?.()}\n{:else if fallback}\n\t<!-- Custom fallback content -->\n\t{@render fallback()}\n{:else if !silent && errorMessage}\n\t<!-- Error message (only if not silent) -->\n\t<div\n\t\tclass=\"flex items-start gap-3 rounded-lg border p-4 {isRateLimited\n\t\t\t? 'border-warning-200 bg-warning-50 dark:border-warning-800 dark:bg-warning-900/20'\n\t\t\t: 'border-error-200 bg-error-50 dark:border-error-800 dark:bg-error-900/20'}\"\n\t\trole={errorRole}\n\t\taria-live=\"polite\"\n\t\ttransition:fade={{ duration: 200 }}\n\t>\n\t\t<!-- Error icon -->\n\t\t<span class=\"text-2xl\" role=\"img\" aria-label={isRateLimited ? 'Rate limited' : 'Access denied'}>\n\t\t\t{errorIcon}\n\t\t</span>\n\n\t\t<!-- Error content -->\n\t\t<div class=\"flex-1\">\n\t\t\t<h3 class=\"font-semibold {isRateLimited ? 'text-warning-800 dark:text-warning-200' : 'text-error-800 dark:text-error-200'}\">\n\t\t\t\t{isRateLimited ? 'Rate Limit Exceeded' : 'Access Denied'}\n\t\t\t</h3>\n\t\t\t<p class=\"mt-1 text-sm {isRateLimited ? 'text-warning-700 dark:text-warning-300' : 'text-error-700 dark:text-error-300'}\">\n\t\t\t\t{errorMessage}\n\t\t\t</p>\n\n\t\t\t<!-- Additional context for missing config (dev mode only) -->\n\t\t\t{#if !config && import.meta.env.DEV}\n\t\t\t\t<p class=\"mt-2 text-xs text-gray-500 dark:text-gray-400\">\n\t\t\t\t\t<strong>Dev Note:</strong> No permission config provided. Pass a valid PermissionConfig object to this component.\n\t\t\t\t</p>\n\t\t\t{/if}\n\t\t</div>\n\t</div>\n{/if}\n"],"names":["$$renderer","$.escape","$.attr_class","$.stringify","$.attr"],"mappings":";;;wCAiEA;;MAuBS;AAAA,MAAQ,WAAQ,CAAA;AAAA,MAAO,SAAS;AAAA,MAAO,mBAAmB;AAAA,MAAM,aAAa;AAAA,MAAM;AAAA,MAAU;AAAA,IAAA;UAG/F,kBAAwC;AAAA,MAC7C,aAAa;AAAA,MACb,eAAe;AAAA,MACf,yBAAyB;AAAA,MACzB,oBAAoB;AAAA,IAAA;UAIf,gBAAa,EAAA,GAAiB,iBAAe,GAAK,SAAA;AAGlD,UAAA,cAAwB,KAAK,MAAM,eAAW,CAAA;AAC9C,UAAA,UAAoB,KAAK,MAAM,WAAW;AAC1C,UAAA,YAAsB,KAAK,MAAM,wBAAwB;AAGzD,UAAA,kBAAc,MAAqB;WACnC,QAAQ,WAAW;AACd,eAAA,EAAA,eAAe,OAAO,eAAe,MAAA;AAAA,MAC/C;aACO,YAAY,OAAO,SAAS,KAAA,EAAO,eAAe,OAAO,eAAe,MAAA;AAAA,IAChF,GAAA;AAGM,UAAA,gBAAyB,WAAW,eAAe;UACnD,gBAAyB,eAAe;AACxC,UAAA,sBAA+B,UAAU,iBAAa,CAAK,kBAAkB;AAuB7E,UAAA,gBAAY,MAAqB;WACjC,OAAM,QAAS,cAAc;UAC9B,sBAAsB,cAAc;WACnC,cAAa,QAAS,cAAc;aAClC;AAAA,IACR,GAAA;AAGM,UAAA,aAAS,MAAqB;AAC9B,UAAA,CAAA,eAAe;AAChB,UAAA,sBAAsB;AACrB,UAAA,CAAA,sBAAsB;aACpB;AAAA,IACR,GAAA;AAGM,UAAA,YAAqB,gBAAgB,WAAW;AAGlD,QAAA,aAAa,kBAAgB;;AAU9BA,kBAAA,KAAA,gWAAAC,YAAA,cAAc,kBAAkB,CAAA,eAAA;AAAA;;UAG1B,mBAAiB;;AAEjB,mBAAQD,WAAA;;;;YACR,UAAQ;;AAER,mBAAQA,WAAA;;;;AACP,cAAA,CAAA,UAAU,cAAY;;AAGsBA,wBAAA,KAAA,OAAAE,WAAA,gDAAAC,UAAA,gBAClD,oFACA,yEAAyE,CAAA,EAAA,CAAA,GAAAC,KAAA,QACtE,SAAS,CAAA,wDAAAA,KAAA,cAK+B,gBAAgB,iBAAiB,eAAe,CAAA,IAAAH,YAC5F,SAAS,CAAA,kCAAAC,WAAA,iBAAAC,UAKgB,gBAAgB,2CAA2C,oCAAoC,oBACvH,gBAAgB,wBAAwB,eAAe,iDAEjC,gBAAgB,2CAA2C,oCAAoC,oBACrH,YAAY,CAAA,OAAA;AAIR,gBAAA,CAAA,UAAU,OAAmB;;;;;;;;;;;;;;;;;EA9C9B,CAAA;;"}