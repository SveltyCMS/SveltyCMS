{"version":3,"file":"Input5.js","sources":["../../../../src/widgets/core/MediaUpload/Input.svelte"],"sourcesContent":["<!--\n@file src/widgets/core/MediaUpload/Input.svelte\n@component\n**Media Upload Widget Component**\n\n@example\n<Input field={{ label: \"Upload Image\", db_fieldName: \"image\", translated: true, required: true }} />\n\n### Props\n- `field: FieldType` - Configuration object for the media upload field\n- `value: string | string[] | null | undefined` - Current value(s) representing media IDs\n- `error?: string | null` - Optional error message to display\n\n### Features\n- **Single and Multiple Uploads**: Supports both single and multi-file uploads based on the `multiupload` property in the `field` prop.\n- **Drag-and-Drop Reordering**: Utilizes `svelte-dnd-action` for drag-and-drop reordering of selected media files.\n- **Media Library Integration**: Opens a modal media library for selecting files, with a callback to handle selected files.\n- **Dynamic Fetching**: Automatically fetches media data when IDs change.\n-->\n\n<script lang=\"ts\">\n\timport { logger } from '@shared/utils/logger';\n\timport { dndzone } from 'svelte-dnd-action';\n\timport { flip } from 'svelte/animate';\n\timport type { FieldType } from './';\n\timport type { MediaFile } from './types';\n\timport { modalState } from '@shared/utils/modalState.svelte';\n\timport MediaLibraryModal from '@cms/components/MediaLibraryModal.svelte';\n\n\t// SECURITY: File validation constants\n\tconst ALLOWED_MIME_TYPES = [\n\t\t'image/jpeg',\n\t\t'image/png',\n\t\t'image/gif',\n\t\t'image/webp',\n\t\t'image/svg+xml',\n\t\t'video/mp4',\n\t\t'video/webm',\n\t\t'video/ogg',\n\t\t'application/pdf',\n\t\t'audio/mpeg',\n\t\t'audio/wav'\n\t];\n\tconst MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB\n\tconst VALID_EXTENSIONS = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'mp4', 'webm', 'ogg', 'pdf', 'mp3', 'wav'];\n\n\tfunction validateFile(file: File): { valid: boolean; error?: string } {\n\t\t// Check MIME type\n\t\tif (!ALLOWED_MIME_TYPES.includes(file.type)) {\n\t\t\treturn { valid: false, error: `Invalid file type: ${file.type}` };\n\t\t}\n\t\t// Check file size\n\t\tif (file.size > MAX_FILE_SIZE) {\n\t\t\treturn { valid: false, error: `File too large (max 10MB): ${(file.size / 1024 / 1024).toFixed(2)}MB` };\n\t\t}\n\t\t// Check file extension\n\t\tconst ext = file.name.split('.').pop()?.toLowerCase();\n\t\tif (!ext || !VALID_EXTENSIONS.includes(ext)) {\n\t\t\treturn { valid: false, error: `Invalid file extension: ${ext}` };\n\t\t}\n\t\t// Basic filename sanitization check (prevent path traversal)\n\t\tif (file.name.includes('..') || file.name.includes('/') || file.name.includes('\\\\')) {\n\t\t\treturn { valid: false, error: 'Invalid filename characters detected' };\n\t\t}\n\t\treturn { valid: true };\n\t}\n\n\tlet { field, value = $bindable(), error }: { field: FieldType; value: string | string[] | null | undefined; error?: string | null } = $props();\n\n\t// A local, reactive array of the full, resolved media file objects for display.\n\tlet selectedFiles = $state<MediaFile[]>([]);\n\n\t// Helper function to fetch full media data from an array of IDs.\n\tasync function fetchMediaData(ids: string[]): Promise<MediaFile[]> {\n\t\t// In a real app, this would be an API call: GET /api/media?ids=id1,id2,...\n\t\t// For this example, we'll simulate it with a timeout.\n\t\tlogger.debug('Fetching data for IDs:', ids);\n\t\treturn new Promise((resolve) =>\n\t\t\tsetTimeout(() => {\n\t\t\t\tconst files: MediaFile[] = ids.map((id) => ({\n\t\t\t\t\t_id: id,\n\t\t\t\t\tname: `Image ${id.slice(0, 4)}.jpg`,\n\t\t\t\t\ttype: 'image/jpeg',\n\t\t\t\t\tsize: 12345,\n\t\t\t\t\turl: `https://picsum.photos/id/${parseInt(id.slice(0, 3), 10)}/1920/1080`,\n\t\t\t\t\tthumbnailUrl: `https://picsum.photos/id/${parseInt(id.slice(0, 3), 10)}/200/200`\n\t\t\t\t}));\n\t\t\t\tresolve(files);\n\t\t\t}, 300)\n\t\t);\n\t}\n\n\t// Effect 1: When the parent `value` (the IDs) changes, fetch the full data.\n\t$effect(() => {\n\t\tconst ids = Array.isArray(value) ? value : value ? [value] : [];\n\t\tif (ids.length > 0) {\n\t\t\tfetchMediaData(ids).then((files) => {\n\t\t\t\tselectedFiles = files;\n\t\t\t});\n\t\t} else {\n\t\t\tselectedFiles = [];\n\t\t}\n\t});\n\n\t// Effect 2: When the local `selectedFiles` array changes (e.g., reordering), update the parent `value`.\n\t$effect(() => {\n\t\tconst newIds = selectedFiles.map((file) => file._id);\n\t\tif (field.multiupload) {\n\t\t\tvalue = newIds;\n\t\t} else {\n\t\t\tvalue = newIds[0] || null;\n\t\t}\n\t});\n\n\t// Function to open the Media Library modal.\n\tfunction openMediaLibrary() {\n\t\tmodalState.trigger(MediaLibraryModal as any, { multiSelect: field.multiupload || false }, (files: any) => {\n\t\t\tif (files) {\n\t\t\t\t// SECURITY: Validate files before adding them\n\t\t\t\tconst validFiles = files.filter((file: MediaFile) => {\n\t\t\t\t\t// Mock File object for validation since we only have MediaFile metadata here\n\t\t\t\t\t// In a real upload scenario, we would validate the actual File object\n\t\t\t\t\tconst mockFile = {\n\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\tsize: file.size\n\t\t\t\t\t} as File;\n\n\t\t\t\t\tconst validation = validateFile(mockFile);\n\t\t\t\t\tif (!validation.valid) {\n\t\t\t\t\t\tlogger.warn(`[MediaUpload Security] Rejected file ${file.name}: ${validation.error}`);\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\treturn true;\n\t\t\t\t});\n\n\t\t\t\tif (field.multiupload) {\n\t\t\t\t\tselectedFiles = [...selectedFiles, ...validFiles];\n\t\t\t\t} else if (validFiles.length > 0) {\n\t\t\t\t\tselectedFiles = [validFiles[0]];\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t// Function to remove a selected file.\n\tfunction removeFile(fileId: string) {\n\t\tselectedFiles = selectedFiles.filter((file) => file._id !== fileId);\n\t}\n</script>\n\n<div class=\"min-h-[120px] rounded-lg border-2 border-dashed border-surface-300 p-4 dark:border-surface-600\" class:!border-error-500={error}>\n\t{#if selectedFiles.length > 0}\n\t\t<div\n\t\t\tclass=\"mb-4 grid gap-4 [grid-cols-[repeat(auto-fill,minmax(100px,1fr))]\"\n\t\t\tuse:dndzone={{ items: selectedFiles }}\n\t\t\tonconsider={(e) => (selectedFiles = e.detail.items)}\n\t\t>\n\t\t\t{#each selectedFiles as file (file._id)}\n\t\t\t\t<div class=\"relative overflow-hidden rounded border border-surface-200 dark:text-surface-50\" animate:flip>\n\t\t\t\t\t<img src={file.thumbnailUrl} alt={file.name} class=\"h-[100px] w-full object-cover\" />\n\t\t\t\t\t<span class=\"block truncate p-1 text-center text-xs\">{file.name}</span>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => removeFile(file._id)}\n\t\t\t\t\t\tclass=\"absolute right-1 top-1 flex h-5 w-5 cursor-pointer items-center justify-center rounded-full border-none bg-surface-900/50 text-white transition-colors hover:bg-surface-900/75\"\n\t\t\t\t\t\taria-label=\"Remove\"\n\t\t\t\t\t>\n\t\t\t\t\t\t√ó\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t{/each}\n\t\t</div>\n\t{/if}\n\n\t{#if field.multiupload || selectedFiles.length === 0}\n\t\t<button\n\t\t\ttype=\"button\"\n\t\t\tonclick={openMediaLibrary}\n\t\t\tclass=\"w-full cursor-pointer rounded border-none bg-surface-100 p-3 transition-colors hover:bg-surface-200 dark:bg-surface-700 dark:hover:bg-surface-600\"\n\t\t>\n\t\t\t+ Add Media\n\t\t</button>\n\t{/if}\n\n\t{#if error}\n\t\t<p class=\"absolute -bottom-4 left-0 w-full text-center text-xs text-error-500\" role=\"alert\">{error}</p>\n\t{/if}\n</div>\n"],"names":["$.attr","$.escape"],"mappings":";;;;wCAoBA;UA+CO,OAAO,QAAK,QAAgB,MAAK,IAAA;QAGnC,gBAAa,CAAA;wKAiFmH,OAAK,CAAA,GAAA;QACpI,cAAc,SAAS,GAAC;;;2CAMpB,aAAa;;YAAI,OAAI,WAAA,OAAA;yIAEhB,KAAK,YAAY,CAAA,GAAAA,KAAA,OAAO,KAAK,IAAI,CAAA,iGAAAC,YACW,KAAK,IAAI,CAAA,6OAAA;AAAA;;;;;;AAa9D,QAAA,MAAM,eAAe,cAAc,WAAW,GAAC;;;;;;;QAU/C,OAAK;;kIACoF,KAAK,CAAA,MAAA;AAAA;;;;;EApC5F,CAAA;;"}