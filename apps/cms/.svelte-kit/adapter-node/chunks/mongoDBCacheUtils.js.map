{"version":3,"file":"mongoDBCacheUtils.js","sources":["../../../../../../shared/database/src/mongodb/methods/mongoDBCacheUtils.ts"],"sourcesContent":["/**\n * @file src/databases/mongodb/methods/mongoDBCacheUtils.ts\n * @description Caching utilities for MongoDB adapter.\n * Separated from mongoDBUtils.ts to avoid circular dependencies with CacheService.\n */\n\nimport { logger } from '@shared/utils/logger.server';\nimport { cacheService } from '@shared/database/CacheService';\nimport { CacheCategory } from '@shared/database/CacheCategory';\nimport { cacheMetrics } from '@shared/database/CacheMetrics';\n\n// Re-export for convenience\nexport { CacheCategory };\n\n//Options for cache operations\nexport interface CacheWrapperOptions {\n\tcategory: CacheCategory;\n\ttenantId?: string;\n\tttl?: number; // Override default TTL (uses category-based TTL from settings if not provided)\n\tforceRefresh?: boolean; // Bypass cache and force DB query\n}\n\n/**\n * Wraps a database query with intelligent caching logic\n *\n * Features:\n * - Automatic cache hit/miss tracking\n * - Multi-tenant isolation via CacheService\n * - Category-based TTL from database settings (dynamically configurable)\n * - Resilient fallback on cache failure\n * - Performance monitoring\n *\n * @param cacheKey Unique key for this query\n * @param queryFn Function that executes the actual database query\n * @param options Caching options (category, tenantId, ttl)\n * @returns Query result (from cache or fresh from DB)\n *\n * @example\n * ```typescript\n * const widgets = await withCache(\n *   'widgets:active',\n *   () => this.widgetRepo.findMany({ isActive: true }),\n *   { category: CacheCategory.WIDGET, tenantId: 'acme_corp' }\n * );\n * ```\n */\nexport async function withCache<T>(cacheKey: string, queryFn: () => Promise<T>, options: CacheWrapperOptions): Promise<T> {\n\tconst startTime = performance.now();\n\tconst { category, tenantId, ttl, forceRefresh = false } = options;\n\n\ttry {\n\t\t// Initialize cache service\n\t\tawait cacheService.initialize();\n\n\t\t// Force refresh bypasses cache\n\t\tif (forceRefresh) {\n\t\t\tlogger.debug(`Cache FORCE REFRESH: ${cacheKey}`, { category, tenantId });\n\t\t\tconst result = await queryFn();\n\n\t\t\t// Update cache with fresh data using category-based TTL from CacheService\n\t\t\tif (ttl !== undefined) {\n\t\t\t\t// Use explicit TTL if provided\n\t\t\t\tawait cacheService.set(cacheKey, result, ttl, tenantId, category);\n\t\t\t} else {\n\t\t\t\t// Use category-based TTL from settings (dynamic, configurable)\n\t\t\t\tawait cacheService.setWithCategory(cacheKey, result, category, tenantId);\n\t\t\t}\n\t\t\tcacheMetrics.recordSet(cacheKey, category, ttl || 0, tenantId);\n\n\t\t\treturn result;\n\t\t}\n\n\t\t// Try to get from cache first (with category for metrics)\n\t\tconst cached = await cacheService.get<T>(cacheKey, tenantId, category);\n\n\t\tif (cached !== null) {\n\t\t\t// Cache HIT\n\t\t\tconst responseTime = performance.now() - startTime;\n\t\t\tcacheMetrics.recordHit(cacheKey, category, tenantId, responseTime);\n\t\t\tlogger.debug(`Cache HIT: ${cacheKey}`, {\n\t\t\t\tcategory,\n\t\t\t\ttenantId,\n\t\t\t\tresponseTime: `${responseTime.toFixed(2)}ms`\n\t\t\t});\n\t\t\treturn cached;\n\t\t}\n\n\t\t// Cache MISS - execute query\n\t\tconst missTime = performance.now() - startTime;\n\t\tcacheMetrics.recordMiss(cacheKey, category, tenantId, missTime);\n\t\tlogger.debug(`Cache MISS: ${cacheKey}`, {\n\t\t\tcategory,\n\t\t\ttenantId,\n\t\t\tresponseTime: `${missTime.toFixed(2)}ms`\n\t\t});\n\n\t\tconst result = await queryFn();\n\n\t\t// Store in cache using category-based TTL from CacheService (dynamic, configurable)\n\t\tif (ttl !== undefined) {\n\t\t\t// Use explicit TTL if provided\n\t\t\tawait cacheService.set(cacheKey, result, ttl, tenantId, category);\n\t\t} else {\n\t\t\t// Use category-based TTL from settings (allows runtime changes)\n\t\t\tawait cacheService.setWithCategory(cacheKey, result, category, tenantId);\n\t\t}\n\t\tcacheMetrics.recordSet(cacheKey, category, ttl || 0, tenantId);\n\n\t\treturn result;\n\t} catch (error) {\n\t\t// If caching fails, still return the query result (resilience)\n\t\tlogger.warn(`Cache wrapper error for ${cacheKey}, falling back to direct query:`, {\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\tcategory,\n\t\t\ttenantId\n\t\t});\n\t\treturn queryFn();\n\t}\n}\n\n/**\n * Generates a consistent cache key from query parameters\n *\n * @param collection Collection name\n * @param operation Operation type (e.g., 'findOne', 'findMany', 'aggregate')\n * @param params Query parameters (will be hashed)\n * @returns Consistent cache key\n *\n * @example\n * ```typescript\n * const key = generateCacheKey('users', 'findOne', { email: 'user@example.com' });\n * // Result: \"collection:users:findOne:a3f7b2\"\n * ```\n */\nexport function generateCacheKey(collection: string, operation: string, params: Record<string, unknown> = {}): string {\n\tconst paramsHash = hashObject(params);\n\treturn `collection:${collection}:${operation}:${paramsHash}`;\n}\n\n/**\n * Hashes an object for use in cache keys\n * Uses a simple but effective hash algorithm\n */\nfunction hashObject(obj: Record<string, unknown>): string {\n\tconst str = JSON.stringify(obj, Object.keys(obj).sort());\n\treturn hashString(str);\n}\n\n/**\n * Simple string hashing for cache keys\n * Uses DJB2 hash algorithm (fast and good distribution)\n */\nfunction hashString(str: string): string {\n\tlet hash = 5381;\n\tfor (let i = 0; i < str.length; i++) {\n\t\tconst char = str.charCodeAt(i);\n\t\thash = (hash << 5) + hash + char; // hash * 33 + char\n\t}\n\treturn Math.abs(hash).toString(36);\n}\n\n/**\n * Invalidates cache for a specific collection\n * Useful after write operations (create, update, delete)\n *\n * @param collection Collection name to invalidate\n * @param tenantId Optional tenant ID for multi-tenant isolation\n */\nexport async function invalidateCollectionCache(collection: string, tenantId?: string): Promise<void> {\n\ttry {\n\t\tawait cacheService.initialize();\n\t\tconst pattern = `collection:${collection}:*`;\n\t\tawait cacheService.clearByPattern(pattern, tenantId);\n\t\tcacheMetrics.recordClear(pattern, CacheCategory.CONTENT, tenantId);\n\t\tlogger.debug(`Cache invalidated for collection: ${collection}`, { tenantId });\n\t} catch (error) {\n\t\tlogger.warn(`Failed to invalidate cache for collection ${collection}:`, error);\n\t}\n}\n\n/**\n * Invalidates cache by category\n * Useful for clearing all widgets, themes, etc.\n *\n * @param category Cache category to invalidate\n * @param tenantId Optional tenant ID for multi-tenant isolation\n */\nexport async function invalidateCategoryCache(category: CacheCategory, tenantId?: string): Promise<void> {\n\ttry {\n\t\tawait cacheService.initialize();\n\t\tconst tenantScope = tenantId ?? '*';\n\t\tconst patterns = new Set<string>();\n\t\tpatterns.add(`${category}:*`);\n\t\tpatterns.add(`*:${category}:*`);\n\n\t\tlet clearedAny = false;\n\t\tfor (const pattern of patterns) {\n\t\t\tawait cacheService.clearByPattern(pattern, tenantScope);\n\t\t\tcacheMetrics.recordClear(pattern, category, tenantId);\n\t\t\tclearedAny = true;\n\t\t}\n\n\t\tif (clearedAny) {\n\t\t\tlogger.debug(`Cache invalidated for category: ${category}`, { tenantId: tenantId ?? 'all-tenants' });\n\t\t}\n\t} catch (error) {\n\t\tlogger.warn(`Failed to invalidate cache for category ${category}:`, error);\n\t}\n}\n\n/**\n * Deletes a specific cache entry\n *\n * @param cacheKey Cache key to delete\n * @param category Cache category for metrics\n * @param tenantId Optional tenant ID\n */\nexport async function deleteCache(cacheKey: string, category: CacheCategory, tenantId?: string): Promise<void> {\n\ttry {\n\t\tawait cacheService.initialize();\n\t\tawait cacheService.delete(cacheKey, tenantId);\n\t\tcacheMetrics.recordDelete(cacheKey, category, tenantId);\n\t\tlogger.debug(`Cache entry deleted: ${cacheKey}`, { category, tenantId });\n\t} catch (error) {\n\t\tlogger.warn(`Failed to delete cache entry ${cacheKey}:`, error);\n\t}\n}\n"],"names":["result"],"mappings":"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"}