{"version":3,"file":"SecurityResponseService.js","sources":["../../../../../../shared/services/src/SecurityResponseService.ts"],"sourcesContent":["/**\n * @file shared/services/src/SecurityResponseService.ts\n * @description Automated security response system with dynamic threat detection\n *\n * ### Features\n * - Real-time threat detection and classification\n * - Dynamic rate limiting based on threat level\n * - Automated IP blocking for severe threats\n * - Security incident reporting and alerting\n * - Integration with existing rate limiter\n * - Configurable response policies\n *\n * ### Threat Detection\n * - **Level 1 (Low)**: Unusual request patterns, minor policy violations\n * - **Level 2 (Medium)**: Repeated CSP violations, auth failures, rate limit hits\n * - **Level 3 (High)**: SQL injection attempts, XSS patterns, brute force\n * - **Level 4 (Critical)**: Active attacks, coordinated threats, system intrusion\n *\n * @enterprise Advanced threat detection for production environments\n */\n\nimport { logger } from '@shared/utils/logger.server';\nimport { metricsService } from './MetricsService';\nimport { building } from '$app/environment';\n\n// --- TYPES ---\n\nexport type ThreatLevel = 'none' | 'low' | 'medium' | 'high' | 'critical';\nexport type ResponseAction = 'monitor' | 'warn' | 'throttle' | 'block' | 'blacklist' | 'challenge' | 'allow';\n\nexport interface SecurityStatus {\n\tlevel: ThreatLevel;\n\taction: ResponseAction;\n\treason?: string;\n}\n\nexport interface ThreatIndicator {\n\ttype: 'rate_limit' | 'auth_failure' | 'csp_violation' | 'sql_injection' | 'xss_attempt' | 'brute_force' | 'suspicious_ua' | 'ip_reputation';\n\tseverity: number; // 1-10 scale\n\tevidence: string;\n\ttimestamp: number;\n\tmetadata?: Record<string, unknown>;\n}\n\nexport interface SecurityIncident {\n\tid: string;\n\tclientIp: string;\n\tuserAgent?: string;\n\tthreatLevel: ThreatLevel;\n\tindicators: ThreatIndicator[];\n\tresponseActions: ResponseAction[];\n\ttimestamp: number;\n\tresolved: boolean;\n\tnotes?: string;\n}\n\nexport interface SecurityPolicy {\n\tname: string;\n\tthreatLevel: ThreatLevel;\n\ttriggers: {\n\t\tindicatorThreshold: number; // Number of indicators needed\n\t\ttimeWindow: number; // Time window in milliseconds\n\t\tseverityThreshold: number; // Minimum severity score\n\t};\n\tresponses: ResponseAction[];\n\tcooldownPeriod: number; // How long to maintain response\n}\n\n// --- SECURITY POLICIES ---\n\nconst DEFAULT_POLICIES: SecurityPolicy[] = [\n\t{\n\t\tname: 'Moderate Threat Response',\n\t\tthreatLevel: 'medium',\n\t\ttriggers: {\n\t\t\tindicatorThreshold: 3,\n\t\t\ttimeWindow: 5 * 60 * 1000, // 5 minutes\n\t\t\tseverityThreshold: 5\n\t\t},\n\t\tresponses: ['warn', 'throttle'],\n\t\tcooldownPeriod: 15 * 60 * 1000 // 15 minutes\n\t},\n\t{\n\t\tname: 'High Threat Response',\n\t\tthreatLevel: 'high',\n\t\ttriggers: {\n\t\t\tindicatorThreshold: 5,\n\t\t\ttimeWindow: 10 * 60 * 1000, // 10 minutes\n\t\t\tseverityThreshold: 7\n\t\t},\n\t\tresponses: ['warn', 'block'],\n\t\tcooldownPeriod: 30 * 60 * 1000 // 30 minutes\n\t},\n\t{\n\t\tname: 'Critical Threat Response',\n\t\tthreatLevel: 'critical',\n\t\ttriggers: {\n\t\t\tindicatorThreshold: 3,\n\t\t\ttimeWindow: 5 * 60 * 1000, // 5 minutes\n\t\t\tseverityThreshold: 9\n\t\t},\n\t\tresponses: ['warn', 'blacklist'],\n\t\tcooldownPeriod: 60 * 60 * 1000 // 1 hour\n\t}\n];\n\n// --- THREAT PATTERNS ---\n// Moved inside class or used via this.patterns\n\n// --- SECURITY RESPONSE SERVICE ---\n\nclass SecurityResponseService {\n\tprivate incidents = new Map<string, SecurityIncident>();\n\tprivate blockedIPs = new Set<string>();\n\tprivate throttledIPs = new Map<string, { until: number; factor: number }>();\n\tprivate policies: SecurityPolicy[] = [];\n\tprivate cleanupInterval: NodeJS.Timeout | null = null;\n\n\t// Pre-compiled regex patterns for performance and ReDoS prevention\n\tprivate patterns = {\n\t\tsqli: [\n\t\t\t/(\\%27)|(\\')|(\\-\\-)|(\\%23)|(#)/i,\n\t\t\t/((\\%3D)|(=))[^\\n]*((\\%27)|(\\')|(\\-\\-)|(\\%3B)|(;))/i,\n\t\t\t/\\w*((\\%27)|(\\'))((\\%6F)|o|(\\%4F))((\\%72)|r|(\\%52))/i,\n\t\t\t/((\\%27)|(\\'))union/i,\n\t\t\t/exec(\\s|\\+)+(s|x)p\\w+/i\n\t\t],\n\t\txss: [\n\t\t\t/((\\%3C)|<)((\\%2F)|\\/)*[a-z0-9\\%]+((\\%3E)|>)/i,\n\t\t\t/((\\%3C)|<)((\\%69)|i|(\\%49))((\\%6D)|m|(\\%4D))((\\%67)|g|(\\%47))[^\\n]+((\\%3E)|>)/i,\n\t\t\t/((\\%3C)|<)[^\\n]+((\\%3E)|>)/i\n\t\t],\n\t\tpathTraversal: [\n\t\t\t/(\\.\\.(\\/|\\\\))/i, // Basic ../\n\t\t\t/(\\%2e\\%2e(\\%2f|\\%5c))/i // Encoded ../\n\t\t],\n\t\tsuspicious_ua: [/sqlmap/i, /nikto/i, /burpsuite/i, /nmap/i, /masscan/i, /bot/i]\n\t};\n\n\tconstructor() {\n\t\tthis.policies = [...DEFAULT_POLICIES];\n\n\t\t// Cleanup old incidents every hour\n\t\tif (!building) {\n\t\t\tthis.cleanupInterval = setInterval(\n\t\t\t\t() => {\n\t\t\t\t\tthis.cleanupOldIncidents();\n\t\t\t\t},\n\t\t\t\t60 * 60 * 1000\n\t\t\t);\n\t\t}\n\t}\n\n\t// --- THREAT DETECTION ---\n\n\t/**\n\t * Analyzes a request for potential security threats.\n\t */\n\tpublic async analyzeRequest(request: Request, clientIp: string): Promise<SecurityStatus> {\n\t\t// 1. Check Blocklist (Fastest check)\n\t\tif (this.isBlocked(clientIp)) {\n\t\t\treturn {\n\t\t\t\tlevel: 'critical',\n\t\t\t\taction: 'block',\n\t\t\t\treason: 'IP is in blocklist'\n\t\t\t};\n\t\t}\n\n\t\t// 2. Rate Limiting (Fast check)\n\t\tconst rateLimitResult = await this.checkRateLimit(clientIp);\n\t\tif (!rateLimitResult.allowed) {\n\t\t\treturn {\n\t\t\t\tlevel: 'high',\n\t\t\t\taction: 'throttle',\n\t\t\t\treason: 'Rate limit exceeded'\n\t\t\t};\n\t\t}\n\n\t\t// 3. Payload Analysis (Slower, CPU intensive)\n\t\t// Only proceed if not already blocked/throttled\n\t\tconst threatLevel = await this.analyzePayload(request);\n\n\t\tif (threatLevel === 'critical') {\n\t\t\tawait this.blockIp(clientIp, 'Critical threat detected in payload');\n\t\t\treturn { level: 'critical', action: 'block', reason: 'Malicious payload detected' };\n\t\t} else if (threatLevel === 'high') {\n\t\t\treturn { level: 'high', action: 'challenge', reason: 'Suspicious payload detected' };\n\t\t}\n\n\t\treturn { level: 'none', action: 'allow' };\n\t}\n\n\t/**\n\t * Analyzes the request payload (URL, body, headers) for threats.\n\t */\n\tprivate async analyzePayload(request: Request): Promise<ThreatLevel> {\n\t\tconst url = new URL(request.url);\n\t\tconst queryString = url.search;\n\t\tconst body = request.method !== 'GET' ? await request.clone().text() : '';\n\t\tconst allContent = `${url.pathname} ${queryString} ${body}`;\n\t\tconst userAgent = request.headers.get('user-agent') || '';\n\n\t\t// Check for SQL injection patterns\n\t\tfor (const pattern of this.patterns.sqli) {\n\t\t\tif (pattern.test(allContent)) return 'critical';\n\t\t}\n\n\t\t// Check for XSS patterns\n\t\tfor (const pattern of this.patterns.xss) {\n\t\t\tif (pattern.test(allContent)) return 'high';\n\t\t}\n\n\t\t// Check for Path Traversal\n\t\tfor (const pattern of this.patterns.pathTraversal) {\n\t\t\tif (pattern.test(allContent)) return 'high';\n\t\t}\n\n\t\t// Check for suspicious user agents\n\t\tfor (const pattern of this.patterns.suspicious_ua) {\n\t\t\tif (pattern.test(userAgent)) return 'medium';\n\t\t}\n\n\t\treturn 'none';\n\t}\n\n\t/**\n\t * Checks if the IP has exceeded rate limits.\n\t * (Placeholder for actual rate limit logic, possibly using Redis)\n\t */\n\tprivate async checkRateLimit(ip: string): Promise<{ allowed: boolean }> {\n\t\t// TODO: Implement actual rate limiting\n\t\t// For now, check if IP is in throttled list\n\t\tconst throttle = this.throttledIPs.get(ip);\n\t\tif (throttle && Date.now() < throttle.until) {\n\t\t\treturn { allowed: false };\n\t\t}\n\t\treturn { allowed: true };\n\t}\n\n\t/**\n\t * Blocks an IP address.\n\t */\n\tpublic async blockIp(ip: string, reason: string): Promise<void> {\n\t\tthis.blockedIPs.add(ip);\n\t\tlogger.warn(`IP blocked: ${ip}. Reason: ${reason}`);\n\t\t// Create incident\n\t\tthis.reportSecurityEvent(ip, 'ip_reputation', 10, reason);\n\t}\n\n\t// Report a security event (rate limit hit, auth failure, etc.)\n\treportSecurityEvent(ip: string, eventType: ThreatIndicator['type'], severity: number, evidence: string, metadata?: Record<string, unknown>): void {\n\t\tconst indicator: ThreatIndicator = {\n\t\t\ttype: eventType,\n\t\t\tseverity,\n\t\t\tevidence,\n\t\t\ttimestamp: Date.now(),\n\t\t\tmetadata\n\t\t};\n\n\t\tthis.processIndicator(ip, indicator);\n\t}\n\n\t// Process a threat indicator and determine response\n\tprivate processIndicator(ip: string, indicator: ThreatIndicator): void {\n\t\t// Get or create incident for this IP\n\t\tlet incident = this.incidents.get(ip);\n\t\tif (!incident) {\n\t\t\tincident = {\n\t\t\t\tid: `inc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n\t\t\t\tclientIp: ip,\n\t\t\t\tthreatLevel: 'none',\n\t\t\t\tindicators: [],\n\t\t\t\tresponseActions: [],\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t\tresolved: false\n\t\t\t};\n\t\t\tthis.incidents.set(ip, incident);\n\t\t}\n\n\t\t// Add indicator to incident\n\t\tincident.indicators.push(indicator);\n\n\t\t// Evaluate threat level and determine response\n\t\tthis.evaluateIncident(incident);\n\t}\n\n\t// Evaluate an incident and determine appropriate response\n\tprivate evaluateIncident(incident: SecurityIncident): void {\n\t\tconst now = Date.now();\n\n\t\t// Filter recent indicators (within time windows)\n\t\tfor (const policy of this.policies) {\n\t\t\tconst recentIndicators = incident.indicators.filter(\n\t\t\t\t(ind) => now - ind.timestamp <= policy.triggers.timeWindow && ind.severity >= policy.triggers.severityThreshold\n\t\t\t);\n\n\t\t\tif (recentIndicators.length >= policy.triggers.indicatorThreshold) {\n\t\t\t\t// Policy triggered - escalate response\n\t\t\t\tincident.threatLevel = policy.threatLevel;\n\t\t\t\tincident.responseActions = [...policy.responses];\n\n\t\t\t\tthis.executeResponse(incident, policy);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Execute security response actions\n\tprivate executeResponse(incident: SecurityIncident, policy: SecurityPolicy): void {\n\t\tconst ip = incident.clientIp;\n\n\t\tfor (const action of policy.responses) {\n\t\t\tswitch (action) {\n\t\t\t\tcase 'monitor':\n\t\t\t\t\t// Just log - no action\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'warn':\n\t\t\t\t\tlogger.warn(`Security incident detected`, {\n\t\t\t\t\t\tip,\n\t\t\t\t\t\tthreatLevel: incident.threatLevel,\n\t\t\t\t\t\tindicatorCount: incident.indicators.length,\n\t\t\t\t\t\tincidentId: incident.id\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'throttle': {\n\t\t\t\t\tconst throttleUntil = Date.now() + policy.cooldownPeriod;\n\t\t\t\t\tthis.throttledIPs.set(ip, {\n\t\t\t\t\t\tuntil: throttleUntil,\n\t\t\t\t\t\tfactor: this.getThrottleFactor(incident.threatLevel)\n\t\t\t\t\t});\n\n\t\t\t\t\tlogger.warn(`IP throttled due to security threat`, {\n\t\t\t\t\t\tip,\n\t\t\t\t\t\tthrottleUntil: new Date(throttleUntil),\n\t\t\t\t\t\tfactor: this.getThrottleFactor(incident.threatLevel)\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tcase 'block': {\n\t\t\t\t\tconst blockUntil = Date.now() + policy.cooldownPeriod;\n\t\t\t\t\tthis.blockedIPs.add(ip);\n\n\t\t\t\t\t// Schedule unblock\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tthis.blockedIPs.delete(ip);\n\t\t\t\t\t\tlogger.info(`IP unblocked after cooldown period`, { ip });\n\t\t\t\t\t}, policy.cooldownPeriod);\n\n\t\t\t\t\tlogger.error(`IP blocked due to security threat`, {\n\t\t\t\t\t\tip,\n\t\t\t\t\t\tblockUntil: new Date(blockUntil),\n\t\t\t\t\t\tincidentId: incident.id\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tcase 'blacklist':\n\t\t\t\t\tthis.blockedIPs.add(ip);\n\t\t\t\t\tlogger.error(`IP blacklisted due to critical security threat`, {\n\t\t\t\t\t\tip,\n\t\t\t\t\t\tincidentId: incident.id,\n\t\t\t\t\t\tpermanent: true\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t// Track security response metrics\n\t\tmetricsService.incrementRateLimitViolations();\n\t}\n\n\t// Get throttle factor based on threat level\n\tprivate getThrottleFactor(threatLevel: ThreatLevel): number {\n\t\tswitch (threatLevel) {\n\t\t\tcase 'low':\n\t\t\t\treturn 2;\n\t\t\tcase 'medium':\n\t\t\t\treturn 5;\n\t\t\tcase 'high':\n\t\t\t\treturn 10;\n\t\t\tcase 'critical':\n\t\t\t\treturn 20;\n\t\t\tdefault:\n\t\t\t\treturn 1;\n\t\t}\n\t}\n\n\t// --- PUBLIC API ---\n\n\t// Check if an IP is currently blocked\n\tisBlocked(ip: string): boolean {\n\t\treturn this.blockedIPs.has(ip);\n\t}\n\n\t// Check if an IP is currently throttled and get throttle factor\n\tgetThrottleStatus(ip: string): { throttled: boolean; factor: number } {\n\t\tconst throttle = this.throttledIPs.get(ip);\n\t\tif (!throttle || Date.now() > throttle.until) {\n\t\t\tthis.throttledIPs.delete(ip);\n\t\t\treturn { throttled: false, factor: 1 };\n\t\t}\n\t\treturn { throttled: true, factor: throttle.factor };\n\t}\n\n\t/**\n\t * Get all active security incidents.\n\t */\n\tgetActiveIncidents(): SecurityIncident[] {\n\t\treturn Array.from(this.incidents.values()).filter((inc) => !inc.resolved);\n\t}\n\n\t/**\n\t * Get security statistics for monitoring.\n\t */\n\tgetSecurityStats(): {\n\t\tactiveIncidents: number;\n\t\tblockedIPs: number;\n\t\tthrottledIPs: number;\n\t\ttotalIncidents: number;\n\t\tthreatLevelDistribution: Record<ThreatLevel, number>;\n\t} {\n\t\tconst incidents = Array.from(this.incidents.values());\n\t\tconst threatDistribution: Record<ThreatLevel, number> = {\n\t\t\tnone: 0,\n\t\t\tlow: 0,\n\t\t\tmedium: 0,\n\t\t\thigh: 0,\n\t\t\tcritical: 0\n\t\t};\n\n\t\tincidents.forEach((inc) => {\n\t\t\tthreatDistribution[inc.threatLevel]++;\n\t\t});\n\n\t\treturn {\n\t\t\tactiveIncidents: incidents.filter((inc) => !inc.resolved).length,\n\t\t\tblockedIPs: this.blockedIPs.size,\n\t\t\tthrottledIPs: this.throttledIPs.size,\n\t\t\ttotalIncidents: incidents.length,\n\t\t\tthreatLevelDistribution: threatDistribution\n\t\t};\n\t}\n\n\t/**\n\t * Manually resolve an incident.\n\t */\n\tresolveIncident(incidentId: string, notes?: string): boolean {\n\t\tfor (const incident of this.incidents.values()) {\n\t\t\tif (incident.id === incidentId) {\n\t\t\t\tincident.resolved = true;\n\t\t\t\tincident.notes = notes;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Manually unblock an IP address.\n\t */\n\tunblockIP(ip: string): boolean {\n\t\tif (this.blockedIPs.has(ip)) {\n\t\t\tthis.blockedIPs.delete(ip);\n\t\t\tthis.throttledIPs.delete(ip);\n\t\t\tlogger.info(`IP manually unblocked`, { ip });\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\t// --- CLEANUP ---\n\n\t/**\n\t * Clean up old incidents and expired blocks.\n\t */\n\tprivate cleanupOldIncidents(): void {\n\t\tconst now = Date.now();\n\t\tconst maxAge = 24 * 60 * 60 * 1000; // 24 hours\n\n\t\t// Remove old incidents\n\t\tfor (const [ip, incident] of this.incidents.entries()) {\n\t\t\tif (now - incident.timestamp > maxAge && incident.resolved) {\n\t\t\t\tthis.incidents.delete(ip);\n\t\t\t}\n\t\t}\n\n\t\t// Remove expired throttles\n\t\tfor (const [ip, throttle] of this.throttledIPs.entries()) {\n\t\t\tif (now > throttle.until) {\n\t\t\t\tthis.throttledIPs.delete(ip);\n\t\t\t}\n\t\t}\n\n\t\tlogger.trace('Security incidents cleanup completed');\n\t}\n\n\t/**\n\t * Cleanup resources when shutting down.\n\t */\n\tdestroy(): void {\n\t\tif (this.cleanupInterval) {\n\t\t\tclearInterval(this.cleanupInterval);\n\t\t\tthis.cleanupInterval = null;\n\t\t}\n\t}\n}\n\n// --- SINGLETON INSTANCE ---\n\n/**\n * Global security response service instance.\n */\nexport const securityResponseService = new SecurityResponseService();\n\n/**\n * Cleanup function for graceful shutdown.\n */\nexport const cleanupSecurityService = (): void => {\n\tsecurityResponseService.destroy();\n};\n\n// Cleanup on process exit (server-only)\nif (!building && typeof process !== 'undefined' && typeof window === 'undefined') {\n\tprocess.on('SIGTERM', cleanupSecurityService);\n\tprocess.on('SIGINT', cleanupSecurityService);\n}\n"],"names":[],"mappings":"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"}