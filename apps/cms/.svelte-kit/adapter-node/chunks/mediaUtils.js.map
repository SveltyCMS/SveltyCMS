{"version":3,"file":"mediaUtils.js","sources":["../../../../../../shared/utils/src/media/mediaUtils.ts"],"sourcesContent":["/**\n * @file src/utils/media/mediaUtils.ts\n * @description Client-safe media utilities (MIME, URL construction, validation)\n */\n\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\nimport { formatBytes, removeExtension } from '@shared/utils/utils';\n// import { logger } from '@shared/utils/logger';\n\nimport type { MediaBase } from './mediaModels';\n\n/** Browser-compatible MIME lookup */\nexport function getMimeType(name: string): string | null {\n\tconst ext = name.toLowerCase().split('.').pop();\n\tif (!ext) return null;\n\n\tconst map: Record<string, string> = {\n\t\t// Images\n\t\tjpg: 'image/jpeg',\n\t\tjpeg: 'image/jpeg',\n\t\tpng: 'image/png',\n\t\tgif: 'image/gif',\n\t\twebp: 'image/webp',\n\t\tsvg: 'image/svg+xml',\n\t\tavif: 'image/avif',\n\t\tbmp: 'image/bmp',\n\t\tico: 'image/x-icon',\n\n\t\t// Documents\n\t\tpdf: 'application/pdf',\n\t\ttxt: 'text/plain',\n\n\t\t// Audio\n\t\tmp3: 'audio/mpeg',\n\t\twav: 'audio/wav',\n\t\togg: 'audio/ogg',\n\t\taac: 'audio/aac',\n\t\tflac: 'audio/flac',\n\t\tm4a: 'audio/mp4',\n\n\t\t// Video\n\t\tmp4: 'video/mp4',\n\t\twebm: 'video/webm',\n\t\tmov: 'video/quicktime'\n\t};\n\n\treturn map[ext] ?? null;\n}\n\n/** Construct public media URL */\nexport function mediaUrl(item: MediaBase, size?: string): string {\n\tif (!item?.url) return '';\n\n\tif (publicEnv.MEDIASERVER_URL) {\n\t\treturn `${publicEnv.MEDIASERVER_URL.replace(/\\/+$/, '')}/${item.url}`;\n\t}\n\n\tif (size && 'thumbnails' in item && (item.thumbnails as any)?.[size]?.url) {\n\t\treturn (item.thumbnails as any)[size].url;\n\t}\n\n\treturn `/files/${item.url}`;\n}\n\n/** Build URL from parts (hash-based naming) */\nexport function buildUrl(path: string, hash: string, filename: string, ext: string, category: string, size?: string): string {\n\tif (!path || !hash || !filename || !ext || !category) return '';\n\n\tconst base = removeExtension(filename);\n\tconst file = `${base}-${hash}.${ext}`;\n\n\tlet rel: string;\n\n\tif (path === 'global') {\n\t\trel = size ? `${category}/sizes/${size}/${file}` : `${category}/original/${file}`;\n\t} else if (path === 'unique') {\n\t\trel = `${category}/original/${file}`;\n\t} else {\n\t\trel = size ? `${path}/${size}/${file}` : `${path}/${file}`;\n\t}\n\n\treturn publicEnv.MEDIASERVER_URL ? `${publicEnv.MEDIASERVER_URL.replace(/\\/+$/, '')}/files/${rel}` : `/files/${rel}`;\n}\n\n/** Client-side file validation */\nexport function validateFile(file: File, allowedPattern: RegExp, maxSize = 10 * 1024 * 1024): { valid: boolean; message?: string } {\n\tconst type = getMimeType(file.name) ?? file.type;\n\n\tif (!type || !allowedPattern.test(type)) {\n\t\treturn { valid: false, message: `Invalid type: ${type}` };\n\t}\n\n\tif (file.size > maxSize) {\n\t\treturn { valid: false, message: `Size exceeds ${formatBytes(maxSize)}` };\n\t}\n\n\treturn { valid: true };\n}\n\n/** Server-side buffer validation */\nexport function validateBuffer(\n\tbuffer: Buffer,\n\tname: string,\n\tallowedPattern: RegExp,\n\tmaxSize = 10 * 1024 * 1024\n): { valid: boolean; message?: string } {\n\tconst type = getMimeType(name) ?? 'application/octet-stream';\n\n\tif (!allowedPattern.test(type)) {\n\t\treturn { valid: false, message: `Invalid type: ${type}` };\n\t}\n\n\tif (buffer.length > maxSize) {\n\t\treturn { valid: false, message: `Size exceeds ${formatBytes(maxSize)}` };\n\t}\n\n\treturn { valid: true };\n}\n\n/** Aliases for backward compatibility */\nexport const validateMediaFileServer = validateBuffer;\nexport const constructUrl = mediaUrl;\nexport const constructMediaUrl = mediaUrl;\n"],"names":[],"mappings":";;AAYO,SAAS,YAAY,MAA6B;AACxD,QAAM,MAAM,KAAK,YAAA,EAAc,MAAM,GAAG,EAAE,IAAA;AAC1C,MAAI,CAAC,IAAK,QAAO;AAEjB,QAAM,MAA8B;AAAA;AAAA,IAEnC,KAAK;AAAA,IACL,MAAM;AAAA,IACN,KAAK;AAAA,IACL,KAAK;AAAA,IACL,MAAM;AAAA,IACN,KAAK;AAAA,IACL,MAAM;AAAA,IACN,KAAK;AAAA,IACL,KAAK;AAAA;AAAA,IAGL,KAAK;AAAA,IACL,KAAK;AAAA;AAAA,IAGL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,MAAM;AAAA,IACN,KAAK;AAAA;AAAA,IAGL,KAAK;AAAA,IACL,MAAM;AAAA,IACN,KAAK;AAAA,EAAA;AAGN,SAAO,IAAI,GAAG,KAAK;AACpB;AAGO,SAAS,SAAS,MAAiB,MAAuB;AAChE,MAAI,CAAC,MAAM,IAAK,QAAO;AAEvB,MAAI,UAAU,iBAAiB;AAC9B,WAAO,GAAG,UAAU,gBAAgB,QAAQ,QAAQ,EAAE,CAAC,IAAI,KAAK,GAAG;AAAA,EACpE;AAEA,MAAI,QAAQ,gBAAgB,QAAS,KAAK,aAAqB,IAAI,GAAG,KAAK;AAC1E,WAAQ,KAAK,WAAmB,IAAI,EAAE;AAAA,EACvC;AAEA,SAAO,UAAU,KAAK,GAAG;AAC1B;AAGO,SAAS,SAAS,MAAc,MAAc,UAAkB,KAAa,UAAkB,MAAuB;AAC5H,MAAa,CAAC,QAAQ,CAAC,YAAY,CAAC,OAAO,CAAC,SAAU,QAAO;AAE7D,QAAM,OAAO,gBAAgB,QAAQ;AACrC,QAAM,OAAO,GAAG,IAAI,IAAI,IAAI,IAAI,GAAG;AAEnC,MAAI;AAEJ,MAAI,SAAS,UAAU;AACtB,UAAM,OAAO,GAAG,QAAQ,UAAU,IAAI,IAAI,IAAI,KAAK,GAAG,QAAQ,aAAa,IAAI;AAAA,EAChF,WAAW,SAAS,UAAU;AAC7B,UAAM,GAAG,QAAQ,aAAa,IAAI;AAAA,EACnC,OAAO;AACN,UAAM,OAAO,GAAG,IAAI,IAAI,IAAI,IAAI,IAAI,KAAK,GAAG,IAAI,IAAI,IAAI;AAAA,EACzD;AAEA,SAAO,UAAU,kBAAkB,GAAG,UAAU,gBAAgB,QAAQ,QAAQ,EAAE,CAAC,UAAU,GAAG,KAAK,UAAU,GAAG;AACnH;AAkBO,SAAS,eACf,QACA,MACA,gBACA,UAAU,KAAK,OAAO,MACiB;AACvC,QAAM,OAAO,YAAY,IAAI,KAAK;AAElC,MAAI,CAAC,eAAe,KAAK,IAAI,GAAG;AAC/B,WAAO,EAAE,OAAO,OAAO,SAAS,iBAAiB,IAAI,GAAA;AAAA,EACtD;AAEA,MAAI,OAAO,SAAS,SAAS;AAC5B,WAAO,EAAE,OAAO,OAAO,SAAS,gBAAgB,YAAY,OAAO,CAAC,GAAA;AAAA,EACrE;AAEA,SAAO,EAAE,OAAO,KAAA;AACjB;AAGO,MAAM,0BAA0B;AAEhC,MAAM,oBAAoB;"}