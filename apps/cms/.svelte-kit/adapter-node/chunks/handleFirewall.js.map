{"version":3,"file":"handleFirewall.js","sources":["../../../../src/hooks/handleSystemState.ts","../../../../../../shared/database/src/seed.ts","../../../../src/hooks/handleAuthentication.ts","../../../../src/hooks/handleLocale.ts","../../../../src/hooks/handleTheme.ts","../../../../src/hooks/addSecurityHeaders.ts","../../../../src/hooks/handleRateLimit.ts","../../../../src/hooks/handleFirewall.ts"],"sourcesContent":["/**\n * @file src/hooks/handleSystemState.ts\n * @description Middleware that acts as a gatekeeper, blocking or allowing requests based on the system's operational state.\n *\n * ### Features\n * - Integrates with the central state machine (`@stores/system`).\n * - Robust initialization with timeout protection\n * - Proper state machine with error recovery\n * - Prevents setup routes from returning before initialization\n */\n\nimport { error } from '@sveltejs/kit';\nimport type { Handle } from '@sveltejs/kit';\nimport { getSystemState, isSystemReady } from '@shared/stores/system';\nimport { logger } from '@shared/utils/logger.server';\nimport { dbInitPromise } from '@shared/database/db';\nimport { isSetupComplete } from '@shared/utils/setupCheck';\n\n// Track initialization state more robustly\nlet initializationState: 'pending' | 'in-progress' | 'complete' | 'failed' = 'pending';\nlet initError: Error | null = null;\nlet initStartTime: number = 0;\n\n// Timeout protection (30 seconds max for initialization)\nconst INIT_TIMEOUT_MS = 30000;\n\nexport const handleSystemState: Handle = async ({ event, resolve }) => {\n\tconst { pathname } = event.url;\n\tconst setupComplete = isSetupComplete();\n\n\tlet systemState = getSystemState();\n\n\t// Skip trace logging for static assets and health checks to reduce log noise\n\tconst isHealthCheck = pathname.startsWith('/api/system/health') || pathname.startsWith('/api/dashboard/health');\n\tconst isStaticAsset = pathname.startsWith('/static') || pathname.startsWith('/assets') || pathname.startsWith('/_');\n\n\tif (!isHealthCheck && !isStaticAsset) {\n\t\tlogger.debug(\n\t\t\t`[handleSystemState] ${event.request.method} ${pathname}${event.url.search} (Data: ${event.isDataRequest}), state: ${systemState.overallState}, initState: ${initializationState}`\n\t\t);\n\t}\n\n\t// ============================================================================\n\t// CRITICAL: Initialization MUST happen FIRST, before allowing any routes\n\t// ============================================================================\n\n\t// --- Phase 1: Attempt Initialization (if needed) ---\n\tif (systemState.overallState === 'IDLE') {\n\t\tif (initializationState === 'pending') {\n\t\t\tif (setupComplete) {\n\t\t\t\t// Start initialization\n\t\t\t\tinitializationState = 'in-progress';\n\t\t\t\tinitStartTime = Date.now();\n\t\t\t\tlogger.info('System is IDLE and setup is complete. Starting initialization...');\n\n\t\t\t\ttry {\n\t\t\t\t\t// Add timeout wrapper\n\t\t\t\t\tawait Promise.race([\n\t\t\t\t\t\tdbInitPromise,\n\t\t\t\t\t\tnew Promise((_, reject) => setTimeout(() => reject(new Error('Initialization timeout')), INIT_TIMEOUT_MS))\n\t\t\t\t\t]);\n\n\t\t\t\t\tsystemState = getSystemState(); // Re-fetch state after init\n\t\t\t\t\tinitializationState = 'complete';\n\t\t\t\t\tconst duration = Date.now() - initStartTime;\n\t\t\t\t\tlogger.info(`Initialization complete in ${duration}ms. System state: ${systemState.overallState}`);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tinitializationState = 'failed';\n\t\t\t\t\tinitError = err instanceof Error ? err : new Error(String(err));\n\t\t\t\t\tlogger.error('Initialization failed:', initError);\n\t\t\t\t\tthrow error(503, 'Service initialization failed. Please check server logs.');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Setup not complete - skip initialization to prevent retry loops\n\t\t\t\tlogger.info('System is IDLE and setup is not complete. Skipping DB initialization.');\n\t\t\t\tinitializationState = 'complete';\n\t\t\t}\n\t\t} else if (initializationState === 'in-progress') {\n\t\t\t// Another request is already initializing, wait for it\n\t\t\tconst elapsed = Date.now() - initStartTime;\n\n\t\t\t// Check if initialization is taking too long\n\t\t\tif (elapsed > INIT_TIMEOUT_MS) {\n\t\t\t\tinitializationState = 'failed';\n\t\t\t\tinitError = new Error(`Initialization exceeded timeout (${INIT_TIMEOUT_MS}ms)`);\n\t\t\t\tlogger.error('Initialization timeout:', initError);\n\t\t\t\tthrow error(503, 'Service initialization timed out. Please check server logs.');\n\t\t\t}\n\n\t\t\tlogger.debug(`[handleSystemState] Request to ${pathname} waiting for ongoing initialization (${elapsed}ms elapsed)...`);\n\t\t\ttry {\n\t\t\t\tawait Promise.race([\n\t\t\t\t\tdbInitPromise,\n\t\t\t\t\tnew Promise((_, reject) => setTimeout(() => reject(new Error('Initialization wait timeout')), INIT_TIMEOUT_MS - elapsed))\n\t\t\t\t]);\n\t\t\t\tsystemState = getSystemState(); // Re-fetch state after wait\n\t\t\t} catch (err) {\n\t\t\t\tlogger.error('Initialization wait failed:', err);\n\t\t\t\tthrow error(503, 'Service initialization is taking longer than expected.');\n\t\t\t}\n\t\t} else if (initializationState === 'failed') {\n\t\t\t// Previous initialization failed, return error immediately\n\t\t\tlogger.error('System initialization previously failed:', initError);\n\t\t\tthrow error(503, `Service unavailable: ${initError?.message || 'Unknown initialization error'}`);\n\t\t}\n\t\t// If 'complete', continue to route checks below\n\t}\n\n\t// --- Phase 2: Allow Setup Routes (AFTER initialization attempt) ---\n\tif (systemState.overallState === 'IDLE') {\n\t\tconst allowedPaths = [\n\t\t\t'/setup',\n\t\t\t'/api/setup',\n\t\t\t'/api/system/health',\n\t\t\t'/api/dashboard/health',\n\t\t\t'/login',\n\t\t\t'/static',\n\t\t\t'/assets',\n\t\t\t'/favicon.ico',\n\t\t\t'/.well-known',\n\t\t\t'/_',\n\t\t\t'/api/system/version',\n\t\t\t'/api/debug' // Allow debug endpoints\n\t\t];\n\t\tconst isLocalizedSetup = /^\\/[a-z]{2,5}(-[a-zA-Z]+)?\\/(setup|login|register)/.test(pathname);\n\t\tconst isAllowedRoute = allowedPaths.some((prefix) => pathname.startsWith(prefix)) || pathname === '/' || isLocalizedSetup;\n\n\t\tif (isAllowedRoute) {\n\t\t\tlogger.trace(`Allowing request to ${pathname} during IDLE (setup mode) state.`);\n\t\t\treturn resolve(event);\n\t\t}\n\t}\n\n\t// --- State: INITIALIZING ---\n\tif (systemState.overallState === 'INITIALIZING') {\n\t\tconst allowedPaths = [\n\t\t\t'/api/system/health',\n\t\t\t'/api/dashboard/health',\n\t\t\t'/setup',\n\t\t\t'/api/setup',\n\t\t\t'/login',\n\t\t\t'/.well-known',\n\t\t\t'/_',\n\t\t\t'/api/system/version',\n\t\t\t'/api/debug'\n\t\t];\n\t\tconst isLocalizedSetup = /^\\/[a-z]{2,5}(-[a-zA-Z]+)?\\/(setup|login|register)/.test(pathname);\n\t\tconst isAllowedRoute = allowedPaths.some((prefix) => pathname.startsWith(prefix)) || (!setupComplete && pathname === '/') || isLocalizedSetup;\n\n\t\tif (isAllowedRoute) {\n\t\t\tlogger.trace(`Allowing request to ${pathname} during INITIALIZING state.`);\n\t\t\treturn resolve(event);\n\t\t}\n\n\t\t// Wait for initialization to complete with timeout\n\t\tlogger.debug(`Request to ${pathname} waiting for initialization to complete...`);\n\t\ttry {\n\t\t\tawait Promise.race([dbInitPromise, new Promise((_, reject) => setTimeout(() => reject(new Error('Init wait timeout')), INIT_TIMEOUT_MS))]);\n\t\t\tsystemState = getSystemState();\n\t\t\tlogger.debug(`Initialization complete. System state is now: ${systemState.overallState}`);\n\t\t} catch (err) {\n\t\t\tlogger.error('Initialization wait error:', err);\n\t\t\tthrow error(503, 'Service Unavailable: System initialization failed.');\n\t\t}\n\n\t\t// If still not ready after initialization, block the request\n\t\tif (!isSystemReady()) {\n\t\t\tlogger.warn(`Request to ${pathname} blocked: System failed to initialize properly.`);\n\t\t\tthrow error(503, 'Service Unavailable: The system failed to initialize. Please contact an administrator.');\n\t\t}\n\t}\n\n\t// --- State: Final Ready Check ---\n\tconst isNowReady = systemState.overallState === 'READY' || systemState.overallState === 'DEGRADED';\n\tif (!isNowReady) {\n\t\tconst allowedPaths = ['/api/system/health', '/api/dashboard/health', '/setup', '/api/setup', '/api/system/version', '/api/debug'];\n\t\tconst isAllowedRoute = allowedPaths.some((prefix) => pathname.startsWith(prefix));\n\n\t\tif (isAllowedRoute) {\n\t\t\tlogger.trace(`Allowing request to ${pathname} during ${systemState.overallState} state.`);\n\t\t\treturn resolve(event);\n\t\t}\n\n\t\t// Reduce log noise for well-known/devtools requests\n\t\tif (pathname.startsWith('/.well-known/') || pathname.includes('devtools')) {\n\t\t\tlogger.trace(`Request to ${pathname} blocked: System is currently ${systemState.overallState}.`);\n\t\t} else {\n\t\t\tlogger.warn(`Request to ${pathname} blocked: System is currently ${systemState.overallState}.`);\n\t\t}\n\t\tthrow error(503, 'Service Unavailable: The system is starting up. Please try again in a moment.');\n\t}\n\n\t// --- State: READY or DEGRADED ---\n\tif (systemState.overallState === 'DEGRADED') {\n\t\tconst degradedServices = Object.entries(systemState.services)\n\t\t\t.filter(([, s]) => s.status === 'unhealthy')\n\t\t\t.map(([name]) => name);\n\n\t\tif (degradedServices.length > 0) {\n\t\t\tevent.locals.degradedServices = degradedServices;\n\t\t\tlogger.warn(`Request to ${pathname} is proceeding in a DEGRADED state. Unhealthy services: ${degradedServices.join(', ')}`);\n\t\t}\n\t}\n\n\treturn resolve(event);\n};\n","/**\n * @file src/routes/api/setup/seed.ts\n * @description Seeds the database with default system settings\n *\n * This replaces the static configuration files with database settings.\n * Uses database-agnostic interfaces for compatibility across different database engines.\n *\n * Collection Seeding Strategy:\n * - seedCollectionsForSetup(): Lightweight version for setup that directly reads compiled\n *   collections from filesystem and creates models. Bypasses ContentManager to avoid\n *   global dbAdapter dependency issues during setup mode.\n * - This allows ContentManager to have collections pre-cached when system fully initializes,\n *   resulting in faster redirects and better UX after setup completion.\n */\n\nimport { publicConfigSchema } from '@shared/database/schemas';\nimport type { DatabaseId } from '@cms-types';\nimport type { DatabaseAdapter, Theme } from '@shared/database/dbInterface';\nimport { invalidateSettingsCache } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { dateToISODateString } from '@shared/utils/dateUtils';\nimport { safeParse } from 'valibot';\nimport { getAllPermissions } from '@shared/database/auth';\nimport { defaultRoles as importedDefaultRoles } from '@shared/database/auth/defaultRoles';\n\n// Import inlang settings directly (TypeScript/SvelteKit handles JSON imports)\nimport inlangSettings from '@root/project.inlang/settings.json';\nimport { setupManager } from '@shared/utils/setupManager';\n\n// ============================================================================\n// EXPORTED DEFAULTS - Loaded from project.inlang/settings.json\n// ============================================================================\n\nexport const DEFAULT_SYSTEM_LANGUAGES = inlangSettings.locales || ['en', 'de'];\nexport const DEFAULT_BASE_LOCALE = inlangSettings.baseLocale || 'en';\nexport const DEFAULT_CONTENT_LANGUAGES = DEFAULT_SYSTEM_LANGUAGES;\nexport const DEFAULT_CONTENT_LANGUAGE = DEFAULT_BASE_LOCALE;\n\n// ============================================================================\n\n// Type for setting data in snapshots\ninterface SettingData {\n\tvalue: unknown;\n\tvisibility?: 'public' | 'private';\n\tcategory?: 'public' | 'private';\n\tdescription?: string;\n}\n\n// Default theme that matches the ThemeManager's DEFAULT_THEME\nconst defaultTheme: Theme = {\n\t_id: '670e8b8c4d123456789abcde' as DatabaseId, // MongoDB ObjectId-style string\n\tpath: '', // Default path\n\tname: 'SveltyCMSTheme',\n\n\tisActive: false,\n\tisDefault: true,\n\tconfig: {\n\t\ttailwindConfigPath: '',\n\t\tassetsPath: ''\n\t},\n\tcreatedAt: dateToISODateString(new Date()),\n\tupdatedAt: dateToISODateString(new Date())\n};\n\n// Re-export defaultRoles from shared module for backward compatibility\nexport const defaultRoles = importedDefaultRoles;\n\n// Seeds the default theme into the database\nexport async function seedDefaultTheme(dbAdapter: DatabaseAdapter, tenantId?: string): Promise<void> {\n\tlogger.info(`üé® Checking if default theme needs seeding${tenantId ? ` for tenant ${tenantId}` : ''}...`);\n\n\tif (!dbAdapter || !dbAdapter.themes) {\n\t\tthrow new Error('Database adapter or themes interface not available');\n\t}\n\n\ttry {\n\t\t// Check if themes already exist\n\t\tconst existingThemes = await dbAdapter.themes.getAllThemes();\n\t\tif (Array.isArray(existingThemes) && existingThemes.length > 0) {\n\t\t\tlogger.info(`‚úÖ Themes already exist${tenantId ? ` for tenant ${tenantId}` : ''}, skipping theme seeding`);\n\t\t\treturn;\n\t\t}\n\n\t\t// Seed the default theme\n\t\tlogger.info(`üé® Seeding default theme${tenantId ? ` for tenant ${tenantId}` : ''}...`);\n\t\tconst themeToStore = {\n\t\t\t...defaultTheme,\n\t\t\t...(tenantId && { tenantId })\n\t\t};\n\t\tawait dbAdapter.themes.storeThemes([themeToStore]);\n\t\tlogger.info(`‚úÖ Default theme seeded successfully${tenantId ? ` for tenant ${tenantId}` : ''}`);\n\t} catch (error) {\n\t\tlogger.error(`Failed to seed default theme${tenantId ? ` for tenant ${tenantId}` : ''}:`, error);\n\t\tthrow error;\n\t}\n}\n\n/**\n * Seeds default roles into the database\n * Roles are now stored in database for dynamic management via UI\n * Admin role gets all available permissions automatically\n */\nexport async function seedRoles(dbAdapter: DatabaseAdapter, tenantId?: string): Promise<void> {\n\tlogger.info(`üîê Seeding default roles${tenantId ? ` for tenant ${tenantId}` : ''}...`);\n\n\tif (!dbAdapter || !dbAdapter.auth) {\n\t\tthrow new Error('Database adapter or auth interface not available');\n\t}\n\n\ttry {\n\t\t// Get all available permissions for admin role\n\t\tconst allPermissions = getAllPermissions();\n\t\tconst adminPermissions = allPermissions.map((p) => p._id);\n\n\t\t// Seed each default role\n\t\tfor (const role of defaultRoles) {\n\t\t\ttry {\n\t\t\t\t// Admin role gets all permissions\n\t\t\t\tconst roleToCreate = {\n\t\t\t\t\t...role,\n\t\t\t\t\tpermissions: role._id === 'admin' ? adminPermissions : role.permissions,\n\t\t\t\t\t...(tenantId && { tenantId })\n\t\t\t\t};\n\n\t\t\t\tawait dbAdapter.auth.createRole(roleToCreate);\n\t\t\t\tlogger.debug(`‚úÖ Role \"${role.name}\" seeded successfully${tenantId ? ` for tenant ${tenantId}` : ''}`);\n\t\t\t} catch (error) {\n\t\t\t\t// Skip if role already exists (duplicate key error)\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\t\t\tif (errorMessage.includes('duplicate') || errorMessage.includes('E11000')) {\n\t\t\t\t\tlogger.debug(`‚ÑπÔ∏è  Role \"${role.name}\" already exists${tenantId ? ` for tenant ${tenantId}` : ''}, skipping`);\n\t\t\t\t} else {\n\t\t\t\t\tlogger.error(`Failed to seed role \"${role.name}\"${tenantId ? ` for tenant ${tenantId}` : ''}:`, error);\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tlogger.info(`‚úÖ Default roles seeded successfully${tenantId ? ` for tenant ${tenantId}` : ''}`);\n\t} catch (error) {\n\t\tlogger.error(`Failed to seed roles${tenantId ? ` for tenant ${tenantId}` : ''}:`, error);\n\t\tthrow error;\n\t}\n}\n\n/**\n * Seeds collections from filesystem into database\n * This bypasses ContentManager to avoid global dbAdapter dependency during setup\n *\n * @returns Information about the first collection (for faster redirects)\n */\nexport async function seedCollectionsForSetup(\n\tdbAdapter: DatabaseAdapter,\n\ttenantId?: string\n): Promise<{ firstCollection: { name: string; path: string } | null }> {\n\tconst overallStart = performance.now();\n\tlogger.info(`üì¶ Seeding collections from filesystem${tenantId ? ` for tenant ${tenantId}` : ''}...`);\n\n\tif (!dbAdapter || !dbAdapter.collection) {\n\t\tthrow new Error('Database adapter or collection interface not available');\n\t}\n\n\tlet firstCollection: { name: string; path: string } | null = null;\n\n\ttry {\n\t\t// Import the collection scanner directly from shared\n\t\tconst { scanCompiledCollections } = await import('@shared/utils/content/scanner');\n\n\t\tconst scanStart = performance.now();\n\t\tconst collections = await scanCompiledCollections();\n\t\tconst scanTime = performance.now() - scanStart;\n\t\tlogger.debug(`‚è±Ô∏è  Collection scan: ${scanTime.toFixed(2)}ms (found ${collections.length})`);\n\n\t\tif (collections.length === 0) {\n\t\t\tlogger.info('‚ÑπÔ∏è  No collections found in filesystem, skipping collection seeding');\n\t\t\treturn { firstCollection: null };\n\t\t}\n\n\t\tlogger.info(`Found ${collections.length} collections to seed`);\n\n\t\tlet successCount = 0;\n\t\tlet skipCount = 0;\n\t\tconst totalCollections = collections.length;\n\t\tconst modelCreationStart = performance.now();\n\n\t\t// Delay between collection registrations to prevent Mongoose race conditions\n\t\t// Use shorter delay in CI/test mode for faster builds\n\t\tconst isTestMode = process.env.TEST_MODE === 'true';\n\t\tconst registrationDelay = isTestMode ? 10 : 50; // 10ms in CI, 50ms in production\n\n\t\tlogger.debug(`üì¶ Seeding ${totalCollections} collections (delay: ${registrationDelay}ms, testMode: ${isTestMode})`);\n\n\t\t// Register each collection SEQUENTIALLY to prevent Mongoose registry race conditions\n\t\tfor (let i = 0; i < totalCollections; i++) {\n\t\t\tconst schema = collections[i];\n\t\t\tsetupManager.updateProgress(i, totalCollections);\n\t\t\ttry {\n\t\t\t\tconst createStart = performance.now();\n\t\t\t\t// Try to create the collection model in database\n\t\t\t\tawait dbAdapter.collection.createModel(schema);\n\n\t\t\t\t// Small delay to ensure model registration completes before next one\n\t\t\t\t// Reduced from 100ms: 10ms in CI, 50ms in production\n\t\t\t\tif (i < totalCollections - 1) {\n\t\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, registrationDelay));\n\t\t\t\t}\n\n\t\t\t\tconst createTime = performance.now() - createStart;\n\t\t\t\tlogger.info(`‚úÖ Created collection model: ${schema.name || 'unknown'} (${createTime.toFixed(0)}ms)`);\n\t\t\t\tsuccessCount++;\n\n\t\t\t\t// Capture the first collection for redirect\n\t\t\t\tif (!firstCollection && schema.path && schema.name) {\n\t\t\t\t\tconst collectionName = schema.name; // Narrow the type\n\t\t\t\t\tconst collectionPath = schema.path; // Narrow the type\n\t\t\t\t\tfirstCollection = {\n\t\t\t\t\t\tname: collectionName,\n\t\t\t\t\t\tpath: collectionPath\n\t\t\t\t\t};\n\t\t\t\t\tlogger.debug(`First collection identified: ${collectionName} at ${collectionPath}`);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\t// Collection might already exist or have schema issues\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\t\t\tif (errorMessage.includes('already exists') || errorMessage.includes('duplicate')) {\n\t\t\t\t\tlogger.debug(`Collection '${schema.name || 'unknown'}' already exists, skipping`);\n\t\t\t\t\tskipCount++;\n\t\t\t\t} else {\n\t\t\t\t\tlogger.error(`‚ùå Failed to create collection '${schema.name || 'unknown'}'${tenantId ? ` for tenant ${tenantId}` : ''}: ${errorMessage}`);\n\t\t\t\t\tif (error instanceof Error && error.stack) {\n\t\t\t\t\t\tlogger.debug('Stack trace:', error.stack);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tsetupManager.updateProgress(totalCollections, totalCollections);\n\n\t\tconst modelCreationTime = performance.now() - modelCreationStart;\n\t\tconst overallTime = performance.now() - overallStart;\n\n\t\tlogger.info(`‚úÖ Collections seeding completed: ${successCount} created, ${skipCount} skipped`);\n\t\tlogger.info(`‚è±Ô∏è  Model creation time: ${modelCreationTime.toFixed(2)}ms`);\n\t\tlogger.info(`‚è±Ô∏è  Total seed time: ${overallTime.toFixed(2)}ms`);\n\n\t\treturn { firstCollection };\n\t} catch (error) {\n\t\tconst overallTime = performance.now() - overallStart;\n\t\tif (error instanceof Error) {\n\t\t\tlogger.error(`Failed to seed collections after ${overallTime.toFixed(2)}ms: ${error.message}`);\n\t\t\tif (error.stack) {\n\t\t\t\tlogger.debug('Stack trace:', error.stack);\n\t\t\t}\n\t\t} else {\n\t\t\tlogger.error(`Failed to seed collections after ${overallTime.toFixed(2)}ms:`, error);\n\t\t}\n\t\t// Don't throw - collections can be created later through the UI\n\t\tlogger.warn('Continuing setup without collection seeding...');\n\t\treturn { firstCollection: null };\n\t}\n}\n\n// Initialize system from setup using database-agnostic interface\nexport async function initSystemFromSetup(\n\tadapter: DatabaseAdapter,\n\ttenantId?: string,\n\tisDemoSeed = false\n): Promise<{ firstCollection: { name: string; path: string } | null }> {\n\tlogger.info(`üöÄ Starting system initialization from setup${tenantId ? ` for tenant ${tenantId}` : ''}...`);\n\n\tif (!adapter) {\n\t\tthrow new Error('Database adapter not available. Database must be initialized first.');\n\t}\n\n\t// Seed the database with default settings using database-agnostic interface\n\tawait seedSettings(adapter, tenantId, isDemoSeed);\n\n\t// Seed the default theme\n\tawait seedDefaultTheme(adapter, tenantId);\n\n\t// Seed default roles into database (from shared defaultRoles module)\n\tawait seedRoles(adapter, tenantId);\n\n\t// Seed collections from filesystem\n\t// This creates collection models in MongoDB so ContentManager can access them quickly\n\t// Uses seedCollectionsForSetup() which bypasses ContentManager to avoid global dbAdapter dependency\n\tconst { firstCollection } = await seedCollectionsForSetup(adapter, tenantId);\n\n\t// Invalidate the settings cache and reload from database\n\tinvalidateSettingsCache();\n\tconst { loadSettingsFromDB } = await import('@shared/database/db');\n\tawait loadSettingsFromDB();\n\n\tlogger.info(`‚úÖ System initialization completed${tenantId ? ` for tenant ${tenantId}` : ''}`);\n\n\treturn { firstCollection };\n}\n\n// Default public settings that were previously in config/public.ts\nexport const defaultPublicSettings: Array<{ key: string; value: unknown; description?: string }> = [\n\t// Host configuration\n\t{ key: 'HOST_DEV', value: 'http://localhost:5173', description: 'Development server URL' },\n\t{ key: 'HOST_PROD', value: 'https://yourdomain.com', description: 'Production server URL' },\n\n\t// Site configuration\n\t{ key: 'SITE_NAME', value: 'SveltyCMS', description: 'The public name of the website' },\n\t{ key: 'PASSWORD_LENGTH', value: 8, description: 'Minimum required length for user passwords' },\n\n\t// Language Configuration\n\t{ key: 'DEFAULT_CONTENT_LANGUAGE', value: DEFAULT_CONTENT_LANGUAGE, description: 'Default language for content' },\n\t{ key: 'AVAILABLE_CONTENT_LANGUAGES', value: DEFAULT_CONTENT_LANGUAGES, description: 'List of available content languages' },\n\t{ key: 'BASE_LOCALE', value: DEFAULT_BASE_LOCALE, description: 'Default/base locale for the CMS interface' },\n\t{ key: 'LOCALES', value: DEFAULT_SYSTEM_LANGUAGES, description: 'List of available interface locales' },\n\n\t// Media configuration\n\t{ key: 'MEDIA_STORAGE_TYPE', value: 'local', description: 'Type of media storage (local, s3, r2, cloudinary)' },\n\t{ key: 'MEDIA_FOLDER', value: './mediaFolder', description: 'Server path where media files are stored' },\n\t{ key: 'MEDIA_OUTPUT_FORMAT_QUALITY', value: { format: 'webp', quality: 80 }, description: 'Image format and quality settings' },\n\t{ key: 'IMAGE_SIZES', value: { sm: 600, md: 900, lg: 1200 }, description: 'Image sizes for automatic resizing' },\n\t{ key: 'MAX_FILE_SIZE', value: 10485760, description: 'Maximum file size for uploads in bytes (10MB)' },\n\t{ key: 'BODY_SIZE_LIMIT', value: 10485760, description: 'Body size limit for server requests in bytes (10MB)' },\n\t{ key: 'USE_ARCHIVE_ON_DELETE', value: true, description: 'Enable archiving instead of permanent deletion' },\n\n\t// Seasons Icons for login page\n\t{ key: 'SEASONS', value: true, description: 'Enable seasonal themes on the login page' },\n\t{ key: 'SEASON_REGION', value: 'Western_Europe', description: 'Region for determining seasonal themes' },\n\n\t// Default Theme Configuration\n\t// The ID will be generated by the database adapter and set after insertion\n\t{ key: 'DEFAULT_THEME_ID', value: '', description: 'ID of the default theme (set by adapter)' },\n\t{ key: 'DEFAULT_THEME_NAME', value: 'SveltyCMSTheme', description: 'Name of the default theme' },\n\t{ key: 'DEFAULT_THEME_PATH', value: '', description: 'Path to the default theme CSS file' },\n\t{ key: 'DEFAULT_THEME_IS_DEFAULT', value: true, description: 'Whether the default theme is the default theme' },\n\n\t// Advanced Settings\n\t{ key: 'EXTRACT_DATA_PATH', value: './exports/data.json', description: 'File path for exported collection data' },\n\t{ key: 'PKG_VERSION', value: '1.0.0', description: 'Application version (can be overridden, but usually read from package.json)' },\n\n\t// NOTE: PKG_VERSION is read dynamically from package.json at runtime, not stored in DB\n\t// This ensures version always reflects the installed package and helps detect outdated installations\n\n\t// Logging\n\t{\n\t\tkey: 'LOG_LEVELS',\n\t\tvalue: ['info', 'warn', 'error', 'debug'],\n\t\tdescription: 'Active logging levels (none, info, warn, error, debug, fatal, trace)'\n\t},\n\t{ key: 'LOG_RETENTION_DAYS', value: 30, description: 'Number of days to keep log files' },\n\t{ key: 'LOG_ROTATION_SIZE', value: 10485760, description: 'Maximum size of a log file in bytes before rotation (10MB)' },\n\n\t// Demo Mode\n\t{ key: 'DEMO', value: false, description: 'Enable demo mode (restricts certain features)' }\n];\n\n/**\n * Default private settings that were previously in config/private.ts\n * Note: Sensitive settings like API keys should be set via GUI or CLI\n * Database config, JWT keys, and encryption keys are handled separately in private config files\n */\nexport const defaultPrivateSettings: Array<{ key: string; value: unknown; description?: string }> = [\n\t// Security / 2FA\n\t{ key: 'USE_2FA', value: false, description: 'Enable Two-Factor Authentication globally' },\n\t{ key: 'TWO_FACTOR_AUTH_BACKUP_CODES_COUNT', value: 10, description: 'Backup codes count for 2FA (1-50)' },\n\n\t// Telemetry (Privacy)\n\t{ key: 'SVELTYCMS_TELEMETRY', value: true, description: 'Enable SveltyCMS telemetry tracking' },\n\n\t// SMTP config\n\t{ key: 'SMTP_HOST', value: '', description: 'SMTP server host for sending emails' },\n\t{ key: 'SMTP_PORT', value: 587, description: 'SMTP server port' },\n\t{ key: 'SMTP_EMAIL', value: '', description: 'Email address to send from' },\n\t{ key: 'SMTP_PASSWORD', value: '', description: 'Password for the SMTP email account' },\n\n\t// Google OAuth\n\t{ key: 'USE_GOOGLE_OAUTH', value: false, description: 'Enable Google OAuth for login' },\n\t{ key: 'GOOGLE_CLIENT_ID', value: '', description: 'Google OAuth Client ID' },\n\t{ key: 'GOOGLE_CLIENT_SECRET', value: '', description: 'Google OAuth Client Secret' },\n\n\t// Redis config\n\t{ key: 'USE_REDIS', value: false, description: 'Enable Redis for caching' },\n\t{ key: 'REDIS_HOST', value: 'localhost', description: 'Redis server host address' },\n\t{ key: 'REDIS_PORT', value: 6379, description: 'Redis server port number' },\n\t{ key: 'REDIS_PASSWORD', value: '', description: 'Password for Redis server' },\n\n\t// Cache TTL Configuration (in seconds)\n\t{ key: 'CACHE_TTL_SCHEMA', value: 600, description: 'TTL for schema/collection definitions (10 minutes)' },\n\t{ key: 'CACHE_TTL_WIDGET', value: 600, description: 'TTL for widget data (10 minutes)' },\n\t{ key: 'CACHE_TTL_THEME', value: 300, description: 'TTL for theme configurations (5 minutes)' },\n\t{ key: 'CACHE_TTL_CONTENT', value: 180, description: 'TTL for content data (3 minutes)' },\n\t{ key: 'CACHE_TTL_MEDIA', value: 300, description: 'TTL for media metadata (5 minutes)' },\n\t{ key: 'CACHE_TTL_SESSION', value: 86400, description: 'TTL for user session data (24 hours)' },\n\t{ key: 'CACHE_TTL_USER', value: 60, description: 'TTL for user permissions (1 minute)' },\n\t{ key: 'CACHE_TTL_API', value: 300, description: 'TTL for API responses (5 minutes)' },\n\n\t// Session configuration\n\t{ key: 'SESSION_CLEANUP_INTERVAL', value: 300000, description: 'Interval in ms to clean up expired sessions (5 minutes)' },\n\t{ key: 'MAX_IN_MEMORY_SESSIONS', value: 1000, description: 'Maximum number of sessions to hold in memory' },\n\t{ key: 'DB_VALIDATION_PROBABILITY', value: 0.1, description: 'Probability (0-1) of validating a session against the DB' },\n\t{ key: 'SESSION_EXPIRATION_SECONDS', value: 86400, description: 'Duration in seconds until a session expires (24 hours)' },\n\n\t// Mapbox config\n\t{ key: 'USE_MAPBOX', value: false, description: 'Enable Mapbox integration' },\n\t{ key: 'MAPBOX_API_TOKEN', value: '', description: 'Public Mapbox API token (for client-side use)' },\n\t{ key: 'SECRET_MAPBOX_API_TOKEN', value: '', description: 'Secret Mapbox API token (for server-side use)' },\n\n\t// Other APIs\n\t{ key: 'GOOGLE_API_KEY', value: '', description: 'Google API Key for services like Maps and YouTube' },\n\t{ key: 'TWITCH_TOKEN', value: '', description: 'API token for Twitch integration' },\n\t{ key: 'USE_TIKTOK', value: false, description: 'Enable TikTok integration' },\n\t{ key: 'TIKTOK_TOKEN', value: '', description: 'API token for TikTok integration' },\n\n\t// Server configuration\n\t{ key: 'SERVER_PORT', value: 5173, description: 'Port for the application server' },\n\n\t// Roles and Permissions (previously required in private config)\n\t{ key: 'ROLES', value: ['admin', 'editor', 'viewer'], description: 'List of user roles available in the system' },\n\t{ key: 'PERMISSIONS', value: ['read', 'write', 'delete', 'admin'], description: 'List of permissions available in the system' }\n];\n\n/**\n * Seeds the database with default settings using database-agnostic interface.\n * This should be called during initial setup or when resetting to defaults.\n * Note: Database config and security keys are handled in private config files, not in DB\n * Only seeds settings that don't already exist (smart seeding).\n * @param dbAdapter Database adapter to use for operations\n */\nexport async function seedSettings(dbAdapter: DatabaseAdapter, tenantId?: string, isDemoSeed = false): Promise<void> {\n\tlogger.info(`üå± Checking which settings need seeding${tenantId ? ` for tenant ${tenantId}` : ''}...`);\n\n\tif (!dbAdapter || !dbAdapter.systemPreferences) {\n\t\tthrow new Error('Database adapter or systemPreferences interface not available');\n\t}\n\n\t// Test database accessibility\n\ttry {\n\t\t// Try a simple getMany operation to test connectivity\n\t\tawait dbAdapter.systemPreferences.getMany(['HOST_DEV'], 'system');\n\t\tlogger.debug('Database adapter is accessible');\n\t} catch (error) {\n\t\tlogger.error('Database adapter is not accessible:', error);\n\t\tthrow new Error(`Cannot access database adapter: ${error instanceof Error ? error.message : String(error)}`);\n\t}\n\n\tconst allSettings = [...defaultPublicSettings, ...defaultPrivateSettings];\n\n\t// Create a Set of private setting keys for efficient lookup\n\tconst privateSettingKeys = new Set(defaultPrivateSettings.map((s) => s.key));\n\n\t// Check which settings already exist\n\tconst allKeys = allSettings.map((s) => s.key);\n\tlet existingSettings: Record<string, unknown> = {};\n\n\ttry {\n\t\tconst result = await dbAdapter.systemPreferences.getMany(allKeys, 'system');\n\t\tif (result.success && result.data) {\n\t\t\texistingSettings = result.data;\n\t\t}\n\t} catch (error) {\n\t\tlogger.debug(`Could not check existing settings for tenant ${tenantId}, will seed all:`, error);\n\t}\n\n\t// Filter out settings that already exist\n\tconst settingsToSeed = allSettings.filter((setting) => !(setting.key in existingSettings));\n\n\tif (settingsToSeed.length === 0) {\n\t\tlogger.info(`‚úÖ All settings already exist${tenantId ? ` for tenant ${tenantId}` : ''}, skipping settings seeding`);\n\t\treturn;\n\t}\n\n\tlogger.info(\n\t\t`üå± Seeding ${settingsToSeed.length} missing settings${tenantId ? ` for tenant ${tenantId}` : ''} (${Object.keys(existingSettings).length} already exist)...`\n\t);\n\n\t// Prepare settings for batch operation with category\n\tconst settingsToSet: Array<{\n\t\tkey: string;\n\t\tvalue: unknown;\n\t\tcategory: 'public' | 'private';\n\t\tscope: 'user' | 'system';\n\t\tuserId?: DatabaseId;\n\t\ttenantId?: string;\n\t}> = [];\n\n\tfor (const setting of settingsToSeed) {\n\t\t// Determine category based on whether the setting is in the private list\n\t\tconst category = privateSettingKeys.has(setting.key) ? 'private' : 'public';\n\n\t\tlet value = setting.value;\n\n\t\t// Override DEMO, SEASONS, SEASON_REGION if isDemoSeed\n\t\tif (isDemoSeed) {\n\t\t\tif (setting.key === 'DEMO') value = true;\n\t\t\tif (setting.key === 'SEASONS') value = true;\n\t\t\tif (setting.key === 'SEASON_REGION') value = 'Western_Europe';\n\t\t}\n\n\t\tsettingsToSet.push({\n\t\t\tkey: setting.key,\n\t\t\tvalue: value, // Store the actual value directly\n\t\t\tcategory, // Add category field for proper classification\n\t\t\tscope: 'system',\n\t\t\t...(tenantId && { tenantId })\n\t\t});\n\t}\n\n\t// Use batch operation for better performance\n\ttry {\n\t\tconst result = await dbAdapter.systemPreferences.setMany(settingsToSet);\n\n\t\tif (!result.success) {\n\t\t\tthrow new Error(result.error?.message || 'Failed to seed settings');\n\t\t}\n\n\t\tlogger.info(`‚úÖ Seeded ${settingsToSeed.length} missing settings`);\n\t} catch (error) {\n\t\tlogger.error(`Failed to seed settings${tenantId ? ` for tenant ${tenantId}` : ''}:`, error);\n\t\tthrow error;\n\t}\n\n\t// Populate public settings cache immediately after seeding\n\t// Private settings will be loaded later when the app starts and reads the private config file\n\ttry {\n\t\tlogger.info('üîÑ Populating public settings cache...');\n\n\t\t// Only organize public settings for immediate cache population\n\t\tconst publicSettings: Record<string, unknown> = {};\n\n\t\t// Add existing public settings first\n\t\tfor (const [key, value] of Object.entries(existingSettings)) {\n\t\t\tconst isPublic = defaultPublicSettings.some((s) => s.key === key);\n\t\t\tif (isPublic) {\n\t\t\t\tpublicSettings[key] = (value as any).value ?? value;\n\t\t\t}\n\t\t}\n\n\t\t// Add/overwrite with new seeded settings\n\t\tfor (const setting of settingsToSeed) {\n\t\t\tconst isPublic = defaultPublicSettings.some((s) => s.key === setting.key);\n\t\t\tif (isPublic) {\n\t\t\t\tpublicSettings[setting.key] = setting.value;\n\t\t\t}\n\t\t}\n\n\t\t// Validate public settings\n\t\tconst parsedPublic = safeParse(publicConfigSchema, publicSettings);\n\n\t\tif (parsedPublic.success) {\n\t\t\t// Private settings will be loaded when the app starts normally\n\t\t\tlogger.info('‚úÖ Public settings validated successfully');\n\t\t} else {\n\t\t\tlogger.warn('Public settings validation failed');\n\t\t\t// Filter out expected undefined errors for cleaner logs if needed, or just log issues\n\t\t\tlogger.debug('Public settings validation issues:', parsedPublic.issues);\n\t\t}\n\t} catch (error) {\n\t\tlogger.error('Failed to populate settings cache:', error);\n\t\t// Don't throw here - seeding was successful, cache population is just an optimization\n\t}\n}\n\n/**\n * Exports all current settings to a JSON file using database-agnostic interface.\n * This creates a settings snapshot for project templates.\n */\ntype SettingsSnapshot = {\n\tversion: string;\n\texportedAt: string;\n\tsettings: Record<string, { value: unknown; category: string; description: string }>;\n};\n\nexport async function exportSettingsSnapshot(dbAdapter: DatabaseAdapter): Promise<SettingsSnapshot> {\n\tif (!dbAdapter || !dbAdapter.systemPreferences) {\n\t\tthrow new Error('Database adapter or systemPreferences interface not available');\n\t}\n\n\t// Get all system settings - we'll need to implement a method to get all settings\n\t// For now, we'll get the known settings keys\n\tconst allSettingKeys = [...defaultPublicSettings, ...defaultPrivateSettings].map((s) => s.key);\n\n\tconst settingsResult = await dbAdapter.systemPreferences.getMany(allSettingKeys, 'system');\n\n\tif (!settingsResult.success) {\n\t\tthrow new Error(`Failed to export settings: ${settingsResult.error?.message}`);\n\t}\n\n\tconst snapshot: SettingsSnapshot = {\n\t\tversion: '1.0.0',\n\t\texportedAt: new Date().toISOString(),\n\t\tsettings: {}\n\t};\n\n\t// Transform the settings data\n\tfor (const [key, settingData] of Object.entries(settingsResult.data)) {\n\t\tif (settingData && typeof settingData === 'object' && 'data' in settingData) {\n\t\t\tconst data = settingData as { data: SettingData };\n\t\t\tsnapshot.settings[key] = {\n\t\t\t\tvalue: data.data.value,\n\t\t\t\tcategory: data.data.category || 'public',\n\t\t\t\tdescription: data.data.description || ''\n\t\t\t};\n\t\t}\n\t}\n\n\treturn snapshot;\n}\n\n/**\n * Imports settings from a snapshot file using database-agnostic interface.\n * This allows restoring settings from a project template.\n */\nexport async function importSettingsSnapshot(snapshot: Record<string, unknown>, dbAdapter: DatabaseAdapter): Promise<void> {\n\tif (!dbAdapter || !dbAdapter.systemPreferences) {\n\t\tthrow new Error('Database adapter or systemPreferences interface not available');\n\t}\n\n\tif (!snapshot.settings) {\n\t\tthrow new Error('Invalid settings snapshot format');\n\t}\n\n\tlogger.info('üì• Importing settings snapshot...');\n\n\tconst settingsToSet: Array<{\n\t\tkey: string;\n\t\tvalue: unknown;\n\t\tscope: 'user' | 'system';\n\t\tuserId?: DatabaseId;\n\t}> = [];\n\n\tfor (const [key, settingData] of Object.entries(snapshot.settings)) {\n\t\tconst data = settingData as SettingData;\n\t\tsettingsToSet.push({\n\t\t\tkey,\n\t\t\tvalue: {\n\t\t\t\tdata: data.value,\n\t\t\t\tcategory: data.category || 'public',\n\t\t\t\tdescription: data.description || '',\n\t\t\t\tisGlobal: true,\n\t\t\t\tupdatedAt: new Date()\n\t\t\t},\n\t\t\tscope: 'system'\n\t\t});\n\t}\n\n\tconst result = await dbAdapter.systemPreferences.setMany(settingsToSet);\n\n\tif (!result.success) {\n\t\tthrow new Error(`Failed to import settings: ${result.error?.message}`);\n\t}\n\n\tlogger.info('‚úÖ Settings snapshot imported successfully');\n}\n\n/**\n * Seeds a demo tenant with default settings, theme, roles, and a user.\n */\nexport async function seedDemoTenant(dbAdapter: DatabaseAdapter, tenantId: string): Promise<void> {\n\tlogger.info(`üöÄ Seeding demo tenant ${tenantId}...`);\n\n\t// 1. Seed Settings (Force Demo Mode)\n\tawait seedSettings(dbAdapter, tenantId, true);\n\n\t// 2. Seed Default Theme\n\tawait seedDefaultTheme(dbAdapter, tenantId);\n\n\t// 3. Seed Roles\n\tawait seedRoles(dbAdapter, tenantId);\n\n\t// 4. Create Admin User\n\t// We need to import auth service or use dbAdapter.auth directly\n\tif (dbAdapter.auth) {\n\t\tconst result = await dbAdapter.auth.getRoleById('admin', tenantId);\n\t\tconst adminRole = result.success ? result.data : null;\n\t\tif (adminRole) {\n\t\t\tconst email = `demo-${tenantId.substring(0, 8)}@sveltycms.com`;\n\t\t\tconst password = 'demo'; // Simple password for demo\n\t\t\ttry {\n\t\t\t\tawait dbAdapter.auth.createUser({\n\t\t\t\t\temail,\n\t\t\t\t\tpassword,\n\t\t\t\t\trole: adminRole._id,\n\t\t\t\t\tusername: 'Demo Admin',\n\t\t\t\t\ttenantId\n\t\t\t\t});\n\t\t\t\tlogger.info(`‚úÖ Demo admin user created: ${email}`);\n\t\t\t} catch (e) {\n\t\t\t\tlogger.warn(`Demo user creation failed (might exist): ${e instanceof Error ? e.message : String(e)}`);\n\t\t\t}\n\t\t}\n\t}\n\n\tlogger.info(`‚úÖ Demo tenant ${tenantId} seeded successfully.`);\n}\n","/**\n * @file src/hooks/handleAuthentication.ts\n * @description Enterprise-grade authentication middleware with session validation, rotation, and multi-tenancy.\n *\n * @summary This hook runs after handleSystemState and handleSetup confirm the system is ready. It provides:\n * - **Session Management**: Validates session cookies with 3-layer caching (in-memory ‚Üí Redis ‚Üí database)\n * - **Security Token Rotation**: Automatic token rotation for active sessions (prevents session hijacking)\n * - **Multi-tenancy**: Hostname-based tenant identification with strict isolation\n * - **Memory Optimization**: WeakRef-based cache with automatic garbage collection\n * - **Rate Limiting**: Session rotation rate limits to prevent abuse\n * - **Metrics Integration**: Comprehensive tracking via MetricsService\n *\n * ### Features\n * - Session rotation every 15 minutes for active users\n * - WeakRef cache with LRU eviction (top 100 hot sessions)\n * - Tenant isolation enforcement (prevents cross-tenant access)\n * - Rate-limited refresh attempts (100/min per IP)\n * - Automatic cleanup of expired sessions\n * - Zero-downtime session validation\n *\n * @prerequisite handleSystemState and handleSetup have already confirmed readiness\n */\n\nimport type { Handle, RequestEvent } from '@sveltejs/kit';\nimport { error } from '@sveltejs/kit';\nimport { dev } from '$app/environment';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { SESSION_COOKIE_NAME } from '@shared/database/auth/constants';\nimport type { User } from '@shared/database/auth/types';\nimport type { ISODateString } from '@shared/database/dbInterface';\nimport { auth, dbAdapter } from '@shared/database/db';\nimport { getSystemState } from '@shared/stores/system';\nimport { seedDemoTenant } from '@shared/database/seed';\nimport { cacheService, SESSION_CACHE_TTL_MS } from '@shared/database/CacheService';\nimport { logger } from '@shared/utils/logger.server';\nimport { metricsService } from '@shared/services/MetricsService';\nimport { RateLimiter } from 'sveltekit-rate-limiter/server';\n\n// --- IN-MEMORY SESSION CACHE WITH WEAKREF-BASED CLEANUP ---\n\n/**\n * WeakRef-based session cache for automatic garbage collection.\n * This approach allows the JavaScript engine to clean up unused sessions\n * without requiring full iteration through the cache.\n *\n * Benefits:\n * - Lower memory overhead in high-traffic scenarios\n * - Automatic cleanup of unused sessions\n * - Better for clustered/edge environments\n * - No periodic setInterval cleanup needed\n */\n\ninterface SessionCacheEntry {\n\tuser: User;\n\ttimestamp: number;\n}\n\n/**\n * Main session cache using WeakRef for automatic GC.\n * Each entry can be garbage collected when no longer referenced.\n */\nconst sessionCache = new Map<string, WeakRef<SessionCacheEntry>>();\n\n/**\n * FinalizationRegistry to track when cache entries are garbage collected.\n * This allows us to clean up the Map keys when values are GC'd.\n */\nconst sessionCacheRegistry = new FinalizationRegistry<string>((sessionId) => {\n\tsessionCache.delete(sessionId);\n\tlogger.trace(`Session cache entry GC'd: ${sessionId.substring(0, 8)}...`);\n});\n\n/**\n * Strong references to prevent immediate GC of recently accessed sessions.\n * This LRU-style cache keeps the most recent N sessions in memory.\n */\nconst MAX_STRONG_REFS = 100;\nconst strongRefs = new Map<string, SessionCacheEntry>();\n\n/**\n * Prevents frequent DB lookups for invalid sessions.\n */\nconst lastRefreshAttempt = new Map<string, number>();\n\n/**\n * Tracks last session rotation time to prevent excessive rotation.\n * Key: sessionId, Value: timestamp of last rotation\n */\nconst lastRotationAttempt = new Map<string, number>();\n\n/**\n * Session rotation interval: 15 minutes\n * Balances security (regular token refresh) with performance (reduced DB writes)\n */\nconst SESSION_ROTATION_INTERVAL_MS = 15 * 60 * 1000;\n\n/**\n * Rate limiter for session rotation to prevent abuse.\n * Limits: 100 rotation attempts per minute per IP\n */\nconst rotationRateLimiter = new RateLimiter({\n\tIP: [100, 'm'],\n\tcookie: {\n\t\tname: 'session_rotation_limit',\n\t\tsecret: getPrivateSettingSync('JWT_SECRET_KEY') || 'fallback-dev-secret',\n\t\trate: [100, 'm'],\n\t\tpreflight: true\n\t}\n});\n\n/**\n * Gets a session from the cache, handling WeakRef dereferencing.\n */\nfunction getSessionFromCache(sessionId: string): SessionCacheEntry | null {\n\tconst now = Date.now();\n\n\t// Check strong references first (most recent)\n\tconst strongRef = strongRefs.get(sessionId);\n\tif (strongRef && now - strongRef.timestamp < SESSION_CACHE_TTL_MS) {\n\t\treturn strongRef;\n\t}\n\n\t// Check weak references\n\tconst weakRef = sessionCache.get(sessionId);\n\tif (weakRef) {\n\t\tconst entry = weakRef.deref();\n\t\tif (entry && now - entry.timestamp < SESSION_CACHE_TTL_MS) {\n\t\t\t// Promote to strong reference\n\t\t\taddToStrongRefs(sessionId, entry);\n\t\t\treturn entry;\n\t\t}\n\t}\n\n\treturn null;\n}\n\n/**\n * Sets a session in the cache with WeakRef.\n */\nfunction setSessionInCache(sessionId: string, entry: SessionCacheEntry): void {\n\t// Add to strong refs (LRU)\n\taddToStrongRefs(sessionId, entry);\n\n\t// Add to weak refs with GC tracking\n\tconst weakRef = new WeakRef(entry);\n\tsessionCache.set(sessionId, weakRef);\n\tsessionCacheRegistry.register(entry, sessionId);\n}\n\n/**\n * Adds/updates a session in the strong reference LRU cache.\n */\nfunction addToStrongRefs(sessionId: string, entry: SessionCacheEntry): void {\n\t// Remove if exists (for LRU re-insertion)\n\tif (strongRefs.has(sessionId)) {\n\t\tstrongRefs.delete(sessionId);\n\t}\n\n\t// Add to end (most recent)\n\tstrongRefs.set(sessionId, entry);\n\n\t// Evict oldest if over limit\n\tif (strongRefs.size > MAX_STRONG_REFS) {\n\t\tconst firstKey = strongRefs.keys().next().value;\n\t\tif (firstKey) {\n\t\t\tstrongRefs.delete(firstKey);\n\t\t}\n\t}\n}\n\n// Periodic cleanup of expired strong references and lastRefreshAttempt\nif (typeof setInterval !== 'undefined') {\n\tsetInterval(\n\t\t() => {\n\t\t\tconst now = Date.now();\n\n\t\t\t// Clean expired strong refs\n\t\t\tfor (const [sessionId, data] of strongRefs.entries()) {\n\t\t\t\tif (now - data.timestamp > SESSION_CACHE_TTL_MS) {\n\t\t\t\t\tstrongRefs.delete(sessionId);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Clean old refresh attempts\n\t\t\tfor (const [sessionId, timestamp] of lastRefreshAttempt.entries()) {\n\t\t\t\tif (now - timestamp > 300000) {\n\t\t\t\t\t// 5 minutes\n\t\t\t\t\tlastRefreshAttempt.delete(sessionId);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Clean old rotation attempts\n\t\t\tfor (const [sessionId, timestamp] of lastRotationAttempt.entries()) {\n\t\t\t\tif (now - timestamp > SESSION_ROTATION_INTERVAL_MS * 2) {\n\t\t\t\t\tlastRotationAttempt.delete(sessionId);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlogger.trace(`Session cache cleanup: ${strongRefs.size} strong refs, ${sessionCache.size} weak refs`);\n\t\t},\n\t\t5 * 60 * 1000\n\t);\n}\n\n// --- UTILITY FUNCTIONS ---\n\n/** Derives tenant ID from hostname */\nfunction getTenantIdFromHostname(hostname: string): string | null {\n\tif (!getPrivateSettingSync('MULTI_TENANT')) return null;\n\n\tif (hostname === 'localhost' || hostname.startsWith('127.0.0.1') || hostname.startsWith('192.168.')) {\n\t\treturn 'default';\n\t}\n\n\tconst parts = hostname.split('.');\n\tif (parts.length > 2 && !['www', 'app', 'api', 'cdn', 'static'].includes(parts[0])) {\n\t\treturn parts[0];\n\t}\n\n\treturn null;\n}\n\n/** Multi-layer user session retrieval (in-memory ‚Üí distributed ‚Üí DB) */\nasync function getUserFromSession(sessionId: string, tenantId?: string): Promise<User | null> {\n\tconst now = Date.now();\n\n\t// Layer 1: In-memory cache with WeakRef (fastest)\n\tconst memCached = getSessionFromCache(sessionId);\n\tif (memCached) {\n\t\tlogger.trace(`Session cache hit (memory): ${sessionId.substring(0, 8)}...`);\n\t\treturn memCached.user;\n\t}\n\n\t// Layer 2: Distributed cache (Redis)\n\ttry {\n\t\tconst cacheKey = tenantId ? `session:${tenantId}:${sessionId}` : `session:${sessionId}`;\n\t\tconst redisCached = await cacheService.get<SessionCacheEntry>(cacheKey, tenantId);\n\t\tif (redisCached && now - redisCached.timestamp < SESSION_CACHE_TTL_MS) {\n\t\t\tsetSessionInCache(sessionId, redisCached);\n\t\t\tlogger.trace(`Session cache hit (redis): ${sessionId.substring(0, 8)}...`);\n\t\t\treturn redisCached.user;\n\t\t}\n\t} catch (err) {\n\t\tlogger.warn(`Redis session read failed: ${err instanceof Error ? err.message : String(err)}`);\n\t}\n\n\t// Layer 3: Database (source of truth)\n\tconst lastAttempt = lastRefreshAttempt.get(sessionId);\n\tif (lastAttempt && now - lastAttempt < 60000) return null; // 1-minute cooldown\n\tlastRefreshAttempt.set(sessionId, now);\n\n\tif (!auth) {\n\t\t// Only log as error if system is ready, otherwise suppress or log as debug\n\t\tconst sysState = getSystemState();\n\t\tif (sysState.overallState === 'READY' || sysState.overallState === 'DEGRADED') {\n\t\t\tlogger.error('Auth service unavailable, skipping session validation.');\n\t\t} else {\n\t\t\tlogger.debug('Auth service not ready, skipping session validation.');\n\t\t}\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tconst user = await auth.validateSession(sessionId);\n\t\tif (user) {\n\t\t\tconst sessionData: SessionCacheEntry = { user, timestamp: now };\n\t\t\tsetSessionInCache(sessionId, sessionData);\n\t\t\tconst cacheKey = tenantId ? `session:${tenantId}:${sessionId}` : `session:${sessionId}`;\n\t\t\tawait cacheService\n\t\t\t\t.set(cacheKey, sessionData, Math.ceil(SESSION_CACHE_TTL_MS / 1000), tenantId)\n\t\t\t\t.catch((err) => logger.warn(`Session cache set failed: ${err.message}`));\n\t\t\tlogger.trace(`Session validated from DB: ${sessionId.substring(0, 8)}...`);\n\t\t\treturn user;\n\t\t}\n\t} catch (err) {\n\t\tlogger.error(`Session validation failed for ${sessionId.substring(0, 8)}: ${err instanceof Error ? err.message : String(err)}`);\n\t}\n\n\treturn null;\n}\n\n/**\n * Handles automatic session rotation for security.\n * Rotates session tokens every 15 minutes for active users to prevent session hijacking.\n *\n * @param event - SvelteKit request event\n * @param user - Authenticated user object\n * @param oldSessionId - Current session ID\n * @returns Promise<void>\n */\nasync function handleSessionRotation(event: RequestEvent, user: User, oldSessionId: string): Promise<void> {\n\tconst now = Date.now();\n\n\t// Check if rotation is needed (15-minute interval)\n\tconst lastRotation = lastRotationAttempt.get(oldSessionId);\n\tif (lastRotation && now - lastRotation < SESSION_ROTATION_INTERVAL_MS) {\n\t\treturn; // Too soon for rotation\n\t}\n\n\t// Rate limit check\n\tif (await rotationRateLimiter.isLimited(event)) {\n\t\tlogger.debug(`Session rotation rate limited for session ${oldSessionId.substring(0, 8)}...`);\n\t\treturn;\n\t}\n\n\t// Attempt rotation\n\ttry {\n\t\tif (!auth?.createSession || !auth?.destroySession) {\n\t\t\tlogger.warn('Session rotation not supported by auth adapter');\n\t\t\treturn;\n\t\t}\n\n\t\t// Create new session with same user\n\t\tconst newSession = await auth.createSession({\n\t\t\tuser_id: user._id,\n\t\t\texpires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() as ISODateString, // 30 days\n\t\t\ttenantId: event.locals.tenantId\n\t\t});\n\n\t\tif (newSession && newSession._id !== oldSessionId) {\n\t\t\tconst newSessionId = newSession._id;\n\n\t\t\t// Update cookie with new session ID\n\t\t\tevent.cookies.set(SESSION_COOKIE_NAME, newSessionId, {\n\t\t\t\tpath: '/',\n\t\t\t\thttpOnly: true,\n\t\t\t\tsecure: event.url.protocol === 'https:' || (event.url.hostname !== 'localhost' && !dev),\n\t\t\t\tsameSite: 'lax',\n\t\t\t\tmaxAge: 60 * 60 * 24 * 30 // 30 days\n\t\t\t});\n\n\t\t\t// Destroy old session\n\t\t\tawait auth\n\t\t\t\t.destroySession(oldSessionId)\n\t\t\t\t.catch((err) => logger.warn(`Failed to destroy old session ${oldSessionId.substring(0, 8)}: ${err.message}`));\n\n\t\t\t// Invalidate old session from all caches\n\t\t\tinvalidateSessionCache(oldSessionId, event.locals.tenantId);\n\n\t\t\t// Cache new session\n\t\t\tconst sessionData: SessionCacheEntry = { user, timestamp: now };\n\t\t\tsetSessionInCache(newSessionId, sessionData);\n\n\t\t\tconst cacheKey = event.locals.tenantId ? `session:${event.locals.tenantId}:${newSessionId}` : `session:${newSessionId}`;\n\t\t\tawait cacheService\n\t\t\t\t.set(cacheKey, sessionData, Math.ceil(SESSION_CACHE_TTL_MS / 1000), event.locals.tenantId)\n\t\t\t\t.catch((err) => logger.warn(`Failed to cache rotated session: ${err.message}`));\n\n\t\t\t// Update locals with new session ID\n\t\t\tevent.locals.session_id = newSessionId;\n\n\t\t\t// Track rotation\n\t\t\tlastRotationAttempt.set(newSessionId, now);\n\n\t\t\tmetricsService.incrementAuthValidations();\n\t\t\tlogger.info(`Session rotated for user ${user._id}: ${oldSessionId.substring(0, 8)}... ‚Üí ${newSessionId.substring(0, 8)}...`);\n\t\t}\n\t} catch (err) {\n\t\t// Non-fatal error - log but don't break the session\n\t\tlogger.error(`Session rotation failed for ${oldSessionId.substring(0, 8)}: ${err instanceof Error ? err.message : String(err)}`);\n\n\t\t// If rotation fails due to invalid session, this is critical\n\t\tif (err instanceof Error && err.message.includes('invalid')) {\n\t\t\tevent.cookies.delete(SESSION_COOKIE_NAME, { path: '/' });\n\t\t\tevent.locals.user = null;\n\t\t\tevent.locals.session_id = undefined;\n\t\t\tinvalidateSessionCache(oldSessionId, event.locals.tenantId);\n\t\t\tthrow error(401, 'Session expired. Please log in again.');\n\t\t}\n\t}\n}\n\n// --- MAIN HOOK ---\n\nexport const handleAuthentication: Handle = async ({ event, resolve }) => {\n\tconst { locals, url, cookies } = event;\n\n\t// Skip internal or special requests\n\tconst ASSET_REGEX =\n\t\t/^\\/(?:@vite\\/client|@fs\\/|src\\/|node_modules\\/|vite\\/|_app|static|favicon\\.ico|\\.svelte-kit\\/generated\\/client\\/nodes|.*\\.(svg|png|jpg|jpeg|gif|css|js|woff|woff2|ttf|eot|map|json))/;\n\tif (url.pathname.startsWith('/.well-known/') || url.pathname.startsWith('/_') || ASSET_REGEX.test(url.pathname)) {\n\t\treturn resolve(event);\n\t}\n\n\t// Skip public routes\n\tconst publicRoutes = ['/login', '/register', '/forgot-password', '/setup', '/api/setup'];\n\tconst isLocalizedPublic = /^\\/[a-z]{2,5}(-[a-zA-Z]+)?\\/(setup|login|register|forgot-password)/.test(url.pathname);\n\n\tif (publicRoutes.some((r) => url.pathname.startsWith(r)) || isLocalizedPublic) {\n\t\treturn resolve(event);\n\t}\n\n\t// --- Setup Guard Removed ---\n\t// handleSetup already handles unconfigured states, saving import overhead.\n\n\t// Attach database adapter\n\tlocals.dbAdapter = dbAdapter;\n\tif (!dbAdapter) {\n\t\tlogger.warn('Database adapter unavailable; system initializing.');\n\t\t// During setup/initialization, skip authentication entirely\n\t\t// handleSetup will enforce proper access control for setup routes\n\t\treturn resolve(event);\n\t}\n\n\t// Step 1: Multi-tenancy (synchronous check)\n\tconst multiTenant = getPrivateSettingSync('MULTI_TENANT');\n\tconst isDemoMode = getPrivateSettingSync('DEMO');\n\n\tif (multiTenant) {\n\t\tlet tenantId: string | null = null;\n\n\t\tif (isDemoMode) {\n\t\t\t// For demo mode, try to get tenantId from cookie first\n\t\t\ttenantId = cookies.get('demo_tenant_id') || null;\n\n\t\t\tif (!tenantId) {\n\t\t\t\t// If no demo_tenant_id cookie, generate a new one\n\t\t\t\ttenantId = crypto.randomUUID();\n\t\t\t\t// Set the cookie for future requests in this session\n\t\t\t\tcookies.set('demo_tenant_id', tenantId, {\n\t\t\t\t\tpath: '/',\n\t\t\t\t\thttpOnly: true,\n\t\t\t\t\tsecure: url.protocol === 'https:' || (url.hostname !== 'localhost' && !dev),\n\t\t\t\t\tsameSite: 'lax',\n\t\t\t\t\tmaxAge: 60 * 20 // 20 minutes for a demo session\n\t\t\t\t});\n\t\t\t\tlogger.info(`New demo tenant generated: ${tenantId}`);\n\n\t\t\t\t// --- Trigger Tenant Seeding Here ---\n\t\t\t\ttry {\n\t\t\t\t\tawait seedDemoTenant(dbAdapter, tenantId);\n\t\t\t\t\tlogger.info(`‚úÖ New demo tenant ${tenantId} seeded successfully.`);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tlogger.error(`Failed to seed demo tenant ${tenantId}:`, e);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlogger.trace(`Existing demo tenant from cookie: ${tenantId}`);\n\t\t\t}\n\t\t} else {\n\t\t\t// Standard multi-tenancy: resolve tenantId from hostname\n\t\t\ttenantId = getTenantIdFromHostname(url.hostname);\n\t\t}\n\n\t\tif (!tenantId) {\n\t\t\tlogger.error(`Tenant not found for hostname: ${url.hostname}`);\n\t\t\tthrow error(404, `Tenant not found for hostname: ${url.hostname}`);\n\t\t}\n\t\tlocals.tenantId = tenantId;\n\t\tlogger.trace(`Tenant identified: ${tenantId}`);\n\t}\n\n\t// Step 2: Session validation\n\tconst sessionId = cookies.get(SESSION_COOKIE_NAME);\n\tif (sessionId) {\n\t\tmetricsService.incrementAuthValidations();\n\n\t\t// Check if auth service is ready before attempting validation\n\t\tif (!auth) {\n\t\t\tlogger.debug('Auth service not ready during session validation - skipping validation but preserving cookie');\n\t\t\t// Do NOT delete cookie here - allow retry on next request\n\t\t\treturn resolve(event);\n\t\t}\n\n\t\tconst user = await getUserFromSession(sessionId, locals.tenantId);\n\t\tif (user) {\n\t\t\t// Tenant isolation check\n\t\t\tif (locals.tenantId && user.tenantId && user.tenantId !== locals.tenantId) {\n\t\t\t\tlogger.warn(`Tenant isolation violation: User ${user._id} (tenant: ${user.tenantId}) tried ${locals.tenantId}`);\n\t\t\t\tmetricsService.incrementAuthFailures();\n\t\t\t\tcookies.delete(SESSION_COOKIE_NAME, { path: '/' });\n\t\t\t\tthrow error(403, 'Access denied: Tenant isolation violation');\n\t\t\t}\n\n\t\t\t// Set user in locals\n\t\t\tlocals.user = user;\n\t\t\tlocals.session_id = sessionId;\n\t\t\tlocals.permissions = user.permissions || [];\n\t\t\tlogger.trace(`User authenticated: ${user._id}`);\n\n\t\t\t// Step 3: Automatic session rotation (security enhancement)\n\t\t\t// Rotates session token every 15 minutes for active users\n\t\t\ttry {\n\t\t\t\tawait handleSessionRotation(event, user, sessionId);\n\t\t\t} catch (rotationError) {\n\t\t\t\t// Rotation errors are already handled in handleSessionRotation\n\t\t\t\t// Just log additional context here if needed\n\t\t\t\tif (rotationError instanceof Error && !rotationError.message.includes('Session expired')) {\n\t\t\t\t\tlogger.debug(`Non-critical rotation issue: ${rotationError.message}`);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// Only delete cookie if auth was ready but session was invalid\n\t\t\t// getUserFromSession returns null if session not found/expired OR if auth not ready\n\t\t\t// But we checked !auth above, so here it means session is truly invalid\n\t\t\tmetricsService.incrementAuthFailures();\n\t\t\tcookies.delete(SESSION_COOKIE_NAME, { path: '/' });\n\t\t\tlogger.trace(`Invalid session removed: ${sessionId.substring(0, 8)}...`);\n\t\t}\n\t}\n\n\treturn resolve(event);\n};\n\n// --- UTILITY EXPORTS ---\n\n/**\n * Invalidate a single session from all cache layers.\n * Use when logging out a user or detecting compromised sessions.\n *\n * @param sessionId - The session ID to invalidate\n * @param tenantId - Optional tenant ID for multi-tenant setups\n */\nexport function invalidateSessionCache(sessionId: string, tenantId?: string): void {\n\tsessionCache.delete(sessionId);\n\tstrongRefs.delete(sessionId);\n\tlastRefreshAttempt.delete(sessionId);\n\tlastRotationAttempt.delete(sessionId);\n\n\tconst cacheKey = tenantId ? `session:${tenantId}:${sessionId}` : `session:${sessionId}`;\n\tcacheService.delete(cacheKey, tenantId).catch((err) => logger.warn(`Failed to delete session from Redis: ${err.message}`));\n\n\tlogger.debug(`Session cache invalidated: ${sessionId.substring(0, 8)}...`);\n}\n\n/**\n * Clear session refresh cooldown to allow immediate validation.\n * Useful for testing or forced session validation.\n *\n * @param sessionId - The session ID to clear cooldown for\n */\nexport function clearSessionRefreshAttempt(sessionId: string): void {\n\tlastRefreshAttempt.delete(sessionId);\n}\n\n/**\n * Force session rotation for a specific session.\n * Useful for security responses or administrative actions.\n *\n * @param sessionId - The session ID to force rotation for\n */\nexport function forceSessionRotation(sessionId: string): void {\n\tlastRotationAttempt.delete(sessionId);\n\tlogger.info(`Forced rotation flag set for session ${sessionId.substring(0, 8)}...`);\n}\n\n/**\n * Clears all session caches (maintenance only).\n * WARNING: This will force all users to re-authenticate on next request.\n * Only use during maintenance windows or security incidents.\n */\nexport function clearAllSessionCaches(): void {\n\tsessionCache.clear();\n\tstrongRefs.clear();\n\tlastRefreshAttempt.clear();\n\tlastRotationAttempt.clear();\n\tlogger.warn('‚ö†Ô∏è  All session caches cleared - users will need to re-authenticate');\n}\n\n/**\n * Get session cache statistics for monitoring.\n * @returns Object containing cache sizes and metrics\n */\nexport function getSessionCacheStats() {\n\treturn {\n\t\tweakRefs: sessionCache.size,\n\t\tstrongRefs: strongRefs.size,\n\t\tpendingRefreshes: lastRefreshAttempt.size,\n\t\tpendingRotations: lastRotationAttempt.size,\n\t\tmaxStrongRefs: MAX_STRONG_REFS\n\t};\n}\n","/**\n * @file src/hooks/handleLocale.ts\n * @description Synchronizes language preferences from cookies to Svelte stores\n *\n * ### Purpose\n * This hook runs **after** ParaglideJS's main i18n handler, which determines the\n * request language from the URL. This hook handles *secondary* language preferences\n * stored in cookies:\n * - **System Language**: UI language for the application interface\n * - **Content Language**: Language for user-generated content and data\n *\n * ### Behavior\n * - Reads language cookies and syncs them to their respective stores\n * - Validates language codes against supported locales\n * - Cleans up invalid cookies automatically\n * - Handles malformed cookie values gracefully\n * - Only updates stores if cookies contain valid, supported languages\n *\n * ### Prerequisites\n * - ParaglideJS i18n.handle() has already determined the request language\n * - System state is READY (guaranteed by handleSystemState)\n *\n * @prerequisite Runs after i18n.handle() in the middleware sequence\n */\n\nimport type { Handle } from '@sveltejs/kit';\nimport { app } from '@shared/stores/store.svelte';\nimport type { Locale } from '@shared/paraglide/runtime';\nimport { locales } from '@shared/paraglide/runtime';\nimport { logger } from '@shared/utils/logger.server';\n\n// --- UTILITY FUNCTIONS ---\n\n/**\n * Validates if a language code is supported by the application.\n *\n * @param lang - The language code to validate\n * @returns True if the language is supported, false otherwise\n */\nfunction isValidLocale(lang: string | undefined): lang is Locale {\n\tif (!lang) return false;\n\treturn (locales as readonly string[]).includes(lang);\n}\n\n/**\n * Safely sets a language in a store, with validation and error handling.\n *\n * @param cookieName - Name of the cookie being processed\n * @param cookieValue - The language value from the cookie\n * @param setter - Function to update the store\n * @returns True if successfully set, false otherwise\n */\nfunction safelySetLanguage(cookieName: string, cookieValue: string | undefined, setter: (value: Locale) => void): boolean {\n\tif (!cookieValue) return false;\n\n\tif (!isValidLocale(cookieValue)) {\n\t\tlogger.warn(`Invalid ${cookieName} cookie value: \"${cookieValue}\". ` + `Supported locales: ${locales.join(', ')}`);\n\t\treturn false;\n\t}\n\n\ttry {\n\t\tsetter(cookieValue);\n\t\tlogger.trace(`${cookieName} set to: ${cookieValue}`);\n\t\treturn true;\n\t} catch (err) {\n\t\tlogger.error(`Failed to set ${cookieName} store: ${err instanceof Error ? err.message : String(err)}`);\n\t\treturn false;\n\t}\n}\n\n// --- MAIN HOOK ---\n\nexport const handleLocale: Handle = async ({ event, resolve }) => {\n\tconst { cookies } = event;\n\n\t// Safety check: Ensure stores are available (server-side initialization)\n\tif (!app) {\n\t\tlogger.warn('Language stores not available on server, skipping handleLocale');\n\t\treturn resolve(event);\n\t}\n\n\t// Sync system language store from cookie\n\tconst systemLangCookie = cookies.get('systemLanguage');\n\tconst systemLangSet = safelySetLanguage('systemLanguage', systemLangCookie, (value) => (app.systemLanguage = value));\n\n\t// Clean up invalid system language cookie\n\tif (systemLangCookie && !systemLangSet) {\n\t\tlogger.debug('Removing invalid systemLanguage cookie');\n\t\tcookies.delete('systemLanguage', { path: '/' });\n\t}\n\n\t// Sync content language store from cookie\n\tconst contentLangCookie = cookies.get('contentLanguage');\n\tconst contentLangSet = safelySetLanguage('contentLanguage', contentLangCookie, (value) => (app.contentLanguage = value));\n\n\t// Clean up invalid content language cookie\n\tif (contentLangCookie && !contentLangSet) {\n\t\tlogger.debug('Removing invalid contentLanguage cookie');\n\t\tcookies.delete('contentLanguage', { path: '/' });\n\t}\n\n\treturn resolve(event);\n};\n","/**\n * @file src/hooks/handleTheme.ts\n * @description Handles server-side theme rendering to prevent theme flickering.\n *\n * ### Features\n * - Reads 'theme' cookie with values: 'system' | 'light' | 'dark'\n * - Injects the 'dark' class into the initial HTML for correct SSR\n * - Sets `event.locals.darkMode` (boolean) for use in other server `load` functions\n */\n\nimport type { Handle } from '@sveltejs/kit';\nimport { ThemeManager } from '@shared/database/themeManager';\nimport { logger } from '@shared/utils/logger.server';\nimport { getSystemState } from '@shared/stores/system';\n\n// Get the singleton ThemeManager instance\nconst themeManager = ThemeManager.getInstance();\n\nexport const handleTheme: Handle = async ({ event, resolve }) => {\n\t// 1. Read the theme preference cookie\n\tconst themePreference = event.cookies.get('theme') as 'system' | 'light' | 'dark' | undefined;\n\n\t// 2. Determine the dark mode state\n\tlet isDarkMode = false;\n\n\tif (themePreference === 'dark') {\n\t\tisDarkMode = true;\n\t} else if (themePreference === 'light') {\n\t\tisDarkMode = false;\n\t} else {\n\t\t// For 'system' or no preference, we can't determine server-side\n\t\t// The inline script in app.html will handle this client-side\n\t\t// Default to false for SSR (will be corrected by client script immediately)\n\t\tisDarkMode = false;\n\t}\n\n\t// 3. Set darkMode (boolean) for use in other server load functions\n\tevent.locals.darkMode = isDarkMode;\n\n\t// 4. Retrieve custom CSS from the active theme, but only if initialized\n\tif (themeManager.isInitialized()) {\n\t\ttry {\n\t\t\tconst currentTheme = await themeManager.getTheme(event.locals.tenantId);\n\t\t\tevent.locals.theme = currentTheme; // Make the entire theme object available\n\t\t\tevent.locals.customCss = currentTheme?.customCss || '';\n\t\t} catch (err) {\n\t\t\t// Only log as error if system is ready, otherwise suppress or log as debug\n\t\t\tconst sysState = getSystemState();\n\t\t\tif (sysState.overallState === 'READY' || sysState.overallState === 'DEGRADED') {\n\t\t\t\tlogger.error('Error retrieving custom CSS in handleTheme hook:', err);\n\t\t\t} else {\n\t\t\t\tlogger.debug('ThemeManager not ready, skipping custom CSS.');\n\t\t\t}\n\t\t\tevent.locals.theme = null;\n\t\t\tevent.locals.customCss = '';\n\t\t}\n\t} else {\n\t\t// ThemeManager not initialized yet (system is still starting up)\n\t\tevent.locals.theme = null;\n\t\tevent.locals.customCss = '';\n\t}\n\n\t// 5. Transform the HTML response to prevent flickering\n\treturn resolve(event, {\n\t\ttransformPageChunk: ({ html }) => {\n\t\t\t// This string MUST match your <html ...> tag in app.html\n\t\t\tconst htmlTag = '<html lang=\"en\" dir=\"ltr\">';\n\n\t\t\t// Only inject dark class if explicitly set to 'dark'\n\t\t\t// For 'system', let the client-side script handle it\n\t\t\tif (themePreference === 'dark') {\n\t\t\t\treturn html.replace(htmlTag, '<html lang=\"en\" dir=\"ltr\" class=\"dark\">');\n\t\t\t}\n\t\t\treturn html;\n\t\t}\n\t});\n};\n","/**\n * @file src/hooks/addSecurityHeaders.ts\n * @description Security headers middleware with essential HTTP security headers\n *\n * ### Security Headers Applied\n * - **X-Frame-Options**: Prevents clickjacking attacks\n * - **X-Content-Type-Options**: Prevents MIME-sniffing vulnerabilities\n * - **Referrer-Policy**: Controls referrer information leakage\n * - **Permissions-Policy**: Restricts browser feature access\n * - **Strict-Transport-Security**: Enforces HTTPS in production\n *\n * ### CSP Handling\n * - Content Security Policy is managed by SvelteKit's built-in CSP system\n * - Configured in svelte.config.js for optimal nonce-based protection\n *\n * ### Performance\n * - Static assets are handled by handleStaticAssetCaching middleware (runs earlier)\n * - Minimal overhead as headers are only set for dynamic responses\n *\n * @prerequisite Static asset handling done by earlier middleware\n */\n\nimport { dev } from '$app/environment';\nimport type { Handle } from '@sveltejs/kit';\n\nexport const addSecurityHeaders: Handle = async ({ event, resolve }) => {\n\tconst response = await resolve(event);\n\n\t// Static assets are already handled by handleStaticAssetCaching middleware\n\n\t// Basic security headers (SvelteKit handles CSP via svelte.config.js)\n\tresponse.headers.set('X-Frame-Options', 'SAMEORIGIN');\n\tresponse.headers.set('X-Content-Type-Options', 'nosniff');\n\tresponse.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');\n\tresponse.headers.set(\n\t\t'Permissions-Policy',\n\t\t['geolocation=()', 'microphone=()', 'camera=()', 'display-capture=()', 'clipboard-read=()', 'clipboard-write=(self)', 'web-share=(self)'].join(\n\t\t\t', '\n\t\t)\n\t);\n\n\t// HTTPS-only headers for production (CRITICAL: Fixed from 'httpss:' typo)\n\tif (!dev && event.url.protocol === 'https:') {\n\t\tresponse.headers.set('Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload');\n\t}\n\n\treturn response;\n};\n","/**\n * @file src/hooks/handleRateLimit.ts\n * @description Middleware for rate limiting to prevent abuse and DoS attacks with clustered deployment support\n *\n * ### Rate Limiting Strategy\n * - **General Routes**: 500 requests/minute per IP, IP+UA, and cookie\n * - **API Routes**: 500 requests/minute per IP, 200 requests/minute per IP+UA (stricter)\n * - **Exemptions**: Localhost, build process, static assets\n *\n * ### Multi-Layer Protection\n * 1. **IP-based**: Prevents basic abuse from single source\n * 2. **IP + User-Agent**: Prevents abuse from same IP with multiple UAs\n * 3. **Cookie-based**: Signed cookie tracking for additional security\n * 4. **Distributed Store**: Redis/Database backend for clustered deployments\n *\n * ### Clustered Deployment Support\n * - Automatically uses Redis if available via CacheService\n * - Falls back to in-memory for single-instance deployments\n * - Shared rate limiting across all instances in load-balanced environments\n *\n * ### Behavior\n * - Returns 429 \"Too Many Requests\" when limits exceeded\n * - Logs violations with IP and endpoint for monitoring\n * - Exempt routes bypass all checks for performance\n *\n * ### Prerequisites\n * - handleSystemState confirmed system is READY\n * - JWT_SECRET_KEY is configured for cookie signing\n * - CacheService configured with Redis for distributed rate limiting\n *\n * @prerequisite System state is READY and JWT secret is available\n */\n\nimport { building } from '$app/environment';\nimport { error, type Handle, type RequestEvent } from '@sveltejs/kit';\nimport { RateLimiter } from 'sveltekit-rate-limiter/server';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { metricsService } from '@shared/services/MetricsService';\nimport { cacheService } from '@shared/database/CacheService';\nimport { logger } from '@shared/utils/logger.server';\n\n// --- RATE LIMITER CONFIGURATION ---\n\n/**\n * Custom store plugin for distributed rate limiting using Redis/Database.\n * Enables shared rate limiting across clustered deployments.\n */\nconst distributedStore = {\n\t/**\n\t * Gets the current count for a rate limit key\n\t */\n\tasync get(key: string): Promise<number | undefined> {\n\t\ttry {\n\t\t\tconst data = await cacheService.get<{ count: number; expires: number }>(`ratelimit:${key}`);\n\t\t\tif (data && data.expires > Date.now()) {\n\t\t\t\treturn data.count;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t} catch (err) {\n\t\t\tlogger.warn(`Distributed rate limit store GET failed: ${err instanceof Error ? err.message : String(err)}`);\n\t\t\treturn undefined;\n\t\t}\n\t},\n\n\tasync has(key: string): Promise<boolean> {\n\t\treturn (await this.get(key)) !== undefined;\n\t},\n\n\t/**\n\t * Adds/sets a value in the store (required by sveltekit-rate-limiter)\n\t */\n\tasync add(key: string, ttlSeconds: number): Promise<number> {\n\t\ttry {\n\t\t\tif (await this.has(key)) {\n\t\t\t\treturn this.increment(key, ttlSeconds);\n\t\t\t}\n\t\t\tconst expires = Date.now() + ttlSeconds * 1000;\n\t\t\tawait cacheService.set(`ratelimit:${key}`, { count: 1, expires }, ttlSeconds);\n\t\t\treturn 1;\n\t\t} catch (err) {\n\t\t\tlogger.error(`Distributed rate limit store ADD failed: ${err instanceof Error ? err.message : String(err)}`);\n\t\t\treturn 0;\n\t\t}\n\t},\n\n\t/**\n\t * Increments the counter for a rate limit key\n\t */\n\tasync increment(key: string, ttlSeconds: number): Promise<number> {\n\t\ttry {\n\t\t\tconst existing = await this.get(key);\n\t\t\tconst newCount = (existing || 0) + 1;\n\t\t\tconst expires = Date.now() + ttlSeconds * 1000;\n\n\t\t\tawait cacheService.set(`ratelimit:${key}`, { count: newCount, expires }, ttlSeconds);\n\t\t\tconsole.log(`[RateLimit] INC ${key}: ${newCount}`);\n\t\t\treturn newCount;\n\t\t} catch (err) {\n\t\t\tlogger.error(`Distributed rate limit store INCREMENT failed: ${err instanceof Error ? err.message : String(err)}`);\n\t\t\treturn 1; // Fail open to prevent blocking all traffic\n\t\t}\n\t},\n\tasync clear(): Promise<void> {\n\t\ttry {\n\t\t\tawait cacheService.delete(`ratelimit:*`); // Clear all rate limit keys\n\t\t} catch (err) {\n\t\t\tlogger.error(`Distributed rate limit store CLEAR failed: ${err instanceof Error ? err.message : String(err)}`);\n\t\t}\n\t}\n};\n\n/** General limiter for all non-API routes with distributed store support */\nconst generalLimiter = new RateLimiter({\n\tIP: [500, 'm'],\n\tIPUA: [500, 'm'],\n\tcookie: {\n\t\tname: 'ratelimit',\n\t\tsecret: getPrivateSettingSync('JWT_SECRET_KEY') || 'fallback-dev-secret',\n\t\trate: [500, 'm'],\n\t\tpreflight: true\n\t},\n\t// Enable distributed store if Redis is available\n\tstore: cacheService ? distributedStore : undefined\n});\n\n/** Stricter limiter for API routes with distributed store support */\nconst apiLimiter = new RateLimiter({\n\tIP: [500, 'm'],\n\tIPUA: [200, 'm'],\n\t// Enable distributed store if Redis is available\n\tstore: cacheService ? distributedStore : undefined\n});\n\n/** Stricter limiter for Auth routes (brute force protection) */\nconst authLimiter = new RateLimiter({\n\tIP: [10, 'm'], // 10 requests per minute per IP\n\tIPUA: [5, 'm'], // 5 requests per minute per IP+UA\n\tstore: cacheService ? distributedStore : undefined\n});\n\n// --- UTILITY FUNCTIONS ---\n\n/** Extracts client IP from request headers or environment */\nfunction getClientIp(event: RequestEvent): string {\n\ttry {\n\t\tconst address = event.getClientAddress();\n\t\tif (address) return address;\n\t} catch {\n\t\t// Fallback to proxy headers\n\t}\n\n\tconst forwarded = event.request.headers.get('x-forwarded-for');\n\tif (forwarded) return forwarded.split(',')[0].trim();\n\n\tconst realIp = event.request.headers.get('x-real-ip');\n\tif (realIp) return realIp;\n\n\treturn '127.0.0.1';\n}\n\n/** Determines if an IP is localhost */\nfunction isLocalhost(ip: string): boolean {\n\treturn ip === '127.0.0.1' || ip === '::1' || ip === '::ffff:127.0.0.1';\n}\n\n/**\n * Checks if a pathname points to a static asset that should bypass rate limiting.\n * Static assets are typically cached by CDNs and don't need rate limiting.\n */\nconst STATIC_EXTENSIONS = /\\.(js|css|map|woff2?|ttf|eot|svg|png|jpg|jpeg|gif|webp|ico)$/;\n\nfunction isStaticAsset(pathname: string): boolean {\n\treturn (\n\t\tpathname.startsWith('/static/') ||\n\t\tpathname.startsWith('/_app/') ||\n\t\tpathname === '/favicon.ico' ||\n\t\tpathname === '/robots.txt' ||\n\t\tpathname === '/sitemap.xml' ||\n\t\tSTATIC_EXTENSIONS.test(pathname)\n\t);\n}\n\n// --- MAIN HOOK ---\n\nexport const handleRateLimit: Handle = async ({ event, resolve }) => {\n\tconst { url } = event;\n\tconst clientIp = getClientIp(event);\n\n\t// --- Exemptions (Skip Rate Limiting) ---\n\n\t// 1. Build process\n\tif (building) return resolve(event);\n\n\t// 2. Localhost during development OR production\n\t// Allow bypassing this check for testing purposes\n\tconst bypassLocalhost = event.request.headers.get('x-test-rate-limit-bypass-localhost') === 'true';\n\t// console.log(`[RateLimit] IP: ${clientIp}, Localhost: ${isLocalhost(clientIp)}, Bypass: ${bypassLocalhost}, Path: ${url.pathname}`);\n\tif (isLocalhost(clientIp) && !bypassLocalhost) {\n\t\treturn resolve(event);\n\t}\n\n\t// 3. Static assets (no need to rate limit CDN-cached content)\n\tif (isStaticAsset(url.pathname)) return resolve(event);\n\n\t// --- Apply Rate Limiting ---\n\tlet limiter = generalLimiter;\n\n\tif (url.pathname.startsWith('/api/auth')) {\n\t\tlimiter = authLimiter;\n\t} else if (url.pathname.startsWith('/api/')) {\n\t\tlimiter = apiLimiter;\n\t}\n\n\tif (await limiter.isLimited(event)) {\n\t\tmetricsService.incrementRateLimitViolations();\n\n\t\tlogger.warn(\n\t\t\t`Rate limit exceeded for IP: ${clientIp}, ` +\n\t\t\t\t`endpoint: ${url.pathname}, ` +\n\t\t\t\t`UA: ${event.request.headers.get('user-agent')?.substring(0, 50) || 'unknown'}`\n\t\t);\n\n\t\tthrow error(429, 'Too Many Requests. Please slow down and try again later.');\n\t}\n\n\treturn resolve(event);\n};\n","/**\n * @file src/hooks/handleFirewall.ts\n * @description Minimal application-level firewall middleware for threat detection\n *\n * ### Purpose\n * Focuses on application-specific threats that infrastructure (Nginx/CDN) cannot detect:\n * - Business logic abuse patterns\n * - Advanced bot detection (headless browsers, automation tools)\n * - Suspicious parameter patterns in requests\n * - Application-level credential stuffing attempts\n *\n * ### What This DOES NOT Do\n * - ‚ùå SQL injection detection (handled by Nginx/parameterized queries)\n * - ‚ùå Path traversal blocking (handled by Nginx/static middleware)\n * - ‚ùå Basic bot filtering (handled by Nginx/CDN)\n * - ‚ùå Rate limiting (handled by handleRateLimit)\n *\n * ### Performance\n * - Minimal overhead (~1-2ms per request)\n * - Only checks patterns Nginx can't detect\n * - Early exit for legitimate traffic\n * - Complements infrastructure-level security\n *\n * ### Prerequisites\n * - handleSystemState confirmed system is operational\n * - Static assets already filtered by handleStaticAssetCaching\n * - Rate limiting already applied by handleRateLimit\n *\n * @prerequisite Runs after rate limiting, before authentication\n */\n\nimport { error } from '@sveltejs/kit';\nimport type { Handle } from '@sveltejs/kit';\nimport { metricsService } from '@shared/services/MetricsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// --- THREAT DETECTION PATTERNS ---\n\n/**\n * Application-specific threat patterns that Nginx can't easily detect.\n * Focus on business logic abuse and suspicious parameter usage.\n */\nconst APP_THREAT_PATTERNS = [\n\t// Suspicious parameter patterns (credentials in URL)\n\t/[?&](password|token|secret|api_key|auth)=[^&]*/i,\n\n\t// Bulk operations abuse\n\t/\\/api\\/(users|content|collections)\\/bulk-(delete|update|create)/i,\n\n\t// Administrative endpoint enumeration\n\t/\\/(admin|manage|control-panel|dashboard)\\/[^/]*\\/(delete|remove|destroy)/i,\n\n\t// Known malicious payloads in paths\n\t/<script[^>]*>|javascript:\\s*|data:text\\/html|vbscript:/i,\n\n\t// Template injection attempts (refined to allow legitimate CMS tokens)\n\t// Original: /\\{\\{.*\\}\\}|\\${.*}|<%.*%>/i\n\t// Refined: We allow {{...}} but block suspicious content within them or in non-token contexts\n\t// This specifically allows {{user.name}}, {{entry._id}}, etc. but still flags very long or complex expressions\n\t/(?<!\\{\\{)\\$\\{.*\\}|(?<!\\{\\{)<%.*%>|(?<!\\{\\{)\\{\\{.*[;<>].*\\}\\}/i,\n\n\t// Command injection patterns\n\t/;(\\s)*(ls|cat|wget|curl|nc|bash|sh|cmd|powershell)/i\n];\n\n/**\n * Advanced bot detection patterns.\n * These are automation tools that might bypass basic CDN detection.\n */\nconst ADVANCED_BOT_PATTERNS = [/HeadlessChrome/i, /PhantomJS/i, /Selenium/i, /Puppeteer/i, /WebDriver/i, /Playwright/i, /Nightmare/i, /ZombieJS/i];\n\n/**\n * Legitimate bot patterns that should NOT be blocked.\n * These are search engines and social media crawlers.\n */\nconst LEGITIMATE_BOT_PATTERNS = [\n\t/Googlebot/i,\n\t/Bingbot/i,\n\t/Slurp/i, // Yahoo\n\t/DuckDuckBot/i,\n\t/Baiduspider/i,\n\t/YandexBot/i,\n\t/facebookexternalhit/i,\n\t/LinkedInBot/i,\n\t/Twitterbot/i,\n\t/WhatsApp/i,\n\t/TelegramBot/i,\n\t/Discordbot/i\n];\n\n// --- UTILITY FUNCTIONS ---\n\n/**\n * Checks if a user agent represents a legitimate bot.\n * @param userAgent - The User-Agent header value\n * @returns True if the bot is legitimate (search engines, social media)\n */\nfunction isLegitimateBot(userAgent: string): boolean {\n\tconst allowedBots = getPrivateSettingSync('FIREWALL_ALLOWED_BOTS') || [];\n\tconst patterns = [...LEGITIMATE_BOT_PATTERNS, ...allowedBots.map((p) => new RegExp(p, 'i'))];\n\treturn patterns.some((pattern) => pattern.test(userAgent));\n}\n\n/**\n * Checks if a user agent represents an advanced bot or automation tool.\n * @param userAgent - The User-Agent header value\n * @returns True if advanced bot patterns are detected\n */\nfunction isAdvancedBot(userAgent: string): boolean {\n\tconst blockedBots = getPrivateSettingSync('FIREWALL_BLOCKED_BOTS') || [];\n\tconst patterns = [...ADVANCED_BOT_PATTERNS, ...blockedBots.map((p) => new RegExp(p, 'i'))];\n\treturn patterns.some((pattern) => pattern.test(userAgent));\n}\n\n/**\n * Checks if the request contains application-level threat patterns.\n * @param pathname - The URL pathname\n * @param search - The URL search parameters\n * @returns True if threat patterns are detected\n */\nfunction hasApplicationThreat(pathname: string, search: string): boolean {\n\tconst fullPath = pathname + search;\n\treturn APP_THREAT_PATTERNS.some((pattern) => pattern.test(fullPath));\n}\n\n/**\n * Checks if the request has suspicious patterns that might indicate abuse.\n * @param pathname - The URL pathname\n * @returns True if suspicious patterns are detected\n */\nfunction hasSuspiciousPattern(pathname: string): boolean {\n\t// Check for excessive path depth (possible enumeration)\n\tconst pathDepth = pathname.split('/').filter(Boolean).length;\n\tif (pathDepth > 10) {\n\t\treturn true;\n\t}\n\n\t// Check for suspicious file operations\n\tif (pathname.includes('/../') || pathname.includes('/./')) {\n\t\treturn true;\n\t}\n\n\t// Check for encoded bypasses\n\tif (pathname.includes('%2e%2e') || pathname.includes('%252e')) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n// --- MAIN HOOK ---\n\nexport const handleFirewall: Handle = async ({ event, resolve }) => {\n\tconst { request, url } = event;\n\tconst userAgent = request.headers.get('user-agent') || '';\n\tconst pathname = url.pathname.toLowerCase();\n\tconst search = url.search.toLowerCase();\n\n\t// Check if firewall is enabled (default to true if not set)\n\tconst firewallEnabled = getPrivateSettingSync('FIREWALL_ENABLED') ?? true;\n\tif (!firewallEnabled) return resolve(event);\n\n\t// --- 1. Advanced Bot Detection ---\n\t// Block automation tools but allow legitimate search engine crawlers\n\tif (isAdvancedBot(userAgent) && !isLegitimateBot(userAgent)) {\n\t\tmetricsService.incrementSecurityViolations();\n\t\tlogger.warn(`Advanced bot detected and blocked: UA=${userAgent.substring(0, 50)}, Path=${pathname}`);\n\t\tthrow error(403, 'Forbidden: Automated access detected');\n\t}\n\n\t// --- 2. Application-Level Threat Detection ---\n\t// Check for patterns that Nginx can't detect (business logic abuse)\n\tif (hasApplicationThreat(pathname, search)) {\n\t\tmetricsService.incrementSecurityViolations();\n\t\tlogger.warn(`Application threat detected: IP=${event.getClientAddress()}, ` + `Path=${pathname}, ` + `UA=${userAgent.substring(0, 50)}`);\n\t\tthrow error(403, 'Forbidden: Request pattern not allowed');\n\t}\n\n\t// --- 3. Suspicious Pattern Detection ---\n\t// Check for indicators of enumeration or abuse attempts\n\tif (hasSuspiciousPattern(pathname)) {\n\t\tmetricsService.incrementSecurityViolations();\n\t\tlogger.warn(`Suspicious pattern detected: IP=${event.getClientAddress()}, Path=${pathname}`);\n\t\tthrow error(403, 'Forbidden: Invalid request pattern');\n\t}\n\n\t// --- 4. Request Passed All Checks ---\n\treturn resolve(event);\n};\n\n// --- UTILITY EXPORTS ---\n\n/**\n * Export detection functions for use in other hooks or API routes.\n */\nexport { isLegitimateBot, isAdvancedBot, hasApplicationThreat, hasSuspiciousPattern };\n"],"names":["isStaticAsset","importedDefaultRoles","dbAdapter","error"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAmBA,IAAI,sBAAyE;AAC7E,IAAI,YAA0B;AAC9B,IAAI,gBAAwB;AAG5B,MAAM,kBAAkB;AAEjB,MAAM,oBAA4B,OAAO,EAAE,OAAO,cAAc;AACtE,QAAM,EAAE,aAAa,MAAM;AAC3B,QAAM,gBAAgB,gBAAA;AAEtB,MAAI,cAAc,eAAA;AAGlB,QAAM,gBAAgB,SAAS,WAAW,oBAAoB,KAAK,SAAS,WAAW,uBAAuB;AAC9G,QAAMA,iBAAgB,SAAS,WAAW,SAAS,KAAK,SAAS,WAAW,SAAS,KAAK,SAAS,WAAW,IAAI;AAElH,MAAI,CAAC,iBAAiB,CAACA,gBAAe;AACrC,WAAO;AAAA,MACN,uBAAuB,MAAM,QAAQ,MAAM,IAAI,QAAQ,GAAG,MAAM,IAAI,MAAM,WAAW,MAAM,aAAa,aAAa,YAAY,YAAY,gBAAgB,mBAAmB;AAAA,IAAA;AAAA,EAElL;AAOA,MAAI,YAAY,iBAAiB,QAAQ;AACxC,QAAI,wBAAwB,WAAW;AACtC,UAAI,eAAe;AAElB,8BAAsB;AACtB,wBAAgB,KAAK,IAAA;AACrB,eAAO,KAAK,kEAAkE;AAE9E,YAAI;AAEH,gBAAM,QAAQ,KAAK;AAAA,YAClB;AAAA,YACA,IAAI,QAAQ,CAAC,GAAG,WAAW,WAAW,MAAM,OAAO,IAAI,MAAM,wBAAwB,CAAC,GAAG,eAAe,CAAC;AAAA,UAAA,CACzG;AAED,wBAAc,eAAA;AACd,gCAAsB;AACtB,gBAAM,WAAW,KAAK,IAAA,IAAQ;AAC9B,iBAAO,KAAK,8BAA8B,QAAQ,qBAAqB,YAAY,YAAY,EAAE;AAAA,QAClG,SAAS,KAAK;AACb,gCAAsB;AACtB,sBAAY,eAAe,QAAQ,MAAM,IAAI,MAAM,OAAO,GAAG,CAAC;AAC9D,iBAAO,MAAM,0BAA0B,SAAS;AAChD,gBAAM,MAAM,KAAK,0DAA0D;AAAA,QAC5E;AAAA,MACD,OAAO;AAEN,eAAO,KAAK,uEAAuE;AACnF,8BAAsB;AAAA,MACvB;AAAA,IACD,WAAW,wBAAwB,eAAe;AAEjD,YAAM,UAAU,KAAK,IAAA,IAAQ;AAG7B,UAAI,UAAU,iBAAiB;AAC9B,8BAAsB;AACtB,oBAAY,IAAI,MAAM,oCAAoC,eAAe,KAAK;AAC9E,eAAO,MAAM,2BAA2B,SAAS;AACjD,cAAM,MAAM,KAAK,6DAA6D;AAAA,MAC/E;AAEA,aAAO,MAAM,kCAAkC,QAAQ,wCAAwC,OAAO,gBAAgB;AACtH,UAAI;AACH,cAAM,QAAQ,KAAK;AAAA,UAClB;AAAA,UACA,IAAI,QAAQ,CAAC,GAAG,WAAW,WAAW,MAAM,OAAO,IAAI,MAAM,6BAA6B,CAAC,GAAG,kBAAkB,OAAO,CAAC;AAAA,QAAA,CACxH;AACD,sBAAc,eAAA;AAAA,MACf,SAAS,KAAK;AACb,eAAO,MAAM,+BAA+B,GAAG;AAC/C,cAAM,MAAM,KAAK,wDAAwD;AAAA,MAC1E;AAAA,IACD,WAAW,wBAAwB,UAAU;AAE5C,aAAO,MAAM,4CAA4C,SAAS;AAClE,YAAM,MAAM,KAAK,wBAAwB,WAAW,WAAW,8BAA8B,EAAE;AAAA,IAChG;AAAA,EAED;AAGA,MAAI,YAAY,iBAAiB,QAAQ;AACxC,UAAM,eAAe;AAAA,MACpB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA;AAAA,IAAA;AAED,UAAM,mBAAmB,qDAAqD,KAAK,QAAQ;AAC3F,UAAM,iBAAiB,aAAa,KAAK,CAAC,WAAW,SAAS,WAAW,MAAM,CAAC,KAAK,aAAa,OAAO;AAEzG,QAAI,gBAAgB;AACnB,aAAO,MAAM,uBAAuB,QAAQ,kCAAkC;AAC9E,aAAO,QAAQ,KAAK;AAAA,IACrB;AAAA,EACD;AAGA,MAAI,YAAY,iBAAiB,gBAAgB;AAChD,UAAM,eAAe;AAAA,MACpB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA;AAED,UAAM,mBAAmB,qDAAqD,KAAK,QAAQ;AAC3F,UAAM,iBAAiB,aAAa,KAAK,CAAC,WAAW,SAAS,WAAW,MAAM,CAAC,KAAM,CAAC,iBAAiB,aAAa,OAAQ;AAE7H,QAAI,gBAAgB;AACnB,aAAO,MAAM,uBAAuB,QAAQ,6BAA6B;AACzE,aAAO,QAAQ,KAAK;AAAA,IACrB;AAGA,WAAO,MAAM,cAAc,QAAQ,4CAA4C;AAC/E,QAAI;AACH,YAAM,QAAQ,KAAK,CAAC,eAAe,IAAI,QAAQ,CAAC,GAAG,WAAW,WAAW,MAAM,OAAO,IAAI,MAAM,mBAAmB,CAAC,GAAG,eAAe,CAAC,CAAC,CAAC;AACzI,oBAAc,eAAA;AACd,aAAO,MAAM,iDAAiD,YAAY,YAAY,EAAE;AAAA,IACzF,SAAS,KAAK;AACb,aAAO,MAAM,8BAA8B,GAAG;AAC9C,YAAM,MAAM,KAAK,oDAAoD;AAAA,IACtE;AAGA,QAAI,CAAC,iBAAiB;AACrB,aAAO,KAAK,cAAc,QAAQ,iDAAiD;AACnF,YAAM,MAAM,KAAK,wFAAwF;AAAA,IAC1G;AAAA,EACD;AAGA,QAAM,aAAa,YAAY,iBAAiB,WAAW,YAAY,iBAAiB;AACxF,MAAI,CAAC,YAAY;AAChB,UAAM,eAAe,CAAC,sBAAsB,yBAAyB,UAAU,cAAc,uBAAuB,YAAY;AAChI,UAAM,iBAAiB,aAAa,KAAK,CAAC,WAAW,SAAS,WAAW,MAAM,CAAC;AAEhF,QAAI,gBAAgB;AACnB,aAAO,MAAM,uBAAuB,QAAQ,WAAW,YAAY,YAAY,SAAS;AACxF,aAAO,QAAQ,KAAK;AAAA,IACrB;AAGA,QAAI,SAAS,WAAW,eAAe,KAAK,SAAS,SAAS,UAAU,GAAG;AAC1E,aAAO,MAAM,cAAc,QAAQ,iCAAiC,YAAY,YAAY,GAAG;AAAA,IAChG,OAAO;AACN,aAAO,KAAK,cAAc,QAAQ,iCAAiC,YAAY,YAAY,GAAG;AAAA,IAC/F;AACA,UAAM,MAAM,KAAK,+EAA+E;AAAA,EACjG;AAGA,MAAI,YAAY,iBAAiB,YAAY;AAC5C,UAAM,mBAAmB,OAAO,QAAQ,YAAY,QAAQ,EAC1D,OAAO,CAAC,CAAA,EAAG,CAAC,MAAM,EAAE,WAAW,WAAW,EAC1C,IAAI,CAAC,CAAC,IAAI,MAAM,IAAI;AAEtB,QAAI,iBAAiB,SAAS,GAAG;AAChC,YAAM,OAAO,mBAAmB;AAChC,aAAO,KAAK,cAAc,QAAQ,2DAA2D,iBAAiB,KAAK,IAAI,CAAC,EAAE;AAAA,IAC3H;AAAA,EACD;AAEA,SAAO,QAAQ,KAAK;AACrB;AC5KO,MAAM,2BAA2B,eAAe,WAAW,CAAC,MAAM,IAAI;AACtE,MAAM,sBAAsB,eAAe;AAC3C,MAAM,4BAA4B;AAClC,MAAM,2BAA2B;AAaxC,MAAM,eAAsB;AAAA,EAC3B,KAAK;AAAA;AAAA,EACL,MAAM;AAAA;AAAA,EACN,MAAM;AAAA,EAEN,UAAU;AAAA,EACV,WAAW;AAAA,EACX,QAAQ;AAAA,IACP,oBAAoB;AAAA,IACpB,YAAY;AAAA,EAAA;AAAA,EAEb,WAAW,oBAAoB,oBAAI,MAAM;AAAA,EACzC,WAAW,oBAAoB,oBAAI,KAAA,CAAM;AAC1C;AAGO,MAAM,eAAeC;AAG5B,eAAsB,iBAAiBC,YAA4B,UAAkC;AACpG,SAAO,KAAK,6CAA6C,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAK;AAEvG,MAAI,CAACA,cAAa,CAACA,WAAU,QAAQ;AACpC,UAAM,IAAI,MAAM,oDAAoD;AAAA,EACrE;AAEA,MAAI;AAEH,UAAM,iBAAiB,MAAMA,WAAU,OAAO,aAAA;AAC9C,QAAI,MAAM,QAAQ,cAAc,KAAK,eAAe,SAAS,GAAG;AAC/D,aAAO,KAAK,yBAAyB,WAAW,eAAe,QAAQ,KAAK,EAAE,0BAA0B;AACxG;AAAA,IACD;AAGA,WAAO,KAAK,2BAA2B,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAK;AACrF,UAAM,eAAe;AAAA,MACpB,GAAG;AAAA,MACH,GAAI,YAAY,EAAE,SAAA;AAAA,IAAS;AAE5B,UAAMA,WAAU,OAAO,YAAY,CAAC,YAAY,CAAC;AACjD,WAAO,KAAK,sCAAsC,WAAW,eAAe,QAAQ,KAAK,EAAE,EAAE;AAAA,EAC9F,SAASC,QAAO;AACf,WAAO,MAAM,+BAA+B,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAKA,MAAK;AAC/F,UAAMA;AAAA,EACP;AACD;AAOA,eAAsB,UAAUD,YAA4B,UAAkC;AAC7F,SAAO,KAAK,2BAA2B,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAK;AAErF,MAAI,CAACA,cAAa,CAACA,WAAU,MAAM;AAClC,UAAM,IAAI,MAAM,kDAAkD;AAAA,EACnE;AAEA,MAAI;AAEH,UAAM,iBAAiB,kBAAA;AACvB,UAAM,mBAAmB,eAAe,IAAI,CAAC,MAAM,EAAE,GAAG;AAGxD,eAAW,QAAQ,cAAc;AAChC,UAAI;AAEH,cAAM,eAAe;AAAA,UACpB,GAAG;AAAA,UACH,aAAa,KAAK,QAAQ,UAAU,mBAAmB,KAAK;AAAA,UAC5D,GAAI,YAAY,EAAE,SAAA;AAAA,QAAS;AAG5B,cAAMA,WAAU,KAAK,WAAW,YAAY;AAC5C,eAAO,MAAM,WAAW,KAAK,IAAI,wBAAwB,WAAW,eAAe,QAAQ,KAAK,EAAE,EAAE;AAAA,MACrG,SAASC,QAAO;AAEf,cAAM,eAAeA,kBAAiB,QAAQA,OAAM,UAAU,OAAOA,MAAK;AAC1E,YAAI,aAAa,SAAS,WAAW,KAAK,aAAa,SAAS,QAAQ,GAAG;AAC1E,iBAAO,MAAM,aAAa,KAAK,IAAI,mBAAmB,WAAW,eAAe,QAAQ,KAAK,EAAE,YAAY;AAAA,QAC5G,OAAO;AACN,iBAAO,MAAM,wBAAwB,KAAK,IAAI,IAAI,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAKA,MAAK;AACrG,gBAAMA;AAAA,QACP;AAAA,MACD;AAAA,IACD;AAEA,WAAO,KAAK,sCAAsC,WAAW,eAAe,QAAQ,KAAK,EAAE,EAAE;AAAA,EAC9F,SAASA,QAAO;AACf,WAAO,MAAM,uBAAuB,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAKA,MAAK;AACvF,UAAMA;AAAA,EACP;AACD;AA2JO,MAAM,wBAAsF;AAAA;AAAA,EAElG,EAAE,KAAK,YAAY,OAAO,yBAAyB,aAAa,yBAAA;AAAA,EAChE,EAAE,KAAK,aAAa,OAAO,0BAA0B,aAAa,wBAAA;AAAA;AAAA,EAGlE,EAAE,KAAK,aAAa,OAAO,aAAa,aAAa,iCAAA;AAAA,EACrD,EAAE,KAAK,mBAAmB,OAAO,GAAG,aAAa,6CAAA;AAAA;AAAA,EAGjD,EAAE,KAAK,4BAA4B,OAAO,0BAA0B,aAAa,+BAAA;AAAA,EACjF,EAAE,KAAK,+BAA+B,OAAO,2BAA2B,aAAa,sCAAA;AAAA,EACrF,EAAE,KAAK,eAAe,OAAO,qBAAqB,aAAa,4CAAA;AAAA,EAC/D,EAAE,KAAK,WAAW,OAAO,0BAA0B,aAAa,sCAAA;AAAA;AAAA,EAGhE,EAAE,KAAK,sBAAsB,OAAO,SAAS,aAAa,oDAAA;AAAA,EAC1D,EAAE,KAAK,gBAAgB,OAAO,iBAAiB,aAAa,2CAAA;AAAA,EAC5D,EAAE,KAAK,+BAA+B,OAAO,EAAE,QAAQ,QAAQ,SAAS,GAAA,GAAM,aAAa,oCAAA;AAAA,EAC3F,EAAE,KAAK,eAAe,OAAO,EAAE,IAAI,KAAK,IAAI,KAAK,IAAI,QAAQ,aAAa,qCAAA;AAAA,EAC1E,EAAE,KAAK,iBAAiB,OAAO,UAAU,aAAa,gDAAA;AAAA,EACtD,EAAE,KAAK,mBAAmB,OAAO,UAAU,aAAa,sDAAA;AAAA,EACxD,EAAE,KAAK,yBAAyB,OAAO,MAAM,aAAa,iDAAA;AAAA;AAAA,EAG1D,EAAE,KAAK,WAAW,OAAO,MAAM,aAAa,2CAAA;AAAA,EAC5C,EAAE,KAAK,iBAAiB,OAAO,kBAAkB,aAAa,yCAAA;AAAA;AAAA;AAAA,EAI9D,EAAE,KAAK,oBAAoB,OAAO,IAAI,aAAa,2CAAA;AAAA,EACnD,EAAE,KAAK,sBAAsB,OAAO,kBAAkB,aAAa,4BAAA;AAAA,EACnE,EAAE,KAAK,sBAAsB,OAAO,IAAI,aAAa,qCAAA;AAAA,EACrD,EAAE,KAAK,4BAA4B,OAAO,MAAM,aAAa,iDAAA;AAAA;AAAA,EAG7D,EAAE,KAAK,qBAAqB,OAAO,uBAAuB,aAAa,yCAAA;AAAA,EACvE,EAAE,KAAK,eAAe,OAAO,SAAS,aAAa,8EAAA;AAAA;AAAA;AAAA;AAAA,EAMnD;AAAA,IACC,KAAK;AAAA,IACL,OAAO,CAAC,QAAQ,QAAQ,SAAS,OAAO;AAAA,IACxC,aAAa;AAAA,EAAA;AAAA,EAEd,EAAE,KAAK,sBAAsB,OAAO,IAAI,aAAa,mCAAA;AAAA,EACrD,EAAE,KAAK,qBAAqB,OAAO,UAAU,aAAa,6DAAA;AAAA;AAAA,EAG1D,EAAE,KAAK,QAAQ,OAAO,OAAO,aAAa,gDAAA;AAC3C;AAOO,MAAM,yBAAuF;AAAA;AAAA,EAEnG,EAAE,KAAK,WAAW,OAAO,OAAO,aAAa,4CAAA;AAAA,EAC7C,EAAE,KAAK,sCAAsC,OAAO,IAAI,aAAa,oCAAA;AAAA;AAAA,EAGrE,EAAE,KAAK,uBAAuB,OAAO,MAAM,aAAa,sCAAA;AAAA;AAAA,EAGxD,EAAE,KAAK,aAAa,OAAO,IAAI,aAAa,sCAAA;AAAA,EAC5C,EAAE,KAAK,aAAa,OAAO,KAAK,aAAa,mBAAA;AAAA,EAC7C,EAAE,KAAK,cAAc,OAAO,IAAI,aAAa,6BAAA;AAAA,EAC7C,EAAE,KAAK,iBAAiB,OAAO,IAAI,aAAa,sCAAA;AAAA;AAAA,EAGhD,EAAE,KAAK,oBAAoB,OAAO,OAAO,aAAa,gCAAA;AAAA,EACtD,EAAE,KAAK,oBAAoB,OAAO,IAAI,aAAa,yBAAA;AAAA,EACnD,EAAE,KAAK,wBAAwB,OAAO,IAAI,aAAa,6BAAA;AAAA;AAAA,EAGvD,EAAE,KAAK,aAAa,OAAO,OAAO,aAAa,2BAAA;AAAA,EAC/C,EAAE,KAAK,cAAc,OAAO,aAAa,aAAa,4BAAA;AAAA,EACtD,EAAE,KAAK,cAAc,OAAO,MAAM,aAAa,2BAAA;AAAA,EAC/C,EAAE,KAAK,kBAAkB,OAAO,IAAI,aAAa,4BAAA;AAAA;AAAA,EAGjD,EAAE,KAAK,oBAAoB,OAAO,KAAK,aAAa,qDAAA;AAAA,EACpD,EAAE,KAAK,oBAAoB,OAAO,KAAK,aAAa,mCAAA;AAAA,EACpD,EAAE,KAAK,mBAAmB,OAAO,KAAK,aAAa,2CAAA;AAAA,EACnD,EAAE,KAAK,qBAAqB,OAAO,KAAK,aAAa,mCAAA;AAAA,EACrD,EAAE,KAAK,mBAAmB,OAAO,KAAK,aAAa,qCAAA;AAAA,EACnD,EAAE,KAAK,qBAAqB,OAAO,OAAO,aAAa,uCAAA;AAAA,EACvD,EAAE,KAAK,kBAAkB,OAAO,IAAI,aAAa,sCAAA;AAAA,EACjD,EAAE,KAAK,iBAAiB,OAAO,KAAK,aAAa,oCAAA;AAAA;AAAA,EAGjD,EAAE,KAAK,4BAA4B,OAAO,KAAQ,aAAa,0DAAA;AAAA,EAC/D,EAAE,KAAK,0BAA0B,OAAO,KAAM,aAAa,+CAAA;AAAA,EAC3D,EAAE,KAAK,6BAA6B,OAAO,KAAK,aAAa,2DAAA;AAAA,EAC7D,EAAE,KAAK,8BAA8B,OAAO,OAAO,aAAa,yDAAA;AAAA;AAAA,EAGhE,EAAE,KAAK,cAAc,OAAO,OAAO,aAAa,4BAAA;AAAA,EAChD,EAAE,KAAK,oBAAoB,OAAO,IAAI,aAAa,gDAAA;AAAA,EACnD,EAAE,KAAK,2BAA2B,OAAO,IAAI,aAAa,gDAAA;AAAA;AAAA,EAG1D,EAAE,KAAK,kBAAkB,OAAO,IAAI,aAAa,oDAAA;AAAA,EACjD,EAAE,KAAK,gBAAgB,OAAO,IAAI,aAAa,mCAAA;AAAA,EAC/C,EAAE,KAAK,cAAc,OAAO,OAAO,aAAa,4BAAA;AAAA,EAChD,EAAE,KAAK,gBAAgB,OAAO,IAAI,aAAa,mCAAA;AAAA;AAAA,EAG/C,EAAE,KAAK,eAAe,OAAO,MAAM,aAAa,kCAAA;AAAA;AAAA,EAGhD,EAAE,KAAK,SAAS,OAAO,CAAC,SAAS,UAAU,QAAQ,GAAG,aAAa,6CAAA;AAAA,EACnE,EAAE,KAAK,eAAe,OAAO,CAAC,QAAQ,SAAS,UAAU,OAAO,GAAG,aAAa,8CAAA;AACjF;AASA,eAAsB,aAAaD,YAA4B,UAAmB,aAAa,OAAsB;AACpH,SAAO,KAAK,0CAA0C,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAK;AAEpG,MAAI,CAACA,cAAa,CAACA,WAAU,mBAAmB;AAC/C,UAAM,IAAI,MAAM,+DAA+D;AAAA,EAChF;AAGA,MAAI;AAEH,UAAMA,WAAU,kBAAkB,QAAQ,CAAC,UAAU,GAAG,QAAQ;AAChE,WAAO,MAAM,gCAAgC;AAAA,EAC9C,SAASC,QAAO;AACf,WAAO,MAAM,uCAAuCA,MAAK;AACzD,UAAM,IAAI,MAAM,mCAAmCA,kBAAiB,QAAQA,OAAM,UAAU,OAAOA,MAAK,CAAC,EAAE;AAAA,EAC5G;AAEA,QAAM,cAAc,CAAC,GAAG,uBAAuB,GAAG,sBAAsB;AAGxE,QAAM,qBAAqB,IAAI,IAAI,uBAAuB,IAAI,CAAC,MAAM,EAAE,GAAG,CAAC;AAG3E,QAAM,UAAU,YAAY,IAAI,CAAC,MAAM,EAAE,GAAG;AAC5C,MAAI,mBAA4C,CAAA;AAEhD,MAAI;AACH,UAAM,SAAS,MAAMD,WAAU,kBAAkB,QAAQ,SAAS,QAAQ;AAC1E,QAAI,OAAO,WAAW,OAAO,MAAM;AAClC,yBAAmB,OAAO;AAAA,IAC3B;AAAA,EACD,SAASC,QAAO;AACf,WAAO,MAAM,gDAAgD,QAAQ,oBAAoBA,MAAK;AAAA,EAC/F;AAGA,QAAM,iBAAiB,YAAY,OAAO,CAAC,YAAY,EAAE,QAAQ,OAAO,iBAAiB;AAEzF,MAAI,eAAe,WAAW,GAAG;AAChC,WAAO,KAAK,+BAA+B,WAAW,eAAe,QAAQ,KAAK,EAAE,6BAA6B;AACjH;AAAA,EACD;AAEA,SAAO;AAAA,IACN,cAAc,eAAe,MAAM,oBAAoB,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAK,OAAO,KAAK,gBAAgB,EAAE,MAAM;AAAA,EAAA;AAI1I,QAAM,gBAOD,CAAA;AAEL,aAAW,WAAW,gBAAgB;AAErC,UAAM,WAAW,mBAAmB,IAAI,QAAQ,GAAG,IAAI,YAAY;AAEnE,QAAI,QAAQ,QAAQ;AAGpB,QAAI,YAAY;AACf,UAAI,QAAQ,QAAQ,OAAQ,SAAQ;AACpC,UAAI,QAAQ,QAAQ,UAAW,SAAQ;AACvC,UAAI,QAAQ,QAAQ,gBAAiB,SAAQ;AAAA,IAC9C;AAEA,kBAAc,KAAK;AAAA,MAClB,KAAK,QAAQ;AAAA,MACb;AAAA;AAAA,MACA;AAAA;AAAA,MACA,OAAO;AAAA,MACP,GAAI,YAAY,EAAE,SAAA;AAAA,IAAS,CAC3B;AAAA,EACF;AAGA,MAAI;AACH,UAAM,SAAS,MAAMD,WAAU,kBAAkB,QAAQ,aAAa;AAEtE,QAAI,CAAC,OAAO,SAAS;AACpB,YAAM,IAAI,MAAM,OAAO,OAAO,WAAW,yBAAyB;AAAA,IACnE;AAEA,WAAO,KAAK,YAAY,eAAe,MAAM,mBAAmB;AAAA,EACjE,SAASC,QAAO;AACf,WAAO,MAAM,0BAA0B,WAAW,eAAe,QAAQ,KAAK,EAAE,KAAKA,MAAK;AAC1F,UAAMA;AAAA,EACP;AAIA,MAAI;AACH,WAAO,KAAK,wCAAwC;AAGpD,UAAM,iBAA0C,CAAA;AAGhD,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,gBAAgB,GAAG;AAC5D,YAAM,WAAW,sBAAsB,KAAK,CAAC,MAAM,EAAE,QAAQ,GAAG;AAChE,UAAI,UAAU;AACb,uBAAe,GAAG,IAAK,MAAc,SAAS;AAAA,MAC/C;AAAA,IACD;AAGA,eAAW,WAAW,gBAAgB;AACrC,YAAM,WAAW,sBAAsB,KAAK,CAAC,MAAM,EAAE,QAAQ,QAAQ,GAAG;AACxE,UAAI,UAAU;AACb,uBAAe,QAAQ,GAAG,IAAI,QAAQ;AAAA,MACvC;AAAA,IACD;AAGA,UAAM,eAAe,UAAU,oBAAoB,cAAc;AAEjE,QAAI,aAAa,SAAS;AAEzB,aAAO,KAAK,0CAA0C;AAAA,IACvD,OAAO;AACN,aAAO,KAAK,mCAAmC;AAE/C,aAAO,MAAM,sCAAsC,aAAa,MAAM;AAAA,IACvE;AAAA,EACD,SAASA,QAAO;AACf,WAAO,MAAM,sCAAsCA,MAAK;AAAA,EAEzD;AACD;AAiGA,eAAsB,eAAeD,YAA4B,UAAiC;AACjG,SAAO,KAAK,0BAA0B,QAAQ,KAAK;AAGnD,QAAM,aAAaA,YAAW,UAAU,IAAI;AAG5C,QAAM,iBAAiBA,YAAW,QAAQ;AAG1C,QAAM,UAAUA,YAAW,QAAQ;AAInC,MAAIA,WAAU,MAAM;AACnB,UAAM,SAAS,MAAMA,WAAU,KAAK,YAAY,SAAS,QAAQ;AACjE,UAAM,YAAY,OAAO,UAAU,OAAO,OAAO;AACjD,QAAI,WAAW;AACd,YAAM,QAAQ,QAAQ,SAAS,UAAU,GAAG,CAAC,CAAC;AAC9C,YAAM,WAAW;AACjB,UAAI;AACH,cAAMA,WAAU,KAAK,WAAW;AAAA,UAC/B;AAAA,UACA;AAAA,UACA,MAAM,UAAU;AAAA,UAChB,UAAU;AAAA,UACV;AAAA,QAAA,CACA;AACD,eAAO,KAAK,8BAA8B,KAAK,EAAE;AAAA,MAClD,SAAS,GAAG;AACX,eAAO,KAAK,4CAA4C,aAAa,QAAQ,EAAE,UAAU,OAAO,CAAC,CAAC,EAAE;AAAA,MACrG;AAAA,IACD;AAAA,EACD;AAEA,SAAO,KAAK,iBAAiB,QAAQ,uBAAuB;AAC7D;ACrnBA,MAAM,mCAAmB,IAAA;AAMzB,MAAM,uBAAuB,IAAI,qBAA6B,CAAC,cAAc;AAC5E,eAAa,OAAO,SAAS;AAC7B,SAAO,MAAM,6BAA6B,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK;AACzE,CAAC;AAMD,MAAM,kBAAkB;AACxB,MAAM,iCAAiB,IAAA;AAKvB,MAAM,yCAAyB,IAAA;AAM/B,MAAM,0CAA0B,IAAA;AAMhC,MAAM,+BAA+B,KAAK,KAAK;AAM/C,MAAM,sBAAsB,IAAI,YAAY;AAAA,EAC3C,IAAI,CAAC,KAAK,GAAG;AAAA,EACb,QAAQ;AAAA,IACP,MAAM;AAAA,IACN,QAAQ,sBAAsB,gBAAgB,KAAK;AAAA,IACnD,MAAM,CAAC,KAAK,GAAG;AAAA,IACf,WAAW;AAAA,EAAA;AAEb,CAAC;AAKD,SAAS,oBAAoB,WAA6C;AACzE,QAAM,MAAM,KAAK,IAAA;AAGjB,QAAM,YAAY,WAAW,IAAI,SAAS;AAC1C,MAAI,aAAa,MAAM,UAAU,YAAY,sBAAsB;AAClE,WAAO;AAAA,EACR;AAGA,QAAM,UAAU,aAAa,IAAI,SAAS;AAC1C,MAAI,SAAS;AACZ,UAAM,QAAQ,QAAQ,MAAA;AACtB,QAAI,SAAS,MAAM,MAAM,YAAY,sBAAsB;AAE1D,sBAAgB,WAAW,KAAK;AAChC,aAAO;AAAA,IACR;AAAA,EACD;AAEA,SAAO;AACR;AAKA,SAAS,kBAAkB,WAAmB,OAAgC;AAE7E,kBAAgB,WAAW,KAAK;AAGhC,QAAM,UAAU,IAAI,QAAQ,KAAK;AACjC,eAAa,IAAI,WAAW,OAAO;AACnC,uBAAqB,SAAS,OAAO,SAAS;AAC/C;AAKA,SAAS,gBAAgB,WAAmB,OAAgC;AAE3E,MAAI,WAAW,IAAI,SAAS,GAAG;AAC9B,eAAW,OAAO,SAAS;AAAA,EAC5B;AAGA,aAAW,IAAI,WAAW,KAAK;AAG/B,MAAI,WAAW,OAAO,iBAAiB;AACtC,UAAM,WAAW,WAAW,KAAA,EAAO,OAAO;AAC1C,QAAI,UAAU;AACb,iBAAW,OAAO,QAAQ;AAAA,IAC3B;AAAA,EACD;AACD;AAGA,IAAI,OAAO,gBAAgB,aAAa;AACvC;AAAA,IACC,MAAM;AACL,YAAM,MAAM,KAAK,IAAA;AAGjB,iBAAW,CAAC,WAAW,IAAI,KAAK,WAAW,WAAW;AACrD,YAAI,MAAM,KAAK,YAAY,sBAAsB;AAChD,qBAAW,OAAO,SAAS;AAAA,QAC5B;AAAA,MACD;AAGA,iBAAW,CAAC,WAAW,SAAS,KAAK,mBAAmB,WAAW;AAClE,YAAI,MAAM,YAAY,KAAQ;AAE7B,6BAAmB,OAAO,SAAS;AAAA,QACpC;AAAA,MACD;AAGA,iBAAW,CAAC,WAAW,SAAS,KAAK,oBAAoB,WAAW;AACnE,YAAI,MAAM,YAAY,+BAA+B,GAAG;AACvD,8BAAoB,OAAO,SAAS;AAAA,QACrC;AAAA,MACD;AAEA,aAAO,MAAM,0BAA0B,WAAW,IAAI,iBAAiB,aAAa,IAAI,YAAY;AAAA,IACrG;AAAA,IACA,IAAI,KAAK;AAAA,EAAA;AAEX;AAKA,SAAS,wBAAwB,UAAiC;AACjE,MAAI,CAAC,sBAAsB,cAAc,EAAG,QAAO;AAEnD,MAAI,aAAa,eAAe,SAAS,WAAW,WAAW,KAAK,SAAS,WAAW,UAAU,GAAG;AACpG,WAAO;AAAA,EACR;AAEA,QAAM,QAAQ,SAAS,MAAM,GAAG;AAChC,MAAI,MAAM,SAAS,KAAK,CAAC,CAAC,OAAO,OAAO,OAAO,OAAO,QAAQ,EAAE,SAAS,MAAM,CAAC,CAAC,GAAG;AACnF,WAAO,MAAM,CAAC;AAAA,EACf;AAEA,SAAO;AACR;AAGA,eAAe,mBAAmB,WAAmB,UAAyC;AAC7F,QAAM,MAAM,KAAK,IAAA;AAGjB,QAAM,YAAY,oBAAoB,SAAS;AAC/C,MAAI,WAAW;AACd,WAAO,MAAM,+BAA+B,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK;AAC1E,WAAO,UAAU;AAAA,EAClB;AAGA,MAAI;AACH,UAAM,WAAW,WAAW,WAAW,QAAQ,IAAI,SAAS,KAAK,WAAW,SAAS;AACrF,UAAM,cAAc,MAAM,aAAa,IAAuB,UAAU,QAAQ;AAChF,QAAI,eAAe,MAAM,YAAY,YAAY,sBAAsB;AACtE,wBAAkB,WAAW,WAAW;AACxC,aAAO,MAAM,8BAA8B,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK;AACzE,aAAO,YAAY;AAAA,IACpB;AAAA,EACD,SAAS,KAAK;AACb,WAAO,KAAK,8BAA8B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AAAA,EAC7F;AAGA,QAAM,cAAc,mBAAmB,IAAI,SAAS;AACpD,MAAI,eAAe,MAAM,cAAc,IAAO,QAAO;AACrD,qBAAmB,IAAI,WAAW,GAAG;AAErC,MAAI,CAAC,MAAM;AAEV,UAAM,WAAW,eAAA;AACjB,QAAI,SAAS,iBAAiB,WAAW,SAAS,iBAAiB,YAAY;AAC9E,aAAO,MAAM,wDAAwD;AAAA,IACtE,OAAO;AACN,aAAO,MAAM,sDAAsD;AAAA,IACpE;AACA,WAAO;AAAA,EACR;AAEA,MAAI;AACH,UAAM,OAAO,MAAM,KAAK,gBAAgB,SAAS;AACjD,QAAI,MAAM;AACT,YAAM,cAAiC,EAAE,MAAM,WAAW,IAAA;AAC1D,wBAAkB,WAAW,WAAW;AACxC,YAAM,WAAW,WAAW,WAAW,QAAQ,IAAI,SAAS,KAAK,WAAW,SAAS;AACrF,YAAM,aACJ,IAAI,UAAU,aAAa,KAAK,KAAK,uBAAuB,GAAI,GAAG,QAAQ,EAC3E,MAAM,CAAC,QAAQ,OAAO,KAAK,6BAA6B,IAAI,OAAO,EAAE,CAAC;AACxE,aAAO,MAAM,8BAA8B,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK;AACzE,aAAO;AAAA,IACR;AAAA,EACD,SAAS,KAAK;AACb,WAAO,MAAM,iCAAiC,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AAAA,EAC/H;AAEA,SAAO;AACR;AAWA,eAAe,sBAAsB,OAAqB,MAAY,cAAqC;AAC1G,QAAM,MAAM,KAAK,IAAA;AAGjB,QAAM,eAAe,oBAAoB,IAAI,YAAY;AACzD,MAAI,gBAAgB,MAAM,eAAe,8BAA8B;AACtE;AAAA,EACD;AAGA,MAAI,MAAM,oBAAoB,UAAU,KAAK,GAAG;AAC/C,WAAO,MAAM,6CAA6C,aAAa,UAAU,GAAG,CAAC,CAAC,KAAK;AAC3F;AAAA,EACD;AAGA,MAAI;AACH,QAAI,CAAC,MAAM,iBAAiB,CAAC,MAAM,gBAAgB;AAClD,aAAO,KAAK,gDAAgD;AAC5D;AAAA,IACD;AAGA,UAAM,aAAa,MAAM,KAAK,cAAc;AAAA,MAC3C,SAAS,KAAK;AAAA,MACd,SAAS,IAAI,KAAK,KAAK,IAAA,IAAQ,KAAK,KAAK,KAAK,KAAK,GAAI,EAAE,YAAA;AAAA;AAAA,MACzD,UAAU,MAAM,OAAO;AAAA,IAAA,CACvB;AAED,QAAI,cAAc,WAAW,QAAQ,cAAc;AAClD,YAAM,eAAe,WAAW;AAGhC,YAAM,QAAQ,IAAI,qBAAqB,cAAc;AAAA,QACpD,MAAM;AAAA,QACN,UAAU;AAAA,QACV,QAAQ,MAAM,IAAI,aAAa,YAAa,MAAM,IAAI,aAAa,eAAe,CAAC;AAAA,QACnF,UAAU;AAAA,QACV,QAAQ,KAAK,KAAK,KAAK;AAAA;AAAA,MAAA,CACvB;AAGD,YAAM,KACJ,eAAe,YAAY,EAC3B,MAAM,CAAC,QAAQ,OAAO,KAAK,iCAAiC,aAAa,UAAU,GAAG,CAAC,CAAC,KAAK,IAAI,OAAO,EAAE,CAAC;AAG7G,6BAAuB,cAAc,MAAM,OAAO,QAAQ;AAG1D,YAAM,cAAiC,EAAE,MAAM,WAAW,IAAA;AAC1D,wBAAkB,cAAc,WAAW;AAE3C,YAAM,WAAW,MAAM,OAAO,WAAW,WAAW,MAAM,OAAO,QAAQ,IAAI,YAAY,KAAK,WAAW,YAAY;AACrH,YAAM,aACJ,IAAI,UAAU,aAAa,KAAK,KAAK,uBAAuB,GAAI,GAAG,MAAM,OAAO,QAAQ,EACxF,MAAM,CAAC,QAAQ,OAAO,KAAK,oCAAoC,IAAI,OAAO,EAAE,CAAC;AAG/E,YAAM,OAAO,aAAa;AAG1B,0BAAoB,IAAI,cAAc,GAAG;AAEzC,qBAAe,yBAAA;AACf,aAAO,KAAK,4BAA4B,KAAK,GAAG,KAAK,aAAa,UAAU,GAAG,CAAC,CAAC,SAAS,aAAa,UAAU,GAAG,CAAC,CAAC,KAAK;AAAA,IAC5H;AAAA,EACD,SAAS,KAAK;AAEb,WAAO,MAAM,+BAA+B,aAAa,UAAU,GAAG,CAAC,CAAC,KAAK,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AAG/H,QAAI,eAAe,SAAS,IAAI,QAAQ,SAAS,SAAS,GAAG;AAC5D,YAAM,QAAQ,OAAO,qBAAqB,EAAE,MAAM,KAAK;AACvD,YAAM,OAAO,OAAO;AACpB,YAAM,OAAO,aAAa;AAC1B,6BAAuB,cAAc,MAAM,OAAO,QAAQ;AAC1D,YAAM,MAAM,KAAK,uCAAuC;AAAA,IACzD;AAAA,EACD;AACD;AAIO,MAAM,uBAA+B,OAAO,EAAE,OAAO,cAAc;AACzE,QAAM,EAAE,QAAQ,KAAK,QAAA,IAAY;AAGjC,QAAM,cACL;AACD,MAAI,IAAI,SAAS,WAAW,eAAe,KAAK,IAAI,SAAS,WAAW,IAAI,KAAK,YAAY,KAAK,IAAI,QAAQ,GAAG;AAChH,WAAO,QAAQ,KAAK;AAAA,EACrB;AAGA,QAAM,eAAe,CAAC,UAAU,aAAa,oBAAoB,UAAU,YAAY;AACvF,QAAM,oBAAoB,qEAAqE,KAAK,IAAI,QAAQ;AAEhH,MAAI,aAAa,KAAK,CAAC,MAAM,IAAI,SAAS,WAAW,CAAC,CAAC,KAAK,mBAAmB;AAC9E,WAAO,QAAQ,KAAK;AAAA,EACrB;AAMA,SAAO,YAAY;AACnB,MAAI,CAAC,WAAW;AACf,WAAO,KAAK,oDAAoD;AAGhE,WAAO,QAAQ,KAAK;AAAA,EACrB;AAGA,QAAM,cAAc,sBAAsB,cAAc;AACxD,QAAM,aAAa,sBAAsB,MAAM;AAE/C,MAAI,aAAa;AAChB,QAAI,WAA0B;AAE9B,QAAI,YAAY;AAEf,iBAAW,QAAQ,IAAI,gBAAgB,KAAK;AAE5C,UAAI,CAAC,UAAU;AAEd,mBAAW,OAAO,WAAA;AAElB,gBAAQ,IAAI,kBAAkB,UAAU;AAAA,UACvC,MAAM;AAAA,UACN,UAAU;AAAA,UACV,QAAQ,IAAI,aAAa,YAAa,IAAI,aAAa,eAAe,CAAC;AAAA,UACvE,UAAU;AAAA,UACV,QAAQ,KAAK;AAAA;AAAA,QAAA,CACb;AACD,eAAO,KAAK,8BAA8B,QAAQ,EAAE;AAGpD,YAAI;AACH,gBAAM,eAAe,WAAW,QAAQ;AACxC,iBAAO,KAAK,qBAAqB,QAAQ,uBAAuB;AAAA,QACjE,SAAS,GAAG;AACX,iBAAO,MAAM,8BAA8B,QAAQ,KAAK,CAAC;AAAA,QAC1D;AAAA,MACD,OAAO;AACN,eAAO,MAAM,qCAAqC,QAAQ,EAAE;AAAA,MAC7D;AAAA,IACD,OAAO;AAEN,iBAAW,wBAAwB,IAAI,QAAQ;AAAA,IAChD;AAEA,QAAI,CAAC,UAAU;AACd,aAAO,MAAM,kCAAkC,IAAI,QAAQ,EAAE;AAC7D,YAAM,MAAM,KAAK,kCAAkC,IAAI,QAAQ,EAAE;AAAA,IAClE;AACA,WAAO,WAAW;AAClB,WAAO,MAAM,sBAAsB,QAAQ,EAAE;AAAA,EAC9C;AAGA,QAAM,YAAY,QAAQ,IAAI,mBAAmB;AACjD,MAAI,WAAW;AACd,mBAAe,yBAAA;AAGf,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,8FAA8F;AAE3G,aAAO,QAAQ,KAAK;AAAA,IACrB;AAEA,UAAM,OAAO,MAAM,mBAAmB,WAAW,OAAO,QAAQ;AAChE,QAAI,MAAM;AAET,UAAI,OAAO,YAAY,KAAK,YAAY,KAAK,aAAa,OAAO,UAAU;AAC1E,eAAO,KAAK,oCAAoC,KAAK,GAAG,aAAa,KAAK,QAAQ,WAAW,OAAO,QAAQ,EAAE;AAC9G,uBAAe,sBAAA;AACf,gBAAQ,OAAO,qBAAqB,EAAE,MAAM,KAAK;AACjD,cAAM,MAAM,KAAK,2CAA2C;AAAA,MAC7D;AAGA,aAAO,OAAO;AACd,aAAO,aAAa;AACpB,aAAO,cAAc,KAAK,eAAe,CAAA;AACzC,aAAO,MAAM,uBAAuB,KAAK,GAAG,EAAE;AAI9C,UAAI;AACH,cAAM,sBAAsB,OAAO,MAAM,SAAS;AAAA,MACnD,SAAS,eAAe;AAGvB,YAAI,yBAAyB,SAAS,CAAC,cAAc,QAAQ,SAAS,iBAAiB,GAAG;AACzF,iBAAO,MAAM,gCAAgC,cAAc,OAAO,EAAE;AAAA,QACrE;AAAA,MACD;AAAA,IACD,OAAO;AAIN,qBAAe,sBAAA;AACf,cAAQ,OAAO,qBAAqB,EAAE,MAAM,KAAK;AACjD,aAAO,MAAM,4BAA4B,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK;AAAA,IACxE;AAAA,EACD;AAEA,SAAO,QAAQ,KAAK;AACrB;AAWO,SAAS,uBAAuB,WAAmB,UAAyB;AAClF,eAAa,OAAO,SAAS;AAC7B,aAAW,OAAO,SAAS;AAC3B,qBAAmB,OAAO,SAAS;AACnC,sBAAoB,OAAO,SAAS;AAEpC,QAAM,WAAW,WAAW,WAAW,QAAQ,IAAI,SAAS,KAAK,WAAW,SAAS;AACrF,eAAa,OAAO,UAAU,QAAQ,EAAE,MAAM,CAAC,QAAQ,OAAO,KAAK,wCAAwC,IAAI,OAAO,EAAE,CAAC;AAEzH,SAAO,MAAM,8BAA8B,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK;AAC1E;AAQO,SAAS,2BAA2B,WAAyB;AACnE,qBAAmB,OAAO,SAAS;AACpC;AAQO,SAAS,qBAAqB,WAAyB;AAC7D,sBAAoB,OAAO,SAAS;AACpC,SAAO,KAAK,wCAAwC,UAAU,UAAU,GAAG,CAAC,CAAC,KAAK;AACnF;AAOO,SAAS,wBAA8B;AAC7C,eAAa,MAAA;AACb,aAAW,MAAA;AACX,qBAAmB,MAAA;AACnB,sBAAoB,MAAA;AACpB,SAAO,KAAK,qEAAqE;AAClF;AAMO,SAAS,uBAAuB;AACtC,SAAO;AAAA,IACN,UAAU,aAAa;AAAA,IACvB,YAAY,WAAW;AAAA,IACvB,kBAAkB,mBAAmB;AAAA,IACrC,kBAAkB,oBAAoB;AAAA,IACtC,eAAe;AAAA,EAAA;AAEjB;ACnhBA,SAAS,cAAc,MAA0C;AAChE,MAAI,CAAC,KAAM,QAAO;AAClB,SAAQ,QAA8B,SAAS,IAAI;AACpD;AAUA,SAAS,kBAAkB,YAAoB,aAAiC,QAA0C;AACzH,MAAI,CAAC,YAAa,QAAO;AAEzB,MAAI,CAAC,cAAc,WAAW,GAAG;AAChC,WAAO,KAAK,WAAW,UAAU,mBAAmB,WAAW,yBAA8B,QAAQ,KAAK,IAAI,CAAC,EAAE;AACjH,WAAO;AAAA,EACR;AAEA,MAAI;AACH,WAAO,WAAW;AAClB,WAAO,MAAM,GAAG,UAAU,YAAY,WAAW,EAAE;AACnD,WAAO;AAAA,EACR,SAAS,KAAK;AACb,WAAO,MAAM,iBAAiB,UAAU,WAAW,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AACrG,WAAO;AAAA,EACR;AACD;AAIO,MAAM,eAAuB,OAAO,EAAE,OAAO,cAAc;AACjE,QAAM,EAAE,YAAY;AAGpB,MAAI,CAAC,KAAK;AACT,WAAO,KAAK,gEAAgE;AAC5E,WAAO,QAAQ,KAAK;AAAA,EACrB;AAGA,QAAM,mBAAmB,QAAQ,IAAI,gBAAgB;AACrD,QAAM,gBAAgB,kBAAkB,kBAAkB,kBAAkB,CAAC,UAAW,IAAI,iBAAiB,KAAM;AAGnH,MAAI,oBAAoB,CAAC,eAAe;AACvC,WAAO,MAAM,wCAAwC;AACrD,YAAQ,OAAO,kBAAkB,EAAE,MAAM,KAAK;AAAA,EAC/C;AAGA,QAAM,oBAAoB,QAAQ,IAAI,iBAAiB;AACvD,QAAM,iBAAiB,kBAAkB,mBAAmB,mBAAmB,CAAC,UAAW,IAAI,kBAAkB,KAAM;AAGvH,MAAI,qBAAqB,CAAC,gBAAgB;AACzC,WAAO,MAAM,yCAAyC;AACtD,YAAQ,OAAO,mBAAmB,EAAE,MAAM,KAAK;AAAA,EAChD;AAEA,SAAO,QAAQ,KAAK;AACrB;ACtFA,MAAM,eAAe,aAAa,YAAA;AAE3B,MAAM,cAAsB,OAAO,EAAE,OAAO,cAAc;AAEhE,QAAM,kBAAkB,MAAM,QAAQ,IAAI,OAAO;AAGjD,MAAI,aAAa;AAEjB,MAAI,oBAAoB,QAAQ;AAC/B,iBAAa;AAAA,EACd,WAAW,oBAAoB,SAAS;AACvC,iBAAa;AAAA,EACd,OAAO;AAIN,iBAAa;AAAA,EACd;AAGA,QAAM,OAAO,WAAW;AAGxB,MAAI,aAAa,iBAAiB;AACjC,QAAI;AACH,YAAM,eAAe,MAAM,aAAa,SAAS,MAAM,OAAO,QAAQ;AACtE,YAAM,OAAO,QAAQ;AACrB,YAAM,OAAO,YAAY,cAAc,aAAa;AAAA,IACrD,SAAS,KAAK;AAEb,YAAM,WAAW,eAAA;AACjB,UAAI,SAAS,iBAAiB,WAAW,SAAS,iBAAiB,YAAY;AAC9E,eAAO,MAAM,oDAAoD,GAAG;AAAA,MACrE,OAAO;AACN,eAAO,MAAM,8CAA8C;AAAA,MAC5D;AACA,YAAM,OAAO,QAAQ;AACrB,YAAM,OAAO,YAAY;AAAA,IAC1B;AAAA,EACD,OAAO;AAEN,UAAM,OAAO,QAAQ;AACrB,UAAM,OAAO,YAAY;AAAA,EAC1B;AAGA,SAAO,QAAQ,OAAO;AAAA,IACrB,oBAAoB,CAAC,EAAE,WAAW;AAEjC,YAAM,UAAU;AAIhB,UAAI,oBAAoB,QAAQ;AAC/B,eAAO,KAAK,QAAQ,SAAS,yCAAyC;AAAA,MACvE;AACA,aAAO;AAAA,IACR;AAAA,EAAA,CACA;AACF;ACnDO,MAAM,qBAA6B,OAAO,EAAE,OAAO,cAAc;AACvE,QAAM,WAAW,MAAM,QAAQ,KAAK;AAKpC,WAAS,QAAQ,IAAI,mBAAmB,YAAY;AACpD,WAAS,QAAQ,IAAI,0BAA0B,SAAS;AACxD,WAAS,QAAQ,IAAI,mBAAmB,iCAAiC;AACzE,WAAS,QAAQ;AAAA,IAChB;AAAA,IACA,CAAC,kBAAkB,iBAAiB,aAAa,sBAAsB,qBAAqB,0BAA0B,kBAAkB,EAAE;AAAA,MACzI;AAAA,IAAA;AAAA,EACD;AAID,MAAY,MAAM,IAAI,aAAa,UAAU;AAC5C,aAAS,QAAQ,IAAI,6BAA6B,8CAA8C;AAAA,EACjG;AAEA,SAAO;AACR;ACAA,MAAM,mBAAmB;AAAA;AAAA;AAAA;AAAA,EAIxB,MAAM,IAAI,KAA0C;AACnD,QAAI;AACH,YAAM,OAAO,MAAM,aAAa,IAAwC,aAAa,GAAG,EAAE;AAC1F,UAAI,QAAQ,KAAK,UAAU,KAAK,OAAO;AACtC,eAAO,KAAK;AAAA,MACb;AACA,aAAO;AAAA,IACR,SAAS,KAAK;AACb,aAAO,KAAK,4CAA4C,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AAC1G,aAAO;AAAA,IACR;AAAA,EACD;AAAA,EAEA,MAAM,IAAI,KAA+B;AACxC,WAAQ,MAAM,KAAK,IAAI,GAAG,MAAO;AAAA,EAClC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,IAAI,KAAa,YAAqC;AAC3D,QAAI;AACH,UAAI,MAAM,KAAK,IAAI,GAAG,GAAG;AACxB,eAAO,KAAK,UAAU,KAAK,UAAU;AAAA,MACtC;AACA,YAAM,UAAU,KAAK,IAAA,IAAQ,aAAa;AAC1C,YAAM,aAAa,IAAI,aAAa,GAAG,IAAI,EAAE,OAAO,GAAG,QAAA,GAAW,UAAU;AAC5E,aAAO;AAAA,IACR,SAAS,KAAK;AACb,aAAO,MAAM,4CAA4C,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AAC3G,aAAO;AAAA,IACR;AAAA,EACD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,UAAU,KAAa,YAAqC;AACjE,QAAI;AACH,YAAM,WAAW,MAAM,KAAK,IAAI,GAAG;AACnC,YAAM,YAAY,YAAY,KAAK;AACnC,YAAM,UAAU,KAAK,IAAA,IAAQ,aAAa;AAE1C,YAAM,aAAa,IAAI,aAAa,GAAG,IAAI,EAAE,OAAO,UAAU,QAAA,GAAW,UAAU;AACnF,cAAQ,IAAI,mBAAmB,GAAG,KAAK,QAAQ,EAAE;AACjD,aAAO;AAAA,IACR,SAAS,KAAK;AACb,aAAO,MAAM,kDAAkD,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AACjH,aAAO;AAAA,IACR;AAAA,EACD;AAAA,EACA,MAAM,QAAuB;AAC5B,QAAI;AACH,YAAM,aAAa,OAAO,aAAa;AAAA,IACxC,SAAS,KAAK;AACb,aAAO,MAAM,8CAA8C,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC,EAAE;AAAA,IAC9G;AAAA,EACD;AACD;AAGA,MAAM,iBAAiB,IAAI,YAAY;AAAA,EACtC,IAAI,CAAC,KAAK,GAAG;AAAA,EACb,MAAM,CAAC,KAAK,GAAG;AAAA,EACf,QAAQ;AAAA,IACP,MAAM;AAAA,IACN,QAAQ,sBAAsB,gBAAgB,KAAK;AAAA,IACnD,MAAM,CAAC,KAAK,GAAG;AAAA,IACf,WAAW;AAAA,EAAA;AAAA;AAAA,EAGZ,OAAO,eAAe,mBAAmB;AAC1C,CAAC;AAGD,MAAM,aAAa,IAAI,YAAY;AAAA,EAClC,IAAI,CAAC,KAAK,GAAG;AAAA,EACb,MAAM,CAAC,KAAK,GAAG;AAAA;AAAA,EAEf,OAAO,eAAe,mBAAmB;AAC1C,CAAC;AAGD,MAAM,cAAc,IAAI,YAAY;AAAA,EACnC,IAAI,CAAC,IAAI,GAAG;AAAA;AAAA,EACZ,MAAM,CAAC,GAAG,GAAG;AAAA;AAAA,EACb,OAAO,eAAe,mBAAmB;AAC1C,CAAC;AAKD,SAAS,YAAY,OAA6B;AACjD,MAAI;AACH,UAAM,UAAU,MAAM,iBAAA;AACtB,QAAI,QAAS,QAAO;AAAA,EACrB,QAAQ;AAAA,EAER;AAEA,QAAM,YAAY,MAAM,QAAQ,QAAQ,IAAI,iBAAiB;AAC7D,MAAI,kBAAkB,UAAU,MAAM,GAAG,EAAE,CAAC,EAAE,KAAA;AAE9C,QAAM,SAAS,MAAM,QAAQ,QAAQ,IAAI,WAAW;AACpD,MAAI,OAAQ,QAAO;AAEnB,SAAO;AACR;AAGA,SAAS,YAAY,IAAqB;AACzC,SAAO,OAAO,eAAe,OAAO,SAAS,OAAO;AACrD;AAMA,MAAM,oBAAoB;AAE1B,SAAS,cAAc,UAA2B;AACjD,SACC,SAAS,WAAW,UAAU,KAC9B,SAAS,WAAW,QAAQ,KAC5B,aAAa,kBACb,aAAa,iBACb,aAAa,kBACb,kBAAkB,KAAK,QAAQ;AAEjC;AAIO,MAAM,kBAA0B,OAAO,EAAE,OAAO,cAAc;AACpE,QAAM,EAAE,QAAQ;AAChB,QAAM,WAAW,YAAY,KAAK;AAKlC,MAAI,SAAU,QAAO,QAAQ,KAAK;AAIlC,QAAM,kBAAkB,MAAM,QAAQ,QAAQ,IAAI,oCAAoC,MAAM;AAE5F,MAAI,YAAY,QAAQ,KAAK,CAAC,iBAAiB;AAC9C,WAAO,QAAQ,KAAK;AAAA,EACrB;AAGA,MAAI,cAAc,IAAI,QAAQ,EAAG,QAAO,QAAQ,KAAK;AAGrD,MAAI,UAAU;AAEd,MAAI,IAAI,SAAS,WAAW,WAAW,GAAG;AACzC,cAAU;AAAA,EACX,WAAW,IAAI,SAAS,WAAW,OAAO,GAAG;AAC5C,cAAU;AAAA,EACX;AAEA,MAAI,MAAM,QAAQ,UAAU,KAAK,GAAG;AACnC,mBAAe,6BAAA;AAEf,WAAO;AAAA,MACN,+BAA+B,QAAQ,eACzB,IAAI,QAAQ,SAClB,MAAM,QAAQ,QAAQ,IAAI,YAAY,GAAG,UAAU,GAAG,EAAE,KAAK,SAAS;AAAA,IAAA;AAG/E,UAAM,MAAM,KAAK,0DAA0D;AAAA,EAC5E;AAEA,SAAO,QAAQ,KAAK;AACrB;ACvLA,MAAM,sBAAsB;AAAA;AAAA,EAE3B;AAAA;AAAA,EAGA;AAAA;AAAA,EAGA;AAAA;AAAA,EAGA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA;AAAA;AAAA,EAGA;AACD;AAMA,MAAM,wBAAwB,CAAC,mBAAmB,cAAc,aAAa,cAAc,cAAc,eAAe,cAAc,WAAW;AAMjJ,MAAM,0BAA0B;AAAA,EAC/B;AAAA,EACA;AAAA,EACA;AAAA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACD;AASA,SAAS,gBAAgB,WAA4B;AACpD,QAAM,cAAc,sBAAsB,uBAAuB,KAAK,CAAA;AACtE,QAAM,WAAW,CAAC,GAAG,yBAAyB,GAAG,YAAY,IAAI,CAAC,MAAM,IAAI,OAAO,GAAG,GAAG,CAAC,CAAC;AAC3F,SAAO,SAAS,KAAK,CAAC,YAAY,QAAQ,KAAK,SAAS,CAAC;AAC1D;AAOA,SAAS,cAAc,WAA4B;AAClD,QAAM,cAAc,sBAAsB,uBAAuB,KAAK,CAAA;AACtE,QAAM,WAAW,CAAC,GAAG,uBAAuB,GAAG,YAAY,IAAI,CAAC,MAAM,IAAI,OAAO,GAAG,GAAG,CAAC,CAAC;AACzF,SAAO,SAAS,KAAK,CAAC,YAAY,QAAQ,KAAK,SAAS,CAAC;AAC1D;AAQA,SAAS,qBAAqB,UAAkB,QAAyB;AACxE,QAAM,WAAW,WAAW;AAC5B,SAAO,oBAAoB,KAAK,CAAC,YAAY,QAAQ,KAAK,QAAQ,CAAC;AACpE;AAOA,SAAS,qBAAqB,UAA2B;AAExD,QAAM,YAAY,SAAS,MAAM,GAAG,EAAE,OAAO,OAAO,EAAE;AACtD,MAAI,YAAY,IAAI;AACnB,WAAO;AAAA,EACR;AAGA,MAAI,SAAS,SAAS,MAAM,KAAK,SAAS,SAAS,KAAK,GAAG;AAC1D,WAAO;AAAA,EACR;AAGA,MAAI,SAAS,SAAS,QAAQ,KAAK,SAAS,SAAS,OAAO,GAAG;AAC9D,WAAO;AAAA,EACR;AAEA,SAAO;AACR;AAIO,MAAM,iBAAyB,OAAO,EAAE,OAAO,cAAc;AACnE,QAAM,EAAE,SAAS,IAAA,IAAQ;AACzB,QAAM,YAAY,QAAQ,QAAQ,IAAI,YAAY,KAAK;AACvD,QAAM,WAAW,IAAI,SAAS,YAAA;AAC9B,QAAM,SAAS,IAAI,OAAO,YAAA;AAG1B,QAAM,kBAAkB,sBAAsB,kBAAkB,KAAK;AACrE,MAAI,CAAC,gBAAiB,QAAO,QAAQ,KAAK;AAI1C,MAAI,cAAc,SAAS,KAAK,CAAC,gBAAgB,SAAS,GAAG;AAC5D,mBAAe,4BAAA;AACf,WAAO,KAAK,yCAAyC,UAAU,UAAU,GAAG,EAAE,CAAC,UAAU,QAAQ,EAAE;AACnG,UAAM,MAAM,KAAK,sCAAsC;AAAA,EACxD;AAIA,MAAI,qBAAqB,UAAU,MAAM,GAAG;AAC3C,mBAAe,4BAAA;AACf,WAAO,KAAK,mCAAmC,MAAM,iBAAA,CAAkB,UAAe,QAAQ,QAAa,UAAU,UAAU,GAAG,EAAE,CAAC,EAAE;AACvI,UAAM,MAAM,KAAK,wCAAwC;AAAA,EAC1D;AAIA,MAAI,qBAAqB,QAAQ,GAAG;AACnC,mBAAe,4BAAA;AACf,WAAO,KAAK,mCAAmC,MAAM,kBAAkB,UAAU,QAAQ,EAAE;AAC3F,UAAM,MAAM,KAAK,oCAAoC;AAAA,EACtD;AAGA,SAAO,QAAQ,KAAK;AACrB;"}