{"version":3,"file":"widgetStore.svelte.js","sources":["../../../../../../shared/stores/src/widgetStore.svelte.ts"],"sourcesContent":["/**\n * @file src/stores/widgetStore.svelte.ts\n * @description Centralized widget state management using Svelte 5 runes.\n *\n * This store handles:\n * - Scanning and loading both core and custom widgets.\n * - Initializing widgets with tenant-specific and database-driven status.\n * - Providing a unified registry for widget functions.\n * - Tracking active widgets and their dependencies.\n */\n\nimport { logger } from '@shared/utils/logger';\nimport type { DatabaseAdapter } from '@shared/database/dbInterface';\nimport type { WidgetFactory, WidgetDefinition, FieldInstance } from '@cms-types';\nimport { coreModules, customModules } from '@widgets/scanner';\n\nexport type WidgetStatus = 'active' | 'inactive';\n\n/**\n * Registry for all available widget functions\n */\nexport type WidgetRegistry = Record<string, WidgetFactory | WidgetDefinition>;\n\nclass WidgetState {\n\twidgets = $state<Record<string, FieldInstance>>({});\n\twidgetFunctions = $state<WidgetRegistry>({});\n\tcoreWidgets = $state<string[]>([]);\n\tcustomWidgets = $state<string[]>([]);\n\tmarketplaceWidgets = $state<string[]>([]);\n\tactiveWidgets = $state<string[]>([]);\n\tdependencyMap = $state<Record<string, string[]>>({});\n\n\ttenantId = $state<string>('default');\n\tisLoaded = $state(false);\n\tloading = $state(false);\n\thealthStatus = $state<'healthy' | 'unhealthy' | 'initializing'>('initializing');\n\tlastHealthCheck = $state<number | undefined>(undefined);\n\n\tconstructor() {\n\t\t// Initialize empty state\n\t}\n\n\tasync initialize(tenantId = 'default', dbAdapter?: DatabaseAdapter | null) {\n\t\tif (this.loading) {\n\t\t\tlogger.debug('[WidgetStore] Initialization already in progress, skipping.');\n\t\t\treturn;\n\t\t}\n\t\tif (this.isLoaded && this.tenantId === tenantId && !dbAdapter) {\n\t\t\tlogger.debug('[WidgetStore] Widgets already loaded, skipping initialization.');\n\t\t\treturn;\n\t\t}\n\n\t\tthis.loading = true;\n\t\tthis.tenantId = tenantId;\n\t\tlogger.info(`[WidgetStore] Initializing for tenant: ${tenantId}`);\n\n\t\ttry {\n\t\t\t// 1. Load modules from scanner\n\t\t\tconst newWidgetFunctions: WidgetRegistry = {};\n\t\t\tconst newCoreWidgets: string[] = [];\n\t\t\tconst newCustomWidgets: string[] = [];\n\t\t\tconst newDependencyMap: Record<string, string[]> = {};\n\n\t\t\t// Process core widgets\n\t\t\tfor (const [path, module] of Object.entries(coreModules)) {\n\t\t\t\tconst name = path.split('/').at(-2);\n\t\t\t\tif (!name || typeof (module as any).default !== 'function') continue;\n\n\t\t\t\tconst fn = (module as any).default as WidgetFactory;\n\t\t\t\tconst widgetName = fn.Name || name;\n\t\t\t\tfn.Name = widgetName;\n\t\t\t\t(fn as any).__widgetType = 'core';\n\n\t\t\t\tnewWidgetFunctions[widgetName] = fn;\n\t\t\t\tnewCoreWidgets.push(widgetName);\n\n\t\t\t\tif ((fn as any).__dependencies && (fn as any).__dependencies.length > 0) {\n\t\t\t\t\tnewDependencyMap[widgetName] = (fn as any).__dependencies;\n\t\t\t\t}\n\n\t\t\t\tif (name && name !== widgetName) {\n\t\t\t\t\tnewWidgetFunctions[name] = fn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Process custom widgets\n\t\t\tfor (const [path, module] of Object.entries(customModules)) {\n\t\t\t\tconst name = path.split('/').at(-2);\n\t\t\t\tif (!name || typeof (module as any).default !== 'function') continue;\n\n\t\t\t\tconst fn = (module as any).default as WidgetFactory;\n\t\t\t\tconst widgetName = fn.Name || name;\n\t\t\t\tfn.Name = widgetName;\n\t\t\t\t(fn as any).__widgetType = 'custom';\n\n\t\t\t\tnewWidgetFunctions[widgetName] = fn;\n\t\t\t\tnewCustomWidgets.push(widgetName);\n\n\t\t\t\tif ((fn as any).__dependencies && (fn as any).__dependencies.length > 0) {\n\t\t\t\t\tnewDependencyMap[widgetName] = (fn as any).__dependencies;\n\t\t\t\t}\n\n\t\t\t\tif (name && name !== widgetName) {\n\t\t\t\t\tnewWidgetFunctions[name] = fn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.widgetFunctions = newWidgetFunctions;\n\t\t\tthis.coreWidgets = newCoreWidgets;\n\t\t\tthis.customWidgets = newCustomWidgets;\n\t\t\tthis.dependencyMap = newDependencyMap;\n\n\t\t\t// 2. Load active status from DB if available\n\t\t\tlet activeWidgetNames: string[] = [];\n\t\t\tif (dbAdapter) {\n\t\t\t\tconst activeRes = await dbAdapter.widgets.getActiveWidgets();\n\t\t\t\tif (activeRes.success) {\n\t\t\t\t\tactiveWidgetNames = (activeRes.data ?? []).map((w) => w.name);\n\t\t\t\t}\n\t\t\t} else if (typeof window !== 'undefined') {\n\t\t\t\t// Fallback to API if adapter not passed (client-side)\n\t\t\t\tconst res = await fetch(`/api/widgets/active${!this.isLoaded ? '?refresh=true' : ''}`, {\n\t\t\t\t\theaders: { 'X-Tenant-ID': tenantId }\n\t\t\t\t});\n\t\t\t\tif (res.ok) {\n\t\t\t\t\tconst data = await res.json();\n\t\t\t\t\tactiveWidgetNames = (data.widgets || []).map((w: any) => w.name);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Normalize and merge core\n\t\t\tconst normalizedActive = activeWidgetNames\n\t\t\t\t.map((name) => {\n\t\t\t\t\tif (this.widgetFunctions[name]) return name;\n\t\t\t\t\tconst camelCase = name.charAt(0).toLowerCase() + name.slice(1);\n\t\t\t\t\tif (this.widgetFunctions[camelCase]) return camelCase;\n\t\t\t\t\tconst lowerCase = name.toLowerCase();\n\t\t\t\t\tif (this.widgetFunctions[lowerCase]) return lowerCase;\n\t\t\t\t\treturn name;\n\t\t\t\t})\n\t\t\t\t.filter((name) => this.widgetFunctions[name]);\n\n\t\t\tconst uniqueActive = [...new Set([...normalizedActive, ...newCoreWidgets])];\n\t\t\tthis.activeWidgets = uniqueActive;\n\n\t\t\t// Create instances\n\t\t\tconst newWidgets: Record<string, any> = {};\n\t\t\tfor (const [name, fn] of Object.entries(this.widgetFunctions)) {\n\t\t\t\tnewWidgets[name] = (fn as any)({} as any);\n\t\t\t}\n\t\t\tthis.widgets = newWidgets;\n\n\t\t\tthis.isLoaded = true;\n\t\t\tthis.loading = false;\n\t\t\tthis.healthStatus = 'healthy';\n\t\t\tthis.lastHealthCheck = Date.now();\n\n\t\t\tlogger.info(`[WidgetStore] Initialized: ${this.coreWidgets.length} core, ${this.customWidgets.length} custom widgets.`);\n\t\t} catch (e) {\n\t\t\tthis.loading = false;\n\t\t\tthis.healthStatus = 'unhealthy';\n\t\t\tlogger.error('[WidgetStore] Initialization failed:', e);\n\t\t}\n\t}\n\n\tasync updateStatus(name: string, status: WidgetStatus, tenantId?: string) {\n\t\tconst targetTenant = tenantId || this.tenantId;\n\t\tconst active = status === 'active';\n\n\t\tif (active && isWidgetCore(name)) return; // Core always active\n\n\t\tif (!active && !canDisableWidget(name)) {\n\t\t\tthrow new Error(`Cannot disable widget ${name}: other widgets depend on it`);\n\t\t}\n\n\t\tif (active) {\n\t\t\tconst deps = getWidgetDependencies(name);\n\t\t\tconst inactiveDeps = deps.filter((dep) => !isWidgetActive(dep));\n\t\t\tif (inactiveDeps.length > 0) {\n\t\t\t\tthrow new Error(`Cannot activate widget ${name}: missing dependencies: ${inactiveDeps.join(', ')}`);\n\t\t\t}\n\t\t}\n\n\t\t// Update DB\n\t\ttry {\n\t\t\tawait this.updateInDatabase(name, active, targetTenant);\n\n\t\t\t// Update state\n\t\t\tif (active) {\n\t\t\t\tif (!this.activeWidgets.includes(name)) {\n\t\t\t\t\tthis.activeWidgets.push(name);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.activeWidgets = this.activeWidgets.filter((w) => w !== name);\n\t\t\t}\n\n\t\t\tlogger.info(`[WidgetStore] Widget '${name}' status changed to '${status}'`);\n\t\t} catch (e) {\n\t\t\tlogger.error(`[WidgetStore] Failed to update status for ${name}:`, e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tasync updateConfig(name: string, config: Record<string, any>) {\n\t\tconst currentFn = this.widgetFunctions[name];\n\t\tif (!currentFn || typeof currentFn !== 'function') return;\n\n\t\tconst updatedFn = Object.assign((cfg: any) => currentFn({ ...config, ...cfg }), currentFn);\n\n\t\tthis.widgetFunctions[name] = updatedFn;\n\t\tthis.widgets[name] = updatedFn({} as any);\n\t}\n\n\tasync reload(tenantId?: string) {\n\t\tthis.isLoaded = false;\n\t\tawait this.initialize(tenantId || this.tenantId);\n\t}\n\n\tprivate async updateInDatabase(name: string, active: boolean, tenantId: string) {\n\t\tif (typeof window !== 'undefined') {\n\t\t\tconst res = await fetch('/api/widgets/status', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/json', 'X-Tenant-ID': tenantId },\n\t\t\t\tbody: JSON.stringify({ widgetName: name, isActive: active })\n\t\t\t});\n\t\t\tif (!res.ok) throw new Error('Database sync failed');\n\t\t}\n\t}\n}\n\nexport const widgets = new WidgetState();\n\n// --- Helper Functions ---\n\nexport function getWidget(name: string) {\n\treturn widgets.widgets[name];\n}\n\nexport function getWidgetFunction(name: string) {\n\treturn widgets.widgetFunctions[name];\n}\n\nexport function isWidgetActive(name: string): boolean {\n\treturn widgets.activeWidgets.includes(name);\n}\n\nexport function isWidgetCore(name: string): boolean {\n\treturn widgets.coreWidgets.includes(name);\n}\n\nexport function isWidgetCustom(name: string): boolean {\n\treturn widgets.customWidgets.includes(name);\n}\n\nexport function isWidgetMarketplace(name: string): boolean {\n\treturn widgets.marketplaceWidgets.includes(name);\n}\n\nexport function getWidgetDependencies(name: string): string[] {\n\treturn widgets.dependencyMap[name] || [];\n}\n\nexport function canDisableWidget(name: string): boolean {\n\tif (isWidgetCore(name)) return false;\n\tconst dependents = Object.entries(widgets.dependencyMap)\n\t\t.filter(([, deps]) => deps.includes(name))\n\t\t.map(([n]) => n);\n\treturn !dependents.some(isWidgetActive);\n}\n\nexport function isWidgetAvailable(name: string): boolean {\n\treturn !!getWidgetFunction(name) && isWidgetActive(name);\n}\n\n// Compatibility export for theme branch components\nexport const widgetStoreActions = {\n\tupdateStatus: widgets.updateStatus.bind(widgets),\n\tupdateConfig: widgets.updateConfig.bind(widgets),\n\treload: widgets.reload.bind(widgets),\n\tinitializeWidgets: widgets.initialize.bind(widgets)\n};\n\n// Compatibility store for legacy components\nexport const widgetFunctions = {\n\tsubscribe(fn: (value: WidgetRegistry) => void) {\n\t\tfn(widgets.widgetFunctions);\n\t\treturn () => {}; // Non-reactive for now, sufficient for initial load or use $effect if needed\n\t}\n};\n\n// HMR\nif (import.meta.hot) {\n\timport.meta.hot.accept(() => {\n\t\twidgets.reload();\n\t});\n}\n"],"names":[],"mappings":"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"}