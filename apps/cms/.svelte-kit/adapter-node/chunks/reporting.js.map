{"version":3,"file":"reporting.js","sources":["../../../../../../shared/stores/src/system/reporting.ts"],"sourcesContent":["/**\n * @file src/stores/system/reporting.ts\n * @description Reporting and analysis functions for system health and performance.\n */\n\nimport { getSystemState } from './state';\nimport { SERVICE_BASELINE_TIMES } from './config';\n\n/**\n * Export comprehensive system state for health check endpoint with performance data\n */\nexport function getHealthCheckReport() {\n\tconst state = getSystemState();\n\tconst now = Date.now();\n\n\treturn {\n\t\toverallStatus: state.overallState,\n\t\ttimestamp: now,\n\t\tuptime: state.initializationStartedAt ? now - state.initializationStartedAt : 0,\n\t\tinitializationTime:\n\t\t\tstate.initializationCompletedAt && state.initializationStartedAt ? state.initializationCompletedAt - state.initializationStartedAt : undefined,\n\t\tcomponents: Object.fromEntries(\n\t\t\tObject.entries(state.services).map(([name, service]) => [\n\t\t\t\tname,\n\t\t\t\t{\n\t\t\t\t\tstatus: service.status,\n\t\t\t\t\tmessage: service.message,\n\t\t\t\t\tlastChecked: service.lastChecked,\n\t\t\t\t\terror: service.error,\n\t\t\t\t\tperformance: {\n\t\t\t\t\t\tinitTime: service.metrics.initializationDuration,\n\t\t\t\t\t\tavgInitTime: service.metrics.averageInitTime,\n\t\t\t\t\t\tminInitTime: service.metrics.minInitTime,\n\t\t\t\t\t\tmaxInitTime: service.metrics.maxInitTime,\n\t\t\t\t\t\thealthChecks: service.metrics.healthCheckCount,\n\t\t\t\t\t\tfailures: service.metrics.failureCount,\n\t\t\t\t\t\tconsecutiveFailures: service.metrics.consecutiveFailures,\n\t\t\t\t\t\trestarts: service.metrics.restartCount,\n\t\t\t\t\t\tuptimePercentage: service.metrics.uptimePercentage.toFixed(2) + '%',\n\t\t\t\t\t\treliability:\n\t\t\t\t\t\t\tservice.metrics.healthCheckCount > 0\n\t\t\t\t\t\t\t\t? (((service.metrics.healthCheckCount - service.metrics.failureCount) / service.metrics.healthCheckCount) * 100).toFixed(1) + '%'\n\t\t\t\t\t\t\t\t: 'N/A',\n\t\t\t\t\t\tstateTimings: {\n\t\t\t\t\t\t\tstartup: {\n\t\t\t\t\t\t\t\tcount: service.metrics.stateTimings.startup.count,\n\t\t\t\t\t\t\t\tavgTime: service.metrics.stateTimings.startup.avgTime,\n\t\t\t\t\t\t\t\tminTime: service.metrics.stateTimings.startup.minTime,\n\t\t\t\t\t\t\t\tmaxTime: service.metrics.stateTimings.startup.maxTime,\n\t\t\t\t\t\t\t\tlastTime: service.metrics.stateTimings.startup.lastTime,\n\t\t\t\t\t\t\t\ttrend: service.metrics.stateTimings.startup.trend\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tshutdown: {\n\t\t\t\t\t\t\t\tcount: service.metrics.stateTimings.shutdown.count,\n\t\t\t\t\t\t\t\tavgTime: service.metrics.stateTimings.shutdown.avgTime,\n\t\t\t\t\t\t\t\ttrend: service.metrics.stateTimings.shutdown.trend\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tidle: {\n\t\t\t\t\t\t\t\tcount: service.metrics.stateTimings.idle.count,\n\t\t\t\t\t\t\t\ttotalTime: service.metrics.stateTimings.idle.totalTime\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tactive: {\n\t\t\t\t\t\t\t\tcount: service.metrics.stateTimings.active.count,\n\t\t\t\t\t\t\t\ttotalTime: service.metrics.stateTimings.active.totalTime\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tthresholds: {\n\t\t\t\t\t\t\tmaxStartupTime: service.metrics.anomalyThresholds.maxStartupTime,\n\t\t\t\t\t\t\tmaxShutdownTime: service.metrics.anomalyThresholds.maxShutdownTime,\n\t\t\t\t\t\t\tcalibrationCount: service.metrics.anomalyThresholds.calibrationCount\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t])\n\t\t),\n\t\tsystemPerformance: {\n\t\t\ttotalInits: state.performanceMetrics.totalInitializations,\n\t\t\tsuccessfulInits: state.performanceMetrics.successfulInitializations,\n\t\t\tfailedInits: state.performanceMetrics.failedInitializations,\n\t\t\tsuccessRate:\n\t\t\t\tstate.performanceMetrics.totalInitializations > 0\n\t\t\t\t\t? ((state.performanceMetrics.successfulInitializations / state.performanceMetrics.totalInitializations) * 100).toFixed(1) + '%'\n\t\t\t\t\t: 'N/A',\n\t\t\tavgInitTime: state.performanceMetrics.averageTotalInitTime,\n\t\t\tminInitTime: state.performanceMetrics.minTotalInitTime,\n\t\t\tmaxInitTime: state.performanceMetrics.maxTotalInitTime,\n\t\t\tlastInitTime: state.performanceMetrics.lastInitDuration\n\t\t}\n\t};\n}\n\n/**\n * Get performance summary for analysis and optimization\n */\nexport function getPerformanceSummary() {\n\tconst state = getSystemState();\n\n\treturn {\n\t\tservices: Object.entries(state.services).map(([name, service]) => ({\n\t\t\tname,\n\t\t\tavgInitTime: service.metrics.averageInitTime,\n\t\t\tminInitTime: service.metrics.minInitTime,\n\t\t\tmaxInitTime: service.metrics.maxInitTime,\n\t\t\tvariance: service.metrics.maxInitTime && service.metrics.minInitTime ? service.metrics.maxInitTime - service.metrics.minInitTime : 0,\n\t\t\treliability:\n\t\t\t\tservice.metrics.healthCheckCount > 0\n\t\t\t\t\t? (service.metrics.healthCheckCount - service.metrics.failureCount) / service.metrics.healthCheckCount\n\t\t\t\t\t: 1,\n\t\t\tfailures: service.metrics.failureCount,\n\t\t\tconsecutiveFailures: service.metrics.consecutiveFailures,\n\t\t\trestarts: service.metrics.restartCount,\n\t\t\tuptimePercentage: service.metrics.uptimePercentage,\n\t\t\tstateTimings: service.metrics.stateTimings,\n\t\t\tanomalyThresholds: service.metrics.anomalyThresholds\n\t\t})),\n\t\tsystem: {\n\t\t\ttotalInitTime: state.performanceMetrics.averageTotalInitTime,\n\t\t\tsuccessRate:\n\t\t\t\tstate.performanceMetrics.totalInitializations > 0\n\t\t\t\t\t? state.performanceMetrics.successfulInitializations / state.performanceMetrics.totalInitializations\n\t\t\t\t\t: 1,\n\t\t\trecentTransitions: state.performanceMetrics.stateTransitions.slice(-10)\n\t\t}\n\t};\n}\n\n/**\n * Identify performance bottlenecks\n */\nexport function identifyBottlenecks() {\n\tconst state = getSystemState();\n\tconst bottlenecks: Array<{\n\t\tservice: string;\n\t\tissue: string;\n\t\tseverity: 'low' | 'medium' | 'high';\n\t\tdetails: string;\n\t}> = [];\n\n\tObject.entries(state.services).forEach(([name, service]) => {\n\t\tconst baseline = SERVICE_BASELINE_TIMES[name as keyof typeof SERVICE_BASELINE_TIMES];\n\n\t\t// Check if service is taking too long\n\t\tif (service.metrics.averageInitTime && service.metrics.averageInitTime > baseline * 2) {\n\t\t\tbottlenecks.push({\n\t\t\t\tservice: name,\n\t\t\t\tissue: 'Slow initialization',\n\t\t\t\tseverity: service.metrics.averageInitTime > baseline * 4 ? 'high' : 'medium',\n\t\t\t\tdetails: `Average: ${service.metrics.averageInitTime.toFixed(0)}ms, Expected: ~${baseline}ms`\n\t\t\t});\n\t\t}\n\n\t\t// Check for high variance (inconsistent performance)\n\t\tif (service.metrics.minInitTime && service.metrics.maxInitTime) {\n\t\t\tconst variance = service.metrics.maxInitTime - service.metrics.minInitTime;\n\t\t\tif (variance > baseline * 3) {\n\t\t\t\tbottlenecks.push({\n\t\t\t\t\tservice: name,\n\t\t\t\t\tissue: 'Inconsistent performance',\n\t\t\t\t\tseverity: 'medium',\n\t\t\t\t\tdetails: `Variance: ${variance.toFixed(0)}ms (${service.metrics.minInitTime.toFixed(0)}-${service.metrics.maxInitTime.toFixed(0)}ms)`\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Check for frequent failures\n\t\tif (service.metrics.failureCount > 2) {\n\t\t\tbottlenecks.push({\n\t\t\t\tservice: name,\n\t\t\t\tissue: 'Frequent failures',\n\t\t\t\tseverity: service.metrics.failureCount > 5 ? 'high' : 'low',\n\t\t\t\tdetails: `${service.metrics.failureCount} failures out of ${service.metrics.healthCheckCount} checks`\n\t\t\t});\n\t\t}\n\n\t\t// Check for frequent restarts\n\t\tif (service.metrics.restartCount > 3) {\n\t\t\tbottlenecks.push({\n\t\t\t\tservice: name,\n\t\t\t\tissue: 'Frequent restarts',\n\t\t\t\tseverity: 'medium',\n\t\t\t\tdetails: `Restarted ${service.metrics.restartCount} times`\n\t\t\t});\n\t\t}\n\t});\n\n\treturn bottlenecks.sort((a, b) => {\n\t\tconst severityWeight = { high: 3, medium: 2, low: 1 };\n\t\treturn severityWeight[b.severity] - severityWeight[a.severity];\n\t});\n}\n\n/**\n * Get recommended timeout values based on performance history\n */\nexport function getRecommendedTimeouts() {\n\tconst state = getSystemState();\n\n\treturn Object.fromEntries(\n\t\tObject.entries(state.services).map(([name, service]) => {\n\t\t\tconst baseline = SERVICE_BASELINE_TIMES[name as keyof typeof SERVICE_BASELINE_TIMES];\n\t\t\tconst recommended = service.metrics.averageInitTime ? Math.ceil(service.metrics.averageInitTime * 3) : baseline * 3;\n\n\t\t\treturn [\n\t\t\t\tname,\n\t\t\t\t{\n\t\t\t\t\trecommended,\n\t\t\t\t\tbaseline,\n\t\t\t\t\tcurrent: service.metrics.averageInitTime || baseline,\n\t\t\t\t\tconfidence: service.metrics.healthCheckCount > 5 ? 'high' : service.metrics.healthCheckCount > 2 ? 'medium' : 'low'\n\t\t\t\t}\n\t\t\t];\n\t\t})\n\t);\n}\n"],"names":[],"mappings":";AAWO,SAAS,uBAAuB;AACtC,QAAM,QAAQ,eAAA;AACd,QAAM,MAAM,KAAK,IAAA;AAEjB,SAAO;AAAA,IACN,eAAe,MAAM;AAAA,IACrB,WAAW;AAAA,IACX,QAAQ,MAAM,0BAA0B,MAAM,MAAM,0BAA0B;AAAA,IAC9E,oBACC,MAAM,6BAA6B,MAAM,0BAA0B,MAAM,4BAA4B,MAAM,0BAA0B;AAAA,IACtI,YAAY,OAAO;AAAA,MAClB,OAAO,QAAQ,MAAM,QAAQ,EAAE,IAAI,CAAC,CAAC,MAAM,OAAO,MAAM;AAAA,QACvD;AAAA,QACA;AAAA,UACC,QAAQ,QAAQ;AAAA,UAChB,SAAS,QAAQ;AAAA,UACjB,aAAa,QAAQ;AAAA,UACrB,OAAO,QAAQ;AAAA,UACf,aAAa;AAAA,YACZ,UAAU,QAAQ,QAAQ;AAAA,YAC1B,aAAa,QAAQ,QAAQ;AAAA,YAC7B,aAAa,QAAQ,QAAQ;AAAA,YAC7B,aAAa,QAAQ,QAAQ;AAAA,YAC7B,cAAc,QAAQ,QAAQ;AAAA,YAC9B,UAAU,QAAQ,QAAQ;AAAA,YAC1B,qBAAqB,QAAQ,QAAQ;AAAA,YACrC,UAAU,QAAQ,QAAQ;AAAA,YAC1B,kBAAkB,QAAQ,QAAQ,iBAAiB,QAAQ,CAAC,IAAI;AAAA,YAChE,aACC,QAAQ,QAAQ,mBAAmB,MAC7B,QAAQ,QAAQ,mBAAmB,QAAQ,QAAQ,gBAAgB,QAAQ,QAAQ,mBAAoB,KAAK,QAAQ,CAAC,IAAI,MAC5H;AAAA,YACJ,cAAc;AAAA,cACb,SAAS;AAAA,gBACR,OAAO,QAAQ,QAAQ,aAAa,QAAQ;AAAA,gBAC5C,SAAS,QAAQ,QAAQ,aAAa,QAAQ;AAAA,gBAC9C,SAAS,QAAQ,QAAQ,aAAa,QAAQ;AAAA,gBAC9C,SAAS,QAAQ,QAAQ,aAAa,QAAQ;AAAA,gBAC9C,UAAU,QAAQ,QAAQ,aAAa,QAAQ;AAAA,gBAC/C,OAAO,QAAQ,QAAQ,aAAa,QAAQ;AAAA,cAAA;AAAA,cAE7C,UAAU;AAAA,gBACT,OAAO,QAAQ,QAAQ,aAAa,SAAS;AAAA,gBAC7C,SAAS,QAAQ,QAAQ,aAAa,SAAS;AAAA,gBAC/C,OAAO,QAAQ,QAAQ,aAAa,SAAS;AAAA,cAAA;AAAA,cAE9C,MAAM;AAAA,gBACL,OAAO,QAAQ,QAAQ,aAAa,KAAK;AAAA,gBACzC,WAAW,QAAQ,QAAQ,aAAa,KAAK;AAAA,cAAA;AAAA,cAE9C,QAAQ;AAAA,gBACP,OAAO,QAAQ,QAAQ,aAAa,OAAO;AAAA,gBAC3C,WAAW,QAAQ,QAAQ,aAAa,OAAO;AAAA,cAAA;AAAA,YAChD;AAAA,YAED,YAAY;AAAA,cACX,gBAAgB,QAAQ,QAAQ,kBAAkB;AAAA,cAClD,iBAAiB,QAAQ,QAAQ,kBAAkB;AAAA,cACnD,kBAAkB,QAAQ,QAAQ,kBAAkB;AAAA,YAAA;AAAA,UACrD;AAAA,QACD;AAAA,MACD,CACA;AAAA,IAAA;AAAA,IAEF,mBAAmB;AAAA,MAClB,YAAY,MAAM,mBAAmB;AAAA,MACrC,iBAAiB,MAAM,mBAAmB;AAAA,MAC1C,aAAa,MAAM,mBAAmB;AAAA,MACtC,aACC,MAAM,mBAAmB,uBAAuB,KAC3C,MAAM,mBAAmB,4BAA4B,MAAM,mBAAmB,uBAAwB,KAAK,QAAQ,CAAC,IAAI,MAC1H;AAAA,MACJ,aAAa,MAAM,mBAAmB;AAAA,MACtC,aAAa,MAAM,mBAAmB;AAAA,MACtC,aAAa,MAAM,mBAAmB;AAAA,MACtC,cAAc,MAAM,mBAAmB;AAAA,IAAA;AAAA,EACxC;AAEF;AAKO,SAAS,wBAAwB;AACvC,QAAM,QAAQ,eAAA;AAEd,SAAO;AAAA,IACN,UAAU,OAAO,QAAQ,MAAM,QAAQ,EAAE,IAAI,CAAC,CAAC,MAAM,OAAO,OAAO;AAAA,MAClE;AAAA,MACA,aAAa,QAAQ,QAAQ;AAAA,MAC7B,aAAa,QAAQ,QAAQ;AAAA,MAC7B,aAAa,QAAQ,QAAQ;AAAA,MAC7B,UAAU,QAAQ,QAAQ,eAAe,QAAQ,QAAQ,cAAc,QAAQ,QAAQ,cAAc,QAAQ,QAAQ,cAAc;AAAA,MACnI,aACC,QAAQ,QAAQ,mBAAmB,KAC/B,QAAQ,QAAQ,mBAAmB,QAAQ,QAAQ,gBAAgB,QAAQ,QAAQ,mBACpF;AAAA,MACJ,UAAU,QAAQ,QAAQ;AAAA,MAC1B,qBAAqB,QAAQ,QAAQ;AAAA,MACrC,UAAU,QAAQ,QAAQ;AAAA,MAC1B,kBAAkB,QAAQ,QAAQ;AAAA,MAClC,cAAc,QAAQ,QAAQ;AAAA,MAC9B,mBAAmB,QAAQ,QAAQ;AAAA,IAAA,EAClC;AAAA,IACF,QAAQ;AAAA,MACP,eAAe,MAAM,mBAAmB;AAAA,MACxC,aACC,MAAM,mBAAmB,uBAAuB,IAC7C,MAAM,mBAAmB,4BAA4B,MAAM,mBAAmB,uBAC9E;AAAA,MACJ,mBAAmB,MAAM,mBAAmB,iBAAiB,MAAM,GAAG;AAAA,IAAA;AAAA,EACvE;AAEF;AAKO,SAAS,sBAAsB;AACrC,QAAM,QAAQ,eAAA;AACd,QAAM,cAKD,CAAA;AAEL,SAAO,QAAQ,MAAM,QAAQ,EAAE,QAAQ,CAAC,CAAC,MAAM,OAAO,MAAM;AAC3D,UAAM,WAAW,uBAAuB,IAA2C;AAGnF,QAAI,QAAQ,QAAQ,mBAAmB,QAAQ,QAAQ,kBAAkB,WAAW,GAAG;AACtF,kBAAY,KAAK;AAAA,QAChB,SAAS;AAAA,QACT,OAAO;AAAA,QACP,UAAU,QAAQ,QAAQ,kBAAkB,WAAW,IAAI,SAAS;AAAA,QACpE,SAAS,YAAY,QAAQ,QAAQ,gBAAgB,QAAQ,CAAC,CAAC,kBAAkB,QAAQ;AAAA,MAAA,CACzF;AAAA,IACF;AAGA,QAAI,QAAQ,QAAQ,eAAe,QAAQ,QAAQ,aAAa;AAC/D,YAAM,WAAW,QAAQ,QAAQ,cAAc,QAAQ,QAAQ;AAC/D,UAAI,WAAW,WAAW,GAAG;AAC5B,oBAAY,KAAK;AAAA,UAChB,SAAS;AAAA,UACT,OAAO;AAAA,UACP,UAAU;AAAA,UACV,SAAS,aAAa,SAAS,QAAQ,CAAC,CAAC,OAAO,QAAQ,QAAQ,YAAY,QAAQ,CAAC,CAAC,IAAI,QAAQ,QAAQ,YAAY,QAAQ,CAAC,CAAC;AAAA,QAAA,CAChI;AAAA,MACF;AAAA,IACD;AAGA,QAAI,QAAQ,QAAQ,eAAe,GAAG;AACrC,kBAAY,KAAK;AAAA,QAChB,SAAS;AAAA,QACT,OAAO;AAAA,QACP,UAAU,QAAQ,QAAQ,eAAe,IAAI,SAAS;AAAA,QACtD,SAAS,GAAG,QAAQ,QAAQ,YAAY,oBAAoB,QAAQ,QAAQ,gBAAgB;AAAA,MAAA,CAC5F;AAAA,IACF;AAGA,QAAI,QAAQ,QAAQ,eAAe,GAAG;AACrC,kBAAY,KAAK;AAAA,QAChB,SAAS;AAAA,QACT,OAAO;AAAA,QACP,UAAU;AAAA,QACV,SAAS,aAAa,QAAQ,QAAQ,YAAY;AAAA,MAAA,CAClD;AAAA,IACF;AAAA,EACD,CAAC;AAED,SAAO,YAAY,KAAK,CAAC,GAAG,MAAM;AACjC,UAAM,iBAAiB,EAAE,MAAM,GAAG,QAAQ,GAAG,KAAK,EAAA;AAClD,WAAO,eAAe,EAAE,QAAQ,IAAI,eAAe,EAAE,QAAQ;AAAA,EAC9D,CAAC;AACF;AAKO,SAAS,yBAAyB;AACxC,QAAM,QAAQ,eAAA;AAEd,SAAO,OAAO;AAAA,IACb,OAAO,QAAQ,MAAM,QAAQ,EAAE,IAAI,CAAC,CAAC,MAAM,OAAO,MAAM;AACvD,YAAM,WAAW,uBAAuB,IAA2C;AACnF,YAAM,cAAc,QAAQ,QAAQ,kBAAkB,KAAK,KAAK,QAAQ,QAAQ,kBAAkB,CAAC,IAAI,WAAW;AAElH,aAAO;AAAA,QACN;AAAA,QACA;AAAA,UACC;AAAA,UACA;AAAA,UACA,SAAS,QAAQ,QAAQ,mBAAmB;AAAA,UAC5C,YAAY,QAAQ,QAAQ,mBAAmB,IAAI,SAAS,QAAQ,QAAQ,mBAAmB,IAAI,WAAW;AAAA,QAAA;AAAA,MAC/G;AAAA,IAEF,CAAC;AAAA,EAAA;AAEH;"}