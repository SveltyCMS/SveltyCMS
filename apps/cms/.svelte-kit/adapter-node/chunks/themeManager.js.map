{"version":3,"file":"themeManager.js","sources":["../../../../../../shared/database/src/themeManager.ts"],"sourcesContent":["/**\n * @file src/databases/themeManager.ts\n * @description Theme manager for the CMS, utilizing a database-agnostic interface and now multi-tenant aware.\n *\n * ### Features\n * - Singleton pattern for global access\n * - Database-agnostic via IDBAdapter interface\n * - Caches themes in-memory for performance\n * - Supports multi-tenant theme management\n * - Fallback to default theme if database is unavailable\n */\nimport { error } from '@sveltejs/kit';\nimport type { DatabaseId } from '@cms-types/content';\nimport type { IDBAdapter, Theme } from './dbInterface';\nimport { dateToISODateString } from '@shared/utils/dateUtils';\n\n// System Logger\nimport { logger } from '@shared/utils/logger';\n\n/**\n * Fallback theme for when database is not available\n * This should match the theme that gets seeded during setup\n */\nexport const DEFAULT_THEME: Theme = {\n\t_id: '670e8b8c4d123456789abcde' as DatabaseId, // Matches the seeded theme ID\n\tpath: '', // Default path\n\tname: 'SveltyCMSTheme',\n\n\tisActive: false,\n\tisDefault: true,\n\tconfig: {\n\t\ttailwindConfigPath: '',\n\t\tassetsPath: ''\n\t},\n\tcreatedAt: dateToISODateString(new Date()),\n\tupdatedAt: dateToISODateString(new Date())\n};\n\nexport class ThemeManager {\n\tprivate static instance: ThemeManager;\n\tprivate themeCache: Map<string, Theme> = new Map(); // Single cache for all themes\n\tprivate db: IDBAdapter | null = null;\n\tprivate initialized: boolean = false;\n\n\tprivate constructor() {}\n\n\tpublic static getInstance(): ThemeManager {\n\t\tif (!ThemeManager.instance) {\n\t\t\tThemeManager.instance = new ThemeManager();\n\t\t}\n\t\treturn ThemeManager.instance;\n\t}\n\n\tpublic isInitialized(): boolean {\n\t\treturn this.initialized;\n\t}\n\n\tpublic async initialize(db: IDBAdapter): Promise<void> {\n\t\tif (this.initialized) {\n\t\t\tlogger.debug('ThemeManager already initialized, skipping.');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tthis.db = db;\n\n\t\t\t// Load and cache the default theme\n\t\t\tawait this.loadAndCacheDefaultTheme();\n\n\t\t\tthis.initialized = true;\n\t\t\t// Removed logger.info here - will be combined with timing in system init\n\t\t} catch (err) {\n\t\t\tconst message = `Error in ThemeManager.initialize: ${err instanceof Error ? err.message : String(err)}`;\n\t\t\tlogger.error(message);\n\t\t\tthrow error(500, message);\n\t\t}\n\t}\n\n\t/**\n\t * Load the default theme from database and cache it\n\t */\n\tprivate async loadAndCacheDefaultTheme(): Promise<void> {\n\t\tif (!this.db) throw new Error('Database adapter not initialized.');\n\n\t\ttry {\n\t\t\t// Single optimized database call - get all themes at once\n\t\t\tconst allThemes = await this.db.themes.getAllThemes();\n\n\t\t\tif (!Array.isArray(allThemes) || allThemes.length === 0) {\n\t\t\t\tlogger.warn('No themes found in database. Using DEFAULT_THEME fallback.');\n\t\t\t\tthis.themeCache.set('global', DEFAULT_THEME);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Find active theme, or default theme, or first theme\n\t\t\tconst defaultTheme = allThemes.find((t) => t.isActive) || allThemes.find((t) => t.isDefault) || allThemes[0];\n\n\t\t\t// Cache it as the global default\n\t\t\tthis.themeCache.set('global', defaultTheme);\n\t\t\tlogger.debug(`Default theme cached: ${defaultTheme.name}`);\n\t\t} catch (err) {\n\t\t\tlogger.error('Failed to load themes from database:', err);\n\t\t\t// Fallback to DEFAULT_THEME on error\n\t\t\tthis.themeCache.set('global', DEFAULT_THEME);\n\t\t}\n\t}\n\n\tpublic async getTheme(tenantId?: string): Promise<Theme> {\n\t\tif (!this.initialized || !this.db) {\n\t\t\tthrow new Error('ThemeManager is not initialized.');\n\t\t}\n\n\t\tconst cacheKey = tenantId || 'global';\n\n\t\t// Return from cache if available\n\t\tif (this.themeCache.has(cacheKey)) {\n\t\t\treturn this.themeCache.get(cacheKey)!;\n\t\t}\n\n\t\t// For tenant-specific themes, fetch from database\n\t\t// For now, fall back to global theme since tenant-specific themes\n\t\t// require additional schema implementation\n\t\tif (tenantId) {\n\t\t\tlogger.debug(`No tenant-specific theme for ${tenantId}, using global theme`);\n\t\t\tconst globalTheme = this.themeCache.get('global');\n\t\t\tif (globalTheme) {\n\t\t\t\treturn globalTheme;\n\t\t\t}\n\t\t}\n\n\t\t// Final fallback - should rarely reach here\n\t\tlogger.warn('No cached theme found, using DEFAULT_THEME fallback.');\n\t\treturn DEFAULT_THEME;\n\t}\n\n\tpublic async setTheme(theme: Theme, tenantId?: string): Promise<void> {\n\t\tif (!this.initialized || !this.db) {\n\t\t\tthrow new Error('ThemeManager is not initialized.');\n\t\t}\n\n\t\ttry {\n\t\t\t// Update database to set this theme as default\n\t\t\tconst setDefaultResult = await this.db.themes.setDefault(theme._id);\n\n\t\t\tif (!setDefaultResult.success) {\n\t\t\t\tthrow new Error(setDefaultResult.error?.message || 'Failed to set theme as default');\n\t\t\t}\n\n\t\t\t// Update cache\n\t\t\tconst cacheKey = tenantId || 'global';\n\t\t\tthis.themeCache.set(cacheKey, theme);\n\n\t\t\tlogger.info(`Theme updated to: ${theme.name}`, { tenantId: tenantId || 'global' });\n\t\t} catch (err) {\n\t\t\tconst message = `Error in ThemeManager.setTheme: ${err instanceof Error ? err.message : String(err)}`;\n\t\t\tlogger.error(message, { tenantId });\n\t\t\tthrow error(500, message);\n\t\t}\n\t}\n\n\t/**\n\t * Clear cache and reload themes from database\n\t */\n\tpublic async refresh(): Promise<void> {\n\t\tif (!this.initialized || !this.db) {\n\t\t\tthrow new Error('ThemeManager is not initialized.');\n\t\t}\n\n\t\tthis.themeCache.clear();\n\t\tawait this.loadAndCacheDefaultTheme();\n\t\tlogger.debug('ThemeManager cache refreshed.');\n\t}\n}\n"],"names":[],"mappings":"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"}