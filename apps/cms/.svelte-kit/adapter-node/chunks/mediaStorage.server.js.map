{"version":3,"file":"mediaStorage.server.js","sources":["../../../../../../shared/utils/src/media/cloudStorage.ts","../../../../../../shared/utils/src/media/mediaStorage.server.ts"],"sourcesContent":["/**\n * @file src/utils/media/cloudStorage.ts\n * @description Cloud storage abstraction layer for S3, R2, and Cloudinary\n *\n * Performace Enhancements:\n * - Singleton S3/Cloudinary clients (reuse connections)\n * - Keep-Alive agents for HTTP/HTTPS\n * - Unified interface exports\n */\n\nimport { getPublicSettingSync } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { error } from '@sveltejs/kit';\nimport type { StorageType } from './mediaModels';\n\n// Lazy-load clients to avoid init cost if unused\nlet s3Client: any = null;\nlet cloudinary: any = null;\n\n// Cloud storage configuration interface\nexport interface CloudStorageConfig {\n\tstorageType: StorageType;\n\tbucketName?: string;\n\tmediaFolder: string;\n\tregion?: string;\n\tendpoint?: string;\n\tpublicUrl?: string;\n\taccessKeyId?: string;\n\tsecretAccessKey?: string;\n\tcloudinaryCloudName?: string;\n}\n\n// Get cloud storage configuration from settings\nexport function getConfig(): CloudStorageConfig {\n\tconst storageType = getPublicSettingSync('MEDIA_STORAGE_TYPE') as StorageType;\n\tconst mediaFolder = getPublicSettingSync('MEDIA_FOLDER') || '';\n\tconst normalizedFolder = mediaFolder.replace(/^\\.\\//, '').replace(/^\\/+/, '').replace(/\\/+$/, '');\n\n\treturn {\n\t\tstorageType,\n\t\tbucketName: getPublicSettingSync('MEDIA_BUCKET_NAME') as string | undefined,\n\t\tmediaFolder: normalizedFolder,\n\t\tregion: getPublicSettingSync('MEDIA_CLOUD_REGION'),\n\t\tendpoint: getPublicSettingSync('MEDIA_CLOUD_ENDPOINT'),\n\t\tpublicUrl: getPublicSettingSync('MEDIA_CLOUD_PUBLIC_URL') || getPublicSettingSync('MEDIASERVER_URL'),\n\t\taccessKeyId: process.env.MEDIA_ACCESS_KEY_ID,\n\t\tsecretAccessKey: process.env.MEDIA_SECRET_ACCESS_KEY,\n\t\tcloudinaryCloudName: process.env.CLOUDINARY_CLOUD_NAME\n\t};\n}\n\nexport function isCloud(): boolean {\n\tconst type = getPublicSettingSync('MEDIA_STORAGE_TYPE');\n\treturn type === 's3' || type === 'r2' || type === 'cloudinary';\n}\n\n/** Get S3 Client Singleton with Keep-Alive */\nasync function getS3Client(config: CloudStorageConfig) {\n\tif (s3Client) return s3Client;\n\n\tconst { S3Client } = await import('@aws-sdk/client-s3');\n\tconst { NodeHttpHandler } = await import('@smithy/node-http-handler');\n\tconst { Agent: HttpsAgent } = await import('https');\n\tconst { Agent: HttpAgent } = await import('http');\n\n\tif (!config.accessKeyId || !config.secretAccessKey) {\n\t\tthrow error(500, 'S3/R2 credentials missing');\n\t}\n\n\ts3Client = new S3Client({\n\t\tregion: config.region || 'auto',\n\t\tendpoint: config.endpoint,\n\t\tcredentials: {\n\t\t\taccessKeyId: config.accessKeyId,\n\t\t\tsecretAccessKey: config.secretAccessKey\n\t\t},\n\t\trequestHandler: new NodeHttpHandler({\n\t\t\thttpsAgent: new HttpsAgent({\n\t\t\t\tkeepAlive: true,\n\t\t\t\ttimeout: 60_000,\n\t\t\t\tmaxSockets: 50\n\t\t\t}),\n\t\t\thttpAgent: new HttpAgent({\n\t\t\t\tkeepAlive: true,\n\t\t\t\ttimeout: 60_000,\n\t\t\t\tmaxSockets: 50\n\t\t\t})\n\t\t})\n\t});\n\n\treturn s3Client;\n}\n\n/** Get Cloudinary Singleton */\nasync function getCloudinary(config: CloudStorageConfig) {\n\tif (cloudinary) return cloudinary;\n\n\tconst lib = await import('cloudinary');\n\tcloudinary = lib.v2;\n\n\tcloudinary.config({\n\t\tcloud_name: config.cloudinaryCloudName,\n\t\tapi_key: process.env.CLOUDINARY_API_KEY,\n\t\tapi_secret: process.env.CLOUDINARY_API_SECRET,\n\t\tsecure: true\n\t});\n\n\treturn cloudinary;\n}\n\nexport function getPath(relativePath: string): string {\n\tconst config = getConfig();\n\tconst clean = relativePath.replace(/^\\/+/, '');\n\treturn config.mediaFolder ? `${config.mediaFolder}/${clean}` : clean;\n}\n\nexport function getUrl(relativePath: string): string {\n\tconst config = getConfig();\n\tif (config.storageType === 'local') return `/files/${relativePath.replace(/^\\/+/, '')}`;\n\n\tif (!config.publicUrl) {\n\t\t// Fallback for Cloudinary if needed, usually handles own URLs\n\t\tif (config.storageType === 'cloudinary') return ''; // Cloudinary returns URL on upload\n\t\tthrow error(500, 'Cloud public URL not configured');\n\t}\n\n\tconst fullPath = getPath(relativePath);\n\treturn `${config.publicUrl.replace(/\\/+$/, '')}/${fullPath}`;\n}\n\n/** Upload file */\nexport async function upload(buffer: Buffer, relativePath: string): Promise<string> {\n\tconst config = getConfig();\n\tconst fullPath = getPath(relativePath);\n\n\tlogger.debug('Cloud upload start', { type: config.storageType, path: fullPath });\n\n\tif (config.storageType === 's3' || config.storageType === 'r2') {\n\t\tconst client = await getS3Client(config);\n\t\tconst { PutObjectCommand } = await import('@aws-sdk/client-s3');\n\t\tconst mime = (await import('./mediaUtils')).getMimeType(relativePath) || 'application/octet-stream';\n\n\t\tawait client.send(\n\t\t\tnew PutObjectCommand({\n\t\t\t\tBucket: config.bucketName,\n\t\t\t\tKey: fullPath,\n\t\t\t\tBody: buffer,\n\t\t\t\tContentType: mime\n\t\t\t})\n\t\t);\n\t\treturn getUrl(relativePath);\n\t}\n\n\tif (config.storageType === 'cloudinary') {\n\t\tconst cld = await getCloudinary(config);\n\t\tconst publicId = relativePath.replace(/\\.[^.]+$/, ''); // Remove ext\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst stream = cld.uploader.upload_stream(\n\t\t\t\t{\n\t\t\t\t\tpublic_id: publicId,\n\t\t\t\t\tfolder: config.mediaFolder,\n\t\t\t\t\tresource_type: 'auto',\n\t\t\t\t\toverwrite: true\n\t\t\t\t},\n\t\t\t\t(err: any, res: any) => {\n\t\t\t\t\tif (err) return reject(err);\n\t\t\t\t\tresolve(res.secure_url);\n\t\t\t\t}\n\t\t\t);\n\t\t\tstream.end(buffer);\n\t\t});\n\t}\n\n\tthrow error(500, 'Invalid storage type for cloud upload');\n}\n\n/** Delete file */\nexport async function remove(relativePath: string): Promise<void> {\n\tconst config = getConfig();\n\tconst fullPath = getPath(relativePath);\n\n\tif (config.storageType === 's3' || config.storageType === 'r2') {\n\t\tconst client = await getS3Client(config);\n\t\tconst { DeleteObjectCommand } = await import('@aws-sdk/client-s3');\n\t\ttry {\n\t\t\tawait client.send(new DeleteObjectCommand({ Bucket: config.bucketName, Key: fullPath }));\n\t\t} catch (e) {\n\t\t\tlogger.warn('S3 delete failed', { error: e });\n\t\t}\n\t\treturn;\n\t}\n\n\tif (config.storageType === 'cloudinary') {\n\t\tconst cld = await getCloudinary(config);\n\t\tconst publicId = `${config.mediaFolder}/${relativePath.replace(/\\.[^.]+$/, '')}`;\n\t\tawait cld.uploader.destroy(publicId);\n\t\treturn;\n\t}\n}\n\n/** Check existence */\nexport async function exists(relativePath: string): Promise<boolean> {\n\tconst config = getConfig();\n\tconst fullPath = getPath(relativePath);\n\n\ttry {\n\t\tif (config.storageType === 's3' || config.storageType === 'r2') {\n\t\t\tconst client = await getS3Client(config);\n\t\t\tconst { HeadObjectCommand } = await import('@aws-sdk/client-s3');\n\t\t\tawait client.send(new HeadObjectCommand({ Bucket: config.bucketName, Key: fullPath }));\n\t\t\treturn true;\n\t\t}\n\n\t\tif (config.storageType === 'cloudinary') {\n\t\t\tconst cld = await getCloudinary(config);\n\t\t\tconst publicId = `${config.mediaFolder}/${relativePath.replace(/\\.[^.]+$/, '')}`;\n\t\t\tawait cld.api.resource(publicId);\n\t\t\treturn true;\n\t\t}\n\t} catch {\n\t\treturn false;\n\t}\n\treturn false;\n}\n","/**\n * @file src/utils/media/mediaStorage.server.ts\n * @description Core media storage (local + cloud) with resizing & avatar handling\n *\n * Features:\n * - Unified local/cloud save/delete\n * - Sharp-based resizing\n * - Avatar processing (200x200)\n * - Safe path handling\n * - No DB logic\n */\n\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\nimport path from 'path';\nimport mime from 'mime-types';\n\nimport { getPublicSettingSync } from '@shared/services/settingsService';\n\nimport { isCloud, upload, remove, getUrl, getConfig, exists } from './cloudStorage';\n\nimport type { ResizedImage } from './mediaModels';\n\n// Image sizes\n// Image sizes\nconst DEFAULT_SIZES = { sm: 600, md: 900, lg: 1200 } as const;\nconst SIZES = {\n\t...DEFAULT_SIZES,\n\t...(publicEnv.IMAGE_SIZES ?? {}),\n\toriginal: 0,\n\tthumbnail: 200\n};\n\n/** Get configured image sizes */\nexport function getImageSizes() {\n\treturn SIZES;\n}\n\nconst MEDIA_ROOT = getPublicSettingSync('MEDIA_FOLDER') ?? 'mediaFiles';\n\n/** Save buffer to storage (local or cloud) */\nexport async function saveFile(buffer: Buffer, relPath: string): Promise<string> {\n\tif (isCloud()) {\n\t\tawait upload(buffer, relPath);\n\t\treturn getUrl(relPath);\n\t}\n\n\t// Local\n\tconst fs = await import('fs/promises');\n\tconst full = path.join(process.cwd(), MEDIA_ROOT, relPath);\n\tawait fs.mkdir(path.dirname(full), { recursive: true });\n\tawait fs.writeFile(full, buffer);\n\n\treturn `/files/${relPath}`;\n}\n\n/** Delete file from storage */\nexport async function deleteFile(url: string): Promise<void> {\n\tlet rel = url;\n\n\tif (url.startsWith('http')) rel = new URL(url).pathname;\n\n\tif (isCloud()) {\n\t\t// Strip prefix if needed (cloud handles full key)\n\t\tconst cfg = getConfig();\n\t\tif (cfg && 'prefix' in cfg && typeof cfg.prefix === 'string' && rel.startsWith(`/${cfg.prefix}/`)) {\n\t\t\trel = rel.slice(cfg.prefix.length + 1);\n\t\t}\n\t\tawait remove(rel);\n\t\treturn;\n\t}\n\n\t// Local\n\tif (rel.startsWith('/files/')) rel = rel.slice(7);\n\trel = rel.replace(/^\\/+/, '');\n\n\tconst fs = await import('fs/promises');\n\tconst full = path.join(process.cwd(), MEDIA_ROOT, rel);\n\tawait fs.unlink(full).catch(() => {}); // best effort\n}\n\n/** Alias for backward compatibility */\nexport const moveMediaToTrash = deleteFile;\nexport const saveAvatarImage = saveAvatar;\nexport const saveFileToDisk = saveFile;\nexport const saveResizedImages = saveResized;\n\n/** Check if file exists */\nexport async function fileExists(rel: string): Promise<boolean> {\n\tif (isCloud()) {\n\t\treturn await exists(rel);\n\t}\n\tconst fs = await import('fs/promises');\n\tconst full = path.join(process.cwd(), MEDIA_ROOT, rel);\n\ttry {\n\t\tawait fs.access(full);\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/** Get file buffer */\nexport async function getFile(rel: string): Promise<Buffer> {\n\tif (isCloud()) {\n\t\tthrow new Error('getFile not implemented for cloud');\n\t}\n\tconst fs = await import('fs/promises');\n\tconst full = path.join(process.cwd(), MEDIA_ROOT, rel);\n\treturn await fs.readFile(full);\n}\n\n/** Resize & save image variants */\nexport async function saveResized(\n\tbuffer: Buffer,\n\thash: string,\n\tbaseName: string,\n\text: string,\n\tbaseDir: string\n): Promise<Record<string, ResizedImage>> {\n\tconst sharp = (await import('sharp')).default;\n\tconst meta = await sharp(buffer).metadata();\n\tconst result: Record<string, ResizedImage> = {};\n\n\tconst format = publicEnv.MEDIA_OUTPUT_FORMAT_QUALITY?.format ?? 'original';\n\tconst quality = publicEnv.MEDIA_OUTPUT_FORMAT_QUALITY?.quality ?? 80;\n\n\tfor (const [key, w] of Object.entries(SIZES)) {\n\t\tif (w === 0) continue; // skip original\n\n\t\tlet instance = sharp(buffer).resize(w, null, { fit: 'cover', position: 'center' });\n\n\t\tlet outExt = ext;\n\t\tlet mimeType = mime.lookup(ext) || 'application/octet-stream';\n\n\t\tif (format !== 'original') {\n\t\t\tinstance = instance.toFormat(format as 'webp' | 'avif', { quality });\n\t\t\toutExt = format;\n\t\t\tmimeType = `image/${format}`;\n\t\t}\n\n\t\tconst fileName = `${baseName}-${hash}.${outExt}`;\n\t\tconst relPath = path.posix.join(baseDir, key, fileName);\n\n\t\tconst resizedBuf = await instance.toBuffer();\n\t\tconst url = await saveFile(resizedBuf, relPath);\n\n\t\tconst height = meta.height ? Math.round((w / (meta.width ?? w)) * meta.height) : undefined;\n\n\t\tresult[key] = {\n\t\t\turl,\n\t\t\twidth: w,\n\t\t\theight: height ?? w,\n\t\t\tsize: resizedBuf ? (resizedBuf as any).length : 0,\n\t\t\tmimeType\n\t\t};\n\t}\n\n\treturn result;\n}\n\n/** Save avatar (200x200) */\nexport async function saveAvatar(file: File, userId: string): Promise<string> {\n\tconst buf = Buffer.from(await file.arrayBuffer());\n\tconst ext = path.extname(file.name) || '.jpg';\n\n\tconst sharp = (await import('sharp')).default;\n\tconst resized = await sharp(buf).resize(200, 200, { fit: 'cover', position: 'center' }).toBuffer();\n\n\tconst rel = `avatars/${userId}${ext}`;\n\treturn await saveFile(resized, rel);\n}\n"],"names":["mime"],"mappings":"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"}