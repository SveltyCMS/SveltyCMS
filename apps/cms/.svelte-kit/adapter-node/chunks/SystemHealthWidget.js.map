{"version":3,"file":"SystemHealthWidget.js","sources":["../../../../../../shared/features/src/dashboard/widgets/SystemHealthWidget.svelte"],"sourcesContent":["<!--\n@file src/routes/(app)/dashboard/widgets/SystemHealthWidget.svelte\n@component\n**Dashboard widget for monitoring system health and service status**\n\n@example\n<SystemHealthWidget label=\"System Health\" />\n\n### Props\n- `label`: The label for the widget (default: 'System Health')\n\n### Features:\n- Real-time system state monitoring (IDLE, INITIALIZING, READY, DEGRADED, FAILED)\n- Individual service health tracking (database, auth, cache, etc.)\n- Service restart capability for administrators\n- Auto-refresh with configurable interval\n- Theme-aware rendering (light/dark mode support)\n-->\n<script lang=\"ts\" module>\n\texport const widgetMeta = {\n\t\tname: 'System Health',\n\t\ticon: 'mdi:heart-pulse',\n\t\tdescription: 'Monitor system services and overall health',\n\t\tdefaultSize: { w: 2, h: 2 }\n\t};\n</script>\n\n<script lang=\"ts\">\n\timport BaseWidget from '../BaseWidget.svelte';\n\timport { showToast } from '@shared/utils/toast';\n\timport type { WidgetSize } from '@cms-types';\n\n\ttype SystemState = 'IDLE' | 'INITIALIZING' | 'READY' | 'DEGRADED' | 'FAILED';\n\ttype ServiceHealth = 'healthy' | 'unhealthy' | 'initializing';\n\n\tinterface ServiceStatus {\n\t\tstatus: ServiceHealth;\n\t\tmessage: string;\n\t\tlastChecked?: number;\n\t\terror?: string;\n\t}\n\n\tinterface HealthData {\n\t\toverallStatus: SystemState;\n\t\ttimestamp: number;\n\t\tuptime: number;\n\t\tcomponents: Record<string, ServiceStatus>;\n\t}\n\n\tconst {\n\t\tlabel = 'System Health',\n\t\ttheme = 'light' as 'light' | 'dark',\n\t\ticon = 'mdi:heart-pulse',\n\t\twidgetId = undefined,\n\t\tsize = { w: 2, h: 2 } as WidgetSize,\n\t\tonSizeChange = (_newSize: any) => {},\n\t\tonRemove = () => {}\n\t}: {\n\t\tlabel?: string;\n\t\ttheme?: 'light' | 'dark';\n\t\ticon?: string;\n\t\twidgetId?: string;\n\t\tsize?: WidgetSize;\n\t\tonSizeChange?: (newSize: WidgetSize) => void;\n\t\tonRemove?: () => void;\n\t} = $props();\n\n\tasync function reinitializeSystem() {\n\t\ttry {\n\t\t\tshowToast('Reinitializing system...', 'warning');\n\n\t\t\tconst response = await fetch('/api/system', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ action: 'reinitialize', force: true })\n\t\t\t});\n\n\t\t\tif (response.ok) {\n\t\t\t\tconst result = await response.json();\n\t\t\t\tshowToast(result.message || `System reinitialized: ${result.status}`, 'success');\n\t\t\t} else {\n\t\t\t\tconst error = await response.json();\n\t\t\t\tthrow new Error(error.error || 'Reinitialization failed');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tshowToast(`Failed to reinitialize: ${error instanceof Error ? error.message : 'Unknown error'}`, 'error');\n\t\t}\n\t}\n\tfunction getStateColor(state: SystemState): string {\n\t\tswitch (state) {\n\t\t\tcase 'READY':\n\t\t\t\treturn 'text-success-500';\n\t\t\tcase 'DEGRADED':\n\t\t\t\treturn 'text-warning-500';\n\t\t\tcase 'INITIALIZING':\n\t\t\t\treturn 'text-primary-500';\n\t\t\tcase 'FAILED':\n\t\t\t\treturn 'text-error-500';\n\t\t\tcase 'IDLE':\n\t\t\t\treturn 'text-surface-500';\n\t\t\tdefault:\n\t\t\t\treturn 'text-surface-500';\n\t\t}\n\t}\n\n\tfunction getStateIcon(state: SystemState): string {\n\t\tswitch (state) {\n\t\t\tcase 'READY':\n\t\t\t\treturn 'mdi:check-circle';\n\t\t\tcase 'DEGRADED':\n\t\t\t\treturn 'mdi:alert';\n\t\t\tcase 'INITIALIZING':\n\t\t\t\treturn 'mdi:loading';\n\t\t\tcase 'FAILED':\n\t\t\t\treturn 'mdi:close-circle';\n\t\t\tcase 'IDLE':\n\t\t\t\treturn 'mdi:pause-circle';\n\t\t\tdefault:\n\t\t\t\treturn 'mdi:help-circle';\n\t\t}\n\t}\n\n\tfunction getServiceBadgeClass(status: ServiceHealth): string {\n\t\tswitch (status) {\n\t\t\tcase 'healthy':\n\t\t\t\treturn 'preset-filled-primary-500';\n\t\t\tcase 'unhealthy':\n\t\t\t\treturn 'preset-filled-error-500';\n\t\t\tcase 'initializing':\n\t\t\t\treturn 'variant-filled-warning';\n\t\t\tdefault:\n\t\t\t\treturn 'preset-filled-surface-500';\n\t\t}\n\t}\n\n\tfunction formatUptime(ms: number): string {\n\t\tconst seconds = Math.floor(ms / 1000);\n\t\tconst minutes = Math.floor(seconds / 60);\n\t\tconst hours = Math.floor(minutes / 60);\n\t\tconst days = Math.floor(hours / 24);\n\n\t\tif (days > 0) return `${days}d ${hours % 24}h`;\n\t\tif (hours > 0) return `${hours}h ${minutes % 60}m`;\n\t\tif (minutes > 0) return `${minutes}m`;\n\t\treturn `${seconds}s`;\n\t}\n\n\tfunction formatServiceName(name: string): string {\n\t\treturn name.charAt(0).toUpperCase() + name.slice(1).replace(/([A-Z])/g, ' $1');\n\t}\n</script>\n\n<BaseWidget {label} {theme} endpoint=\"/api/dashboard/health\" pollInterval={5000} {icon} {widgetId} {size} {onSizeChange} onCloseRequest={onRemove}>\n\t{#snippet children({ data }: { data: HealthData | undefined })}\n\t\t{#if data}\n\t\t\t<div class=\"flex h-full flex-col gap-3\">\n\t\t\t\t<!-- Overall Status -->\n\t\t\t\t<div class=\"flex items-center justify-between\">\n\t\t\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t\t\t<iconify-icon icon={getStateIcon(data.overallStatus)} class={`text-2xl ${getStateColor(data.overallStatus)}`} width=\"24\"></iconify-icon>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class={`font-bold ${getStateColor(data.overallStatus)}`}>\n\t\t\t\t\t\t\t\t{data.overallStatus}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<p class=\"text-xs opacity-70\">Uptime: {formatUptime(data.uptime)}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<button class=\"preset-outlined-warning-500 btn-sm\" onclick={reinitializeSystem} title=\"Reinitialize system\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:refresh\" width=\"16\"></iconify-icon>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<!-- Services Grid -->\n\t\t\t\t<div class=\"grid flex-1 grid-cols-2 gap-2 overflow-y-auto\" style=\"max-height: calc({size.h} * 120px - 80px);\">\n\t\t\t\t\t{#each Object.entries(data.components) as [name, service]}\n\t\t\t\t\t\t<div class=\"card preset-outlined-surface-500flex flex-col gap-1 p-2\">\n\t\t\t\t\t\t\t<div class=\"flex items-center justify-between\">\n\t\t\t\t\t\t\t\t<span class=\"text-xs font-semibold\">{formatServiceName(name)}</span>\n\t\t\t\t\t\t\t\t<span class={`badge ${getServiceBadgeClass(service.status)}`}>\n\t\t\t\t\t\t\t\t\t{service.status}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<p class=\"truncate text-xs opacity-70\" title={service.message}>\n\t\t\t\t\t\t\t\t{service.message}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t{#if service.error}\n\t\t\t\t\t\t\t\t<p class=\"truncate text-xs text-error-500\" title={service.error}>\n\t\t\t\t\t\t\t\t\t{service.error}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/each}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{:else}\n\t\t\t<div class=\"flex flex-1 flex-col items-center justify-center py-6 text-xs text-gray-500 dark:text-gray-400\">\n\t\t\t\t<iconify-icon icon=\"mdi:alert-circle-outline\" width=\"32\" class=\"mb-2 text-surface-400\"></iconify-icon>\n\t\t\t\t<span>Health data unavailable</span>\n\t\t\t</div>\n\t\t{/if}\n\t{/snippet}\n</BaseWidget>\n"],"names":["$$renderer","$.attr","$.attr_class","$.escape","$.attr_style","$.stringify","$.ensure_array_like"],"mappings":";;;;MAmBc,aAAU;AAAA,EACtB,MAAM;AAAA,EACN,MAAM;AAAA,EACN,aAAa;AAAA,EACb,eAAe,GAAG,GAAG,GAAG,EAAC;;;wCAI3B;;MAuBE,QAAQ;AAAA,MACR,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,WAAW;AAAA,MACX,SAAS,GAAG,GAAG,GAAG,EAAC;AAAA,MACnB,eAAY,CAAI,aAAkB;AAAA,MAAC;AAAA,MACnC,iBAAiB;AAAA,MAAC;AAAA;aAgCV,cAAc,OAA4B;cAC1C,OAAK;AAAA,aACP;iBACG;AAAA,aACH;iBACG;AAAA,aACH;iBACG;AAAA,aACH;iBACG;AAAA,aACH;iBACG;AAAA;iBAEA;AAAA;IAEV;aAES,aAAa,OAA4B;cACzC,OAAK;AAAA,aACP;iBACG;AAAA,aACH;iBACG;AAAA,aACH;iBACG;AAAA,aACH;iBACG;AAAA,aACH;iBACG;AAAA;iBAEA;AAAA;IAEV;aAES,qBAAqB,QAA+B;cACpD,QAAM;AAAA,aACR;iBACG;AAAA,aACH;iBACG;AAAA,aACH;iBACG;AAAA;iBAEA;AAAA;IAEV;aAES,aAAa,IAAoB;AACnC,YAAA,UAAU,KAAK,MAAM,KAAK,GAAI;AAC9B,YAAA,UAAU,KAAK,MAAM,UAAU,EAAE;AACjC,YAAA,QAAQ,KAAK,MAAM,UAAU,EAAE;AAC/B,YAAA,OAAO,KAAK,MAAM,QAAQ,EAAE;AAE9B,UAAA,OAAO,EAAC,QAAA,GAAY,IAAI,KAAK,QAAQ,EAAE;AACvC,UAAA,QAAQ,EAAC,QAAA,GAAY,KAAK,KAAK,UAAU,EAAE;UAC3C,UAAU,EAAC,QAAA,GAAY,OAAO;gBACxB,OAAO;AAAA,IAClB;aAES,kBAAkB,MAAsB;AACzC,aAAA,KAAK,OAAO,CAAC,EAAE,YAAW,IAAK,KAAK,MAAM,CAAC,EAAE,QAAQ,YAAY,KAAK;AAAA,IAC9E;;AAIU,UAAA,WAAA,wBAAW,QAAI;YACnB,MAAI;;AAKe,UAAAA,YAAA,KAAA,4IAAAC,KAAA,QAAA,aAAa,KAAK,aAAa,CAAA,CAAA,GAAAC,WAAA,YAAsB,cAAc,KAAK,aAAa,CAAA,EAAA,CAAA,yCAAAA,WAAA,aAE9E,cAAc,KAAK,aAAa,CAAA,EAAA,CAAA,IAAAC,YACxD,KAAK,aAAa,CAAA,iDAAAA,YAEmB,aAAa,KAAK,MAAM,CAAA,CAAA,wOAAAC,WAAA,oBAAAC,UAUkB,KAAK,CAAC,CAAA,mBAAA,CAAA,WAAA;AAClF,gBAAA,aAAAC,kBAAA,OAAO,QAAQ,KAAK,UAAU,CAAA;;AAAM,gBAAA,CAAA,MAAM,OAAQ,IAAA,WAAA,OAAA;AAGjB,YAAAN,YAAA,KAAA,2JAAAG,YAAA,kBAAkB,IAAI,CAAA,CAAA,gBAAAD,WAAA,SACrC,qBAAqB,QAAQ,MAAM,CAAA,EAAA,CAAA,IAAAC,YACvD,QAAQ,MAAM,sEAG6B,QAAQ,OAAO,CAAA,IAAAA,YAC3D,QAAQ,OAAO,CAAA,OAAA;AAEZ,gBAAA,QAAQ,OAAK;;AACiC,cAAAH,YAAA,KAAA,6CAAAC,KAAA,SAAA,QAAQ,KAAK,CAAA,IAAAE,YAC7D,QAAQ,KAAK,CAAA,MAAA;AAAA;;;;;;;;;;;;;QApCV;AAAA,QAAQ;AAAA;sBAAsD;AAAA,QAAO;AAAA,QAAO;AAAA,QAAW;AAAA,QAAO;AAAA,wBAA8B;AAAA,QAC9H;AAAA;;EAHH,CAAA;;"}