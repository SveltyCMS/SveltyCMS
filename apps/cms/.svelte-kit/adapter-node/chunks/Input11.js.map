{"version":3,"file":"Input11.js","sources":["../../../../src/widgets/custom/Email/Input.svelte"],"sourcesContent":["<!--\n@file src/widgets/custom/Email/Input.svelte\n@component\n**Email Widget Component**\n\n@example\n<Email bind:field={field} bind:value={value} />\n\n### Props\n- `field`: FieldType\n- `value`: any\n\n### Features\n- **Email Validation**: HTML5 email validation with Valibot schema\n- **Non-Translatable**: Correctly treats email addresses as universal data\n- **Semantic HTML**: Uses type=\"email\" for proper mobile keyboards\n- **Enhanced Validation**: Integration with validation store\n- **Touch State Management**: Proper error display based on interaction\n- **Debounced Validation**: Performance-optimized validation\n- **Accessibility**: Full ARIA support and semantic HTML\n- **Auto-Focus**: Focus management for required fields\n-->\n\n<script lang=\"ts\">\n\timport { onMount, onDestroy } from 'svelte';\n\timport type { FieldType } from '.';\n\timport { publicEnv } from '@shared/stores/globalSettings.svelte';\n\n\t// Stores\n\t// Stores\n\timport { app, validationStore } from '@shared/stores/store.svelte';\n\timport { collection } from '@shared/stores/collectionStore.svelte';\n\timport { activeInput } from '@shared/stores/activeInputStore.svelte';\n\n\t// Utils\n\timport { getFieldName } from '@shared/utils/utils';\n\n\t// Valibot validation\n\timport { string, email as emailValidator, pipe, parse, type ValiError, minLength, optional } from 'valibot';\n\n\tinterface Props {\n\t\tfield: FieldType;\n\t\tvalue?: any;\n\t}\n\n\tlet { field, value = $bindable() }: Props = $props();\n\n\t// Use current content language for translated fields, default for non-translated\n\t// Use current content language for translated fields, default for non-translated\n\tconst fieldName = $derived(getFieldName(field));\n\tconst _language = $derived(field.translated ? app.contentLanguage : ((publicEnv.DEFAULT_CONTENT_LANGUAGE as string) || 'en').toLowerCase());\n\n\t// Initialize value\n\t$effect(() => {\n\t\tif (!value) {\n\t\t\tvalue = { [_language]: '' };\n\t\t}\n\t});\n\n\tconst safeValue = $derived(value?.[_language] ?? '');\n\tconst validationError = $derived(validationStore.getError(fieldName));\n\tlet debounceTimeout: number | undefined;\n\tlet inputElement = $state<HTMLInputElement | null>(null);\n\tlet isTouched = $state(false);\n\tlet isValidating = $state(false);\n\n\t// Create validation schema for email\n\tconst emailSchema = $derived(\n\t\tfield?.required\n\t\t\t? pipe(string(), minLength(1, 'This field is required'), emailValidator('Please enter a valid email address'))\n\t\t\t: optional(pipe(string(), emailValidator('Please enter a valid email address')), '')\n\t);\n\n\t// Validation function with debounce\n\tfunction validateInput(immediate = false) {\n\t\tif (debounceTimeout) clearTimeout(debounceTimeout);\n\n\t\tconst doValidation = () => {\n\t\t\ttry {\n\t\t\t\tisValidating = true;\n\t\t\t\tconst currentValue = safeValue;\n\n\t\t\t\t// First validate if required\n\t\t\t\tif (field?.required && (!currentValue || currentValue.trim() === '')) {\n\t\t\t\t\tvalidationStore.setError(fieldName, 'This field is required');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Then validate email format if value exists\n\t\t\t\tif (currentValue && currentValue.trim() !== '') {\n\t\t\t\t\tparse(emailSchema, currentValue);\n\t\t\t\t}\n\n\t\t\t\tvalidationStore.clearError(fieldName);\n\t\t\t} catch (error) {\n\t\t\t\tif ((error as ValiError<any>).issues) {\n\t\t\t\t\tconst valiError = error as ValiError<any>;\n\t\t\t\t\tconst errorMessage = valiError.issues[0]?.message || 'Invalid input';\n\t\t\t\t\tvalidationStore.setError(fieldName, errorMessage);\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tisValidating = false;\n\t\t\t}\n\t\t};\n\n\t\tif (immediate) {\n\t\t\tdoValidation();\n\t\t} else {\n\t\t\tdebounceTimeout = window.setTimeout(doValidation, 300);\n\t\t}\n\t}\n\n\t// ✨ SECURITY ENHANCEMENT: Prevent homograph attacks\n\tfunction sanitizeInput(input: string): string {\n\t\t// Remove zero-width characters that could be used for spoofing\n\t\tconst sanitized = input.replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n\n\t\t// Normalize Unicode to prevent homograph attacks\n\t\treturn sanitized.normalize('NFKC');\n\t}\n\n\t// Handle input changes\n\tfunction handleInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tif (!value) {\n\t\t\tvalue = {};\n\t\t}\n\t\t// ✨ Apply sanitization before storing\n\t\tconst sanitized = sanitizeInput(target.value);\n\t\tvalue = { ...value, [_language]: sanitized };\n\t}\n\n\t// Handle blur\n\tfunction handleBlur() {\n\t\tisTouched = true;\n\t\tvalidateInput(true);\n\t}\n\n\t// Handle focus events\n\tfunction handleFocus(e: FocusEvent) {\n\t\t// If the token picker is already open (activeInput.current has a value),\n\t\t// update it to point to this input.\n\t\tif (activeInput.current) {\n\t\t\tactiveInput.set({\n\t\t\t\telement: e.currentTarget as HTMLInputElement,\n\t\t\t\tfield: {\n\t\t\t\t\tname: field.db_fieldName,\n\t\t\t\t\tlabel: field.label,\n\t\t\t\t\tcollection: collection.value?.name\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t// Focus management\n\tonMount(() => {\n\t\tif (field?.required && !safeValue) {\n\t\t\tinputElement?.focus();\n\t\t}\n\t});\n\n\t// Cleanup\n\tonDestroy(() => {\n\t\tif (debounceTimeout) clearTimeout(debounceTimeout);\n\t});\n\n\t// Export WidgetData for data binding with Fields.svelte\n\texport const WidgetData = async () => value;\n</script>\n\n<div class=\"input-container relative mb-4\">\n\t<div class=\"preset-filled-surface-500 btn-group flex w-full rounded\" role=\"group\">\n\t\t{#if field?.prefix}\n\t\t\t<button class=\"px-2!\" type=\"button\" aria-label={`${field.prefix} prefix`}>\n\t\t\t\t{field?.prefix}\n\t\t\t</button>\n\t\t{/if}\n\n\t\t<div class=\"relative w-full flex-1\">\n\t\t\t<input\n\t\t\t\ttype=\"email\"\n\t\t\t\tvalue={safeValue || ''}\n\t\t\t\toninput={handleInput}\n\t\t\t\tonblur={handleBlur}\n\t\t\t\tonfocus={handleFocus}\n\t\t\t\tname={field?.db_fieldName}\n\t\t\t\tid={field?.db_fieldName}\n\t\t\t\tplaceholder={typeof field?.placeholder === 'string' && field.placeholder !== '' ? field.placeholder : String(field?.db_fieldName ?? '')}\n\t\t\t\trequired={field?.required as boolean | undefined}\n\t\t\t\treadonly={field?.readonly as boolean | undefined}\n\t\t\t\tdisabled={field?.disabled as boolean | undefined}\n\t\t\t\tclass=\"input w-full rounded-none text-black dark:text-primary-500\"\n\t\t\t\tclass:!border-error-500={!!validationError}\n\t\t\t\tclass:!ring-1={!!validationError || isValidating}\n\t\t\t\tclass:!ring-error-500={!!validationError}\n\t\t\t\tclass:!border-primary-500={isValidating && !validationError}\n\t\t\t\tclass:!ring-primary-500={isValidating && !validationError}\n\t\t\t\taria-invalid={!!validationError}\n\t\t\t\taria-describedby={validationError ? `${fieldName}-error` : undefined}\n\t\t\t\taria-required={field?.required}\n\t\t\t\tdata-testid=\"email-input\"\n\t\t\t/>\n\t\t</div>\n\n\t\t{#if field?.suffix}\n\t\t\t<button class=\"px-2!\" type=\"button\" aria-label={`${field.suffix} suffix`}>\n\t\t\t\t{field?.suffix}\n\t\t\t</button>\n\t\t{/if}\n\n\t\t<!-- Validation indicator -->\n\t\t{#if isValidating}\n\t\t\t<div class=\"absolute right-2 top-1/2 -translate-y-1/2\" aria-label=\"Validating\">\n\t\t\t\t<div class=\"h-4 w-4 animate-spin rounded-full border-2 border-primary-500 border-t-transparent\"></div>\n\t\t\t</div>\n\t\t{/if}\n\n\t\t<!-- Error Message -->\n\t\t{#if validationError && isTouched}\n\t\t\t<p\n\t\t\t\tid={`${field.db_fieldName}-error`}\n\t\t\t\tclass=\"absolute -bottom-4 left-0 w-full text-center text-xs text-error-500\"\n\t\t\t\trole=\"alert\"\n\t\t\t\taria-live=\"polite\"\n\t\t\t>\n\t\t\t\t{validationError}\n\t\t\t</p>\n\t\t{/if}\n\t</div>\n</div>\n"],"names":["emailValidator","$$renderer","$.attr","$.escape","$.attr_class"],"mappings":";;;;;;;;wCAuBA;AAsBO,QAAA,EAAA,OAAO,QAAK,OAAA,IAAA;UAIZ,YAAqB,aAAa,KAAK;UACvC,YAAqB,MAAM,aAAa,IAAI,mBAAoB,UAAU,4BAAuC,MAAM,YAAW;AASlI,UAAA,YAAqB,QAAQ,SAAS,KAAK;AAC3C,UAAA,kBAA2B,gBAAgB,SAAS,SAAS;AAI/D,QAAA,eAAsB;AAIzB,WAAO,WACJ,KAAK,OAAM,GAAI,UAAU,GAAG,wBAAwB,GAAGA,MAAe,oCAAoC,CAAA,IAC1G,SAAS,KAAK,OAAM,GAAIA,MAAe,oCAAoC,CAAA,GAAI,EAAE;AA4FrF,cAAS,MAAO;AAAA,IAEhB,CAAC;AAGY,UAAA,yBAAyB;;AAKhC,QAAA,OAAO,QAAM;;AACkC,MAAAC,YAAA,KAAA,sCAAAC,KAAA,cAAA,GAAA,MAAM,MAAM,SAAA,CAAA,IAAAC,YAC7D,OAAO,MAAM,CAAA,WAAA;AAAA;;;sGAOP,aAAa,EAAE,CAAA,GAAAD,KAAA,QAIhB,OAAO,YAAY,CAAA,GAAAA,KAAA,MACrB,OAAO,YAAY,+BACH,OAAO,gBAAgB,YAAY,MAAM,gBAAgB,KAAK,MAAM,cAAc,OAAO,OAAO,gBAAgB,EAAE,sBAC5H,OAAO,UAAQ,IAAA,CAAA,GAAAA,KAAA,YACf,OAAO,UAAQ,IAAA,CAAA,GAAAA,KAAA,YACf,OAAO,UAAQ,IAAA,CAAA,GAAAE,WAAA,8DAAA,QAAA;AAAA,6BAEE;AAAA,MACV,WAAA,CAAA,CAAA,mBAAmB;AAAA,2BACX;AAAA,MACE,uBAAA;AAAA,MACF,qBAAA;AAAA,gCACT,eAAe,CAAA,GAAAF,KAAA,oBACb,kBAAe,GAAM,SAAS,WAAW,MAAS,CAAA,GAAAA,KAAA,iBACrD,OAAO,QAAQ,CAAA,qCAAA;AAK3B,QAAA,OAAO,QAAM;;AACkC,MAAAD,YAAA,KAAA,sCAAAC,KAAA,cAAA,GAAA,MAAM,MAAM,SAAA,CAAA,IAAAC,YAC7D,OAAO,MAAM,CAAA,WAAA;AAAA;;;;;;;;;;;;;EAtCV,CAAA;;"}