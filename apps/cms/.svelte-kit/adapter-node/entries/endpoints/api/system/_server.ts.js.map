{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/system/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/system/+server.ts\n * @description System Management API - unified database-agnostic endpoint for system operations\n * @summary All system management goes through this single endpoint with action-based routing\n *  - GET: health - Get current system health status\n *  - POST: reinitialize - Reinitialize system services\n *  - POST: restart-service - Restart specific service\n *  - GET: metrics - Get system metrics (future)\n *  - POST: backup - Trigger system backup (future)\n */\n\nimport { json, error as svelteError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getHealthCheckReport } from '@shared/stores/system';\nimport { reinitializeSystem } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\n\n/**\n * GET /api/system?action=health\n * Public health check endpoint for monitoring system status\n */\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\tconst action = url.searchParams.get('action') || 'health';\n\n\ttry {\n\t\tswitch (action) {\n\t\t\tcase 'health': {\n\t\t\t\tconst healthReport = getHealthCheckReport();\n\n\t\t\t\t// Map system state to HTTP status codes\n\t\t\t\tconst statusCode = healthReport.overallStatus === 'READY' || healthReport.overallStatus === 'DEGRADED' ? 200 : 503;\n\n\t\t\t\treturn json(healthReport, { status: statusCode });\n\t\t\t}\n\n\t\t\tcase 'metrics': {\n\t\t\t\t// Future: Return detailed metrics\n\t\t\t\tif (!locals.user || (locals.user.role !== 'admin' && locals.user.role !== 'superadmin')) {\n\t\t\t\t\tthrow svelteError(403, 'Admin access required');\n\t\t\t\t}\n\n\t\t\t\treturn json({\n\t\t\t\t\tmessage: 'Metrics endpoint - coming soon',\n\t\t\t\t\tavailableMetrics: ['service uptime', 'failure count history', 'performance metrics', 'request latency', 'error rates']\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdefault:\n\t\t\t\tthrow svelteError(400, `Unknown action: ${action}`);\n\t\t}\n\t} catch (err) {\n\t\tif (err && typeof err === 'object' && 'status' in err) {\n\t\t\tthrow err; // Re-throw SvelteKit errors\n\t\t}\n\n\t\tlogger.error('System GET request failed', { action, error: err });\n\t\treturn json(\n\t\t\t{\n\t\t\t\terror: err instanceof Error ? err.message : 'Unknown error',\n\t\t\t\taction\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n\n/**\n * POST /api/system\n * Admin-only system management operations\n */\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\ttry {\n\t\t// Authentication check\n\t\tif (!locals.user) {\n\t\t\tthrow svelteError(401, 'Authentication required');\n\t\t}\n\n\t\t// Authorization check - require admin role\n\t\tif (locals.user.role !== 'admin' && locals.user.role !== 'superadmin') {\n\t\t\tthrow svelteError(403, 'Admin access required');\n\t\t}\n\n\t\tconst body = await request.json();\n\t\tconst { action, ...params } = body;\n\n\t\tlogger.info('System management action requested', {\n\t\t\taction,\n\t\t\tuserId: locals.user._id,\n\t\t\tuserEmail: locals.user.email,\n\t\t\tparams\n\t\t});\n\n\t\tswitch (action) {\n\t\t\tcase 'reinitialize': {\n\t\t\t\tconst force = params.force ?? true;\n\t\t\t\tconst result = await reinitializeSystem(force);\n\n\t\t\t\tif (result.status === 'initialized') {\n\t\t\t\t\tlogger.info('System reinitialized successfully', { userId: locals.user._id });\n\t\t\t\t\treturn json({\n\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\tmessage: 'System reinitialized successfully'\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tlogger.error('System reinitialization failed', {\n\t\t\t\t\t\tresult,\n\t\t\t\t\t\tuserId: locals.user._id\n\t\t\t\t\t});\n\t\t\t\t\treturn json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\t\terror: result.error || 'Unknown error'\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{ status: 500 }\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcase 'restart-service': {\n\t\t\t\t// Future: Restart specific service\n\t\t\t\tconst serviceName = params.service;\n\n\t\t\t\tif (!serviceName) {\n\t\t\t\t\tthrow svelteError(400, 'Service name required');\n\t\t\t\t}\n\n\t\t\t\t// Validate service name\n\t\t\t\tconst validServices = ['database', 'auth', 'cache', 'contentManager', 'themeManager'];\n\t\t\t\tif (!validServices.includes(serviceName)) {\n\t\t\t\t\tthrow svelteError(400, `Invalid service name. Valid services: ${validServices.join(', ')}`);\n\t\t\t\t}\n\n\t\t\t\tlogger.info('Service restart requested', {\n\t\t\t\t\tservice: serviceName,\n\t\t\t\t\tuserId: locals.user._id\n\t\t\t\t});\n\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Service-specific restart not yet implemented',\n\t\t\t\t\t\tservice: serviceName,\n\t\t\t\t\t\tnote: 'Use \"reinitialize\" action to restart all services'\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 501 }\n\t\t\t\t); // Not Implemented\n\t\t\t}\n\n\t\t\tcase 'backup': {\n\t\t\t\t// Future: Trigger system backup\n\t\t\t\tlogger.info('System backup requested', { userId: locals.user._id });\n\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Backup endpoint - coming soon',\n\t\t\t\t\t\tnote: 'Will trigger database backup and export system configuration'\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 501 }\n\t\t\t\t); // Not Implemented\n\t\t\t}\n\n\t\t\tcase 'clear-cache': {\n\t\t\t\t// Future: Clear system caches\n\t\t\t\tlogger.info('Cache clear requested', { userId: locals.user._id });\n\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Cache clear endpoint - coming soon',\n\t\t\t\t\t\tnote: 'Will clear session cache, content cache, and other caches'\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 501 }\n\t\t\t\t); // Not Implemented\n\t\t\t}\n\n\t\t\tdefault:\n\t\t\t\tthrow svelteError(400, `Unknown action: ${action}`);\n\t\t}\n\t} catch (err) {\n\t\tif (err && typeof err === 'object' && 'status' in err) {\n\t\t\tthrow err; // Re-throw SvelteKit errors\n\t\t}\n\n\t\tlogger.error('System POST request failed', { error: err });\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\terror: err instanceof Error ? err.message : 'Unknown error'\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":["svelteError"],"mappings":"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"}