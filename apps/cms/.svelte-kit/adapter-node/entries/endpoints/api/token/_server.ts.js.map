{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/token/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/token/+server.ts\n * @description API endpoint for listing all tokens.\n *\n * This module is responsible for:\n * - Retrieving all tokens for the current tenant\n * - Requires admin authentication (handled by hooks)\n *\n * @usage\n * GET /api/token\n * @returns {\n *   \"success\": true,\n *   \"data\": {\n *     \"tokens\": [...],\n *     \"count\": 10\n *   }\n * }\n *\n * @note Token creation has been moved to /api/token/createToken\n * @note Token editing has been consolidated to /api/token/[tokenID]\n */\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\n// Auth (Database Agnostic)\nimport { auth } from '@shared/database/db';\n\n// System logger\nimport { logger } from '@shared/utils/logger.server';\n\nexport const GET: RequestHandler = async ({ locals }) => {\n\tconst { tenantId } = locals; // User and permissions are guaranteed by hooks\n\n\ttry {\n\t\tif (!auth) {\n\t\t\tlogger.error('Database authentication adapter not initialized');\n\t\t\tthrow error(500, 'Database authentication not available');\n\t\t}\n\n\t\t// Build filter for multi-tenant scenarios\n\t\tconst filter = getPrivateSettingSync('MULTI_TENANT') && tenantId ? { tenantId } : {};\n\n\t\tconst result = await auth.getAllTokens(filter);\n\n\t\tif (!result.success) {\n\t\t\tthrow error(500, 'Failed to retrieve tokens');\n\t\t}\n\n\t\tlogger.info('Tokens retrieved successfully', {\n\t\t\tcount: result.data?.length || 0,\n\t\t\trequestedBy: locals.user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\ttokens: result.data || [],\n\t\t\t\tcount: result.data?.length || 0\n\t\t\t}\n\t\t});\n\t} catch (err: unknown) {\n\t\tconst httpError = err as { status?: number; body?: { message?: string } };\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'An unexpected error occurred.';\n\n\t\tlogger.error('Error retrieving tokens:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\tstatus\n\t\t});\n\n\t\treturn json({ success: false, message: status === 500 ? 'Internal Server Error' : message }, { status });\n\t}\n};\n"],"names":[],"mappings":";;;;AAgCO,MAAM,MAAsB,OAAO,EAAE,aAAa;AACxD,QAAM,EAAE,aAAa;AAErB,MAAI;AACH,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,iDAAiD;AAC9D,YAAM,MAAM,KAAK,uCAAuC;AAAA,IACzD;AAGA,UAAM,SAAS,sBAAsB,cAAc,KAAK,WAAW,EAAE,SAAA,IAAa,CAAA;AAElF,UAAM,SAAS,MAAM,KAAK,aAAa,MAAM;AAE7C,QAAI,CAAC,OAAO,SAAS;AACpB,YAAM,MAAM,KAAK,2BAA2B;AAAA,IAC7C;AAEA,WAAO,KAAK,iCAAiC;AAAA,MAC5C,OAAO,OAAO,MAAM,UAAU;AAAA,MAC9B,aAAa,OAAO,MAAM;AAAA,MAC1B;AAAA,IAAA,CACA;AAED,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,QACL,QAAQ,OAAO,QAAQ,CAAA;AAAA,QACvB,OAAO,OAAO,MAAM,UAAU;AAAA,MAAA;AAAA,IAC/B,CACA;AAAA,EACF,SAAS,KAAc;AACtB,UAAM,YAAY;AAClB,UAAM,SAAS,UAAU,UAAU;AACnC,UAAM,UAAU,UAAU,MAAM,WAAW;AAE3C,WAAO,MAAM,4BAA4B;AAAA,MACxC,OAAO;AAAA,MACP,OAAO,eAAe,QAAQ,IAAI,QAAQ;AAAA,MAC1C,QAAQ,OAAO,MAAM;AAAA,MACrB;AAAA,IAAA,CACA;AAED,WAAO,KAAK,EAAE,SAAS,OAAO,SAAS,WAAW,MAAM,0BAA0B,WAAW,EAAE,OAAA,CAAQ;AAAA,EACxG;AACD;"}