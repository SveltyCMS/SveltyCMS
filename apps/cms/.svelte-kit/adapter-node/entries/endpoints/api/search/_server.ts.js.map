{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/search/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/search/+server.ts\n * @description API endpoint for searching across collections\n *\n * @example: GET /api/search?q=searchterm&collections=posts,pages&limit=10\n *\n * Features:\n * * Cross-collection search functionality, scoped to the current tenant\n * * Full-text search capabilities\n * * Advanced filtering and sorting\n * * Permission-aware results\n * * Performance optimized with QueryBuilder\n */\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nimport { json, error, type RequestHandler } from '@sveltejs/kit';\n\n// Auth\n\n// Databases & Api\nimport { dbAdapter } from '@shared/database/db';\nimport { contentManager } from '@content/ContentManager';\nimport { modifyRequest } from '@api/collections/modifyRequest';\nimport type { CollectionModel } from '@shared/database/dbInterface';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// GET: Advanced search across collections\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\tconst start = performance.now();\n\tconst { user, tenantId } = locals;\n\n\tif (!user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\ttry {\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t} // Parse query parameters\n\n\t\tconst searchQuery = url.searchParams.get('q') || '';\n\t\tconst collectionsParam = url.searchParams.get('collections');\n\t\tconst page = Number(url.searchParams.get('page') ?? 1);\n\t\tconst limit = Number(url.searchParams.get('limit') ?? 25);\n\t\tconst sortField = url.searchParams.get('sortField') || 'updatedAt';\n\t\tconst sortDirection = (url.searchParams.get('sortDirection') as 'asc' | 'desc') || 'desc';\n\t\tconst filterParam = url.searchParams.get('filter');\n\t\tconst statusFilter = url.searchParams.get('status');\n\t\t// Parse collections to search\n\t\tlet collectionsToSearch: string[] = [];\n\t\tif (collectionsParam) {\n\t\t\tcollectionsToSearch = collectionsParam.split(',').map((c) => c.trim());\n\t\t} else {\n\t\t\t// If no collections specified, search all collections within the tenant (hooks already validated access)\n\t\t\tconst allCollections = await contentManager.getCollections(tenantId);\n\t\t\tcollectionsToSearch = allCollections.map((c) => c._id).filter((id): id is string => id !== undefined);\n\t\t}\n\t\t// Parse additional filters\n\t\tlet additionalFilter = {};\n\t\tif (filterParam) {\n\t\t\ttry {\n\t\t\t\tadditionalFilter = JSON.parse(filterParam);\n\t\t\t} catch {\n\t\t\t\tthrow error(400, 'Invalid filter parameter');\n\t\t\t}\n\t\t}\n\n\t\t// --- MULTI-TENANCY: Scope all filters by tenantId ---\n\t\tconst baseFilter: { status?: string; tenantId?: string } = getPrivateSettingSync('MULTI_TENANT') ? { tenantId } : {};\n\t\tif (additionalFilter) {\n\t\t\tObject.assign(baseFilter, additionalFilter);\n\t\t}\n\t\t// Add status filtering for non-admin users\n\t\tconst isAdmin = locals.isAdmin || false;\n\t\tif (!isAdmin) {\n\t\t\tbaseFilter.status = statusFilter || 'published';\n\t\t} else if (statusFilter) {\n\t\t\tbaseFilter.status = statusFilter;\n\t\t}\n\n\t\tconst searchResults: unknown[] = [];\n\t\tlet totalResults = 0;\n\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\tthrow error(500, 'Database not initialized');\n\t\t}\n\n\t\t// Search across all specified collections in parallel\n\t\tconst searchPromises = collectionsToSearch.map(async (collectionId) => {\n\t\t\tconst collection = await contentManager.getCollectionById(collectionId, tenantId);\n\t\t\tif (!collection) return [];\n\n\t\t\ttry {\n\t\t\t\t// Build search filter\n\t\t\t\tconst searchFilter: Record<string, unknown> = { ...baseFilter };\n\n\t\t\t\t// For text search, we'll use the database's text search capabilities\n\t\t\t\t// Note: The exact implementation depends on the database adapter\n\t\t\t\tconst collectionName = `collection_${collection._id}`;\n\n\t\t\t\t// Use findMany instead of queryBuilder for simpler type compatibility\n\t\t\t\tif (!dbAdapter) throw new Error('Database adapter not initialized');\n\t\t\t\tconst result = await dbAdapter.crud.findMany(collectionName, searchFilter as Record<string, unknown>, {\n\t\t\t\t\tlimit: Math.min(limit, 100)\n\t\t\t\t});\n\n\t\t\t\tif (result.success && result.data) {\n\t\t\t\t\tlet items = Array.isArray(result.data) ? result.data : [];\n\n\t\t\t\t\t// Filter by search query if provided (client-side filtering for simplicity)\n\t\t\t\t\tif (searchQuery) {\n\t\t\t\t\t\tconst lowerQuery = searchQuery.toLowerCase();\n\t\t\t\t\t\titems = items.filter((item) => {\n\t\t\t\t\t\t\tconst searchableFields = ['title', 'content', 'description', 'name'];\n\t\t\t\t\t\t\treturn searchableFields.some((field) => {\n\t\t\t\t\t\t\t\tconst value = (item as unknown as Record<string, unknown>)[field];\n\t\t\t\t\t\t\t\treturn typeof value === 'string' && value.toLowerCase().includes(lowerQuery);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t} // Apply modifyRequest for widget processing\n\t\t\t\t\tif (items.length > 0) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait modifyRequest({\n\t\t\t\t\t\t\t\tdata: items as unknown as Record<string, unknown>[],\n\t\t\t\t\t\t\t\tfields: collection.fields as unknown as import('@cms-types').FieldInstance[],\n\t\t\t\t\t\t\t\tcollection: collection as unknown as CollectionModel,\n\t\t\t\t\t\t\t\tuser,\n\t\t\t\t\t\t\t\ttype: 'GET',\n\t\t\t\t\t\t\t\ttenantId\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (modifyError) {\n\t\t\t\t\t\t\tconst errMsg = modifyError instanceof Error ? modifyError.message : String(modifyError);\n\t\t\t\t\t\t\tlogger.warn(`ModifyRequest failed for collection ${collectionId}: ${errMsg}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// Add collection context to results\n\t\t\t\t\treturn items.map((item) => ({\n\t\t\t\t\t\t...(item as unknown as Record<string, unknown>),\n\t\t\t\t\t\t_collection: {\n\t\t\t\t\t\t\tid: collection._id,\n\t\t\t\t\t\t\tname: collection.name,\n\t\t\t\t\t\t\tlabel: collection.label\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t\treturn [];\n\t\t\t} catch (collectionError) {\n\t\t\t\tconst errMsg = collectionError instanceof Error ? collectionError.message : String(collectionError);\n\t\t\t\tlogger.warn(`Search failed for collection ${collectionId}: ${errMsg}`);\n\t\t\t\treturn [];\n\t\t\t}\n\t\t});\n\n\t\tconst resultsArrays = await Promise.all(searchPromises);\n\t\tsearchResults.push(...resultsArrays.flat());\n\t\t// Sort combined results\n\t\tif (sortField && searchResults.length > 0) {\n\t\t\tsearchResults.sort((a, b) => {\n\t\t\t\tconst aRecord = a as Record<string, unknown>;\n\t\t\t\tconst bRecord = b as Record<string, unknown>;\n\t\t\t\tconst aVal = aRecord[sortField];\n\t\t\t\tconst bVal = bRecord[sortField];\n\n\t\t\t\t// Handle comparison with type safety\n\t\t\t\tif (typeof aVal === 'string' && typeof bVal === 'string') {\n\t\t\t\t\treturn sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);\n\t\t\t\t}\n\t\t\t\tif (typeof aVal === 'number' && typeof bVal === 'number') {\n\t\t\t\t\tif (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;\n\t\t\t\t\tif (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;\n\t\t\t\t}\n\t\t\t\treturn 0;\n\t\t\t});\n\t\t}\n\t\t// Apply pagination to combined results\n\t\tconst startIndex = (page - 1) * limit;\n\t\tconst paginatedResults = searchResults.slice(startIndex, startIndex + limit);\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info(`Search completed: ${paginatedResults.length}/${totalResults} results in ${duration.toFixed(2)}ms`, { tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\titems: paginatedResults,\n\t\t\t\ttotal: totalResults,\n\t\t\t\tpage,\n\t\t\t\tpageSize: limit,\n\t\t\t\ttotalPages: Math.ceil(totalResults / limit),\n\t\t\t\tcollectionsSearched: collectionsToSearch.length,\n\t\t\t\tquery: searchQuery\n\t\t\t},\n\t\t\tperformance: { duration }\n\t\t});\n\t} catch (e) {\n\t\tif (e && typeof e === 'object' && 'status' in e) throw e; // Re-throw SvelteKit errors\n\n\t\tconst duration = performance.now() - start;\n\t\tconst errMsg = e instanceof Error ? e.message : String(e);\n\t\tlogger.error(`Search failed: ${errMsg} in ${duration.toFixed(2)}ms`);\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n"],"names":[],"mappings":";;;;;;AA6BO,MAAM,MAAsB,OAAO,EAAE,QAAQ,UAAU;AAC7D,QAAM,QAAQ,YAAY,IAAA;AAC1B,QAAM,EAAE,MAAM,SAAA,IAAa;AAE3B,MAAI,CAAC,MAAM;AACV,UAAM,MAAM,KAAK,cAAc;AAAA,EAChC;AAEA,MAAI;AACH,QAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,YAAM,MAAM,KAAK,oDAAoD;AAAA,IACtE;AAEA,UAAM,cAAc,IAAI,aAAa,IAAI,GAAG,KAAK;AACjD,UAAM,mBAAmB,IAAI,aAAa,IAAI,aAAa;AAC3D,UAAM,OAAO,OAAO,IAAI,aAAa,IAAI,MAAM,KAAK,CAAC;AACrD,UAAM,QAAQ,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK,EAAE;AACxD,UAAM,YAAY,IAAI,aAAa,IAAI,WAAW,KAAK;AACvD,UAAM,gBAAiB,IAAI,aAAa,IAAI,eAAe,KAAwB;AACnF,UAAM,cAAc,IAAI,aAAa,IAAI,QAAQ;AACjD,UAAM,eAAe,IAAI,aAAa,IAAI,QAAQ;AAElD,QAAI,sBAAgC,CAAA;AACpC,QAAI,kBAAkB;AACrB,4BAAsB,iBAAiB,MAAM,GAAG,EAAE,IAAI,CAAC,MAAM,EAAE,MAAM;AAAA,IACtE,OAAO;AAEN,YAAM,iBAAiB,MAAM,eAAe,eAAe,QAAQ;AACnE,4BAAsB,eAAe,IAAI,CAAC,MAAM,EAAE,GAAG,EAAE,OAAO,CAAC,OAAqB,OAAO,MAAS;AAAA,IACrG;AAEA,QAAI,mBAAmB,CAAA;AACvB,QAAI,aAAa;AAChB,UAAI;AACH,2BAAmB,KAAK,MAAM,WAAW;AAAA,MAC1C,QAAQ;AACP,cAAM,MAAM,KAAK,0BAA0B;AAAA,MAC5C;AAAA,IACD;AAGA,UAAM,aAAqD,sBAAsB,cAAc,IAAI,EAAE,SAAA,IAAa,CAAA;AAClH,QAAI,kBAAkB;AACrB,aAAO,OAAO,YAAY,gBAAgB;AAAA,IAC3C;AAEA,UAAM,UAAU,OAAO,WAAW;AAClC,QAAI,CAAC,SAAS;AACb,iBAAW,SAAS,gBAAgB;AAAA,IACrC,WAAW,cAAc;AACxB,iBAAW,SAAS;AAAA,IACrB;AAEA,UAAM,gBAA2B,CAAA;AACjC,QAAI,eAAe;AAEnB,QAAI,CAAC,WAAW;AACf,aAAO,MAAM,kCAAkC;AAC/C,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAGA,UAAM,iBAAiB,oBAAoB,IAAI,OAAO,iBAAiB;AACtE,YAAM,aAAa,MAAM,eAAe,kBAAkB,cAAc,QAAQ;AAChF,UAAI,CAAC,WAAY,QAAO,CAAA;AAExB,UAAI;AAEH,cAAM,eAAwC,EAAE,GAAG,WAAA;AAInD,cAAM,iBAAiB,cAAc,WAAW,GAAG;AAGnD,YAAI,CAAC,UAAW,OAAM,IAAI,MAAM,kCAAkC;AAClE,cAAM,SAAS,MAAM,UAAU,KAAK,SAAS,gBAAgB,cAAyC;AAAA,UACrG,OAAO,KAAK,IAAI,OAAO,GAAG;AAAA,QAAA,CAC1B;AAED,YAAI,OAAO,WAAW,OAAO,MAAM;AAClC,cAAI,QAAQ,MAAM,QAAQ,OAAO,IAAI,IAAI,OAAO,OAAO,CAAA;AAGvD,cAAI,aAAa;AAChB,kBAAM,aAAa,YAAY,YAAA;AAC/B,oBAAQ,MAAM,OAAO,CAAC,SAAS;AAC9B,oBAAM,mBAAmB,CAAC,SAAS,WAAW,eAAe,MAAM;AACnE,qBAAO,iBAAiB,KAAK,CAAC,UAAU;AACvC,sBAAM,QAAS,KAA4C,KAAK;AAChE,uBAAO,OAAO,UAAU,YAAY,MAAM,YAAA,EAAc,SAAS,UAAU;AAAA,cAC5E,CAAC;AAAA,YACF,CAAC;AAAA,UACF;AACA,cAAI,MAAM,SAAS,GAAG;AACrB,gBAAI;AACH,oBAAM,cAAc;AAAA,gBACnB,MAAM;AAAA,gBACN,QAAQ,WAAW;AAAA,gBACnB;AAAA,gBACA;AAAA,gBACA,MAAM;AAAA,gBACN;AAAA,cAAA,CACA;AAAA,YACF,SAAS,aAAa;AACrB,oBAAM,SAAS,uBAAuB,QAAQ,YAAY,UAAU,OAAO,WAAW;AACtF,qBAAO,KAAK,uCAAuC,YAAY,KAAK,MAAM,EAAE;AAAA,YAC7E;AAAA,UACD;AAEA,iBAAO,MAAM,IAAI,CAAC,UAAU;AAAA,YAC3B,GAAI;AAAA,YACJ,aAAa;AAAA,cACZ,IAAI,WAAW;AAAA,cACf,MAAM,WAAW;AAAA,cACjB,OAAO,WAAW;AAAA,YAAA;AAAA,UACnB,EACC;AAAA,QACH;AACA,eAAO,CAAA;AAAA,MACR,SAAS,iBAAiB;AACzB,cAAM,SAAS,2BAA2B,QAAQ,gBAAgB,UAAU,OAAO,eAAe;AAClG,eAAO,KAAK,gCAAgC,YAAY,KAAK,MAAM,EAAE;AACrE,eAAO,CAAA;AAAA,MACR;AAAA,IACD,CAAC;AAED,UAAM,gBAAgB,MAAM,QAAQ,IAAI,cAAc;AACtD,kBAAc,KAAK,GAAG,cAAc,KAAA,CAAM;AAE1C,QAAI,aAAa,cAAc,SAAS,GAAG;AAC1C,oBAAc,KAAK,CAAC,GAAG,MAAM;AAC5B,cAAM,UAAU;AAChB,cAAM,UAAU;AAChB,cAAM,OAAO,QAAQ,SAAS;AAC9B,cAAM,OAAO,QAAQ,SAAS;AAG9B,YAAI,OAAO,SAAS,YAAY,OAAO,SAAS,UAAU;AACzD,iBAAO,kBAAkB,QAAQ,KAAK,cAAc,IAAI,IAAI,KAAK,cAAc,IAAI;AAAA,QACpF;AACA,YAAI,OAAO,SAAS,YAAY,OAAO,SAAS,UAAU;AACzD,cAAI,OAAO,KAAM,QAAO,kBAAkB,QAAQ,KAAK;AACvD,cAAI,OAAO,KAAM,QAAO,kBAAkB,QAAQ,IAAI;AAAA,QACvD;AACA,eAAO;AAAA,MACR,CAAC;AAAA,IACF;AAEA,UAAM,cAAc,OAAO,KAAK;AAChC,UAAM,mBAAmB,cAAc,MAAM,YAAY,aAAa,KAAK;AAE3E,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,WAAO,KAAK,qBAAqB,iBAAiB,MAAM,IAAI,YAAY,eAAe,SAAS,QAAQ,CAAC,CAAC,MAAM,EAAE,UAAU;AAE5H,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,QACL,OAAO;AAAA,QACP,OAAO;AAAA,QACP;AAAA,QACA,UAAU;AAAA,QACV,YAAY,KAAK,KAAK,eAAe,KAAK;AAAA,QAC1C,qBAAqB,oBAAoB;AAAA,QACzC,OAAO;AAAA,MAAA;AAAA,MAER,aAAa,EAAE,SAAA;AAAA,IAAS,CACxB;AAAA,EACF,SAAS,GAAG;AACX,QAAI,KAAK,OAAO,MAAM,YAAY,YAAY,EAAG,OAAM;AAEvD,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,UAAM,SAAS,aAAa,QAAQ,EAAE,UAAU,OAAO,CAAC;AACxD,WAAO,MAAM,kBAAkB,MAAM,OAAO,SAAS,QAAQ,CAAC,CAAC,IAAI;AACnE,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;"}