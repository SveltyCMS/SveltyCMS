{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/required/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/required/+server.ts\n * @description API endpoint for getting widgets required by collections\n */\nimport { contentManager } from '@content/ContentManager';\nimport { json } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestHandler } from './$types';\n\nexport const GET: RequestHandler = async ({ locals }) => {\n\tconst start = performance.now();\n\tconst { tenantId } = locals; // User is guaranteed to exist due to hooks protection\n\n\ttry {\n\t\t// Get all collections from ContentManager, scoped by tenantId\n\t\tconst allCollections = await contentManager.getCollections();\n\n\t\tif (!allCollections || Object.keys(allCollections).length === 0) {\n\t\t\tlogger.trace('No collections found', { tenantId });\n\t\t\treturn json({\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: {\n\t\t\t\t\trequiredWidgets: [],\n\t\t\t\t\tcollectionsAnalyzed: 0,\n\t\t\t\t\ttenantId\n\t\t\t\t},\n\t\t\t\tmessage: 'No collections found'\n\t\t\t});\n\t\t}\n\n\t\t// Extract widget types from all collection fields\n\t\tconst requiredWidgets: string[] = [];\n\t\tconst widgetSet = new Set<string>();\n\n\t\tfor (const collection of Object.values(allCollections)) {\n\t\t\tif (!collection.fields) continue;\n\n\t\t\tfor (const field of collection.fields) {\n\t\t\t\tif (field && typeof field === 'object') {\n\t\t\t\t\tlet widgetType: string | undefined;\n\n\t\t\t\t\t// Modern architecture: get widget name from widget.Name\n\t\t\t\t\tif ('widget' in field && field.widget && typeof field.widget === 'object' && 'Name' in field.widget) {\n\t\t\t\t\t\twidgetType = String(field.widget.Name);\n\t\t\t\t\t}\n\t\t\t\t\t// Legacy compatibility: fallback to type property\n\t\t\t\t\telse if ('type' in field && field.type) {\n\t\t\t\t\t\twidgetType = String(field.type);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (widgetType) {\n\t\t\t\t\t\t// Capitalize the widget name to match the store convention\n\t\t\t\t\t\tconst capitalizedWidget = widgetType.charAt(0).toUpperCase() + widgetType.slice(1);\n\t\t\t\t\t\twidgetSet.add(capitalizedWidget);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\trequiredWidgets.push(...Array.from(widgetSet));\n\n\t\tconst collectionCount = Object.keys(allCollections).length;\n\t\tconst duration = performance.now() - start;\n\n\t\tlogger.trace('Analyzed collection widget dependencies', {\n\t\t\ttenantId,\n\t\t\tcollectionsAnalyzed: collectionCount,\n\t\t\trequiredWidgets: Array.from(requiredWidgets)\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\trequiredWidgets,\n\t\t\t\tcollectionsAnalyzed: collectionCount,\n\t\t\t\ttenantId,\n\t\t\t\tperformance: { duration: `${duration.toFixed(2)}ms` }\n\t\t\t},\n\t\t\tmessage: 'Required widgets analyzed successfully'\n\t\t});\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to analyze collection widget dependencies: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms`, stack: err instanceof Error ? err.stack : undefined });\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":";;;AASO,MAAM,MAAsB,OAAO,EAAE,aAAa;AACxD,QAAM,QAAQ,YAAY,IAAA;AAC1B,QAAM,EAAE,aAAa;AAErB,MAAI;AAEH,UAAM,iBAAiB,MAAM,eAAe,eAAA;AAE5C,QAAI,CAAC,kBAAkB,OAAO,KAAK,cAAc,EAAE,WAAW,GAAG;AAChE,aAAO,MAAM,wBAAwB,EAAE,SAAA,CAAU;AACjD,aAAO,KAAK;AAAA,QACX,SAAS;AAAA,QACT,MAAM;AAAA,UACL,iBAAiB,CAAA;AAAA,UACjB,qBAAqB;AAAA,UACrB;AAAA,QAAA;AAAA,QAED,SAAS;AAAA,MAAA,CACT;AAAA,IACF;AAGA,UAAM,kBAA4B,CAAA;AAClC,UAAM,gCAAgB,IAAA;AAEtB,eAAW,cAAc,OAAO,OAAO,cAAc,GAAG;AACvD,UAAI,CAAC,WAAW,OAAQ;AAExB,iBAAW,SAAS,WAAW,QAAQ;AACtC,YAAI,SAAS,OAAO,UAAU,UAAU;AACvC,cAAI;AAGJ,cAAI,YAAY,SAAS,MAAM,UAAU,OAAO,MAAM,WAAW,YAAY,UAAU,MAAM,QAAQ;AACpG,yBAAa,OAAO,MAAM,OAAO,IAAI;AAAA,UACtC,WAES,UAAU,SAAS,MAAM,MAAM;AACvC,yBAAa,OAAO,MAAM,IAAI;AAAA,UAC/B;AAEA,cAAI,YAAY;AAEf,kBAAM,oBAAoB,WAAW,OAAO,CAAC,EAAE,gBAAgB,WAAW,MAAM,CAAC;AACjF,sBAAU,IAAI,iBAAiB;AAAA,UAChC;AAAA,QACD;AAAA,MACD;AAAA,IACD;AAEA,oBAAgB,KAAK,GAAG,MAAM,KAAK,SAAS,CAAC;AAE7C,UAAM,kBAAkB,OAAO,KAAK,cAAc,EAAE;AACpD,UAAM,WAAW,YAAY,IAAA,IAAQ;AAErC,WAAO,MAAM,2CAA2C;AAAA,MACvD;AAAA,MACA,qBAAqB;AAAA,MACrB,iBAAiB,MAAM,KAAK,eAAe;AAAA,IAAA,CAC3C;AAED,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,QACL;AAAA,QACA,qBAAqB;AAAA,QACrB;AAAA,QACA,aAAa,EAAE,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC,KAAA;AAAA,MAAK;AAAA,MAErD,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,KAAK;AACb,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,UAAM,UAAU,qDAAqD,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACrH,WAAO,MAAM,SAAS,EAAE,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC,MAAM,OAAO,eAAe,QAAQ,IAAI,QAAQ,QAAW;AAEnH,WAAO;AAAA,MACN;AAAA,QACC,SAAS;AAAA,QACT,SAAS;AAAA,QACT,OAAO;AAAA,MAAA;AAAA,MAER,EAAE,QAAQ,IAAA;AAAA,IAAI;AAAA,EAEhB;AACD;"}