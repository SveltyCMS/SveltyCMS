{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/sync/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/sync/+server.ts\n * @description API endpoint to sync file system widgets with database\n * This ensures all widgets found in the file system are registered in the database\n */\nimport { json, error } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestHandler } from './$types';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\nimport { widgets } from '@shared/stores/widgetStore.svelte';\n\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\tconst start = performance.now();\n\n\ttry {\n\t\tconst { user } = locals;\n\n\t\t// Check authentication\n\t\tif (!user) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Unauthorized',\n\t\t\t\t\terror: 'Authentication credentials missing'\n\t\t\t\t},\n\t\t\t\t{ status: 401 }\n\t\t\t);\n\t\t}\n\n\t\t// Check permission - only admins can sync widgets\n\t\tconst hasWidgetPermission = hasPermissionWithRoles(user, 'api:widgets', locals.roles);\n\t\tconst isAdmin = user.role === 'admin' || user.role === 'super-admin';\n\n\t\tif (!hasWidgetPermission || !isAdmin) {\n\t\t\tlogger.warn(`User ${user._id} denied access to widget sync due to insufficient permissions`);\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Insufficient permissions',\n\t\t\t\t\terror: 'User lacks api:widgets permission or admin role'\n\t\t\t\t},\n\t\t\t\t{ status: 403 }\n\t\t\t);\n\t\t}\n\n\t\tconst tenantId = request.headers.get('X-Tenant-ID') || locals.tenantId || 'default-tenant';\n\n\t\t// Initialize widgets to get all from file system\n\t\tawait widgets.initialize(tenantId);\n\n\t\t// Get all widget data from file system\n\t\tconst allWidgetFunctions = widgets.widgetFunctions;\n\t\tconst coreWidgetNames = widgets.coreWidgets;\n\t\tconst customWidgetNames = widgets.customWidgets;\n\n\t\tif (!locals.dbAdapter?.widgets) {\n\t\t\tlogger.error('Widget database adapter not available');\n\t\t\tthrow error(500, 'Widget database adapter not available');\n\t\t}\n\n\t\t// Get current widgets from database\n\t\tconst dbResult = await locals.dbAdapter.widgets.findAll();\n\t\tconst dbWidgets: Array<Record<string, unknown>> = dbResult.success ? (dbResult.data as unknown as Array<Record<string, unknown>>) || [] : [];\n\t\tconst dbWidgetNames = dbWidgets.map((w) => w.name as string);\n\n\t\tlogger.info('Starting widget sync...', {\n\t\t\ttenantId,\n\t\t\tfileSystem: Object.keys(allWidgetFunctions).length,\n\t\t\tdatabase: dbWidgets.length,\n\t\t\tcore: coreWidgetNames.length,\n\t\t\tcustom: customWidgetNames.length\n\t\t});\n\n\t\t// Sync results tracking\n\t\tconst results = {\n\t\t\tcreated: [] as string[],\n\t\t\tupdated: [] as string[],\n\t\t\tactivated: [] as string[],\n\t\t\tskipped: [] as string[],\n\t\t\terrors: [] as { widget: string; error: string }[]\n\t\t};\n\n\t\t// Sync each widget from file system to database\n\t\tfor (const [name, widgetFn] of Object.entries(allWidgetFunctions)) {\n\t\t\ttry {\n\t\t\t\tconst isCore = coreWidgetNames.includes(name);\n\t\t\t\tconst exists = dbWidgetNames.includes(name);\n\t\t\t\tconst widget = widgetFn as unknown as Record<string, unknown>;\n\n\t\t\t\tif (exists) {\n\t\t\t\t\t// Widget exists in DB - ensure it's active if it's core\n\t\t\t\t\tconst dbWidget = dbWidgets.find((w) => w.name === name);\n\t\t\t\t\tif (isCore && dbWidget && !(dbWidget.isActive as boolean)) {\n\t\t\t\t\t\tawait locals.dbAdapter.widgets.update(dbWidget._id as unknown as import('@shared/database/dbInterface').DatabaseId, { isActive: true });\n\t\t\t\t\t\tresults.activated.push(name);\n\t\t\t\t\t\tlogger.trace(`Activated core widget: ${name}`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresults.skipped.push(name);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// Widget doesn't exist - create it\n\t\t\t\t\tconst createResult = await locals.dbAdapter.widgets.register({\n\t\t\t\t\t\tname,\n\t\t\t\t\t\tisActive: isCore, // Core widgets are active by default\n\t\t\t\t\t\tinstances: {},\n\t\t\t\t\t\tdependencies: (widget.__dependencies as string[]) || []\n\t\t\t\t\t});\n\t\t\t\t\tif (createResult.success) {\n\t\t\t\t\t\tresults.created.push(name);\n\t\t\t\t\t\tlogger.info(`Created widget in database: ${name} (${isCore ? 'core' : 'custom'})`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresults.errors.push({\n\t\t\t\t\t\t\twidget: name,\n\t\t\t\t\t\t\terror: createResult.error?.message || 'Unknown error'\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tconst errorMsg = err instanceof Error ? err.message : String(err);\n\t\t\t\tresults.errors.push({ widget: name, error: errorMsg });\n\t\t\t\tlogger.error(`Error syncing widget ${name}:`, err);\n\t\t\t}\n\t\t}\n\n\t\tconst duration = performance.now() - start;\n\n\t\tlogger.info('Widget sync completed', {\n\t\t\tstats: {\n\t\t\t\ttotal: Object.keys(allWidgetFunctions).length,\n\t\t\t\tcreated: results.created.length,\n\t\t\t\tupdated: results.updated.length,\n\t\t\t\tactivated: results.activated.length,\n\t\t\t\tskipped: results.skipped.length,\n\t\t\t\terrors: results.errors.length\n\t\t\t},\n\t\t\tduration: `${duration.toFixed(2)}ms`,\n\t\t\ttenantId\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tresults: {\n\t\t\t\t\ttotal: Object.keys(allWidgetFunctions).length,\n\t\t\t\t\tcreated: results.created.length,\n\t\t\t\t\tupdated: results.updated.length,\n\t\t\t\t\tactivated: results.activated.length,\n\t\t\t\t\tskipped: results.skipped.length,\n\t\t\t\t\terrors: results.errors.length\n\t\t\t\t},\n\t\t\t\tdetails: results,\n\t\t\t\ttenantId,\n\t\t\t\tperformance: { duration: `${duration.toFixed(2)}ms` }\n\t\t\t},\n\t\t\tmessage: 'Widget sync completed successfully'\n\t\t});\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to sync widgets: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms`, stack: err instanceof Error ? err.stack : undefined });\n\n\t\t// Standardized error response\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}