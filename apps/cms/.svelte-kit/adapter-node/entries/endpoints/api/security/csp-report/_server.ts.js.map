{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/security/csp-report/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/security/csp-report/+server.ts\n * @description CSP violation reporting endpoint for security monitoring\n *\n * ### Features\n * - Receives and processes CSP violation reports\n * - Logs violations for security analysis\n * - Tracks violation metrics for monitoring\n * - Rate limits to prevent abuse\n * - Validates report format\n *\n * @security This endpoint helps monitor XSS attempts and policy violations\n */\n\nimport { json, type RequestHandler } from '@sveltejs/kit';\nimport { metricsService } from '@shared/services/MetricsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { dev } from '$app/environment';\n\n// --- TYPES ---\n\ninterface CSPViolationReport {\n\t'document-uri': string;\n\treferrer: string;\n\t'violated-directive': string;\n\t'effective-directive': string;\n\t'original-policy': string;\n\tdisposition: 'enforce' | 'report';\n\t'blocked-uri': string;\n\t'line-number': number;\n\t'column-number': number;\n\t'source-file': string;\n\t'status-code': number;\n\t'script-sample': string;\n}\n\ninterface CSPReportPayload {\n\t'csp-report': CSPViolationReport;\n}\n\n// --- VALIDATION ---\n\n/**\n * Validates that the incoming report has the expected CSP format.\n */\nfunction isValidCSPReport(data: unknown): data is CSPReportPayload {\n\tif (!data || typeof data !== 'object') return false;\n\n\tconst report = (data as CSPReportPayload)['csp-report'];\n\tif (!report || typeof report !== 'object') return false;\n\n\t// Check for required fields\n\treturn (\n\t\ttypeof report['document-uri'] === 'string' && typeof report['violated-directive'] === 'string' && typeof report['original-policy'] === 'string'\n\t);\n}\n\n/**\n * Checks if a CSP violation should be ignored (common false positives).\n */\nfunction shouldIgnoreViolation(report: CSPViolationReport): boolean {\n\tconst blockedUri = report['blocked-uri'] || '';\n\tconst violatedDirective = report['violated-directive'] || '';\n\n\t// Ignore browser extensions\n\tif (blockedUri.startsWith('chrome-extension://') || blockedUri.startsWith('moz-extension://') || blockedUri.startsWith('safari-web-extension://')) {\n\t\treturn true;\n\t}\n\n\t// Ignore common browser artifacts\n\tif (blockedUri === 'eval' && violatedDirective.includes('script-src')) {\n\t\t// This might be legitimate eval() usage - log but don't alarm\n\t\treturn false;\n\t}\n\n\t// Ignore data URLs for images (commonly used legitimately)\n\tif (blockedUri.startsWith('data:') && violatedDirective.includes('img-src')) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n// --- HANDLERS ---\n\n/**\n * Handles CSP violation reports sent by browsers.\n */\nexport const POST: RequestHandler = async ({ request, getClientAddress }) => {\n\ttry {\n\t\t// Rate limiting check (prevent report spam)\n\t\tconst clientIp = getClientAddress();\n\n\t\t// Parse the violation report\n\t\tconst contentType = request.headers.get('content-type') || '';\n\t\tlet reportData: unknown;\n\n\t\tif (contentType.includes('application/csp-report')) {\n\t\t\t// Standard CSP report format\n\t\t\treportData = await request.json();\n\t\t} else if (contentType.includes('application/reports+json')) {\n\t\t\t// Newer Reporting API format\n\t\t\tconst reports = await request.json();\n\t\t\tif (Array.isArray(reports) && reports.length > 0) {\n\t\t\t\treportData = { 'csp-report': reports[0].body };\n\t\t\t}\n\t\t} else {\n\t\t\tlogger.warn(`CSP report with unexpected content-type: ${contentType}`);\n\t\t\treturn json({ error: 'Invalid content type' }, { status: 400 });\n\t\t}\n\n\t\t// Validate report format\n\t\tif (!isValidCSPReport(reportData)) {\n\t\t\tlogger.warn('Invalid CSP report format received', { data: reportData });\n\t\t\treturn json({ error: 'Invalid report format' }, { status: 400 });\n\t\t}\n\n\t\tconst report = reportData['csp-report'];\n\n\t\t// Check if this violation should be ignored\n\t\tif (shouldIgnoreViolation(report)) {\n\t\t\tlogger.trace(`Ignoring CSP violation: ${report['violated-directive']} - ${report['blocked-uri']}`);\n\t\t\treturn json({ status: 'ignored' }, { status: 200 });\n\t\t}\n\n\t\t// Log the violation for analysis\n\t\tconst logLevel = dev ? 'debug' : 'warn';\n\t\tlogger[logLevel]('CSP Violation Report', {\n\t\t\tdocumentUri: report['document-uri'],\n\t\t\tviolatedDirective: report['violated-directive'],\n\t\t\teffectiveDirective: report['effective-directive'],\n\t\t\tblockedUri: report['blocked-uri'],\n\t\t\tsourceFile: report['source-file'],\n\t\t\tlineNumber: report['line-number'],\n\t\t\tcolumnNumber: report['column-number'],\n\t\t\tscriptSample: report['script-sample']?.substring(0, 100), // Truncate for logging\n\t\t\tdisposition: report.disposition,\n\t\t\tclientIp,\n\t\t\tuserAgent: request.headers.get('user-agent')?.substring(0, 200)\n\t\t});\n\n\t\t// Track violation metrics\n\t\tmetricsService.incrementCSPViolations();\n\n\t\t// In production, you might want to:\n\t\t// - Store violations in database for analysis\n\t\t// - Send alerts for suspicious patterns\n\t\t// - Update CSP policies based on legitimate violations\n\n\t\tif (!dev) {\n\t\t\t// Example: Check for potential XSS attempts\n\t\t\tconst suspiciousPatterns = [/javascript:/i, /<script/i, /eval\\(/i, /setTimeout\\(/i, /setInterval\\(/i];\n\n\t\t\tconst blockedContent = report['script-sample'] || report['blocked-uri'] || '';\n\t\t\tconst isSuspicious = suspiciousPatterns.some((pattern) => pattern.test(blockedContent));\n\n\t\t\tif (isSuspicious) {\n\t\t\t\tlogger.error('Suspicious CSP violation detected - potential XSS attempt', {\n\t\t\t\t\tblockedUri: report['blocked-uri'],\n\t\t\t\t\tscriptSample: report['script-sample'],\n\t\t\t\t\tdocumentUri: report['document-uri'],\n\t\t\t\t\tclientIp,\n\t\t\t\t\tuserAgent: request.headers.get('user-agent')\n\t\t\t\t});\n\n\t\t\t\t// Here you could trigger additional security measures:\n\t\t\t\t// - Rate limit the client IP\n\t\t\t\t// - Send security alerts\n\t\t\t\t// - Log to security monitoring system\n\t\t\t}\n\t\t}\n\n\t\treturn json({ status: 'received' }, { status: 200 });\n\t} catch (error) {\n\t\tlogger.error('Error processing CSP report:', error);\n\t\treturn json({ error: 'Internal server error' }, { status: 500 });\n\t}\n};\n\n/**\n * Handle OPTIONS requests for CORS preflight.\n */\nexport const OPTIONS: RequestHandler = async () => {\n\treturn new Response(null, {\n\t\tstatus: 200,\n\t\theaders: {\n\t\t\t'Access-Control-Allow-Origin': '*',\n\t\t\t'Access-Control-Allow-Methods': 'POST, OPTIONS',\n\t\t\t'Access-Control-Allow-Headers': 'Content-Type',\n\t\t\t'Access-Control-Max-Age': '86400'\n\t\t}\n\t});\n};\n"],"names":[],"mappings":"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"}