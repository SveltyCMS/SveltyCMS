{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/systemPreferences/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/systemPreferences/+server.ts\n * @description Consolidated server-side API endpoint for managing system and user preferences.\n *\n * ### Usage\n * - GET /api/systemPreferences?key=... - Loads a specific preference value for the authenticated user.\n * - GET /api/systemPreferences?keys[]=...&keys[]=... - Loads multiple preference values for the user.\n * - POST /api/systemPreferences with `{ key, value }` - Saves a single preference for the user.\n * - POST /api/systemPreferences with `[{ key, value }, ...]` - Saves multiple preferences in a single request.\n * - DELETE /api/systemPreferences?key=... - Deletes a specific preference for the user.\n *\n * ### Features\n * - Unified endpoint for all user-scoped preferences (e.g., dashboard layouts, widget states).\n * - User authentication and role-based authorization.\n * - Robust validation using Valibot.\n * - Bulk operations for getting and setting multiple preferences.\n * - Consistent error handling and logging.\n */\n\nimport { dbAdapter } from '@shared/database/db';\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport * as v from 'valibot';\n\n// Validation Schemas\nconst PreferenceSchema = v.object({\n\tkey: v.pipe(v.string(), v.minLength(1, 'Preference key cannot be empty.')),\n\tvalue: v.any()\n});\n\nconst SetSinglePreferenceSchema = PreferenceSchema;\nconst SetMultiplePreferencesSchema = v.array(PreferenceSchema);\n\n// GET Handler for retrieving one or more preferences\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\tif (!locals.user) {\n\t\tlogger.warn('Unauthorized attempt to load system preferences');\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\t// Allow any authenticated user to read their own preferences\n\t// The endpoint is scoped to the current user (userId = locals.user._id)\n\t// so they cannot read other users' preferences or system-wide settings here.\n\n\tconst userId = locals.user._id;\n\tconst singleKey = url.searchParams.get('key');\n\tconst multipleKeys = url.searchParams.getAll('keys[]');\n\n\ttry {\n\t\t// Handle request for multiple keys\n\t\tif (multipleKeys.length > 0) {\n\t\t\tif (!dbAdapter) {\n\t\t\t\tthrow new Error('Database adapter not available');\n\t\t\t}\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst result = await dbAdapter.systemPreferences.getMany(multipleKeys, 'user', userId as any);\n\t\t\tif (!result.success) {\n\t\t\t\tthrow new Error(result.message);\n\t\t\t}\n\t\t\treturn json(result.data);\n\t\t}\n\n\t\t// Handle request for a single key\n\t\tif (singleKey) {\n\t\t\tif (!dbAdapter) {\n\t\t\t\tthrow new Error('Database adapter not available');\n\t\t\t}\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst result = await dbAdapter.systemPreferences.get(singleKey, 'user', userId as any);\n\t\t\tif (!result.success) {\n\t\t\t\t// Return a default value for layout preferences to prevent UI breakage\n\t\t\t\tif (singleKey.startsWith('dashboard.layout.')) {\n\t\t\t\t\treturn json({ id: singleKey, name: 'Default', preferences: [] });\n\t\t\t\t}\n\t\t\t\treturn json({ value: null }, { status: 404 });\n\t\t\t}\n\t\t\treturn json(result.data);\n\t\t}\n\n\t\treturn json({ error: \"Invalid request. Provide 'key' or 'keys[]' query parameter.\" }, { status: 400 });\n\t} catch (e) {\n\t\tconst errorMessage = e instanceof Error ? e.message : 'Unknown error';\n\t\tlogger.error(`Failed to load preferences for user ${userId}: ${errorMessage}`, e);\n\t\treturn json({ error: 'Failed to load preferences' }, { status: 500 });\n\t}\n};\n\n// POST Handler for creating or updating one or more preferences\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tif (!locals.user) {\n\t\tlogger.warn('Unauthorized attempt to save system preferences');\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\t// Allow any authenticated user to manage their own preferences\n\t// The endpoint is scoped to the current user (userId = locals.user._id)\n\t// so they cannot modify other users' preferences or system-wide settings here.\n\n\tconst data = await request.json();\n\tconst userId = locals.user._id;\n\n\ttry {\n\t\t// Try parsing as a single preference\n\t\tconst singleResult = v.safeParse(SetSinglePreferenceSchema, data);\n\t\tif (singleResult.success) {\n\t\t\tif (!dbAdapter) {\n\t\t\t\tthrow new Error('Database adapter not available');\n\t\t\t}\n\t\t\tconst { key, value } = singleResult.output;\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst result = await dbAdapter.systemPreferences.set(key, value, 'user', userId as any);\n\t\t\tif (!result.success) throw new Error(result.message);\n\t\t\treturn json({ success: true, message: `Preference '${key}' saved.` }, { status: 200 });\n\t\t}\n\n\t\t// Try parsing as multiple preferences\n\t\tconst multipleResult = v.safeParse(SetMultiplePreferencesSchema, data);\n\t\tif (multipleResult.success) {\n\t\t\tif (!dbAdapter) {\n\t\t\t\tthrow new Error('Database adapter not available');\n\t\t\t}\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst preferencesToSet = multipleResult.output.map((p) => ({ ...p, scope: 'user' as const, userId: userId as any }));\n\t\t\tconst result = await dbAdapter.systemPreferences.setMany(preferencesToSet);\n\t\t\tif (!result.success) throw new Error(result.message);\n\t\t\treturn json({ success: true, message: `${preferencesToSet.length} preferences saved.` }, { status: 200 });\n\t\t}\n\n\t\t// If neither schema matches\n\t\tconst issues = singleResult.issues || multipleResult.issues;\n\t\treturn json({ error: 'Invalid request data.', issues }, { status: 400 });\n\t} catch (e) {\n\t\tconst errorMessage = e instanceof Error ? e.message : 'Unknown error';\n\t\tlogger.error(`Failed to save preferences for user ${userId}: ${errorMessage}`, e);\n\t\treturn json({ error: 'Failed to save preferences' }, { status: 500 });\n\t}\n};\n\n// DELETE Handler for removing a preference\nexport const DELETE: RequestHandler = async ({ locals, url }) => {\n\tif (!locals.user) {\n\t\tlogger.warn('Unauthorized attempt to delete a system preference');\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\t// Allow any authenticated user to delete their own preferences\n\t// The endpoint is scoped to the current user (userId = locals.user._id)\n\t// so they cannot delete other users' preferences or system-wide settings here.\n\n\tconst key = url.searchParams.get('key');\n\tif (!key) {\n\t\treturn json({ error: \"Missing 'key' query parameter.\" }, { status: 400 });\n\t}\n\n\tconst userId = locals.user._id;\n\n\ttry {\n\t\tif (!dbAdapter) {\n\t\t\tthrow new Error('Database adapter not available');\n\t\t}\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tconst result = await dbAdapter.systemPreferences.delete(key, 'user', userId as any);\n\t\tif (!result.success) {\n\t\t\t// It might not be an error if the key didn't exist, but we log it just in case.\n\t\t\tlogger.warn(`Attempted to delete non-existent preference key '${key}' for user ${userId}`);\n\t\t}\n\t\treturn json({ success: true, message: `Preference '${key}' deleted.` }, { status: 200 });\n\t} catch (e) {\n\t\tconst errorMessage = e instanceof Error ? e.message : 'Unknown error';\n\t\tlogger.error(`Failed to delete preference '${key}' for user ${userId}: ${errorMessage}`, e);\n\t\treturn json({ error: 'Failed to delete preference' }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":"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"}