{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/content-structure/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/content-structure/+server.ts\n * @description Unified API endpoint for managing content structure metadata\n *\n * @example GET /api/content-structure?operation=getContentStructure\n *\n * #Features:\n * Lists all collections accessible to the current user\n * Filters collections based on user permissions\n * Provides collection metadata and configuration\n * Handles creation, updates (including reordering and parent changes), and deletion of content nodes.\n * Utilizes Redis caching for performance, now tenant-aware.\n */\nimport { browser } from '$app/environment';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { error, json, type RequestHandler } from '@sveltejs/kit';\n\nimport type { ContentNodeOperation } from '@cms-types';\n\n// Auth\nimport { contentManager } from '@content/ContentManager';\nimport { dbAdapter } from '@shared/database/db';\n\n// Redis\nimport { cacheService } from '@shared/database/CacheService';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nconst CACHE_TTL = 300; // 5 minutes\n\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\t// Authentication is handled by hooks.server.ts\n\tif (!user) {\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\ttry {\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant ID is required for this operation.');\n\t\t}\n\n\t\tconst action = url.searchParams.get('action');\n\t\tlogger.debug('GET request received', { action, tenantId }); // Try to get from Redis cache first\n\n\t\tif (!browser) {\n\t\t\tconst cacheKey = `api:content-structure:${tenantId || 'global'}:${action || 'default'}`;\n\t\t\tconst cached = await cacheService.get(cacheKey);\n\t\t\tif (cached) {\n\t\t\t\tlogger.debug('Returning cached data from Redis', { action, tenantId });\n\t\t\t\treturn json(cached);\n\t\t\t}\n\t\t}\n\n\t\tlet response;\n\n\t\tswitch (action) {\n\t\t\tcase 'getStructure': {\n\t\t\t\t// Return full structure with metadata\n\t\t\t\tconst contentNodes = await contentManager.getContentStructure();\n\t\t\t\tconst version = contentManager.getContentVersion();\n\n\t\t\t\tresponse = {\n\t\t\t\t\tcontentStructure: contentNodes,\n\t\t\t\t\tversion\n\t\t\t\t}; // Cache the response if Redis is enabled\n\n\t\t\t\tif (!browser) {\n\t\t\t\t\tconst cacheKey = `api:content-structure:${tenantId || 'global'}:${action}`;\n\t\t\t\t\tawait cacheService.set(cacheKey, response, CACHE_TTL);\n\t\t\t\t}\n\n\t\t\t\treturn json({ data: response });\n\t\t\t}\n\n\t\t\tcase 'getContentStructure': {\n\t\t\t\t// Return content nodes from database\n\t\t\t\tconst contentStructure = await contentManager.getContentStructure();\n\t\t\t\tconst version = contentManager.getContentVersion();\n\t\t\t\tlogger.info('Returning content structure from database', { tenantId });\n\t\t\t\tresponse = {\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tcontentNodes: contentStructure,\n\t\t\t\t\tversion\n\t\t\t\t};\n\t\t\t\tbreak; // Continue to caching and return\n\t\t\t}\n\n\t\t\tdefault:\n\t\t\t\tthrow error(400, 'Invalid action');\n\t\t} // Cache in Redis if available\n\n\t\tif (!browser) {\n\t\t\tconst cacheKey = `api:content-structure:${tenantId || 'global'}:${action || 'default'}`;\n\t\t\tawait cacheService.set(cacheKey, response, CACHE_TTL);\n\t\t}\n\t\treturn json(response);\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tlogger.error('Error in GET /api/content-structure:', message);\n\t\tthrow error(500, `Failed to process content structure request: ${message}`);\n\t}\n};\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\t// Authentication is handled by hooks.server.ts\n\tif (!user) {\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\ttry {\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant ID is required for this operation.');\n\t\t}\n\n\t\tconst data = await request.json();\n\t\tconst action = data.action;\n\t\tlogger.debug('POST request received', { data, action, tenantId });\n\n\t\tswitch (action) {\n\t\t\tcase 'reorderContentStructure': {\n\t\t\t\tconst { items }: { items: ContentNodeOperation[] } = data;\n\n\t\t\t\tif (!items || !Array.isArray(items)) {\n\t\t\t\t\tthrow error(400, 'Items array is required for reorderContentStructure');\n\t\t\t\t}\n\n\t\t\t\tconst updatedContentStructure = await contentManager.reorderContentNodes(items);\n\n\t\t\t\tif (!browser) {\n\t\t\t\t\tconst cachePattern = `api:content-structure:${tenantId || 'global'}:*`;\n\t\t\t\t\tawait cacheService.clearByPattern(cachePattern);\n\t\t\t\t\tlogger.debug('Cleared content-structure cache after reorder.', { tenantId });\n\t\t\t\t}\n\n\t\t\t\tlogger.info('Content structure reordered successfully', { tenantId });\n\t\t\t\treturn json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tcontentStructure: updatedContentStructure,\n\t\t\t\t\tmessage: 'Content structure reordered successfully'\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tcase 'updateContentStructure': {\n\t\t\t\tconst { items }: { items: ContentNodeOperation[] } = data;\n\n\t\t\t\tif (!items || !Array.isArray(items)) {\n\t\t\t\t\tthrow error(400, 'Items array is required for updateContentStructure');\n\t\t\t\t}\n\n\t\t\t\tconst updatedContentStructure = await contentManager.upsertContentNodes(items);\n\n\t\t\t\tif (!browser) {\n\t\t\t\t\tconst cachePattern = `api:content-structure:${tenantId || 'global'}:*`;\n\t\t\t\t\tawait cacheService.clearByPattern(cachePattern);\n\t\t\t\t\tlogger.debug('Cleared content-structure cache after update.', { tenantId });\n\t\t\t\t}\n\n\t\t\t\tlogger.info('Content structure metadata updated successfully', { tenantId });\n\t\t\t\treturn json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tcontentStructure: updatedContentStructure,\n\t\t\t\t\tmessage: 'Content structure metadata updated successfully'\n\t\t\t\t});\n\t\t\t}\n\t\t\tcase 'recompile': {\n\t\t\t\tif (!browser) {\n\t\t\t\t\tconst cachePattern = `api:content-structure:${tenantId || 'global'}:*`;\n\t\t\t\t\tawait cacheService.clearByPattern(cachePattern);\n\t\t\t\t\tlogger.debug('Cleared all content-structure related caches.', { tenantId });\n\t\t\t\t}\n\n\t\t\t\tawait contentManager.refresh(tenantId);\n\t\t\t\tlogger.info('Collections recompiled successfully', { tenantId });\n\t\t\t\treturn json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tmessage: 'Collections recompiled successfully'\n\t\t\t\t});\n\t\t\t}\n\t\t\tcase 'refreshCollections': {\n\t\t\t\t// Refresh collections from compiled files without recompiling\n\t\t\t\tif (!browser) {\n\t\t\t\t\tconst cachePattern = `api:content-structure:${tenantId || 'global'}:*`;\n\t\t\t\t\tawait cacheService.clearByPattern(cachePattern);\n\t\t\t\t\tlogger.debug('Cleared content-structure caches for refresh.', { tenantId });\n\t\t\t\t}\n\n\t\t\t\tawait contentManager.refresh(tenantId);\n\t\t\t\tconst contentStructure = await contentManager.getContentStructure();\n\n\t\t\t\tlogger.info('Collections refreshed from compiled files', { tenantId, collectionsFound: contentStructure?.length || 0 });\n\t\t\t\treturn json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tcontentNodes: contentStructure,\n\t\t\t\t\tmessage: 'Collections refreshed successfully'\n\t\t\t\t});\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tthrow error(400, 'Invalid action');\n\t\t}\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tlogger.error('Error in POST /api/content-structure:', message);\n\t\tthrow error(500, `Failed to process content structure request: ${message}`);\n\t}\n};\n\nexport const PUT: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\t// Authentication is handled by hooks.server.ts\n\tif (!user) {\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\ttry {\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant ID is required for this operation.');\n\t\t}\n\n\t\tconst { _id, updates } = await request.json();\n\n\t\tif (!_id || !updates) {\n\t\t\tthrow error(400, '_id and updates are required');\n\t\t}\n\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(503, 'Database adapter not available');\n\t\t}\n\n\t\tconst updateResult = await dbAdapter.content.nodes.update(_id, updates);\n\t\tif (!updateResult.success || !updateResult.data) {\n\t\t\tthrow error(404, 'Node not found');\n\t\t}\n\n\t\tconst updatedNode = updateResult.data;\n\n\t\t// Invalidate cache after a single node update\n\t\tif (!browser) {\n\t\t\tconst cachePattern = `api:content-structure:${tenantId || 'global'}:*`;\n\t\t\tawait cacheService.clearByPattern(cachePattern);\n\t\t\tlogger.debug(`Cleared content-structure cache after PUT update for node ${_id}.`, { tenantId });\n\t\t}\n\n\t\tawait contentManager.refresh(tenantId);\n\t\tlogger.info(`Content node ${_id} updated successfully`, { tenantId });\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'Content Structure updated successfully',\n\t\t\tdata: updatedNode\n\t\t});\n\t} catch (err) {\n\t\tconst errorMessage = err instanceof Error ? err.message : String(err);\n\t\tlogger.error('Error in PUT /api/content-structure:', errorMessage);\n\t\tthrow error(500, `Failed to update content structure: ${errorMessage}`);\n\t}\n};\n"],"names":[],"mappings":"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"}