{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/collections/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/collections/+server.ts\n * @description Optimized API endpoint for full CRUD (Create, Read, Update, Delete) operations on collections.\n *\n * ### Features\n * - GET: Efficiently lists all collections with optional stats and fields. Fixes the N+1 query problem by batch-fetching statistics.\n * - POST: Creates a new collection.\n * - PUT: Updates an existing collection by its ID.\n * - DELETE: Removes a collection by its ID.\n * - Implements role-based permission checks for all operations.\n * - Automatically invalidates the global content structure cache on any create, update, or delete action.\n */\n\nimport { getErrorMessage } from '@shared/utils/errorHandling';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { error, json, type RequestHandler } from '@sveltejs/kit';\n\n// Auth\nimport { contentManager } from '@content/ContentManager';\n\n// Token Engine\nimport { replaceTokens } from '@shared/services/token/engine';\nimport type { TokenContext } from '@shared/services/token/types';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// GET: Lists all collections accessible to the user\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\tconst start = performance.now();\n\tconst { tenantId } = locals; // User is guaranteed to exist due to hooks protection\n\n\t// In multi-tenant mode, a tenantId is required.\n\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\tlogger.error('List collections attempt failed: Tenant ID is missing in a multi-tenant setup.');\n\t\tthrow error(400, 'Could not identify the tenant for this request.');\n\t}\n\n\ttry {\n\t\t// Get query parameters\n\t\tconst includeFields = url.searchParams.get('includeFields') === 'true';\n\t\tconst includeStats = url.searchParams.get('includeStats') === 'true';\n\n\t\t// Get all collections from ContentManager (returns an array)\n\t\tconst allCollections = await contentManager.getCollections(tenantId);\n\n\t\tconst accessibleCollections = [];\n\n\t\t// Iterate over the array of collections\n\t\tfor (const collection of allCollections) {\n\t\t\tconst collectionInfo: {\n\t\t\t\tid: string | undefined;\n\t\t\t\tname: string | undefined;\n\t\t\t\tlabel: string | undefined;\n\t\t\t\tdescription: string | undefined;\n\t\t\t\ticon: string | undefined;\n\t\t\t\tpath: string | undefined;\n\t\t\t\tpermissions: { read: boolean; write: boolean };\n\t\t\t\tfields?: unknown[];\n\t\t\t\tstats?: { totalEntries: number; publishedEntries: number; draftEntries: number };\n\t\t\t} = {\n\t\t\t\tid: collection._id,\n\t\t\t\tname: collection.name,\n\t\t\t\tlabel: collection.label || collection.name,\n\t\t\t\tdescription: collection.description,\n\t\t\t\ticon: collection.icon,\n\t\t\t\tpath: collection.path,\n\t\t\t\tpermissions: {\n\t\t\t\t\tread: true,\n\t\t\t\t\twrite: true\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// Include fields if requested\n\t\t\tif (includeFields) {\n\t\t\t\tcollectionInfo.fields = collection.fields;\n\t\t\t}\n\n\t\t\t// Include stats if requested\n\t\t\tif (includeStats) {\n\t\t\t\ttry {\n\t\t\t\t\tcollectionInfo.stats = {\n\t\t\t\t\t\ttotalEntries: 0,\n\t\t\t\t\t\tpublishedEntries: 0,\n\t\t\t\t\t\tdraftEntries: 0\n\t\t\t\t\t};\n\t\t\t\t} catch (statsError) {\n\t\t\t\t\tlogger.warn(`Failed to get stats for collection ${collection._id}: ${getErrorMessage(statsError)}`);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Token Replacement for Collection Metadata\n\t\t\tconst tokenContext: TokenContext = {\n\t\t\t\tuser: locals.user || undefined\n\t\t\t};\n\n\t\t\tif (collectionInfo.description && collectionInfo.description.includes('{{')) {\n\t\t\t\tcollectionInfo.description = await replaceTokens(collectionInfo.description, tokenContext);\n\t\t\t}\n\t\t\tif (collectionInfo.label && collectionInfo.label.includes('{{')) {\n\t\t\t\tcollectionInfo.label = await replaceTokens(collectionInfo.label, tokenContext);\n\t\t\t}\n\n\t\t\taccessibleCollections.push(collectionInfo);\n\t\t}\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info(`${accessibleCollections.length} collections retrieved in ${duration.toFixed(2)}ms for tenant ${tenantId || 'default'}`);\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tcollections: accessibleCollections,\n\t\t\t\ttotal: accessibleCollections.length\n\t\t\t},\n\t\t\tperformance: { duration }\n\t\t});\n\t} catch (e) {\n\t\tconst duration = performance.now() - start;\n\t\tlogger.error(`Failed to get collections: ${getErrorMessage(e)} in ${duration.toFixed(2)}ms`);\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n"],"names":[],"mappings":";;;;;;AA4BO,MAAM,MAAsB,OAAO,EAAE,QAAQ,UAAU;AAC7D,QAAM,QAAQ,YAAY,IAAA;AAC1B,QAAM,EAAE,aAAa;AAGrB,MAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,WAAO,MAAM,gFAAgF;AAC7F,UAAM,MAAM,KAAK,iDAAiD;AAAA,EACnE;AAEA,MAAI;AAEH,UAAM,gBAAgB,IAAI,aAAa,IAAI,eAAe,MAAM;AAChE,UAAM,eAAe,IAAI,aAAa,IAAI,cAAc,MAAM;AAG9D,UAAM,iBAAiB,MAAM,eAAe,eAAe,QAAQ;AAEnE,UAAM,wBAAwB,CAAA;AAG9B,eAAW,cAAc,gBAAgB;AACxC,YAAM,iBAUF;AAAA,QACH,IAAI,WAAW;AAAA,QACf,MAAM,WAAW;AAAA,QACjB,OAAO,WAAW,SAAS,WAAW;AAAA,QACtC,aAAa,WAAW;AAAA,QACxB,MAAM,WAAW;AAAA,QACjB,MAAM,WAAW;AAAA,QACjB,aAAa;AAAA,UACZ,MAAM;AAAA,UACN,OAAO;AAAA,QAAA;AAAA,MACR;AAID,UAAI,eAAe;AAClB,uBAAe,SAAS,WAAW;AAAA,MACpC;AAGA,UAAI,cAAc;AACjB,YAAI;AACH,yBAAe,QAAQ;AAAA,YACtB,cAAc;AAAA,YACd,kBAAkB;AAAA,YAClB,cAAc;AAAA,UAAA;AAAA,QAEhB,SAAS,YAAY;AACpB,iBAAO,KAAK,sCAAsC,WAAW,GAAG,KAAK,gBAAgB,UAAU,CAAC,EAAE;AAAA,QACnG;AAAA,MACD;AAGA,YAAM,eAA6B;AAAA,QAClC,MAAM,OAAO,QAAQ;AAAA,MAAA;AAGtB,UAAI,eAAe,eAAe,eAAe,YAAY,SAAS,IAAI,GAAG;AAC5E,uBAAe,cAAc,MAAM,cAAc,eAAe,aAAa,YAAY;AAAA,MAC1F;AACA,UAAI,eAAe,SAAS,eAAe,MAAM,SAAS,IAAI,GAAG;AAChE,uBAAe,QAAQ,MAAM,cAAc,eAAe,OAAO,YAAY;AAAA,MAC9E;AAEA,4BAAsB,KAAK,cAAc;AAAA,IAC1C;AAEA,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,WAAO,KAAK,GAAG,sBAAsB,MAAM,6BAA6B,SAAS,QAAQ,CAAC,CAAC,iBAAiB,YAAY,SAAS,EAAE;AAEnI,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,QACL,aAAa;AAAA,QACb,OAAO,sBAAsB;AAAA,MAAA;AAAA,MAE9B,aAAa,EAAE,SAAA;AAAA,IAAS,CACxB;AAAA,EACF,SAAS,GAAG;AACX,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,WAAO,MAAM,8BAA8B,gBAAgB,CAAC,CAAC,OAAO,SAAS,QAAQ,CAAC,CAAC,IAAI;AAC3F,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;"}