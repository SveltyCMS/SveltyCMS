{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/collections/[collectionId]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/collections/[collectionId]/+server.ts\n * @description API endpoint for creating new collection entries\n *\n * @example POST /api/collections/:collectionId\n *\n * Features:\n * * ❌ GET removed - use +page.server.ts load() for SSR data fetching\n * * Performance-optimized entry creation with automatic metadata\n * * ModifyRequest support for widget-based data processing\n * * Multi-tenant support with automatic tenantId scoping\n */\n\nimport { json, error, type RequestHandler } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Databases\n// Auth\nimport { contentManager } from '@content/ContentManager';\nimport { modifyRequest } from '@api/collections/modifyRequest';\nimport { cacheService } from '@shared/database/CacheService';\n\n// Types\nimport type { FieldInstance } from '@cms-types';\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// ❌ REMOVED: GET handler - SSR data loading should use +page.server.ts load() function\n// This prevents redundant data fetching and improves SSR performance.\n// Use the load() function in +page.server.ts for initial page loads,\n// and client-side API calls only for dynamic updates (create/update/delete).\n\n// POST: Creates a new entry in a collection\nexport const POST: RequestHandler = async ({ locals, params, request }) => {\n\tconst startTime = performance.now();\n\tconst endpoint = `POST /api/collections/${params.collectionId}`;\n\tconst { user, tenantId } = locals;\n\n\tlogger.info(`${endpoint} - Request started`, {\n\t\tuserId: user?._id,\n\t\tuserEmail: user?.email,\n\t\ttenantId\n\t});\n\n\ttry {\n\t\tconst schema = await contentManager.getCollectionById(params.collectionId, tenantId);\n\t\tif (!schema) {\n\t\t\tlogger.warn(`${endpoint} - Collection not found`, {\n\t\t\t\tcollectionId: params.collectionId,\n\t\t\t\tuserId: user?._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\tthrow error(404, 'Collection not found');\n\t\t}\n\n\t\tlet body;\n\t\tconst contentType = request.headers.get('content-type');\n\n\t\tif (contentType?.includes('application/json')) {\n\t\t\tbody = await request.json();\n\t\t} else if (contentType?.includes('multipart/form-data')) {\n\t\t\tconst formData = await request.formData();\n\t\t\tbody = Object.fromEntries(formData.entries());\n\t\t} else {\n\t\t\tthrow error(400, 'Unsupported content type');\n\t\t}\n\n\t\t// Check if data is nested under a 'data' property (handles both direct and nested payloads)\n\t\t// This prevents \"last_name is required\" errors when data comes from different sources\n\t\tconst sourceData = body.data && typeof body.data === 'object' ? body.data : body;\n\n\t\tlogger.trace('Data extraction completed', {\n\t\t\thasNestedData: !!body.data,\n\t\t\tfieldCount: Object.keys(sourceData).length,\n\t\t\tfields: Object.keys(sourceData)\n\t\t});\n\n\t\tif (!user) throw error(401, 'Unauthorized');\n\n\t\t// Initialize database adapter\n\t\tconst dbAdapter = locals.dbAdapter;\n\t\tif (!dbAdapter) throw error(503, 'Service Unavailable: Database service is not properly initialized');\n\n\t\tif (!schema._id) throw error(500, 'Collection ID is missing');\n\t\tconst collectionModel = await dbAdapter.collection.getModel(schema._id);\n\n\t\t// Prepare entry data with user ID\n\t\tconst entryData = {\n\t\t\t...sourceData, // Use extracted source data directly\n\t\t\t...(getPrivateSettingSync('MULTI_TENANT') && { tenantId }), // Add tenantId\n\t\t\tcreatedBy: user._id,\n\t\t\tupdatedBy: user._id,\n\t\t\tstatus: sourceData.status || schema.status || 'draft' // Respect collection's default status\n\t\t};\n\n\t\t// Apply modifyRequest for pre-processing\n\t\tconst dataArray = [entryData];\n\n\t\ttry {\n\t\t\tawait modifyRequest({\n\t\t\t\tdata: dataArray,\n\t\t\t\tfields: schema.fields as FieldInstance[],\n\t\t\t\tcollection: collectionModel,\n\t\t\t\tuser,\n\t\t\t\ttype: 'POST',\n\t\t\t\ttenantId\n\t\t\t});\n\t\t} catch (modifyError) {\n\t\t\tlogger.warn(`${endpoint} - ModifyRequest pre-processing failed`, {\n\t\t\t\tcollection: schema._id,\n\t\t\t\terror: (modifyError as Error).message,\n\t\t\t\tuserId: user._id\n\t\t\t});\n\t\t}\n\n\t\tif (!schema._id) throw error(500, 'Collection ID is missing');\n\t\tconst collectionName = `collection_${schema._id}`;\n\t\tif (!dbAdapter) throw error(503, 'Database adapter not initialized');\n\t\tconst result = await dbAdapter.crud.insert(collectionName, dataArray[0]);\n\n\t\tif (!result.success) {\n\t\t\tconst errorMessage = result.error.message || '';\n\t\t\t// Handle validation errors specifically\n\t\t\tif (errorMessage.includes('validation failed') || result.error.code === 'INSERT_ERROR') {\n\t\t\t\t// Log warning but return 400 to client so it can display the error\n\t\t\t\tlogger.warn(`${endpoint} - Validation failed`, { error: errorMessage });\n\t\t\t\tthrow error(400, errorMessage);\n\t\t\t}\n\t\t\tthrow new Error(errorMessage);\n\t\t}\n\n\t\tif (!result.data) {\n\t\t\tthrow error(500, 'Failed to insert entry');\n\t\t}\n\n\t\tconst duration = performance.now() - startTime;\n\t\tconst responseData = { success: true, data: result.data, performance: { duration } };\n\n\t\t// Invalidate server-side page cache for this collection\n\t\t// Use the statically imported cacheService\n\t\tconst cachePattern = `collection:${schema._id}:*`;\n\n\t\tlogger.debug(`${endpoint} - Invalidating cache pattern: ${cachePattern}`);\n\n\t\tawait cacheService.clearByPattern(cachePattern, tenantId).catch((err) => {\n\t\t\tlogger.warn('Failed to invalidate page cache after POST', { pattern: cachePattern, error: err });\n\t\t});\n\n\t\t// Also invalidate specific caches in ContentManager to ensure schema updates are reflected\n\t\tawait contentManager.invalidateSpecificCaches([schema.path || '', schema._id as string].filter(Boolean));\n\n\t\t// Publish entryUpdated event\n\t\ttry {\n\t\t\t// Dynamic import to avoid circular dependencies or initialization issues if any\n\t\t\tconst { pubSub } = await import('@shared/services/pubSub');\n\t\t\tpubSub.publish('entryUpdated', {\n\t\t\t\tcollection: schema.name || params.collectionId,\n\t\t\t\tid: result.data._id,\n\t\t\t\taction: 'create',\n\t\t\t\tdata: result.data,\n\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\tuser: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername: user.username,\n\t\t\t\t\temail: user.email\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (pubSubError) {\n\t\t\tlogger.warn('Failed to publish entryUpdated event', { error: pubSubError });\n\t\t}\n\n\t\tlogger.info(`${endpoint} - Entry created successfully`, {\n\t\t\tduration: `${duration.toFixed(2)}ms`,\n\t\t\tcollection: schema._id,\n\t\t\tuserId: user?._id,\n\t\t\ttenantId,\n\t\t\tentryId: result.data._id\n\t\t});\n\n\t\treturn json(responseData, { status: 201 });\n\t} catch (e) {\n\t\tconst duration = performance.now() - startTime;\n\t\tconst userId = locals.user?._id;\n\n\t\tif ((e as any).status) {\n\t\t\tlogger.warn(`${endpoint} - Request failed`, {\n\t\t\t\tstatus: (e as any).status,\n\t\t\t\tmessage: (e as any).body?.message,\n\t\t\t\tduration: `${duration.toFixed(2)}ms`,\n\t\t\t\tuserId,\n\t\t\t\tcollection: params.collectionId\n\t\t\t});\n\t\t\tthrow e;\n\t\t}\n\n\t\tlogger.error(`${endpoint} - Unexpected error`, {\n\t\t\terror: (e as any).message,\n\t\t\tstack: (e as any).stack,\n\t\t\tduration: `${duration.toFixed(2)}ms`,\n\t\t\tuserId,\n\t\t\tcollection: params.collectionId\n\t\t});\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n"],"names":[],"mappings":"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"}