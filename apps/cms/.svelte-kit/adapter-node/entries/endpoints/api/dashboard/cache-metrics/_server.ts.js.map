{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/dashboard/cache-metrics/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/dashboard/cache-metrics/+server.ts\n * @description API endpoint for cache performance metrics\n * Returns cache hit rates, category statistics, and tenant metrics for dashboard monitoring\n */\n\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { cacheMetrics } from '@shared/database/CacheMetrics';\nimport { logger } from '@shared/utils/logger.server';\n\nexport const GET: RequestHandler = async () => {\n\ttry {\n\t\t// Get cache metrics snapshot\n\t\tconst snapshot = cacheMetrics.getSnapshot();\n\n\t\t// Get recent events (last 20)\n\t\tconst recentEvents = cacheMetrics.getRecentEvents(20);\n\n\t\t// Filter recent misses\n\t\tconst recentMisses = recentEvents\n\t\t\t.filter((event) => event.type === 'miss')\n\t\t\t.slice(-10) // Last 10 misses\n\t\t\t.map((event) => ({\n\t\t\t\tkey: event.key,\n\t\t\t\tcategory: event.category,\n\t\t\t\ttenantId: event.tenantId,\n\t\t\t\ttimestamp: event.timestamp\n\t\t\t})); // Return formatted metrics\n\t\treturn json({\n\t\t\toverall: {\n\t\t\t\thits: snapshot.hits,\n\t\t\t\tmisses: snapshot.misses,\n\t\t\t\tsets: 0, // Not tracked in current implementation\n\t\t\t\tdeletes: 0, // Not tracked in current implementation\n\t\t\t\thitRate: snapshot.hitRate,\n\t\t\t\ttotalOperations: snapshot.totalRequests\n\t\t\t},\n\t\t\tbyCategory: Object.entries(snapshot.byCategory || {}).reduce(\n\t\t\t\t(acc, [category, stats]) => {\n\t\t\t\t\tacc[category] = {\n\t\t\t\t\t\thits: stats.hits,\n\t\t\t\t\t\tmisses: stats.misses,\n\t\t\t\t\t\thitRate: stats.hitRate\n\t\t\t\t\t};\n\t\t\t\t\treturn acc;\n\t\t\t\t},\n\t\t\t\t{} as Record<string, { hits: number; misses: number; hitRate: number }>\n\t\t\t),\n\t\t\tbyTenant: Object.entries(snapshot.byTenant || {}).reduce(\n\t\t\t\t(acc, [tenant, stats]) => {\n\t\t\t\t\tacc[tenant] = {\n\t\t\t\t\t\thits: stats.hits,\n\t\t\t\t\t\tmisses: stats.misses,\n\t\t\t\t\t\thitRate: stats.hitRate\n\t\t\t\t\t};\n\t\t\t\t\treturn acc;\n\t\t\t\t},\n\t\t\t\t{} as Record<string, { hits: number; misses: number; hitRate: number }>\n\t\t\t),\n\t\t\trecentMisses,\n\t\t\ttimestamp: Date.now()\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Error fetching cache metrics:', error);\n\t\treturn json(\n\t\t\t{\n\t\t\t\terror: 'Failed to fetch cache metrics',\n\t\t\t\toverall: {\n\t\t\t\t\thits: 0,\n\t\t\t\t\tmisses: 0,\n\t\t\t\t\tsets: 0,\n\t\t\t\t\tdeletes: 0,\n\t\t\t\t\thitRate: 0,\n\t\t\t\t\ttotalOperations: 0\n\t\t\t\t},\n\t\t\t\tbyCategory: {},\n\t\t\t\tbyTenant: {},\n\t\t\t\ttimestamp: Date.now()\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n\n/**\n * Reset cache metrics endpoint (admin only)\n * DELETE /api/dashboard/cache-metrics\n */\nexport const DELETE: RequestHandler = async () => {\n\ttry {\n\t\t// TODO: Add authorization check\n\t\t// if (!locals.user?.isAdmin) {\n\t\t//   return json({ error: 'Unauthorized' }, { status: 403 });\n\t\t// }\n\n\t\tcacheMetrics.reset();\n\t\tlogger.info('Cache metrics reset successfully');\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'Cache metrics reset successfully'\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Error resetting cache metrics:', error);\n\t\treturn json({ error: 'Failed to reset cache metrics' }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":";;;AAWO,MAAM,MAAsB,YAAY;AAC9C,MAAI;AAEH,UAAM,WAAW,aAAa,YAAA;AAG9B,UAAM,eAAe,aAAa,gBAAgB,EAAE;AAGpD,UAAM,eAAe,aACnB,OAAO,CAAC,UAAU,MAAM,SAAS,MAAM,EACvC,MAAM,GAAG,EACT,IAAI,CAAC,WAAW;AAAA,MAChB,KAAK,MAAM;AAAA,MACX,UAAU,MAAM;AAAA,MAChB,UAAU,MAAM;AAAA,MAChB,WAAW,MAAM;AAAA,IAAA,EAChB;AACH,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,QACR,MAAM,SAAS;AAAA,QACf,QAAQ,SAAS;AAAA,QACjB,MAAM;AAAA;AAAA,QACN,SAAS;AAAA;AAAA,QACT,SAAS,SAAS;AAAA,QAClB,iBAAiB,SAAS;AAAA,MAAA;AAAA,MAE3B,YAAY,OAAO,QAAQ,SAAS,cAAc,CAAA,CAAE,EAAE;AAAA,QACrD,CAAC,KAAK,CAAC,UAAU,KAAK,MAAM;AAC3B,cAAI,QAAQ,IAAI;AAAA,YACf,MAAM,MAAM;AAAA,YACZ,QAAQ,MAAM;AAAA,YACd,SAAS,MAAM;AAAA,UAAA;AAEhB,iBAAO;AAAA,QACR;AAAA,QACA,CAAA;AAAA,MAAC;AAAA,MAEF,UAAU,OAAO,QAAQ,SAAS,YAAY,CAAA,CAAE,EAAE;AAAA,QACjD,CAAC,KAAK,CAAC,QAAQ,KAAK,MAAM;AACzB,cAAI,MAAM,IAAI;AAAA,YACb,MAAM,MAAM;AAAA,YACZ,QAAQ,MAAM;AAAA,YACd,SAAS,MAAM;AAAA,UAAA;AAEhB,iBAAO;AAAA,QACR;AAAA,QACA,CAAA;AAAA,MAAC;AAAA,MAEF;AAAA,MACA,WAAW,KAAK,IAAA;AAAA,IAAI,CACpB;AAAA,EACF,SAAS,OAAO;AACf,WAAO,MAAM,iCAAiC,KAAK;AACnD,WAAO;AAAA,MACN;AAAA,QACC,OAAO;AAAA,QACP,SAAS;AAAA,UACR,MAAM;AAAA,UACN,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,SAAS;AAAA,UACT,SAAS;AAAA,UACT,iBAAiB;AAAA,QAAA;AAAA,QAElB,YAAY,CAAA;AAAA,QACZ,UAAU,CAAA;AAAA,QACV,WAAW,KAAK,IAAA;AAAA,MAAI;AAAA,MAErB,EAAE,QAAQ,IAAA;AAAA,IAAI;AAAA,EAEhB;AACD;AAMO,MAAM,SAAyB,YAAY;AACjD,MAAI;AAMH,iBAAa,MAAA;AACb,WAAO,KAAK,kCAAkC;AAE9C,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,OAAO;AACf,WAAO,MAAM,kCAAkC,KAAK;AACpD,WAAO,KAAK,EAAE,OAAO,gCAAA,GAAmC,EAAE,QAAQ,KAAK;AAAA,EACxE;AACD;"}