{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/media/manipulate/[id]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/manipulate/[id]/+server.ts\n * @description API endpoint for manipulating media files (e.g., focal point, watermark).\n */\n\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { dbAdapter } from '@shared/database/db';\nimport { MediaService } from '@shared/services/MediaService.server';\nimport { logger } from '@shared/utils/logger.server';\n\n// Helper function to get MediaService instance\nfunction getMediaService(): MediaService {\n\tif (!dbAdapter) {\n\t\tthrow new Error('Database adapter is not initialized');\n\t}\n\ttry {\n\t\tconst service = new MediaService(dbAdapter);\n\t\treturn service;\n\t} catch (err) {\n\t\tconst message = `Failed to initialize MediaService: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow new Error(message);\n\t}\n}\n\nexport const POST: RequestHandler = async ({ request, params, locals }) => {\n\tconst { user, tenantId } = locals;\n\tconst { id } = params;\n\n\tif (!user) {\n\t\treturn json({ success: false, error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\tif (!id) {\n\t\treturn json({ success: false, error: 'Media ID not specified' }, { status: 400 });\n\t}\n\n\ttry {\n\t\tconst manipulations = await request.json();\n\n\t\tif (!manipulations || typeof manipulations !== 'object') {\n\t\t\treturn json({ success: false, error: 'Invalid manipulation data' }, { status: 400 });\n\t\t}\n\n\t\tconst mediaService = getMediaService();\n\n\t\t// Use updateMedia instead of manipulateMedia\n\t\tawait mediaService.updateMedia(id, manipulations);\n\n\t\tif (!locals.user) {\n\t\t\treturn json({ success: false, error: 'Unauthorized' }, { status: 401 });\n\t\t}\n\n\t\t// Fetch the updated media to return\n\t\tconst updatedMedia = await mediaService.getMedia(id, locals.user, locals.roles);\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: updatedMedia\n\t\t});\n\t} catch (err) {\n\t\tconst message = `Error manipulating media: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { mediaId: id, tenantId });\n\t\treturn json({ success: false, error: message }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":";;;;AAYA,SAAS,kBAAgC;AACxC,MAAI,CAAC,WAAW;AACf,UAAM,IAAI,MAAM,qCAAqC;AAAA,EACtD;AACA,MAAI;AACH,UAAM,UAAU,IAAI,aAAa,SAAS;AAC1C,WAAO;AAAA,EACR,SAAS,KAAK;AACb,UAAM,UAAU,sCAAsC,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACtG,WAAO,MAAM,OAAO;AACpB,UAAM,IAAI,MAAM,OAAO;AAAA,EACxB;AACD;AAEO,MAAM,OAAuB,OAAO,EAAE,SAAS,QAAQ,aAAa;AAC1E,QAAM,EAAE,MAAM,SAAA,IAAa;AAC3B,QAAM,EAAE,OAAO;AAEf,MAAI,CAAC,MAAM;AACV,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,kBAAkB,EAAE,QAAQ,KAAK;AAAA,EACvE;AAEA,MAAI,CAAC,IAAI;AACR,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,4BAA4B,EAAE,QAAQ,KAAK;AAAA,EACjF;AAEA,MAAI;AACH,UAAM,gBAAgB,MAAM,QAAQ,KAAA;AAEpC,QAAI,CAAC,iBAAiB,OAAO,kBAAkB,UAAU;AACxD,aAAO,KAAK,EAAE,SAAS,OAAO,OAAO,+BAA+B,EAAE,QAAQ,KAAK;AAAA,IACpF;AAEA,UAAM,eAAe,gBAAA;AAGrB,UAAM,aAAa,YAAY,IAAI,aAAa;AAEhD,QAAI,CAAC,OAAO,MAAM;AACjB,aAAO,KAAK,EAAE,SAAS,OAAO,OAAO,kBAAkB,EAAE,QAAQ,KAAK;AAAA,IACvE;AAGA,UAAM,eAAe,MAAM,aAAa,SAAS,IAAI,OAAO,MAAM,OAAO,KAAK;AAE9E,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,IAAA,CACN;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,6BAA6B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC7F,WAAO,MAAM,SAAS,EAAE,SAAS,IAAI,UAAU;AAC/C,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,WAAW,EAAE,QAAQ,KAAK;AAAA,EAChE;AACD;"}