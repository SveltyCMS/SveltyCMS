{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/media/transform/[...path]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/transform/[...path]/+server.ts\n * @description On-the-fly image transformation API endpoint.\n *\n * @example\n * /api/media/transform/path/to/image.jpg?w=800&h=600&fit=cover&q=80&format=webp\n *\n * @features\n * - Resizing (w, h)\n * - Cropping (fit: cover, contain, fill, inside, outside)\n * - Quality adjustment (q)\n * - Format conversion (format: jpeg, png, webp, avif)\n * - Caching headers for CDN and browser optimization\n */\n\nimport { error } from '@sveltejs/kit';\nimport sharp from 'sharp';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestHandler } from './$types';\n\nconst MEDIA_ROOT = path.resolve(process.cwd(), 'mediaFolder');\n\nexport const GET: RequestHandler = async ({ params, url }) => {\n\tconst imagePath = params.path;\n\tconst fullPath = path.join(MEDIA_ROOT, imagePath);\n\n\ttry {\n\t\t// --- Security Check: Ensure path is within the media root ---\n\t\tif (!path.resolve(fullPath).startsWith(MEDIA_ROOT)) {\n\t\t\tthrow error(403, 'Forbidden: Access outside of media folder is not allowed.');\n\t\t}\n\n\t\t// --- Read original image from storage ---\n\t\tconst imageBuffer = await fs.readFile(fullPath);\n\t\tlet transformer = sharp(imageBuffer);\n\n\t\t// --- Parse Transformation Parameters ---\n\t\tconst width = url.searchParams.get('w') ? parseInt(url.searchParams.get('w')!, 10) : undefined;\n\t\tconst height = url.searchParams.get('h') ? parseInt(url.searchParams.get('h')!, 10) : undefined;\n\t\tconst quality = url.searchParams.get('q') ? parseInt(url.searchParams.get('q')!, 10) : 80;\n\t\tconst fit = url.searchParams.get('fit') as keyof sharp.FitEnum | undefined;\n\t\tconst format = url.searchParams.get('format') as keyof sharp.FormatEnum | undefined;\n\n\t\t// --- Parse Focal Point (e.g., ?focal=60,30 for 60% from left, 30% from top) ---\n\t\tconst focalParam = url.searchParams.get('focal');\n\t\tlet focalPosition: string | undefined;\n\t\tif (focalParam) {\n\t\t\tconst [x, y] = focalParam.split(',').map(Number);\n\t\t\tif (!isNaN(x) && !isNaN(y) && x >= 0 && x <= 100 && y >= 0 && y <= 100) {\n\t\t\t\t// Sharp accepts position as percentage string for attention point\n\t\t\t\tfocalPosition = `${x}% ${y}%`;\n\t\t\t}\n\t\t}\n\n\t\t// --- Apply Transformations ---\n\t\tif (width || height || fit) {\n\t\t\ttransformer = transformer.resize(width, height, {\n\t\t\t\tfit: fit || 'cover',\n\t\t\t\tposition: focalPosition || 'centre' // Use focal point if provided, else center\n\t\t\t});\n\t\t}\n\n\t\t// --- Apply Format Conversion ---\n\t\tlet mimeType = `image/${format || 'jpeg'}`;\n\t\tif (format) {\n\t\t\ttransformer = transformer.toFormat(format, { quality });\n\t\t} else if (fullPath.endsWith('.png')) {\n\t\t\ttransformer = transformer.png({ quality });\n\t\t\tmimeType = 'image/png';\n\t\t} else if (fullPath.endsWith('.webp')) {\n\t\t\ttransformer = transformer.webp({ quality });\n\t\t\tmimeType = 'image/webp';\n\t\t} else {\n\t\t\ttransformer = transformer.jpeg({ quality });\n\t\t\tmimeType = 'image/jpeg';\n\t\t}\n\n\t\t// --- Generate Transformed Image Buffer ---\n\t\tconst transformedBuffer = await transformer.toBuffer();\n\n\t\t// --- Return Response with Caching Headers ---\n\t\treturn new Response(transformedBuffer as any, {\n\t\t\theaders: {\n\t\t\t\t'Content-Type': mimeType,\n\t\t\t\t'Content-Length': transformedBuffer.length.toString(),\n\t\t\t\t'Cache-Control': 'public, max-age=31536000, immutable' // Cache for 1 year\n\t\t\t}\n\t\t});\n\t} catch (err) {\n\t\tlogger.error(`Failed to transform image at path: ${imagePath}`, err);\n\n\t\tif (err instanceof Error && (err as any).code === 'ENOENT') {\n\t\t\tthrow error(404, 'Image not found.');\n\t\t}\n\t\t// Re-throw other framework errors\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, 'Error transforming image.');\n\t}\n};\n"],"names":[],"mappings":";;;;;AAsBA,MAAM,aAAa,KAAK,QAAQ,QAAQ,IAAA,GAAO,aAAa;AAErD,MAAM,MAAsB,OAAO,EAAE,QAAQ,UAAU;AAC7D,QAAM,YAAY,OAAO;AACzB,QAAM,WAAW,KAAK,KAAK,YAAY,SAAS;AAEhD,MAAI;AAEH,QAAI,CAAC,KAAK,QAAQ,QAAQ,EAAE,WAAW,UAAU,GAAG;AACnD,YAAM,MAAM,KAAK,2DAA2D;AAAA,IAC7E;AAGA,UAAM,cAAc,MAAM,GAAG,SAAS,QAAQ;AAC9C,QAAI,cAAc,MAAM,WAAW;AAGnC,UAAM,QAAQ,IAAI,aAAa,IAAI,GAAG,IAAI,SAAS,IAAI,aAAa,IAAI,GAAG,GAAI,EAAE,IAAI;AACrF,UAAM,SAAS,IAAI,aAAa,IAAI,GAAG,IAAI,SAAS,IAAI,aAAa,IAAI,GAAG,GAAI,EAAE,IAAI;AACtF,UAAM,UAAU,IAAI,aAAa,IAAI,GAAG,IAAI,SAAS,IAAI,aAAa,IAAI,GAAG,GAAI,EAAE,IAAI;AACvF,UAAM,MAAM,IAAI,aAAa,IAAI,KAAK;AACtC,UAAM,SAAS,IAAI,aAAa,IAAI,QAAQ;AAG5C,UAAM,aAAa,IAAI,aAAa,IAAI,OAAO;AAC/C,QAAI;AACJ,QAAI,YAAY;AACf,YAAM,CAAC,GAAG,CAAC,IAAI,WAAW,MAAM,GAAG,EAAE,IAAI,MAAM;AAC/C,UAAI,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK,KAAK,KAAK,KAAK,OAAO,KAAK,KAAK,KAAK,KAAK;AAEvE,wBAAgB,GAAG,CAAC,KAAK,CAAC;AAAA,MAC3B;AAAA,IACD;AAGA,QAAI,SAAS,UAAU,KAAK;AAC3B,oBAAc,YAAY,OAAO,OAAO,QAAQ;AAAA,QAC/C,KAAK,OAAO;AAAA,QACZ,UAAU,iBAAiB;AAAA;AAAA,MAAA,CAC3B;AAAA,IACF;AAGA,QAAI,WAAW,SAAS,UAAU,MAAM;AACxC,QAAI,QAAQ;AACX,oBAAc,YAAY,SAAS,QAAQ,EAAE,SAAS;AAAA,IACvD,WAAW,SAAS,SAAS,MAAM,GAAG;AACrC,oBAAc,YAAY,IAAI,EAAE,QAAA,CAAS;AACzC,iBAAW;AAAA,IACZ,WAAW,SAAS,SAAS,OAAO,GAAG;AACtC,oBAAc,YAAY,KAAK,EAAE,QAAA,CAAS;AAC1C,iBAAW;AAAA,IACZ,OAAO;AACN,oBAAc,YAAY,KAAK,EAAE,QAAA,CAAS;AAC1C,iBAAW;AAAA,IACZ;AAGA,UAAM,oBAAoB,MAAM,YAAY,SAAA;AAG5C,WAAO,IAAI,SAAS,mBAA0B;AAAA,MAC7C,SAAS;AAAA,QACR,gBAAgB;AAAA,QAChB,kBAAkB,kBAAkB,OAAO,SAAA;AAAA,QAC3C,iBAAiB;AAAA;AAAA,MAAA;AAAA,IAClB,CACA;AAAA,EACF,SAAS,KAAK;AACb,WAAO,MAAM,sCAAsC,SAAS,IAAI,GAAG;AAEnE,QAAI,eAAe,SAAU,IAAY,SAAS,UAAU;AAC3D,YAAM,MAAM,KAAK,kBAAkB;AAAA,IACpC;AAEA,QAAI,eAAe,SAAS,YAAY,KAAK;AAC5C,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,2BAA2B;AAAA,EAC7C;AACD;"}