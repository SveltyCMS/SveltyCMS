{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/media/ai-tag/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/ai-tag/+server.ts\n * @description API endpoint for generating AI-powered tags for images.\n */\n\nimport { json, error } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestHandler } from './$types';\nimport type { MediaItem } from '@shared/database/dbInterface';\nimport { dbAdapter } from '@shared/database/db';\n\n// Mock function for AI service - REPLACE WITH ACTUAL API CALL\nasync function getTagsFromAIService(imageUrl: string): Promise<string[]> {\n\tlogger.info(`[MOCK] Fetching AI tags for image: ${imageUrl}`);\n\t// In a real implementation, you would call a service like Google Cloud Vision API here.\n\t// Example:\n\t// const vision = require('@google-cloud/vision');\n\t// const client = new vision.ImageAnnotatorClient();\n\t// const [result] = await client.labelDetection(imageUrl);\n\t// const labels = result.labelAnnotations.map(label => label.description);\n\t// return labels;\n\n\t// Returning mock data for demonstration\n\tconst mockTags = ['landscape', 'nature', 'sky', 'mountain', 'travel', 'scenic'];\n\tawait new Promise((resolve) => setTimeout(resolve, 1500)); // Simulate network delay\n\treturn mockTags.slice(0, Math.floor(Math.random() * (mockTags.length + 1)));\n}\n\nexport const POST: RequestHandler = async ({ request }) => {\n\tconst { mediaId } = await request.json();\n\n\tif (!mediaId) {\n\t\tthrow error(400, 'mediaId is required.');\n\t}\n\n\ttry {\n\t\t// 1. Fetch the media item from the database\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database adapter is not initialized.');\n\t\t}\n\t\tconst mediaResult = await dbAdapter.crud.findOne<MediaItem>('MediaItem', { _id: mediaId as any });\n\t\tif (!mediaResult.success || !mediaResult.data) {\n\t\t\tthrow error(404, 'Media item not found.');\n\t\t}\n\t\tconst mediaItem = mediaResult.data;\n\n\t\t// 2. Ensure it's an image\n\t\tif (!mediaItem.mimeType.startsWith('image/')) {\n\t\t\tthrow error(400, 'AI tagging is only available for images.');\n\t\t}\n\n\t\t// 3. Call the AI tagging service (mocked for now)\n\t\t// We use the direct public URL of the original image\n\t\tconst imageUrl = mediaItem.thumbnails?.lg?.url || mediaItem.path;\n\t\tconst aiTags = await getTagsFromAIService(imageUrl);\n\n\t\tif (!aiTags || aiTags.length === 0) {\n\t\t\treturn json({ success: true, message: 'No new tags were generated.', data: mediaItem });\n\t\t}\n\n\t\t// 4. Update the media item's metadata with the new tags\n\t\tconst existingTags = (mediaItem.metadata.tags as string[]) || [];\n\t\tconst uniqueNewTags = aiTags.filter((tag) => !existingTags.includes(tag.toLowerCase()));\n\n\t\tif (uniqueNewTags.length === 0) {\n\t\t\treturn json({ success: true, message: 'AI tags already exist.', data: mediaItem });\n\t\t}\n\n\t\tconst updatedTags = [...existingTags, ...uniqueNewTags];\n\n\t\tconst updateResult = await dbAdapter.crud.update<MediaItem>('MediaItem', mediaItem._id, {\n\t\t\tmetadata: {\n\t\t\t\t...mediaItem.metadata,\n\t\t\t\ttags: updatedTags\n\t\t\t}\n\t\t});\n\n\t\tif (!updateResult.success) {\n\t\t\tthrow new Error('Failed to save new tags to the database.');\n\t\t}\n\n\t\t// 5. Return the updated media item\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: `Successfully added ${uniqueNewTags.length} new AI-powered tags.`,\n\t\t\tdata: updateResult.data\n\t\t});\n\t} catch (err) {\n\t\tlogger.error(`Failed to generate AI tags for mediaId: ${mediaId}`, err);\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\tthrow err;\n\t\t}\n\t\tthrow error(500, 'An unexpected error occurred while generating AI tags.');\n\t}\n};\n"],"names":[],"mappings":";;;AAYA,eAAe,qBAAqB,UAAqC;AACxE,SAAO,KAAK,sCAAsC,QAAQ,EAAE;AAU5D,QAAM,WAAW,CAAC,aAAa,UAAU,OAAO,YAAY,UAAU,QAAQ;AAC9E,QAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,IAAI,CAAC;AACxD,SAAO,SAAS,MAAM,GAAG,KAAK,MAAM,KAAK,OAAA,KAAY,SAAS,SAAS,EAAE,CAAC;AAC3E;AAEO,MAAM,OAAuB,OAAO,EAAE,cAAc;AAC1D,QAAM,EAAE,QAAA,IAAY,MAAM,QAAQ,KAAA;AAElC,MAAI,CAAC,SAAS;AACb,UAAM,MAAM,KAAK,sBAAsB;AAAA,EACxC;AAEA,MAAI;AAEH,QAAI,CAAC,WAAW;AACf,YAAM,MAAM,KAAK,sCAAsC;AAAA,IACxD;AACA,UAAM,cAAc,MAAM,UAAU,KAAK,QAAmB,aAAa,EAAE,KAAK,SAAgB;AAChG,QAAI,CAAC,YAAY,WAAW,CAAC,YAAY,MAAM;AAC9C,YAAM,MAAM,KAAK,uBAAuB;AAAA,IACzC;AACA,UAAM,YAAY,YAAY;AAG9B,QAAI,CAAC,UAAU,SAAS,WAAW,QAAQ,GAAG;AAC7C,YAAM,MAAM,KAAK,0CAA0C;AAAA,IAC5D;AAIA,UAAM,WAAW,UAAU,YAAY,IAAI,OAAO,UAAU;AAC5D,UAAM,SAAS,MAAM,qBAAqB,QAAQ;AAElD,QAAI,CAAC,UAAU,OAAO,WAAW,GAAG;AACnC,aAAO,KAAK,EAAE,SAAS,MAAM,SAAS,+BAA+B,MAAM,WAAW;AAAA,IACvF;AAGA,UAAM,eAAgB,UAAU,SAAS,QAAqB,CAAA;AAC9D,UAAM,gBAAgB,OAAO,OAAO,CAAC,QAAQ,CAAC,aAAa,SAAS,IAAI,YAAA,CAAa,CAAC;AAEtF,QAAI,cAAc,WAAW,GAAG;AAC/B,aAAO,KAAK,EAAE,SAAS,MAAM,SAAS,0BAA0B,MAAM,WAAW;AAAA,IAClF;AAEA,UAAM,cAAc,CAAC,GAAG,cAAc,GAAG,aAAa;AAEtD,UAAM,eAAe,MAAM,UAAU,KAAK,OAAkB,aAAa,UAAU,KAAK;AAAA,MACvF,UAAU;AAAA,QACT,GAAG,UAAU;AAAA,QACb,MAAM;AAAA,MAAA;AAAA,IACP,CACA;AAED,QAAI,CAAC,aAAa,SAAS;AAC1B,YAAM,IAAI,MAAM,0CAA0C;AAAA,IAC3D;AAGA,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,SAAS,sBAAsB,cAAc,MAAM;AAAA,MACnD,MAAM,aAAa;AAAA,IAAA,CACnB;AAAA,EACF,SAAS,KAAK;AACb,WAAO,MAAM,2CAA2C,OAAO,IAAI,GAAG;AACtE,QAAI,eAAe,SAAS,YAAY,KAAK;AAC5C,YAAM;AAAA,IACP;AACA,UAAM,MAAM,KAAK,wDAAwD;AAAA,EAC1E;AACD;"}