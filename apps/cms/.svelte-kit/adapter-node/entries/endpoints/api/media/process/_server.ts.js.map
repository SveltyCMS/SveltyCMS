{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/media/process/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/process/+server.ts\n * @description\n * API endpoint for processing media files, now multi-tenant aware.\n *\n * @example POST /api/media/process\n *\n * Features:\n * - Granular permission checking based on operation type\n * - Operation-specific security (read/write/delete permissions)\n * - Admin override for all operations\n * - Supports metadata extraction, file saving, and deletion within a tenant\n * - Comprehensive error handling and logging\n */\n\nimport { json, error } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Auth\nimport { dbAdapter } from '@shared/database/db';\n\n// Media Processing\nimport { extractMetadata } from '@shared/utils/media/mediaProcessing.server';\nimport { MediaService } from '@shared/services/MediaService.server';\nimport type { MediaAccess, WatermarkOptions, MediaItem } from '@shared/utils/media/mediaModels';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Response types\ninterface ProcessResult {\n\tsuccess: boolean;\n\tdata?: MediaItem | MediaItem[] | FileProcessResult[] | Record<string, unknown>;\n\terror?: string;\n}\n\ninterface FileProcessResult {\n\tfileName: string;\n\tsuccess: boolean;\n\tdata?: MediaItem;\n\terror?: string;\n}\n\n// Helper function to get MediaService instance\nfunction getMediaService(): MediaService {\n\tif (!dbAdapter) {\n\t\tthrow new Error('Database adapter is not initialized');\n\t}\n\ttry {\n\t\tconst service = new MediaService(dbAdapter);\n\t\tlogger.info('MediaService initialized successfully');\n\t\treturn service;\n\t} catch (err) {\n\t\tconst message = `Failed to initialize MediaService: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow new Error(message);\n\t}\n}\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\ttry {\n\t\tconst formData = await request.formData();\n\t\tconst processType = formData.get('processType');\n\n\t\tif (!processType || typeof processType !== 'string') {\n\t\t\tlogger.warn('No process type specified', { tenantId });\n\t\t\treturn json({ success: false, error: 'Process type not specified' }, { status: 400 });\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t} // Check appropriate permissions based on operation type\n\n\t\tswitch (processType) {\n\t\t\tcase 'metadata':\n\t\t\t\tbreak;\n\t\t\tcase 'save':\n\t\t\t\tbreak;\n\t\t\tcase 'delete':\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow error(400, `Unsupported process type: ${processType}`);\n\t\t} // Authentication is handled by hooks.server.ts - user presence confirms access // Initialize MediaService\n\n\t\tconst mediaService = getMediaService();\n\n\t\tlet result: ProcessResult;\n\t\tswitch (processType) {\n\t\t\tcase 'metadata': {\n\t\t\t\tconst file = formData.get('file');\n\t\t\t\tif (!file || !(file instanceof File)) {\n\t\t\t\t\treturn json({ success: false, error: 'No valid file received' }, { status: 400 });\n\t\t\t\t}\n\t\t\t\tconst buffer = Buffer.from(await file.arrayBuffer());\n\t\t\t\tconst metadata = await extractMetadata(buffer);\n\t\t\t\tresult = { success: true, data: metadata as unknown as Record<string, unknown> };\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'save': {\n\t\t\t\tconst files = formData.getAll('files');\n\t\t\t\tif (files.length === 0 || !files.every((f) => f instanceof File)) {\n\t\t\t\t\treturn json({ success: false, error: 'No valid files received' }, { status: 400 });\n\t\t\t\t}\n\n\t\t\t\tif (!user) {\n\t\t\t\t\tthrow error(401, 'User not authenticated');\n\t\t\t\t}\n\n\t\t\t\tconst access: MediaAccess = 'private';\n\t\t\t\tconst watermarkOptionsString = formData.get('watermarkOptions') as string | null;\n\t\t\t\tlet watermarkOptions: WatermarkOptions | undefined;\n\t\t\t\tif (watermarkOptionsString) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\twatermarkOptions = JSON.parse(watermarkOptionsString);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tlogger.warn('Could not parse watermark options', { options: watermarkOptionsString });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst results: FileProcessResult[] = [];\n\t\t\t\tfor (const file of files) {\n\t\t\t\t\tif (file instanceof File) {\n\t\t\t\t\t\tif (!file.name || typeof file.name !== 'string') {\n\t\t\t\t\t\t\tresults.push({ fileName: 'unknown', success: false, error: 'Invalid file name' });\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t// Pass tenantId and watermarkOptions to the media service\n\t\t\t\t\t\t\tconst saveResult = await mediaService.saveMedia(file, user._id.toString(), access, tenantId, watermarkOptions);\n\t\t\t\t\t\t\tconst savedItem = saveResult as MediaItem;\n\n\t\t\t\t\t\t\tresults.push({\n\t\t\t\t\t\t\t\tfileName: file.name,\n\t\t\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\t\t\tdata: savedItem\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tlogger.info(`Successfully saved file: ${file.name}`, {\n\t\t\t\t\t\t\t\tuserId: user._id,\n\t\t\t\t\t\t\t\tfileSize: file.size,\n\t\t\t\t\t\t\t\ttenantId,\n\t\t\t\t\t\t\t\tthumbnails: Object.keys(savedItem.thumbnails ?? {})\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\tconst errorMsg = err instanceof Error ? err.message : String(err);\n\t\t\t\t\t\t\tlogger.error(`Error saving file ${file.name}:`, { error: errorMsg, tenantId });\n\t\t\t\t\t\t\tresults.push({ fileName: file.name, success: false, error: errorMsg });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tresult = { success: true, data: results };\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'delete': {\n\t\t\t\tconst mediaId = formData.get('mediaId');\n\t\t\t\tif (!mediaId || typeof mediaId !== 'string') {\n\t\t\t\t\treturn json({ success: false, error: 'Invalid media ID' }, { status: 400 });\n\t\t\t\t}\n\t\t\t\t// deleteMedia only takes one parameter\n\t\t\t\tawait mediaService.deleteMedia(mediaId);\n\t\t\t\tresult = { success: true };\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tthrow error(400, `Unsupported process type: ${processType}`);\n\t\t}\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: result\n\t\t});\n\t} catch (err) {\n\t\tconst message = `Error processing media: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { tenantId });\n\t\treturn json({ success: false, error: message }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":"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"}