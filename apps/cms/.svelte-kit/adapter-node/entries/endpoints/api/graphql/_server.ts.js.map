{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/graphql/resolvers/collections.ts","../../../../../../../src/routes/api/graphql/resolvers/media.ts","../../../../../../../src/routes/api/graphql/resolvers/users.ts","../../../../../../../src/routes/api/graphql/resolvers/system.ts","../../../../../../../src/routes/api/graphql/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/graphql/resolvers/collections.ts\n * @description Dynamic GraphQL schema and resolver generation for collections.\n *\n * This module provides functionality to:\n * - Dynamically register collection schemas based on the CMS configuration\n * - Generate GraphQL type definitions and resolvers for each collection\n * - Handle complex field types and nested structures\n * - Integrate with Redis for caching (via CacheService, tenent-aware)\n * - Apply token replacement for string fields\n *\n * Features:\n * - Dynamic schema generation based on widget configurations\n * - Support for extracted fields and nested structures\n * - Integration with custom widget schemas\n * - Redis caching for improved performance (following Architecture Standard)\n * - Error handling and logging\n *\n * Usage:\n * Used by the main GraphQL setup to generate collection-specific schemas and resolvers\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport type { DatabaseAdapter, CollectionModel } from '@shared/database/dbInterface';\nimport { getFieldName } from '@shared/utils/utils';\nimport { widgets } from '@shared/stores/widgetStore.svelte';\nimport deepmerge from 'deepmerge';\nimport type { GraphQLFieldResolver } from 'graphql';\n\n// Collection Manager\nimport { modifyRequest } from '@api/collections/modifyRequest';\nimport { contentManager } from '@content/ContentManager';\n\n// Token Engine\nimport { replaceTokens } from '@shared/services/token/engine';\nimport type { TokenContext } from '@shared/services/token/types';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Types\nimport type { User } from '@shared/database/auth/types';\nimport type { Schema, FieldInstance } from '@cms-types';\n\n// Helper to extract localized value\nfunction getLocalizedValue(value: unknown, locale: string = 'en'): unknown {\n\tif (value && typeof value === 'object' && !Array.isArray(value)) {\n\t\t// Check if it looks like a localized object (keys are language codes)\n\t\tconst valObj = value as Record<string, unknown>;\n\t\tif (locale in valObj) {\n\t\t\treturn valObj[locale];\n\t\t}\n\t\t// Fallback to 'en' or first key\n\t\tif ('en' in valObj) {\n\t\t\treturn valObj['en'];\n\t\t}\n\t\tconst keys = Object.keys(valObj);\n\t\tif (keys.length > 0) {\n\t\t\treturn valObj[keys[0]];\n\t\t}\n\t}\n\treturn value;\n}\n\n/**\n * Creates a clean GraphQL type name from collection info\n * Uses collection name + short UUID suffix for uniqueness and readability\n */\nexport function createCleanTypeName(collection: { _id?: string; name?: string | unknown }): string {\n\tconst rawName = typeof collection.name === 'string' ? collection.name : '';\n\tconst baseName = rawName.split('/').pop() || rawName;\n\tconst cleanName = baseName\n\t\t.replace(/[^a-zA-Z0-9]/g, '')\n\t\t.replace(/^[0-9]/, 'Collection$&')\n\t\t.replace(/^[a-z]/, (c) => c.toUpperCase());\n\tconst shortId = (collection._id ?? '').substring(0, 8);\n\treturn `${cleanName}_${shortId}`;\n}\n\ninterface WidgetSchema {\n\tgraphql: string;\n\ttypeID: string;\n\ttypeName: string;\n\tresolver?: Record<string, GraphQLFieldResolver<unknown, unknown>>;\n}\n\ninterface DocumentBase {\n\t_id: string;\n\tcreatedAt: string;\n\tupdatedAt: string;\n\t[key: string]: unknown;\n}\n\n// Type for document with extracted fields\ninterface DocumentWithFields extends DocumentBase {\n\t[fieldName: string]: unknown;\n}\n\ninterface ResolverContext {\n\tQuery: Record<string, GraphQLFieldResolver<unknown, unknown>>;\n\t[key: string]: Record<string, GraphQLFieldResolver<unknown, unknown>>;\n}\n\n// Interface compatible with CacheService wrapper\ninterface CacheClient {\n\tget(key: string, tenantId?: string): Promise<string | null>;\n\tset(key: string, value: string, ex: string, duration: number, tenantId?: string): Promise<unknown>;\n}\n\n// Registers collection schemas dynamically, now tenant-aware\nexport async function registerCollections(tenantId?: string) {\n\tawait contentManager.initialize(tenantId);\n\tconst collections: Schema[] = await contentManager.getCollections(tenantId);\n\n\t// Use lightweight metadata instead of full schemas where possible\n\tconst collectionStats = await Promise.all(\n\t\t(await contentManager.getCollections(tenantId)).map(async (col) => ({\n\t\t\t...col,\n\t\t\tstats: contentManager.getCollectionStats(col._id!, tenantId)\n\t\t}))\n\t);\n\n\tlogger.debug(\n\t\t`Collections loaded for GraphQL:`,\n\t\tcollectionStats.map((c) => ({\n\t\t\tname: typeof c.name === 'string' ? c.name : '',\n\t\t\tid: c._id,\n\t\t\tcleanTypeName: createCleanTypeName({ _id: c._id, name: typeof c.name === 'string' ? c.name : '' }),\n\t\t\tfieldCount: c.stats?.fieldCount\n\t\t}))\n\t);\n\n\tconst typeIDs = new Set<string>();\n\tconst typeDefsSet = new Set<string>();\n\tconst resolvers: ResolverContext = { Query: {} };\n\tconst collectionSchemas: string[] = [];\n\tconst collectionNameMapping = new Map<string, string>();\n\tfor (const collection of collections) {\n\t\tconst name = typeof collection.name === 'string' ? collection.name : '';\n\t\tconst cleanTypeName = createCleanTypeName({ _id: collection._id, name });\n\t\tcollectionNameMapping.set(name, cleanTypeName);\n\t}\n\n\tfor (const collection of collections) {\n\t\tconst name = typeof collection.name === 'string' ? collection.name : '';\n\t\tconst cleanTypeName = createCleanTypeName({ _id: collection._id, name });\n\t\tresolvers[cleanTypeName] = {};\n\t\tlet collectionSchema = `\n\t\t\ttype ${cleanTypeName} {\n\t\t`;\n\n\t\tfor (const field of collection.fields as FieldInstance[]) {\n\t\t\tconst widgetNameRaw = field.widget?.Name;\n\t\t\tif (!widgetNameRaw || typeof widgetNameRaw !== 'string') {\n\t\t\t\tcontinue; // Skip fields with missing widget names silently\n\t\t\t}\n\n\t\t\t// Get widget functions map - Correctly accessed from store\n\t\t\tconst widgetFunctionsMap = widgets.widgetFunctions;\n\n\t\t\t// Try exact match first, then try camelCase conversion, then lowercase fallback\n\t\t\tlet widget = widgetFunctionsMap[widgetNameRaw];\n\n\t\t\tif (!widget) {\n\t\t\t\tconst camelName = widgetNameRaw.charAt(0).toLowerCase() + widgetNameRaw.slice(1);\n\t\t\t\twidget = widgetFunctionsMap[camelName];\n\t\t\t}\n\n\t\t\tif (!widget) {\n\t\t\t\tconst lowerName = widgetNameRaw.toLowerCase();\n\t\t\t\twidget = widgetFunctionsMap[lowerName];\n\t\t\t}\n\n\t\t\tif (!widget) {\n\t\t\t\t// Log warning but continue, missing widget shouldn't break entire API\n\t\t\t\tconst availableWidgets = Object.keys(widgetFunctionsMap).length;\n\t\t\t\tlogger.warn(`Widget not found: ${widgetNameRaw} (Available: ${availableWidgets})`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (typeof widget.GraphqlSchema !== 'function') {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst schema = widget.GraphqlSchema({\n\t\t\t\tfield,\n\t\t\t\tlabel: `${cleanTypeName}_${getFieldName(field)}`,\n\t\t\t\tcollection,\n\t\t\t\tcollectionNameMapping\n\t\t\t}) as WidgetSchema | undefined;\n\n\t\t\tif (!schema) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (schema.resolver) {\n\t\t\t\tdeepmerge(resolvers, { [cleanTypeName]: schema.resolver });\n\t\t\t}\n\n\t\t\t// Only add to typeDefsSet if there's actual GraphQL schema content\n\t\t\tif (schema.graphql && schema.graphql.trim() && !typeIDs.has(schema.typeID)) {\n\t\t\t\ttypeIDs.add(schema.typeID);\n\t\t\t\ttypeDefsSet.add(schema.graphql);\n\t\t\t} else if (!schema.graphql || !schema.graphql.trim()) {\n\t\t\t\ttypeIDs.add(schema.typeID);\n\t\t\t} else if (typeIDs.has(schema.typeID)) {\n\t\t\t\t// Duplicate type ID warning suppressed\n\t\t\t}\n\n\t\t\t// Nested Fields Logic\n\t\t\tif (\n\t\t\t\t'extract' in field &&\n\t\t\t\tArray.isArray((field as FieldInstance & { fields?: FieldInstance[] }).fields) &&\n\t\t\t\t(field as FieldInstance & { fields?: FieldInstance[] }).fields!.length > 0\n\t\t\t) {\n\t\t\t\tfor (const _field of (field as FieldInstance & { fields?: FieldInstance[] }).fields!) {\n\t\t\t\t\tconst nestedWidgetNameRaw = _field.widget?.Name;\n\t\t\t\t\tif (!nestedWidgetNameRaw || typeof nestedWidgetNameRaw !== 'string') continue;\n\n\t\t\t\t\tconst widgetFunctionsMap = widgets.widgetFunctions;\n\t\t\t\t\tlet nestedWidget = widgetFunctionsMap[nestedWidgetNameRaw];\n\n\t\t\t\t\tif (!nestedWidget) {\n\t\t\t\t\t\tconst camelName = nestedWidgetNameRaw.charAt(0).toLowerCase() + nestedWidgetNameRaw.slice(1);\n\t\t\t\t\t\tnestedWidget = widgetFunctionsMap[camelName];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!nestedWidget) {\n\t\t\t\t\t\tconst lowerName = nestedWidgetNameRaw.toLowerCase();\n\t\t\t\t\t\tnestedWidget = widgetFunctionsMap[lowerName];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!nestedWidget || typeof nestedWidget.GraphqlSchema !== 'function') continue;\n\n\t\t\t\t\tconst nestedSchema = nestedWidget.GraphqlSchema({\n\t\t\t\t\t\tfield: _field,\n\t\t\t\t\t\tlabel: `${cleanTypeName}_${getFieldName(_field)}`,\n\t\t\t\t\t\tcollection,\n\t\t\t\t\t\tcollectionNameMapping\n\t\t\t\t\t});\n\n\t\t\t\t\tif (nestedSchema && nestedSchema.typeID) {\n\t\t\t\t\t\tif (nestedSchema.graphql && nestedSchema.graphql.trim() && !typeIDs.has(nestedSchema.typeID)) {\n\t\t\t\t\t\t\ttypeIDs.add(nestedSchema.typeID);\n\t\t\t\t\t\t\ttypeDefsSet.add(nestedSchema.graphql);\n\t\t\t\t\t\t} else if (!nestedSchema.graphql || !nestedSchema.graphql.trim()) {\n\t\t\t\t\t\t\ttypeIDs.add(nestedSchema.typeID);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcollectionSchema += `                ${getFieldName(_field)}: ${nestedSchema.typeID}\\n`;\n\n\t\t\t\t\t\tconst nestedResolverFn = (_field as FieldInstance).translated\n\t\t\t\t\t\t\t? (parent: DocumentWithFields, _args: unknown, ctx: { locale?: string }) => getLocalizedValue(parent[getFieldName(_field)], ctx.locale)\n\t\t\t\t\t\t\t: undefined;\n\n\t\t\t\t\t\tif (nestedResolverFn) {\n\t\t\t\t\t\t\tdeepmerge(resolvers[cleanTypeName], {\n\t\t\t\t\t\t\t\t[getFieldName(_field)]: nestedResolverFn\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcollectionSchema += `                ${getFieldName(field)}: ${schema.typeID}\\n`;\n\n\t\t\t\tconst resolverFn = (field as FieldInstance).translated\n\t\t\t\t\t? (parent: DocumentWithFields, _args: unknown, ctx: { locale?: string }) => getLocalizedValue(parent[getFieldName(field)], ctx.locale)\n\t\t\t\t\t: undefined;\n\n\t\t\t\tif (resolverFn) {\n\t\t\t\t\tdeepmerge(resolvers[cleanTypeName], {\n\t\t\t\t\t\t[getFieldName(field)]: resolverFn\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tcollectionSchema += `\n\t\t\t\t_id: String\n\t\t\t\tstatus: String\n\t\t\t\tcreatedAt: String\n\t\t\t\tupdatedAt: String\n\t\t\t\tcreatedBy: String\n\t\t\t\tupdatedBy: String\n\t\t\t}`;\n\n\t\tcollectionSchemas.push(collectionSchema + '\\n');\n\t}\n\n\tconst finalTypeDefs = Array.from(typeDefsSet).join('\\n') + collectionSchemas.join('\\n');\n\n\treturn {\n\t\ttypeDefs: finalTypeDefs,\n\t\tresolvers,\n\t\tcollections\n\t};\n}\n\n// Builds resolvers for querying collection data.\nexport async function collectionsResolvers(dbAdapter: DatabaseAdapter, cacheClient: CacheClient | null, tenantId?: string) {\n\tif (!dbAdapter) {\n\t\tthrow new Error('Database adapter is not initialized');\n\t}\n\tconst { resolvers, collections } = await registerCollections(tenantId);\n\n\tfor (const collection of collections) {\n\t\tif (!collection._id) continue;\n\n\t\tconst name = typeof collection.name === 'string' ? collection.name : '';\n\t\tconst cleanTypeName = createCleanTypeName({ _id: collection._id, name });\n\t\tresolvers.Query[cleanTypeName] = async function resolver(\n\t\t\t_parent: unknown,\n\t\t\targs: { pagination?: { page?: number; limit?: number } },\n\t\t\tcontext: unknown\n\t\t): Promise<DocumentBase[]> {\n\t\t\t// Type guard for context\n\t\t\tconst ctx = context as { user?: User; tenantId?: string; locale?: string };\n\t\t\tif (!ctx.user) {\n\t\t\t\tthrow new Error('Authentication required');\n\t\t\t}\n\n\t\t\tif (getPrivateSettingSync('MULTI_TENANT') && ctx.tenantId !== tenantId) {\n\t\t\t\tlogger.error(`Resolver tenantId mismatch. Expected ${tenantId}, got ${ctx.tenantId}`);\n\t\t\t\tthrow new Error('Internal server error: Tenant context mismatch.');\n\t\t\t}\n\n\t\t\tif (!dbAdapter) {\n\t\t\t\tthrow new Error('Database adapter is not initialized');\n\t\t\t}\n\n\t\t\tconst { page = 1, limit = 50 } = args.pagination || {};\n\t\t\tconst locale = ctx.locale || 'en';\n\n\t\t\ttry {\n\t\t\t\tconst collectionStats = contentManager.getCollectionStats(collection._id!, ctx.tenantId);\n\t\t\t\tif (!collectionStats) {\n\t\t\t\t\tthrow new Error(`Collection not found: ${collection._id}`);\n\t\t\t\t}\n\n\t\t\t\t// CACHE: Conforming to Cache Architecture (Category: Query)\n\t\t\t\t// Key: query:collections:{id}:{page}:{limit}:{locale}:{version}\n\t\t\t\tconst contentVersion = contentManager.getContentVersion();\n\t\t\t\tconst cacheKey = `query:collections:${collection._id}:${page}:${limit}:${locale}:${contentVersion}`;\n\n\t\t\t\tif (getPrivateSettingSync('USE_REDIS') && cacheClient) {\n\t\t\t\t\tconst cachedResult = await cacheClient.get(cacheKey, ctx.tenantId);\n\t\t\t\t\tif (cachedResult) {\n\t\t\t\t\t\treturn JSON.parse(cachedResult);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Query execution\n\t\t\t\tconst query: Record<string, unknown> = {};\n\t\t\t\tif (getPrivateSettingSync('MULTI_TENANT') && ctx.tenantId) {\n\t\t\t\t\tquery.tenantId = ctx.tenantId;\n\t\t\t\t}\n\n\t\t\t\tconst collectionName = `collection_${collection._id}`;\n\t\t\t\tconst queryBuilder = dbAdapter\n\t\t\t\t\t.queryBuilder(collectionName)\n\t\t\t\t\t.where(Object.keys(query).length ? query : {})\n\t\t\t\t\t.paginate({ page, pageSize: limit });\n\t\t\t\tconst result = await queryBuilder.execute();\n\n\t\t\t\tif (!result.success) {\n\t\t\t\t\tthrow new Error(`Database query failed: ${result.error?.message || 'Unknown error'}`);\n\t\t\t\t}\n\n\t\t\t\tconst resultArray = (Array.isArray(result.data) ? result.data : []) as unknown as DocumentBase[];\n\n\t\t\t\t// Modify Request (Permissions & Computed Fields)\n\t\t\t\tif (resultArray.length > 0) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait modifyRequest({\n\t\t\t\t\t\t\tdata: resultArray,\n\t\t\t\t\t\t\tfields: collection.fields as FieldInstance[],\n\t\t\t\t\t\t\tcollection: collection as unknown as CollectionModel,\n\t\t\t\t\t\t\tuser: ctx.user!,\n\t\t\t\t\t\t\ttype: 'GET'\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (modifyError) {\n\t\t\t\t\t\tlogger.warn(`GraphQL modifyRequest failed`, {\n\t\t\t\t\t\t\terror: modifyError instanceof Error ? modifyError.message : 'Unknown error'\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Token Replacement\n\t\t\t\tconst processedResults = await Promise.all(\n\t\t\t\t\tresultArray.map(async (doc) => {\n\t\t\t\t\t\tconst tokenContext: TokenContext = {\n\t\t\t\t\t\t\tentry: doc,\n\t\t\t\t\t\t\tuser: ctx.user\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst processedDoc = { ...doc };\n\t\t\t\t\t\tfor (const key in processedDoc) {\n\t\t\t\t\t\t\tconst value = processedDoc[key];\n\t\t\t\t\t\t\tif (typeof value === 'string' && value.includes('{{')) {\n\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\tprocessedDoc[key] = await replaceTokens(value, tokenContext);\n\t\t\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\t\t\tlogger.warn(`Token replacement failed for field ${key}`, err);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn processedDoc;\n\t\t\t\t\t})\n\t\t\t\t);\n\n\t\t\t\t// Date Normalization\n\t\t\t\tprocessedResults.forEach((doc: DocumentBase) => {\n\t\t\t\t\tdoc.createdAt = doc.createdAt ? new Date(doc.createdAt).toISOString() : new Date().toISOString();\n\t\t\t\t\tdoc.updatedAt = doc.updatedAt ? new Date(doc.updatedAt).toISOString() : doc.createdAt;\n\t\t\t\t});\n\n\t\t\t\t// CACHE SET: Category 'query' (Default TTL: 30m = 1800s)\n\t\t\t\tif (getPrivateSettingSync('USE_REDIS') && cacheClient) {\n\t\t\t\t\tawait cacheClient.set(cacheKey, JSON.stringify(processedResults), 'EX', 1800, ctx.tenantId);\n\t\t\t\t}\n\n\t\t\t\treturn processedResults;\n\t\t\t} catch (error) {\n\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Unknown error';\n\t\t\t\tlogger.error(`Error fetching data for ${collection._id}: ${errorMessage}`);\n\t\t\t\tthrow new Error(`Failed to fetch data for ${collection._id}: ${errorMessage}`);\n\t\t\t}\n\t\t};\n\t}\n\n\treturn resolvers;\n}\n","/**\n * @file src/routes/api/graphql/resolvers/media.ts\n * @description Dynamic GraphQL schema and resolver generation for media.\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport type { DatabaseAdapter, BaseEntity } from '@shared/database/dbInterface';\nimport { logger } from '@shared/utils/logger.server';\nimport type { User } from '@shared/database/auth/types';\n\n// Registers media schemas dynamically.\nexport function mediaTypeDefs() {\n\treturn `\n        type MediaImage {\n            _id: String\n            url: String\n            createdAt: String\n            updatedAt: String\n        }\n\n        type MediaDocument {\n            _id: String\n            url: String\n            createdAt: String\n            updatedAt: String\n        }\n\n        type MediaAudio {\n            _id: String\n            url: String\n            createdAt: String\n            updatedAt: String\n        }\n\n        type MediaVideo {\n            _id: String\n            url: String\n            createdAt: String\n            updatedAt: String\n        }\n\n        type MediaRemote {\n            _id: String\n            url: String\n            createdAt: String\n            updatedAt: String\n        }\n    `;\n}\n\ninterface PaginationArgs {\n\tpagination: {\n\t\tpage: number;\n\t\tlimit: number;\n\t};\n}\n\ninterface GraphQLContext {\n\tuser?: User;\n\ttenantId?: string;\n}\n\ntype MediaResolverParent = unknown;\n\ninterface MediaEntity extends BaseEntity {\n\turl?: string;\n\ttenantId?: string;\n}\n\n// Builds resolvers for querying media data with pagination support.\nexport function mediaResolvers(dbAdapter: DatabaseAdapter) {\n\tif (!dbAdapter) {\n\t\tthrow new Error('Database adapter is not initialized');\n\t}\n\n\tconst fetchWithPagination = async (contentTypes: string, pagination: { page: number; limit: number }, context: GraphQLContext) => {\n\t\tif (!context.user) throw new Error('Authentication required');\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !context.tenantId) {\n\t\t\tthrow new Error('Internal Server Error: Tenant context is missing.');\n\t\t}\n\n\t\tconst { page = 1, limit = 50 } = pagination || {};\n\n\t\ttry {\n\t\t\tconst query: Partial<MediaEntity> = {};\n\t\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\t\tquery.tenantId = context.tenantId;\n\t\t\t}\n\n\t\t\tconst result = await dbAdapter\n\t\t\t\t.queryBuilder<MediaEntity>(contentTypes)\n\t\t\t\t.where(query)\n\t\t\t\t.sort('createdAt', 'desc')\n\t\t\t\t.paginate({ page, pageSize: limit })\n\t\t\t\t.execute();\n\n\t\t\tif (!result.success) throw new Error(result.error?.message || 'Query failed');\n\n\t\t\treturn result.data;\n\t\t} catch (error) {\n\t\t\tlogger.error(`Error fetching data for ${contentTypes}:`, {\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\ttenantId: context.tenantId\n\t\t\t});\n\t\t\tthrow Error(`Failed to fetch data for ${contentTypes}`);\n\t\t}\n\t};\n\n\treturn {\n\t\tmediaImages: async (_: MediaResolverParent, args: PaginationArgs, context: GraphQLContext) =>\n\t\t\tawait fetchWithPagination('media_images', args.pagination, context),\n\t\tmediaDocuments: async (_: MediaResolverParent, args: PaginationArgs, context: GraphQLContext) =>\n\t\t\tawait fetchWithPagination('media_documents', args.pagination, context),\n\t\tmediaAudio: async (_: MediaResolverParent, args: PaginationArgs, context: GraphQLContext) =>\n\t\t\tawait fetchWithPagination('media_audio', args.pagination, context),\n\t\tmediaVideos: async (_: MediaResolverParent, args: PaginationArgs, context: GraphQLContext) =>\n\t\t\tawait fetchWithPagination('media_videos', args.pagination, context),\n\t\tmediaRemote: async (_: MediaResolverParent, args: PaginationArgs, context: GraphQLContext) =>\n\t\t\tawait fetchWithPagination('media_remote', args.pagination, context)\n\t};\n}\n","/**\n * @file src/routes/api/graphql/resolvers/users.ts\n * @description GraphQL type definitions and resolvers for user-related queries.\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport type { ISODateString, BaseEntity } from '@shared/database/dbInterface';\nimport { logger } from '@shared/utils/logger.server';\nimport type { DatabaseAdapter } from '@shared/database/dbInterface';\nimport type { User } from '@shared/database/auth/types';\n\n// GraphQL types\ntype GraphQLValue = string | number | boolean | Date | object | GraphQLValue[];\n\n// Helper function to map TypeScript types to GraphQL types\nfunction mapTypeToGraphQLType(value: GraphQLValue): string {\n\tif (Array.isArray(value)) {\n\t\treturn `[${mapTypeToGraphQLType(value[0])}]`;\n\t}\n\tswitch (typeof value) {\n\t\tcase 'string':\n\t\t\treturn 'String';\n\t\tcase 'boolean':\n\t\t\treturn 'Boolean';\n\t\tcase 'number':\n\t\t\treturn Number.isInteger(value) ? 'Int' : 'Float';\n\t\tcase 'object':\n\t\t\treturn value instanceof Date ? 'String' : 'JSON';\n\t\tdefault:\n\t\t\treturn 'String';\n\t}\n}\n\n// Helper function to generate GraphQL type definitions from a TypeScript type\nfunction generateGraphQLTypeDefsFromType<T extends Record<string, GraphQLValue>>(type: T, typeID: string): string {\n\tconst fields = Object.entries(type)\n\t\t.map(([key, value]) => `${key}: ${mapTypeToGraphQLType(value)}`)\n\t\t.join('\\n');\n\n\treturn `\n        type ${typeID} {\n            ${fields}\n        }\n    `;\n}\n\n// Use a partial User object to define the types\nconst userTypeSample: Partial<User> = {\n\t_id: '',\n\temail: '',\n\ttenantId: '',\n\tpassword: '',\n\trole: '',\n\tusername: '',\n\tavatar: '',\n\tlastAuthMethod: '',\n\tlastActiveAt: new Date().toISOString() as ISODateString,\n\texpiresAt: new Date().toISOString() as ISODateString,\n\tisRegistered: false,\n\tblocked: false,\n\tresetRequestedAt: new Date().toISOString() as ISODateString,\n\tresetToken: '',\n\tfailedAttempts: 0,\n\tlockoutUntil: new Date().toISOString() as ISODateString,\n\tis2FAEnabled: false,\n\tpermissions: []\n};\n\n// TypeDefs\nexport function userTypeDefs() {\n\treturn generateGraphQLTypeDefsFromType(userTypeSample as Record<string, GraphQLValue>, 'User');\n}\n\ninterface GraphQLContext {\n\tuser?: User;\n\ttenantId?: string;\n}\n\ninterface UserEntity extends BaseEntity {\n\temail?: string;\n\ttenantId?: string;\n}\n\n// Resolvers with pagination support and validation\nexport function userResolvers(dbAdapter: DatabaseAdapter) {\n\tif (!dbAdapter) {\n\t\tthrow new Error('Database adapter is not initialized');\n\t}\n\n\tconst fetchWithPagination = async (contentTypes: string, pagination: { page: number; limit: number }, context: GraphQLContext) => {\n\t\tif (!context.user) throw new Error('Authentication required');\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !context.tenantId) {\n\t\t\tthrow new Error('Internal Server Error: Tenant context is missing.');\n\t\t}\n\n\t\tconst { page = 1, limit = 10 } = pagination || {};\n\n\t\ttry {\n\t\t\t// Tenant query\n\t\t\tconst query: Partial<UserEntity> = {};\n\t\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\t\tquery.tenantId = context.tenantId;\n\t\t\t}\n\n\t\t\tconst result = await dbAdapter\n\t\t\t\t.queryBuilder<UserEntity>(contentTypes)\n\t\t\t\t.where(query)\n\t\t\t\t.sort('updatedAt', 'desc')\n\t\t\t\t.paginate({ page, pageSize: limit })\n\t\t\t\t.execute();\n\n\t\t\tif (!result.success) throw new Error(result.error?.message || 'Query failed');\n\n\t\t\treturn result.data;\n\t\t} catch (error) {\n\t\t\tlogger.error(`Error fetching data for ${contentTypes}:`, {\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\ttenantId: context.tenantId\n\t\t\t});\n\t\t\tthrow Error(`Failed to fetch data for ${contentTypes}`);\n\t\t}\n\t};\n\n\treturn {\n\t\tusers: async (_: unknown, args: { pagination: { page: number; limit: number } }, context: GraphQLContext) =>\n\t\t\tawait fetchWithPagination('auth_users', args.pagination, context),\n\t\tme: async (_: unknown, __: unknown, context: GraphQLContext) => {\n\t\t\tif (!context.user) throw new Error('Authentication required');\n\t\t\treturn context.user;\n\t\t}\n\t};\n}\n","/**\n * @file src/routes/api/graphql/resolvers/system.ts\n * @description System-level GraphQL resolvers for health, diagnostics, navigation, and collection stats.\n */\n\nimport { contentManager } from '@content/ContentManager';\nimport type { User } from '@shared/database/auth/types';\nimport { logger } from '@shared/utils/logger.server';\n\ninterface GraphQLContext {\n\tuser?: User;\n\ttenantId?: string;\n\tlocale?: string;\n}\n\nexport const systemTypeDefs = `\n\tinput NavigationOptions {\n\t\tmaxDepth: Int = 1\n\t\texpandedIds: [String!]\n\t}\n\n\ttype CollectionStats {\n\t\t_id: String!\n\t\tname: String!\n\t\ticon: String\n\t\tpath: String\n\t\tfieldCount: Int!\n\t\thasRevisions: Boolean!\n\t\thasLivePreview: Boolean!\n\t\tstatus: String\n\t}\n\n\ttype NavigationNode {\n\t\t_id: String!\n\t\tname: String!\n\t\tpath: String\n\t\ticon: String\n\t\tnodeType: String!\n\t\torder: Int\n\t\tparentId: String\n\t\tchildren: [NavigationNode!]\n\t\thasChildren: Boolean\n\t}\n\n\ttype BreadcrumbItem {\n\t\tname: String!\n\t\tpath: String!\n\t}\n\n\ttype ContentManagerHealth {\n\t\tstate: String!\n\t\tnodeCount: Int!\n\t\tcollectionCount: Int!\n\t\tcacheAge: Int\n\t\tversion: Int!\n\t}\n\n\ttype HealthMaps {\n\t\tcontentNodes: Int!\n\t\tpathLookup: Int!\n\t}\n\n\ttype HealthCache {\n\t\thasFirstCollection: Boolean!\n\t\tcacheAge: Int\n\t\ttenantId: String\n\t}\n\n\ttype ContentManagerDiagnostics {\n\t\tmaps: HealthMaps!\n\t\tcache: HealthCache!\n\t\tstate: String!\n\t\tversion: Int!\n\t}\n\n\ttype OperationCounts {\n\t\tcreate: Int!\n\t\tupdate: Int!\n\t\tdelete: Int!\n\t\tmove: Int!\n\t}\n\n\ttype ContentManagerMetrics {\n\t\tinitializationTime: Float!\n\t\tcacheHits: Int!\n\t\tcacheMisses: Int!\n\t\tlastRefresh: Float!\n\t\toperationCounts: OperationCounts!\n\t\tuptime: Float!\n\t\tcacheHitRate: Float!\n\t}\n\n\ttype StructureValidation {\n\t\tvalid: Boolean!\n\t\terrors: [String!]!\n\t\twarnings: [String!]!\n\t}\n`;\n\nexport const systemResolvers = {\n\tQuery: {\n\t\t// --- Collection Metadata ---\n\t\tcollectionStats: async (_: unknown, args: { collectionId: string }, context: GraphQLContext) => {\n\t\t\tif (!context.user) throw new Error('Authentication required');\n\t\t\ttry {\n\t\t\t\treturn await contentManager.getCollectionStats(args.collectionId, context.tenantId);\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in collectionStats:`, { error, collectionId: args.collectionId, tenantId: context.tenantId });\n\t\t\t\tthrow new Error('Failed to fetch collection stats');\n\t\t\t}\n\t\t},\n\n\t\tallCollectionStats: async (_: unknown, __: unknown, context: GraphQLContext) => {\n\t\t\tif (!context.user) throw new Error('Authentication required');\n\t\t\ttry {\n\t\t\t\tconst collections = await contentManager.getCollections(context.tenantId);\n\t\t\t\treturn collections.map((col) => contentManager.getCollectionStats(col._id!, context.tenantId)).filter(Boolean);\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in allCollectionStats:`, { error, tenantId: context.tenantId });\n\t\t\t\tthrow new Error('Failed to fetch all collection stats');\n\t\t\t}\n\t\t},\n\n\t\t// --- Navigation ---\n\t\tnavigationStructure: async (_: unknown, args: { options?: { maxDepth?: number; expandedIds?: string[] } }, context: GraphQLContext) => {\n\t\t\tif (!context.user) throw new Error('Authentication required');\n\t\t\ttry {\n\t\t\t\tconst expandedIds = new Set(args.options?.expandedIds || []);\n\t\t\t\treturn await contentManager.getNavigationStructureProgressive({\n\t\t\t\t\tmaxDepth: args.options?.maxDepth ?? 1,\n\t\t\t\t\texpandedIds,\n\t\t\t\t\ttenantId: context.tenantId\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in navigationStructure:`, { error, tenantId: context.tenantId });\n\t\t\t\tthrow new Error('Failed to fetch navigation structure');\n\t\t\t}\n\t\t},\n\n\t\tnodeChildren: async (_: unknown, args: { nodeId: string }, context: GraphQLContext) => {\n\t\t\tif (!context.user) throw new Error('Authentication required');\n\t\t\ttry {\n\t\t\t\treturn await contentManager.getNodeChildren(args.nodeId, context.tenantId);\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in nodeChildren:`, { error, nodeId: args.nodeId, tenantId: context.tenantId });\n\t\t\t\tthrow new Error('Failed to fetch node children');\n\t\t\t}\n\t\t},\n\n\t\tbreadcrumb: async (_: unknown, args: { path: string }, context: GraphQLContext) => {\n\t\t\tif (!context.user) throw new Error('Authentication required');\n\t\t\ttry {\n\t\t\t\treturn await contentManager.getBreadcrumb(args.path);\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in breadcrumb:`, { error, path: args.path, tenantId: context.tenantId });\n\t\t\t\tthrow new Error('Failed to fetch breadcrumb');\n\t\t\t}\n\t\t},\n\n\t\t// --- Health & Diagnostics ---\n\t\tcontentManagerHealth: async (_: unknown, __: unknown, context: GraphQLContext) => {\n\t\t\tif (!context.user) throw new Error('Authentication required');\n\t\t\ttry {\n\t\t\t\treturn await contentManager.getHealthStatus();\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in contentManagerHealth:`, { error });\n\t\t\t\tthrow new Error('Failed to fetch health status');\n\t\t\t}\n\t\t},\n\n\t\tcontentManagerDiagnostics: async (_: unknown, __: unknown, context: GraphQLContext) => {\n\t\t\tif (!context.user || !context.user.isAdmin) throw new Error('Admin access required');\n\t\t\ttry {\n\t\t\t\treturn await contentManager.getDiagnostics();\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in contentManagerDiagnostics:`, { error });\n\t\t\t\tthrow new Error('Failed to fetch diagnostics');\n\t\t\t}\n\t\t},\n\n\t\tcontentManagerMetrics: async (_: unknown, __: unknown, context: GraphQLContext) => {\n\t\t\tif (!context.user || !context.user.isAdmin) throw new Error('Admin access required');\n\t\t\ttry {\n\t\t\t\treturn await contentManager.getMetrics();\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in contentManagerMetrics:`, { error });\n\t\t\t\tthrow new Error('Failed to fetch metrics');\n\t\t\t}\n\t\t},\n\n\t\tvalidateContentStructure: async (_: unknown, __: unknown, context: GraphQLContext) => {\n\t\t\tif (!context.user || !context.user.isAdmin) throw new Error('Admin access required');\n\t\t\ttry {\n\t\t\t\treturn await contentManager.validateStructure();\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Error in validateContentStructure:`, { error });\n\t\t\t\tthrow new Error('Failed to validate structure');\n\t\t\t}\n\t\t}\n\t}\n};\n","/**\n * @file src/routes/api/graphql/+server.ts\n * @description GraphQL API setup and request handler for the CMS.\n *\n * This module sets up the GraphQL schema and resolvers, including:\n * - Collection-specific schemas and resolvers, scoped to the current tenant\n * - User-related schemas and resolvers\n * - Media-related schemas and resolvers\n * - Access management permission definition and checking\n * - GraphQL Subscriptions for real-time updates (WebSocket)\n * - Optimized Cache Client wrapping CacheService\n */\n\nimport { CacheCategory } from '@shared/database/CacheCategory';\n\nimport { building } from '$app/environment';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport type { RequestEvent } from '@sveltejs/kit';\n\n// GraphQL Yoga\nimport type { DatabaseAdapter, DatabaseId } from '@shared/database/dbInterface';\n\n// Create a cache client adapter compatible with the expected interface in resolvers\nconst cacheClient = getPrivateSettingSync('USE_REDIS')\n\t? {\n\t\t\tget: async (key: string, tenantId?: string) => {\n\t\t\t\ttry {\n\t\t\t\t\t// Namespace GraphQL caches and include tenant when provided\n\t\t\t\t\treturn await cacheService.get<string>(`graphql:${key}`, tenantId);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tlogger.debug('GraphQL cache get failed, continuing without cache', err);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t},\n\t\t\tset: async (key: string, value: string, _ex: string, duration: number, tenantId?: string) => {\n\t\t\t\ttry {\n\t\t\t\t\t// Ignore 'EX' (Generic wrapper) and use duration directly\n\t\t\t\t\t// Namespace GraphQL caches\n\t\t\t\t\tawait cacheService.set(`graphql:${key}`, value, duration, tenantId, CacheCategory.API);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tlogger.debug('GraphQL cache set failed, continuing without cache', err);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t: null;\nimport { createSchema, createYoga } from 'graphql-yoga';\nimport { collectionsResolvers, createCleanTypeName, registerCollections } from './resolvers/collections';\nimport { mediaResolvers, mediaTypeDefs } from './resolvers/media';\nimport { userResolvers, userTypeDefs } from './resolvers/users';\nimport { systemResolvers, systemTypeDefs } from './resolvers/system';\n\n// GraphQL Subscriptions\nimport { WebSocketServer } from 'ws';\nimport { useServer } from 'graphql-ws/use/ws';\n\n// Widget Store - ensure widgets are loaded before GraphQL setup\nimport { widgets } from '@shared/stores/widgetStore.svelte';\n\n// Unified Cache Service\nimport { cacheService } from '@shared/database/CacheService';\n\n// Auth / Permission\nimport { hasPermissionWithRoles, registerPermission } from '@shared/database/auth/permissions';\nimport { PermissionAction, PermissionType, type User, type Role } from '@shared/database/auth/types';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Import shared PubSub instance\nimport { pubSub } from '@shared/services/pubSub';\n\n// Removed local createPubSub() call\n// const pubSub = createPubSub();\n\n// Define the access management permission configuration\nconst accessManagementPermission = {\n\t_id: 'config:accessManagement' as DatabaseId,\n\tcontextId: 'config/accessManagement',\n\tname: 'Access Management',\n\taction: PermissionAction.MANAGE,\n\tcontextType: PermissionType.CONFIGURATION,\n\ttype: PermissionType.CONFIGURATION,\n\tdescription: 'Allows management of user access and permissions'\n};\n\n// Register the permission\nif (!building) {\n\tregisterPermission(accessManagementPermission);\n}\n\n// Create a cache client adapter compatible with the expected interface in resolvers\n// WRAPPER: Maps generic get/set to CacheService with 'graphql' namespace prefix\n// NOTE: Resolvers should append specific keys. This ensures separation.\n// Cache client created above\n\n// Setup GraphQL schema and resolvers\nasync function createGraphQLSchema(dbAdapter: DatabaseAdapter, tenantId?: string) {\n\t// Ensure widgets are loaded before proceeding\n\tif (!widgets.isLoaded) {\n\t\tlogger.debug('Widgets not loaded yet, initializing...');\n\t\t// Pass dbAdapter to load active widgets from DB\n\t\tawait widgets.initialize(tenantId, dbAdapter);\n\t}\n\n\tconst { typeDefs: collectionsTypeDefs, collections } = await registerCollections(tenantId);\n\n\t// Ensure collections is properly formatted\n\tconst collectionsArray = (Array.isArray(collections) ? collections : Object.values(collections || {})) as Array<{\n\t\t_id?: string;\n\t\tname?: string;\n\t}>;\n\n\tconst typeDefs = `\n\t\tinput PaginationInput {\n\t\t\tpage: Int = 1\n\t\t\tlimit: Int = 50\n\t\t}\n\n\t\tscalar JSON\n\n\t\t${collectionsTypeDefs}\n\t\t${userTypeDefs()}\n\t\t${mediaTypeDefs()}\n\t\t${systemTypeDefs}\n\n\n\n\t\ttype ContentUpdateEvent {\n\t\t\tversion: Int!\n\t\t\ttimestamp: String!\n\t\t\taffectedCollections: [String!]!\n\t\t\tchangeType: String!\n\t\t}\n\n\t\ttype EntryUpdateEvent {\n\t\t\tcollection: String!\n\t\t\tid: String!\n\t\t\taction: String!\n\t\t\tdata: JSON\n\t\t\ttimestamp: String!\n\t\t}\n\n\t\ttype Subscription {\n\t\t\tcontentStructureUpdated: ContentUpdateEvent!\n\t\t\tentryUpdated(collection: String, id: String): EntryUpdateEvent!\n\t\t}\n\n\t\ttype AccessManagementPermission {\n\t\t\tcontextId: String!\n\t\t\tname: String!\n\t\t\taction: String!\n\t\t\tcontextType: String!\n\t\t\tdescription: String\n\t\t}\n\n\t\ttype Query {\n\t\t\t${collectionsArray\n\t\t\t\t.filter((collection) => collection && collection.name && collection._id)\n\t\t\t\t.map((collection) => `${createCleanTypeName(collection)}(pagination: PaginationInput): [${createCleanTypeName(collection)}]`)\n\t\t\t\t.join('\\n')}\n\t\t\tusers(pagination: PaginationInput): [User]\n\t\t\tme: User\n\t\t\tmediaImages(pagination: PaginationInput): [MediaImage]\n\t\t\tmediaDocuments(pagination: PaginationInput): [MediaDocument]\n\t\t\tmediaAudio(pagination: PaginationInput): [MediaAudio]\n\t\t\tmediaVideos(pagination: PaginationInput): [MediaVideo]\n\t\t\tmediaRemote(pagination: PaginationInput): [MediaRemote]\n\t\t\taccessManagementPermission: AccessManagementPermission\n\n\t\t\t# System Queries\n\t\t\tcollectionStats(collectionId: String!): CollectionStats\n\t\t\tallCollectionStats: [CollectionStats!]\n\t\t\tnavigationStructure(options: NavigationOptions): [NavigationNode]\n\t\t\tnodeChildren(nodeId: String!): [NavigationNode]\n\t\t\tbreadcrumb(path: String!): [BreadcrumbItem]\n\t\t\tcontentManagerHealth: ContentManagerHealth\n\t\t\tcontentManagerDiagnostics: ContentManagerDiagnostics\n\t\t\tcontentManagerMetrics: ContentManagerMetrics\n\t\t\tvalidateContentStructure: StructureValidation\n\t\t}\n\t`;\n\n\tconst collectionsResolversObj = await collectionsResolvers(dbAdapter, cacheClient, tenantId);\n\n\tconst resolvers = {\n\t\tQuery: {\n\t\t\t...collectionsResolversObj.Query,\n\t\t\t...userResolvers(dbAdapter),\n\t\t\t...mediaResolvers(dbAdapter),\n\t\t\t...systemResolvers.Query,\n\t\t\taccessManagementPermission: async (_: unknown, __: unknown, context: { user?: User; locals?: { roles?: Role[] } }) => {\n\t\t\t\tconst { user } = context;\n\t\t\t\tif (!user) {\n\t\t\t\t\tthrow new Error('Unauthorized: No user in context');\n\t\t\t\t}\n\t\t\t\tconst userHasPermission = hasPermissionWithRoles(user, 'config:accessManagement', context.locals?.roles || []);\n\t\t\t\tif (!userHasPermission) {\n\t\t\t\t\tthrow new Error('Forbidden: Insufficient permissions');\n\t\t\t\t}\n\t\t\t\treturn accessManagementPermission;\n\t\t\t}\n\t\t},\n\t\t...Object.keys(collectionsResolversObj)\n\t\t\t.filter((key) => key !== 'Query')\n\t\t\t.reduce(\n\t\t\t\t(acc, key) => {\n\t\t\t\t\tacc[key] = collectionsResolversObj[key];\n\t\t\t\t\treturn acc;\n\t\t\t\t},\n\t\t\t\t{} as Record<string, Record<string, unknown>>\n\t\t\t),\n\t\tSubscription: {\n\t\t\tcontentStructureUpdated: {\n\t\t\t\tsubscribe: (_: unknown, __: unknown, context: { pubSub: any }) => {\n\t\t\t\t\treturn context.pubSub.subscribe('contentStructureUpdated');\n\t\t\t\t},\n\t\t\t\tresolve: (payload: any) => payload\n\t\t\t},\n\t\t\tentryUpdated: {\n\t\t\t\tsubscribe: (_: unknown, _args: { collection?: string; id?: string }, context: { pubSub: any }) => {\n\t\t\t\t\t// Subscribe to all updates\n\t\t\t\t\t// In a real app, you might want to filter by collection/id here if the PubSub supports it,\n\t\t\t\t\t// or filter in the resolver. For simplest implementation: subscribe to channel, modify payload in resolve?\n\t\t\t\t\t// Actually, graphql-yoga pubsub is simple.\n\t\t\t\t\t// We can just subscribe to the channel 'entryUpdated'.\n\t\t\t\t\tconst iterator = context.pubSub.subscribe('entryUpdated');\n\t\t\t\t\t// We can filter in the resolver or using pipe/filter on iterator if needed.\n\t\t\t\t\t// But standard pattern: client receives event and checks if it matches.\n\t\t\t\t\treturn iterator;\n\t\t\t\t},\n\t\t\t\tresolve: (payload: any) => payload\n\t\t\t}\n\t\t}\n\t};\n\n\t// Return raw typeDefs/resolvers; Yoga and WS server will build schemas as needed\n\treturn { typeDefs, resolvers };\n}\n\nasync function setupGraphQL(dbAdapter: DatabaseAdapter, tenantId?: string) {\n\ttry {\n\t\tconst { typeDefs, resolvers } = await createGraphQLSchema(dbAdapter, tenantId);\n\n\t\t// Create GraphQL Yoga app; let Yoga manage the schema from typeDefs/resolvers\n\t\tconst yogaApp = createYoga({\n\t\t\tgraphqlEndpoint: '/api/graphql',\n\t\t\tlandingPage: true,\n\t\t\tplugins: [],\n\t\t\tcors: false,\n\t\t\tgraphiql: {\n\t\t\t\tsubscriptionsProtocol: 'WS'\n\t\t\t},\n\t\t\t// @ts-expect-error Yoga schema type mismatch due to context generics\n\t\t\tschema: createSchema({ typeDefs, resolvers }),\n\t\t\tcontext: async ({ request }) => {\n\t\t\t\t// Extract the context from the request if it was passed\n\t\t\t\tconst contextData = (request as Request & { contextData?: { user: unknown; tenantId?: string } }).contextData;\n\t\t\t\treturn {\n\t\t\t\t\tuser: contextData?.user,\n\t\t\t\t\ttenantId: contextData?.tenantId,\n\t\t\t\t\tlocale: request.headers.get('accept-language')?.split(',')[0]?.trim().slice(0, 2) || 'en', // Simple locale extraction\n\t\t\t\t\tpubSub\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tlogger.info('GraphQL setup completed successfully');\n\t\treturn yogaApp;\n\t} catch (error) {\n\t\tlogger.error('Error setting up GraphQL:', {\n\t\t\terrorMessage: error instanceof Error ? error.message : 'Unknown error',\n\t\t\ttenantId\n\t\t});\n\t\tthrow error;\n\t}\n}\n\n// Store Yoga app promise with a relaxed, generic-any typing to avoid\n// tight coupling to Yoga's internal generics, which are noisy for our use case.\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nlet yogaAppPromise: Promise<ReturnType<typeof createYoga<any, any>>> | null = null;\nlet wsServerInitialized = false;\n\n// NOTE: This is a workaround for SvelteKit not exposing the HTTP server instance.\n// We create a standalone WebSocket server on a different port.\n// In a production environment, you would ideally integrate this with your main HTTP server.\nasync function initializeWebSocketServer(dbAdapter: DatabaseAdapter, tenantId?: string) {\n\tif (wsServerInitialized || building) {\n\t\treturn;\n\t}\n\n\ttry {\n\t\tconst { typeDefs, resolvers } = await createGraphQLSchema(dbAdapter, tenantId);\n\t\tconst schema = createSchema({ typeDefs, resolvers });\n\n\t\tconst wsServer = new WebSocketServer({\n\t\t\tport: 3001,\n\t\t\tpath: '/api/graphql'\n\t\t});\n\n\t\tuseServer(\n\t\t\t{\n\t\t\t\tschema,\n\t\t\t\tcontext: async (ctx) => {\n\t\t\t\t\t// Extract authentication from connection params\n\t\t\t\t\tconst connectionParams = ctx.connectionParams as\n\t\t\t\t\t\t| {\n\t\t\t\t\t\t\t\tauthorization?: string;\n\t\t\t\t\t\t\t\tsessionId?: string;\n\t\t\t\t\t\t\t\tcookie?: string;\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t| undefined;\n\n\t\t\t\t\tlet user = null;\n\n\t\t\t\t\t// Try multiple authentication methods\n\t\t\t\t\tif (connectionParams) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t// Method 1: Bearer token (for API tokens)\n\t\t\t\t\t\t\tif (connectionParams.authorization) {\n\t\t\t\t\t\t\t\tconst token = connectionParams.authorization.replace(/^Bearer\\s+/i, '');\n\t\t\t\t\t\t\t\tconst tokenValidation = await dbAdapter.auth.validateToken(token, undefined, 'access', tenantId);\n\n\t\t\t\t\t\t\t\tif (tokenValidation?.success) {\n\t\t\t\t\t\t\t\t\tconst tokenData = await dbAdapter.auth.getTokenByValue(token, tenantId);\n\t\t\t\t\t\t\t\t\tif (tokenData?.success && tokenData.data) {\n\t\t\t\t\t\t\t\t\t\tconst userResult = await dbAdapter.auth.getUserById(tokenData.data.user_id, tenantId);\n\t\t\t\t\t\t\t\t\t\tif (userResult?.success) {\n\t\t\t\t\t\t\t\t\t\t\tuser = userResult.data;\n\t\t\t\t\t\t\t\t\t\t\tlogger.info('WebSocket: User authenticated via token', { userId: user?._id });\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tlogger.error('WebSocket authentication error:', {\n\t\t\t\t\t\t\t\terror: error instanceof Error ? error.message : 'Unknown error'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tuser,\n\t\t\t\t\t\tpubSub,\n\t\t\t\t\t\ttenantId\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t},\n\t\t\twsServer\n\t\t);\n\n\t\twsServerInitialized = true;\n\t\tlogger.info('GraphQL WebSocket Server initialized on port 3001');\n\t} catch (error) {\n\t\tlogger.error('Failed to initialize WebSocket server:', {\n\t\t\terror: error instanceof Error ? error.message : 'Unknown error'\n\t\t});\n\t}\n}\n\nconst handler = async (event: RequestEvent) => {\n\tconst { locals, request } = event;\n\n\t// Authentication is handled by hooks.server.ts, but let's be extra sure\n\tif (!locals.user) {\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: 'Unauthorized',\n\t\t\t\tmessage: 'You must be logged in to access the GraphQL endpoint.'\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 401,\n\t\t\t\theaders: { 'Content-Type': 'application/json' }\n\t\t\t}\n\t\t);\n\t}\n\n\t// Check if database adapter is available\n\tif (!locals.dbAdapter) {\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: 'Service Unavailable',\n\t\t\t\tmessage: 'Database service is not available.'\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 503,\n\t\t\t\theaders: { 'Content-Type': 'application/json' }\n\t\t\t}\n\t\t);\n\t}\n\n\ttry {\n\t\t// Initialize yogaAppPromise if not already done\n\t\tif (!yogaAppPromise) {\n\t\t\tlogger.debug('Initializing GraphQL Yoga app', { tenantId: locals.tenantId });\n\t\t\tyogaAppPromise = setupGraphQL(locals.dbAdapter, locals.tenantId);\n\t\t}\n\t\tconst yogaApp = await yogaAppPromise;\n\t\tif (!yogaApp) {\n\t\t\tthrow new Error('GraphQL Yoga app failed to initialize');\n\t\t}\n\n\t\t// Initialize WebSocket server if not already done\n\t\tif (!wsServerInitialized) {\n\t\t\tlogger.debug('Initializing WebSocket server', { tenantId: locals.tenantId });\n\t\t\tvoid initializeWebSocketServer(locals.dbAdapter, locals.tenantId);\n\t\t}\n\n\t\t// Create a compatible Request object for GraphQL Yoga\n\t\t// The issue is that SvelteKit's request.url is a URL object, but GraphQL Yoga expects a string\n\t\tconst requestInit: RequestInit = {\n\t\t\tmethod: request.method,\n\t\t\theaders: request.headers\n\t\t};\n\n\t\t// Only add body for non-GET requests\n\t\tif (request.method !== 'GET' && request.body) {\n\t\t\trequestInit.body = request.body;\n\t\t\t// 'duplex' is required for streaming bodies but not in RequestInit type\n\t\t\t// Assign duplex property for streaming bodies (Node.js fetch polyfill)\n\t\t\t(requestInit as RequestInit & { duplex?: string }).duplex = 'half';\n\t\t}\n\n\t\tconst compatibleRequest = new Request(request.url.toString(), requestInit);\n\n\t\t// Add context data to the request object for GraphQL Yoga\n\t\t(compatibleRequest as Request & { contextData?: { user: unknown; tenantId?: string } }).contextData = {\n\t\t\tuser: locals.user,\n\t\t\ttenantId: locals.tenantId\n\t\t};\n\n\t\t// Use GraphQL Yoga's handleRequest method which is designed for server environments\n\t\tconst yogaResponse = await yogaApp.handleRequest(compatibleRequest, {\n\t\t\tuser: locals.user,\n\t\t\ttenantId: locals.tenantId\n\t\t});\n\n\t\tlogger.debug('GraphQL Yoga response:', {\n\t\t\tstatus: yogaResponse?.status,\n\t\t\tstatusText: yogaResponse?.statusText,\n\t\t\theaders: yogaResponse ? Object.fromEntries(yogaResponse.headers.entries()) : 'N/A',\n\t\t\tisResponse: yogaResponse instanceof Response\n\t\t});\n\n\t\tif (!yogaResponse) {\n\t\t\tlogger.error('GraphQL Yoga returned undefined or null response');\n\t\t\tthrow new Error('GraphQL Yoga returned no response');\n\t\t}\n\n\t\t// Return a SvelteKit-compatible Response\n\t\t// FIX: We consume the body to ensure it's loaded and return a new Response\n\t\t// This handles streaming issues where SvelteKit/Node might not like the Yoga stream format directly\n\t\tconst bodyBuffer = await yogaResponse.arrayBuffer();\n\n\t\treturn new Response(bodyBuffer, {\n\t\t\tstatus: yogaResponse.status,\n\t\t\tstatusText: yogaResponse.statusText,\n\t\t\theaders: yogaResponse.headers\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Error handling GraphQL request:', {\n\t\t\terrorMessage: error instanceof Error ? error.message : 'Unknown error',\n\t\t\ttenantId: locals.tenantId\n\t\t});\n\n\t\t// Return proper JSON error response\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: 'Internal Server Error',\n\t\t\t\tmessage: 'An error occurred while processing your GraphQL request.'\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 500,\n\t\t\t\theaders: { 'Content-Type': 'application/json' }\n\t\t\t}\n\t\t);\n\t}\n};\n\n// Export the handlers for GET and POST requests\nexport { handler as GET, handler as POST };\n"],"names":["widgetFunctionsMap","cacheClient"],"mappings":"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"}