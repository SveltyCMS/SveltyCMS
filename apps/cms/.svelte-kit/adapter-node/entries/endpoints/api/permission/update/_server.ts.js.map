{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/permission/update/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/permission/update/+server.ts\n * @description API endpoint for updating permissions and roles via database\n *\n * Supports multi-tenant mode with tenant-specific role isolation.\n */\nimport type { RequestHandler } from './$types';\nimport { json } from '@sveltejs/kit';\nimport { dbAdapter, dbInitPromise } from '@shared/database/db';\nimport { getAllPermissions } from '@shared/database/auth/permissions';\nimport { invalidateRolesCache } from '@cms/hooks/handleAuthorization';\nimport { logger } from '@shared/utils/logger.server';\nimport type { Role } from '@shared/database/auth/types';\n\nconst MAX_ROLE_NAME_LENGTH = 50;\nconst ROLE_NAME_PATTERN = /^[a-zA-Z0-9-_\\s]+$/;\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst user = locals.user;\n\tconst tenantId = locals.tenantId;\n\n\tif (!user) {\n\t\tlogger.warn('Unauthenticated attempt to update permissions', { tenantId });\n\t\treturn json({ success: false, error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\tif (!locals.isAdmin) {\n\t\tlogger.warn('Unauthorized attempt to update permissions', { userId: user._id, tenantId });\n\t\treturn json({ success: false, error: 'Unauthorized' }, { status: 403 });\n\t}\n\n\ttry {\n\t\tawait dbInitPromise;\n\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\treturn json({ success: false, error: 'Database not initialized' }, { status: 500 });\n\t\t}\n\n\t\tconst { roles } = await request.json();\n\n\t\tif (!Array.isArray(roles)) {\n\t\t\treturn json({ success: false, error: 'Roles must be provided as an array' }, { status: 400 });\n\t\t}\n\n\t\tconst validationResult = await validateRoles(roles);\n\t\tif (!validationResult.isValid) {\n\t\t\treturn json({ success: false, error: validationResult.error }, { status: 400 });\n\t\t}\n\n\t\tlogger.info('Updating roles', { userId: user._id, roleCount: roles.length, tenantId });\n\n\t\tconst existingRoles = await dbAdapter.auth.getAllRoles(tenantId);\n\t\tconst existingRoleIds = new Set(existingRoles.map((r) => r._id));\n\t\tconst incomingRoleIds = new Set(roles.map((r: Role) => r._id));\n\n\t\tfor (const existingRole of existingRoles) {\n\t\t\tif (!incomingRoleIds.has(existingRole._id)) {\n\t\t\t\tawait dbAdapter.auth.deleteRole(existingRole._id, tenantId);\n\t\t\t}\n\t\t}\n\n\t\tfor (const role of roles) {\n\t\t\tconst roleData: Role = { ...role, tenantId: tenantId || undefined };\n\t\t\tif (existingRoleIds.has(role._id)) {\n\t\t\t\tawait dbAdapter.auth.updateRole(role._id, roleData, tenantId);\n\t\t\t} else {\n\t\t\t\tawait dbAdapter.auth.createRole(roleData);\n\t\t\t}\n\t\t}\n\n\t\tinvalidateRolesCache(tenantId);\n\t\tlogger.info('Roles updated successfully', { userId: user._id, tenantId });\n\n\t\treturn json({ success: true }, { status: 200 });\n\t} catch (error) {\n\t\tlogger.error('Error updating permissions:', { error, userId: user._id, tenantId });\n\t\treturn json({ success: false, error: `Error: ${error}` }, { status: 500 });\n\t}\n};\n\nasync function validateRoles(roles: Role[]): Promise<{ isValid: boolean; error?: string }> {\n\tif (roles.length === 0) return { isValid: false, error: 'At least one role required' };\n\n\tconst permissions = await getAllPermissions();\n\tconst permissionIds = new Set(permissions.map((p) => p._id));\n\tconst roleNames = new Set<string>();\n\tconst roleIds = new Set<string>();\n\tlet hasAdmin = false;\n\n\tfor (const role of roles) {\n\t\tif (!validateRoleStructure(role)) {\n\t\t\treturn { isValid: false, error: `Invalid structure: ${role.name}` };\n\t\t}\n\t\tif (!validateRoleName(role.name)) {\n\t\t\treturn { isValid: false, error: `Invalid name: ${role.name}` };\n\t\t}\n\t\tif (roleIds.has(role._id)) return { isValid: false, error: `Duplicate ID: ${role._id}` };\n\t\tif (roleNames.has(role.name.toLowerCase())) return { isValid: false, error: `Duplicate name: ${role.name}` };\n\n\t\troleIds.add(role._id);\n\t\troleNames.add(role.name.toLowerCase());\n\n\t\tif (!role.isAdmin) {\n\t\t\tfor (const perm of role.permissions) {\n\t\t\t\tif (!permissionIds.has(perm)) {\n\t\t\t\t\treturn { isValid: false, error: `Invalid permission: ${perm}` };\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (role.isAdmin) hasAdmin = true;\n\t}\n\n\tif (!hasAdmin) return { isValid: false, error: 'At least one admin role required' };\n\treturn { isValid: true };\n}\n\nfunction validateRoleStructure(role: Role): boolean {\n\treturn (\n\t\ttypeof role._id === 'string' &&\n\t\ttypeof role.name === 'string' &&\n\t\tArray.isArray(role.permissions) &&\n\t\trole.permissions.every((p) => typeof p === 'string') &&\n\t\t(role.isAdmin === undefined || typeof role.isAdmin === 'boolean') &&\n\t\t(role.tenantId === undefined || typeof role.tenantId === 'string')\n\t);\n}\n\nfunction validateRoleName(name: string): boolean {\n\treturn name.length > 0 && name.length <= MAX_ROLE_NAME_LENGTH && ROLE_NAME_PATTERN.test(name);\n}\n"],"names":[],"mappings":"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"}