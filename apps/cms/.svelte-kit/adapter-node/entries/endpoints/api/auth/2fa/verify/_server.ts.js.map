{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/auth/2fa/verify/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/auth/2fa/verify/+server.ts\n * @description API endpoint for verifying 2FA codes during authentication\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { getDefaultTwoFactorAuthService } from '@shared/database/auth/twoFactorAuth';\nimport { auth } from '@shared/database/db';\nimport { object, string, parse } from 'valibot';\n\n// Request body schema\nconst verifySchema = object({\n\tuserId: string(),\n\tcode: string()\n});\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\ttry {\n\t\t// This endpoint can be used during login flow, so user might not be fully authenticated yet\n\t\t// The userId will be provided in the request body for verification\n\n\t\t// Parse and validate request body\n\t\tconst body = await request.json();\n\t\tconst validatedBody = parse(verifySchema, body);\n\n\t\t// Get tenant ID from locals if available\n\t\tconst tenantId = locals.user?.tenantId;\n\n\t\t// Verify 2FA code\n\t\tif (!auth) {\n\t\t\tlogger.error('Auth service not initialized during 2FA verification');\n\t\t\tthrow error(500, 'Auth service not available');\n\t\t}\n\t\tconst twoFactorService = getDefaultTwoFactorAuthService(auth.authInterface);\n\t\tconst result = await twoFactorService.verify2FA(validatedBody.userId, validatedBody.code, tenantId);\n\n\t\tif (!result.success) {\n\t\t\tlogger.warn('2FA verification failed', {\n\t\t\t\tuserId: validatedBody.userId,\n\t\t\t\ttenantId,\n\t\t\t\treason: result.message\n\t\t\t});\n\n\t\t\treturn json({\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: result.message\n\t\t\t});\n\t\t}\n\n\t\tlogger.info('2FA verification successful', {\n\t\t\tuserId: validatedBody.userId,\n\t\t\ttenantId,\n\t\t\tmethod: result.method,\n\t\t\tbackupCodeUsed: result.backupCodeUsed\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: result.message,\n\t\t\tmethod: result.method,\n\t\t\tbackupCodeUsed: result.backupCodeUsed\n\t\t});\n\t} catch (err) {\n\t\tconst message = `2FA verification failed: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\n\t\tif (err instanceof Response) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, 'Failed to verify 2FA code');\n\t}\n};\n"],"names":[],"mappings":";;;;;AAaA,MAAM,eAAe,OAAO;AAAA,EAC3B,QAAQ,OAAA;AAAA,EACR,MAAM,OAAA;AACP,CAAC;AAEM,MAAM,OAAuB,OAAO,EAAE,SAAS,aAAa;AAClE,MAAI;AAKH,UAAM,OAAO,MAAM,QAAQ,KAAA;AAC3B,UAAM,gBAAgB,MAAM,cAAc,IAAI;AAG9C,UAAM,WAAW,OAAO,MAAM;AAG9B,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,sDAAsD;AACnE,YAAM,MAAM,KAAK,4BAA4B;AAAA,IAC9C;AACA,UAAM,mBAAmB,+BAA+B,KAAK,aAAa;AAC1E,UAAM,SAAS,MAAM,iBAAiB,UAAU,cAAc,QAAQ,cAAc,MAAM,QAAQ;AAElG,QAAI,CAAC,OAAO,SAAS;AACpB,aAAO,KAAK,2BAA2B;AAAA,QACtC,QAAQ,cAAc;AAAA,QACtB;AAAA,QACA,QAAQ,OAAO;AAAA,MAAA,CACf;AAED,aAAO,KAAK;AAAA,QACX,SAAS;AAAA,QACT,SAAS,OAAO;AAAA,MAAA,CAChB;AAAA,IACF;AAEA,WAAO,KAAK,+BAA+B;AAAA,MAC1C,QAAQ,cAAc;AAAA,MACtB;AAAA,MACA,QAAQ,OAAO;AAAA,MACf,gBAAgB,OAAO;AAAA,IAAA,CACvB;AAED,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,SAAS,OAAO;AAAA,MAChB,QAAQ,OAAO;AAAA,MACf,gBAAgB,OAAO;AAAA,IAAA,CACvB;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,4BAA4B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC5F,WAAO,MAAM,OAAO;AAEpB,QAAI,eAAe,UAAU;AAC5B,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,2BAA2B;AAAA,EAC7C;AACD;"}