{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/auth/2fa/setup/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/auth/2fa/setup/+server.ts\n * @description API endpoint for initiating 2FA setup\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { getDefaultTwoFactorAuthService } from '@shared/database/auth/twoFactorAuth';\nimport { auth } from '@shared/database/db';\n\nexport const POST: RequestHandler = async ({ locals }) => {\n\ttry {\n\t\t// Ensure user is authenticated\n\t\tif (!locals.user) {\n\t\t\tlogger.warn('Unauthorized 2FA setup attempt');\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tconst user = locals.user;\n\t\tconst tenantId = user.tenantId;\n\n\t\t// Check if 2FA is already enabled\n\t\tif (user.is2FAEnabled) {\n\t\t\tlogger.warn('2FA setup attempted for user with 2FA already enabled', {\n\t\t\t\tuserId: user._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\tthrow error(400, '2FA is already enabled for this account');\n\t\t}\n\n\t\t// Initialize 2FA setup\n\t\tif (!auth) {\n\t\t\tlogger.error('Auth service not initialized during 2FA setup initiation');\n\t\t\tthrow error(500, 'Auth service not available');\n\t\t}\n\t\tconst twoFactorService = getDefaultTwoFactorAuthService(auth.authInterface);\n\t\tconst setupData = await twoFactorService.initiate2FASetup(user._id, user.email, tenantId);\n\n\t\tlogger.info('2FA setup initiated', { userId: user._id, tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: setupData,\n\t\t\tmessage: '2FA setup initiated. Please save your backup codes and scan the QR code with your authenticator app.'\n\t\t});\n\t} catch (err) {\n\t\tconst message = `2FA setup initiation failed: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\n\t\tif (err instanceof Response) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, 'Failed to initiate 2FA setup');\n\t}\n};\n"],"names":[],"mappings":";;;;AAWO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AAEH,QAAI,CAAC,OAAO,MAAM;AACjB,aAAO,KAAK,gCAAgC;AAC5C,YAAM,MAAM,KAAK,yBAAyB;AAAA,IAC3C;AAEA,UAAM,OAAO,OAAO;AACpB,UAAM,WAAW,KAAK;AAGtB,QAAI,KAAK,cAAc;AACtB,aAAO,KAAK,yDAAyD;AAAA,QACpE,QAAQ,KAAK;AAAA,QACb;AAAA,MAAA,CACA;AACD,YAAM,MAAM,KAAK,yCAAyC;AAAA,IAC3D;AAGA,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,0DAA0D;AACvE,YAAM,MAAM,KAAK,4BAA4B;AAAA,IAC9C;AACA,UAAM,mBAAmB,+BAA+B,KAAK,aAAa;AAC1E,UAAM,YAAY,MAAM,iBAAiB,iBAAiB,KAAK,KAAK,KAAK,OAAO,QAAQ;AAExF,WAAO,KAAK,uBAAuB,EAAE,QAAQ,KAAK,KAAK,UAAU;AAEjE,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,MACN,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,gCAAgC,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAChG,WAAO,MAAM,OAAO;AAEpB,QAAI,eAAe,UAAU;AAC5B,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,8BAA8B;AAAA,EAChD;AACD;"}