{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/auth/2fa/disable/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/auth/2fa/disable/+server.ts\n * @description API endpoint for disabling 2FA\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { getDefaultTwoFactorAuthService } from '@shared/database/auth/twoFactorAuth';\nimport { auth } from '@shared/database/db';\n\nexport const POST: RequestHandler = async ({ locals }) => {\n\ttry {\n\t\t// Ensure user is authenticated\n\t\tif (!locals.user) {\n\t\t\tlogger.warn('Unauthorized 2FA disable attempt');\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tconst user = locals.user;\n\t\tconst tenantId = user.tenantId;\n\n\t\t// Check if 2FA is enabled\n\t\tif (!user.is2FAEnabled) {\n\t\t\tlogger.warn('2FA disable attempted for user without 2FA enabled', {\n\t\t\t\tuserId: user._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\tthrow error(400, '2FA is not enabled for this account');\n\t\t}\n\n\t\t// Disable 2FA\n\t\tif (!auth) {\n\t\t\tlogger.error('Auth service not initialized during 2FA disable request');\n\t\t\tthrow error(500, 'Auth service not available');\n\t\t}\n\t\tconst twoFactorService = getDefaultTwoFactorAuthService(auth.authInterface);\n\t\tconst success = await twoFactorService.disable2FA(user._id, tenantId);\n\n\t\tif (!success) {\n\t\t\tlogger.error('Failed to disable 2FA', { userId: user._id, tenantId });\n\t\t\tthrow error(500, 'Failed to disable 2FA');\n\t\t}\n\n\t\tlogger.info('2FA disabled successfully', { userId: user._id, tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: '2FA has been disabled for your account.'\n\t\t});\n\t} catch (err) {\n\t\tconst message = `2FA disable failed: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\n\t\tif (err instanceof Response) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, 'Failed to disable 2FA');\n\t}\n};\n"],"names":[],"mappings":";;;;AAWO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AAEH,QAAI,CAAC,OAAO,MAAM;AACjB,aAAO,KAAK,kCAAkC;AAC9C,YAAM,MAAM,KAAK,yBAAyB;AAAA,IAC3C;AAEA,UAAM,OAAO,OAAO;AACpB,UAAM,WAAW,KAAK;AAGtB,QAAI,CAAC,KAAK,cAAc;AACvB,aAAO,KAAK,sDAAsD;AAAA,QACjE,QAAQ,KAAK;AAAA,QACb;AAAA,MAAA,CACA;AACD,YAAM,MAAM,KAAK,qCAAqC;AAAA,IACvD;AAGA,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,yDAAyD;AACtE,YAAM,MAAM,KAAK,4BAA4B;AAAA,IAC9C;AACA,UAAM,mBAAmB,+BAA+B,KAAK,aAAa;AAC1E,UAAM,UAAU,MAAM,iBAAiB,WAAW,KAAK,KAAK,QAAQ;AAEpE,QAAI,CAAC,SAAS;AACb,aAAO,MAAM,yBAAyB,EAAE,QAAQ,KAAK,KAAK,UAAU;AACpE,YAAM,MAAM,KAAK,uBAAuB;AAAA,IACzC;AAEA,WAAO,KAAK,6BAA6B,EAAE,QAAQ,KAAK,KAAK,UAAU;AAEvE,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,uBAAuB,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACvF,WAAO,MAAM,OAAO;AAEpB,QAAI,eAAe,UAAU;AAC5B,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;"}