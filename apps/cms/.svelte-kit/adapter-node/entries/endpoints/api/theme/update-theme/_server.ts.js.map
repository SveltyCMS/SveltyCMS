{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/theme/update-theme/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/theme/update-theme/+server.ts\n * @description Server-side handler for updating the current theme for a tenant.\n *\n * @example POST /api/theme/update-theme\n *\n * Features:\n * - Updates the current theme based on the provided theme name in the request body.\n * - Checks if the user has permission to update the theme.\n * - Throws an error if the theme does not exist in the database for the current tenant.\n * - Throws an error if the theme update fails.\n * - Returns the updated theme in the response.\n */\n\nimport type { RequestHandler } from './$types';\nimport { ThemeManager } from '@shared/database/themeManager';\nimport { dbAdapter } from '@shared/database/db';\nimport type { DatabaseId } from '@shared/database/dbInterface';\nimport { json, error } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Permission checking\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Initialize ThemeManager singleton\nconst themeManager = ThemeManager.getInstance();\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\t// Authentication is handled by hooks.server.ts\n\tif (!user) {\n\t\treturn json({ success: false, error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t}\n\n\tconst { themeId, customCss } = await request.json();\n\n\tif (!themeId || typeof themeId !== 'string') {\n\t\tlogger.warn(`Invalid theme ID provided: ${themeId}`, { tenantId });\n\t\tthrow error(400, 'Invalid theme ID.');\n\t}\n\n\ttry {\n\t\tif (!dbAdapter) {\n\t\t\tthrow new Error('Database adapter is not initialized');\n\t\t}\n\n\t\t// Fetch the theme from the database to ensure it exists for the current tenant\n\t\tconst themeResult = await dbAdapter.themes.update(themeId as unknown as DatabaseId, { customCss });\n\n\t\tif (!themeResult.success || !themeResult.data) {\n\t\t\tlogger.warn(`Theme '${themeId}' does not exist or update failed for this tenant.`, { tenantId });\n\t\t\tthrow error(404, `Theme '${themeId}' does not exist or update failed.`);\n\t\t}\n\n\t\tconst updatedTheme = themeResult.data;\n\n\t\t// Invalidate theme cache after update\n\t\tawait themeManager.refresh();\n\n\t\tlogger.info(`Theme '${updatedTheme.name}' custom CSS successfully updated by user '${user._id}'.`, { tenantId });\n\n\t\treturn json({ success: true, theme: updatedTheme });\n\t} catch (err) {\n\t\tconst errorMessage = err instanceof Error ? err.message : String(err);\n\t\tlogger.error('Error updating theme custom CSS:', { error: errorMessage, tenantId });\n\t\treturn json({ success: false, error: `Error updating theme custom CSS: ${errorMessage}` }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":";;;;;AA2BA,MAAM,eAAe,aAAa,YAAA;AAE3B,MAAM,OAAuB,OAAO,EAAE,SAAS,aAAa;AAClE,QAAM,EAAE,MAAM,SAAA,IAAa;AAG3B,MAAI,CAAC,MAAM;AACV,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,kBAAkB,EAAE,QAAQ,KAAK;AAAA,EACvE;AAEA,MAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,UAAM,MAAM,KAAK,oDAAoD;AAAA,EACtE;AAEA,QAAM,EAAE,SAAS,UAAA,IAAc,MAAM,QAAQ,KAAA;AAE7C,MAAI,CAAC,WAAW,OAAO,YAAY,UAAU;AAC5C,WAAO,KAAK,8BAA8B,OAAO,IAAI,EAAE,UAAU;AACjE,UAAM,MAAM,KAAK,mBAAmB;AAAA,EACrC;AAEA,MAAI;AACH,QAAI,CAAC,WAAW;AACf,YAAM,IAAI,MAAM,qCAAqC;AAAA,IACtD;AAGA,UAAM,cAAc,MAAM,UAAU,OAAO,OAAO,SAAkC,EAAE,WAAW;AAEjG,QAAI,CAAC,YAAY,WAAW,CAAC,YAAY,MAAM;AAC9C,aAAO,KAAK,UAAU,OAAO,sDAAsD,EAAE,UAAU;AAC/F,YAAM,MAAM,KAAK,UAAU,OAAO,oCAAoC;AAAA,IACvE;AAEA,UAAM,eAAe,YAAY;AAGjC,UAAM,aAAa,QAAA;AAEnB,WAAO,KAAK,UAAU,aAAa,IAAI,8CAA8C,KAAK,GAAG,MAAM,EAAE,SAAA,CAAU;AAE/G,WAAO,KAAK,EAAE,SAAS,MAAM,OAAO,cAAc;AAAA,EACnD,SAAS,KAAK;AACb,UAAM,eAAe,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG;AACpE,WAAO,MAAM,oCAAoC,EAAE,OAAO,cAAc,UAAU;AAClF,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,oCAAoC,YAAY,GAAA,GAAM,EAAE,QAAQ,IAAA,CAAK;AAAA,EAC3G;AACD;"}