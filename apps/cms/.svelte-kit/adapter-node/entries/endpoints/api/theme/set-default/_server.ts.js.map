{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/theme/set-default/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/theme/set-default/+server.ts\n * @description Server-side handler for setting the default theme for a tenant.\n *\n * @example POST /api/theme/set-default\n *\n * Features:\n * - Sets the provided theme as the default for the current tenant.\n * - Checks if the user has permission to update the theme.\n * - Throws an error if the theme update fails.\n * - Returns the updated theme in the response.\n */\n\nimport type { RequestHandler } from './$types';\nimport { ThemeManager } from '@shared/database/themeManager';\nimport { dbAdapter } from '@shared/database/db';\nimport type { Theme, DatabaseId } from '@shared/database/dbInterface';\nimport { json, error } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Permission checking\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Initialize ThemeManager singleton\nconst themeManager = ThemeManager.getInstance();\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\t// Authentication is handled by hooks.server.ts\n\tif (!user) {\n\t\treturn json({ success: false, error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t}\n\n\tconst { themeId } = await request.json();\n\n\tif (!themeId || typeof themeId !== 'string') {\n\t\tlogger.warn(`Invalid theme ID provided: ${themeId}`, { tenantId });\n\t\tthrow error(400, 'Invalid theme ID.');\n\t}\n\n\ttry {\n\t\tif (!dbAdapter) {\n\t\t\tthrow new Error('Database adapter is not initialized');\n\t\t}\n\n\t\t// Set the selected theme as the default in the database for the current tenant\n\t\tawait dbAdapter.themes.setDefault(themeId as unknown as DatabaseId);\n\n\t\t// Invalidate theme cache to apply changes immediately\n\t\tawait themeManager.refresh();\n\n\t\t// Fetch the updated default theme to confirm the change\n\t\tconst updatedTheme: Theme = await themeManager.getTheme(tenantId);\n\n\t\tlogger.info(`Default theme successfully set to '${updatedTheme.name}' by user '${user._id}'.`, { tenantId });\n\n\t\treturn json({ success: true, theme: updatedTheme });\n\t} catch (err) {\n\t\tconst errorMessage = err instanceof Error ? err.message : String(err);\n\t\tlogger.error('Error setting default theme:', { error: errorMessage, tenantId });\n\t\treturn json({ success: false, error: `Error setting default theme: ${errorMessage}` }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":";;;;;AA0BA,MAAM,eAAe,aAAa,YAAA;AAE3B,MAAM,OAAuB,OAAO,EAAE,SAAS,aAAa;AAClE,QAAM,EAAE,MAAM,SAAA,IAAa;AAG3B,MAAI,CAAC,MAAM;AACV,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,kBAAkB,EAAE,QAAQ,KAAK;AAAA,EACvE;AAEA,MAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,UAAM,MAAM,KAAK,oDAAoD;AAAA,EACtE;AAEA,QAAM,EAAE,QAAA,IAAY,MAAM,QAAQ,KAAA;AAElC,MAAI,CAAC,WAAW,OAAO,YAAY,UAAU;AAC5C,WAAO,KAAK,8BAA8B,OAAO,IAAI,EAAE,UAAU;AACjE,UAAM,MAAM,KAAK,mBAAmB;AAAA,EACrC;AAEA,MAAI;AACH,QAAI,CAAC,WAAW;AACf,YAAM,IAAI,MAAM,qCAAqC;AAAA,IACtD;AAGA,UAAM,UAAU,OAAO,WAAW,OAAgC;AAGlE,UAAM,aAAa,QAAA;AAGnB,UAAM,eAAsB,MAAM,aAAa,SAAS,QAAQ;AAEhE,WAAO,KAAK,sCAAsC,aAAa,IAAI,cAAc,KAAK,GAAG,MAAM,EAAE,SAAA,CAAU;AAE3G,WAAO,KAAK,EAAE,SAAS,MAAM,OAAO,cAAc;AAAA,EACnD,SAAS,KAAK;AACb,UAAM,eAAe,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG;AACpE,WAAO,MAAM,gCAAgC,EAAE,OAAO,cAAc,UAAU;AAC9E,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,gCAAgC,YAAY,GAAA,GAAM,EAAE,QAAQ,IAAA,CAAK;AAAA,EACvG;AACD;"}