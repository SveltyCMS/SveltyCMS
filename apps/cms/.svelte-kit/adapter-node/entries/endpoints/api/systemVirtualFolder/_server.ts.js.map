{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/systemVirtualFolder/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/systemVirtualFolder/+server.ts\n * @description API endpoint for system virtual folder operations\n *\n * @example POST /api/systemVirtualFolder - Creates a new system virtual folder\n *\n * Features:\n * - Create a new system virtual folder, scoped to the current tenant.\n * - Secure, granular access control per operation.\n * - Status-based access control for non-admin users.\n * - ModifyRequest support for widget-based data processing.\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Database\nimport { dbAdapter } from '@shared/database/db';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Types\nimport type { SystemVirtualFolder } from '@shared/database/dbInterface';\nimport type { DatabaseId } from '@cms-types';\n\n// GET /api/systemVirtualFolder - Fetches all system virtual folders for the current tenant\nexport const GET: RequestHandler = async ({ locals }) => {\n\tconst { user, tenantId } = locals;\n\ttry {\n\t\t// Check authentication\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\t// Check if dbAdapter is initialized\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\tthrow error(500, 'Database adapter not initialized');\n\t\t}\n\n\t\t// Check if dbAdapter has systemVirtualFolder interface\n\t\tif (!dbAdapter.systemVirtualFolder) {\n\t\t\tlogger.error('Database adapter systemVirtualFolder interface not available');\n\t\t\tthrow error(500, 'Database adapter systemVirtualFolder interface not available');\n\t\t}\n\n\t\t// --- MULTI-TENANCY: Scope the query by tenantId ---\n\t\tconst result = await dbAdapter.systemVirtualFolder.getAll();\n\n\t\tif (!result.success) {\n\t\t\tlogger.error('Database query failed', { error: result.error });\n\t\t\tthrow error(500, result.error?.message || 'Database query failed');\n\t\t}\n\n\t\tconst folders = result.data || [];\n\n\t\tlogger.debug(`Fetched ${folders.length} system virtual folders`, { tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: folders\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : 'Unknown error occurred';\n\t\tlogger.error(`Error fetching system virtual folders: ${message}`, { tenantId });\n\n\t\tthrow error(500, message);\n\t}\n};\n\n// POST /api/systemVirtualFolder - Creates a new system virtual folder for the current tenant\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\ttry {\n\t\t// Check authentication\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t} // Parse request body\n\n\t\tconst body = await request.json();\n\t\tconst { name, parentId } = body; // Validate required fields\n\n\t\tif (!name || typeof name !== 'string') {\n\t\t\tthrow error(400, 'Name is required and must be a string');\n\t\t}\n\n\t\t// Check if dbAdapter is initialized\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\tthrow error(500, 'Database adapter not initialized');\n\t\t}\n\n\t\t// Build the path based on parent folder\n\t\tlet folderPath = '';\n\t\tif (parentId) {\n\t\t\tconst parentResult = await dbAdapter.systemVirtualFolder.getById(parentId as DatabaseId);\n\t\t\tif (parentResult.success && parentResult.data) {\n\t\t\t\tfolderPath = `${parentResult.data.path}/${name.trim()}`;\n\t\t\t} else {\n\t\t\t\tthrow error(400, 'Parent folder not found');\n\t\t\t}\n\t\t} else {\n\t\t\t// Root level folder\n\t\t\tfolderPath = `/${name.trim()}`;\n\t\t}\n\n\t\t// Create folder data, including tenantId if in multi-tenant mode\n\t\tconst folderData: Omit<SystemVirtualFolder, '_id' | 'createdAt' | 'updatedAt'> = {\n\t\t\tname: name.trim(),\n\t\t\tpath: folderPath,\n\t\t\ttype: 'folder',\n\t\t\tparentId: parentId ? (parentId as DatabaseId) : null,\n\t\t\torder: 0,\n\t\t\t...(getPrivateSettingSync('MULTI_TENANT') && { tenantId })\n\t\t}; // Create the folder\n\n\t\tconst result = await dbAdapter.systemVirtualFolder.create(folderData);\n\n\t\tif (!result.success) {\n\t\t\tlogger.error('Database insert failed', { error: result.error });\n\t\t\tthrow error(500, result.error?.message || 'Database insert failed');\n\t\t}\n\n\t\tconst newFolder = result.data;\n\n\t\tlogger.info(`Created system virtual folder: ${folderData.name}`, { tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tfolder: newFolder\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : 'Unknown error occurred';\n\t\tlogger.error(`Error creating system virtual folder: ${message}`, { tenantId });\n\n\t\tthrow error(500, message);\n\t}\n};\n\n// PATCH /api/systemVirtualFolder - Handles folder reordering\nexport const PATCH: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\ttry {\n\t\t// Check authentication\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\tconst body = await request.json();\n\t\tconst { action, orderUpdates } = body;\n\n\t\tif (action !== 'reorder') {\n\t\t\tthrow error(400, 'Invalid action');\n\t\t}\n\n\t\tif (!Array.isArray(orderUpdates)) {\n\t\t\tthrow error(400, 'orderUpdates must be an array');\n\t\t}\n\n\t\t// Check if dbAdapter is initialized\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\tthrow error(500, 'Database adapter not initialized');\n\t\t}\n\n\t\t// Store reference for use in async callbacks\n\t\tconst adapter = dbAdapter;\n\n\t\t// Update each folder in a transaction\n\t\tconst results = await Promise.all(\n\t\t\torderUpdates.map(async (update: { folderId: string; order: number; parentId?: string | null }) => {\n\t\t\t\tconst { folderId, order, parentId: newParentId } = update;\n\n\t\t\t\t// Get current folder to access its name\n\t\t\t\tconst currentFolder = await adapter.systemVirtualFolder.getById(folderId as DatabaseId);\n\t\t\t\tif (!currentFolder.success || !currentFolder.data) {\n\t\t\t\t\tlogger.error('Folder not found for reordering', { folderId });\n\t\t\t\t\treturn { success: false, error: { message: 'Folder not found' } };\n\t\t\t\t}\n\n\t\t\t\tconst updateData: Partial<SystemVirtualFolder> = { order };\n\n\t\t\t\t// If parentId changed, rebuild path\n\t\t\t\tif (newParentId !== undefined) {\n\t\t\t\t\tupdateData.parentId = newParentId ? (newParentId as DatabaseId) : null;\n\n\t\t\t\t\t// Build new path based on new parent\n\t\t\t\t\tif (newParentId) {\n\t\t\t\t\t\tconst parentResult = await adapter.systemVirtualFolder.getById(newParentId as DatabaseId);\n\t\t\t\t\t\tif (parentResult.success && parentResult.data) {\n\t\t\t\t\t\t\tupdateData.path = `${parentResult.data.path}/${currentFolder.data.name}`;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlogger.warn('Parent folder not found, using root path', { parentId: newParentId });\n\t\t\t\t\t\t\tupdateData.path = `/${currentFolder.data.name}`;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Moving to root\n\t\t\t\t\t\tupdateData.path = `/${currentFolder.data.name}`;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn adapter.systemVirtualFolder.update(folderId as DatabaseId, updateData);\n\t\t\t})\n\t\t);\n\n\t\tconst errors = results.filter((r) => !r.success);\n\t\tif (errors.length > 0) {\n\t\t\tlogger.error('Error reordering folders', { errors });\n\t\t\tthrow error(500, 'Error reordering folders');\n\t\t}\n\n\t\tlogger.info('Reordered folders successfully', { tenantId });\n\n\t\treturn json({ success: true });\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : 'Unknown error occurred';\n\t\tlogger.error(`Error reordering folders: ${message}`, { tenantId });\n\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":[],"mappings":"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"}