{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/systemVirtualFolder/[id]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/systemVirtualFolder/[id]/+server.ts\n * @description API endpoint for individual system virtual folder operations\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { dbAdapter } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\nimport type { SystemVirtualFolder } from '@shared/database/dbInterface';\nimport { constructMediaUrl } from '@shared/utils/media/mediaUtils';\nimport type { ISODateString } from '@cms-types';\n\ntype MediaDoc = {\n\t_id?: string;\n\tfilename?: string;\n\tvirtualFolderId?: string | null;\n\tthumbnailWidth?: number;\n\tthumbnailHeight?: number;\n\t[key: string]: unknown;\n};\n\n// GET /api/systemVirtualFolder/[id] - Fetches contents of a specific virtual folder\nexport const GET: RequestHandler = async ({ params, locals }) => {\n\tconst { user, tenantId } = locals;\n\tconst { id } = params;\n\n\ttry {\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database adapter not available');\n\t\t}\n\n\t\tlet currentFolder: SystemVirtualFolder | null = null;\n\t\tlet folders: SystemVirtualFolder[] = [];\n\t\tlet files: MediaDoc[] = [];\n\n\t\tconst tenantFilter = getPrivateSettingSync('MULTI_TENANT') ? { tenantId } : {};\n\n\t\tif (id === 'root') {\n\t\t\t// Root folder - get top-level folders and files\n\t\t\tconst folderResult = await dbAdapter.systemVirtualFolder.getByParentId(null);\n\t\t\tfolders = folderResult.success ? folderResult.data || [] : [];\n\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst fileQuery = { virtualFolderId: null, ...tenantFilter } as any;\n\t\t\tconst [imagesResult, documentsResult, audioResult, videosResult] = await Promise.all([\n\t\t\t\tdbAdapter.crud.findMany('media_images', fileQuery),\n\t\t\t\tdbAdapter.crud.findMany('media_documents', fileQuery),\n\t\t\t\tdbAdapter.crud.findMany('media_audio', fileQuery),\n\t\t\t\tdbAdapter.crud.findMany('media_videos', fileQuery)\n\t\t\t]);\n\t\t\tconst images = imagesResult.success ? ((imagesResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tconst documents = documentsResult.success ? ((documentsResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tconst audio = audioResult.success ? ((audioResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tconst videos = videosResult.success ? ((videosResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tfiles = [...images, ...documents, ...audio, ...videos];\n\t\t} else {\n\t\t\t// Specific folder\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst folderResult = await dbAdapter.systemVirtualFolder.getById(id as any);\n\t\t\tcurrentFolder = folderResult.success ? folderResult.data : null;\n\n\t\t\tif (!currentFolder) {\n\t\t\t\tthrow error(404, 'Folder not found');\n\t\t\t}\n\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst subfolderResult = await dbAdapter.systemVirtualFolder.getByParentId(id as any);\n\t\t\tfolders = subfolderResult.success ? subfolderResult.data || [] : [];\n\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst fileQuery = { virtualFolderId: id, ...tenantFilter } as any;\n\t\t\tconst [imagesResult, documentsResult, audioResult, videosResult] = await Promise.all([\n\t\t\t\tdbAdapter.crud.findMany('media_images', fileQuery),\n\t\t\t\tdbAdapter.crud.findMany('media_documents', fileQuery),\n\t\t\t\tdbAdapter.crud.findMany('media_audio', fileQuery),\n\t\t\t\tdbAdapter.crud.findMany('media_videos', fileQuery)\n\t\t\t]);\n\t\t\tconst images = imagesResult.success ? ((imagesResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tconst documents = documentsResult.success ? ((documentsResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tconst audio = audioResult.success ? ((audioResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tconst videos = videosResult.success ? ((videosResult.data || []) as unknown as MediaDoc[]) : [];\n\t\t\tfiles = [...images, ...documents, ...audio, ...videos];\n\t\t}\n\n\t\t// Process files with URL construction\n\t\tconst processedFiles = files.map((file) => {\n\t\t\ttry {\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\tconst originalUrl = constructMediaUrl(file as any, 'original');\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\tconst thumbnailUrl = constructMediaUrl(file as any, 'thumbnail');\n\t\t\t\treturn {\n\t\t\t\t\t...file,\n\t\t\t\t\turl: originalUrl,\n\t\t\t\t\tthumbnail: {\n\t\t\t\t\t\turl: thumbnailUrl,\n\t\t\t\t\t\twidth: file.thumbnailWidth || 200,\n\t\t\t\t\t\theight: file.thumbnailHeight || 200\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t} catch (err) {\n\t\t\t\tlogger.warn(`Failed to construct URL for file ${file.filename}: ${err}`);\n\t\t\t\treturn {\n\t\t\t\t\t...file,\n\t\t\t\t\turl: '/Default_User.svg',\n\t\t\t\t\tthumbnail: {\n\t\t\t\t\t\turl: '/Default_User.svg',\n\t\t\t\t\t\twidth: 200,\n\t\t\t\t\t\theight: 200\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tlogger.debug(`Fetched folder ${id}: ${processedFiles.length} files, ${folders.length} subfolders`, { tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tcurrentFolder,\n\t\t\t\tcontents: {\n\t\t\t\t\tfiles: processedFiles,\n\t\t\t\t\tfolders\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : 'Unknown error occurred';\n\t\tlogger.error(`Error fetching folder contents for ${id}: ${message}`, { tenantId });\n\t\tthrow error(500, message);\n\t}\n};\n\n// PATCH /api/systemVirtualFolder/[id] - Update a folder\nexport const PATCH: RequestHandler = async ({ params, request, locals }) => {\n\tconst { user, tenantId } = locals;\n\tconst { id } = params;\n\n\ttry {\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database adapter not available');\n\t\t}\n\n\t\tconst body = await request.json();\n\t\tconst { name } = body;\n\n\t\tif (!name || typeof name !== 'string') {\n\t\t\tthrow error(400, 'Name is required and must be a string');\n\t\t}\n\n\t\t// Get the current folder to update its path\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tconst currentResult = await dbAdapter.systemVirtualFolder.getById(id as any);\n\t\tif (!currentResult.success || !currentResult.data) {\n\t\t\tthrow error(404, 'Folder not found');\n\t\t}\n\n\t\tconst currentFolder = currentResult.data;\n\n\t\t// Build new path\n\t\tlet newPath = '';\n\t\tif (currentFolder.parentId) {\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst parentResult = await dbAdapter.systemVirtualFolder.getById(currentFolder.parentId as any);\n\t\t\tif (parentResult.success && parentResult.data) {\n\t\t\t\tnewPath = `${parentResult.data.path}/${name.trim()}`;\n\t\t\t} else {\n\t\t\t\tthrow error(400, 'Parent folder not found');\n\t\t\t}\n\t\t} else {\n\t\t\tnewPath = `/${name.trim()}`;\n\t\t}\n\n\t\tconst updateData = {\n\t\t\tname: name.trim(),\n\t\t\tpath: newPath,\n\t\t\tupdatedAt: new Date().toISOString() as ISODateString\n\t\t};\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tconst result = await dbAdapter.systemVirtualFolder.update(id as any, updateData);\n\n\t\tif (!result.success) {\n\t\t\tlogger.error('Failed to update folder', { error: result.error });\n\t\t\tthrow error(500, result.error?.message || 'Failed to update folder');\n\t\t}\n\n\t\tlogger.info(`Updated system virtual folder: ${name}`, { tenantId, folderId: id });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tfolder: result.data\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : 'Unknown error occurred';\n\t\tlogger.error(`Error updating system virtual folder: ${message}`, { tenantId, folderId: id });\n\t\tthrow error(500, message);\n\t}\n};\n\n// DELETE /api/systemVirtualFolder/[id] - Delete a folder\nexport const DELETE: RequestHandler = async ({ params, locals }) => {\n\tconst { user, tenantId } = locals;\n\tconst { id } = params;\n\n\ttry {\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database adapter not available');\n\t\t}\n\n\t\t// Check if folder has children\n\t\tconst allFoldersResult = await dbAdapter.systemVirtualFolder.getAll();\n\t\tif (allFoldersResult.success && allFoldersResult.data) {\n\t\t\tconst hasChildren = allFoldersResult.data.some((f: SystemVirtualFolder) => f.parentId === id);\n\t\t\tif (hasChildren) {\n\t\t\t\tthrow error(400, 'Cannot delete folder with subfolders. Delete subfolders first.');\n\t\t\t}\n\t\t}\n\n\t\t// Check if folder has media files\n\t\t// TODO: Add media file check when media is properly linked to folders\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tconst result = await dbAdapter.systemVirtualFolder.delete(id as any);\n\n\t\tif (!result.success) {\n\t\t\tlogger.error('Failed to delete folder', { error: result.error });\n\t\t\tthrow error(500, result.error?.message || 'Failed to delete folder');\n\t\t}\n\n\t\tlogger.info(`Deleted system virtual folder`, { tenantId, folderId: id });\n\n\t\treturn json({\n\t\t\tsuccess: true\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : 'Unknown error occurred';\n\t\tlogger.error(`Error deleting system virtual folder: ${message}`, { tenantId, folderId: id });\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":[],"mappings":"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"}