{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/admin/users/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/admin/users/+server.ts\n * @description API endpoint for fetching users with pagination, sorting, and filtering.\n *\n * This endpoint is designed for the Admin Area to efficiently query user data.\n * It is protected and can only be accessed by users with administrative privileges.\n *\n * @usage\n * GET /api/admin/users?page=1&limit=10&sort=createdAt&order=desc&search=john\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\nimport { auth, dbAdapter } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\tconst { user, tenantId, hasManageUsersPermission } = locals;\n\n\t// Security: Ensure the user is authenticated and has admin-level permissions.\n\t// This is largely handled by hooks, but we add a redundant check here for safety.\n\tif (!user || !hasManageUsersPermission) {\n\t\tthrow error(403, 'Forbidden: You do not have permission to access this resource.');\n\t}\n\n\tif (!auth || !dbAdapter) {\n\t\tthrow error(500, 'Authentication system is not initialized');\n\t}\n\n\ttry {\n\t\tconst page = parseInt(url.searchParams.get('page') || '1');\n\t\tconst limit = parseInt(url.searchParams.get('limit') || '10');\n\t\tconst sort = url.searchParams.get('sort') || 'createdAt';\n\t\tconst order = url.searchParams.get('order') === 'asc' ? 1 : -1;\n\t\tconst search = url.searchParams.get('search') || '';\n\n\t\t// Build filter for database query\n\t\tconst filter: Record<string, unknown> = {};\n\n\t\t// Apply tenant ID if in multi-tenant mode\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && tenantId) {\n\t\t\tfilter.tenantId = tenantId;\n\t\t}\n\n\t\t// Add search query if provided (MongoDB-style query)\n\t\tif (search) {\n\t\t\tfilter.$or = [{ username: { $regex: search, $options: 'i' } }, { email: { $regex: search, $options: 'i' } }];\n\t\t}\n\n\t\t// Build pagination options for the adapter\n\t\tconst options = {\n\t\t\tfilter,\n\t\t\tlimit,\n\t\t\toffset: (page - 1) * limit,\n\t\t\tsort: { [sort]: order === 1 ? 'asc' : 'desc' } as { [key: string]: 'asc' | 'desc' }\n\t\t};\n\n\t\t// Use the database adapter directly for full pagination support\n\t\tconst usersResult = await dbAdapter.auth.getAllUsers(options);\n\t\tconst totalUsersResult = await dbAdapter.auth.getUserCount(filter);\n\n\t\tif (!usersResult.success || !usersResult.data) {\n\t\t\tthrow error(500, 'Failed to fetch users from database');\n\t\t}\n\n\t\tif (!totalUsersResult.success || totalUsersResult.data === undefined) {\n\t\t\tthrow error(500, 'Failed to get user count from database');\n\t\t}\n\n\t\tconst users = usersResult.data;\n\t\tconst totalUsers = totalUsersResult.data;\n\n\t\tif (!users) {\n\t\t\tthrow error(404, 'No users found.');\n\t\t}\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: users,\n\t\t\tpagination: {\n\t\t\t\tpage,\n\t\t\t\tlimit,\n\t\t\t\ttotalItems: totalUsers,\n\t\t\t\ttotalPages: Math.ceil(totalUsers / limit)\n\t\t\t}\n\t\t});\n\t} catch (err: unknown) {\n\t\tlogger.error('Error fetching users for admin area:', err);\n\t\tconst errorMessage = err instanceof Error ? err.message : 'An internal server error occurred.';\n\t\tthrow error(500, errorMessage);\n\t}\n};\n"],"names":[],"mappings":";;;;AAkBO,MAAM,MAAsB,OAAO,EAAE,KAAK,aAAa;AAC7D,QAAM,EAAE,MAAM,UAAU,yBAAA,IAA6B;AAIrD,MAAI,CAAC,QAAQ,CAAC,0BAA0B;AACvC,UAAM,MAAM,KAAK,gEAAgE;AAAA,EAClF;AAEA,MAAI,CAAC,QAAQ,CAAC,WAAW;AACxB,UAAM,MAAM,KAAK,0CAA0C;AAAA,EAC5D;AAEA,MAAI;AACH,UAAM,OAAO,SAAS,IAAI,aAAa,IAAI,MAAM,KAAK,GAAG;AACzD,UAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,IAAI;AAC5D,UAAM,OAAO,IAAI,aAAa,IAAI,MAAM,KAAK;AAC7C,UAAM,QAAQ,IAAI,aAAa,IAAI,OAAO,MAAM,QAAQ,IAAI;AAC5D,UAAM,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK;AAGjD,UAAM,SAAkC,CAAA;AAGxC,QAAI,sBAAsB,cAAc,KAAK,UAAU;AACtD,aAAO,WAAW;AAAA,IACnB;AAGA,QAAI,QAAQ;AACX,aAAO,MAAM,CAAC,EAAE,UAAU,EAAE,QAAQ,QAAQ,UAAU,IAAA,KAAS,EAAE,OAAO,EAAE,QAAQ,QAAQ,UAAU,IAAA,GAAO;AAAA,IAC5G;AAGA,UAAM,UAAU;AAAA,MACf;AAAA,MACA;AAAA,MACA,SAAS,OAAO,KAAK;AAAA,MACrB,MAAM,EAAE,CAAC,IAAI,GAAG,UAAU,IAAI,QAAQ,OAAA;AAAA,IAAO;AAI9C,UAAM,cAAc,MAAM,UAAU,KAAK,YAAY,OAAO;AAC5D,UAAM,mBAAmB,MAAM,UAAU,KAAK,aAAa,MAAM;AAEjE,QAAI,CAAC,YAAY,WAAW,CAAC,YAAY,MAAM;AAC9C,YAAM,MAAM,KAAK,qCAAqC;AAAA,IACvD;AAEA,QAAI,CAAC,iBAAiB,WAAW,iBAAiB,SAAS,QAAW;AACrE,YAAM,MAAM,KAAK,wCAAwC;AAAA,IAC1D;AAEA,UAAM,QAAQ,YAAY;AAC1B,UAAM,aAAa,iBAAiB;AAEpC,QAAI,CAAC,OAAO;AACX,YAAM,MAAM,KAAK,iBAAiB;AAAA,IACnC;AAEA,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,MACN,YAAY;AAAA,QACX;AAAA,QACA;AAAA,QACA,YAAY;AAAA,QACZ,YAAY,KAAK,KAAK,aAAa,KAAK;AAAA,MAAA;AAAA,IACzC,CACA;AAAA,EACF,SAAS,KAAc;AACtB,WAAO,MAAM,wCAAwC,GAAG;AACxD,UAAM,eAAe,eAAe,QAAQ,IAAI,UAAU;AAC1D,UAAM,MAAM,KAAK,YAAY;AAAA,EAC9B;AACD;"}