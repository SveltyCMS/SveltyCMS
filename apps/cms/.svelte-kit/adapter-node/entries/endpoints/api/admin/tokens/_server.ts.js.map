{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/admin/tokens/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/admin/tokens/+server.ts\n * @description API endpoint for fetching registration tokens with pagination, sorting, and filtering.\n *\n * This endpoint is for the Admin Area to query token data efficiently.\n * It is protected and only accessible by users with administrative privileges.\n *\n * @usage\n * GET /api/admin/tokens?page=1&limit=10&sort=expires&order=asc&search=test@example.com\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\nimport { auth, dbAdapter } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\tconst { user, tenantId, hasManageUsersPermission } = locals;\n\n\t// Security: Ensure the user is authenticated and has admin-level permissions.\n\tif (!user || !hasManageUsersPermission) {\n\t\tthrow error(403, 'Forbidden: You do not have permission to access this resource.');\n\t}\n\n\tif (!auth || !dbAdapter) {\n\t\tthrow error(500, 'Authentication system is not initialized');\n\t}\n\n\ttry {\n\t\tconst page = parseInt(url.searchParams.get('page') || '1');\n\t\tconst limit = parseInt(url.searchParams.get('limit') || '10');\n\t\tconst sort = url.searchParams.get('sort') || 'createdAt';\n\t\tconst order = url.searchParams.get('order') === 'asc' ? 1 : -1;\n\t\tconst search = url.searchParams.get('search') || '';\n\n\t\t// Build filter for database query\n\t\tconst filter: Record<string, unknown> = {};\n\n\t\t// Apply tenant ID if in multi-tenant mode\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && tenantId) {\n\t\t\tfilter.tenantId = tenantId;\n\t\t}\n\n\t\t// Add search query if provided (MongoDB-style query)\n\t\tif (search) {\n\t\t\tfilter.$or = [{ email: { $regex: search, $options: 'i' } }, { token: { $regex: search, $options: 'i' } }];\n\t\t}\n\n\t\t// Get all tokens using the database adapter directly\n\t\tconst tokensResult = await dbAdapter.auth.getAllTokens(filter);\n\n\t\tif (!tokensResult.success || !tokensResult.data) {\n\t\t\tthrow error(500, 'Failed to fetch tokens from database');\n\t\t}\n\n\t\tconst allTokens = tokensResult.data;\n\n\t\t// Apply sorting\n\t\tallTokens.sort((a, b) => {\n\t\t\tconst aVal = a[sort as keyof typeof a];\n\t\t\tconst bVal = b[sort as keyof typeof b];\n\n\t\t\tif (aVal == null) return 1;\n\t\t\tif (bVal == null) return -1;\n\n\t\t\tif (aVal < bVal) return order === 1 ? -1 : 1;\n\t\t\tif (aVal > bVal) return order === 1 ? 1 : -1;\n\t\t\treturn 0;\n\t\t});\n\n\t\t// Apply pagination\n\t\tconst totalTokens = allTokens.length;\n\t\tconst startIndex = (page - 1) * limit;\n\t\tconst tokens = allTokens.slice(startIndex, startIndex + limit);\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: tokens,\n\t\t\tpagination: {\n\t\t\t\tpage,\n\t\t\t\tlimit,\n\t\t\t\ttotalItems: totalTokens,\n\t\t\t\ttotalPages: Math.ceil(totalTokens / limit)\n\t\t\t}\n\t\t});\n\t} catch (err: unknown) {\n\t\tlogger.error('Error fetching tokens for admin area:', err);\n\t\tconst errorMessage = err instanceof Error ? err.message : 'An internal server error occurred.';\n\t\tthrow error(500, errorMessage);\n\t}\n};\n"],"names":[],"mappings":";;;;AAkBO,MAAM,MAAsB,OAAO,EAAE,KAAK,aAAa;AAC7D,QAAM,EAAE,MAAM,UAAU,yBAAA,IAA6B;AAGrD,MAAI,CAAC,QAAQ,CAAC,0BAA0B;AACvC,UAAM,MAAM,KAAK,gEAAgE;AAAA,EAClF;AAEA,MAAI,CAAC,QAAQ,CAAC,WAAW;AACxB,UAAM,MAAM,KAAK,0CAA0C;AAAA,EAC5D;AAEA,MAAI;AACH,UAAM,OAAO,SAAS,IAAI,aAAa,IAAI,MAAM,KAAK,GAAG;AACzD,UAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,IAAI;AAC5D,UAAM,OAAO,IAAI,aAAa,IAAI,MAAM,KAAK;AAC7C,UAAM,QAAQ,IAAI,aAAa,IAAI,OAAO,MAAM,QAAQ,IAAI;AAC5D,UAAM,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK;AAGjD,UAAM,SAAkC,CAAA;AAGxC,QAAI,sBAAsB,cAAc,KAAK,UAAU;AACtD,aAAO,WAAW;AAAA,IACnB;AAGA,QAAI,QAAQ;AACX,aAAO,MAAM,CAAC,EAAE,OAAO,EAAE,QAAQ,QAAQ,UAAU,IAAA,KAAS,EAAE,OAAO,EAAE,QAAQ,QAAQ,UAAU,IAAA,GAAO;AAAA,IACzG;AAGA,UAAM,eAAe,MAAM,UAAU,KAAK,aAAa,MAAM;AAE7D,QAAI,CAAC,aAAa,WAAW,CAAC,aAAa,MAAM;AAChD,YAAM,MAAM,KAAK,sCAAsC;AAAA,IACxD;AAEA,UAAM,YAAY,aAAa;AAG/B,cAAU,KAAK,CAAC,GAAG,MAAM;AACxB,YAAM,OAAO,EAAE,IAAsB;AACrC,YAAM,OAAO,EAAE,IAAsB;AAErC,UAAI,QAAQ,KAAM,QAAO;AACzB,UAAI,QAAQ,KAAM,QAAO;AAEzB,UAAI,OAAO,KAAM,QAAO,UAAU,IAAI,KAAK;AAC3C,UAAI,OAAO,KAAM,QAAO,UAAU,IAAI,IAAI;AAC1C,aAAO;AAAA,IACR,CAAC;AAGD,UAAM,cAAc,UAAU;AAC9B,UAAM,cAAc,OAAO,KAAK;AAChC,UAAM,SAAS,UAAU,MAAM,YAAY,aAAa,KAAK;AAE7D,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,MACN,YAAY;AAAA,QACX;AAAA,QACA;AAAA,QACA,YAAY;AAAA,QACZ,YAAY,KAAK,KAAK,cAAc,KAAK;AAAA,MAAA;AAAA,IAC1C,CACA;AAAA,EACF,SAAS,KAAc;AACtB,WAAO,MAAM,yCAAyC,GAAG;AACzD,UAAM,eAAe,eAAe,QAAQ,IAAI,UAAU;AAC1D,UAAM,MAAM,KAAK,YAAY;AAAA,EAC9B;AACD;"}