{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/user/batch/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/user/batch/+server.ts\n * @description Unified API endpoint for performing batch actions on users.\n *\n * This module provides a single endpoint to perform the following actions on one or more users:\n * - Delete users\n * - Block users\n * - Unblock users\n *\n * Each action is protected by its own specific permission and uses the corresponding\n * batch method defined in the authDBInterface for database-agnostic efficiency.\n *\n * @usage\n * POST /api/user/batch\n * @body {\n * \"userIds\": [\"id1\", \"id2\"],\n * \"action\": \"block\"\n * }\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nimport { error, json, type HttpError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport type { User } from '@shared/database/auth/types';\n\n// Auth and permission helpers\nimport { auth } from '@shared/database/db';\n\n// Validation\nimport { array, minLength, object, parse, picklist, pipe, string } from 'valibot';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nconst batchUserActionSchema = object({\n\tuserIds: array(pipe(string(), minLength(1, 'User ID cannot be empty.'))),\n\taction: picklist(['delete', 'block', 'unblock'], 'Invalid action specified.')\n});\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\ttry {\n\t\tconst { user, tenantId } = locals; // Destructure tenantId from locals\n\t\tconst body = await request.json().catch(() => {\n\t\t\tthrow error(400, 'Invalid JSON in request body');\n\t\t});\n\t\tconst { userIds, action } = parse(batchUserActionSchema, body);\n\n\t\t// Authentication is handled by hooks.server.ts - user presence confirms access\n\n\t\tif (userIds.some((id) => id === user?._id)) {\n\t\t\tthrow error(400, 'You cannot perform batch actions on your own account.');\n\t\t}\n\n\t\tif (!auth) {\n\t\t\tthrow error(500, 'Authentication system is not initialized');\n\t\t}\n\n\t\t// --- MULTI-TENANCY SECURITY CHECK ---\n\t\t// Before performing any action, verify all target users belong to the current tenant.\n\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\tif (!tenantId) {\n\t\t\t\tthrow error(500, 'Tenant could not be identified for this operation.');\n\t\t\t}\n\t\t\t// Check if all users exist and belong to the tenant\n\t\t\tconst userChecks = await Promise.all(\n\t\t\t\tuserIds.map(async (userId) => {\n\t\t\t\t\treturn await auth!.getUserById(userId, tenantId);\n\t\t\t\t})\n\t\t\t);\n\t\t\tif (userChecks.some((u: User | null) => u === null)) {\n\t\t\t\tlogger.warn(`Attempt to act on users outside of tenant or non-existent users`, {\n\t\t\t\t\tuserId: user?._id,\n\t\t\t\t\ttenantId,\n\t\t\t\t\trequestedUserIds: userIds\n\t\t\t\t});\n\t\t\t\tthrow error(403, 'Forbidden: One or more user IDs do not belong to your tenant or do not exist.');\n\t\t\t}\n\t\t}\n\n\t\tlet successMessage = '';\n\n\t\tswitch (action) {\n\t\t\tcase 'delete': {\n\t\t\t\t// Use optimized deleteUserAndSessions for each user to ensure sessions are cleaned up\n\t\t\t\tlet totalDeleted = 0;\n\t\t\t\tlet totalSessionsDeleted = 0;\n\n\t\t\t\tfor (const userId of userIds) {\n\t\t\t\t\tconst result = await auth.deleteUserAndSessions(userId, tenantId);\n\t\t\t\t\tif (result.success && result.data) {\n\t\t\t\t\t\ttotalDeleted++;\n\t\t\t\t\t\ttotalSessionsDeleted += result.data.deletedSessionCount || 0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst errorMsg = !result.success && 'error' in result ? result.error?.message : 'Unknown error';\n\t\t\t\t\t\tlogger.warn(`Failed to delete user or sessions`, {\n\t\t\t\t\t\t\tuserId,\n\t\t\t\t\t\t\terror: errorMsg,\n\t\t\t\t\t\t\ttenantId\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (totalDeleted === 0) {\n\t\t\t\t\tthrow error(500, 'Failed to delete any users');\n\t\t\t\t}\n\n\t\t\t\tsuccessMessage =\n\t\t\t\t\ttotalDeleted === userIds.length\n\t\t\t\t\t\t? `${totalDeleted} user(s) and ${totalSessionsDeleted} session(s) deleted successfully.`\n\t\t\t\t\t\t: `${totalDeleted} of ${userIds.length} user(s) deleted (${totalSessionsDeleted} sessions cleaned up). Some deletions failed.`;\n\n\t\t\t\tlogger.info('User deletion completed', {\n\t\t\t\t\trequested: userIds.length,\n\t\t\t\t\tdeleted: totalDeleted,\n\t\t\t\t\tsessionsDeleted: totalSessionsDeleted,\n\t\t\t\t\ttenantId\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'block': {\n\t\t\t\tconst result = await auth.blockUsers(userIds, tenantId);\n\t\t\t\tif (!result.success) {\n\t\t\t\t\tthrow error(500, `Failed to block users: ${result.error}`);\n\t\t\t\t}\n\t\t\t\tsuccessMessage = 'Users blocked successfully.';\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'unblock': {\n\t\t\t\tconst result = await auth.unblockUsers(userIds, tenantId);\n\t\t\t\tif (!result.success) {\n\t\t\t\t\tthrow error(500, `Failed to unblock users: ${result.error}`);\n\t\t\t\t}\n\t\t\t\tsuccessMessage = 'Users unblocked successfully.';\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tlogger.info(`Batch user action '${action}' completed.`, {\n\t\t\taffectedIds: userIds,\n\t\t\texecutedBy: user?._id,\n\t\t\ttenantId\n\t\t});\n\t\t// Invalidate user count cache since users were deleted\n\t\tconst { invalidateUserCountCache } = await import('@cms/hooks/handleAuthorization');\n\t\tinvalidateUserCountCache(tenantId);\n\n\t\treturn json({ success: true, message: successMessage });\n\t} catch (err) {\n\t\tif (err instanceof Error && err.name === 'ValiError') {\n\t\t\tconst valiError = err as unknown as { issues: Array<{ message: string }> };\n\t\t\tconst issues = valiError.issues.map((issue: { message: string }) => issue.message).join(', ');\n\t\t\tlogger.warn('Invalid input for user batch API:', { issues });\n\t\t\tthrow error(400, `Invalid input: ${issues}`);\n\t\t}\n\t\tconst httpError = err as HttpError;\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'An unexpected error occurred.';\n\t\tlogger.error('Error in user batch API:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\tstatus\n\t\t});\n\t\treturn json({ success: false, message: status === 500 ? 'Internal Server Error' : message }, { status });\n\t}\n};\n"],"names":[],"mappings":"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"}