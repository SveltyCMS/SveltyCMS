{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/user/updateUserAttributes/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/user/updateUserAttributes/+server.ts\n * @description API endpoint for editing user attributes.\n *\n * This is a highly sensitive endpoint that handles all user profile updates.\n *\n * Features:\n * - **Defense in Depth**: Granular, two-level permission checking. It distinguishes\n * between a user editing their own profile vs. an admin editing another user's.\n * - **Privilege Escalation Prevention**: The validation schema dynamically prevents\n * users from changing their own role. Only an admin can change another user's role.\n * - **Multi-Tenant Safe**: Verifies that admins can only edit users within their own tenant.\n * - Secure input validation with Valibot.\n * - Robust error handling and session cache invalidation.\n *\n * Usage:\n * PUT /api/user/updateUserAttributes\n * Body: JSON object with 'user_id' and 'newUserData' properties.\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nimport { error, json, type HttpError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\n// Auth and permission helpers\nimport { SESSION_COOKIE_NAME } from '@shared/database/auth/constants';\nimport { cacheService } from '@shared/database/CacheService';\nimport { auth } from '@shared/database/db';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Input validation\nimport { email, maxLength, minLength, object, optional, parse, pipe, string } from 'valibot';\n\n// Define the base schema for user data. The 'role' is handled separately for security.\nconst baseUserDataSchema = object({\n\temail: optional(pipe(string(), email())),\n\tusername: optional(pipe(string(), minLength(2, 'Username must be at least 2 characters'), maxLength(50, 'Username must not exceed 50 characters'))),\n\tpassword: optional(pipe(string(), minLength(8, 'Password must be at least 8 characters')))\n});\n\nexport const PUT: RequestHandler = async ({ request, locals, cookies }) => {\n\ttry {\n\t\tconst { user, tenantId } = locals; // Destructure user and tenantId\n\n\t\tif (!auth) {\n\t\t\tlogger.error('Authentication system is not initialized');\n\t\t\tthrow error(500, 'Internal Server Error: Auth system not initialized');\n\t\t}\n\n\t\t// Check if user is authenticated\n\t\tif (!user) {\n\t\t\tlogger.warn('Unauthenticated request to updateUserAttributes');\n\t\t\tthrow error(401, 'Unauthorized: Please log in to continue');\n\t\t}\n\n\t\tconst body = await request.json();\n\t\tconst { user_id: userIdToUpdate, newUserData } = body;\n\n\t\t// Validate the top-level request structure\n\t\tif (!userIdToUpdate || typeof userIdToUpdate !== 'string' || userIdToUpdate.trim() === '') {\n\t\t\tthrow error(400, 'A valid user_id must be provided.');\n\t\t}\n\n\t\tif (!newUserData || typeof newUserData !== 'object') {\n\t\t\tthrow error(400, 'Valid newUserData must be provided.');\n\t\t}\n\n\t\t// **TWO-LEVEL PERMISSION SYSTEM**: Check if user is editing their own profile or has admin permissions\n\t\tconst isEditingSelf = user._id === userIdToUpdate;\n\n\t\t// Permission checking is handled by hooks.server.ts\n\t\t// Users can always edit their own profiles, admins can edit others (handled by hooks)\n\n\t\t// --- MULTI-TENANCY SECURITY CHECK ---\n\t\t// If an admin is editing another user, ensure the target user is in the same tenant.\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !isEditingSelf) {\n\t\t\tif (!tenantId) {\n\t\t\t\tthrow error(500, 'Tenant could not be identified for this operation.');\n\t\t\t}\n\t\t\tconst userToUpdate = await auth.getUserById(userIdToUpdate);\n\t\t\tif (!userToUpdate || userToUpdate.tenantId !== tenantId) {\n\t\t\t\tlogger.warn('Admin attempted to edit a user outside their tenant.', {\n\t\t\t\t\tadminId: user?._id,\n\t\t\t\t\tadminTenantId: tenantId,\n\t\t\t\t\ttargetUserId: userIdToUpdate,\n\t\t\t\t\ttargetTenantId: userToUpdate?.tenantId\n\t\t\t\t});\n\t\t\t\tthrow error(403, 'Forbidden: You can only edit users within your own tenant.');\n\t\t\t}\n\t\t}\n\n\t\t// **SECURITY FEATURE**: Prevent users from changing their own role\n\t\tlet schemaToUse = baseUserDataSchema;\n\t\tif (newUserData.role) {\n\t\t\tif (isEditingSelf) {\n\t\t\t\t// If a user tries to submit a 'role' change for themselves, throw an error.\n\t\t\t\tlogger.warn('User attempted to change their own role.', { userId: user._id, attemptedRole: newUserData.role });\n\t\t\t\tthrow error(403, 'Forbidden: You cannot change your own role.');\n\t\t\t} else {\n\t\t\t\t// If an admin is editing another user, allow the role change.\n\t\t\t\t// We add the 'role' field to the validation schema dynamically.\n\t\t\t\tschemaToUse = object({ ...baseUserDataSchema.entries, role: optional(string()) });\n\t\t\t}\n\t\t}\n\n\t\t// Validate the input against the appropriate schema (with or without 'role').\n\t\tconst validatedData = parse(schemaToUse, newUserData);\n\n\t\t// Update user attributes in the database.\n\t\tconst updatedUser = await auth.updateUserAttributes(userIdToUpdate, validatedData);\n\n\t\tif (!updatedUser) {\n\t\t\tlogger.error('updateUserAttributes returned null/undefined', {\n\t\t\t\tuserIdToUpdate,\n\t\t\t\tvalidatedData\n\t\t\t});\n\t\t\tthrow error(500, 'Failed to update user attributes');\n\t\t}\n\n\t\t// If the current user updated their own data, invalidate their session cache to reflect changes immediately.\n\t\tif (isEditingSelf) {\n\t\t\tconst sessionId = cookies.get(SESSION_COOKIE_NAME);\n\t\t\tif (sessionId) {\n\t\t\t\ttry {\n\t\t\t\t\t// The session will be re-validated on the next request, so we can just delete the old cache entry.\n\t\t\t\t\tawait cacheService.delete(sessionId);\n\t\t\t\t\tlogger.debug(`Session cache invalidated for self-updated user ${userIdToUpdate}`);\n\t\t\t\t} catch (cacheError) {\n\t\t\t\t\tlogger.warn(`Failed to invalidate session cache during self-update: ${cacheError}`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Note: We no longer cache user data by ID or email - session cache is the only cache\n\t\t// This eliminates redundant caching and cache invalidation complexity\n\n\t\t// Invalidate admin users list cache so UI updates immediately\n\t\ttry {\n\t\t\tawait cacheService.clearByPattern(`api:*:/api/admin/users*`, tenantId);\n\t\t\tlogger.debug('Admin users list cache cleared after user update');\n\t\t} catch (cacheError) {\n\t\t\tlogger.warn(`Failed to clear admin users cache: ${cacheError}`);\n\t\t}\n\n\t\t// Invalidate roles cache since user data may have changed\n\t\tconst { invalidateRolesCache } = await import('@cms/hooks/handleAuthorization');\n\t\tinvalidateRolesCache(tenantId);\n\n\t\tlogger.info('User attributes updated successfully', {\n\t\t\tuser_id: userIdToUpdate,\n\t\t\tupdatedBy: user?._id,\n\t\t\ttenantId: tenantId,\n\t\t\tupdatedFields: Object.keys(validatedData)\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'User updated successfully.',\n\t\t\tuser: updatedUser\n\t\t});\n\t} catch (err) {\n\t\t// Handle specific validation errors from Valibot.\n\t\tif (err instanceof Error && err.name === 'ValiError') {\n\t\t\tconst valiError = err as unknown as { issues: Array<{ message: string }> };\n\t\t\tconst issues = valiError.issues.map((issue: { message: string }) => issue.message).join(', ');\n\t\t\tlogger.warn('Invalid input for updateUserAttributes API:', { issues });\n\t\t\tthrow error(400, `Invalid input: ${issues}`);\n\t\t}\n\n\t\t// Handle all other errors, including HTTP errors from `throw error()`.\n\t\tconst httpError = err as HttpError;\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'An unexpected error occurred while updating user attributes.';\n\n\t\tlogger.error('Error in updateUserAttributes API:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\tstatus\n\t\t});\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: status === 500 ? 'Internal Server Error' : message\n\t\t\t},\n\t\t\t{ status }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}