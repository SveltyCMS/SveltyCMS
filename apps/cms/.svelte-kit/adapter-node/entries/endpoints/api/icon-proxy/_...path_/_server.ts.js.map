{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/icon-proxy/[...path]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/icon-proxy/[...path]/+server.ts\n * @description\n * **Icon Proxy API Endpoint**\n *\n * **Purpose:** Securely fetch 3rd-party icons through server-side proxy to comply with CSP.\n *\n * **Security:**\n * - Validates icon source against allowlist\n * - Prevents SSRF attacks by restricting allowed domains\n * - Caches responses to reduce external requests\n * - Sets appropriate CORS and cache headers\n *\n * **Usage:**\n * <img src=\"/api/icon-proxy/simpleicons/github\" alt=\"GitHub\" />\n * <img src=\"/api/icon-proxy/iconify/mdi:account\" alt=\"Account\" />\n *\n * @example\n * GET /api/icon-proxy/simpleicons/github\n * → Proxies to https://cdn.simpleicons.org/github\n *\n * GET /api/icon-proxy/iconify/mdi:account\n * → Proxies to https://api.iconify.design/mdi/account.svg\n */\n\nimport type { RequestHandler } from './$types';\nimport { error } from '@sveltejs/kit';\n\n// Allowlist of trusted icon providers\nconst ALLOWED_PROVIDERS = {\n\tsimpleicons: {\n\t\tbaseUrl: 'https://cdn.simpleicons.org',\n\t\t// Maps: /api/icon-proxy/simpleicons/github → https://cdn.simpleicons.org/github\n\t\ttransform: (path: string) => `${path}`\n\t},\n\ticonify: {\n\t\tbaseUrl: 'https://api.iconify.design',\n\t\t// Maps: /api/icon-proxy/iconify/mdi:account → https://api.iconify.design/mdi/account.svg\n\t\ttransform: (path: string) => {\n\t\t\tconst [collection, icon] = path.split(':');\n\t\t\treturn `${collection}/${icon}.svg`;\n\t\t}\n\t}\n\t// Add more providers as needed:\n\t// lucide: { baseUrl: 'https://unpkg.com/lucide-static@latest/icons', transform: (path) => `${path}.svg` },\n\t// heroicons: { baseUrl: 'https://cdn.jsdelivr.net/npm/heroicons@2.0.18/24/outline', transform: (path) => `${path}.svg` }\n} as const;\n\ntype ProviderKey = keyof typeof ALLOWED_PROVIDERS;\n\n// Simple in-memory cache (consider Redis for production multi-instance deployments)\nconst iconCache = new Map<string, { data: Response; timestamp: number }>();\nconst CACHE_TTL = 1000 * 60 * 60 * 24; // 24 hours\n\nexport const GET: RequestHandler = async ({ params, fetch }) => {\n\tconst fullPath = params.path; // e.g., \"simpleicons/github\" or \"iconify/mdi:account\"\n\n\tif (!fullPath) {\n\t\tthrow error(400, 'Icon path is required');\n\t}\n\n\t// Parse provider and icon path\n\tconst [provider, ...iconPathParts] = fullPath.split('/');\n\tconst iconPath = iconPathParts.join('/');\n\n\t// Validate provider\n\tif (!provider || !(provider in ALLOWED_PROVIDERS)) {\n\t\tthrow error(400, `Invalid icon provider. Allowed: ${Object.keys(ALLOWED_PROVIDERS).join(', ')}`);\n\t}\n\n\tif (!iconPath) {\n\t\tthrow error(400, 'Icon path is required');\n\t}\n\n\tconst providerConfig = ALLOWED_PROVIDERS[provider as ProviderKey];\n\tconst cacheKey = `${provider}:${iconPath}`;\n\n\t// Check cache first\n\tconst cached = iconCache.get(cacheKey);\n\tif (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n\t\treturn cached.data.clone(); // Clone to avoid consuming the Response body\n\t}\n\n\t// Build external URL\n\tconst transformedPath = providerConfig.transform(iconPath);\n\tconst externalUrl = `${providerConfig.baseUrl}/${transformedPath}`;\n\n\ttry {\n\t\t// Fetch icon from external provider\n\t\tconst response = await fetch(externalUrl, {\n\t\t\theaders: {\n\t\t\t\t'User-Agent': 'SveltyCMS-IconProxy/1.0'\n\t\t\t}\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tthrow error(response.status, `Failed to fetch icon from ${provider}`);\n\t\t}\n\n\t\t// Determine content type (default to SVG if not provided)\n\t\tconst contentType = response.headers.get('content-type') || 'image/svg+xml';\n\n\t\t// Read response body\n\t\tconst iconData = await response.arrayBuffer();\n\n\t\t// Create new Response for caching and returning\n\t\tconst cachedResponse = new Response(iconData, {\n\t\t\tstatus: 200,\n\t\t\theaders: {\n\t\t\t\t'Content-Type': contentType,\n\t\t\t\t'Cache-Control': 'public, max-age=86400', // Client-side cache for 24 hours\n\t\t\t\t'Access-Control-Allow-Origin': '*', // Allow CORS for icons\n\t\t\t\t'X-Content-Type-Options': 'nosniff'\n\t\t\t}\n\t\t});\n\n\t\t// Store in cache\n\t\ticonCache.set(cacheKey, {\n\t\t\tdata: cachedResponse.clone(),\n\t\t\ttimestamp: Date.now()\n\t\t});\n\n\t\treturn cachedResponse;\n\t} catch (err) {\n\t\tconsole.error(`[Icon Proxy] Failed to fetch ${externalUrl}:`, err);\n\t\tthrow error(502, 'Failed to fetch icon from external provider');\n\t}\n};\n\n/**\n * **Migration Guide:**\n *\n * Replace direct external icon URLs with proxy URLs:\n *\n * **Before:**\n * ```svelte\n * <img src=\"https://cdn.simpleicons.org/github\" alt=\"GitHub\" />\n * ```\n *\n * **After:**\n * ```svelte\n * <img src=\"/api/icon-proxy/simpleicons/github\" alt=\"GitHub\" />\n * ```\n *\n * **Benefits:**\n * - CSP compliance (no external image sources needed)\n * - Centralized icon loading with caching\n * - SSRF attack prevention via allowlist\n * - Easier icon provider migration (change config, not components)\n */\n"],"names":[],"mappings":";AA6BA,MAAM,oBAAoB;AAAA,EACzB,aAAa;AAAA,IACZ,SAAS;AAAA;AAAA,IAET,WAAW,CAAC,SAAiB,GAAG,IAAI;AAAA,EAAA;AAAA,EAErC,SAAS;AAAA,IACR,SAAS;AAAA;AAAA,IAET,WAAW,CAAC,SAAiB;AAC5B,YAAM,CAAC,YAAY,IAAI,IAAI,KAAK,MAAM,GAAG;AACzC,aAAO,GAAG,UAAU,IAAI,IAAI;AAAA,IAC7B;AAAA,EAAA;AAAA;AAAA;AAAA;AAKF;AAKA,MAAM,gCAAgB,IAAA;AACtB,MAAM,YAAY,MAAO,KAAK,KAAK;AAE5B,MAAM,MAAsB,OAAO,EAAE,QAAQ,YAAY;AAC/D,QAAM,WAAW,OAAO;AAExB,MAAI,CAAC,UAAU;AACd,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AAGA,QAAM,CAAC,UAAU,GAAG,aAAa,IAAI,SAAS,MAAM,GAAG;AACvD,QAAM,WAAW,cAAc,KAAK,GAAG;AAGvC,MAAI,CAAC,YAAY,EAAE,YAAY,oBAAoB;AAClD,UAAM,MAAM,KAAK,mCAAmC,OAAO,KAAK,iBAAiB,EAAE,KAAK,IAAI,CAAC,EAAE;AAAA,EAChG;AAEA,MAAI,CAAC,UAAU;AACd,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AAEA,QAAM,iBAAiB,kBAAkB,QAAuB;AAChE,QAAM,WAAW,GAAG,QAAQ,IAAI,QAAQ;AAGxC,QAAM,SAAS,UAAU,IAAI,QAAQ;AACrC,MAAI,UAAU,KAAK,IAAA,IAAQ,OAAO,YAAY,WAAW;AACxD,WAAO,OAAO,KAAK,MAAA;AAAA,EACpB;AAGA,QAAM,kBAAkB,eAAe,UAAU,QAAQ;AACzD,QAAM,cAAc,GAAG,eAAe,OAAO,IAAI,eAAe;AAEhE,MAAI;AAEH,UAAM,WAAW,MAAM,MAAM,aAAa;AAAA,MACzC,SAAS;AAAA,QACR,cAAc;AAAA,MAAA;AAAA,IACf,CACA;AAED,QAAI,CAAC,SAAS,IAAI;AACjB,YAAM,MAAM,SAAS,QAAQ,6BAA6B,QAAQ,EAAE;AAAA,IACrE;AAGA,UAAM,cAAc,SAAS,QAAQ,IAAI,cAAc,KAAK;AAG5D,UAAM,WAAW,MAAM,SAAS,YAAA;AAGhC,UAAM,iBAAiB,IAAI,SAAS,UAAU;AAAA,MAC7C,QAAQ;AAAA,MACR,SAAS;AAAA,QACR,gBAAgB;AAAA,QAChB,iBAAiB;AAAA;AAAA,QACjB,+BAA+B;AAAA;AAAA,QAC/B,0BAA0B;AAAA,MAAA;AAAA,IAC3B,CACA;AAGD,cAAU,IAAI,UAAU;AAAA,MACvB,MAAM,eAAe,MAAA;AAAA,MACrB,WAAW,KAAK,IAAA;AAAA,IAAI,CACpB;AAED,WAAO;AAAA,EACR,SAAS,KAAK;AACb,YAAQ,MAAM,gCAAgC,WAAW,KAAK,GAAG;AACjE,UAAM,MAAM,KAAK,6CAA6C;AAAA,EAC/D;AACD;"}