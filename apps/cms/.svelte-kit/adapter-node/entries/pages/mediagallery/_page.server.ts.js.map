{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../src/routes/mediagallery/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/mediagallery/+page.server.ts\n * @description Server-side logic for the media gallery page.\n *\n * This module handles:\n * - Fetching media files from various collections (images, documents, audio, video)\n * - Fetching virtual folders\n * - File upload processing for different media types\n * - Error handling and logging\n *\n * The load function prepares data for the media gallery, including user information,\n * a list of all media files, and virtual folders. The actions object defines the\n * server-side logic for handling file uploads.\n */\n\n// Use DB-backed public settings with safe fallbacks\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\nimport { error, redirect } from '@sveltejs/kit';\nimport type { Actions, PageServerLoad } from './$types';\n\n// Utils\nimport type { SystemVirtualFolder, QueryFilter, MediaItem } from '@shared/database/dbInterface';\nimport type { DatabaseId } from '@cms-types';\nimport type { MediaAccess } from '@shared/utils/media/mediaModels';\nimport { MediaService } from '@shared/services/MediaService.server';\nimport { buildUrl } from '@shared/utils/media/mediaUtils';\nimport { moveMediaToTrash, getImageSizes } from '@shared/utils/media/mediaStorage.server';\nimport { getSanitizedFileName } from '@shared/utils/media/mediaProcessing';\n\n// Auth\nimport { dbAdapter } from '@shared/database/db';\n\n// System Logger\nimport { logger, type LoggableValue } from '@shared/utils/logger.server';\n\ninterface StackItem {\n\tparent: Record<string, unknown> | Array<unknown> | null;\n\tkey: string;\n\tvalue: unknown;\n}\n\nfunction convertIdToString(obj: unknown): unknown {\n\tconst stack: StackItem[] = [{ parent: null, key: '', value: obj }];\n\tconst seen = new WeakSet();\n\tconst root: unknown = {};\n\n\twhile (stack.length) {\n\t\tconst { parent, key, value } = stack.pop()!;\n\n\t\t// If value is not an object, assign directly\n\t\tif (value === null || typeof value !== 'object') {\n\t\t\tif (parent) (parent as Record<string, unknown>)[key] = value;\n\t\t\tcontinue;\n\t\t}\n\n\t\t// Handle circular references\n\t\tif (seen.has(value)) {\n\t\t\tif (parent) (parent as Record<string, unknown>)[key] = value;\n\t\t\tcontinue;\n\t\t}\n\t\tseen.add(value);\n\n\t\t// Initialize object\n\t\tconst result: Record<string, unknown> = {};\n\t\tif (parent) (parent as Record<string, unknown>)[key] = result;\n\n\t\t// Process each key/value pair\n\t\tfor (const k in value as Record<string, unknown>) {\n\t\t\tconst val = (value as Record<string, unknown>)[k];\n\t\t\tif (val === null) {\n\t\t\t\tresult[k] = null;\n\t\t\t} else if (k === '_id' || k === 'parent') {\n\t\t\t\tresult[k] = val?.toString() || null;\n\t\t\t\t// Convert _id or parent to string\n\t\t\t} else if (Buffer.isBuffer(val)) {\n\t\t\t\tresult[k] = val.toString('hex'); // Convert Buffer to hex string\n\t\t\t} else if (typeof val === 'object') {\n\t\t\t\t// Add object to the stack for further processing\n\t\t\t\tstack.push({ parent: result, key: k, value: val });\n\t\t\t} else {\n\t\t\t\tresult[k] = val; // Assign primitive values\n\t\t\t}\n\t\t}\n\t}\n\n\treturn root;\n}\n\nexport const load: PageServerLoad = async ({ locals, url }) => {\n\t// Add url parameter\n\tif (!dbAdapter) {\n\t\tlogger.error('Database adapter is not initialized');\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n\n\ttry {\n\t\t// User is already validated in hooks.server.ts\n\t\tconst { user, isAdmin, roles: tenantRoles } = locals;\n\t\tif (!user) {\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\n\t\t// Check if user has permission to access media gallery\n\t\tconst hasMediaPermission =\n\t\t\tisAdmin ||\n\t\t\tObject.values(tenantRoles).some(\n\t\t\t\t(role) =>\n\t\t\t\t\t((role as { permissions?: string[] }).permissions || []).includes('media:read') ||\n\t\t\t\t\t((role as { permissions?: string[] }).permissions || []).includes('media:write')\n\t\t\t);\n\n\t\tif (!hasMediaPermission) {\n\t\t\tlogger.warn(`User ${user._id} does not have permission to access media gallery`);\n\t\t\tthrow error(403, 'Insufficient permissions to access media gallery');\n\t\t}\n\n\t\tconst folderId = url.searchParams.get('folderId'); // Get folderId from URL\n\t\tlogger.info(`Loading media gallery for folderId: ${folderId || 'root'}`);\n\n\t\t// Fetch all virtual folders first to find the current one\n\t\tconst allVirtualFoldersResult = await dbAdapter.systemVirtualFolder.getAll();\n\n\t\tif (!allVirtualFoldersResult.success) {\n\t\t\tlogger.error('Failed to fetch virtual folders', allVirtualFoldersResult.error);\n\t\t\tthrow error(500, 'Failed to fetch virtual folders');\n\t\t}\n\n\t\t// Ensure data is an array\n\t\tconst virtualFoldersData = Array.isArray(allVirtualFoldersResult.data) ? allVirtualFoldersResult.data : [];\n\n\t\tconst serializedVirtualFolders = virtualFoldersData.map((folder) => convertIdToString(folder as unknown));\n\n\t\t// Determine current folder\n\t\tconst currentFolder = folderId ? serializedVirtualFolders.find((f) => (f as Record<string, unknown>)._id === folderId) || null : null;\n\t\tlogger.trace('Current folder determined:', currentFolder);\n\n\t\t// Fetch from all media collections including the primary MediaItem collection\n\t\tconst mediaCollections = ['MediaItem', 'media_images', 'media_documents', 'media_audio', 'media_videos'];\n\t\tconst allMediaResults: Record<string, unknown>[] = [];\n\n\t\tfor (const collection of mediaCollections) {\n\t\t\ttry {\n\t\t\t\tconst query: QueryFilter<MediaItem> = {\n\t\t\t\t\tfolderId: folderId as DatabaseId | null,\n\t\t\t\t\t// Filter out deleted items\n\t\t\t\t\t$or: [{ isDeleted: { $ne: true } }, { isDeleted: { $exists: false } }]\n\t\t\t\t};\n\t\t\t\tconst result = await dbAdapter.crud.findMany(collection, query);\n\n\t\t\t\tif (result.success && result.data) {\n\t\t\t\t\t// Add collection type to each item for processing\n\t\t\t\t\tconst itemsWithType = result.data.map((item) => ({\n\t\t\t\t\t\t...item,\n\t\t\t\t\t\tcollection: collection\n\t\t\t\t\t}));\n\t\t\t\t\tallMediaResults.push(...itemsWithType);\n\t\t\t\t}\n\t\t\t} catch (collectionError) {\n\t\t\t\t// Log but don't fail if a collection doesn't exist\n\t\t\t\tlogger.warn(`Collection ${collection} not found or error fetching:`, collectionError);\n\t\t\t}\n\t\t}\n\n\t\tlogger.info(`Fetched ${allMediaResults.length} total media items from all collections`);\n\n\t\tif (allMediaResults.length === 0) {\n\t\t\tlogger.info('No media items found in any collection');\n\t\t}\n\n\t\t// Deduplicate media items by hash since same items might exist in multiple collections\n\t\tconst deduplicatedMedia = allMediaResults.reduce((acc: Record<string, unknown>[], item) => {\n\t\t\tconst existingItem = acc.find((existing) => existing.hash === item.hash);\n\t\t\tif (!existingItem) {\n\t\t\t\tacc.push(item);\n\t\t\t}\n\t\t\treturn acc;\n\t\t}, []);\n\n\t\tlogger.info(`After deduplication: ${deduplicatedMedia.length} unique media items`);\n\n\t\t// Process and flatten media results - Filter and validate media items before processing\n\t\tconst processedMedia = deduplicatedMedia\n\t\t\t.filter((item) => {\n\t\t\t\tif (!item) return false;\n\t\t\t\tconst isValid =\n\t\t\t\t\titem.hash &&\n\t\t\t\t\titem.filename &&\n\t\t\t\t\titem.mimeType &&\n\t\t\t\t\ttypeof item.hash === 'string' &&\n\t\t\t\t\ttypeof item.filename === 'string' &&\n\t\t\t\t\ttypeof item.mimeType === 'string';\n\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tlogger.warn('Skipping invalid media item', {\n\t\t\t\t\t\titem,\n\t\t\t\t\t\treason: 'Missing required fields or invalid types'\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn isValid;\n\t\t\t})\n\t\t\t.map((item) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst mediaItem = item as unknown as MediaItem;\n\t\t\t\t\t// Sanitize filename to match storage strategy\n\t\t\t\t\tconst { fileNameWithoutExt, ext } = getSanitizedFileName(mediaItem.filename);\n\t\t\t\t\tconst filename = fileNameWithoutExt;\n\t\t\t\t\tconst extension = ext;\n\n\t\t\t\t\t// MEDIA_FOLDER may not be eagerly available; use a safe default\n\t\t\t\t\tconst mediaFolder = publicEnv.MEDIA_FOLDER || 'mediaFiles';\n\t\t\t\t\tif (!mediaFolder) {\n\t\t\t\t\t\tlogger.warn('MEDIA_FOLDER not set; proceeding with defaults');\n\t\t\t\t\t}\n\n\t\t\t\t\t// Extract base path (e.g., 'global' from 'global/original/...')\n\t\t\t\t\tconst rawPath = mediaItem.path ?? 'global';\n\t\t\t\t\t// Remove leading slashes and 'files/' prefix if present\n\t\t\t\t\tlet cleanPath = rawPath.replace(/^\\/+/, '').replace(/^files\\//, '');\n\t\t\t\t\t// Get the first segment as the base path (e.g., 'global')\n\t\t\t\t\tconst basePath = cleanPath.split('/')[0] || 'global';\n\n\t\t\t\t\t// Build thumbnail URL\n\t\t\t\t\t// buildUrl(path, hash, fileName, format, contentTypes, size) -> Actual signature: path, hash, filename, ext, category, size\n\t\t\t\t\tconst thumbnailUrl = buildUrl(basePath, mediaItem.hash, filename, extension, basePath, 'thumbnail');\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...mediaItem,\n\t\t\t\t\t\ttype: mediaItem.mimeType.split('/')[0], // Derive from mimeType\n\t\t\t\t\t\tpath: mediaItem.path ?? 'global',\n\t\t\t\t\t\tname: mediaItem.filename ?? 'unnamed-media',\n\t\t\t\t\t\t// Use the item's path if available when constructing the original URL\n\t\t\t\t\t\turl: buildUrl(basePath, mediaItem.hash, filename, extension, basePath),\n\t\t\t\t\t\tthumbnail: {\n\t\t\t\t\t\t\turl: thumbnailUrl\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t} catch (err) {\n\t\t\t\t\tlogger.error('Error processing media item', {\n\t\t\t\t\t\titem,\n\t\t\t\t\t\terror: err instanceof Error ? err.message : String(err)\n\t\t\t\t\t});\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t})\n\t\t\t.filter((item): item is NonNullable<typeof item> => item !== null);\n\n\t\tlogger.info(`Fetched ${processedMedia.length} media items for folder ${folderId || 'root'}`);\n\t\tlogger.info(`Fetched ${serializedVirtualFolders.length} total virtual folders`);\n\n\t\tconst returnData = {\n\t\t\tuser: {\n\t\t\t\t// Ensure user data is serializable\n\t\t\t\trole: user.role,\n\t\t\t\t_id: user._id.toString(), // Convert user ID to string\n\t\t\t\tavatar: user.avatar\n\t\t\t},\n\t\t\tmedia: processedMedia, // Use the processed and filtered media\n\t\t\tsystemVirtualFolders: serializedVirtualFolders as SystemVirtualFolder[], // All folders for the VirtualFolders component\n\t\t\tcurrentFolder: currentFolder as SystemVirtualFolder | null // The specific folder object for the current view\n\t\t};\n\n\t\treturn returnData;\n\t} catch (err) {\n\t\tconst message = `Error in media gallery load function: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow error(500, message);\n\t}\n};\n\nexport const actions: Actions = {\n\t// Upload action for file upload\n\tupload: async ({ request, locals }) => {\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter is not initialized');\n\t\t\tthrow error(500, 'Internal Server Error');\n\t\t}\n\n\t\ttry {\n\t\t\tconst user = locals.user;\n\t\t\tif (!user) {\n\t\t\t\tlogger.warn('No user found in locals during file upload');\n\t\t\t\tthrow redirect(302, '/login');\n\t\t\t}\n\n\t\t\tconst formData = await request.formData();\n\t\t\tconst files = formData.getAll('files');\n\n\t\t\tconst mediaService = new MediaService(dbAdapter);\n\n\t\t\tconst access: MediaAccess = 'public'; // or 'private'/'protected' based on your needs\n\n\t\t\tfor (const file of files) {\n\t\t\t\tif (file instanceof File) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Use MediaService.saveMedia which handles all media types\n\t\t\t\t\t\tawait mediaService.saveMedia(file, user._id, access, 'global');\n\t\t\t\t\t\tlogger.info(`File uploaded successfully: ${file.name}`);\n\t\t\t\t\t} catch (fileError) {\n\t\t\t\t\t\tconst errorMessage = fileError instanceof Error ? fileError.message : String(fileError);\n\t\t\t\t\t\tif (errorMessage.includes('duplicate')) {\n\t\t\t\t\t\t\tlogger.warn(`A file with name \"${file.name}\" already exists`);\n\t\t\t\t\t\t\tthrow new Error(`A file with name \"${file.name}\" already exists`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthrow new Error(errorMessage);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { success: true };\n\t\t} catch (err) {\n\t\t\tlet userMessage = 'Error uploading file';\n\t\t\tif (err instanceof Error) {\n\t\t\t\tif (err.message.includes('duplicate')) {\n\t\t\t\t\tuserMessage = err.message;\n\t\t\t\t} else if (err.message.includes('invalid file type')) {\n\t\t\t\t\tuserMessage = 'Unsupported file type';\n\t\t\t\t} else {\n\t\t\t\t\tuserMessage = err.message;\n\t\t\t\t}\n\t\t\t}\n\t\t\tlogger.error(`Error during file upload: ${err instanceof Error ? err.message : String(err)}`);\n\t\t\tthrow error(400, userMessage);\n\t\t}\n\t},\n\n\t// Action to delete a media file\n\tdeleteMedia: async ({ request }) => {\n\t\ttry {\n\t\t\tconst formData = await request.formData();\n\t\t\tconst imageDataStr = formData.get('imageData');\n\n\t\t\tlogger.info('Delete request received, imageDataStr:', imageDataStr);\n\n\t\t\tif (!imageDataStr || typeof imageDataStr !== 'string') {\n\t\t\t\tlogger.error('Invalid image data received - not a string');\n\t\t\t\tthrow error(400, 'Invalid image data received');\n\t\t\t}\n\n\t\t\tconst image = JSON.parse(imageDataStr);\n\t\t\tlogger.warn('Parsed image data:', image);\n\t\t\tlogger.trace('Received delete request for image:', image);\n\n\t\t\tif (!image || !image._id) {\n\t\t\t\tlogger.error('Invalid image data received - no _id');\n\t\t\t\tthrow error(400, 'Invalid image data received');\n\t\t\t}\n\n\t\t\tif (!dbAdapter) {\n\t\t\t\tlogger.error('Database adapter is not initialized.');\n\t\t\t\tthrow error(500, 'Internal Server Error');\n\t\t\t}\n\n\t\t\t// Move files to trash before deleting from database\n\t\t\t// FIX: Explicitly delete from ALL size folders to ensure complete cleanup\n\t\t\ttry {\n\t\t\t\tconst sanitizePath = (p: string) => {\n\t\t\t\t\tif (!p) return '';\n\t\t\t\t\tlet clean = p;\n\t\t\t\t\t// Remove web prefixes\n\t\t\t\t\tclean = clean.replace(/^\\/files\\//, '').replace(/^files\\//, '');\n\t\t\t\t\t// Remove storage root prefix if present\n\t\t\t\t\tclean = clean.replace(/^mediaFolder\\//, '');\n\t\t\t\t\t// Ensure no leading slashes\n\t\t\t\t\treturn clean.replace(/^\\/+/, '');\n\t\t\t\t};\n\n\t\t\t\t// Extract base path and filename from the stored path\n\t\t\t\t// Path format: \"global/original/filename-hash.ext\"\n\t\t\t\tconst targetPath = image.path || image.url;\n\t\t\t\tif (targetPath) {\n\t\t\t\t\tconst cleanPath = sanitizePath(targetPath);\n\t\t\t\t\t// Parse the path to extract components\n\t\t\t\t\tconst pathParts = cleanPath.split('/');\n\n\t\t\t\t\tif (pathParts.length >= 3) {\n\t\t\t\t\t\t// Format: basePath/sizeFolder/filename\n\t\t\t\t\t\tconst basePath = pathParts[0]; // e.g., \"global\"\n\t\t\t\t\t\tconst fileName = pathParts[pathParts.length - 1]; // e.g., \"image-hash.ext\"\n\n\t\t\t\t\t\t// Get configured sizes dynamically + ensure standard folders\n\t\t\t\t\t\tconst configuredSizes = getImageSizes();\n\t\t\t\t\t\tconst standardFolders = ['original', 'thumbnail'];\n\t\t\t\t\t\tconst dynamicFolders = Object.keys(configuredSizes);\n\t\t\t\t\t\tconst allSizes = [...new Set([...standardFolders, ...dynamicFolders])];\n\n\t\t\t\t\t\tlogger.info(`Deleting all variants for file: ${fileName} in ${basePath} - Sizes: ${allSizes.join(', ')}`);\n\n\t\t\t\t\t\tfor (const size of allSizes) {\n\t\t\t\t\t\t\tconst sizePath = `${basePath}/${size}/${fileName}`;\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tawait moveMediaToTrash(sizePath);\n\t\t\t\t\t\t\t\tlogger.info(`Deleted ${size} variant:`, sizePath);\n\t\t\t\t\t\t\t} catch (sizeErr) {\n\t\t\t\t\t\t\t\t// File might not exist in this size folder - that's OK\n\t\t\t\t\t\t\t\tlogger.debug(`No ${size} variant found (or already deleted):`, sizePath);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Fallback: just try to delete the exact path\n\t\t\t\t\t\tawait moveMediaToTrash(cleanPath);\n\t\t\t\t\t\tlogger.info('File moved to trash (fallback):', cleanPath);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tlogger.warn('No path or url found for file deletion:', image._id);\n\t\t\t\t}\n\n\t\t\t\t// Also delete any thumbnails explicitly listed (for backwards compatibility)\n\t\t\t\tif (image.thumbnails) {\n\t\t\t\t\tfor (const size in image.thumbnails) {\n\t\t\t\t\t\tif (image.thumbnails[size]?.url) {\n\t\t\t\t\t\t\tconst cleanThumbUrl = sanitizePath(image.thumbnails[size].url);\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tawait moveMediaToTrash(cleanThumbUrl);\n\t\t\t\t\t\t\t\tlogger.debug('Additional thumbnail cleaned up:', cleanThumbUrl);\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\t// Already deleted above or doesn't exist\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (trashError) {\n\t\t\t\tlogger.error('Error moving files to trash:', trashError);\n\t\t\t\t// Continue with database deletion even if trash move fails\n\t\t\t}\n\n\t\t\t// Determine which collection to delete from - default to MediaItem if not specified\n\t\t\tconst collection = image.collection || 'MediaItem';\n\t\t\tlogger.info(`Deleting image from collection '${collection}': ${image._id}`);\n\n\t\t\tconst result = await dbAdapter.crud.delete(collection, image._id.toString());\n\n\t\t\tif (result.success) {\n\t\t\t\tlogger.info('Image deleted successfully from', collection);\n\t\t\t\t// TODO: Add back invalidation when upgrading SvelteKit\n\t\t\t\treturn { success: true }; // Return true on success\n\t\t\t} else {\n\t\t\t\tlogger.error('Failed to delete image from database:', result);\n\t\t\t\tthrow error(500, result.message || 'Failed to delete image');\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tlogger.error('Error in deleteMedia action:', err as LoggableValue);\n\t\t\tthrow error(500, err instanceof Error ? err.message : 'Internal Server Error');\n\t\t}\n\t},\n\n\tremoteUpload: async ({ request, locals }) => {\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter is not initialized');\n\t\t\tthrow error(500, 'Internal Server Error');\n\t\t}\n\n\t\ttry {\n\t\t\tconst user = locals.user;\n\t\t\tif (!user) {\n\t\t\t\tlogger.warn('No user found in locals during file upload');\n\t\t\t\tthrow redirect(302, '/login');\n\t\t\t}\n\n\t\t\tconst formData = await request.formData();\n\t\t\tconst remoteUrls = JSON.parse(formData.get('remoteUrls') as string) as string[];\n\n\t\t\tif (!remoteUrls || !Array.isArray(remoteUrls) || remoteUrls.length === 0) {\n\t\t\t\tthrow new Error('No URLs provided');\n\t\t\t}\n\n\t\t\tconst mediaService = new MediaService(dbAdapter);\n\t\t\tconst access: MediaAccess = 'public'; // or 'private'/'protected' based on your needs\n\n\t\t\tfor (const url of remoteUrls) {\n\t\t\t\ttry {\n\t\t\t\t\tconst response = await fetch(url);\n\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\tlogger.warn(`Failed to fetch remote URL: ${url}`);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tconst arrayBuffer = await response.arrayBuffer();\n\t\t\t\t\tconst buffer = Buffer.from(arrayBuffer);\n\t\t\t\t\tconst contentType = response.headers.get('content-type') || 'application/octet-stream';\n\t\t\t\t\tconst filename = url.substring(url.lastIndexOf('/') + 1);\n\n\t\t\t\t\tconst file = new File([buffer], filename, { type: contentType });\n\n\t\t\t\t\t// Use MediaService.saveMedia which handles all media types\n\t\t\t\t\tawait mediaService.saveMedia(file, user._id, access, 'global');\n\t\t\t\t\tlogger.info(`Remote file uploaded successfully: ${file.name}`);\n\t\t\t\t} catch (fileError) {\n\t\t\t\t\tconst errorMessage = fileError instanceof Error ? fileError.message : String(fileError);\n\t\t\t\t\tif (errorMessage.includes('duplicate')) {\n\t\t\t\t\t\tlogger.warn(`A file from URL \"${url}\" already exists`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlogger.error(`Failed to upload file from ${url}: ${errorMessage}`);\n\t\t\t\t\t}\n\t\t\t\t\t// Continue with next URL instead of throwing\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { success: true };\n\t\t} catch (err) {\n\t\t\tlet userMessage = 'Error uploading file';\n\t\t\tif (err instanceof Error) {\n\t\t\t\tuserMessage = err.message;\n\t\t\t}\n\t\t\tlogger.error(`Error during remote file upload: ${err instanceof Error ? err.message : String(err)}`);\n\t\t\tthrow error(400, userMessage);\n\t\t}\n\t}\n};\n"],"names":[],"mappings":"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"}