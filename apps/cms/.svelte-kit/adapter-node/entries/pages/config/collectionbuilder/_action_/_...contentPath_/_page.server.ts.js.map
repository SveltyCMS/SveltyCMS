{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../../../../../../shared/utils/src/compilation/transformers.ts","../../../../../../../../../../../shared/utils/src/compilation/compile.ts","../../../../../../../../../src/routes/config/collectionbuilder/[action]/[...contentPath]/+page.server.ts"],"sourcesContent":["/**\n * @file shared/utils/src/compilation/transformers.ts\n * @description TypeScript AST transformers for ensuring schema integrity and runtime compatibility.\n */\n\nimport * as ts from 'typescript';\nimport { v4 as uuidv4 } from 'uuid';\n\n// Transformer factory for widget-related changes\nexport const widgetTransformer: ts.TransformerFactory<ts.SourceFile> = (context) => (sourceFile) => {\n\tconst visitor = (node: ts.Node): ts.VisitResult<ts.Node> => {\n\t\t// 1. Remove widget imports that shouldn't be in the final output\n\t\tif (ts.isImportDeclaration(node) && ts.isStringLiteral(node.moduleSpecifier)) {\n\t\t\tconst moduleSpecifier = node.moduleSpecifier.text;\n\t\t\tlet removeImport = false;\n\n\t\t\t// Check named imports for 'widgets' alias\n\t\t\tif (node.importClause?.namedBindings && ts.isNamedImports(node.importClause.namedBindings)) {\n\t\t\t\tconst hasWidgetsAlias = node.importClause.namedBindings.elements.some((element) => element.name.text === 'widgets');\n\t\t\t\tif (hasWidgetsAlias) {\n\t\t\t\t\tif (\n\t\t\t\t\t\tmoduleSpecifier.includes('@shared/stores/widgetStore.svelte') ||\n\t\t\t\t\t\tmoduleSpecifier.includes('@widgets/proxy') ||\n\t\t\t\t\t\tmoduleSpecifier.includes('widgets/proxy')\n\t\t\t\t\t) {\n\t\t\t\t\t\tremoveImport = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (removeImport) {\n\t\t\t\treturn [];\n\t\t\t}\n\t\t}\n\n\t\t// 2. Replace standalone `widgets` identifier with `globalThis.widgets`\n\t\tif (ts.isIdentifier(node) && node.text === 'widgets') {\n\t\t\tif (\n\t\t\t\t!ts.isPropertyAccessExpression(node.parent) ||\n\t\t\t\t(ts.isPropertyAccessExpression(node.parent) && node.parent.name !== node) ||\n\t\t\t\t(ts.isPropertyAccessExpression(node.parent) &&\n\t\t\t\t\tnode.parent.expression.kind !== ts.SyntaxKind.ThisKeyword &&\n\t\t\t\t\t(!ts.isIdentifier(node.parent.expression) || node.parent.expression.text !== 'globalThis'))\n\t\t\t) {\n\t\t\t\treturn ts.factory.createPropertyAccessExpression(ts.factory.createIdentifier('globalThis'), ts.factory.createIdentifier('widgets'));\n\t\t\t}\n\t\t}\n\n\t\t// 3. Inject UUID into widget calls\n\t\tif (ts.isCallExpression(node) && ts.isPropertyAccessExpression(node.expression)) {\n\t\t\tconst isWidgetCall =\n\t\t\t\tts.isPropertyAccessExpression(node.expression.expression) &&\n\t\t\t\tts.isIdentifier(node.expression.expression.expression) &&\n\t\t\t\tnode.expression.expression.expression.text === 'globalThis' &&\n\t\t\t\tts.isIdentifier(node.expression.expression.name) &&\n\t\t\t\tnode.expression.expression.name.text === 'widgets';\n\t\t\tif (isWidgetCall && node.arguments.length > 0 && ts.isObjectLiteralExpression(node.arguments[0])) {\n\t\t\t\tconst objectLiteral = node.arguments[0];\n\t\t\t\tconst hasUuid = objectLiteral.properties.some(\n\t\t\t\t\t(prop) => ts.isPropertyAssignment(prop) && ts.isIdentifier(prop.name) && prop.name.text === 'uuid'\n\t\t\t\t);\n\t\t\t\tif (!hasUuid) {\n\t\t\t\t\tconst uuidProperty = ts.factory.createPropertyAssignment('uuid', ts.factory.createStringLiteral(uuidv4()));\n\t\t\t\t\tconst updatedProperties = [uuidProperty, ...objectLiteral.properties];\n\t\t\t\t\tconst updatedObjectLiteral = ts.factory.updateObjectLiteralExpression(objectLiteral, updatedProperties);\n\t\t\t\t\treturn ts.factory.updateCallExpression(node, node.expression, node.typeArguments, [updatedObjectLiteral, ...node.arguments.slice(1)]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn ts.visitEachChild(node, visitor, context);\n\t};\n\treturn ts.visitNode(sourceFile, visitor) as ts.SourceFile;\n};\n\n// Transformer factory specifically for adding .js extensions to relative imports/exports\nexport const addJsExtensionTransformer: ts.TransformerFactory<ts.SourceFile> = (context) => (sourceFile) => {\n\tconst visitor = (node: ts.Node): ts.VisitResult<ts.Node> => {\n\t\tif ((ts.isImportDeclaration(node) || ts.isExportDeclaration(node)) && node.moduleSpecifier && ts.isStringLiteral(node.moduleSpecifier)) {\n\t\t\tconst specifier = node.moduleSpecifier.text;\n\t\t\tif (specifier.startsWith('.') && !specifier.endsWith('.js') && !specifier.endsWith('.json')) {\n\t\t\t\tconst newSpecifier = ts.factory.createStringLiteral(specifier + '.js');\n\t\t\t\tif (ts.isImportDeclaration(node)) {\n\t\t\t\t\treturn ts.factory.updateImportDeclaration(node, node.modifiers, node.importClause, newSpecifier, node.assertClause);\n\t\t\t\t} else {\n\t\t\t\t\treturn ts.factory.updateExportDeclaration(node, node.modifiers, node.isTypeOnly, node.exportClause, newSpecifier, node.assertClause);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn ts.visitEachChild(node, visitor, context);\n\t};\n\treturn ts.visitNode(sourceFile, visitor) as ts.SourceFile;\n};\n\n// Transformer factory for converting CommonJS globals to ES module equivalents\nexport const commonjsToEsModuleTransformer: ts.TransformerFactory<ts.SourceFile> = (context) => (sourceFile) => {\n\tlet needsFileURLToPath = false;\n\tconst visitor = (node: ts.Node): ts.VisitResult<ts.Node> => {\n\t\tif (ts.isIdentifier(node) && node.text === '__filename') {\n\t\t\tneedsFileURLToPath = true;\n\t\t\treturn ts.factory.createCallExpression(ts.factory.createIdentifier('fileURLToPath'), undefined, [\n\t\t\t\tts.factory.createPropertyAccessExpression(\n\t\t\t\t\tts.factory.createMetaProperty(ts.SyntaxKind.ImportKeyword, ts.factory.createIdentifier('meta')),\n\t\t\t\t\t'url'\n\t\t\t\t)\n\t\t\t]);\n\t\t}\n\n\t\tif (ts.isIdentifier(node) && node.text === '__dirname') {\n\t\t\tneedsFileURLToPath = true;\n\t\t\treturn ts.factory.createCallExpression(ts.factory.createPropertyAccessExpression(ts.factory.createIdentifier('path'), 'dirname'), undefined, [\n\t\t\t\tts.factory.createCallExpression(ts.factory.createIdentifier('fileURLToPath'), undefined, [\n\t\t\t\t\tts.factory.createPropertyAccessExpression(\n\t\t\t\t\t\tts.factory.createMetaProperty(ts.SyntaxKind.ImportKeyword, ts.factory.createIdentifier('meta')),\n\t\t\t\t\t\t'url'\n\t\t\t\t\t)\n\t\t\t\t])\n\t\t\t]);\n\t\t}\n\t\treturn ts.visitEachChild(node, visitor, context);\n\t};\n\n\tlet transformedFile = ts.visitNode(sourceFile, visitor) as ts.SourceFile;\n\tif (needsFileURLToPath) {\n\t\tconst urlImport = ts.factory.createImportDeclaration(\n\t\t\tundefined,\n\t\t\tts.factory.createImportClause(\n\t\t\t\tfalse,\n\t\t\t\tundefined,\n\t\t\t\tts.factory.createNamedImports([ts.factory.createImportSpecifier(false, undefined, ts.factory.createIdentifier('fileURLToPath'))])\n\t\t\t),\n\t\t\tts.factory.createStringLiteral('url')\n\t\t);\n\t\tconst pathImport = ts.factory.createImportDeclaration(\n\t\t\tundefined,\n\t\t\tts.factory.createImportClause(false, ts.factory.createIdentifier('path'), undefined),\n\t\t\tts.factory.createStringLiteral('path')\n\t\t);\n\t\ttransformedFile = ts.factory.updateSourceFile(transformedFile, [urlImport, pathImport, ...transformedFile.statements]);\n\t}\n\treturn transformedFile;\n};\n\nexport const schemaUuidTransformer =\n\t(uuid: string): ts.TransformerFactory<ts.SourceFile> =>\n\t(context) =>\n\t(sourceFile) => {\n\t\tconst visitor = (node: ts.Node): ts.VisitResult<ts.Node> => {\n\t\t\tif (ts.isObjectLiteralExpression(node)) {\n\t\t\t\tconst hasSchemaProperties = node.properties.some(\n\t\t\t\t\t(prop) =>\n\t\t\t\t\t\tts.isPropertyAssignment(prop) &&\n\t\t\t\t\t\tts.isIdentifier(prop.name) &&\n\t\t\t\t\t\t['fields', 'icon', 'status', 'revision', 'livePreview'].includes(prop.name.text)\n\t\t\t\t);\n\t\t\t\tif (hasSchemaProperties) {\n\t\t\t\t\tconst hasIdProperty = node.properties.some(\n\t\t\t\t\t\t(prop) => ts.isPropertyAssignment(prop) && ts.isIdentifier(prop.name) && prop.name.text === '_id'\n\t\t\t\t\t);\n\t\t\t\t\tif (!hasIdProperty) {\n\t\t\t\t\t\tconst idProperty = ts.factory.createPropertyAssignment('_id', ts.factory.createStringLiteral(uuid));\n\t\t\t\t\t\treturn ts.factory.updateObjectLiteralExpression(node, [idProperty, ...node.properties]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn ts.visitEachChild(node, visitor, context);\n\t\t};\n\t\treturn ts.visitNode(sourceFile, visitor) as ts.SourceFile;\n\t};\n","/**\n * @file shared/utils/src/compilation/compile.ts\n * @description Compiles TypeScript files from the collections folder into JavaScript files using vite with custom AST transformations\n *\n * Enterprise Features:\n * - Robust Error Handling & Typing\n * - Concurrent Processing with Limit\n * - Structured Logging Interface\n * - Modular AST Transformers\n * - Content Hashing & UUID Management\n * - Orphaned File Cleanup\n */\n\nimport fs from 'fs/promises';\nimport path from 'path';\nimport * as ts from 'typescript';\nimport { v4 as uuidv4 } from 'uuid';\nimport { createHash } from 'crypto';\nimport type { CompileOptions, CompilationResult, ExistingFileData, Logger } from './types';\nimport { widgetTransformer, addJsExtensionTransformer, commonjsToEsModuleTransformer, schemaUuidTransformer } from './transformers';\n// Schema comparison (collectionSchemaWarnings.ts) runs at runtime in GUI/API when schemas are loaded\n// schemaWarnings in CompilationResult is populated by the collection save flow, not compilation\n\n// Default logger implementation\nconst defaultLogger: Logger = {\n\tinfo: (msg) => console.log(`\\x1b[34m[Compile]\\x1b[0m ${msg}`),\n\tsuccess: (msg) => console.log(`\\x1b[34m[Compile]\\x1b[0m \\x1b[32m${msg}\\x1b[0m`),\n\twarn: (msg) => console.warn(`\\x1b[34m[Compile]\\x1b[0m \\x1b[33m${msg}\\x1b[0m`),\n\terror: (msg, err) => console.error(`\\x1b[34m[Compile]\\x1b[0m \\x1b[31m${msg}\\x1b[0m`, err)\n};\n\nfunction logSuccess(logger: Logger, msg: string) {\n\tif (logger.success) {\n\t\tlogger.success(msg);\n\t} else {\n\t\tlogger.info(msg);\n\t}\n}\n\nexport async function compile(options: CompileOptions = {}): Promise<CompilationResult> {\n\tconst startTime = Date.now();\n\tconst logger = options.logger || defaultLogger;\n\n\t// Default paths\n\tconst userCollections = options.userCollections || path.posix.join(process.cwd(), 'config/collections');\n\tconst compiledCollections = options.compiledCollections || path.posix.join(process.cwd(), 'compiledCollections');\n\tconst concurrencyLimit = options.concurrency || 5;\n\n\tconst result: CompilationResult = {\n\t\tprocessed: 0,\n\t\tskipped: 0,\n\t\terrors: [],\n\t\tduration: 0,\n\t\torphanedFiles: [],\n\t\tschemaWarnings: []\n\t};\n\n\ttry {\n\t\t// Ensure output directories exist\n\t\tawait fs.mkdir(userCollections, { recursive: true });\n\t\tawait fs.mkdir(compiledCollections, { recursive: true });\n\n\t\t// 1. Scan existing state\n\t\tconst { existingFilesByPath, existingFilesByHash } = await scanCompiledFiles(compiledCollections, logger);\n\n\t\t// 2. Discover source files\n\t\tconst sourceFiles = await getTypescriptAndJavascriptFiles(userCollections);\n\t\tconst sourceFileSet = new Set(sourceFiles);\n\n\t\t// 3. Create directory structure\n\t\tawait createOutputDirectories(sourceFiles, compiledCollections);\n\n\t\t// 4. Process files with concurrency control\n\t\tconst processedJsPaths = new Set<string>();\n\t\tconst queue = [...sourceFiles]; // Clone array to manage queue\n\t\tconst workers = [];\n\n\t\t// Simple concurrency implementation\n\t\tconst worker = async () => {\n\t\t\twhile (queue.length > 0) {\n\t\t\t\tconst file = queue.shift();\n\t\t\t\tif (!file) break;\n\n\t\t\t\t// If specific target file is requested, skip others\n\t\t\t\tif (options.targetFile) {\n\t\t\t\t\t// Normalize paths for comparison (handle leading ./ or different separators)\n\t\t\t\t\tconst normalizedTarget = path.normalize(options.targetFile);\n\t\t\t\t\tconst normalizedFile = path.normalize(path.join(userCollections, file));\n\t\t\t\t\t// Check if this source file corresponds to the target file\n\t\t\t\t\t// The passed targetFile might be absolute or relative\n\t\t\t\t\tif (!normalizedFile.endsWith(normalizedTarget) && !normalizedTarget.endsWith(file)) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\t// Calculate the expected JS path for this source file\n\t\t\t\t\tconst expectedJsPath = file.replace(/\\.(ts|js)$/, '.js');\n\n\t\t\t\t\tconst jsFilePath = await compileFile(\n\t\t\t\t\t\tfile,\n\t\t\t\t\t\tuserCollections,\n\t\t\t\t\t\tcompiledCollections,\n\t\t\t\t\t\texistingFilesByPath,\n\t\t\t\t\t\texistingFilesByHash,\n\t\t\t\t\t\tsourceFileSet,\n\t\t\t\t\t\tlogger\n\t\t\t\t\t);\n\n\t\t\t\t\tif (jsFilePath) {\n\t\t\t\t\t\tif (jsFilePath === 'SKIPPED') {\n\t\t\t\t\t\t\t// For skipped files, add the actual expected path (not 'SKIPPED')\n\t\t\t\t\t\t\tprocessedJsPaths.add(expectedJsPath);\n\t\t\t\t\t\t\tresult.skipped++;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprocessedJsPaths.add(jsFilePath);\n\t\t\t\t\t\t\tresult.processed++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (err) {\n\t\t\t\t\tresult.errors.push({\n\t\t\t\t\t\tfile,\n\t\t\t\t\t\terror: err instanceof Error ? err : new Error(String(err))\n\t\t\t\t\t});\n\t\t\t\t\tlogger.error(`Failed to compile ${file}`, err);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t// Start workers\n\t\tfor (let i = 0; i < Math.min(concurrencyLimit, sourceFiles.length); i++) {\n\t\t\tworkers.push(worker());\n\t\t}\n\t\tawait Promise.all(workers);\n\n\t\t// 5. Cleanup (only if doing a full compile, i.e., no targetFile)\n\t\tif (!options.targetFile) {\n\t\t\tresult.orphanedFiles = await cleanupOrphanedFiles(existingFilesByPath, processedJsPaths, compiledCollections, logger);\n\t\t}\n\t} catch (error) {\n\t\tlogger.error('Fatal compilation error', error);\n\t\tif (error instanceof Error && error.message.includes('Collection name conflict')) {\n\t\t\tthrow error;\n\t\t}\n\t\t// Propagate but ensure error is logged\n\t\tthrow error;\n\t}\n\n\tresult.duration = Date.now() - startTime;\n\treturn result;\n}\n\n// --- Helper Functions ---\n\nasync function scanCompiledFiles(\n\tdir: string,\n\tlogger: Logger\n): Promise<{\n\texistingFilesByPath: Map<string, ExistingFileData>;\n\texistingFilesByHash: Map<string, ExistingFileData>;\n}> {\n\tconst byPath = new Map<string, ExistingFileData>();\n\tconst byHash = new Map<string, ExistingFileData>();\n\n\tasync function traverse(current: string) {\n\t\ttry {\n\t\t\tconst entries = await fs.readdir(current, { withFileTypes: true });\n\t\t\tfor (const entry of entries) {\n\t\t\t\tconst fullPath = path.posix.join(current, entry.name);\n\t\t\t\tif (entry.isDirectory()) {\n\t\t\t\t\tawait traverse(fullPath);\n\t\t\t\t} else if (entry.isFile() && entry.name.endsWith('.js')) {\n\t\t\t\t\tconst relativePath = path.posix.relative(dir, fullPath);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst content = await fs.readFile(fullPath, 'utf8');\n\t\t\t\t\t\tconst hash = extractHashFromJs(content);\n\t\t\t\t\t\tconst uuid = extractUUIDFromJs(content);\n\t\t\t\t\t\tconst data: ExistingFileData = { jsPath: relativePath, uuid, hash };\n\n\t\t\t\t\t\tbyPath.set(relativePath, data);\n\t\t\t\t\t\tif (hash) byHash.set(hash, data);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tlogger.warn(`Could not read compiled file ${relativePath}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif ((e as NodeJS.ErrnoException).code !== 'ENOENT') {\n\t\t\t\tlogger.error(`Error scanning ${current}`, e);\n\t\t\t}\n\t\t}\n\t}\n\n\tawait traverse(dir);\n\treturn { existingFilesByPath: byPath, existingFilesByHash: byHash };\n}\n\nasync function getTypescriptAndJavascriptFiles(folder: string, subdir = ''): Promise<string[]> {\n\tconst files: string[] = [];\n\ttry {\n\t\tconst entries = await fs.readdir(path.posix.join(folder, subdir), { withFileTypes: true });\n\t\tconst collectionNames = new Set<string>();\n\n\t\tfor (const entry of entries) {\n\t\t\tconst relativePath = path.posix.join(subdir, entry.name);\n\t\t\tif (entry.isDirectory()) {\n\t\t\t\tfiles.push(...(await getTypescriptAndJavascriptFiles(folder, relativePath)));\n\t\t\t} else if (entry.isFile() && /\\.(ts|js)$/.test(entry.name)) {\n\t\t\t\tconst name = entry.name.replace(/\\.(ts|js)$/, '');\n\t\t\t\tif (collectionNames.has(name)) {\n\t\t\t\t\tthrow new Error(`Collection name conflict: \"${name}\" used multiple times in ${path.posix.join(folder, subdir)}`);\n\t\t\t\t}\n\t\t\t\tcollectionNames.add(name);\n\t\t\t\tfiles.push(relativePath);\n\t\t\t}\n\t\t}\n\t} catch (e) {\n\t\tif ((e as NodeJS.ErrnoException).code === 'ENOENT') return [];\n\t\tthrow e;\n\t}\n\treturn files;\n}\n\nasync function createOutputDirectories(files: string[], baseDir: string): Promise<void> {\n\tconst dirs = new Set(files.map((f) => path.posix.dirname(f)).filter((d) => d !== '.'));\n\tawait Promise.all(Array.from(dirs).map((d) => fs.mkdir(path.posix.join(baseDir, d), { recursive: true })));\n}\n\nasync function compileFile(\n\tfile: string,\n\tsrcDir: string,\n\tdestDir: string,\n\texistingByPath: Map<string, ExistingFileData>,\n\texistingByHash: Map<string, ExistingFileData>,\n\tsourceSet: Set<string>,\n\tlogger: Logger\n): Promise<string | null> {\n\tconst srcPath = path.posix.join(srcDir, file);\n\tconst targetRel = file.replace(/\\.(ts|js)$/, '.js');\n\tconst targetAbs = path.posix.join(destDir, targetRel);\n\n\tconst content = await fs.readFile(srcPath, 'utf8');\n\tconst hash = createHash('sha256').update(content).digest('hex').slice(0, 16);\n\tconst existing = existingByPath.get(targetRel);\n\n\t// Optimization: Skip if hash matches\n\tif (existing && existing.hash === hash) {\n\t\treturn 'SKIPPED';\n\t}\n\n\t// UUID Resolution Strategy\n\tlet uuid: string | null = null;\n\tlet reason = '';\n\n\t// 1. Check content hash (move/rename detection)\n\tconst moved = existingByHash.get(hash);\n\tif (!existing && moved?.uuid) {\n\t\t// Check if original still exists to distinguish move vs clone\n\t\tconst origTs = moved.jsPath.replace(/\\.js$/, '.ts');\n\t\tif (!sourceSet.has(origTs)) {\n\t\t\tuuid = moved.uuid;\n\t\t\treason = 'Reused (move/rename)';\n\t\t}\n\t}\n\n\t// 2. Reuse existing file's UUID\n\tif (!uuid && existing?.uuid) {\n\t\tuuid = existing.uuid;\n\t\treason = 'Reused (path match)';\n\t}\n\n\t// 3. Generate new\n\tif (!uuid) {\n\t\tuuid = uuidv4().replace(/-/g, '');\n\t\treason = 'Generated new';\n\t}\n\n\t// Compile\n\tconst transpile = file.endsWith('.ts')\n\t\t? ts.transpileModule(content, { compilerOptions: { target: ts.ScriptTarget.ESNext, module: ts.ModuleKind.ESNext } })\n\t\t: { outputText: content };\n\n\tlet code = transformAST(transpile.outputText, uuid);\n\tcode = wrapOutput(code, hash, targetRel);\n\n\tawait fs.writeFile(targetAbs, code);\n\tlogSuccess(logger, `Compiled ${file} (${reason}: \\x1b[33m${uuid}\\x1b[0m)`);\n\n\treturn targetRel;\n}\n\nconst printer = ts.createPrinter({ newLine: ts.NewLineKind.LineFeed });\nfunction transformAST(code: string, uuid: string): string {\n\tconst source = ts.createSourceFile('temp.js', code, ts.ScriptTarget.ESNext, true, ts.ScriptKind.JS);\n\tconst res = ts.transform(source, [schemaUuidTransformer(uuid), widgetTransformer, addJsExtensionTransformer, commonjsToEsModuleTransformer]);\n\treturn printer.printFile(res.transformed[0]);\n}\n\nfunction wrapOutput(code: string, hash: string, pathRel: string): string {\n\t// Add header comments\n\tlet out = code.replace(/(\\s*\\*\\s*@file\\s+)(.*)/, `$1compiledCollections/${pathRel}`);\n\tout = out.replace(/^\\/\\/\\s*(HASH|UUID):.*$/gm, '').trimStart();\n\n\treturn `// WARNING: Generated file. Do not edit.\\n` + `// HASH: ${hash}\\n\\n` + out;\n}\n\nfunction extractHashFromJs(content: string) {\n\treturn content.match(/^\\/\\/\\s*HASH:\\s*([a-f0-9]{16})\\s*$/m)?.[1] || null;\n}\nfunction extractUUIDFromJs(content: string) {\n\treturn content.match(/^\\/\\/\\s*UUID:\\s*([a-f0-9-]+)\\s*$/m)?.[1] || null;\n}\n\nasync function cleanupOrphanedFiles(\n\texisting: Map<string, ExistingFileData>,\n\tkept: Set<string>,\n\tcompiledCollections: string,\n\tlogger: Logger\n): Promise<string[]> {\n\tconst orphanedFiles = Array.from(existing.keys()).filter((f) => !kept.has(f) && f !== 'SKIPPED');\n\n\tif (orphanedFiles.length > 0) {\n\t\t// Terminal-friendly formatted message with actionable guidance\n\t\tconst divider = '‚îÄ'.repeat(60);\n\t\tlogger.warn(`\\n‚îå${divider}‚îê`);\n\t\tlogger.warn(`‚îÇ  ‚ö†Ô∏è  Orphaned Compiled Collections Detected${' '.repeat(15)}‚îÇ`);\n\t\tlogger.warn(`‚îú${divider}‚î§`);\n\t\tlogger.warn(`‚îÇ${' '.repeat(61)}‚îÇ`);\n\t\tlogger.warn(`‚îÇ  The following compiled files have no matching source:${' '.repeat(4)}‚îÇ`);\n\n\t\tfor (const file of orphanedFiles) {\n\t\t\tconst padding = 57 - file.length;\n\t\t\tlogger.warn(`‚îÇ    ‚Ä¢ ${file}${' '.repeat(Math.max(0, padding))}‚îÇ`);\n\t\t}\n\n\t\tlogger.warn(`‚îÇ${' '.repeat(61)}‚îÇ`);\n\t\tlogger.warn(`‚îÇ  This usually means:${' '.repeat(39)}‚îÇ`);\n\t\tlogger.warn(`‚îÇ    1. You renamed/moved a source collection file${' '.repeat(10)}‚îÇ`);\n\t\tlogger.warn(`‚îÇ    2. You deleted a collection that's no longer needed${' '.repeat(4)}‚îÇ`);\n\t\tlogger.warn(`‚îÇ${' '.repeat(61)}‚îÇ`);\n\t\tlogger.warn(`‚îÇ  To clean up manually, delete from:${' '.repeat(23)}‚îÇ`);\n\t\tlogger.warn(`‚îÇ    ${compiledCollections.slice(-50)}${' '.repeat(Math.max(0, 55 - compiledCollections.slice(-50).length))}‚îÇ`);\n\t\tlogger.warn(`‚îÇ${' '.repeat(61)}‚îÇ`);\n\t\tlogger.warn(`‚îî${divider}‚îò\\n`);\n\t}\n\n\t// Return the list so GUI can display it appropriately\n\treturn orphanedFiles;\n}\n","/**\n * @file src/routes/(app)/config/collectionbuilder/[action]/[...contentPath]/+page.server.ts\n * @description Server-side logic for creating and editing individual collections.\n *\n * #Features:\n * - Handles 'new' and 'edit' actions based on URL parameters.\n * - Checks for authenticated user in locals (set by hooks.server.ts).\n * - Verifies user permissions: Must be admin or have 'config:collection:manage' permission.\n * - Fetches all permissions and roles to pass to the client (for UI selectors).\n * - For 'edit' mode, fetches the specific collection data from contentManager.\n * - For 'new' mode, returns a null collection object.\n * - Serializes collection data, removing functions before sending to the client.\n * - Provides 'saveCollection' and 'deleteCollections' actions for persistence.\n */\n\nimport fs from 'fs';\nimport prettier from 'prettier';\nimport * as ts from 'typescript';\nimport { redirect, type Actions, error } from '@sveltejs/kit';\nimport type { PageServerLoad } from './$types';\n\n// Collections\nimport { contentManager } from '@content/ContentManager';\nimport { compile } from '@shared/utils/compilation/compile';\n\n// Widgets\nimport { widgets } from '@shared/stores/widgetStore.svelte';\n\n// Auth\n// Use hasPermissionWithRoles and roles from locals, like the example pattern\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\nimport { permissionConfigs } from '@shared/database/auth/permissions';\n\nimport { permissions } from '@shared/database/auth/permissions';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Type definitions for widget field structure\ninterface WidgetConfig {\n\tName: string;\n\tkey: string;\n\tGuiFields: Record<string, unknown>;\n}\n\ninterface FieldWithWidget {\n\twidget?: WidgetConfig;\n\t[key: string]: unknown;\n}\n\ninterface WidgetGuiSchema {\n\timports?: string[];\n\t[key: string]: unknown;\n}\n\ninterface WidgetDefinition {\n\tGuiSchema?: Record<string, WidgetGuiSchema>;\n\t[key: string]: unknown;\n}\n\ntype FieldsData = Record<string, FieldWithWidget>;\n\n// Load Prettier config\nasync function getPrettierConfig() {\n\ttry {\n\t\tconst config = await prettier.resolveConfig(process.cwd());\n\t\treturn { ...config, parser: 'typescript' };\n\t} catch (err) {\n\t\tlogger.warn('Failed to load Prettier config, using defaults:', err);\n\t\treturn { parser: 'typescript' };\n\t}\n}\n\n// Define load function as async function that takes an event parameter\nexport const load: PageServerLoad = async ({ locals, params }) => {\n\ttry {\n\t\t// 1. Get user, roles, and admin status from locals (set by hook)\n\t\tconst { user, roles: tenantRoles, isAdmin } = locals;\n\t\tconst { action } = params;\n\n\t\t// 2. User authentication (already done by hook, this is a fallback)\n\t\tif (!user) {\n\t\t\tlogger.warn('User not authenticated, redirecting to login');\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\n\t\tlogger.trace(`User authenticated successfully for user: ${user._id}`);\n\n\t\t// 3. Authorization check\n\t\t// Use the 'config:collection:manage' permission string (adjust if needed)\n\t\tconst hasManagePermission = hasPermissionWithRoles(user, 'config:collection:manage', tenantRoles);\n\n\t\t// Replicate original logic: User must be an Admin OR have the specific permission.\n\t\tif (!isAdmin && !hasManagePermission) {\n\t\t\tconst message = `User ${user._id} lacks 'config:collection:manage' permission and is not admin.`;\n\t\t\tlogger.warn(message, { userId: user._id, isAdmin, hasManagePermission });\n\t\t\tthrow error(403, 'Insufficient permissions');\n\t\t}\n\n\t\t// 4. Serialize user data (like the example)\n\t\tconst { _id, ...rest } = user;\n\t\tconst serializedUser = {\n\t\t\tid: _id.toString(),\n\t\t\t...rest,\n\t\t\tisAdmin // Include admin status\n\t\t};\n\n\t\t// 5. Handle 'new' action\n\t\tif (action === 'new') {\n\t\t\treturn {\n\t\t\t\tuser: serializedUser,\n\t\t\t\troles: tenantRoles || [], // Roles:' key\n\t\t\t\tpermissions, // Permissions data\n\t\t\t\tpermissionConfigs, // Permission configs\n\t\t\t\tcollection: null // Pass null for 'new' action\n\t\t\t};\n\t\t}\n\n\t\t// 6. Handle 'edit' action (default)\n\t\tawait contentManager.refresh(); // Force a refresh to bypass any stale cache\n\t\tconst collectionIdentifier = params.contentPath;\n\n\t\t// Try resolving exactly as passed (UUID or relative path)\n\t\tlet currentCollection = await contentManager.getCollection(collectionIdentifier);\n\n\t\t// Fallback: Try identifying as an absolute path if not found\n\t\tif (!currentCollection && !collectionIdentifier.startsWith('/')) {\n\t\t\tcurrentCollection = await contentManager.getCollection(`/${collectionIdentifier}`);\n\t\t}\n\n\t\tif (!currentCollection) {\n\t\t\tlogger.warn(`Collection not found at path: ${collectionIdentifier}`, { identifier: collectionIdentifier });\n\t\t\tthrow error(404, 'Collection not found');\n\t\t}\n\n\t\t// Helper function to deep clone and remove functions\n\t\tfunction deepCloneAndRemoveFunctions(obj: unknown): unknown {\n\t\t\tif (obj === null || typeof obj !== 'object') {\n\t\t\t\treturn obj;\n\t\t\t}\n\n\t\t\tif (obj instanceof Date) {\n\t\t\t\treturn new Date(obj.getTime());\n\t\t\t}\n\n\t\t\tif (Array.isArray(obj)) {\n\t\t\t\treturn (obj as unknown[]).map((item) => deepCloneAndRemoveFunctions(item));\n\t\t\t}\n\n\t\t\tconst newObj: Record<string, unknown> = {};\n\t\t\tfor (const key in obj as Record<string, unknown>) {\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(obj, key)) {\n\t\t\t\t\tconst value = (obj as Record<string, unknown>)[key];\n\t\t\t\t\tif (typeof value === 'function') {\n\t\t\t\t\t\tcontinue; // Skip functions\n\t\t\t\t\t}\n\t\t\t\t\tnewObj[key] = deepCloneAndRemoveFunctions(value);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn newObj;\n\t\t}\n\n\t\tconst serializableCollection = currentCollection ? deepCloneAndRemoveFunctions(currentCollection) : null;\n\n\t\treturn {\n\t\t\tuser: serializedUser,\n\t\t\troles: tenantRoles || [], // roles:' key\n\t\t\tpermissions, // Permissions data\n\t\t\tpermissionConfigs, //Permission configs\n\t\t\tcollection: serializableCollection\n\t\t};\n\t} catch (err) {\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\t// This is likely a redirect or an error we've already handled\n\t\t\tthrow err;\n\t\t}\n\t\tconst message = `Error in load function: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow error(500, message);\n\t}\n};\n\nexport const actions: Actions = {\n\t// Save Collection\n\tsaveCollection: async ({ request }) => {\n\t\ttry {\n\t\t\tconst formData = await request.formData();\n\t\t\tconst fieldsData = formData.get('fields') as string;\n\t\t\tconst originalName = formData.get('originalName') as string;\n\t\t\tconst contentName = formData.get('name') as string;\n\t\t\tconst collectionIcon = formData.get('icon') as string;\n\t\t\tconst collectionSlug = formData.get('slug') as string;\n\t\t\tconst collectionDescription = formData.get('description');\n\t\t\tconst collectionStatus = formData.get('status') as string;\n\n\t\t\t// Widgets Fields\n\t\t\tconst fields = JSON.parse(fieldsData) as FieldsData;\n\t\t\tconst imports = await goThrough(fields, fieldsData);\n\n\t\t\t// Generate collection file using AST transformation\n\t\t\tconst content = await generateCollectionFileWithAST({\n\t\t\t\tcontentName,\n\t\t\t\tcollectionIcon,\n\t\t\t\tcollectionStatus,\n\t\t\t\tcollectionDescription,\n\t\t\t\tcollectionSlug,\n\t\t\t\tfields,\n\t\t\t\timports\n\t\t\t});\n\n\t\t\tconst collectionPath = import.meta.env.userCollectionsPath;\n\n\t\t\tif (originalName && originalName !== contentName) {\n\t\t\t\tfs.renameSync(`${collectionPath}/${originalName}.ts`, `${process.env.COLLECTIONS_FOLDER_TS}/${contentName}.ts`);\n\t\t\t}\n\t\t\tfs.writeFileSync(`${collectionPath}/${contentName}.ts`, content);\n\t\t\tawait compile({ logger });\n\t\t\t//await contentManager.generateContentTypes();\n\t\t\t//await contentManager.generateCollectionFieldTypes();\n\t\t\tawait contentManager.refresh();\n\t\t\treturn { status: 200 };\n\t\t} catch (err) {\n\t\t\tconst message = `Error in saveCollection action: ${err instanceof Error ? err.message : String(err)}`;\n\t\t\tlogger.error(message);\n\t\t\treturn { status: 500, error: message };\n\t\t}\n\t},\n\n\t// Save config\n\tsaveConfig: async ({ request }) => {\n\t\ttry {\n\t\t\tconst formData = await request.formData();\n\t\t\tconst categories = JSON.parse(formData.get('categories') as string);\n\n\t\t\t// Convert categories to path-based structure\n\t\t\tinterface Category {\n\t\t\t\tname: string;\n\t\t\t\tpath?: string;\n\t\t\t\tcollections?: Array<{\n\t\t\t\t\tname: string;\n\t\t\t\t\tpath?: string;\n\t\t\t\t}>;\n\t\t\t}\n\n\t\t\tconst pathCategories = (categories as Category[]).map((cat) => ({\n\t\t\t\t...cat,\n\t\t\t\tpath: cat.name.toLowerCase().replace(/\\s+/g, '-'),\n\t\t\t\tcollections:\n\t\t\t\t\tcat.collections?.map((col) => ({\n\t\t\t\t\t\t...col,\n\t\t\t\t\t\tpath: `${cat.path || cat.name.toLowerCase().replace(/\\s+/g, '-')}/${col.name.toLowerCase().replace(/\\s+/g, '-')}`\n\t\t\t\t\t})) || []\n\t\t\t}));\n\n\t\t\t// Update collections with new category paths\n\t\t\tawait contentManager.refresh();\n\n\t\t\treturn {\n\t\t\t\tstatus: 200,\n\t\t\t\tcategories: pathCategories\n\t\t\t};\n\t\t} catch (err) {\n\t\t\tconst message = `Error in saveConfig action: ${err instanceof Error ? err.message : String(err)}`;\n\t\t\tlogger.error(message);\n\t\t\treturn { status: 500, error: message };\n\t\t}\n\t},\n\n\t// Delete collection\n\tdeleteCollections: async ({ request }) => {\n\t\ttry {\n\t\t\tconst formData = await request.formData();\n\t\t\tconst contentTypes = JSON.parse(formData.get('contentTypes') as string);\n\t\t\tfs.unlinkSync(`${process.env.COLLECTIONS_FOLDER_TS}/${contentTypes}.ts`);\n\t\t\tawait compile({ logger });\n\t\t\tawait contentManager.refresh();\n\t\t\treturn { status: 200 };\n\t\t} catch (err) {\n\t\t\tconst message = `Error in deleteCollections action: ${err instanceof Error ? err.message : String(err)}`;\n\t\t\tlogger.error(message);\n\t\t\treturn { status: 500, error: message };\n\t\t}\n\t}\n};\n\n// Recursively goes through a collection's fields\nasync function goThrough(object: FieldsData, fields: string): Promise<string> {\n\tconst imports = new Set<string>();\n\n\tasync function processField(field: FieldWithWidget | FieldsData, fields?: string): Promise<void> {\n\t\tif (!(field instanceof Object)) return;\n\n\t\tfor (const key in field) {\n\t\t\tconst fieldValue = field[key];\n\n\t\t\t// Recursively process nested fields\n\t\t\tif (typeof fieldValue === 'object' && fieldValue !== null) {\n\t\t\t\tawait processField(fieldValue as FieldWithWidget, fields);\n\t\t\t}\n\n\t\t\t// Check if this field has a widget configuration\n\t\t\tif (!fieldValue || typeof fieldValue !== 'object') continue;\n\t\t\tconst fieldWithWidget = fieldValue as FieldWithWidget;\n\t\t\tif (!fieldWithWidget.widget) continue;\n\n\t\t\t// Get widget definition\n\t\t\tconst widgetName = fieldWithWidget.widget.Name;\n\t\t\tconst widget = widgets.widgetFunctions[widgetName] as unknown as WidgetDefinition;\n\t\t\tif (!widget || !widget.GuiSchema) continue;\n\n\t\t\t// Process widget imports\n\t\t\tfor (const importKey in widget.GuiSchema) {\n\t\t\t\tconst widgetImport = widget.GuiSchema[importKey].imports;\n\t\t\t\tif (!widgetImport) continue;\n\n\t\t\t\tfor (const _import of widgetImport) {\n\t\t\t\t\tconst importValue = fieldWithWidget[importKey];\n\t\t\t\t\tconst replacement = (typeof importValue === 'string' ? importValue : '').replace(/üóëÔ∏è/g, '').trim();\n\t\t\t\t\timports.add(_import.replace(`{${importKey}}`, replacement));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Convert widget to string representation\n\t\t\tconst widgetCall = `üóëÔ∏èwidgets.${fieldWithWidget.widget.key}(${JSON.stringify(fieldWithWidget.widget.GuiFields, (_k, value) =>\n\t\t\t\ttypeof value === 'string' ? String(value.replace(/\\s*üóëÔ∏è\\s*/g, 'üóëÔ∏è').trim()) : value\n\t\t\t)})üóëÔ∏è`;\n\n\t\t\tfield[key] = widgetCall as unknown as FieldWithWidget;\n\n\t\t\t// Add permissions if present\n\t\t\tconst parsedFields = JSON.parse(fields || '{}') as FieldsData;\n\t\t\tif (parsedFields[key]?.permissions) {\n\t\t\t\tconst subWidget = widgetCall.split('}');\n\t\t\t\tconst permissions = removeFalseValues(parsedFields[key].permissions);\n\t\t\t\tconst permissionStr = `,\"permissions\":${JSON.stringify(permissions)}}`;\n\t\t\t\tconst newWidget = subWidget[0] + permissionStr + subWidget[1];\n\t\t\t\tfield[key] = newWidget as unknown as FieldWithWidget;\n\t\t\t}\n\t\t}\n\t}\n\n\ttry {\n\t\tawait processField(object, fields);\n\t\treturn Array.from(imports).join('\\n');\n\t} catch (err) {\n\t\tconst message = `Error in goThrough function: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow error(500, message);\n\t}\n\n\t// Asynchronously processes a field recursively\n}\n\n// Check if permissions are present and append them\n\n// Remove false values from an object\nfunction removeFalseValues(obj: unknown): unknown {\n\tif (typeof obj !== 'object' || obj === null) {\n\t\treturn obj;\n\t}\n\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map(removeFalseValues).filter(Boolean);\n\t}\n\n\treturn Object.fromEntries(\n\t\tObject.entries(obj)\n\t\t\t.map(([key, value]) => [key, removeFalseValues(value)])\n\t\t\t.filter(([, value]) => value !== false)\n\t);\n}\n\n// AST-based collection file generation\ninterface CollectionData {\n\tcontentName: string;\n\tcollectionIcon: string;\n\tcollectionStatus: string;\n\tcollectionDescription: string | FormDataEntryValue | null;\n\tcollectionSlug: string;\n\tfields: FieldsData;\n\timports: string;\n}\n\nasync function generateCollectionFileWithAST(data: CollectionData): Promise<string> {\n\ttry {\n\t\t// Create the base template with imports\n\t\tconst sourceCode = `/**\n * @file config/collections/${data.contentName}.ts\n * @description Collection file for ${data.contentName}\n */\n\n${data.imports}\nimport { widgets } from '@widgets/widgetManager.svelte';\nimport type { Schema } from '@cms-types';\n\nexport const schema: Schema = {\n\t// Collection Name coming from filename so not needed\n\t\n\t// Optional & Icon, status, slug\n\t// See for possible Icons https://icon-sets.iconify.design/\n\ticon: '',\n\tstatus: '',\n\tdescription: '',\n\tslug: '',\n\t\n\t// Defined Fields that are used in your Collection\n\t// Widget fields can be inspected for individual options\n\tfields: []\n};`;\n\n\t\t// Parse the source code into an AST\n\t\tconst sourceFile = ts.createSourceFile(\n\t\t\t`${data.contentName}.ts`,\n\t\t\tsourceCode,\n\t\t\tts.ScriptTarget.ESNext,\n\t\t\ttrue // setParentNodes\n\t\t);\n\n\t\t// Transform the AST to inject the collection data\n\t\tconst transformationResult = ts.transform(sourceFile, [createCollectionTransformer(data)]);\n\t\tconst transformedSourceFile = transformationResult.transformed[0];\n\n\t\t// Print the transformed AST back to code\n\t\tconst printer = ts.createPrinter({ newLine: ts.NewLineKind.LineFeed });\n\t\tlet result = printer.printFile(transformedSourceFile);\n\n\t\t// Clean up the üóëÔ∏è markers and format with prettier\n\t\tresult = result.replace(/[\"']üóëÔ∏è|üóëÔ∏è[\"']/g, '').replace(/üóëÔ∏è/g, '');\n\n\t\tconst prettierConfig = await getPrettierConfig();\n\t\tresult = await prettier.format(result, prettierConfig);\n\n\t\treturn result;\n\t} catch (error) {\n\t\tlogger.error('Error generating collection file with AST:', error);\n\t\tthrow new Error(`Failed to generate collection file: ${error instanceof Error ? error.message : String(error)}`);\n\t}\n}\n\n// Transformer factory to inject collection data into the AST\nfunction createCollectionTransformer(data: CollectionData): ts.TransformerFactory<ts.SourceFile> {\n\treturn (context) => {\n\t\treturn (sourceFile) => {\n\t\t\tconst visitor = (node: ts.Node): ts.VisitResult<ts.Node> => {\n\t\t\t\t// Find the schema object literal and replace its properties\n\t\t\t\tif (\n\t\t\t\t\tts.isVariableStatement(node) &&\n\t\t\t\t\tnode.declarationList.declarations.some((decl) => ts.isIdentifier(decl.name) && decl.name.text === 'schema')\n\t\t\t\t) {\n\t\t\t\t\t// Create the schema object with actual data\n\t\t\t\t\tconst schemaObject = createSchemaObjectLiteral(data);\n\n\t\t\t\t\t// Create new variable declaration (TypeScript 5.9+ API)\n\t\t\t\t\t// createVariableDeclaration(name, exclamationToken, type, initializer)\n\t\t\t\t\tconst newDeclaration = ts.factory.createVariableDeclaration(\n\t\t\t\t\t\tts.factory.createIdentifier('schema'),\n\t\t\t\t\t\tundefined, // exclamation token\n\t\t\t\t\t\tundefined, // type  - let TypeScript infer\n\t\t\t\t\t\tschemaObject // initializer\n\t\t\t\t\t);\n\n\t\t\t\t\t// Create new variable statement with export modifier\n\t\t\t\t\treturn ts.factory.createVariableStatement(\n\t\t\t\t\t\t[ts.factory.createModifier(ts.SyntaxKind.ExportKeyword)],\n\t\t\t\t\t\tts.factory.createVariableDeclarationList([newDeclaration], ts.NodeFlags.Const)\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn ts.visitEachChild(node, visitor, context);\n\t\t\t};\n\n\t\t\treturn ts.visitNode(sourceFile, visitor) as ts.SourceFile;\n\t\t};\n\t};\n}\n\n// Create TypeScript AST nodes for the schema object\nfunction createSchemaObjectLiteral(data: CollectionData): ts.ObjectLiteralExpression {\n\tconst properties: ts.ObjectLiteralElementLike[] = [];\n\n\t// Add icon property\n\tproperties.push(ts.factory.createPropertyAssignment(ts.factory.createIdentifier('icon'), ts.factory.createStringLiteral(data.collectionIcon)));\n\n\t// Add status property\n\tproperties.push(ts.factory.createPropertyAssignment(ts.factory.createIdentifier('status'), ts.factory.createStringLiteral(data.collectionStatus)));\n\n\t// Add description property\n\tproperties.push(\n\t\tts.factory.createPropertyAssignment(\n\t\t\tts.factory.createIdentifier('description'),\n\t\t\tts.factory.createStringLiteral(String(data.collectionDescription || ''))\n\t\t)\n\t);\n\n\t// Add slug property\n\tproperties.push(ts.factory.createPropertyAssignment(ts.factory.createIdentifier('slug'), ts.factory.createStringLiteral(data.collectionSlug)));\n\n\t// Add fields property - this is more complex as it contains processed widget calls\n\tconst fieldsString = JSON.stringify(data.fields);\n\t// Parse the fields as a JavaScript expression (this handles the widget calls)\n\tconst fieldsExpression = ts.factory.createIdentifier(`üóëÔ∏è${fieldsString}üóëÔ∏è`);\n\n\tproperties.push(ts.factory.createPropertyAssignment(ts.factory.createIdentifier('fields'), fieldsExpression));\n\n\treturn ts.factory.createObjectLiteralExpression(properties, true);\n}\n"],"names":["uuidv4","logger","error","fs","fields","permissions","printer"],"mappings":"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"}