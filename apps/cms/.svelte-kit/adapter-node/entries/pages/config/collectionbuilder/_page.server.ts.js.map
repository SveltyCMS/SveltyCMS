{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../../src/routes/config/collectionbuilder/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/config/collectionbuilder/+page.server.ts\n * @description Server-side logic for Collection Builder page authentication and authorization.\n *\n * #Features:\n * - Checks for authenticated user in locals (set by hooks.server.ts).\n * - Verifies user permissions for collection builder access (`config:collectionbuilder`).\n * - Fetches initial content structure data from `contentManager`.\n * - Determines user's admin status based on roles.\n * - Redirects unauthenticated users to login.\n * - Throws 403 error for insufficient permissions.\n * - Returns user data and content structure for client-side rendering.\n */\n\nimport { error, redirect } from '@sveltejs/kit';\nimport type { PageServerLoad } from './$types';\n\n// Auth - Use cached roles from locals instead of global config\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\n// System Logger\nimport { contentManager } from '@content/ContentManager';\nimport { logger } from '@shared/utils/logger.server';\n\nexport const load: PageServerLoad = async ({ locals }) => {\n\ttry {\n\t\tconst { user, roles: tenantRoles, isAdmin } = locals;\n\n\t\t// User authentication already done by handleAuthorization hook\n\t\tif (!user) {\n\t\t\tlogger.warn('User not authenticated, redirecting to login');\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\n\t\t// Check user permission for collection builder using cached roles from locals\n\t\tconst hasCollectionBuilderPermission = hasPermissionWithRoles(user, 'config:collectionbuilder', tenantRoles);\n\n\t\tif (!hasCollectionBuilderPermission) {\n\t\t\tconst userRole = tenantRoles.find((r) => r._id === user.role);\n\t\t\tlogger.warn('Permission denied for collection builder', {\n\t\t\t\tuserId: user._id,\n\t\t\t\tuserRole: user.role,\n\t\t\t\troleFound: !!userRole,\n\t\t\t\tisAdmin: userRole?.isAdmin,\n\t\t\t\trolePermissions: userRole?.permissions?.length || 0\n\t\t\t});\n\t\t\tthrow error(403, 'Insufficient permissions');\n\t\t}\n\n\t\t// Initialize ContentManager before accessing data\n\t\tawait contentManager.initialize();\n\n\t\t// Fetch the initial content structure directly from database\n\t\t// CollectionBuilder needs the current database state (not in-memory cache) to:\n\t\t// - See the most recently persisted order and parentId values\n\t\t// - Ensure consistency when saving drag-and-drop changes back to DB\n\t\t// - Work with the actual stored data, not cached/compiled schemas\n\t\t// The database stores lightweight metadata without heavy collectionDef.fields arrays\n\t\tconst contentStructure = await contentManager.getContentStructureFromDatabase('nested');\n\n\t\t// Use isAdmin from locals (already computed by handleAuthorization hook)\n\t\t// No need to re-calculate from roles\n\n\t\t// Serialize ObjectIds to strings for client-side usage\n\t\t// This is crucial because MongoDB ObjectId instances cannot be serialized by SvelteKit\n\t\tconst serializedStructure = contentStructure.map((node) => ({\n\t\t\t...node,\n\t\t\t_id: node._id.toString(),\n\t\t\t...(node.parentId ? { parentId: node.parentId.toString() } : {})\n\t\t}));\n\n\t\t// Return user data with proper admin status and the content structure\n\t\tconst { _id, ...rest } = user;\n\t\treturn {\n\t\t\tuser: {\n\t\t\t\tid: _id.toString(),\n\t\t\t\t...rest,\n\t\t\t\tisAdmin // Add the properly calculated admin status\n\t\t\t},\n\t\t\tcontentStructure: serializedStructure\n\t\t};\n\t} catch (err) {\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\t// This is likely a redirect or an error we've already handled\n\t\t\tthrow err;\n\t\t}\n\t\tconst message = `Error in load function: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":[],"mappings":";;;;AAwBO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AACH,UAAM,EAAE,MAAM,OAAO,aAAa,YAAY;AAG9C,QAAI,CAAC,MAAM;AACV,aAAO,KAAK,8CAA8C;AAC1D,YAAM,SAAS,KAAK,QAAQ;AAAA,IAC7B;AAGA,UAAM,iCAAiC,uBAAuB,MAAM,4BAA4B,WAAW;AAE3G,QAAI,CAAC,gCAAgC;AACpC,YAAM,WAAW,YAAY,KAAK,CAAC,MAAM,EAAE,QAAQ,KAAK,IAAI;AAC5D,aAAO,KAAK,4CAA4C;AAAA,QACvD,QAAQ,KAAK;AAAA,QACb,UAAU,KAAK;AAAA,QACf,WAAW,CAAC,CAAC;AAAA,QACb,SAAS,UAAU;AAAA,QACnB,iBAAiB,UAAU,aAAa,UAAU;AAAA,MAAA,CAClD;AACD,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAGA,UAAM,eAAe,WAAA;AAQrB,UAAM,mBAAmB,MAAM,eAAe,gCAAgC,QAAQ;AAOtF,UAAM,sBAAsB,iBAAiB,IAAI,CAAC,UAAU;AAAA,MAC3D,GAAG;AAAA,MACH,KAAK,KAAK,IAAI,SAAA;AAAA,MACd,GAAI,KAAK,WAAW,EAAE,UAAU,KAAK,SAAS,SAAA,MAAe,CAAA;AAAA,IAAC,EAC7D;AAGF,UAAM,EAAE,KAAK,GAAG,KAAA,IAAS;AACzB,WAAO;AAAA,MACN,MAAM;AAAA,QACL,IAAI,IAAI,SAAA;AAAA,QACR,GAAG;AAAA,QACH;AAAA;AAAA,MAAA;AAAA,MAED,kBAAkB;AAAA,IAAA;AAAA,EAEpB,SAAS,KAAK;AACb,QAAI,eAAe,SAAS,YAAY,KAAK;AAE5C,YAAM;AAAA,IACP;AACA,UAAM,UAAU,2BAA2B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC3F,WAAO,MAAM,OAAO;AACpB,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}