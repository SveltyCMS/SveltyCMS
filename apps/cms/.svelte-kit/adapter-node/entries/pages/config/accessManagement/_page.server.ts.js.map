{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../../src/routes/config/accessManagement/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/config/accessManagement/+page.server.ts\n * @description Server-side logic for Access Management page using simplified auth system.\n */\n\nimport { redirect, error } from '@sveltejs/kit';\nimport type { PageServerLoad } from './$types';\n\n// Auth - getAllPermissions is lightweight, no heavy queries needed\nimport { getAllPermissions } from '@shared/database/auth/permissions';\n\n// System Logger - Ensure logger is optimized for performance in production (e.g., disabled debug logs)\nimport { logger } from '@shared/utils/logger.server';\n\nexport const load: PageServerLoad = async ({ locals }) => {\n\ttry {\n\t\tconst { user, roles: tenantRoles, tenantId } = locals;\n\n\t\t// User authentication and permission checks already done by handleAuthorization hook\n\t\tif (!user) {\n\t\t\tlogger.warn('User not authenticated, redirecting to login');\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\n\t\t// Check if user is admin (admins have access to all config pages)\n\t\tconst userRole = (tenantRoles || []).find((role) => role._id === user.role);\n\t\tconst isAdmin = userRole?.isAdmin === true;\n\n\t\tif (!isAdmin) {\n\t\t\t// For non-admins, check specific permission\n\t\t\t// You can add more granular permission checks here if needed\n\t\t\tconst message = `User ${user._id} does not have permission to access access management`;\n\t\t\tlogger.warn(message, { tenantId });\n\t\t\tthrow error(403, message);\n\t\t}\n\n\t\t// Fetch permissions (lightweight operation)\n\t\tlogger.debug('Fetching permissions...', { tenantId });\n\t\tconst permissions = getAllPermissions();\n\n\t\tlogger.debug(`Roles available: ${tenantRoles.length}`, { tenantId });\n\t\tlogger.debug(`Permissions fetched: ${permissions.length}`, { tenantId });\n\n\t\t// Return minimal user data and reuse roles from locals (already cached by handleAuthorization)\n\t\treturn {\n\t\t\tuser: {\n\t\t\t\t_id: user._id.toString(),\n\t\t\t\temail: user.email,\n\t\t\t\trole: user.role\n\t\t\t},\n\t\t\troles: tenantRoles, // Already cached and loaded by handleAuthorization hook\n\t\t\tpermissions\n\t\t};\n\t} catch (err) {\n\t\t// Differentiate between intentional redirects/errors and unexpected server errors\n\t\tif (err && typeof err === 'object' && 'status' in err) {\n\t\t\t// This is likely a redirect or an error we've already thrown (e.g., 403, 302)\n\t\t\tthrow err;\n\t\t}\n\t\tconst message = `Error in load function for Access Management: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { tenantId: locals.tenantId });\n\t\tthrow error(500, message); // Generic 500 for unhandled server errors\n\t}\n};\n"],"names":[],"mappings":";;;AAcO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AACH,UAAM,EAAE,MAAM,OAAO,aAAa,aAAa;AAG/C,QAAI,CAAC,MAAM;AACV,aAAO,KAAK,8CAA8C;AAC1D,YAAM,SAAS,KAAK,QAAQ;AAAA,IAC7B;AAGA,UAAM,YAAY,eAAe,CAAA,GAAI,KAAK,CAAC,SAAS,KAAK,QAAQ,KAAK,IAAI;AAC1E,UAAM,UAAU,UAAU,YAAY;AAEtC,QAAI,CAAC,SAAS;AAGb,YAAM,UAAU,QAAQ,KAAK,GAAG;AAChC,aAAO,KAAK,SAAS,EAAE,SAAA,CAAU;AACjC,YAAM,MAAM,KAAK,OAAO;AAAA,IACzB;AAGA,WAAO,MAAM,2BAA2B,EAAE,SAAA,CAAU;AACpD,UAAM,cAAc,kBAAA;AAEpB,WAAO,MAAM,oBAAoB,YAAY,MAAM,IAAI,EAAE,UAAU;AACnE,WAAO,MAAM,wBAAwB,YAAY,MAAM,IAAI,EAAE,UAAU;AAGvE,WAAO;AAAA,MACN,MAAM;AAAA,QACL,KAAK,KAAK,IAAI,SAAA;AAAA,QACd,OAAO,KAAK;AAAA,QACZ,MAAM,KAAK;AAAA,MAAA;AAAA,MAEZ,OAAO;AAAA;AAAA,MACP;AAAA,IAAA;AAAA,EAEF,SAAS,KAAK;AAEb,QAAI,OAAO,OAAO,QAAQ,YAAY,YAAY,KAAK;AAEtD,YAAM;AAAA,IACP;AACA,UAAM,UAAU,iDAAiD,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACjH,WAAO,MAAM,SAAS,EAAE,UAAU,OAAO,UAAU;AACnD,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}