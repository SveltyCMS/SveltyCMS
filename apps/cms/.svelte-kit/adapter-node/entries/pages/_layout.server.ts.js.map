{"version":3,"file":"_layout.server.ts.js","sources":["../../../../../src/routes/+layout.server.ts"],"sourcesContent":["/**\n * @file src/routes/+layout.server.ts\n * @description Root server-side layout handler.\n *\n * ### Features\n * - Settings Loading\n * - User Management\n * - Theme Management\n * - Content Versioning\n *\n * ### Security\n * - Settings Loading is cached\n * - User Management is cached\n * - Theme Management is cached\n * - Content Versioning is cached\n */\nimport { version } from '@root/package.json';\nimport { loadSettingsCache, getPrivateSettingSync } from '@shared/services/settingsService';\nimport type { LayoutServerLoad } from './$types';\nimport type { Locale } from '@shared/paraglide/runtime';\nimport type { NavigationNode } from '@content/ContentManager';\n\nexport const load: LayoutServerLoad = async ({ cookies, locals, url }) => {\n\t// Use cached setup status from hooks instead of re-checking\n\t// The handleSetup hook already sets locals.__setupConfigExists\n\tconst setupMode = locals.__setupConfigExists === false || url.pathname.startsWith('/setup');\n\n\t// Fast-path for setup mode - skip ALL CMS initialization\n\tif (setupMode) {\n\t\treturn {\n\t\t\tsystemLanguage: (cookies.get('systemLanguage') as Locale) ?? 'en',\n\t\t\tcontentLanguage: (cookies.get('contentLanguage') as Locale) ?? 'en',\n\t\t\tuser: null,\n\t\t\tisAdmin: false,\n\t\t\tisMultiTenant: false,\n\t\t\tcspNonce: locals.cspNonce,\n\t\t\ttenantId: null,\n\t\t\tdarkMode: locals.darkMode ?? false,\n\t\t\tnavigationStructure: [],\n\t\t\tcontentVersion: 0,\n\t\t\tsettings: {\n\t\t\t\tPKG_VERSION: version,\n\t\t\t\tsiteName: 'SveltyCMS Setup'\n\t\t\t}\n\t\t};\n\t}\n\n\t// Wrap settings loading in try-catch for preview mode resilience\n\tlet publicSettings;\n\ttry {\n\t\tconst settingsResult = await loadSettingsCache();\n\t\tpublicSettings = settingsResult.public;\n\t} catch (error) {\n\t\tconsole.error('[Layout] Settings load failed (preview mode?):', error);\n\t\t// Return minimal valid data structure\n\t\treturn {\n\t\t\tsystemLanguage: 'en' as Locale,\n\t\t\tcontentLanguage: 'en' as Locale,\n\t\t\tuser: null,\n\t\t\tisAdmin: false,\n\t\t\tisMultiTenant: false,\n\t\t\tcspNonce: locals.cspNonce,\n\t\t\ttenantId: null,\n\t\t\tdarkMode: locals.darkMode ?? false,\n\t\t\tnavigationStructure: [],\n\t\t\tcontentVersion: 0,\n\t\t\tsettings: {\n\t\t\t\tPKG_VERSION: version,\n\t\t\t\tsiteName: 'SveltyCMS'\n\t\t\t}\n\t\t};\n\t}\n\n\t// Extract values for server-side logic\n\tconst baseLocale = publicSettings.BASE_LOCALE;\n\tconst defaultContentLanguage = publicSettings.DEFAULT_CONTENT_LANGUAGE;\n\n\t// Private settings only accessible server-side\n\tconst isMultiTenant = getPrivateSettingSync('MULTI_TENANT');\n\n\tconst systemLanguage = (cookies.get('systemLanguage') as Locale) ?? baseLocale;\n\tconst contentLanguage = (cookies.get('contentLanguage') as Locale) ?? defaultContentLanguage;\n\n\t// Content System Hydration with error handling for preview mode\n\tconst { contentManager } = await import('@content/ContentManager');\n\tlet navigationStructure: NavigationNode[] = [];\n\tlet contentVersion = 0;\n\n\ttry {\n\t\t// Check if ContentManager is initialized before using it\n\t\tif (contentManager.getHealthStatus().state === 'initialized') {\n\t\t\tnavigationStructure = await contentManager.getNavigationStructureProgressive({\n\t\t\t\tmaxDepth: 1,\n\t\t\t\ttenantId: locals.tenantId\n\t\t\t});\n\t\t\tcontentVersion = contentManager.getContentVersion();\n\t\t} else {\n\t\t\tconsole.warn('[Layout] ContentManager not initialized, skipping navigation load');\n\t\t}\n\t} catch (error) {\n\t\tconsole.error('[Layout] ContentManager error (preview mode?):', error);\n\t\t// Continue with empty navigation - don't block page load\n\t}\n\n\treturn {\n\t\tsystemLanguage,\n\t\tcontentLanguage,\n\t\tuser: locals.user ?? null,\n\t\tisAdmin: locals.isAdmin ?? false,\n\t\tisMultiTenant,\n\t\tcspNonce: locals.cspNonce,\n\t\ttenantId: locals.tenantId ?? null,\n\t\tdarkMode: locals.darkMode ?? false,\n\t\tnavigationStructure,\n\t\tcontentVersion,\n\t\t// Pass public settings to client for store initialization\n\t\tsettings: {\n\t\t\t...publicSettings,\n\t\t\tPKG_VERSION: version\n\t\t}\n\t};\n};\n"],"names":[],"mappings":";;AAsBO,MAAM,OAAyB,OAAO,EAAE,SAAS,QAAQ,UAAU;AAGzE,QAAM,YAAY,OAAO,wBAAwB,SAAS,IAAI,SAAS,WAAW,QAAQ;AAG1F,MAAI,WAAW;AACd,WAAO;AAAA,MACN,gBAAiB,QAAQ,IAAI,gBAAgB,KAAgB;AAAA,MAC7D,iBAAkB,QAAQ,IAAI,iBAAiB,KAAgB;AAAA,MAC/D,MAAM;AAAA,MACN,SAAS;AAAA,MACT,eAAe;AAAA,MACf,UAAU,OAAO;AAAA,MACjB,UAAU;AAAA,MACV,UAAU,OAAO,YAAY;AAAA,MAC7B,qBAAqB,CAAA;AAAA,MACrB,gBAAgB;AAAA,MAChB,UAAU;AAAA,QACT,aAAa;AAAA,QACb,UAAU;AAAA,MAAA;AAAA,IACX;AAAA,EAEF;AAGA,MAAI;AACJ,MAAI;AACH,UAAM,iBAAiB,MAAM,kBAAA;AAC7B,qBAAiB,eAAe;AAAA,EACjC,SAAS,OAAO;AACf,YAAQ,MAAM,kDAAkD,KAAK;AAErE,WAAO;AAAA,MACN,gBAAgB;AAAA,MAChB,iBAAiB;AAAA,MACjB,MAAM;AAAA,MACN,SAAS;AAAA,MACT,eAAe;AAAA,MACf,UAAU,OAAO;AAAA,MACjB,UAAU;AAAA,MACV,UAAU,OAAO,YAAY;AAAA,MAC7B,qBAAqB,CAAA;AAAA,MACrB,gBAAgB;AAAA,MAChB,UAAU;AAAA,QACT,aAAa;AAAA,QACb,UAAU;AAAA,MAAA;AAAA,IACX;AAAA,EAEF;AAGA,QAAM,aAAa,eAAe;AAClC,QAAM,yBAAyB,eAAe;AAG9C,QAAM,gBAAgB,sBAAsB,cAAc;AAE1D,QAAM,iBAAkB,QAAQ,IAAI,gBAAgB,KAAgB;AACpE,QAAM,kBAAmB,QAAQ,IAAI,iBAAiB,KAAgB;AAGtE,QAAM,EAAE,eAAA,IAAmB,MAAM,OAAO,gCAAyB;AACjE,MAAI,sBAAwC,CAAA;AAC5C,MAAI,iBAAiB;AAErB,MAAI;AAEH,QAAI,eAAe,kBAAkB,UAAU,eAAe;AAC7D,4BAAsB,MAAM,eAAe,kCAAkC;AAAA,QAC5E,UAAU;AAAA,QACV,UAAU,OAAO;AAAA,MAAA,CACjB;AACD,uBAAiB,eAAe,kBAAA;AAAA,IACjC,OAAO;AACN,cAAQ,KAAK,mEAAmE;AAAA,IACjF;AAAA,EACD,SAAS,OAAO;AACf,YAAQ,MAAM,kDAAkD,KAAK;AAAA,EAEtE;AAEA,SAAO;AAAA,IACN;AAAA,IACA;AAAA,IACA,MAAM,OAAO,QAAQ;AAAA,IACrB,SAAS,OAAO,WAAW;AAAA,IAC3B;AAAA,IACA,UAAU,OAAO;AAAA,IACjB,UAAU,OAAO,YAAY;AAAA,IAC7B,UAAU,OAAO,YAAY;AAAA,IAC7B;AAAA,IACA;AAAA;AAAA,IAEA,UAAU;AAAA,MACT,GAAG;AAAA,MACH,aAAa;AAAA,IAAA;AAAA,EACd;AAEF;"}