{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../../src/routes/[language]/[...collection]/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/[language]/[...collection]/+page.server.ts\n * @description Enterprise-level SSR for collection pages with optimized data loading and caching.\n *\n * ## Architecture Overview\n * This module implements a **two-tier data loading strategy** for optimal performance:\n *\n * ### Tier 1: EntryList (View Mode) - Language-Specific Partial Data\n * - Loads only the CURRENT language data for list display\n * - Prevents over-fetching (100s of entries × N languages)\n * - Cache key includes language: `collection:ID:page:1:lang:EN`\n * - Typical payload: ~50KB for 10 entries\n *\n * ### Tier 2: Fields (Edit Mode) - Full Multilingual Data\n * - Loads ALL language data for the single entry being edited\n * - Enables simultaneous translation editing\n * - Minimal overhead: 1 entry × N languages (~5KB)\n * - Cache key: `entry:ID` (language-agnostic)\n *\n * ## Translation Status Integration\n * The TranslationStatus component shows per-language completion:\n * - **Dropdown (View Mode)**: Switches language → triggers SSR reload with new `lang` param\n * - **Progress Bar (Edit Mode)**: Shows translation % → updates locally without reload\n * - **Cache Strategy**: Language change invalidates list cache, preserves entry cache\n *\n * ## Performance Characteristics\n * | Scenario | Data Size | Requests | Cache Hit Rate |\n * |----------|-----------|----------|----------------|\n * | List 100 entries (EN) | ~50KB | 1 | 95% |\n * | Switch to DE | ~50KB | 1 | 95% (new cache key) |\n * | Edit entry | ~5KB | 1 | 80% |\n * | Toggle language in edit | 0KB | 0 | 100% (local only) |\n *\n * ## Cache Invalidation Rules\n * - Entry save/update → Invalidates `entry:ID` + all `collection:ID:*` keys\n * - Language change → Natural cache miss (different `lang` in key)\n * - Pagination → Natural cache miss (different `page` in key)\n *\n * @see docs/architecture/collection-store-dataflow.mdx\n */\nimport { error, redirect } from '@sveltejs/kit';\nimport type { PageServerLoad } from './$types';\n\n// Core SveltyCMS services\nimport { contentManager } from '@content/ContentManager';\nimport { cacheService } from '@shared/database/CacheService';\nimport { modifyRequest } from '@api/collections/modifyRequest';\nimport { getPublicSettingSync, getPrivateSettingSync } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\nimport type { FieldDefinition } from '@cms-types';\nimport type { User } from '@shared/database/auth/types';\n\nexport const load: PageServerLoad = async ({ locals, params, url }) => {\n\tconst { user, tenantId, dbAdapter } = locals;\n\tconst typedUser = user as User; // Explicitly cast user to User type\n\tconst { language, collection } = params;\n\n\t// =================================================================\n\t// 1. PRE-FLIGHT CHECKS & REDIRECTS (moved outside try-catch)\n\t// =================================================================\n\tif (!user) {\n\t\tthrow redirect(302, '/login');\n\t}\n\n\tconst collectionNameOnly = collection?.split('/').pop();\n\tconst systemPages = ['config', 'user', 'dashboard', 'imageEditor', 'email-previews'];\n\tif (collectionNameOnly && systemPages.includes(collectionNameOnly)) {\n\t\tthrow redirect(302, `/${collectionNameOnly}${url.search}`);\n\t}\n\n\tconst availableLanguages = getPublicSettingSync('AVAILABLE_CONTENT_LANGUAGES') || ['en'];\n\tif (typedUser?.locale && typedUser.locale !== language && availableLanguages.includes(typedUser.locale)) {\n\t\tconst newPath = url.pathname.replace(`/${language}/`, `/${typedUser.locale}/`);\n\t\tthrow redirect(302, newPath);\n\t}\n\n\tif (typedUser.lastAuthMethod === 'token') {\n\t\tthrow redirect(302, '/user');\n\t}\n\n\ttry {\n\t\t// =================================================================\n\t\t// 2. GET COLLECTION SCHEMA\n\t\t// =================================================================\n\t\t// Ensure ContentManager is initialized before use\n\t\tawait contentManager.initialize(tenantId);\n\n\t\t// Check if collection param is a UUID (32 char hex) or a path\n\t\tconst isUUID = /^[a-f0-9]{32}$/i.test(collection || '');\n\n\t\tlet currentCollection;\n\t\tif (isUUID) {\n\t\t\t// Direct UUID lookup\n\t\t\tlogger.debug(`Loading collection by UUID: \\x1b[33m${collection}\\x1b[0m`);\n\t\t\tcurrentCollection = contentManager.getCollectionById(collection!, tenantId);\n\n\t\t\t// Redirect to pretty path if available (Prevents UUID -> Path flicker on client)\n\t\t\tif (currentCollection && currentCollection.path) {\n\t\t\t\tconst newPath = `/${language}${currentCollection.path}${url.search}`;\n\t\t\t\tlogger.debug(`Redirecting UUID to canonical path: ${newPath}`);\n\t\t\t\tthrow redirect(302, newPath);\n\t\t\t}\n\t\t} else {\n\t\t\t// Path-based lookup (backward compatibility)\n\t\t\tconst collectionPath = `/${collection}`;\n\t\t\tlogger.debug(`Loading collection by path: \\x1b[34m${collectionPath}\\x1b[0m`);\n\t\t\tcurrentCollection = contentManager.getCollection(collectionPath, tenantId);\n\t\t}\n\n\t\tif (!currentCollection) {\n\t\t\tif (collectionNameOnly === 'Collections') {\n\t\t\t\tconst allCollections = await contentManager.getCollections(tenantId);\n\t\t\t\tif (allCollections.length > 0) {\n\t\t\t\t\tthrow redirect(302, `/${language}${allCollections[0].path}`);\n\t\t\t\t} else {\n\t\t\t\t\tthrow redirect(302, '/config/collectionbuilder');\n\t\t\t\t}\n\t\t\t}\n\t\t\tlogger.warn(`Collection not found: ${collection}`, { tenantId, isUUID });\n\t\t\tthrow error(404, `Collection not found: ${collection}`);\n\t\t}\n\n\t\t// If accessed via a non-canonical path, it will be handled by the client-side to update the URL,\n\t\t// but the server will still serve the content to avoid a redirect.\n\t\t// This check is to prevent potential redirect loops if client-side logic fails.\n\t\tif (!isUUID && currentCollection.path && `/${collection}` !== currentCollection.path) {\n\t\t\tlogger.warn(`Serving content from non-canonical path: /${collection}. Canonical is ${currentCollection.path}`);\n\t\t}\n\n\t\t// =================================================================\n\t\t// 3. DEFINE CACHE KEY & CHECK CACHE\n\t\t// =================================================================\n\t\tconst page = Number(url.searchParams.get('page') ?? 1);\n\t\tconst pageSize = Number(url.searchParams.get('pageSize') ?? 10);\n\t\tconst sortField = url.searchParams.get('sort') || '_createdAt';\n\t\tconst sortOrder = url.searchParams.get('order') || 'desc';\n\t\tconst sortParams = { field: sortField, direction: sortOrder as 'asc' | 'desc' };\n\t\tconst editEntryId = url.searchParams.get('edit');\n\t\tconst globalSearch = url.searchParams.get('search') || '';\n\n\t\tconst filterParams: Record<string, { contains: string }> = {};\n\t\tlet forceEmpty = false;\n\n\t\tfor (const [key, value] of url.searchParams.entries()) {\n\t\t\tif (key.startsWith('filter_')) {\n\t\t\t\tconst filterKey = key.substring(7); // remove \"filter_\"\n\n\t\t\t\t// Validate System Date fields to prevent DB cast errors on invalid inputs\n\t\t\t\tif ((filterKey === 'createdAt' || filterKey === 'updatedAt') && value) {\n\t\t\t\t\t// Check for \"asda\" type garbage. Valid dates or partial headers (numbers) allow pass.\n\t\t\t\t\tif (isNaN(Date.parse(value)) && !/^\\d+$/.test(value)) {\n\t\t\t\t\t\tforceEmpty = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfilterParams[filterKey] = { contains: value }; // Assuming a 'contains' filter strategy\n\t\t\t}\n\t\t}\n\n\t\tconst cacheKey = `collection:${currentCollection._id}:page:${page}:size:${pageSize}:filter:${JSON.stringify(\n\t\t\tfilterParams\n\t\t)}:search:${globalSearch}:sort:${JSON.stringify(sortParams)}:edit:${editEntryId || 'none'}:lang:${language}:tenant:${tenantId}`;\n\n\t\tconst cachedData = await cacheService.get(cacheKey);\n\t\tif (cachedData) {\n\t\t\tlogger.debug(`Cache HIT for key: \\x1b[33m${cacheKey}\\x1b[0m`);\n\t\t\treturn cachedData;\n\t\t}\n\t\tlogger.debug(`Cache MISS for key: \\x1b[33m${cacheKey}\\x1b[0m`);\n\n\t\t// =================================================================\n\t\t// 4. LOAD PAGINATED ENTRIES (DB QUERY)\n\t\t// =================================================================\n\t\tconst collectionTableName = `collection_${currentCollection._id}`;\n\n\t\tconst finalFilter: Record<string, unknown> = { ...filterParams };\n\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\tfinalFilter.tenantId = tenantId;\n\t\t}\n\n\t\tlogger.debug(`[EntryList] Querying table: ${collectionTableName}`, { finalFilter, tenantId });\n\n\t\t// If editing a specific entry, load only that entry\n\t\tif (editEntryId) {\n\t\t\tfinalFilter._id = editEntryId;\n\t\t}\n\n\t\t// Build the query with search support\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter is not available.', { tenantId });\n\t\t\tthrow error(500, 'Database adapter is not available.');\n\t\t}\n\t\tlet query = dbAdapter.queryBuilder(collectionTableName).where(finalFilter);\n\n\t\t// Add global search across all collection fields if search term provided\n\t\tif (globalSearch) {\n\t\t\t// Get all field names from the collection schema\n\t\t\tconst searchableFields = currentCollection.fields\n\t\t\t\t.map((field: FieldDefinition) => {\n\t\t\t\t\t// Get the field name, handling both direct name and nested path\n\t\t\t\t\tconst fieldObj = field as Record<string, unknown>;\n\t\t\t\t\tif (typeof fieldObj.name === 'string') {\n\t\t\t\t\t\treturn fieldObj.name;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeof fieldObj.path === 'string') {\n\t\t\t\t\t\treturn fieldObj.path;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeof fieldObj.key === 'string') {\n\t\t\t\t\t\treturn fieldObj.key;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeof fieldObj.db_fieldName === 'string') {\n\t\t\t\t\t\treturn fieldObj.db_fieldName;\n\t\t\t\t\t}\n\t\t\t\t\treturn null;\n\t\t\t\t})\n\t\t\t\t.filter((name): name is string => name !== null); // Type guard to filter nulls\n\n\t\t\t// Add system fields that might contain searchable data\n\t\t\tsearchableFields.push('_id', 'status', 'createdBy', 'updatedBy');\n\n\t\t\tlogger.debug(`[Global Search] Searching for \"${globalSearch}\" across fields: ${searchableFields.join(', ')}`);\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tquery = query.search(globalSearch, searchableFields as any);\n\t\t}\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tquery = query.sort(sortParams.field as any, sortParams.direction).paginate({ page, pageSize });\n\n\t\t// Build count query (must include same filters and search)\n\t\tlet countQuery = dbAdapter.queryBuilder(collectionTableName).where(finalFilter);\n\t\tif (globalSearch) {\n\t\t\tconst searchableFields = currentCollection.fields\n\t\t\t\t.map((field: FieldDefinition) => {\n\t\t\t\t\tconst fieldObj = field as Record<string, unknown>;\n\t\t\t\t\treturn (fieldObj.name || fieldObj.path || fieldObj.key || fieldObj.db_fieldName) as string | null;\n\t\t\t\t})\n\t\t\t\t.filter((name): name is string => typeof name === 'string');\n\t\t\tsearchableFields.push('_id', 'status', 'createdBy', 'updatedBy');\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tcountQuery = countQuery.search(globalSearch, searchableFields as any);\n\t\t}\n\n\t\t// Initialize with empty defaults\n\t\tlet entries: any[] = [];\n\t\tlet totalItems = 0;\n\n\t\tif (!forceEmpty) {\n\t\t\tconst [entriesResult, countResult] = await Promise.all([query.execute(), countQuery.count()]);\n\n\t\t\tif (!entriesResult.success || !countResult.success) {\n\t\t\t\tconst dbError =\n\t\t\t\t\t(!entriesResult.success && 'error' in entriesResult ? entriesResult.error : undefined) ||\n\t\t\t\t\t(!countResult.success && 'error' in countResult ? countResult.error : undefined) ||\n\t\t\t\t\t'Unknown database error';\n\n\t\t\t\tconst errStr = typeof dbError === 'object' ? JSON.stringify(dbError) : String(dbError);\n\n\t\t\t\t// Gracefully handle CastErrors (invalid filters) by returning empty results\n\t\t\t\tif (errStr.includes('Cast') || errStr.includes('convert')) {\n\t\t\t\t\tlogger.warn('Invalid filter value caused DB error, returning empty result.', { error: dbError });\n\t\t\t\t\tentries = [];\n\t\t\t\t\ttotalItems = 0;\n\t\t\t\t} else {\n\t\t\t\t\tlogger.error('Failed to load collection entries.', { error: dbError });\n\t\t\t\t\tthrow error(500, `Failed to load collection entries: ${errStr}`);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\tentries = (entriesResult.data || []) as any[];\n\t\t\t\ttotalItems = countResult.data as number;\n\t\t\t}\n\t\t}\n\n\t\t// =================================================================\n\t\t// 5. RUN MODIFYREQUEST (Enrich entries)\n\t\t// =================================================================\n\t\tif (entries.length > 0) {\n\t\t\tawait modifyRequest({\n\t\t\t\tdata: entries,\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\tfields: currentCollection.fields as any,\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\tcollection: currentCollection as any,\n\t\t\t\tuser: typedUser,\n\t\t\t\ttype: 'GET',\n\t\t\t\ttenantId\n\t\t\t});\n\t\t}\n\n\t\t// =================================================================\n\t\t// 5.5. ENTERPRISE SSR: LANGUAGE PROJECTION FOR VIEW MODE\n\t\t// =================================================================\n\t\t// For list views (EntryList), project only the current language data to:\n\t\t// 1. Reduce payload size (100s of entries × N languages → 100s of entries × 1 language)\n\t\t// 2. Prevent EntryList from displaying wrong language data (EN on /de/ page)\n\t\t// 3. Improve cache efficiency (language-specific cache keys)\n\t\t//\n\t\t// For edit mode (Fields), keep full multilingual data to enable:\n\t\t// 1. Simultaneous translation editing across all languages\n\t\t// 2. Per-field translation status calculation\n\t\t// 3. Language toggle without page reload\n\t\tif (!editEntryId) {\n\t\t\tfor (let i = 0; i < entries.length; i++) {\n\t\t\t\tconst entry = entries[i];\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\tfor (const field of currentCollection.fields as any[]) {\n\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\t\tconst fieldName = (field as any).db_fieldName || (field as any).label;\n\t\t\t\t\tif (\n\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\t\t\t(field as any).translated &&\n\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\t\t\t(entry as any)[fieldName] &&\n\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\t\t\ttypeof (entry as any)[fieldName] === 'object' &&\n\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\t\t\t!Array.isArray((entry as any)[fieldName])\n\t\t\t\t\t) {\n\t\t\t\t\t\t// ENTERPRISE BEHAVIOR: Show only the requested language\n\t\t\t\t\t\t// If translation doesn't exist, show clear indicator instead of fallback language\n\t\t\t\t\t\t// This prevents confusion and clearly shows which content needs translation\n\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\t\t\tconst value = ((entry as any)[fieldName] as any)[language];\n\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\t\t\t(entry as any)[fieldName] = value !== undefined && value !== null && value !== '' ? value : '-';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// =================================================================\n\t\t// 6. LOAD REVISIONS (for Fields.svelte) - Direct Import\n\t\t// =================================================================\n\t\tlet revisionsMeta = [];\n\t\t// Only load revisions if we're in edit mode and have an entry ID\n\t\tif (editEntryId && currentCollection.revision) {\n\t\t\ttry {\n\t\t\t\t// ✅ ARCHITECTURE: Direct import from service instead of API endpoint\n\t\t\t\tconst { getRevisions } = await import('@shared/services/RevisionService');\n\t\t\t\tconst revisionsResult = await getRevisions({\n\t\t\t\t\tcollection: currentCollection,\n\t\t\t\t\tentryId: editEntryId as string,\n\t\t\t\t\ttenantId: tenantId || '',\n\t\t\t\t\tdbAdapter,\n\t\t\t\t\tlimit: 100\n\t\t\t\t});\n\n\t\t\t\tif (revisionsResult.success && revisionsResult.data) {\n\t\t\t\t\trevisionsMeta = revisionsResult.data || [];\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tlogger.warn('Failed to load revisions', { error: err, editEntryId });\n\t\t\t\t// Don't fail the whole page load if revisions fail\n\t\t\t}\n\t\t}\n\n\t\t// =================================================================\n\t\t// 7. PREPARE FINAL DATA & SET CACHE\n\t\t// =================================================================\n\n\t\t// Strip all non-serializable data (functions, circular refs, etc.) from collection schema\n\t\t// This is necessary because widgets contain validation schemas with functions\n\t\tconst collectionSchemaForClient = JSON.parse(JSON.stringify(currentCollection));\n\n\t\tconst returnData = {\n\t\t\ttheme: locals.theme,\n\t\t\tuser: {\n\t\t\t\t_id: typedUser?._id,\n\t\t\t\tusername: typedUser?.username,\n\t\t\t\temail: typedUser?.email,\n\t\t\t\trole: typedUser?.role,\n\t\t\t\tavatar: typedUser?.avatar,\n\t\t\t\tlocale: typedUser?.locale\n\t\t\t},\n\t\t\tisAdmin: locals.isAdmin,\n\t\t\thasManageUsersPermission: locals.hasManageUsersPermission,\n\t\t\troles: locals.roles,\n\t\t\tsiteName: getPublicSettingSync('SITE_NAME') || 'SveltyCMS',\n\t\t\tcontentLanguage: language,\n\t\t\tcollectionSchema: collectionSchemaForClient,\n\t\t\tentries: entries || [],\n\t\t\tpagination: {\n\t\t\t\ttotalItems: totalItems || 0,\n\t\t\t\tpagesCount: Math.ceil((totalItems || 0) / pageSize),\n\t\t\t\tcurrentPage: page,\n\t\t\t\tpageSize: pageSize\n\t\t\t},\n\t\t\trevisions: revisionsMeta || []\n\t\t};\n\n\t\t// Cache with TTL (5 minutes for dynamic content)\n\t\ttry {\n\t\t\tawait cacheService.set(cacheKey, returnData, 300);\n\t\t} catch (cacheError) {\n\t\t\tlogger.warn('Failed to cache response', { error: cacheError });\n\t\t\t// Continue without caching - non-fatal error\n\t\t}\n\n\t\treturn returnData;\n\t} catch (err) {\n\t\t// If it's a redirect (SvelteKit standard behavior), just rethrow it without logging an error\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tif ((err as any)?.status >= 300 && (err as any)?.status < 400 && (err as any)?.location) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tlogger.error('Error loading collection page', {\n\t\t\terror: err,\n\t\t\tcollection,\n\t\t\tlanguage,\n\t\t\turl: url.pathname\n\t\t});\n\t\tthrow err;\n\t}\n};\n"],"names":[],"mappings":"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"}