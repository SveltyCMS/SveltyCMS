{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../src/routes/dashboard/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/dashboard/+page.server.ts\n * @description Server-side logic for the dashboard page.\n *\n * ### Props\n * - `user`: The authenticated user data.\n * - `availableWidgets`: Dynamically discovered widgets from the widgets folder\n *\n * Features:\n * - User authentication and authorization\n * - Dynamic widget discovery from widgets folder\n * - Server-side UUID v4 generation for new widgets\n * - Support for dynamic width and height sizing\n */\n\nimport { redirect, json, error } from '@sveltejs/kit';\nimport type { PageServerLoad, Actions } from './$types';\nimport { readdirSync } from 'fs';\nimport { join } from 'path';\nimport { v4 as uuidv4 } from 'uuid';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Cache for discovered widgets\nlet cachedWidgets: WidgetInfo[] | null = null;\nconst WIDGET_CACHE_TTL = 1000 * 60 * 5; // 5 minutes\nlet lastCacheTime = 0;\n\ninterface WidgetInfo {\n\tcomponentName: string;\n\tname: string;\n\ticon: string;\n\tdescription?: string;\n}\n\nasync function getWidgetMetadata(componentName: string): Promise<WidgetInfo> {\n\ttry {\n\t\tconst widgetModule = await import(`@shared/features/dashboard/widgets/${componentName}.svelte`);\n\n\t\tif (widgetModule.widgetMeta) {\n\t\t\treturn {\n\t\t\t\tcomponentName,\n\t\t\t\tname: widgetModule.widgetMeta.name,\n\t\t\t\ticon: widgetModule.widgetMeta.icon,\n\t\t\t\tdescription: widgetModule.widgetMeta.description\n\t\t\t};\n\t\t}\n\t\tlogger.warn(`Widget ${componentName} has no widgetMeta export, using fallback`);\n\t} catch (err) {\n\t\tlogger.error(`Failed to load metadata for widget ${componentName}:`, err);\n\t}\n\n\treturn {\n\t\tcomponentName,\n\t\tname: componentName\n\t\t\t.replace('Widget', '')\n\t\t\t.replace(/([A-Z])/g, ' $1')\n\t\t\t.trim(),\n\t\ticon: 'mdi:widgets',\n\t\tdescription: 'Custom dashboard widget'\n\t};\n}\n\nasync function discoverWidgets(): Promise<WidgetInfo[]> {\n\t// Return cached widgets if valid\n\tif (cachedWidgets && Date.now() - lastCacheTime < WIDGET_CACHE_TTL && process.env.NODE_ENV === 'production') {\n\t\treturn cachedWidgets;\n\t}\n\n\ttry {\n\t\tconst widgetsPath = join(process.cwd(), 'shared/features/src/dashboard/widgets');\n\t\tconst files = readdirSync(widgetsPath, { withFileTypes: true });\n\n\t\tconst widgetPromises = files\n\t\t\t.filter((file) => file.isFile() && file.name.endsWith('Widget.svelte'))\n\t\t\t.map(async (file) => {\n\t\t\t\tconst componentName = file.name.replace('.svelte', '');\n\t\t\t\treturn await getWidgetMetadata(componentName);\n\t\t\t});\n\n\t\tconst widgets = await Promise.all(widgetPromises);\n\t\tconst sortedWidgets = widgets.sort((a, b) => a.name.localeCompare(b.name));\n\n\t\tlogger.trace(`Discovered ${sortedWidgets.length} dashboard widgets`);\n\n\t\t// Update cache\n\t\tcachedWidgets = sortedWidgets;\n\t\tlastCacheTime = Date.now();\n\n\t\treturn sortedWidgets;\n\t} catch (err) {\n\t\tlogger.error('Failed to discover widgets:', err);\n\t\treturn [];\n\t}\n}\n\nexport const load: PageServerLoad = async ({ locals }) => {\n\tconst { user, isAdmin, roles: tenantRoles } = locals;\n\tif (!user) {\n\t\tlogger.warn('User not authenticated, redirecting to login.');\n\t\tthrow redirect(301, '/login');\n\t}\n\n\t// Check if user has permission to access dashboard\n\tconst hasDashboardPermission =\n\t\tisAdmin ||\n\t\ttenantRoles.some((role) =>\n\t\t\trole.permissions?.some((p) => {\n\t\t\t\tconst [resource, action] = p.split(':');\n\t\t\t\treturn resource === 'dashboard' && action === 'read';\n\t\t\t})\n\t\t);\n\n\tif (!hasDashboardPermission) {\n\t\tlogger.warn(`User ${user._id} (${user.email}) does not have permission to access dashboard. Redirecting.`);\n\t\tthrow error(403, 'Insufficient permissions to access dashboard');\n\t}\n\n\tlogger.trace(`User authenticated successfully for dashboard: ${user._id}`);\n\n\tconst { _id, ...rest } = user;\n\tconst availableWidgets = await discoverWidgets();\n\n\treturn {\n\t\tpageData: {\n\t\t\tuser: {\n\t\t\t\tid: _id.toString(),\n\t\t\t\t...rest\n\t\t\t},\n\t\t\tisAdmin\n\t\t},\n\t\tavailableWidgets\n\t};\n};\n\nexport const actions: Actions = {\n\tdefault: async ({ request, locals }) => {\n\t\tconst user = locals.user;\n\t\tif (!user) {\n\t\t\tlogger.warn('Unauthorized attempt to add widget');\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tconst data = await request.json();\n\t\tconst { userId, component, label, icon, size } = data;\n\n\t\tif (userId !== user._id.toString()) {\n\t\t\tlogger.warn(`User ID mismatch: ${userId} vs ${user._id}`);\n\t\t\tthrow error(403, 'Forbidden');\n\t\t}\n\n\t\tif (!component || !label || !icon || !size || typeof size.w !== 'number' || typeof size.h !== 'number') {\n\t\t\tlogger.error('Invalid widget data:', data);\n\t\t\tthrow error(400, 'Invalid widget data');\n\t\t}\n\n\t\tconst widget = {\n\t\t\tid: uuidv4(),\n\t\t\tcomponent,\n\t\t\tlabel,\n\t\t\ticon,\n\t\t\tsize,\n\t\t\tgridPosition: 0,\n\t\t\tmovable: true,\n\t\t\tresizable: true\n\t\t};\n\n\t\tlogger.trace(`Created widget ${widget.id} for user ${userId}`);\n\t\treturn json(widget);\n\t}\n};\n"],"names":["uuidv4"],"mappings":";;;;;;;;;;;;AAyBA,IAAI,gBAAqC;AACzC,MAAM,mBAAmB,MAAO,KAAK;AACrC,IAAI,gBAAgB;AASpB,eAAe,kBAAkB,eAA4C;AAC5E,MAAI;AACH,UAAM,eAAe,MAAM,qCAAA,uBAAA,OAAA,EAAA,yEAAA,MAAA,OAAA,8BAAA,GAAA,kFAAA,MAAA,OAAA,uCAAA,GAAA,uFAAA,MAAA,OAAA,4CAAA,GAAA,0EAAA,MAAA,OAAA,+BAAA,GAAA,kFAAA,MAAA,OAAA,uCAAA,GAAA,gFAAA,MAAA,OAAA,qCAAA,GAAA,0EAAA,MAAA,OAAA,+BAAA,GAAA,4EAAA,MAAA,OAAA,iCAAA,GAAA,iFAAA,MAAA,OAAA,sCAAA,GAAA,8EAAA,MAAA,OAAA,mCAAA,GAAA,kFAAA,MAAA,OAAA,uCAAA,GAAA,oFAAA,MAAA,OAAA,yCAAA,GAAA,oFAAA,MAAA,OAAA,yCAAA,GAAA,gFAAA,MAAA,OAAA,qCAAA,EAAA,CAAA,GAAA,wDAAA,aAAA,WAAA,EAAA;AAE3B,QAAI,aAAa,YAAY;AAC5B,aAAO;AAAA,QACN;AAAA,QACA,MAAM,aAAa,WAAW;AAAA,QAC9B,MAAM,aAAa,WAAW;AAAA,QAC9B,aAAa,aAAa,WAAW;AAAA,MAAA;AAAA,IAEvC;AACA,WAAO,KAAK,UAAU,aAAa,2CAA2C;AAAA,EAC/E,SAAS,KAAK;AACb,WAAO,MAAM,sCAAsC,aAAa,KAAK,GAAG;AAAA,EACzE;AAEA,SAAO;AAAA,IACN;AAAA,IACA,MAAM,cACJ,QAAQ,UAAU,EAAE,EACpB,QAAQ,YAAY,KAAK,EACzB,KAAA;AAAA,IACF,MAAM;AAAA,IACN,aAAa;AAAA,EAAA;AAEf;AAEA,eAAe,kBAAyC;AAEvD,MAAI,iBAAiB,KAAK,QAAQ,gBAAgB,oBAAoB,QAAQ,IAAI,aAAa,cAAc;AAC5G,WAAO;AAAA,EACR;AAEA,MAAI;AACH,UAAM,cAAc,KAAK,QAAQ,IAAA,GAAO,uCAAuC;AAC/E,UAAM,QAAQ,YAAY,aAAa,EAAE,eAAe,MAAM;AAE9D,UAAM,iBAAiB,MACrB,OAAO,CAAC,SAAS,KAAK,OAAA,KAAY,KAAK,KAAK,SAAS,eAAe,CAAC,EACrE,IAAI,OAAO,SAAS;AACpB,YAAM,gBAAgB,KAAK,KAAK,QAAQ,WAAW,EAAE;AACrD,aAAO,MAAM,kBAAkB,aAAa;AAAA,IAC7C,CAAC;AAEF,UAAM,UAAU,MAAM,QAAQ,IAAI,cAAc;AAChD,UAAM,gBAAgB,QAAQ,KAAK,CAAC,GAAG,MAAM,EAAE,KAAK,cAAc,EAAE,IAAI,CAAC;AAEzE,WAAO,MAAM,cAAc,cAAc,MAAM,oBAAoB;AAGnE,oBAAgB;AAChB,oBAAgB,KAAK,IAAA;AAErB,WAAO;AAAA,EACR,SAAS,KAAK;AACb,WAAO,MAAM,+BAA+B,GAAG;AAC/C,WAAO,CAAA;AAAA,EACR;AACD;AAEO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,QAAM,EAAE,MAAM,SAAS,OAAO,gBAAgB;AAC9C,MAAI,CAAC,MAAM;AACV,WAAO,KAAK,+CAA+C;AAC3D,UAAM,SAAS,KAAK,QAAQ;AAAA,EAC7B;AAGA,QAAM,yBACL,WACA,YAAY;AAAA,IAAK,CAAC,SACjB,KAAK,aAAa,KAAK,CAAC,MAAM;AAC7B,YAAM,CAAC,UAAU,MAAM,IAAI,EAAE,MAAM,GAAG;AACtC,aAAO,aAAa,eAAe,WAAW;AAAA,IAC/C,CAAC;AAAA,EAAA;AAGH,MAAI,CAAC,wBAAwB;AAC5B,WAAO,KAAK,QAAQ,KAAK,GAAG,KAAK,KAAK,KAAK,8DAA8D;AACzG,UAAM,MAAM,KAAK,8CAA8C;AAAA,EAChE;AAEA,SAAO,MAAM,kDAAkD,KAAK,GAAG,EAAE;AAEzE,QAAM,EAAE,KAAK,GAAG,KAAA,IAAS;AACzB,QAAM,mBAAmB,MAAM,gBAAA;AAE/B,SAAO;AAAA,IACN,UAAU;AAAA,MACT,MAAM;AAAA,QACL,IAAI,IAAI,SAAA;AAAA,QACR,GAAG;AAAA,MAAA;AAAA,MAEJ;AAAA,IAAA;AAAA,IAED;AAAA,EAAA;AAEF;AAEO,MAAM,UAAmB;AAAA,EAC/B,SAAS,OAAO,EAAE,SAAS,aAAa;AACvC,UAAM,OAAO,OAAO;AACpB,QAAI,CAAC,MAAM;AACV,aAAO,KAAK,oCAAoC;AAChD,YAAM,MAAM,KAAK,cAAc;AAAA,IAChC;AAEA,UAAM,OAAO,MAAM,QAAQ,KAAA;AAC3B,UAAM,EAAE,QAAQ,WAAW,OAAO,MAAM,SAAS;AAEjD,QAAI,WAAW,KAAK,IAAI,SAAA,GAAY;AACnC,aAAO,KAAK,qBAAqB,MAAM,OAAO,KAAK,GAAG,EAAE;AACxD,YAAM,MAAM,KAAK,WAAW;AAAA,IAC7B;AAEA,QAAI,CAAC,aAAa,CAAC,SAAS,CAAC,QAAQ,CAAC,QAAQ,OAAO,KAAK,MAAM,YAAY,OAAO,KAAK,MAAM,UAAU;AACvG,aAAO,MAAM,wBAAwB,IAAI;AACzC,YAAM,MAAM,KAAK,qBAAqB;AAAA,IACvC;AAEA,UAAM,SAAS;AAAA,MACd,IAAIA,GAAA;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,cAAc;AAAA,MACd,SAAS;AAAA,MACT,WAAW;AAAA,IAAA;AAGZ,WAAO,MAAM,kBAAkB,OAAO,EAAE,aAAa,MAAM,EAAE;AAC7D,WAAO,KAAK,MAAM;AAAA,EACnB;AACD;"}