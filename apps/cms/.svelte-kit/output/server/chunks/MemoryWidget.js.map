{"version":3,"file":"MemoryWidget.js","sources":["../../../../../../shared/features/src/dashboard/widgets/MemoryWidget.svelte"],"sourcesContent":["<!--\n@file src/routes/(app)/dashboard/widgets/MemoryWidget.svelte\n@component\n**A reusable widget component for displaying memory usage information with improved rendering and error handling**\n\n@example\n<MemoryWidget label=\"Memory Usage\" />\n\n### Props\n- `label`: The label for the widget (default: 'Memory Usage')\n\nThis widget fetches and displays real-time memory usage data, including:\n- Total memory\n- Used memory\n- Free memory\n- Usage percentages\n\nFeatures:\n- Responsive doughnut chart visualization\n- Theme-aware rendering (light/dark mode support)\n- Real-time data updates\n- Customizable widget properties (size, position, etc.)\n- Improved error handling and data validation\n- Proper lifecycle management\n- Enhanced debugging and logging\n-->\n<script lang=\"ts\" module>\n\texport const widgetMeta = {\n\t\tname: 'Memory Usage',\n\t\ticon: 'mdi:memory',\n\t\tdefaultSize: { w: 1, h: 2 }\n\t};\n</script>\n\n<script lang=\"ts\">\n\timport type { ChartConfiguration, Plugin } from 'chart.js';\n\timport { ArcElement, Chart, PieController, Tooltip } from 'chart.js';\n\timport { onDestroy } from 'svelte';\n\timport BaseWidget from '../BaseWidget.svelte';\n\timport type { WidgetSize } from '@cms-types';\n\n\tChart.register(PieController, ArcElement, Tooltip);\n\n\tinterface MemoryData {\n\t\tmemoryInfo: {\n\t\t\ttotal: {\n\t\t\t\tusedMemMb: number;\n\t\t\t\tfreeMemMb: number;\n\t\t\t\tusedMemPercentage: number;\n\t\t\t};\n\t\t};\n\t}\n\n\t// Props passed from +page.svelte, then to BaseWidget\n\tconst {\n\t\tlabel = 'Memory Usage',\n\t\ttheme = 'light',\n\t\ticon = 'mdi:memory',\n\t\twidgetId = undefined,\n\t\tsize = { w: 1, h: 2 } as WidgetSize,\n\t\tonSizeChange = (_newSize: WidgetSize) => {},\n\t\tonRemove = () => {}\n\t}: {\n\t\tlabel?: string;\n\t\ttheme?: 'light' | 'dark';\n\t\ticon?: string;\n\t\twidgetId?: string;\n\t\tsize?: WidgetSize;\n\t\tonSizeChange?: (newSize: WidgetSize) => void;\n\t\tonRemove?: () => void;\n\t} = $props();\n\n\tlet currentData: MemoryData | undefined = $state(undefined);\n\tlet chart: Chart | undefined = $state(undefined);\n\tlet chartCanvas: HTMLCanvasElement | undefined = $state(undefined);\n\n\tfunction updateChartAction(_canvas: HTMLCanvasElement, data: any) {\n\t\tcurrentData = data;\n\n\t\treturn {\n\t\t\tupdate(newData: any) {\n\t\t\t\tcurrentData = newData;\n\t\t\t}\n\t\t};\n\t}\n\n\t$effect(() => {\n\t\tif (!chartCanvas || !currentData?.memoryInfo?.total) return;\n\n\t\t// Data is already in MB from API\n\t\tconst usedMemMb = currentData.memoryInfo.total.usedMemMb || 0;\n\t\tconst freeMemMb = currentData.memoryInfo.total.freeMemMb || 0;\n\t\tconst usedPercent = currentData.memoryInfo.total.usedMemPercentage || 0;\n\n\t\tconst plainUsedMem = Number(usedMemMb) || 0;\n\t\tconst plainFreeMem = Number(freeMemMb) || 0;\n\n\t\tif (chart) {\n\t\t\tchart.data.datasets[0].data = [plainUsedMem, plainFreeMem];\n\t\t\tchart.update('none');\n\t\t} else {\n\t\t\tconst existingChart = Chart.getChart(chartCanvas);\n\t\t\tif (existingChart) {\n\t\t\t\texistingChart.destroy();\n\t\t\t}\n\n\t\t\tconst memoryTextCenterPlugin: Plugin = {\n\t\t\t\tid: 'memoryTextCenterPlugin',\n\t\t\t\tbeforeDraw(chart) {\n\t\t\t\t\tconst ctx = chart.ctx;\n\t\t\t\t\tconst { width, height } = chart;\n\n\t\t\t\t\tctx.save();\n\t\t\t\t\tctx.textAlign = 'center';\n\t\t\t\t\tctx.textBaseline = 'middle';\n\n\t\t\t\t\t// Main percentage text\n\t\t\t\t\tctx.font = `bold ${size.w > 1 ? '20px' : '16px'} system-ui, -apple-system, sans-serif`;\n\t\t\t\t\tctx.fillStyle = theme === 'dark' ? '#f9fafb' : '#111827';\n\t\t\t\t\tctx.fillText(`${usedPercent.toFixed(1)}%`, width / 2, height / 2 - 8);\n\n\t\t\t\t\t// Subtitle text\n\t\t\t\t\tctx.font = `${size.w > 1 ? '12px' : '10px'} system-ui, -apple-system, sans-serif`;\n\t\t\t\t\tctx.fillStyle = theme === 'dark' ? '#9ca3af' : '#6b7280';\n\t\t\t\t\tctx.fillText('Used', width / 2, height / 2 + 12);\n\n\t\t\t\t\tctx.restore();\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tconst config: ChartConfiguration = {\n\t\t\t\ttype: 'pie',\n\t\t\t\tdata: {\n\t\t\t\t\tlabels: ['Used', 'Free'],\n\t\t\t\t\tdatasets: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdata: [plainUsedMem, plainFreeMem],\n\t\t\t\t\t\t\tbackgroundColor: [\n\t\t\t\t\t\t\t\tusedPercent > 80 ? 'rgba(239, 68, 68, 0.8)' : usedPercent > 60 ? 'rgba(245, 158, 11, 0.8)' : 'rgba(34, 197, 94, 0.8)',\n\t\t\t\t\t\t\t\ttheme === 'dark' ? 'rgba(75, 85, 99, 0.4)' : 'rgba(229, 231, 235, 0.6)'\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tborderColor: [\n\t\t\t\t\t\t\t\tusedPercent > 80 ? 'rgba(239, 68, 68, 1)' : usedPercent > 60 ? 'rgba(245, 158, 11, 1)' : 'rgba(34, 197, 94, 1)',\n\t\t\t\t\t\t\t\ttheme === 'dark' ? 'rgba(75, 85, 99, 0.8)' : 'rgba(229, 231, 235, 1)'\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tborderWidth: 2,\n\t\t\t\t\t\t\tborderRadius: 4\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\toptions: {\n\t\t\t\t\tresponsive: true,\n\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\tanimation: {\n\t\t\t\t\t\tduration: 1000,\n\t\t\t\t\t\teasing: 'easeInOutQuart'\n\t\t\t\t\t},\n\t\t\t\t\tplugins: {\n\t\t\t\t\t\tlegend: {\n\t\t\t\t\t\t\tdisplay: false\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttooltip: {\n\t\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\t\tbackgroundColor: theme === 'dark' ? 'rgba(17, 24, 39, 0.9)' : 'rgba(255, 255, 255, 0.9)',\n\t\t\t\t\t\t\ttitleColor: theme === 'dark' ? '#f9fafb' : '#111827',\n\t\t\t\t\t\t\tbodyColor: theme === 'dark' ? '#d1d5db' : '#374151',\n\t\t\t\t\t\t\tborderColor: theme === 'dark' ? 'rgba(75, 85, 99, 0.5)' : 'rgba(229, 231, 235, 0.5)',\n\t\t\t\t\t\t\tborderWidth: 1,\n\t\t\t\t\t\t\tcornerRadius: 8,\n\t\t\t\t\t\t\tdisplayColors: true,\n\t\t\t\t\t\t\tcallbacks: {\n\t\t\t\t\t\t\t\tlabel: function (context) {\n\t\t\t\t\t\t\t\t\tconst label = context.label || '';\n\t\t\t\t\t\t\t\t\tconst value = typeof context.raw === 'number' ? context.raw : 0;\n\t\t\t\t\t\t\t\t\tconst dataSet = context.chart.data.datasets[0].data as number[];\n\t\t\t\t\t\t\t\t\tconst totalMemMb = dataSet.reduce((a, b) => (a ?? 0) + (b ?? 0), 0);\n\t\t\t\t\t\t\t\t\tconst percentage = totalMemMb ? (value / totalMemMb) * 100 : 0;\n\t\t\t\t\t\t\t\t\treturn `${label}: ${(value / 1024).toFixed(1)} GB (${percentage.toFixed(1)}%)`;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tplugins: [memoryTextCenterPlugin]\n\t\t\t};\n\t\t\tchart = new Chart(chartCanvas, config);\n\t\t}\n\t});\n\n\tonDestroy(() => {\n\t\tif (chart) chart.destroy();\n\t});\n</script>\n\n<BaseWidget\n\t{label}\n\t{theme}\n\tendpoint=\"/api/dashboard/systemInfo?type=memory\"\n\tpollInterval={10000}\n\t{icon}\n\t{widgetId}\n\t{size}\n\t{onSizeChange}\n\tonCloseRequest={onRemove}\n>\n\t{#snippet children({ data: fetchedData }: { data: any | undefined })}\n\t\t{#if fetchedData?.memoryInfo?.total}\n\t\t\t{@const totalMemGB = (fetchedData.memoryInfo.total.totalMemMb || 0) / 1024}\n\t\t\t{@const usedMemGB = (fetchedData.memoryInfo.total.usedMemMb || 0) / 1024}\n\t\t\t{@const freeMemGB = (fetchedData.memoryInfo.total.freeMemMb || 0) / 1024}\n\t\t\t{@const usedPercentage = fetchedData.memoryInfo.total.usedMemPercentage || 0}\n\t\t\t{@const usageLevel = usedPercentage > 80 ? 'high' : usedPercentage > 60 ? 'medium' : 'low'}\n\t\t\t{@const freePercentage = 100 - usedPercentage}\n\n\t\t\t<div class=\"flex h-full flex-col justify-between space-y-3\" role=\"region\" aria-label=\"Memory usage statistics\">\n\t\t\t\t<div class=\"flex items-center space-x-3\">\n\t\t\t\t\t<div class=\"flex items-center space-x-2\">\n\t\t\t\t\t\t<div class=\"relative\">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass=\"h-3 w-3 rounded-full {usageLevel === 'high' ? 'bg-red-500' : usageLevel === 'medium' ? 'bg-yellow-500' : 'bg-green-500'}\"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass=\"absolute inset-0 h-3 w-3 rounded-full {usageLevel === 'high'\n\t\t\t\t\t\t\t\t\t? 'bg-red-500'\n\t\t\t\t\t\t\t\t\t: usageLevel === 'medium'\n\t\t\t\t\t\t\t\t\t\t? 'bg-yellow-500'\n\t\t\t\t\t\t\t\t\t\t: 'bg-green-500'} animate-ping opacity-75\"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class=\"flex w-full items-center justify-between\">\n\t\t\t\t\t\t\t<div class=\"flex gap-2\">\n\t\t\t\t\t\t\t\t<div class=\"text-sm font-bold\" aria-live=\"polite\">{usedPercentage.toFixed(1)}%</div>\n\t\t\t\t\t\t\t\t<div class=\"text-sm {theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}\">Memory Used</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"flex gap-2\">\n\t\t\t\t\t\t\t\t<div class=\"text-sm font-bold\" aria-live=\"polite\">{freePercentage.toFixed(1)}%</div>\n\t\t\t\t\t\t\t\t<div class=\"text-sm {theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}\">Memory Free</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<h3 class=\"text-xs font-semibold {theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} text-center\">Memory Usage Overview</h3>\n\t\t\t\t<div class=\"relative shrink-0\" style=\"height: 120px; min-height: 80px; max-height: 180px; width: 100%;\">\n\t\t\t\t\t<canvas\n\t\t\t\t\t\tbind:this={chartCanvas}\n\t\t\t\t\t\tclass=\"h-full w-full\"\n\t\t\t\t\t\tuse:updateChartAction={fetchedData}\n\t\t\t\t\t\tstyle=\"display: block; width: 100% !important; height: 100% !important;\"\n\t\t\t\t\t\taria-label=\"Memory usage pie chart\"\n\t\t\t\t\t></canvas>\n\t\t\t\t</div>\n\n\t\t\t\t<h3 class=\"text-xs font-semibold {theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} text-center\">Memory Statistics</h3>\n\t\t\t\t<div class=\"shrink-0 space-y-3\">\n\t\t\t\t\t<div class=\"grid {size.w === 1 ? 'grid-cols-2' : 'grid-cols-3'} gap-3 text-xs\">\n\t\t\t\t\t\t<div class=\"flex flex-col text-center\">\n\t\t\t\t\t\t\t<span class={theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}>Total</span>\n\t\t\t\t\t\t\t<span class=\"text-sm font-semibold\">{totalMemGB.toFixed(1)} GB</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"flex flex-col text-center\">\n\t\t\t\t\t\t\t<span class={theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}>Used</span>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tclass=\"text-sm font-semibold {usageLevel === 'high'\n\t\t\t\t\t\t\t\t\t? 'text-red-600 dark:text-red-400'\n\t\t\t\t\t\t\t\t\t: usageLevel === 'medium'\n\t\t\t\t\t\t\t\t\t\t? 'text-yellow-600 dark:text-yellow-400'\n\t\t\t\t\t\t\t\t\t\t: 'text-green-600 dark:text-green-400'}\">{usedMemGB.toFixed(1)} GB</span\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{#if size.w !== 1}\n\t\t\t\t\t\t\t<div class=\"flex flex-col space-y-1 text-center\">\n\t\t\t\t\t\t\t\t<span class={theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}>Free</span>\n\t\t\t\t\t\t\t\t<span class=\"font-semibold {theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}\">{freeMemGB.toFixed(1)} GB</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{:else}\n\t\t\t<div class=\"flex h-full flex-col items-center justify-center space-y-3\" role=\"status\" aria-live=\"polite\">\n\t\t\t\t<div class=\"relative\">\n\t\t\t\t\t<div class=\"h-8 w-8 animate-spin rounded-full border-2 border-emerald-500 border-t-transparent\" aria-hidden=\"true\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"text-center\">\n\t\t\t\t\t<div class=\"text-sm font-medium {theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}\">Loading memory data</div>\n\t\t\t\t\t<div class=\"text-xs\">Please wait...</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{/if}\n\t{/snippet}\n</BaseWidget>\n"],"names":["$$renderer","$.attr_class","$.stringify","$.escape","$.clsx"],"mappings":";;;;MA2Bc,aAAU;AAAA,EACtB,MAAM;AAAA,EACN,MAAM;AAAA,EACN,eAAe,GAAG,GAAG,GAAG,EAAC;;;wCAI3B;AAOC,UAAM,SAAS,eAAe,YAAY,OAAO;;MAchD,QAAQ;AAAA,MACR,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,WAAW;AAAA,MACX,SAAS,GAAG,GAAG,GAAG,EAAC;AAAA,MACnB,eAAY,CAAI,aAAyB;AAAA,MAAC;AAAA,MAC1C,iBAAiB;AAAA,MAAC;AAAA;AAgInB,cAAS,MAAO;AAAA,IAEhB,CAAC;;UAcS,oBAAQA,aAAA,EAAG,MAAM,YAAW,GAAA;YAChC,aAAa,YAAY,OAAK;;gBAC1B,cAAc,YAAY,WAAW,MAAM,cAAc,KAAK;gBAC9D,aAAa,YAAY,WAAW,MAAM,aAAa,KAAK;gBAC5D,aAAa,YAAY,WAAW,MAAM,aAAa,KAAK;gBAC5D,iBAAiB,YAAY,WAAW,MAAM,qBAAqB;AACnE,gBAAA,aAAa,iBAAiB,KAAK,SAAS,iBAAiB,KAAK,WAAW;gBAC7E,iBAAiB,MAAM;AAOG,UAAAA,YAAA,KAAA,8NAAAC,WAAA,wBAAAC,UAAA,eAAe,SAAS,eAAe,eAAe,WAAW,kBAAkB,cAAc,CAAA,EAAA,CAAA,eAAAD,WAAA,yCAAAC,UAGhF,eAAe,SAC1D,eACA,eAAe,WACd,kBACA,cAAc,yLAMiC,eAAe,QAAQ,CAAC,CAAA,CAAA,eAAAD,WAAA,WAAAC,UACtD,UAAU,SAAS,kBAAkB,eAAe,CAAA,EAAA,CAAA,sGAAAC,YAGtB,eAAe,QAAQ,CAAC,CAAA,CAAA,eAAAF,WAAA,WAAAC,UACtD,UAAU,SAAS,kBAAkB,eAAe,CAAA,EAAA,CAAA,iDAAAD,WAAA,yBAAAC,UAM3C,UAAU,SAAS,kBAAkB,eAAe,CAAA,cAAA,CAAA,qSAAAD,WAAA,yBAAAC,UAWpD,UAAU,SAAS,kBAAkB,eAAe,4GAEnE,KAAK,MAAM,IAAI,gBAAgB,aAAa,CAAA,gBAAA,CAAA,gDAAAD,WAAAG,KAE/C,UAAU,SAAS,kBAAkB,eAAe,CAAA,CAAA,qDAAAD,YAC5B,WAAW,QAAQ,CAAC,CAAA,CAAA,gEAAAF,WAAAG,KAG5C,UAAU,SAAS,kBAAkB,eAAe,CAAA,CAAA,qBAAAH,WAAA,yBAAAC,UAElC,eAAe,SAC1C,mCACA,eAAe,WACd,yCACA,oCAAoC,CAAA,EAAA,CAAA,IAAAC,YAAI,UAAU,QAAQ,CAAC,CAAA,CAAA,mBAAA;cAI5D,KAAK,MAAM,GAAC;;AAEF,YAAAH,YAAA,KAAA,yDAAAC,WAAAG,KAAA,UAAU,SAAS,kBAAkB,eAAe,6DACrC,UAAU,SAAS,kBAAkB,eAAe,CAAA,EAAA,CAAA,IAAAD,YAAI,UAAU,QAAQ,CAAC,CAAA,CAAA,kBAAA;AAAA;;;;;;AAYzE,UAAAH,YAAA,KAAA,+RAAAC,WAAA,uBAAAC,UAAA,UAAU,SAAS,kBAAkB,eAAe,CAAA,EAAA,CAAA,kFAAA;AAAA;;;;QA5FxF;AAAA,QACA;AAAA;sBAEa;AAAA,QACb;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,wBACe;AAAA,QAEN;AAAA;;EAbH,CAAA;;"}