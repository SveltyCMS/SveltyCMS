{"version":3,"file":"demoCleanup.js","sources":["../../../../../../shared/utils/src/demoCleanup.ts"],"sourcesContent":["/**\n * @file src/utils/demoCleanup.ts\n * @description Utility to clean up expired demo tenants in DEMO mode.\n *\n * This function identifies tenants that were created over 60 minutes ago\n * and removes all associated data from the database to reset the demo environment.\n * It is intended to be run periodically (e.g., via a cron job).\n */\n\nimport { logger } from '@shared/utils/logger.server';\nimport mongoose from 'mongoose';\nimport { SystemSettingModel } from '@shared/database/mongodb/models/systemSetting';\nimport { ThemeModel } from '@shared/database/mongodb/models/theme';\nimport { ContentStructureModel } from '@shared/database/mongodb/models/contentStructure';\nimport { WebsiteTokenModel } from '@shared/database/mongodb/models/websiteToken';\nimport { getPrivateEnv } from '@shared/database/db';\n\n/**\n * Cleans up expired demo tenants.\n * Runs only if DEMO mode is enabled (via env var or private config).\n */\nexport async function cleanupExpiredDemoTenants() {\n\tconst env = getPrivateEnv();\n\tconst isDemo = process.env.SVELTYCMS_DEMO === 'true' || env?.DEMO === true;\n\n\t// Safety check: ONLY run in demo mode\n\tif (!isDemo) return;\n\n\t// Threshold: 60 minutes\n\tconst EXPIRATION_MS = 60 * 60 * 1000;\n\tconst cutoffDate = new Date(Date.now() - EXPIRATION_MS);\n\n\ttry {\n\t\t// Access models that are not exported directly\n\t\t// We assume these models are already registered by the application startup\n\t\tconst User = mongoose.models.auth_users || mongoose.model('auth_users');\n\t\tconst Session = mongoose.models.auth_sessions || mongoose.model('auth_sessions');\n\n\t\t// 1. Identify expired tenants\n\t\t// We look for the 'admin' user created during seeding for that tenant\n\t\tconst expiredUsers = await User.find({\n\t\t\ttenantId: { $exists: true, $ne: null },\n\t\t\tcreatedAt: { $lt: cutoffDate },\n\t\t\trole: 'admin'\n\t\t}).select('tenantId');\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tconst tenantIds = [...new Set(expiredUsers.map((u: any) => u.tenantId).filter(Boolean))];\n\n\t\tif (tenantIds.length === 0) return;\n\n\t\tlogger.info(`üßπ [Demo Cleanup] Found ${tenantIds.length} expired tenants. Starting cleanup...`);\n\n\t\tfor (const tenantId of tenantIds) {\n\t\t\tif (!tenantId) continue;\n\t\t\tlogger.debug(`üóëÔ∏è [Demo Cleanup] Deleting tenant: ${tenantId}`);\n\n\t\t\t// 2. Delete Dynamic Content\n\t\t\t// We iterate through the ContentStructure to find collection names\n\t\t\tconst collections = await ContentStructureModel.find({\n\t\t\t\ttenantId,\n\t\t\t\tnodeType: 'collection'\n\t\t\t});\n\n\t\t\tfor (const col of collections) {\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\t\tconst c = col as any;\n\t\t\t\tif (c.name) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Attempt to delete data from the dynamic collection\n\t\t\t\t\t\t// We use the native MongoDB driver to avoid Mongoose model compilation issues\n\t\t\t\t\t\tconst collectionName = c.name; // Assuming collection name matches structure name\n\t\t\t\t\t\t// Note: In a real multi-tenant setup, verify if collection names are prefixed or shared.\n\t\t\t\t\t\t// Here we assume shared collections with tenantId field.\n\t\t\t\t\t\tawait mongoose.connection.db?.collection(collectionName).deleteMany({ tenantId });\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t// Ignore errors if collection doesn't exist\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// 3. Delete System Data\n\t\t\tawait Promise.all([\n\t\t\t\tUser.deleteMany({ tenantId }),\n\t\t\t\tSession.deleteMany({ tenantId }),\n\t\t\t\tSystemSettingModel.deleteMany({ tenantId }),\n\t\t\t\tThemeModel.deleteMany({ tenantId }),\n\t\t\t\tContentStructureModel.deleteMany({ tenantId }),\n\t\t\t\tWebsiteTokenModel.deleteMany({ tenantId }),\n\t\t\t\t// Role is a dynamic model in authComposition, so we access the collection directly\n\t\t\t\tmongoose.connection.db?.collection('auth_roles').deleteMany({ tenantId })\n\t\t\t]);\n\t\t}\n\n\t\tlogger.info(`‚ú® [Demo Cleanup] Successfully removed ${tenantIds.length} tenants.`);\n\t} catch (error) {\n\t\tlogger.error('‚ùå [Demo Cleanup] Failed:', error);\n\t}\n}\n"],"names":[],"mappings":";;;;AAqBA,eAAsB,4BAA4B;AACjD,QAAM,MAAM,cAAA;AACZ,QAAM,SAAS,QAAQ,IAAI,mBAAmB,UAAU,KAAK,SAAS;AAGtE,MAAI,CAAC,OAAQ;AAGb,QAAM,gBAAgB,KAAK,KAAK;AAChC,QAAM,aAAa,IAAI,KAAK,KAAK,IAAA,IAAQ,aAAa;AAEtD,MAAI;AAGH,UAAM,OAAO,SAAS,OAAO,cAAc,SAAS,MAAM,YAAY;AACtE,UAAM,UAAU,SAAS,OAAO,iBAAiB,SAAS,MAAM,eAAe;AAI/E,UAAM,eAAe,MAAM,KAAK,KAAK;AAAA,MACpC,UAAU,EAAE,SAAS,MAAM,KAAK,KAAA;AAAA,MAChC,WAAW,EAAE,KAAK,WAAA;AAAA,MAClB,MAAM;AAAA,IAAA,CACN,EAAE,OAAO,UAAU;AAGpB,UAAM,YAAY,CAAC,GAAG,IAAI,IAAI,aAAa,IAAI,CAAC,MAAW,EAAE,QAAQ,EAAE,OAAO,OAAO,CAAC,CAAC;AAEvF,QAAI,UAAU,WAAW,EAAG;AAE5B,WAAO,KAAK,2BAA2B,UAAU,MAAM,uCAAuC;AAE9F,eAAW,YAAY,WAAW;AACjC,UAAI,CAAC,SAAU;AACf,aAAO,MAAM,uCAAuC,QAAQ,EAAE;AAI9D,YAAM,cAAc,MAAM,sBAAsB,KAAK;AAAA,QACpD;AAAA,QACA,UAAU;AAAA,MAAA,CACV;AAED,iBAAW,OAAO,aAAa;AAE9B,cAAM,IAAI;AACV,YAAI,EAAE,MAAM;AACX,cAAI;AAGH,kBAAM,iBAAiB,EAAE;AAGzB,kBAAM,SAAS,WAAW,IAAI,WAAW,cAAc,EAAE,WAAW,EAAE,UAAU;AAAA,UACjF,SAAS,KAAK;AAAA,UAEd;AAAA,QACD;AAAA,MACD;AAGA,YAAM,QAAQ,IAAI;AAAA,QACjB,KAAK,WAAW,EAAE,UAAU;AAAA,QAC5B,QAAQ,WAAW,EAAE,UAAU;AAAA,QAC/B,mBAAmB,WAAW,EAAE,UAAU;AAAA,QAC1C,WAAW,WAAW,EAAE,UAAU;AAAA,QAClC,sBAAsB,WAAW,EAAE,UAAU;AAAA,QAC7C,kBAAkB,WAAW,EAAE,UAAU;AAAA;AAAA,QAEzC,SAAS,WAAW,IAAI,WAAW,YAAY,EAAE,WAAW,EAAE,SAAA,CAAU;AAAA,MAAA,CACxE;AAAA,IACF;AAEA,WAAO,KAAK,yCAAyC,UAAU,MAAM,WAAW;AAAA,EACjF,SAAS,OAAO;AACf,WAAO,MAAM,4BAA4B,KAAK;AAAA,EAC/C;AACD;"}