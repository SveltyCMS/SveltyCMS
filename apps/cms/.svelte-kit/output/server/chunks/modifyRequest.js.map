{"version":3,"file":"modifyRequest.js","sources":["../../../../src/routes/api/collections/modifyRequest.ts"],"sourcesContent":["/**\n * @file src/routes/api/collections/modifyRequest.ts\n * @description Utility function for modifyin\t\t\t\t\t\t\tconst entryDuration = performance.now() - entryStart;\n\t\t\t\t\t\t\tlogger.trace(`Entry ${index + 1} processed in ${entryDuration.toFixed(2)}ms`);request data based on field widgets.\n *\n * This module provides functionality to:\n * - Process each field in a collection schema\n * - Apply widget-specific modifications to the request data, now with tenant context.\n * - Handle custom widget logic for different request types (GET, POST, etc.)\n *\n * Features:\n * - Support for custom widget-based data modifications\n * - Asynchronous processing of each entry in the data array\n * - Data accessor pattern for safe data manipulation\n * - Performance monitoring\n * - Detailed logging for debugging purposes\n *\n * Usage:\n * Called by various collection handlers (GET, POST, etc.) to modify request data\n * before final processing or database operations.\n */\n\nimport { getFieldName } from '@shared/utils/utils';\nimport { widgets } from '@shared/stores/widgetStore.svelte';\n\n// Types\nimport type { User } from '@shared/database/auth/types';\nimport type { FieldInstance } from '@cms-types';\nimport type { CollectionModel } from '@shared/database/dbInterface';\n\n// System logger\nimport { logger } from '@shared/utils/logger.server';\n\ninterface DataAccessor<T> {\n\tget(): T;\n\tupdate(newData: T): void;\n}\n\ninterface EntryData {\n\t_id?: string;\n\tmeta_data?: Record<string, unknown>;\n\t[key: string]: unknown;\n}\n\n// Define the parameters for the function\ninterface ModifyRequestParams {\n\tdata: EntryData[];\n\tfields: FieldInstance[];\n\tcollection: CollectionModel;\n\tuser: User;\n\ttype: string;\n\ttenantId?: string; // Add tenantId for multi-tenancy\n}\n\n// Function to modify request data based on field widgets\nexport async function modifyRequest({ data, fields, collection, user, type, tenantId }: ModifyRequestParams) {\n\tconst start = performance.now();\n\ttry {\n\t\t// User access is already validated by hooks\n\t\tlogger.trace(\n\t\t\t`Starting modifyRequest for type: ${type}, user: ${user._id}, collection: ${(collection as unknown as { id?: string }).id ?? 'unknown'}, tenant: ${tenantId}`\n\t\t);\n\n\t\tfor (const field of fields) {\n\t\t\tconst fieldStart = performance.now();\n\t\t\t// Access widget from store with proper type casting\n\t\t\tconst widget = widgets.widgetFunctions[field.widget.Name];\n\t\t\tconst fieldName = getFieldName(field);\n\n\t\t\tlogger.trace(`Processing field: ${fieldName}, widget: ${field.widget.Name}`);\n\n\t\t\t// Resolve potential modifyRequest handler in a type-safe way\n\t\t\tconst modifyFn = (widget as unknown as { modifyRequest?: unknown })?.modifyRequest;\n\t\t\tconst modifyBatchFn = (widget as unknown as { modifyRequestBatch?: unknown })?.modifyRequestBatch;\n\n\t\t\tif (modifyBatchFn && typeof modifyBatchFn === 'function') {\n\t\t\t\t// --- BATCH PROCESSING ---\n\t\t\t\tlogger.trace(`Processing batch for field: ${fieldName}, widget: ${field.widget.Name}`);\n\t\t\t\ttry {\n\t\t\t\t\tconst batchStart = performance.now();\n\t\t\t\t\t// Extract data for this field\n\t\t\t\t\t// const fieldData = data.map((entry) => entry[fieldName]);\n\n\t\t\t\t\t// Call batch function\n\t\t\t\t\tconst batchResults = (await modifyBatchFn({\n\t\t\t\t\t\tdata: data as unknown as Record<string, unknown>[],\n\t\t\t\t\t\tcollection: collection as unknown as Record<string, unknown>,\n\t\t\t\t\t\tfield: field as unknown as Record<string, unknown>,\n\t\t\t\t\t\tuser: user as unknown as Record<string, unknown>,\n\t\t\t\t\t\ttype: type as unknown as string,\n\t\t\t\t\t\ttenantId: tenantId as unknown as string | undefined\n\t\t\t\t\t})) as Record<string, unknown>[];\n\n\t\t\t\t\t// Update data with results\n\t\t\t\t\tif (Array.isArray(batchResults) && batchResults.length === data.length) {\n\t\t\t\t\t\tdata = batchResults as EntryData[];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlogger.warn(`Batch processing for ${fieldName} returned invalid results length. Expected ${data.length}, got ${batchResults?.length}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst batchDuration = performance.now() - batchStart;\n\t\t\t\t\tlogger.debug(`Batch processing for ${fieldName} completed in ${batchDuration.toFixed(2)}ms`);\n\t\t\t\t} catch (batchError) {\n\t\t\t\t\tconst errorMessage = batchError instanceof Error ? batchError.message : 'Unknown batch error';\n\t\t\t\t\tlogger.error(`Batch widget error for field ${fieldName}: ${errorMessage}`);\n\t\t\t\t\t// Fallback to individual processing could be implemented here if needed,\n\t\t\t\t\t// but for now we let it fail or continue with unmodified data?\n\t\t\t\t\t// Ideally we should probably re-throw or handle gracefully.\n\t\t\t\t}\n\t\t\t} else if (modifyFn !== undefined && modifyFn !== null && typeof modifyFn === 'function') {\n\t\t\t\t// --- INDIVIDUAL PROCESSING (Legacy/Fallback) ---\n\t\t\t\tdata = await Promise.all(\n\t\t\t\t\tdata.map(async (entry: EntryData, index: number) => {\n\t\t\t\t\t\t// const entryStart = performance.now();\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst entryCopy = { ...entry };\n\t\t\t\t\t\t\tconst dataAccessor: DataAccessor<unknown> = {\n\t\t\t\t\t\t\t\tget() {\n\t\t\t\t\t\t\t\t\treturn entryCopy[fieldName];\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tupdate(newData: unknown) {\n\t\t\t\t\t\t\t\t\tentryCopy[fieldName] = newData;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t// logger.trace(`Processing entry ${index + 1}/${data.length} for field: ${fieldName}`);\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t// Call widget.modifyRequest with structural casts to avoid `any` while remaining permissive\n\t\t\t\t\t\t\t\tconst modify = modifyFn as (args: Record<string, unknown>) => Promise<unknown> | unknown;\n\t\t\t\t\t\t\t\tawait modify({\n\t\t\t\t\t\t\t\t\tcollection: collection as unknown as Record<string, unknown>,\n\t\t\t\t\t\t\t\t\tfield: field as unknown as Record<string, unknown>,\n\t\t\t\t\t\t\t\t\tdata: dataAccessor as unknown as Record<string, unknown>,\n\t\t\t\t\t\t\t\t\tuser: user as unknown as Record<string, unknown>,\n\t\t\t\t\t\t\t\t\ttype: type as unknown as string,\n\t\t\t\t\t\t\t\t\ttenantId: tenantId as unknown as string | undefined,\n\t\t\t\t\t\t\t\t\tid: entryCopy._id,\n\t\t\t\t\t\t\t\t\tmeta_data: entryCopy.meta_data\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t// const entryDuration = performance.now() - entryStart;\n\t\t\t\t\t\t\t\t// logger.debug(`Entry ${index + 1} processed in ${entryDuration.toFixed(2)}ms`);\n\t\t\t\t\t\t\t} catch (widgetError) {\n\t\t\t\t\t\t\t\tconst errorMessage = widgetError instanceof Error ? widgetError.message : 'Unknown widget error';\n\t\t\t\t\t\t\t\tconst errorStack = widgetError instanceof Error ? widgetError.stack : '';\n\t\t\t\t\t\t\t\tlogger.error(`Widget error for field ${fieldName}, entry ${index + 1}: ${errorMessage}`, { stack: errorStack });\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn entryCopy;\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tconst errorMessage = error instanceof Error ? error.message : 'Unknown error';\n\t\t\t\t\t\t\tconst errorStack = error instanceof Error ? error.stack : '';\n\t\t\t\t\t\t\tlogger.error(`Error processing entry ${index + 1}: ${errorMessage}`, {\n\t\t\t\t\t\t\t\tstack: errorStack\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\treturn entry;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t);\n\n\t\t\t\tconst fieldDuration = performance.now() - fieldStart;\n\t\t\t\tlogger.trace(`Field ${fieldName} processed in ${fieldDuration.toFixed(2)}ms`);\n\t\t\t} else {\n\t\t\t\t// logger.warn(`No modifyRequest handler for widget: ${field.widget.Name}`);\n\t\t\t}\n\t\t}\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info(`ModifyRequest completed in ${duration.toFixed(2)}ms for ${data.length} entries`);\n\n\t\treturn data;\n\t} catch (error) {\n\t\tconst duration = performance.now() - start;\n\t\tconst errorMessage = error instanceof Error ? error.message : 'Unknown error';\n\t\tconst errorStack = error instanceof Error ? error.stack : '';\n\t\tlogger.error(`ModifyRequest failed after ${duration.toFixed(2)}ms: ${errorMessage}`, {\n\t\t\tstack: errorStack\n\t\t});\n\t\tthrow error;\n\t}\n}\n"],"names":[],"mappings":"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"}