{"version":3,"file":"apiPermissions.js","sources":["../../../../../../shared/database/src/auth/apiPermissions.ts"],"sourcesContent":["/**\n * @file src/databases/auth/apiPermissions.ts\n * @description API endpoint permissions configuration for role-based access control\n *\n * This file defines which roles can access which API endpoints at the first level.\n * This provides coarse-grained but effective security for multi-tenant applications.\n *\n * Permission Structure:\n * - Key: API endpoint (first segment after /api/)\n * - Value: Array of roles that can access this endpoint\n *\n * Special roles:\n * - '*' means all authenticated users can access\n * - Only listed roles can access the endpoint\n */\n\nexport const API_PERMISSIONS: Record<string, string[]> = {\n\t// System Administration - Admin only\n\t'api:config': ['admin'], // System configuration\n\t'api:token': ['admin'], // Token management (user invitations)\n\t'api:permission': ['admin'], // Permission management\n\t'api:settings': ['admin'], // System settings (database-driven configuration)\n\t'api:systemPreferences': ['admin'], // System preferences (user dashboard layout/sizes)\n\t'api:config_sync': ['admin'], // Configuration sync (import/export)\n\t'api:system': ['admin', 'editor'], // System status (version, health)\n\t'api:telemetry': ['admin', 'editor'], // System telemetry\n\n\t// Admin area - Admin only\n\t'api:admin': ['admin'],\n\n\t// Website Tokens - Admin only\n\t'api:website-tokens': ['admin'],\n\n\t// Authentication & Security - All authenticated users can manage their own auth/2FA\n\t'api:auth': ['*'], // Authentication endpoints (2FA setup, disable, backup codes, etc.)\n\n\t// User Management - Admin and Editor\n\t'api:user': ['admin', 'editor'], // User management (includes profile updates)\n\n\t// Content Management - Admin and Editor\n\t'api:collections': ['admin', 'editor'], // Collection/content management\n\t'api:media': ['admin', 'editor'], // Media management\n\t'api:systemVirtualFolder': ['admin', 'editor'], // System virtual folders\n\n\t// Dashboard & Analytics - Admin and Editor\n\t'api:dashboard': ['admin', 'editor'], // Dashboard data\n\t'api:security': ['admin'], // Security monitoring and incident management\n\t'api:search': ['admin', 'editor'], // Search functionality\n\t'api:index': ['admin', 'editor'], // Index/search operations\n\n\t// Content Structure - Admin and Editor\n\t'api:content-structure': ['admin', 'editor'], // Content structure management\n\n\t// Theme Management - Admin and Editor (content creators need themes)\n\t'api:theme': ['admin', 'editor'], // Theme management\n\n\t// Video/Media Processing - Admin and Editor\n\t'api:video': ['admin', 'editor'], // Video processing\n\n\t// GraphQL - Admin and Editor (for complex queries)\n\t'api:graphql': ['admin', 'editor'], // GraphQL endpoint\n\n\t// Widget Management - Admin and Developer\n\t'api:widgets': ['admin', 'developer'], // Widget management and marketplace\n\n\t// Public/Semi-public endpoints (authenticated users)\n\t'api:sendMail': ['*'], // Email sending (used internally, but needs auth)\n\t'api:getTokensProvided': ['admin'] // Token information - admin only\n};\n\n/**\n * Check if a user role has permission to access an API endpoint\n * @param userRole - The user's role\n * @param apiEndpoint - The API endpoint (e.g., 'token', 'user', 'collections')\n * @returns boolean - true if access is allowed\n */\nexport function hasApiPermission(userRole: string, apiEndpoint: string): boolean {\n\tconst allowedRoles = API_PERMISSIONS[`api:${apiEndpoint}`];\n\n\tif (!allowedRoles) {\n\t\t// If endpoint is not defined, deny access by default (secure by default)\n\t\treturn false;\n\t}\n\n\t// Check for wildcard (all authenticated users)\n\tif (allowedRoles.includes('*')) {\n\t\treturn true;\n\t}\n\n\t// Check if user's role is in the allowed roles\n\treturn allowedRoles.includes(userRole);\n}\n\n/**\n * Get all API endpoints that a role can access\n * @param userRole - The user's role\n * @returns string[] - Array of API endpoints the role can access\n */\nexport function getApiPermissionsForRole(userRole: string): string[] {\n\tconst endpoints: string[] = [];\n\n\tfor (const [endpoint, roles] of Object.entries(API_PERMISSIONS)) {\n\t\tif (roles.includes('*') || roles.includes(userRole)) {\n\t\t\tendpoints.push(endpoint.replace('api:', ''));\n\t\t}\n\t}\n\n\treturn endpoints;\n}\n"],"names":[],"mappings":"AAgBO,MAAM,kBAA4C;AAAA;AAAA,EAExD,cAAc,CAAC,OAAO;AAAA;AAAA,EACtB,aAAa,CAAC,OAAO;AAAA;AAAA,EACrB,kBAAkB,CAAC,OAAO;AAAA;AAAA,EAC1B,gBAAgB,CAAC,OAAO;AAAA;AAAA,EACxB,yBAAyB,CAAC,OAAO;AAAA;AAAA,EACjC,mBAAmB,CAAC,OAAO;AAAA;AAAA,EAC3B,cAAc,CAAC,SAAS,QAAQ;AAAA;AAAA,EAChC,iBAAiB,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAGnC,aAAa,CAAC,OAAO;AAAA;AAAA,EAGrB,sBAAsB,CAAC,OAAO;AAAA;AAAA,EAG9B,YAAY,CAAC,GAAG;AAAA;AAAA;AAAA,EAGhB,YAAY,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAG9B,mBAAmB,CAAC,SAAS,QAAQ;AAAA;AAAA,EACrC,aAAa,CAAC,SAAS,QAAQ;AAAA;AAAA,EAC/B,2BAA2B,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAG7C,iBAAiB,CAAC,SAAS,QAAQ;AAAA;AAAA,EACnC,gBAAgB,CAAC,OAAO;AAAA;AAAA,EACxB,cAAc,CAAC,SAAS,QAAQ;AAAA;AAAA,EAChC,aAAa,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAG/B,yBAAyB,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAG3C,aAAa,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAG/B,aAAa,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAG/B,eAAe,CAAC,SAAS,QAAQ;AAAA;AAAA;AAAA,EAGjC,eAAe,CAAC,SAAS,WAAW;AAAA;AAAA;AAAA,EAGpC,gBAAgB,CAAC,GAAG;AAAA;AAAA,EACpB,yBAAyB,CAAC,OAAO;AAAA;AAClC;AAQO,SAAS,iBAAiB,UAAkB,aAA8B;AAChF,QAAM,eAAe,gBAAgB,OAAO,WAAW,EAAE;AAEzD,MAAI,CAAC,cAAc;AAElB,WAAO;AAAA,EACR;AAGA,MAAI,aAAa,SAAS,GAAG,GAAG;AAC/B,WAAO;AAAA,EACR;AAGA,SAAO,aAAa,SAAS,QAAQ;AACtC;"}