{"version":3,"file":"LogsWidget.js","sources":["../../../../../../shared/features/src/dashboard/widgets/LogsWidget.svelte"],"sourcesContent":["<!--\n@file src/routes/(app)/dashboard/widgets/LogsWidget.svelte\n@component\n**Logs widget component to display system logs with filtering, searching, and pagination.**\n\n### Props\n- Inherits all props from BaseWidget.svelte\n- `data`: Fetched log data from the server.\n\n### Features:\n- Displays paginated log entries.\n- Allows filtering logs by level (fatal, error, warn, info, debug, trace).\n- Provides a search input to filter log messages by text.\n- Includes date range filtering for logs.\n- Integrates with BaseWidget for common widget functionalities.\n-->\n<script lang=\"ts\" module>\n\texport const widgetMeta = {\n\t\tname: 'Logs',\n\t\ticon: 'mdi:text-box-outline',\n\t\tdefaultSize: { w: 2, h: 2 }\n\t};\n</script>\n\n<script lang=\"ts\">\n\timport BaseWidget from '../BaseWidget.svelte';\n\timport type { TablePaginationProps, WidgetSize } from '@cms-types';\n\timport TablePagination from '@cms/components/system/table/TablePagination.svelte';\n\n\tinterface LogEntryDisplay {\n\t\ttimestamp: string;\n\t\tlevel: string;\n\t\tmessage: string;\n\t\tmessageHtml?: string;\n\t\targs: unknown[];\n\t}\n\n\tinterface FetchedData {\n\t\tlogs: LogEntryDisplay[];\n\t\tpage: number;\n\t\ttotal: number;\n\t\ttotalPages?: number;\n\t\thasMore?: boolean;\n\t}\n\n\tconst {\n\t\tlabel = 'System Logs',\n\t\ticon = 'mdi:file-document-outline',\n\t\twidgetId = undefined,\n\t\tsize = { w: 2, h: 2 } as WidgetSize,\n\t\tonSizeChange = (_newSize: WidgetSize) => {},\n\t\tonRemove = () => {},\n\t\tendpoint = '/api/dashboard/logs',\n\t\tpollInterval = 15000\n\t}: {\n\t\tlabel?: string;\n\t\ticon?: string;\n\t\twidgetId?: string;\n\t\tsize?: WidgetSize;\n\t\tonSizeChange?: (newSize: WidgetSize) => void;\n\t\tonRemove?: () => void;\n\t\tendpoint?: string;\n\t\tpollInterval?: number;\n\t} = $props();\n\n\t// Internal state for logs data\n\tlet currentPage = $state(1);\n\tlet logsPerPage = $state(20); // Default logs per page\n\n\t// Filter states\n\tlet filterLevel = $state('all');\n\tlet searchText = $state('');\n\tlet startDate: string = $state(''); // YYYY-MM-DD\n\tlet endDate: string = $state(''); // YYYY-MM-DD\n\n\t// Debounce search/filter inputs\n\tlet searchTimeout: ReturnType<typeof setTimeout> | null = null;\n\tlet triggerFetchFlag = $state(0); // Dummy state to explicitly trigger fetch via $effect\n\n\t// Function to construct query parameters for the endpoint\n\tconst getQueryParams = () => {\n\t\tconst params = new URLSearchParams();\n\t\tif (filterLevel !== 'all') params.append('level', filterLevel);\n\t\tif (searchText) params.append('search', searchText);\n\t\tif (startDate) params.append('startDate', startDate);\n\t\tif (endDate) params.append('endDate', endDate);\n\t\tparams.append('page', currentPage.toString());\n\t\tparams.append('limit', logsPerPage.toString());\n\t\treturn params.toString();\n\t};\n\n\t// Effect to re-trigger fetch when filters or pagination change\n\t$effect(() => {\n\t\tif (searchTimeout) clearTimeout(searchTimeout);\n\t\tsearchTimeout = setTimeout(() => {\n\t\t\tconst isFilterChange = filterLevel !== 'all' || searchText !== '' || startDate !== '' || endDate !== '';\n\t\t\tif (isFilterChange && currentPage !== 1) {\n\t\t\t\tcurrentPage = 1;\n\t\t\t}\n\t\t\ttriggerFetchFlag++;\n\t\t}, 300); // 300ms debounce\n\t});\n\n\t// Handle pagination changes\n\tconst onUpdatePage = (page: number) => {\n\t\tcurrentPage = page;\n\t\ttriggerFetchFlag++;\n\t};\n\n\tconst onUpdateRowsPerPage = (rows: number) => {\n\t\tlogsPerPage = rows;\n\t\tcurrentPage = 1;\n\t\ttriggerFetchFlag++;\n\t};\n\n\tconst handleFilterLevelChange = (newLevel: typeof filterLevel) => {\n\t\tfilterLevel = newLevel;\n\t\tcurrentPage = 1;\n\t\ttriggerFetchFlag++;\n\t};\n\n\tconst dynamicEndpoint = $derived(`${endpoint}?${getQueryParams()}&_t=${triggerFetchFlag}`);\n\n\tconst logLevelOptions = [\n\t\t{ value: 'all', label: 'All Levels' },\n\t\t{ value: 'fatal', label: 'Fatal' },\n\t\t{ value: 'error', label: 'Error' },\n\t\t{ value: 'warn', label: 'Warn' },\n\t\t{ value: 'info', label: 'Info' },\n\t\t{ value: 'debug', label: 'Debug' },\n\t\t{ value: 'trace', label: 'Trace' }\n\t];\n\n\tconst getLogLevelColor = (level: string) => {\n\t\tswitch (level.toLowerCase()) {\n\t\t\tcase 'fatal':\n\t\t\t\treturn 'text-purple-500 dark:text-purple-400';\n\t\t\tcase 'error':\n\t\t\t\treturn 'text-red-500 dark:text-red-400';\n\t\t\tcase 'warn':\n\t\t\t\treturn 'text-yellow-500 dark:text-yellow-400';\n\t\t\tcase 'info':\n\t\t\t\treturn 'text-green-500 dark:text-green-400';\n\t\t\tcase 'debug':\n\t\t\t\treturn 'text-blue-500 dark:text-blue-400';\n\t\t\tcase 'trace':\n\t\t\t\treturn 'text-cyan-500 dark:text-cyan-400';\n\t\t\tdefault:\n\t\t\t\treturn 'text-gray-700 dark:text-gray-300';\n\t\t}\n\t};\n</script>\n\n<BaseWidget {label} endpoint={dynamicEndpoint} {pollInterval} {icon} {widgetId} {size} {onSizeChange} onCloseRequest={onRemove}>\n\t{#snippet children({ data: fetchedData }: { data: FetchedData | undefined })}\n\t\t<div class=\"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\" role=\"region\" aria-label=\"Log controls\">\n\t\t\t<div class=\"flex flex-1 gap-2\">\n\t\t\t\t<select\n\t\t\t\t\tbind:value={filterLevel}\n\t\t\t\t\tonchange={(e) => handleFilterLevelChange((e.target as HTMLSelectElement).value as typeof filterLevel)}\n\t\t\t\t\tclass=\"rounded border border-surface-300 bg-white px-8 py-1 text-sm text-surface-700 shadow-sm focus:border-primary-400 focus:ring-2 focus:ring-primary-200 dark:border-surface-400 dark:bg-surface-800 dark:text-surface-100 dark:focus:border-primary-500\"\n\t\t\t\t\taria-label=\"Filter log level\"\n\t\t\t\t>\n\t\t\t\t\t{#each logLevelOptions as { value, label }}\n\t\t\t\t\t\t<option {value}>{label}</option>\n\t\t\t\t\t{/each}\n\t\t\t\t</select>\n\t\t\t\t<input\n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tplaceholder=\"Search logs...\"\n\t\t\t\t\tbind:value={searchText}\n\t\t\t\t\tclass=\"rounded border border-surface-300 bg-white px-3 py-1 text-sm text-surface-700 shadow-sm focus:border-primary-400 focus:ring-2 focus:ring-primary-200 dark:border-surface-400 dark:bg-surface-800 dark:text-surface-100 dark:focus:border-primary-500\"\n\t\t\t\t\taria-label=\"Search logs\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<input\n\t\t\t\t\ttype=\"date\"\n\t\t\t\t\tbind:value={startDate}\n\t\t\t\t\tclass=\"rounded border border-surface-300 bg-white px-2 py-1 text-sm text-surface-700 shadow-sm focus:border-primary-400 focus:ring-2 focus:ring-primary-200 dark:border-surface-400 dark:bg-surface-800 dark:text-surface-100 dark:focus:border-primary-500\"\n\t\t\t\t\taria-label=\"Start date\"\n\t\t\t\t/>\n\t\t\t\t<input\n\t\t\t\t\ttype=\"date\"\n\t\t\t\t\tbind:value={endDate}\n\t\t\t\t\tclass=\"rounded border border-surface-300 bg-white px-2 py-1 text-sm text-surface-700 shadow-sm focus:border-primary-400 focus:ring-2 focus:ring-primary-200 dark:border-surface-400 dark:bg-surface-800 dark:text-surface-100 dark:focus:border-primary-500\"\n\t\t\t\t\taria-label=\"End date\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t\t{#if fetchedData && fetchedData.logs && fetchedData.logs.length > 0}\n\t\t\t<div\n\t\t\t\tclass=\"flex flex-col gap-1 overflow-y-auto\"\n\t\t\t\tstyle=\"max-height: calc({size.h} * 120px - 120px);\"\n\t\t\t\trole=\"list\"\n\t\t\t\taria-label=\"System log entries\"\n\t\t\t>\n\t\t\t\t{#each fetchedData.logs as log}\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass=\"flex items-center gap-1 rounded border border-surface-200 bg-surface-50/50 px-1 py-1 text-xs dark:text-surface-50 dark:bg-surface-800/30\"\n\t\t\t\t\t\trole=\"listitem\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:circle\" width=\"8\" class=\"{getLogLevelColor(log.level)} shrink-0\" aria-label=\"{log.level} log level\"\n\t\t\t\t\t\t></iconify-icon>\n\t\t\t\t\t\t<span class=\"w-8 shrink-0 text-xs text-surface-500 dark:text-surface-50\">\n\t\t\t\t\t\t\t{new Date(log.timestamp).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class=\"w-14 shrink-0 text-xs font-medium {getLogLevelColor(log.level)}\">\n\t\t\t\t\t\t\t{log.level.toUpperCase()}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class=\"text-text-900 dark:text-text-100 flex-1 select-text truncate text-xs\" style=\"user-select: text;\" title={log.message}>\n\t\t\t\t\t\t\t{log.message}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t{/each}\n\t\t\t</div>\n\n\t\t\t<div class=\"mt-auto flex items-center justify-between pt-2\">\n\t\t\t\t<TablePagination\n\t\t\t\t\tcurrentPage={(fetchedData.page || 1) as TablePaginationProps['currentPage']}\n\t\t\t\t\trowsPerPage={logsPerPage as TablePaginationProps['rowsPerPage']}\n\t\t\t\t\trowsPerPageOptions={[10, 20, 50, 100] as TablePaginationProps['rowsPerPageOptions']}\n\t\t\t\t\ttotalItems={(fetchedData.total || 0) as TablePaginationProps['totalItems']}\n\t\t\t\t\tpagesCount={(fetchedData.hasMore ? (fetchedData.page || 1) + 1 : fetchedData.page || 1) as TablePaginationProps['pagesCount']}\n\t\t\t\t\tonUpdatePage={onUpdatePage as TablePaginationProps['onUpdatePage']}\n\t\t\t\t\tonUpdateRowsPerPage={onUpdateRowsPerPage as TablePaginationProps['onUpdateRowsPerPage']}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t{:else}\n\t\t\t<div class=\"flex flex-1 flex-col items-center justify-center py-6 text-xs text-gray-500 dark:text-gray-400\" role=\"status\" aria-live=\"polite\">\n\t\t\t\t<iconify-icon icon=\"mdi:file-remove-outline\" width=\"32\" class=\"mb-2 text-surface-400 dark:text-surface-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t<span>No logs found</span>\n\t\t\t</div>\n\t\t{/if}\n\t{/snippet}\n</BaseWidget>\n"],"names":["$$renderer","label","$.attr","$.attr_style","$.stringify","$.ensure_array_like","$.escape"],"mappings":"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"}