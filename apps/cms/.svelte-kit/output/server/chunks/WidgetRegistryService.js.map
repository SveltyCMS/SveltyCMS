{"version":3,"file":"WidgetRegistryService.js","sources":["../../../../../../shared/services/src/WidgetRegistryService.ts"],"sourcesContent":["/**\n * @file shared/services/src/WidgetRegistryService.ts\n * @description A server-side singleton service that discovers and holds all widget blueprints.\n */\n\nimport type { WidgetFactory, WidgetModule, WidgetType } from '@cms-types';\nimport { logger } from '@shared/utils/logger';\n\nclass WidgetRegistryService {\n\tprivate static instance: WidgetRegistryService;\n\tprivate widgets: Map<string, WidgetFactory> = new Map();\n\tprivate isInitialized = false;\n\n\tprivate constructor() {\n\t\tlogger.debug('WidgetRegistryService instance created.');\n\t}\n\n\tpublic static getInstance(): WidgetRegistryService {\n\t\tif (!WidgetRegistryService.instance) {\n\t\t\tWidgetRegistryService.instance = new WidgetRegistryService();\n\t\t}\n\t\treturn WidgetRegistryService.instance;\n\t}\n\n\t/**\n\t * Registers a single widget manually.\n\t */\n\tpublic registerWidget(name: string, widgetFn: WidgetFactory): void {\n\t\tthis.widgets.set(name, widgetFn);\n\t\tlogger.trace(`[WidgetRegistryService] Registered widget: ${name}`);\n\t}\n\n\t/**\n\t * Registers multiple widgets at once.\n\t */\n\tpublic registerWidgets(widgets: Record<string, WidgetFactory>): void {\n\t\tfor (const [name, widgetFn] of Object.entries(widgets)) {\n\t\t\tthis.registerWidget(name, widgetFn);\n\t\t}\n\t\tthis.isInitialized = true;\n\t}\n\n\tpublic getWidget(name: string): WidgetFactory | undefined {\n\t\treturn this.widgets.get(name);\n\t}\n\n\tpublic getAllWidgets(): Map<string, WidgetFactory> {\n\t\treturn this.widgets;\n\t}\n\n\t/**\n\t * Processes a raw widget module into a standard factory (internal use)\n\t */\n\tpublic processWidgetModule(\n\t\tpath: string,\n\t\tmodule: WidgetModule,\n\t\ttype: WidgetType\n\t): {\n\t\tname: string;\n\t\twidgetFn: WidgetFactory;\n\t\tdependencies: string[];\n\t\tfolderName: string;\n\t} | null {\n\t\ttry {\n\t\t\tconst name = path.split('/').at(-2);\n\t\t\tif (!name) return null;\n\n\t\t\tif (typeof module.default !== 'function') return null;\n\n\t\t\tconst originalFn = module.default;\n\t\t\tconst widgetName = originalFn.Name || name;\n\t\t\tconst dependencies = originalFn.__dependencies || [];\n\n\t\t\tconst widgetFn: WidgetFactory = Object.assign((config: any) => originalFn(config), {\n\t\t\t\tName: widgetName,\n\t\t\t\tGuiSchema: originalFn.GuiSchema,\n\t\t\t\tGraphqlSchema: originalFn.GraphqlSchema,\n\t\t\t\tIcon: originalFn.Icon,\n\t\t\t\tDescription: originalFn.Description,\n\t\t\t\taggregations: originalFn.aggregations,\n\t\t\t\t__widgetType: type,\n\t\t\t\t__dependencies: dependencies,\n\t\t\t\t__inputComponentPath: originalFn.__inputComponentPath || '',\n\t\t\t\t__displayComponentPath: originalFn.__displayComponentPath || '',\n\t\t\t\tcomponentPath: originalFn.__inputComponentPath || ''\n\t\t\t}) as unknown as WidgetFactory;\n\n\t\t\treturn {\n\t\t\t\tname: widgetFn.Name,\n\t\t\t\twidgetFn,\n\t\t\t\tdependencies,\n\t\t\t\tfolderName: name\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tlogger.error(`Failed to process widget module ${path}:`, error);\n\t\t\treturn null;\n\t\t}\n\t}\n}\n\nexport const widgetRegistryService = WidgetRegistryService.getInstance();\n"],"names":[],"mappings":";AAQA,MAAM,sBAAsB;AAAA,EAC3B,OAAe;AAAA,EACP,8BAA0C,IAAA;AAAA,EAC1C,gBAAgB;AAAA,EAEhB,cAAc;AACrB,WAAO,MAAM,yCAAyC;AAAA,EACvD;AAAA,EAEA,OAAc,cAAqC;AAClD,QAAI,CAAC,sBAAsB,UAAU;AACpC,4BAAsB,WAAW,IAAI,sBAAA;AAAA,IACtC;AACA,WAAO,sBAAsB;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAKO,eAAe,MAAc,UAA+B;AAClE,SAAK,QAAQ,IAAI,MAAM,QAAQ;AAC/B,WAAO,MAAM,8CAA8C,IAAI,EAAE;AAAA,EAClE;AAAA;AAAA;AAAA;AAAA,EAKO,gBAAgB,SAA8C;AACpE,eAAW,CAAC,MAAM,QAAQ,KAAK,OAAO,QAAQ,OAAO,GAAG;AACvD,WAAK,eAAe,MAAM,QAAQ;AAAA,IACnC;AACA,SAAK,gBAAgB;AAAA,EACtB;AAAA,EAEO,UAAU,MAAyC;AACzD,WAAO,KAAK,QAAQ,IAAI,IAAI;AAAA,EAC7B;AAAA,EAEO,gBAA4C;AAClD,WAAO,KAAK;AAAA,EACb;AAAA;AAAA;AAAA;AAAA,EAKO,oBACN,MACA,QACA,MAMQ;AACR,QAAI;AACH,YAAM,OAAO,KAAK,MAAM,GAAG,EAAE,GAAG,EAAE;AAClC,UAAI,CAAC,KAAM,QAAO;AAElB,UAAI,OAAO,OAAO,YAAY,WAAY,QAAO;AAEjD,YAAM,aAAa,OAAO;AAC1B,YAAM,aAAa,WAAW,QAAQ;AACtC,YAAM,eAAe,WAAW,kBAAkB,CAAA;AAElD,YAAM,WAA0B,OAAO,OAAO,CAAC,WAAgB,WAAW,MAAM,GAAG;AAAA,QAClF,MAAM;AAAA,QACN,WAAW,WAAW;AAAA,QACtB,eAAe,WAAW;AAAA,QAC1B,MAAM,WAAW;AAAA,QACjB,aAAa,WAAW;AAAA,QACxB,cAAc,WAAW;AAAA,QACzB,cAAc;AAAA,QACd,gBAAgB;AAAA,QAChB,sBAAsB,WAAW,wBAAwB;AAAA,QACzD,wBAAwB,WAAW,0BAA0B;AAAA,QAC7D,eAAe,WAAW,wBAAwB;AAAA,MAAA,CAClD;AAED,aAAO;AAAA,QACN,MAAM,SAAS;AAAA,QACf;AAAA,QACA;AAAA,QACA,YAAY;AAAA,MAAA;AAAA,IAEd,SAAS,OAAO;AACf,aAAO,MAAM,mCAAmC,IAAI,KAAK,KAAK;AAC9D,aAAO;AAAA,IACR;AAAA,EACD;AACD;AAEO,MAAM,wBAAwB,sBAAsB,YAAA;"}