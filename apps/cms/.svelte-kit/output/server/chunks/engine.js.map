{"version":3,"file":"engine.js","sources":["../../../../../../shared/services/src/token/modifiers.ts","../../../../../../shared/services/src/token/engine.ts"],"sourcesContent":["/**\n * @file src/services/token/modifiers.ts\n * @description Comprehensive modifier system with math, path, and enhanced date operations\n *\n * Features:\n * - Text Modifiers\n * - Math Modifiers\n * - Date Modifiers\n * - Path Modifiers\n * - Logic Modifiers\n * - Security Modifiers\n * - CMS Specific Modifiers\n */\nimport type { ModifierFunction, ModifierMetadata } from './types';\nimport { formatDateString } from '@shared/utils/dateUtils';\n\nexport const modifierRegistry = new Map<string, ModifierFunction>();\n\n// EXECUTION LOGIC\nconst functions: Record<string, ModifierFunction> = {\n\t// ===== TEXT MODIFIERS =====\n\tupper: (v) => String(v ?? '').toUpperCase(),\n\tlower: (v) => String(v ?? '').toLowerCase(),\n\tcapitalize: (v) => String(v ?? '').replace(/\\b\\w/g, (c) => c.toUpperCase()),\n\n\tslug: (v) =>\n\t\tString(v ?? '')\n\t\t\t.toLowerCase()\n\t\t\t.trim()\n\t\t\t.replace(/[^\\w\\s-]/g, '')\n\t\t\t.replace(/[\\s_-]+/g, '-'),\n\n\ttruncate: (v, args) => {\n\t\tconst len = parseInt(args?.[0] || '50');\n\t\tconst s = String(v ?? '');\n\t\treturn s.length > len ? s.substring(0, len) + (args?.[1] ?? '...') : s;\n\t},\n\n\t// ===== MATH MODIFIERS =====\n\tadd: (v, args) => String(parseFloat(String(v)) + parseFloat(args?.[0] || '0')),\n\tsubtract: (v, args) => String(parseFloat(String(v)) - parseFloat(args?.[0] || '0')),\n\tmultiply: (v, args) => String(parseFloat(String(v)) * parseFloat(args?.[0] || '1')),\n\tdivide: (v, args) => {\n\t\tconst divisor = parseFloat(args?.[0] || '1');\n\t\treturn divisor === 0 ? 'NaN' : String(parseFloat(String(v)) / divisor);\n\t},\n\tround: (v, args) => {\n\t\tconst decimals = parseInt(args?.[0] || '0');\n\t\treturn String(Math.round(parseFloat(String(v)) * Math.pow(10, decimals)) / Math.pow(10, decimals));\n\t},\n\tceil: (v) => String(Math.ceil(parseFloat(String(v)))),\n\tfloor: (v) => String(Math.floor(parseFloat(String(v)))),\n\tabs: (v) => String(Math.abs(parseFloat(String(v)))),\n\tmin: (v, args) => String(Math.min(parseFloat(String(v)), parseFloat(args?.[0] || '0'))),\n\tmax: (v, args) => String(Math.max(parseFloat(String(v)), parseFloat(args?.[0] || '0'))),\n\tnumber: (v, args) => {\n\t\tconst decimals = parseInt(args?.[0] || '0');\n\t\treturn parseFloat(String(v)).toFixed(decimals);\n\t},\n\n\t// ===== DATE MODIFIERS =====\n\tdate: (v, args) => {\n\t\tif (!v) return '';\n\n\t\t// Preset formats\n\t\tconst presets: Record<string, string> = {\n\t\t\tiso: \"yyyy-MM-dd'T'HH:mm:ssxxx\",\n\t\t\tdate: 'yyyy-MM-dd',\n\t\t\ttime: 'HH:mm:ss',\n\t\t\tdatetime: 'yyyy-MM-dd HH:mm:ss',\n\t\t\tshort: 'M/d/yy',\n\t\t\tlong: 'MMMM d, yyyy',\n\t\t\tfull: 'EEEE, MMMM d, yyyy',\n\t\t\trelative: 'relative', // Special case\n\t\t\ttimestamp: 'timestamp' // Special case\n\t\t};\n\n\t\tconst format = args?.[0] || 'date';\n\t\tconst dateObj = typeof v === 'string' ? new Date(v) : (v as Date);\n\n\t\t// Handle special formats\n\t\tif (format === 'timestamp') {\n\t\t\treturn String(dateObj.getTime());\n\t\t}\n\n\t\tif (format === 'relative') {\n\t\t\tconst now = Date.now();\n\t\t\tconst diff = now - dateObj.getTime();\n\t\t\tconst seconds = Math.floor(diff / 1000);\n\t\t\tconst minutes = Math.floor(seconds / 60);\n\t\t\tconst hours = Math.floor(minutes / 60);\n\t\t\tconst days = Math.floor(hours / 24);\n\n\t\t\tif (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;\n\t\t\tif (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;\n\t\t\tif (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;\n\t\t\treturn 'just now';\n\t\t}\n\n\t\tconst actualFormat = presets[format] || format;\n\t\treturn formatDateString(v as string | Date, actualFormat, '');\n\t},\n\n\t// ===== PATH MODIFIERS =====\n\tbasename: (v) => {\n\t\tconst path = String(v ?? '');\n\t\treturn path.split('/').pop() || path;\n\t},\n\n\tdirname: (v) => {\n\t\tconst path = String(v ?? '');\n\t\tconst parts = path.split('/');\n\t\tparts.pop();\n\t\treturn parts.join('/') || '/';\n\t},\n\n\textension: (v) => {\n\t\tconst path = String(v ?? '');\n\t\tconst match = path.match(/\\.([^.]+)$/);\n\t\treturn match ? match[1] : '';\n\t},\n\n\tfilename: (v) => {\n\t\tconst path = String(v ?? '');\n\t\tconst base = path.split('/').pop() || path;\n\t\treturn base.replace(/\\.[^.]+$/, '');\n\t},\n\n\tpath: (v) => String(v ?? '').replace(/\\\\/g, '/'),\n\n\tcleanurl: (v) => {\n\t\treturn String(v ?? '')\n\t\t\t.replace(/^https?:\\/\\//, '')\n\t\t\t.replace(/\\/$/, '');\n\t},\n\n\t// ===== LOGIC MODIFIERS =====\n\tdefault: (v, args) => (!v || v === '' ? (args?.[0] ?? '') : String(v)),\n\tif: (v, args) => (v && v !== 'false' ? (args?.[0] ?? '') : (args?.[1] ?? '')),\n\teq: (v, args) => (String(v) === String(args?.[0]) ? 'true' : 'false'),\n\tne: (v, args) => (String(v) !== String(args?.[0]) ? 'true' : 'false'),\n\tgt: (v, args) => (parseFloat(String(v)) > parseFloat(args?.[0] || '0') ? 'true' : 'false'),\n\tlt: (v, args) => (parseFloat(String(v)) < parseFloat(args?.[0] || '0') ? 'true' : 'false'),\n\n\t// ===== SECURITY =====\n\tescape: (v) =>\n\t\tString(v ?? '')\n\t\t\t.replace(/&/g, '&amp;')\n\t\t\t.replace(/</g, '&lt;')\n\t\t\t.replace(/>/g, '&gt;')\n\t\t\t.replace(/\"/g, '&quot;')\n\t\t\t.replace(/'/g, '&#039;'),\n\n\t// ===== CMS SPECIFIC =====\n\timage_style: (v, args) => {\n\t\tif (!v) return '';\n\t\tconst style = args?.[0] || 'original';\n\t\treturn `/api/media/${v}?style=${style}`;\n\t}\n};\n\n// Register all modifiers\nObject.entries(functions).forEach(([k, v]) => {\n\tmodifierRegistry.set(k.toLowerCase(), v);\n});\n\n// UI METADATA\nexport const modifierMetadata: ModifierMetadata[] = [\n\t// TEXT\n\t{\n\t\tname: 'upper',\n\t\tlabel: 'Uppercase',\n\t\tdescription: 'Convert text to UPPERCASE',\n\t\taccepts: ['string'],\n\t\targs: []\n\t},\n\t{\n\t\tname: 'lower',\n\t\tlabel: 'Lowercase',\n\t\tdescription: 'Convert text to lowercase',\n\t\taccepts: ['string'],\n\t\targs: []\n\t},\n\t{\n\t\tname: 'capitalize',\n\t\tlabel: 'Capitalize Words',\n\t\tdescription: 'Capitalize The First Letter Of Each Word',\n\t\taccepts: ['string'],\n\t\targs: []\n\t},\n\t{\n\t\tname: 'slug',\n\t\tlabel: 'URL Slug',\n\t\tdescription: 'Convert to URL-friendly format (hello-world)',\n\t\taccepts: ['string'],\n\t\targs: []\n\t},\n\t{\n\t\tname: 'truncate',\n\t\tlabel: 'Truncate Text',\n\t\tdescription: 'Shorten text to specified length',\n\t\taccepts: ['string'],\n\t\targs: [\n\t\t\t{ name: 'Length', type: 'number', default: 50 },\n\t\t\t{ name: 'Suffix', type: 'text', default: '...' }\n\t\t]\n\t},\n\n\t// MATH\n\t{\n\t\tname: 'add',\n\t\tlabel: 'Add Number',\n\t\tdescription: 'Add a value to this number',\n\t\taccepts: ['number'],\n\t\targs: [{ name: 'Value', type: 'number', default: 1 }]\n\t},\n\t{\n\t\tname: 'subtract',\n\t\tlabel: 'Subtract Number',\n\t\tdescription: 'Subtract a value from this number',\n\t\taccepts: ['number'],\n\t\targs: [{ name: 'Value', type: 'number', default: 1 }]\n\t},\n\t{\n\t\tname: 'multiply',\n\t\tlabel: 'Multiply',\n\t\tdescription: 'Multiply by a value',\n\t\taccepts: ['number'],\n\t\targs: [{ name: 'Multiplier', type: 'number', default: 2 }]\n\t},\n\t{\n\t\tname: 'divide',\n\t\tlabel: 'Divide',\n\t\tdescription: 'Divide by a value',\n\t\taccepts: ['number'],\n\t\targs: [{ name: 'Divisor', type: 'number', default: 2 }]\n\t},\n\t{\n\t\tname: 'round',\n\t\tlabel: 'Round Number',\n\t\tdescription: 'Round to specified decimal places',\n\t\taccepts: ['number'],\n\t\targs: [{ name: 'Decimals', type: 'number', default: 0 }]\n\t},\n\t{\n\t\tname: 'ceil',\n\t\tlabel: 'Round Up',\n\t\tdescription: 'Round up to nearest integer',\n\t\taccepts: ['number'],\n\t\targs: []\n\t},\n\t{\n\t\tname: 'floor',\n\t\tlabel: 'Round Down',\n\t\tdescription: 'Round down to nearest integer',\n\t\taccepts: ['number'],\n\t\targs: []\n\t},\n\n\t// DATE\n\t{\n\t\tname: 'date',\n\t\tlabel: 'Format Date',\n\t\tdescription: 'Format date/time values',\n\t\taccepts: ['date', 'string'],\n\t\targs: [\n\t\t\t{\n\t\t\t\tname: 'Format',\n\t\t\t\ttype: 'select',\n\t\t\t\toptions: ['iso', 'date', 'time', 'datetime', 'short', 'long', 'full', 'relative', 'yyyy-MM-dd', 'MM/dd/yyyy', 'dd.MM.yyyy', 'MMM do, yyyy'],\n\t\t\t\tdefault: 'date'\n\t\t\t}\n\t\t]\n\t},\n\n\t// PATH\n\t{\n\t\tname: 'basename',\n\t\tlabel: 'File Name',\n\t\tdescription: 'Extract filename from path (file.jpg)',\n\t\taccepts: ['string'],\n\t\targs: []\n\t},\n\t{\n\t\tname: 'extension',\n\t\tlabel: 'File Extension',\n\t\tdescription: 'Get file extension (.jpg)',\n\t\taccepts: ['string'],\n\t\targs: []\n\t},\n\t{\n\t\tname: 'dirname',\n\t\tlabel: 'Directory Path',\n\t\tdescription: 'Get directory portion of path',\n\t\taccepts: ['string'],\n\t\targs: []\n\t},\n\n\t// LOGIC\n\t{\n\t\tname: 'default',\n\t\tlabel: 'Default Value',\n\t\tdescription: 'Use fallback if field is empty',\n\t\taccepts: ['any', 'string', 'number', 'date'],\n\t\targs: [{ name: 'Fallback', type: 'text', default: 'N/A' }]\n\t},\n\t{\n\t\tname: 'if',\n\t\tlabel: 'Conditional',\n\t\tdescription: 'Show different text based on condition',\n\t\taccepts: ['any'],\n\t\targs: [\n\t\t\t{ name: 'If True', type: 'text', default: 'Yes' },\n\t\t\t{ name: 'If False', type: 'text', default: 'No' }\n\t\t]\n\t}\n];\n","/**\n * @file src/services/token/engine.ts\n * @description Enhanced token engine with comprehensive descriptions and cross-collection support\n *\n * Features:\n * - Token Registry\n * - Token Resolution\n * - Token Caching\n * - Token Modifiers\n * - Token Permissions\n * - Token Validation\n * - Token Escaping\n * - Token Replacement\n */\nimport type { TokenContext, TokenDefinition, TokenRegistryConfig, TokenReplaceOptions, TokenCategory } from './types';\nimport type { Schema } from '@cms-types/content';\nimport type { User } from '@shared/database/auth/types';\nimport { modifierRegistry } from './modifiers';\nimport { logger } from '@shared/utils/logger';\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\n\n// import { resolveRelationToken } from './relationResolver';\n\nconst ALLOWED_USER_FIELDS = ['_id', 'email', 'username', 'role', 'avatar', 'language', 'name'];\n\nclass TokenRegistryService {\n\tprivate resolvers = new Map<string, (ctx: TokenContext) => any>();\n\tprivate cache = new Map<string, { timestamp: number; data: Record<TokenCategory, TokenDefinition[]> }>();\n\tprivate CACHE_TTL = 1000 * 60 * 5; // 5 minutes\n\tprivate relationTokenGenerator: ((schema: Schema, user: User | undefined, tenantId?: string, roles?: any[]) => Promise<TokenDefinition[]>) | null =\n\t\tnull;\n\tprivate relationResolver: ((token: string, ctx: TokenContext, user?: User, tenantId?: string) => Promise<any>) | null = null;\n\n\tpublic setRelationTokenGenerator(\n\t\tgenerator: (schema: Schema, user: User | undefined, tenantId?: string, roles?: any[]) => Promise<TokenDefinition[]>\n\t) {\n\t\tthis.relationTokenGenerator = generator;\n\t}\n\n\tpublic setRelationResolver(resolver: (token: string, ctx: TokenContext, user?: User, tenantId?: string) => Promise<any>) {\n\t\tthis.relationResolver = resolver;\n\t}\n\n\tasync resolve(tokenKey: string, ctx: TokenContext): Promise<any> {\n\t\tconst resolver = this.resolvers.get(tokenKey);\n\t\tif (resolver) return resolver(ctx);\n\n\t\t// Security check for user fields\n\t\tif (tokenKey.startsWith('user.')) {\n\t\t\tconst field = tokenKey.split('.')[1];\n\t\t\tif (!ALLOWED_USER_FIELDS.includes(field)) return '';\n\t\t}\n\n\t\t// Try relation resolver for deep entry tokens\n\t\tif (tokenKey.startsWith('entry.') && tokenKey.split('.').length > 2) {\n\t\t\ttry {\n\t\t\t\tif (this.relationResolver) {\n\t\t\t\t\tconst val = await this.relationResolver(tokenKey, ctx, ctx.user, ctx.tenantId);\n\t\t\t\t\tif (val !== null) return val;\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tlogger.error(`Failed to resolve relation token ${tokenKey}:`, e);\n\t\t\t}\n\t\t}\n\n\t\treturn tokenKey.split('.').reduce((curr: any, key) => curr?.[key], ctx);\n\t}\n\n\tclearCache() {\n\t\tthis.resolvers.clear();\n\t\tthis.cache.clear();\n\t}\n\n\tgetTokens(schema?: Schema, user?: User, config: TokenRegistryConfig = {}): Record<TokenCategory, TokenDefinition[]> {\n\t\tconst role = user?.role || 'public';\n\t\tconst collection = schema?.name || 'global';\n\t\tconst locale = config.locale || 'en';\n\t\tconst key = `${role}:${collection}:${locale}`;\n\n\t\tconst cached = this.cache.get(key);\n\t\tif (cached && Date.now() - cached.timestamp < this.CACHE_TTL) {\n\t\t\treturn cached.data;\n\t\t}\n\n\t\tconst tokens: TokenDefinition[] = [];\n\t\tconst add = (t: TokenDefinition) => {\n\t\t\ttokens.push(t);\n\t\t\tthis.resolvers.set(t.token, t.resolve);\n\t\t};\n\n\t\t// 1. ENHANCED SYSTEM TOKENS\n\t\tif (config.includeSystem !== false) {\n\t\t\tadd({\n\t\t\t\ttoken: 'system.now',\n\t\t\t\tname: 'Current Date & Time',\n\t\t\t\tcategory: 'system',\n\t\t\t\ttype: 'date',\n\t\t\t\tdescription: 'Full ISO 8601 timestamp (e.g., 2025-11-24T14:30:00Z). Use with |date() modifier to format.',\n\t\t\t\texample: '{{system.now | date(\"MMM do, yyyy\")}}',\n\t\t\t\tresolve: () => new Date().toISOString()\n\t\t\t});\n\n\t\t\tadd({\n\t\t\t\ttoken: 'system.year',\n\t\t\t\tname: 'Current Year',\n\t\t\t\tcategory: 'system',\n\t\t\t\ttype: 'number',\n\t\t\t\tdescription: 'Four-digit year (e.g., 2025). Perfect for copyright notices.',\n\t\t\t\texample: 'Â© {{system.year}} Company Name',\n\t\t\t\tresolve: () => new Date().getFullYear()\n\t\t\t});\n\n\t\t\tadd({\n\t\t\t\ttoken: 'system.timestamp',\n\t\t\t\tname: 'Unix Timestamp',\n\t\t\t\tcategory: 'system',\n\t\t\t\ttype: 'number',\n\t\t\t\tdescription: 'Milliseconds since epoch. Useful for unique IDs or sorting.',\n\t\t\t\texample: '{{system.timestamp}}',\n\t\t\t\tresolve: () => Date.now()\n\t\t\t});\n\n\t\t\tadd({\n\t\t\t\ttoken: 'system.date',\n\t\t\t\tname: 'Current Date',\n\t\t\t\tcategory: 'system',\n\t\t\t\ttype: 'string',\n\t\t\t\tdescription: \"Today's date in YYYY-MM-DD format.\",\n\t\t\t\texample: '{{system.date}}',\n\t\t\t\tresolve: () => new Date().toISOString().split('T')[0]\n\t\t\t});\n\n\t\t\tadd({\n\t\t\t\ttoken: 'system.time',\n\t\t\t\tname: 'Current Time',\n\t\t\t\tcategory: 'system',\n\t\t\t\ttype: 'string',\n\t\t\t\tdescription: 'Current time in HH:MM:SS format (24-hour).',\n\t\t\t\texample: '{{system.time}}',\n\t\t\t\tresolve: () => new Date().toTimeString().split(' ')[0]\n\t\t\t});\n\n\t\t\t// Individual date components\n\t\t\t['month', 'day', 'hour', 'minute', 'second'].forEach((unit) => {\n\t\t\t\tadd({\n\t\t\t\t\ttoken: `system.${unit}`,\n\t\t\t\t\tname: `Current ${unit.charAt(0).toUpperCase() + unit.slice(1)}`,\n\t\t\t\t\tcategory: 'system',\n\t\t\t\t\ttype: 'number',\n\t\t\t\t\tdescription: `Current ${unit} value.`,\n\t\t\t\t\tresolve: () => (new Date() as any)[`get${unit === 'day' ? 'Date' : unit.charAt(0).toUpperCase() + unit.slice(1)}`]()\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\t// 2. ENHANCED USER TOKENS\n\t\tif (user && config.includeUser !== false) {\n\t\t\tconst userFieldDescriptions: Record<string, string> = {\n\t\t\t\t_id: 'Unique user identifier (UUID format)',\n\t\t\t\temail: \"User's email address\",\n\t\t\t\tusername: \"User's display name or handle\",\n\t\t\t\trole: \"User's permission level (admin, editor, viewer, etc.)\",\n\t\t\t\tavatar: \"URL to user's profile picture\",\n\t\t\t\tlanguage: \"User's preferred language code (e.g., en, de, fr)\",\n\t\t\t\tname: \"User's full name\"\n\t\t\t};\n\n\t\t\tALLOWED_USER_FIELDS.forEach((field) => {\n\t\t\t\tif (field in user) {\n\t\t\t\t\tadd({\n\t\t\t\t\t\ttoken: `user.${field}`,\n\t\t\t\t\t\tname: `User ${field.charAt(0).toUpperCase() + field.slice(1)}`,\n\t\t\t\t\t\tcategory: 'user',\n\t\t\t\t\t\ttype: field === '_id' || field === 'email' ? 'string' : 'string',\n\t\t\t\t\t\tdescription: userFieldDescriptions[field] || `User's ${field} field`,\n\t\t\t\t\t\texample: field === 'name' ? `Welcome back, {{user.name}}!` : `{{user.${field}}}`,\n\t\t\t\t\t\tresolve: (c) => c.user?.[field as keyof User]\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// 3. ENHANCED SITE TOKENS\n\t\tif (config.includeSite !== false && publicEnv) {\n\t\t\tconst siteDescriptions: Record<string, string> = {\n\t\t\t\tSITE_NAME: \"Your website's name (appears in titles and branding)\",\n\t\t\t\tHOST_PROD: 'Production URL (e.g., https://example.com)',\n\t\t\t\tDEFAULT_CONTENT_LANGUAGE: 'Default language for content',\n\t\t\t\tPKG_VERSION: 'Current CMS version number',\n\t\t\t\tMEDIA_FOLDER: 'Path to uploaded media files'\n\t\t\t};\n\n\t\t\tObject.entries(publicEnv).forEach(([key, val]) => {\n\t\t\t\tif (typeof val === 'string' || typeof val === 'number' || typeof val === 'boolean') {\n\t\t\t\t\tadd({\n\t\t\t\t\t\ttoken: `site.${key}`,\n\t\t\t\t\t\tname: key.replace(/_/g, ' ').replace(/\\b\\w/g, (c) => c.toUpperCase()),\n\t\t\t\t\t\tcategory: 'site',\n\t\t\t\t\t\ttype: typeof val as any,\n\t\t\t\t\t\tdescription: siteDescriptions[key] || `Site configuration: ${key}`,\n\t\t\t\t\t\texample: key === 'SITE_NAME' ? `{{entry.title}} | {{site.SITE_NAME}}` : `{{site.${key}}}`,\n\t\t\t\t\t\tresolve: () => publicEnv[key as keyof typeof publicEnv]\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// 4. ENHANCED ENTRY TOKENS (including Relations)\n\t\tif (schema?.fields && config.includeEntry !== false) {\n\t\t\t// Import relation token generator\n\t\t\t// Use injected relation token generator if available (Server-side only)\n\t\t\tif (this.relationTokenGenerator) {\n\t\t\t\tthis.relationTokenGenerator(schema, user, config.tenantId, config.roles as any[])\n\t\t\t\t\t.then((relationTokens: TokenDefinition[]) => {\n\t\t\t\t\t\trelationTokens.forEach((t) => add(t));\n\t\t\t\t\t})\n\t\t\t\t\t.catch((err: unknown) => logger.error('Failed to load relation tokens', err));\n\t\t\t}\n\n\t\t\tconst WIDGET_TYPE_MAP: Record<string, any> = {\n\t\t\t\t// Core\n\t\t\t\tCheckbox: 'boolean',\n\t\t\t\tDate: 'date',\n\t\t\t\tDateRange: 'any', // Object {start, end}\n\t\t\t\tGroup: 'any',\n\t\t\t\tInput: 'string',\n\t\t\t\tMediaUpload: 'any', // Array/Object\n\t\t\t\tMegaMenu: 'any',\n\t\t\t\tRadio: 'string',\n\t\t\t\tRelation: 'any',\n\t\t\t\tRichText: 'string',\n\t\t\t\t// Custom\n\t\t\t\tAddress: 'any',\n\t\t\t\tColorPicker: 'string',\n\t\t\t\tCurrency: 'number',\n\t\t\t\tEmail: 'string',\n\t\t\t\tNumber: 'number',\n\t\t\t\tPhoneNumber: 'string',\n\t\t\t\tRating: 'number',\n\t\t\t\tRemoteVideo: 'any',\n\t\t\t\tSeo: 'any'\n\t\t\t};\n\n\t\t\tschema.fields.forEach((field: any) => {\n\t\t\t\tconst name = field.db_fieldName || field.label;\n\t\t\t\tif (!name) return;\n\n\t\t\t\t// Infer type from widget\n\t\t\t\tconst widgetName = field.widget?.Name;\n\t\t\t\tconst type = WIDGET_TYPE_MAP[widgetName] || 'string';\n\n\t\t\t\t// Generate smart descriptions based on widget type\n\t\t\t\tlet description = field.helper || field.description || `Field: ${name}`;\n\t\t\t\tlet example = `{{entry.${name}}}`;\n\n\t\t\t\t// Widget-specific examples\n\t\t\t\tif (widgetName === 'RichText') {\n\t\t\t\t\texample = `{{entry.${name} | truncate(150)}}`;\n\t\t\t\t\tdescription += ' (HTML content - use truncate for previews)';\n\t\t\t\t} else if (widgetName === 'Date') {\n\t\t\t\t\texample = `{{entry.${name} | date(\"MMM do, yyyy\")}}`;\n\t\t\t\t\tdescription += ' (use date() modifier to format)';\n\t\t\t\t} else if (widgetName === 'MediaUpload') {\n\t\t\t\t\texample = `{{entry.${name}.url}}`;\n\t\t\t\t\tdescription += ' (access .url, .alt, .title properties)';\n\t\t\t\t} else if (widgetName === 'Number' || widgetName === 'Currency') {\n\t\t\t\t\texample = `{{entry.${name} | add(10)}}`;\n\t\t\t\t\tdescription += ' (supports math: add, subtract, multiply)';\n\t\t\t\t}\n\n\t\t\t\tadd({\n\t\t\t\t\ttoken: `entry.${name}`,\n\t\t\t\t\tname: field.label || name,\n\t\t\t\t\tcategory: 'entry',\n\t\t\t\t\ttype,\n\t\t\t\t\tdescription,\n\t\t\t\t\texample,\n\t\t\t\t\tresolve: (c) => {\n\t\t\t\t\t\tconst fieldData = c.entry?.[name];\n\t\t\t\t\t\t// If it's a widget object with a value property, extract it\n\t\t\t\t\t\tif (fieldData && typeof fieldData === 'object' && 'value' in fieldData) {\n\t\t\t\t\t\t\treturn fieldData.value;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn fieldData;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\t// Grouping\n\t\tconst grouped: Record<string, TokenDefinition[]> = {\n\t\t\tentry: [],\n\t\t\tuser: [],\n\t\t\tsite: [],\n\t\t\tsystem: [],\n\t\t\trecentlyUsed: []\n\t\t};\n\t\ttokens.forEach((t) => {\n\t\t\tif (!grouped[t.category]) grouped[t.category] = [];\n\t\t\tgrouped[t.category].push(t);\n\t\t});\n\n\t\t// Cache Result\n\t\tthis.cache.set(key, { timestamp: Date.now(), data: grouped as Record<TokenCategory, TokenDefinition[]> });\n\n\t\treturn grouped as Record<TokenCategory, TokenDefinition[]>;\n\t}\n}\n\nexport const TokenRegistry = new TokenRegistryService();\n\n// Regex and replaceTokens function remain the same...\nconst TOKEN_REGEX = /(?<!\\\\)\\{\\{([^}]+)\\}\\}/g;\n\nexport async function replaceTokens(template: string, context: TokenContext, options: TokenReplaceOptions = {}): Promise<string> {\n\tif (!template || !template.includes('{{')) return template.replace(/\\\\\\{\\{/g, '{{');\n\n\tconst { maxDepth = 10 } = options;\n\tlet result = template;\n\tlet depth = 0;\n\tlet hasMatches = true;\n\n\twhile (hasMatches && depth < maxDepth) {\n\t\thasMatches = false;\n\t\tconst matches = Array.from(result.matchAll(TOKEN_REGEX));\n\t\tif (matches.length === 0) break;\n\n\t\tconst replacements = await Promise.all(\n\t\t\tmatches.map(async (match) => {\n\t\t\t\t// match[1] is no longer the backslash due to lookbehind change, match[1] is the content\n\t\t\t\tconst content = match[1];\n\t\t\t\tconst [path, ...mods] = content.split('|').map((s) => s.trim());\n\t\t\t\tlet value = await Promise.resolve(TokenRegistry.resolve(path, context));\n\t\t\t\tif (value === undefined || value === null) {\n\t\t\t\t\tvalue = '';\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\tfor (const modStr of mods) {\n\t\t\t\t\t\t// Try parens: name(arg1, arg2)\n\t\t\t\t\t\tconst m = modStr.match(/^(\\w+)(?:\\((.*)\\))?$/);\n\t\t\t\t\t\tif (m) {\n\t\t\t\t\t\t\tconst name = m[1].toLowerCase();\n\t\t\t\t\t\t\tconst args = m[2] ? m[2].split(',').map((s) => s.trim().replace(/^['\"]|['\"]$/g, '')) : [];\n\t\t\t\t\t\t\tconst fn = modifierRegistry.get(name);\n\t\t\t\t\t\t\tif (fn) value = await fn(value as any, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tlogger.error(String(e));\n\t\t\t\t}\n\t\t\t\treturn { fullMatch: match[0], value: String(value), resolved: true };\n\t\t\t})\n\t\t);\n\n\t\tfor (const rep of replacements) {\n\t\t\tif (rep.resolved) {\n\t\t\t\tresult = result.replace(rep.fullMatch, rep.value);\n\t\t\t\thasMatches = true;\n\t\t\t}\n\t\t}\n\t\tdepth++;\n\t}\n\treturn result.replace(/\\\\\\{\\{/g, '{{');\n}\n"],"names":["key"],"mappings":"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"}