{"version":3,"file":"TelemetryService.js","sources":["../../../../../../shared/services/src/TelemetryService.ts"],"sourcesContent":["/*\n * @files shared/services/src/TelemetryService.ts\n * @description Telemetry Service\n *\n * ### Features\n * - Update Checks\n * - Admin/Guest Access\n * - Forward to telemetry.sveltycms.com\n *\n * ### Security\n * - Fail silently - telemetry should never break the app\n * - Uses Hashed Secret for Unique ID (Never sends raw secret)\n */\nimport { building, dev } from '$app/environment';\nimport { getPrivateEnv } from '@shared/database/db';\nimport { getPrivateSetting } from '@shared/services/settingsService';\nimport pkg from '@root/package.json' with { type: 'json' };\nimport { createHash } from 'node:crypto';\nimport { logger } from '@shared/utils/logger';\nimport os from 'node:os';\n\n// In-memory cache for update checks, backed by globalThis to survive HMR in dev\nconst globalWithCache = globalThis as typeof globalThis & {\n\t__SVELTY_TELEMETRY_CACHE__?: any;\n\t__SVELTY_TELEMETRY_LAST_CHECK__?: number;\n};\n\nlet cachedUpdateInfo: any = globalWithCache.__SVELTY_TELEMETRY_CACHE__ || null;\nlet lastCheckTime = globalWithCache.__SVELTY_TELEMETRY_LAST_CHECK__ || 0;\nconst CHECK_INTERVAL = 1000 * 60 * 60 * 12; // 12 hours\nlet activeCheckPromise: Promise<any> | null = null; // Deduping promise\n\nexport const telemetryService = {\n\tasync checkUpdateStatus() {\n\t\t// Disable telemetry in test mode (CI/CD) or during build\n\t\tif (typeof process !== 'undefined' && (process.env.TEST_MODE === 'true' || process.env.VITEST)) {\n\t\t\treturn { status: 'test_mode', latest: null, security_issue: false };\n\t\t}\n\n\t\tif (building) {\n\t\t\treturn { status: 'building', latest: null, security_issue: false };\n\t\t}\n\n\t\t// Check opt-out settings\n\t\tlet isTelemetryEnabled = true;\n\t\ttry {\n\t\t\tconst setting = await getPrivateSetting('SVELTYCMS_TELEMETRY');\n\t\t\tisTelemetryEnabled = setting !== false;\n\t\t} catch (err) {\n\t\t\tlogger.debug('[Telemetry] Could not check opt-out setting, defaulting to enabled', err);\n\t\t}\n\n\t\tif (!isTelemetryEnabled) {\n\t\t\tlogger.info('ðŸ“¡ Telemetry is disabled by configuration.');\n\t\t\treturn { status: 'disabled', latest: null, security_issue: false };\n\t\t}\n\n\t\tconst now = Date.now();\n\t\tif (cachedUpdateInfo && now - lastCheckTime < CHECK_INTERVAL && !dev) {\n\t\t\treturn cachedUpdateInfo;\n\t\t}\n\n\t\t// Return existing promise if a check is already running (deduplication)\n\t\tif (activeCheckPromise) {\n\t\t\tlogger.debug('[Telemetry] Reusing active check promise');\n\t\t\treturn activeCheckPromise;\n\t\t}\n\n\t\tlogger.info('ðŸ“¡ Starting Telemetry check (Background)...');\n\n\t\t// Start the check in a truly non-blocking way\n\t\tactiveCheckPromise = (async () => {\n\t\t\ttry {\n\t\t\t\t// 1. Calculate Installation ID (Specific to this config/secret)\n\t\t\t\tconst jwtSecret = (await getPrivateSetting('JWT_SECRET_KEY')) || 'fallback_secret';\n\t\t\t\tconst installationId = createHash('sha256').update(jwtSecret).digest('hex');\n\n\t\t\t\t// 2. Calculate Stable Machine ID (Survives fresh installs/config deletion)\n\t\t\t\t// We hash hardware traits that are stable for a given environment\n\t\t\t\tconst stableTraits = `${os.type()}-${os.arch()}-${os.totalmem()}-${os.cpus().length}-${os.cpus()[0]?.model || 'unknown'}`;\n\t\t\t\tconst stableId = createHash('sha256').update(stableTraits).digest('hex');\n\n\t\t\t\t// Real widget detection (Custom Only)\n\t\t\t\tlet widgets: string[] = [];\n\t\t\t\ttry {\n\t\t\t\t\tconst { widgetRegistryService } = await import('@shared/services/WidgetRegistryService');\n\t\t\t\t\twidgets = widgetRegistryService.getAllWidgets().size > 0 ? Array.from(widgetRegistryService.getAllWidgets().keys()) : [];\n\t\t\t\t} catch (err) {\n\t\t\t\t\tlogger.debug('[Telemetry] Failed to collect widget info:', err);\n\t\t\t\t}\n\n\t\t\t\t// Use direct env access for infrastructure config (more reliable than settings cache)\n\t\t\t\tconst privateEnv = getPrivateEnv();\n\t\t\t\tconst dbType = privateEnv?.DB_TYPE || (await getPrivateSetting('DB_TYPE')) || 'unknown';\n\n\t\t\t\t// Collect geolocation data\n\t\t\t\tlet location = {\n\t\t\t\t\tcountry: undefined as string | undefined,\n\t\t\t\t\tcountry_code: undefined as string | undefined,\n\t\t\t\t\tregion: undefined as string | undefined,\n\t\t\t\t\tcity: undefined as string | undefined,\n\t\t\t\t\tlatitude: undefined as number | undefined,\n\t\t\t\t\tlongitude: undefined as number | undefined,\n\t\t\t\t\tisp: undefined as string | undefined,\n\t\t\t\t\torg: undefined as string | undefined\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst geoRes = await fetch('http://ip-api.com/json/?fields=status,country,countryCode,region,regionName,city,lat,lon,isp,org', {\n\t\t\t\t\t\theaders: { 'User-Agent': `SveltyCMS/${pkg.version}` },\n\t\t\t\t\t\tsignal: AbortSignal.timeout(5000)\n\t\t\t\t\t});\n\n\t\t\t\t\tif (geoRes.ok) {\n\t\t\t\t\t\tconst geoData = await geoRes.json();\n\t\t\t\t\t\tif (geoData.status === 'success') {\n\t\t\t\t\t\t\tlocation = {\n\t\t\t\t\t\t\t\tcountry: geoData.country,\n\t\t\t\t\t\t\t\tcountry_code: geoData.countryCode,\n\t\t\t\t\t\t\t\tregion: geoData.regionName || geoData.region,\n\t\t\t\t\t\t\t\tcity: geoData.city,\n\t\t\t\t\t\t\t\tlatitude: geoData.lat,\n\t\t\t\t\t\t\t\tlongitude: geoData.lon,\n\t\t\t\t\t\t\t\tisp: geoData.isp,\n\t\t\t\t\t\t\t\torg: geoData.org\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tlogger.debug('[Telemetry] Could not resolve location:', e);\n\t\t\t\t}\n\n\t\t\t\t// Metrics\n\t\t\t\tlet userCount = 0;\n\t\t\t\tlet collectionCount = 0;\n\t\t\t\tlet roleCount = 0;\n\n\t\t\t\ttry {\n\t\t\t\t\tconst { dbAdapter } = await import('@shared/database/db');\n\t\t\t\t\tif (dbAdapter && dbAdapter.auth) {\n\t\t\t\t\t\tconst userCountResult = await dbAdapter.auth.getUserCount();\n\t\t\t\t\t\tif (userCountResult.success) userCount = userCountResult.data;\n\t\t\t\t\t\troleCount = (await dbAdapter.auth.getAllRoles()).length;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { configService } = await import('@shared/services/ConfigService');\n\t\t\t\t\tconst contentManager = configService.getContentManager();\n\t\t\t\t\tif (contentManager) {\n\t\t\t\t\t\tconst collections = await contentManager.getCollections();\n\t\t\t\t\t\tcollectionCount = collections.length;\n\t\t\t\t\t}\n\t\t\t\t} catch (err) {\n\t\t\t\t\tlogger.debug('[Telemetry] Metrics collection failed:', err);\n\t\t\t\t}\n\n\t\t\t\t// System Info\n\t\t\t\tconst cpus = os.cpus();\n\t\t\t\tconst systemInfo = {\n\t\t\t\t\tcpu_count: cpus.length,\n\t\t\t\t\tcpu_model: cpus.length > 0 ? cpus[0].model : 'unknown',\n\t\t\t\t\ttotal_memory_gb: Math.round(os.totalmem() / 1024 / 1024 / 1024),\n\t\t\t\t\tos_type: os.type(),\n\t\t\t\t\tos_release: os.release(),\n\t\t\t\t\tos_arch: os.arch()\n\t\t\t\t};\n\n\t\t\t\tconst environment = process.env.NODE_ENV || (dev ? 'development' : 'production');\n\t\t\t\tconst timestamp = Date.now();\n\n\t\t\t\t// 3. Generate HMAC Signature (Identifies this request as an authentic SveltyCMS instance)\n\t\t\t\tconst TELEMETRY_SALT = 'sveltycms-telemetry';\n\t\t\t\tconst cryptoSignature = (await import('node:crypto'))\n\t\t\t\t\t.createHmac('sha256', TELEMETRY_SALT)\n\t\t\t\t\t.update(`${installationId}:${pkg.version}:${timestamp}`)\n\t\t\t\t\t.digest('hex');\n\n\t\t\t\tconst payload = {\n\t\t\t\t\tcurrent_version: pkg.version, // âœ… Required\n\t\t\t\t\tnode_version: process.version, // âœ… Required\n\t\t\t\t\tenvironment, // âœ… Required\n\t\t\t\t\tos: os.type(), // âœ… Required\n\t\t\t\t\tinstallation_id: installationId, // âœ… Required for auth\n\t\t\t\t\ttimestamp, // âœ… Required for auth\n\t\t\t\t\tsignature: cryptoSignature, // âœ… Required for auth\n\t\t\t\t\tis_ephemeral: environment === 'development' || environment === 'test', // Optional\n\t\t\t\t\tstable_id: stableId, // Optional\n\t\t\t\t\tdb_type: dbType, // Optional\n\t\t\t\t\tlocation: Object.values(location).some((v) => v !== undefined) ? location : undefined, // Optional\n\t\t\t\t\tusage_metrics: { users: userCount, collections: collectionCount, roles: roleCount }, // Optional\n\t\t\t\t\tsystem_info: systemInfo, // Optional\n\t\t\t\t\twidgets // Optional\n\t\t\t\t};\n\n\t\t\t\tconst telemetryEndpoint = process.env.TELEMETRY_ENDPOINT || 'https://telemetry.sveltycms.com/api/check-update';\n\t\t\t\tconst response = await fetch(telemetryEndpoint, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t\t\t'User-Agent': 'SveltyCMS-Telemetry/1.0'\n\t\t\t\t\t},\n\t\t\t\t\tbody: JSON.stringify(payload),\n\t\t\t\t\tsignal: AbortSignal.timeout(10000)\n\t\t\t\t});\n\n\t\t\t\tif (response.status === 429) {\n\t\t\t\t\tcachedUpdateInfo = { status: 'rate_limited', latest: pkg.version, security_issue: false };\n\t\t\t\t} else if (!response.ok) {\n\t\t\t\t\tthrow new Error(`Update server unreachable: ${response.status}`);\n\t\t\t\t} else {\n\t\t\t\t\tconst data = await response.json();\n\t\t\t\t\tcachedUpdateInfo = {\n\t\t\t\t\t\tstatus: 'active',\n\t\t\t\t\t\tlatest: data.latest_version,\n\t\t\t\t\t\tsecurity_issue: data.has_vulnerability,\n\t\t\t\t\t\tmessage: data.message,\n\t\t\t\t\t\ttelemetry_id: data.telemetry_id\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tlastCheckTime = Date.now();\n\t\t\t\tglobalWithCache.__SVELTY_TELEMETRY_CACHE__ = cachedUpdateInfo;\n\t\t\t\tglobalWithCache.__SVELTY_TELEMETRY_LAST_CHECK__ = lastCheckTime;\n\n\t\t\t\treturn cachedUpdateInfo;\n\t\t\t} catch (err) {\n\t\t\t\tlogger.warn('[Telemetry] Check failed:', err instanceof Error ? err.message : String(err));\n\t\t\t\tlastCheckTime = Date.now();\n\t\t\t\tcachedUpdateInfo = { status: 'error', latest: pkg.version, security_issue: false };\n\t\t\t\tglobalWithCache.__SVELTY_TELEMETRY_CACHE__ = cachedUpdateInfo;\n\t\t\t\tglobalWithCache.__SVELTY_TELEMETRY_LAST_CHECK__ = lastCheckTime;\n\t\t\t\treturn cachedUpdateInfo;\n\t\t\t} finally {\n\t\t\t\tactiveCheckPromise = null;\n\t\t\t}\n\t\t})();\n\n\t\treturn activeCheckPromise;\n\t}\n};\n"],"names":[],"mappings":"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"}