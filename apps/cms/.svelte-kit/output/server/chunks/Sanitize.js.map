{"version":3,"file":"Sanitize.js","sources":["../../../../../../shared/utils/src/Sanitize.svelte"],"sourcesContent":["<script lang=\"ts\">\n\t/**\n\t * Sanitize Component\n\t *\n\t * **Purpose:** Secure wrapper for rendering HTML content (@html) with XSS protection.\n\t *\n\t * **Security:**\n\t * - Uses DOMPurify to sanitize HTML before rendering\n\t * - Removes dangerous tags (script, iframe, embed, object)\n\t * - Strips event handlers (onclick, onerror, etc.)\n\t * - Validates URLs in href/src attributes\n\t * - Configurable sanitization profiles\n\t *\n\t * **Usage:**\n\t * <Sanitize html={userGeneratedContent} />\n\t * <Sanitize html={richTextContent} profile=\"rich-text\" />\n\t *\n\t * @component\n\t */\n\n\timport { onMount } from 'svelte';\n\n\ttype SanitizeProfile = 'default' | 'rich-text' | 'strict';\n\n\tinterface Props {\n\t\t/** HTML content to sanitize and render */\n\t\thtml: string;\n\t\t/** Sanitization profile - controls allowed tags/attributes */\n\t\tprofile?: SanitizeProfile;\n\t\t/** Custom CSS class for wrapper element */\n\t\tclass?: string;\n\t}\n\n\tlet { html, profile = 'default', class: className }: Props = $props();\n\n\tlet DOMPurify: any;\n\tlet sanitized = $state('');\n\n\t// Sanitization profiles\n\tconst PROFILES: Record<SanitizeProfile, any> = {\n\t\tdefault: {\n\t\t\tALLOWED_TAGS: [\n\t\t\t\t'p',\n\t\t\t\t'br',\n\t\t\t\t'strong',\n\t\t\t\t'em',\n\t\t\t\t'u',\n\t\t\t\t's',\n\t\t\t\t'a',\n\t\t\t\t'ul',\n\t\t\t\t'ol',\n\t\t\t\t'li',\n\t\t\t\t'blockquote',\n\t\t\t\t'code',\n\t\t\t\t'pre',\n\t\t\t\t'h1',\n\t\t\t\t'h2',\n\t\t\t\t'h3',\n\t\t\t\t'h4',\n\t\t\t\t'h5',\n\t\t\t\t'h6',\n\t\t\t\t'img',\n\t\t\t\t'span',\n\t\t\t\t'div'\n\t\t\t],\n\t\t\tALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'target', 'rel'],\n\t\t\tALLOW_DATA_ATTR: false\n\t\t},\n\t\t'rich-text': {\n\t\t\tALLOWED_TAGS: [\n\t\t\t\t'p',\n\t\t\t\t'br',\n\t\t\t\t'strong',\n\t\t\t\t'em',\n\t\t\t\t'u',\n\t\t\t\t's',\n\t\t\t\t'a',\n\t\t\t\t'ul',\n\t\t\t\t'ol',\n\t\t\t\t'li',\n\t\t\t\t'blockquote',\n\t\t\t\t'code',\n\t\t\t\t'pre',\n\t\t\t\t'h1',\n\t\t\t\t'h2',\n\t\t\t\t'h3',\n\t\t\t\t'h4',\n\t\t\t\t'h5',\n\t\t\t\t'h6',\n\t\t\t\t'img',\n\t\t\t\t'span',\n\t\t\t\t'div',\n\t\t\t\t'table',\n\t\t\t\t'thead',\n\t\t\t\t'tbody',\n\t\t\t\t'tr',\n\t\t\t\t'th',\n\t\t\t\t'td',\n\t\t\t\t'hr',\n\t\t\t\t'sub',\n\t\t\t\t'sup',\n\t\t\t\t'mark',\n\t\t\t\t'abbr',\n\t\t\t\t'cite',\n\t\t\t\t'q',\n\t\t\t\t'del',\n\t\t\t\t'ins'\n\t\t\t],\n\t\t\tALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'target', 'rel', 'width', 'height', 'align', 'colspan', 'rowspan'],\n\t\t\tALLOW_DATA_ATTR: true\n\t\t},\n\t\tstrict: {\n\t\t\tALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'a'],\n\t\t\tALLOWED_ATTR: ['href', 'title', 'rel'],\n\t\t\tALLOW_DATA_ATTR: false\n\t\t}\n\t};\n\n\tonMount(async () => {\n\t\t// Dynamically import DOMPurify (client-side only)\n\t\tconst module = await import('isomorphic-dompurify');\n\t\tDOMPurify = module.default;\n\n\t\t// Sanitize HTML\n\t\tsanitizeHtml();\n\t});\n\n\tfunction sanitizeHtml() {\n\t\tif (!DOMPurify || !html) {\n\t\t\tsanitized = '';\n\t\t\treturn;\n\t\t}\n\n\t\tconst config = PROFILES[profile];\n\n\t\t// Add URL validation hook\n\t\tDOMPurify.addHook('afterSanitizeAttributes', (node: any) => {\n\t\t\t// Validate links\n\t\t\tif (node.tagName === 'A' && node.hasAttribute('href')) {\n\t\t\t\tconst href = node.getAttribute('href');\n\t\t\t\t// Only allow http(s), mailto, and relative URLs\n\t\t\t\tif (href && !href.match(/^(https?:|mailto:|\\/|#)/) && !href.startsWith('data:')) {\n\t\t\t\t\tnode.removeAttribute('href');\n\t\t\t\t}\n\t\t\t\t// Add rel=\"noopener noreferrer\" to external links\n\t\t\t\tif (href && href.match(/^https?:/)) {\n\t\t\t\t\tnode.setAttribute('rel', 'noopener noreferrer');\n\t\t\t\t\t// Only allow target=\"_blank\" for external links\n\t\t\t\t\tif (node.getAttribute('target') !== '_blank') {\n\t\t\t\t\t\tnode.removeAttribute('target');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Validate images\n\t\t\tif (node.tagName === 'IMG' && node.hasAttribute('src')) {\n\t\t\t\tconst src = node.getAttribute('src');\n\t\t\t\t// Only allow http(s), data URLs, and relative URLs\n\t\t\t\tif (src && !src.match(/^(https?:|data:|\\/)/)) {\n\t\t\t\t\tnode.removeAttribute('src');\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsanitized = DOMPurify.sanitize(html, config);\n\t}\n\n\t// Re-sanitize when html or profile changes\n\t$effect(() => {\n\t\tif (DOMPurify) {\n\t\t\tsanitizeHtml();\n\t\t}\n\t});\n</script>\n\n<!-- Render sanitized HTML -->\n{#if sanitized}\n\t<div class={className} data-sanitized>\n\t\t{@html sanitized}\n\t</div>\n{:else}\n\t<!-- Loading state while DOMPurify loads -->\n\t<div class={className} data-sanitize-loading>\n\t\t<!-- You can customize this loading state -->\n\t</div>\n{/if}\n\n<!--\n**Migration Guide:**\n\nReplace raw @html with Sanitize component:\n\n**Before:**\n```svelte\n{@html userContent}\n```\n\n**After:**\n```svelte\n<script>\n  import Sanitize from '@shared/utils/Sanitize.svelte';\n</script>\n\n<Sanitize html={userContent} />\n```\n\n**Profile Examples:**\n- `default`: Basic HTML (paragraphs, lists, links, images)\n- `rich-text`: Full rich text editor output (tables, headings, formatting)\n- `strict`: Minimal formatting only (bold, italic, links)\n\n**Custom Styling:**\n```svelte\n<Sanitize html={content} class=\"prose dark:prose-invert\" />\n```\n\n**Benefits:**\n- XSS attack prevention\n- URL validation for links and images\n- Automatic rel=\"noopener noreferrer\" for external links\n- Configurable sanitization levels\n- SSR-safe (DOMPurify loaded only on client)\n-->\n\n<style>\n\t/* Base styles for sanitized content */\n\t[data-sanitized] {\n\t\t/* Reset potentially dangerous CSS properties */\n\t\tposition: relative;\n\t\toverflow: visible;\n\t}\n\n\t/* Prevent layout-breaking images */\n\t[data-sanitized] :global(img) {\n\t\tmax-width: 100%;\n\t\theight: auto;\n\t}\n\n\t/* Loading state (invisible by default) */\n\t[data-sanitize-loading] {\n\t\tmin-height: 1em;\n\t}\n</style>\n"],"names":["html"],"mappings":";;wCAAA;AAiCO,QAAA,EAAA,MAAAA,QAAM,UAAU,WAAW,OAAO,UAAS,IAAA;;;8CAqJrC,SAAS,GAAA,eAAA,CAAA,kCAAA;AAAA;;EATd,CAAA;;"}