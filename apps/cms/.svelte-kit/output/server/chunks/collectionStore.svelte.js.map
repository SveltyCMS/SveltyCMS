{"version":3,"file":"collectionStore.svelte.js","sources":["../../../../../../shared/stores/src/collectionStore.svelte.ts"],"sourcesContent":["import type { Schema, ContentNode } from '@cms-types/content';\nimport { logger } from '@shared/utils/logger';\n\n// Types\nexport type ModeType = 'view' | 'edit' | 'create' | 'delete' | 'modify' | 'media';\n\nexport interface Widget {\n\tpermissions: Record<string, Record<string, boolean>>;\n\t[key: string]: Record<string, Record<string, boolean>> | unknown;\n}\n\nexport const statusMap = {\n\tpublish: 'publish',\n\tunpublish: 'unpublish',\n\tdraft: 'draft',\n\tarchived: 'archived'\n} as const;\n\n/**\n * Enterprise-level Collection Management State\n * Consolidates all collection-related reactivity into a single class.\n */\nclass CollectionState {\n\t// Record of all collections indexed by UUID\n\tall = $state<Record<string, Schema>>({});\n\n\t// Active collection being viewed or edited\n\tactive = $state<Schema | null>(null);\n\n\t// Data value of the currently active entry (e.g. form data)\n\tactiveValue = $state<Record<string, unknown>>({});\n\n\t// Operational mode (view, edit, etc.)\n\tmode = $state<ModeType>('view');\n\n\tloading = $state(false);\n\terror = $state<string | null>(null);\n\n\t// Miscellaneous state\n\tcurrentId = $state<string | null>(null);\n\tunassigned = $state<Schema>({} as Schema);\n\tmodifyEntry = $state<(status?: keyof typeof statusMap) => Promise<void>>(() => Promise.resolve());\n\ttargetWidget = $state<Widget>({ permissions: {} });\n\tcontentStructure = $state<ContentNode[]>([]);\n\tselectedEntries = $state<string[]>([]);\n\n\t// --- Derived Properties ---\n\n\tget total() {\n\t\treturn Object.keys(this.all).length;\n\t}\n\n\tget hasSelected() {\n\t\treturn this.selectedEntries.length > 0;\n\t}\n\n\tget activeName() {\n\t\treturn this.active?.name;\n\t}\n\n\t// --- Actions ---\n\n\tsetCollection(newCollection: Schema | null) {\n\t\tthis.active = newCollection;\n\t}\n\n\tsetMode(newMode: ModeType) {\n\t\tlogger.debug(`CollectionState: mode changed from ${this.mode} to ${newMode}`);\n\t\tthis.mode = newMode;\n\t}\n\n\tsetCollectionValue(newValue: Record<string, unknown>) {\n\t\tthis.activeValue = newValue;\n\t\t// Business logic: ensure status is set if not present\n\t\tif (this.activeValue && !('status' in this.activeValue)) {\n\t\t\tthis.activeValue.status = this.active?.status ?? 'unpublish';\n\t\t}\n\t}\n\n\tsetModifyEntry(newFn: (status?: keyof typeof statusMap) => Promise<void>) {\n\t\tthis.modifyEntry = newFn;\n\t}\n\n\tsetContentStructure(newContentStructure: ContentNode[]) {\n\t\tthis.contentStructure = newContentStructure;\n\t}\n\n\tsetTargetWidget(newWidget: Widget) {\n\t\tthis.targetWidget = newWidget;\n\t}\n\n\t// Entry selection management\n\taddEntry(entryId: string) {\n\t\tif (!this.selectedEntries.includes(entryId)) {\n\t\t\tthis.selectedEntries.push(entryId);\n\t\t}\n\t}\n\n\tremoveEntry(entryId: string) {\n\t\tconst index = this.selectedEntries.indexOf(entryId);\n\t\tif (index > -1) {\n\t\t\tthis.selectedEntries.splice(index, 1);\n\t\t}\n\t}\n\n\tclearSelected() {\n\t\tthis.selectedEntries.length = 0;\n\t}\n\n\t// Legacy compatibility getters/setters for smooth migration\n\tget current() {\n\t\treturn this.active;\n\t}\n\tset current(v) {\n\t\tthis.active = v;\n\t}\n}\n\n// Singleton instances\nexport const collections = new CollectionState();\n\n/**\n * BACKWARD COMPATIBILITY LAYER\n * These exports are maintained to prevent immediate breakage.\n * TODO: Migrate all consumers to use the 'collections' singleton.\n */\n\n// Legacy 'collections' was a record. We bridge it to collections.all\n// This is tricky because it was a direct export of a $state object.\n// We'll provide a Proxy or just keep the old collections record for now if needed,\n// but let's try to migrate.\n\n// Actually, let's keep the discrete exports for now but wire them to the singleton.\n\nexport const collection = {\n\tget value() {\n\t\treturn collections.active;\n\t},\n\tset value(v) {\n\t\tcollections.active = v;\n\t}\n};\n\nexport const collectionValue = {\n\tget value() {\n\t\treturn collections.activeValue;\n\t},\n\tset value(v) {\n\t\tcollections.setCollectionValue(v);\n\t}\n};\n\nexport const mode = {\n\tget value() {\n\t\treturn collections.mode;\n\t},\n\tset value(v) {\n\t\tcollections.setMode(v);\n\t}\n};\n\nexport const contentStructure = {\n\tget value() {\n\t\treturn collections.contentStructure;\n\t},\n\tset value(v) {\n\t\tcollections.contentStructure = v;\n\t}\n};\n\nexport const modifyEntry = {\n\tget value() {\n\t\treturn collections.modifyEntry;\n\t},\n\tset value(v) {\n\t\tcollections.modifyEntry = v;\n\t}\n};\n\nexport const targetWidget = {\n\tget value() {\n\t\treturn collections.targetWidget;\n\t},\n\tset value(v) {\n\t\tcollections.targetWidget = v;\n\t}\n};\n\n// Action functions\nexport const setCollection = (v: Schema | null) => collections.setCollection(v);\nexport const setMode = (v: ModeType) => collections.setMode(v);\nexport const setCollectionValue = (v: Record<string, unknown>) => collections.setCollectionValue(v);\nexport const setModifyEntry = (v: (status?: keyof typeof statusMap) => Promise<void>) => collections.setModifyEntry(v);\nexport const setContentStructure = (v: ContentNode[]) => collections.setContentStructure(v);\nexport const setTargetWidget = (v: Widget) => collections.setTargetWidget(v);\n\n// Legacy derived/utility functions\nexport const getTotalCollections = () => collections.total;\nexport const getHasSelectedEntries = () => collections.hasSelected;\nexport const getCurrentCollectionName = () => collections.activeName;\n\nexport const entryActions = {\n\taddEntry: (id: string) => collections.addEntry(id),\n\tremoveEntry: (id: string) => collections.removeEntry(id),\n\tclear: () => collections.clearSelected()\n};\n\n// Direct state exports for legacy components that don't use the objects\n// Note: These might lose reactivity if rebound elsewhere, but should work for direct imports.\nexport const currentCollectionId = collections.currentId;\nexport const collectionsLoading = collections.loading;\nexport const collectionsError = collections.error;\nexport const unAssigned = collections.unassigned;\nexport const selectedEntries = collections.selectedEntries;\n"],"names":[],"mappings":";;AAsBM,MAAA,gBAAgB;AAAA;AAAA,EAErB,MAAA,CAAA;AAAA;AAAA,EAGA,SAA+B;AAAA;AAAA,EAG/B,cAAA,CAAA;AAAA;AAAA,EAGA,OAAwB;AAAA,EAExB,UAAiB;AAAA,EACjB,QAA8B;AAAA;AAAA,EAG9B,YAAkC;AAAA,EAClC,aAAA,CAAA;AAAA,EACA,cAAA,MAA+E,QAAQ;EACvF,iBAAgC,aAAA,GAAA;AAAA,EAChC,mBAAA,CAAA;AAAA,EACA,kBAAA,CAAA;AAAA;AAAA,EAII,IAAA,QAAQ;AACJ,WAAA,OAAO,KAAK,KAAK,GAAG,EAAE;AAAA,EAC9B;AAAA,EAEI,IAAA,cAAc;AACV,WAAA,KAAK,gBAAgB,SAAS;AAAA,EACtC;AAAA,EAEI,IAAA,aAAa;WACT,KAAK,QAAQ;AAAA,EACrB;AAAA;AAAA,EAIA,cAAc,eAA8B;AAC3C,SAAK,SAAS;AAAA,EACf;AAAA,EAEA,QAAQ,SAAmB;AAC1B,WAAO,4CAA4C,KAAK,IAAI,OAAO,OAAO,EAAA;AAC1E,SAAK,OAAO;AAAA,EACb;AAAA,EAEA,mBAAmB,UAAmC;AACrD,SAAK,cAAc;QAEf,KAAK,eAAA,EAAiB,YAAY,KAAK,cAAc;AACxD,WAAK,YAAY,SAAS,KAAK,QAAQ,UAAU;AAAA,IAClD;AAAA,EACD;AAAA,EAEA,eAAe,OAA2D;AACzE,SAAK,cAAc;AAAA,EACpB;AAAA,EAEA,oBAAoB,qBAAoC;AACvD,SAAK,mBAAmB;AAAA,EACzB;AAAA,EAEA,gBAAgB,WAAmB;AAClC,SAAK,eAAe;AAAA,EACrB;AAAA;AAAA,EAGA,SAAS,SAAiB;AACpB,QAAA,CAAA,KAAK,gBAAgB,SAAS,OAAO,GAAG;AAC5C,WAAK,gBAAgB,KAAK,OAAO;AAAA,IAClC;AAAA,EACD;AAAA,EAEA,YAAY,SAAiB;AACtB,UAAA,QAAQ,KAAK,gBAAgB,QAAQ,OAAO;QAC9C,YAAY;AACf,WAAK,gBAAgB,OAAO,OAAO,CAAC;AAAA,IACrC;AAAA,EACD;AAAA,EAEA,gBAAgB;AACf,SAAK,gBAAgB,SAAS;AAAA,EAC/B;AAAA;AAAA,EAGI,IAAA,UAAU;AACN,WAAA,KAAK;AAAA,EACb;AAAA,MACI,QAAQ,GAAG;AACd,SAAK,SAAS;AAAA,EACf;AACD;AAGa,MAAA,kBAAkB,gBAAA;MAelB,aAAA;AAAA,EACR,IAAA,QAAQ;AACJ,WAAA,YAAY;AAAA,EACpB;AAAA,MACI,MAAM,GAAG;AACZ,gBAAY,SAAS;AAAA,EACtB;;MAGY,kBAAA;AAAA,EACR,IAAA,QAAQ;AACJ,WAAA,YAAY;AAAA,EACpB;AAAA,MACI,MAAM,GAAG;AACZ,gBAAY,mBAAmB,CAAC;AAAA,EACjC;;MAGY,OAAA;AAAA,EACR,IAAA,QAAQ;AACJ,WAAA,YAAY;AAAA,EACpB;AAAA,MACI,MAAM,GAAG;AACZ,gBAAY,QAAQ,CAAC;AAAA,EACtB;;MAGY,mBAAA;AAAA,EACR,IAAA,QAAQ;AACJ,WAAA,YAAY;AAAA,EACpB;AAAA,MACI,MAAM,GAAG;AACZ,gBAAY,mBAAmB;AAAA,EAChC;;AAsBY,MAAA,iBAAiB,MAAqB,YAAY,cAAc,CAAC;AACjE,MAAA,WAAW,MAAgB,YAAY,QAAQ,CAAC;AAChD,MAAA,sBAAsB,MAA+B,YAAY,mBAAmB,CAAC;AACrF,MAAA,kBAAkB,MAA0D,YAAY,eAAe,CAAC;AAiBlF,YAAY;AACb,YAAY;AACd,YAAY;MAC/B,aAAa,YAAY;AACP,YAAY;"}