{"version":3,"file":"globalSettings.svelte.js","sources":["../../../../../../shared/stores/src/globalSettings.svelte.ts"],"sourcesContent":["/**\n * @file src/stores/globalSettings.svelte.ts\n * @description Global Settings Store for PUBLIC ONLY\n *\n * ðŸ”’ SECURITY: This file only contains PUBLIC settings safe for client-side use.\n * Private settings (DB passwords, API keys, etc.) are NEVER exposed here.\n * They remain server-only in src/services/settingsService.ts\n *\n * ### Features\n * - Reactive PUBLIC settings using Svelte 5 $state/$derived runes\n * - Automatic UI updates when settings change\n * - Populated by root layout load function\n * - Type-safe access to public configuration\n */\n\nimport { browser } from '$app/environment';\nimport { publicConfigSchema } from '@shared/database/schemas';\nimport { type InferOutput } from 'valibot';\n\n// Universal Logger (safe for client and server)\nimport { logger } from '@shared/utils/logger';\n\ntype PublicEnv = InferOutput<typeof publicConfigSchema> & { PKG_VERSION?: string };\n\n/**\n * The reactive state for all public environment settings.\n * Initialized empty and populated by initPublicEnv() from layout load.\n */\nconst state = $state<PublicEnv>({} as PublicEnv);\nlet eventSource: EventSource | null = null;\n\n/**\n * Check if settings have been loaded on the client.\n * Returns a reactive value using $derived internally.\n */\nexport function isInitialized(): boolean {\n\treturn Object.keys(state).length > 0;\n}\n\n// Fetches the latest public settings from the server\nasync function fetchPublicSettings() {\n\ttry {\n\t\tconst response = await fetch('/api/settings/public');\n\t\tif (response.ok) {\n\t\t\tconst data = await response.json();\n\t\t\tObject.assign(state, data);\n\t\t}\n\t} catch (error) {\n\t\tlogger.error('Failed to fetch public settings:', error);\n\t}\n}\n\n/**\n * Starts listening for real-time settings changes via Server-Sent Events.\n * This replaces the old polling mechanism for better efficiency.\n */\nfunction startListening() {\n\tif (!browser || eventSource) return;\n\n\t// Do not connect to stream on login page to avoid 401 errors\n\tif (window.location.pathname.startsWith('/login')) return;\n\n\ttry {\n\t\teventSource = new EventSource('/api/settings/public/stream');\n\n\t\teventSource.addEventListener('message', async (event) => {\n\t\t\ttry {\n\t\t\t\tconst data = JSON.parse(event.data);\n\n\t\t\t\tif (data.type === 'connected') {\n\t\t\t\t\tlogger.debug('Connected to settings stream');\n\t\t\t\t} else if (data.type === 'update') {\n\t\t\t\t\tlogger.debug('Settings updated, fetching new values...');\n\t\t\t\t\tawait fetchPublicSettings();\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error('Failed to process settings update:', error);\n\t\t\t}\n\t\t});\n\n\t\teventSource.addEventListener('error', (error) => {\n\t\t\tlogger.warn('Settings stream connection error, will auto-reconnect...', error);\n\t\t\t// EventSource automatically reconnects on error\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Failed to start settings listener:', error);\n\t}\n}\n\n/**\n * Initializes or updates the client-side public environment store.\n * This should be called from a root layout's load function.\n * @param data The public settings loaded from the server.\n */\nexport function initPublicEnv(data: PublicEnv): void {\n\tObject.assign(state, data);\n\tstartListening();\n}\n\n/**\n * Type-safe getter for a specific public setting.\n */\nexport function getPublicSetting<K extends keyof PublicEnv>(key: K): PublicEnv[K] {\n\treturn state[key];\n}\n\n/**\n * Get the reactive public environment for use across the app.\n * Access properties directly: publicEnv.SITE_NAME (no $ prefix needed)\n *\n * Note: This returns the state object directly, which is reactive in Svelte 5.\n */\nexport function getPublicEnv(): PublicEnv {\n\treturn state;\n}\n\n/**\n * Direct export of reactive state as publicEnv for backward compatibility.\n * All properties are reactive and will automatically update components.\n */\nexport const publicEnv: PublicEnv = state;\n"],"names":[],"mappings":";;;MA4BM,QAAA,CAAA;SA0EU,iBAA4C,KAAsB;AAC1E,SAAA,MAAM,GAAG;AACjB;AAgBa,MAAA,YAAuB;"}