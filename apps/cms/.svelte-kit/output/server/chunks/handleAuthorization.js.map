{"version":3,"file":"handleAuthorization.js","sources":["../../../../src/hooks/handleAuthorization.ts"],"sourcesContent":["/**\n * @file src/hooks/handleAuthorization.ts\n * @description Lightweight authorization middleware for user role and route protection\n *\n * ### Improvements\n * - Removed setup guard (redundant)\n * - Removed heavy global data loading (users/tokens)\n * - Simplified redirect logic for authenticated users\n * - Public and static routes skip database access entirely\n */\n\nimport { error, redirect, type Handle } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { hasPermissionByAction } from '@shared/database/auth/permissions';\nimport type { Role } from '@shared/database/auth/types';\nimport { auth } from '@shared/database/db';\nimport {\n\tcacheService,\n\tUSER_COUNT_CACHE_TTL_MS,\n\tUSER_COUNT_CACHE_TTL_S,\n\tUSER_PERM_CACHE_TTL_MS,\n\tUSER_PERM_CACHE_TTL_S\n} from '@shared/database/CacheService';\nimport { logger } from '@shared/utils/logger.server';\n\n// --- SIMPLE IN-MEMORY CACHE ---\n\nlet userCountCache: { count: number; timestamp: number } | null = null;\nconst rolesCache = new Map<string, { data: Role[]; timestamp: number }>();\n\n// --- UTILITIES ---\n\nfunction isPublicRoute(pathname: string): boolean {\n\tconst publicRoutes = ['/login', '/register', '/forgot-password', '/setup', '/api/sendMail', '/api/setup', '/api/system/version', '/api/user/login'];\n\treturn publicRoutes.some((route) => pathname.startsWith(route));\n}\n\nfunction isOAuthRoute(pathname: string): boolean {\n\treturn pathname.startsWith('/login') && pathname.includes('OAuth');\n}\n\n/** Get cached user count with fallback */\nasync function getCachedUserCount(tenantId?: string): Promise<number> {\n\tconst now = Date.now();\n\tif (userCountCache && now - userCountCache.timestamp < USER_COUNT_CACHE_TTL_MS) {\n\t\treturn userCountCache.count;\n\t}\n\n\ttry {\n\t\tconst cached = await cacheService.get<{ count: number; timestamp: number }>('userCount', tenantId);\n\t\tif (cached && now - cached.timestamp < USER_COUNT_CACHE_TTL_MS) {\n\t\t\tuserCountCache = cached;\n\t\t\treturn cached.count;\n\t\t}\n\t} catch {\n\t\t// ignore cache errors\n\t}\n\n\ttry {\n\t\tif (!auth) return -1;\n\t\tconst filter = getPrivateSettingSync('MULTI_TENANT') && tenantId ? { tenantId } : {};\n\t\tconst count = await auth.getUserCount(filter);\n\t\tconst cacheData = { count, timestamp: now };\n\t\tuserCountCache = cacheData;\n\t\tawait cacheService.set('userCount', cacheData, USER_COUNT_CACHE_TTL_S, tenantId);\n\t\treturn count;\n\t} catch (err) {\n\t\tlogger.warn(`User count query failed: ${err instanceof Error ? err.message : String(err)}`);\n\t\treturn -1;\n\t}\n}\n\n/**\n * Get cached roles for access checks (database-only)\n * Returns empty array if database is unavailable - caller should handle setup redirect\n */\nasync function getCachedRoles(tenantId?: string): Promise<Role[]> {\n\tconst now = Date.now();\n\tconst key = tenantId || 'global';\n\n\tconst cached = rolesCache.get(key);\n\tif (cached && now - cached.timestamp < USER_PERM_CACHE_TTL_MS) {\n\t\treturn cached.data;\n\t}\n\n\ttry {\n\t\tif (!auth) {\n\t\t\tlogger.debug('Database adapter not initialized - roles unavailable');\n\t\t\treturn [];\n\t\t}\n\n\t\tconst data = await auth.getAllRoles(tenantId);\n\t\tif (!data || data.length === 0) {\n\t\t\tlogger.debug('No roles found in database', { tenantId });\n\t\t\treturn [];\n\t\t}\n\n\t\tconst cacheData = { data, timestamp: now };\n\t\trolesCache.set(key, cacheData);\n\t\tawait cacheService.set(`roles:${key}`, cacheData, USER_PERM_CACHE_TTL_S, tenantId);\n\t\treturn data;\n\t} catch (err) {\n\t\tlogger.error(`Failed to fetch roles from database: ${err instanceof Error ? err.message : String(err)}`);\n\t\treturn [];\n\t}\n}\n\n// --- MAIN HANDLE ---\n\nexport const handleAuthorization: Handle = async ({ event, resolve }) => {\n\tconst { url, locals } = event;\n\tconst { user } = locals;\n\n\tconst pathname = url.pathname;\n\tconst isApi = pathname.startsWith('/api/');\n\tconst isPublic = isPublicRoute(pathname);\n\n\t// --- Skip static or internal routes early ---\n\tconst ASSET_REGEX =\n\t\t/^\\/(?:@vite\\/client|@fs\\/|src\\/|node_modules\\/|vite\\/|_app|static|favicon\\.ico|\\.svelte-kit\\/generated\\/client\\/nodes|.*\\.(svg|png|jpg|jpeg|gif|css|js|woff|woff2|ttf|eot|map|json))/;\n\tif (pathname.startsWith('/.well-known/') || pathname.startsWith('/_') || ASSET_REGEX.test(pathname)) {\n\t\treturn resolve(event);\n\t}\n\n\t// --- Public routes require no auth ---\n\tif (isPublic) {\n\t\tlocals.isAdmin = false;\n\t\tlocals.hasManageUsersPermission = false;\n\t\tlocals.isFirstUser = false;\n\t\treturn resolve(event);\n\t}\n\n\t// --- Check if first user (for setup flow) ---\n\tconst userCount = await getCachedUserCount(locals.tenantId);\n\tlocals.isFirstUser = userCount === 0;\n\n\t// --- Load cached roles (database-only) ---\n\tconst rolesData = await getCachedRoles(locals.tenantId);\n\tlocals.roles = rolesData;\n\n\t// --- Redirect to setup if database not initialized (no roles found) ---\n\tconst isLocalizedSetup = /^\\/[a-z]{2,5}(-[a-zA-Z]+)?\\/setup/.test(pathname);\n\tif (rolesData.length === 0 && !pathname.startsWith('/setup') && !pathname.startsWith('/api/setup') && !isLocalizedSetup) {\n\t\tlogger.warn('No roles found in database - redirecting to setup', { pathname, tenantId: locals.tenantId });\n\t\tif (isApi) {\n\t\t\tthrow error(503, 'Service Unavailable: System not initialized. Please run setup.');\n\t\t}\n\t\tthrow redirect(302, '/setup');\n\t}\n\n\t// --- Handle authenticated users ---\n\tif (user) {\n\t\tconst userRole = rolesData.find((r) => r._id === user.role);\n\t\tconst isAdmin = !!userRole?.isAdmin;\n\n\t\tlocals.isAdmin = isAdmin;\n\t\tlocals.hasManageUsersPermission = isAdmin || hasPermissionByAction(user, 'manage', 'user', undefined, rolesData);\n\n\t\t// Redirect authenticated users away from public routes\n\t\tif (isPublic && !isOAuthRoute(pathname) && !isApi) {\n\t\t\tthrow redirect(302, '/');\n\t\t}\n\t} else {\n\t\t// --- Handle unauthenticated users ---\n\t\tlocals.isAdmin = false;\n\t\tlocals.hasManageUsersPermission = false;\n\n\t\t// Block access to protected pages\n\t\tif (!isPublic && !locals.isFirstUser) {\n\t\t\tif (isApi) throw error(401, 'Unauthorized');\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\t}\n\n\t// --- Allow OAuth routes to pass through ---\n\tif (isOAuthRoute(pathname)) {\n\t\tlogger.trace('OAuth route detected, passing through');\n\t}\n\n\treturn resolve(event);\n};\n\n// --- CACHE INVALIDATION UTILITIES ---\n\nexport function invalidateUserCountCache(tenantId?: string): void {\n\tuserCountCache = null;\n\tcacheService.delete('userCount', tenantId).catch((err) => logger.error(`Failed to invalidate user count: ${err.message}`));\n\tlogger.debug('User count cache invalidated');\n}\n\nexport function invalidateRolesCache(tenantId?: string): void {\n\tconst key = tenantId || 'global';\n\trolesCache.delete(key);\n\tcacheService.delete(`roles:${key}`, tenantId).catch((err) => logger.error(`Failed to invalidate roles cache: ${err.message}`));\n\tlogger.debug(`Roles cache invalidated (tenant: ${tenantId || 'global'})`);\n}\n"],"names":[],"mappings":"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"}