{"version":3,"file":"googleAuth.js","sources":["../../../../../../shared/database/src/auth/googleAuth.ts"],"sourcesContent":["/**\n * @file src/databases/auth/googleAuth.ts\n * @description Utility functions for Google OAuth.\n *\n * This module provides:\n * - Google OAuth client initialization\n * - Google OAuth client setup\n */\n\nimport { dev } from '$app/environment';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\n\nimport type { Credentials, OAuth2Client } from 'google-auth-library';\n\n// System Logger\nimport { logger } from '@shared/utils/logger';\n\n// Utility function to determine the correct OAuth redirect URI\nfunction getOAuthRedirectUri(): string {\n\t// Use SvelteKit's built-in environment detection\n\tif (dev) {\n\t\tlogger.debug('ðŸ”§ Development mode detected - using development host');\n\t\treturn `${publicEnv.HOST_DEV}/login/oauth`;\n\t} // For production builds, use the production host\n\n\tlogger.debug('ðŸš€ Production mode detected - using production host');\n\treturn `${publicEnv.HOST_PROD}/login/oauth`;\n}\n\n// Google OAuth\nlet googleAuthClient: OAuth2Client | null = null;\n\n// Initialize Google OAuth client with ID, secret, and redirect URL\nasync function googleAuth(): Promise<OAuth2Client | null> {\n\tconst googleClientId = getPrivateSettingSync('GOOGLE_CLIENT_ID');\n\tconst googleClientSecret = getPrivateSettingSync('GOOGLE_CLIENT_SECRET');\n\tif (!googleClientId || !googleClientSecret) {\n\t\tlogger.warn('Google client ID and secret are not provided. OAuth unavailable.');\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tif (!googleAuthClient) {\n\t\t\tlogger.debug('Setting up Google OAuth2...');\n\t\t\tconst { google } = await import('googleapis');\n\t\t\tconst redirectUri = getOAuthRedirectUri();\n\t\t\tlogger.debug(`Using OAuth redirect URI: ${redirectUri}`);\n\n\t\t\tgoogleAuthClient = new google.auth.OAuth2(googleClientId, googleClientSecret, redirectUri);\n\t\t}\n\n\t\treturn googleAuthClient;\n\t} catch (err) {\n\t\tconst error = err instanceof Error ? err.message : 'Unknown error initializing Google OAuth client';\n\t\tlogger.error('Error initializing Google OAuth client:', error);\n\t\treturn null;\n\t}\n}\n\n// Set credentials for the OAuth client\nasync function setCredentials(credentials: Credentials): Promise<void> {\n\tconst client = await googleAuth();\n\tif (client) {\n\t\tclient.setCredentials(credentials);\n\t}\n}\n\nasync function generateGoogleAuthUrl(token?: string | null, promptType?: 'consent' | 'none' | 'select_account', tenantId?: string): Promise<string> {\n\tconst googleAuthClient = await googleAuth();\n\tif (!googleAuthClient) {\n\t\tthrow new Error('Google OAuth is not initialized');\n\t}\n\n\tconst scopes = ['https://www.googleapis.com/auth/userinfo.profile', 'https://www.googleapis.com/auth/userinfo.email', 'openid'];\n\tconst baseUrl = getOAuthRedirectUri(); // Generate auth URL without PKCE parameters to avoid Google's \"code_verifier or verifier is not needed\" error\n\t// Use 'online' access_type to prevent PKCE from being auto-enabled in newer googleapis versions\n\n\tconst authUrlOptions: Record<string, string | boolean | undefined> = {\n\t\taccess_type: 'online', // Changed from 'offline' to 'online' to disable PKCE\n\t\tscope: scopes.join(' '),\n\t\tredirect_uri: baseUrl,\n\t\tstate: token ? encodeURIComponent(token) : undefined,\n\t\tinclude_granted_scopes: true // Note: Using 'online' access_type prevents PKCE parameters from being auto-added\n\t}; // Only add prompt if explicitly specified\n\n\tif (promptType) {\n\t\tauthUrlOptions.prompt = promptType;\n\t}\n\n\tconst authUrl = googleAuthClient.generateAuthUrl(authUrlOptions);\n\tlogger.debug('Generated Google Auth URL', { tenantId, promptType });\n\n\treturn authUrl;\n}\n\nexport { generateGoogleAuthUrl, getOAuthRedirectUri, googleAuth, setCredentials };\n"],"names":["googleAuthClient"],"mappings":";;;AAmBA,SAAS,sBAA8B;AAOtC,SAAO,MAAM,qDAAqD;AAClE,SAAO,GAAG,UAAU,SAAS;AAC9B;AAGA,IAAI,mBAAwC;AAG5C,eAAe,aAA2C;AACzD,QAAM,iBAAiB,sBAAsB,kBAAkB;AAC/D,QAAM,qBAAqB,sBAAsB,sBAAsB;AACvE,MAAI,CAAC,kBAAkB,CAAC,oBAAoB;AAC3C,WAAO,KAAK,kEAAkE;AAC9E,WAAO;AAAA,EACR;AAEA,MAAI;AACH,QAAI,CAAC,kBAAkB;AACtB,aAAO,MAAM,6BAA6B;AAC1C,YAAM,EAAE,OAAA,IAAW,MAAM,OAAO,YAAY;AAC5C,YAAM,cAAc,oBAAA;AACpB,aAAO,MAAM,6BAA6B,WAAW,EAAE;AAEvD,yBAAmB,IAAI,OAAO,KAAK,OAAO,gBAAgB,oBAAoB,WAAW;AAAA,IAC1F;AAEA,WAAO;AAAA,EACR,SAAS,KAAK;AACb,UAAM,QAAQ,eAAe,QAAQ,IAAI,UAAU;AACnD,WAAO,MAAM,2CAA2C,KAAK;AAC7D,WAAO;AAAA,EACR;AACD;AAUA,eAAe,sBAAsB,OAAuB,YAAoD,UAAoC;AACnJ,QAAMA,oBAAmB,MAAM,WAAA;AAC/B,MAAI,CAACA,mBAAkB;AACtB,UAAM,IAAI,MAAM,iCAAiC;AAAA,EAClD;AAEA,QAAM,SAAS,CAAC,oDAAoD,kDAAkD,QAAQ;AAC9H,QAAM,UAAU,oBAAA;AAGhB,QAAM,iBAA+D;AAAA,IACpE,aAAa;AAAA;AAAA,IACb,OAAO,OAAO,KAAK,GAAG;AAAA,IACtB,cAAc;AAAA,IACd,OAAO,QAAQ,mBAAmB,KAAK,IAAI;AAAA,IAC3C,wBAAwB;AAAA;AAAA,EAAA;AAGzB,MAAI,YAAY;AACf,mBAAe,SAAS;AAAA,EACzB;AAEA,QAAM,UAAUA,kBAAiB,gBAAgB,cAAc;AAC/D,SAAO,MAAM,6BAA6B,EAAE,UAAU,YAAY;AAElE,SAAO;AACR;"}