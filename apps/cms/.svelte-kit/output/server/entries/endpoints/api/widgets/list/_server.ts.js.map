{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/list/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/list/+server.ts\n * @description API endpoint for listing all widgets with 3-pillar architecture metadata\n */\n\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\nimport { widgets, getWidgetDependencies } from '@shared/stores/widgetStore.svelte';\n\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\tconst start = performance.now();\n\tconst tenantId = url.searchParams.get('tenantId') || 'default-tenant';\n\n\ttry {\n\t\tconst { user } = locals;\n\n\t\tif (!user) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Unauthorized',\n\t\t\t\t\terror: 'Authentication credentials missing'\n\t\t\t\t},\n\t\t\t\t{ status: 401 }\n\t\t\t);\n\t\t}\n\n\t\t// Check permission\n\t\tconst hasWidgetPermission = hasPermissionWithRoles(user, 'api:widgets', locals.roles);\n\t\tif (!hasWidgetPermission) {\n\t\t\tlogger.warn(`User ${user._id} denied access to widget API due to insufficient permissions`);\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Insufficient permissions',\n\t\t\t\t\terror: 'User lacks api:widgets permission'\n\t\t\t\t},\n\t\t\t\t{ status: 403 }\n\t\t\t);\n\t\t}\n\n\t\t// Initialize widgets if not already loaded\n\t\tawait widgets.initialize(tenantId);\n\n\t\t// Get active widgets from DATABASE (not cached widget store)\n\t\t// This ensures the GUI always shows current database state\n\t\tif (!locals.dbAdapter?.widgets?.getActiveWidgets) {\n\t\t\tthrow new Error('Widget database adapter not available');\n\t\t}\n\n\t\tconst activeWidgetsResult = await locals.dbAdapter.widgets.getActiveWidgets();\n\t\tif (!activeWidgetsResult.success) {\n\t\t\tthrow new Error(`Failed to fetch active widgets: ${activeWidgetsResult.error?.message || 'Unknown error'}`);\n\t\t}\n\n\t\tconst activeWidgetNames = (activeWidgetsResult.data || []).map((w) => w.name);\n\n\t\tlogger.debug('[/api/widgets/list] Active widgets from database', {\n\t\t\ttenantId,\n\t\t\tcount: activeWidgetNames.length,\n\t\t\twidgets: activeWidgetNames\n\t\t});\n\n\t\t// Build comprehensive widget list with 3-pillar architecture metadata\n\t\tconst widgetList = Object.entries(widgets.widgetFunctions).map(([name, widgetFn]) => {\n\t\t\tconst isActive = activeWidgetNames.includes(name);\n\t\t\tconst isCore = widgets.coreWidgets.includes(name);\n\t\t\tconst dependencies = getWidgetDependencies(name);\n\t\t\tconst widget = widgetFn as unknown as Record<string, unknown>;\n\n\t\t\treturn {\n\t\t\t\tname,\n\t\t\t\ticon: (widget.Icon as string) || (isCore ? 'mdi:puzzle' : 'mdi:puzzle-plus'),\n\t\t\t\tdescription: (widget.Description as string) || '',\n\t\t\t\tisCore,\n\t\t\t\tisActive,\n\t\t\t\tdependencies,\n\t\t\t\t// 3-Pillar Architecture Components\n\t\t\t\tpillar: {\n\t\t\t\t\tdefinition: {\n\t\t\t\t\t\tname: widget.Name as string,\n\t\t\t\t\t\tdescription: widget.Description as string,\n\t\t\t\t\t\ticon: widget.Icon as string,\n\t\t\t\t\t\tguiSchema: widget.GuiSchema ? Object.keys(widget.GuiSchema as object).length : 0,\n\t\t\t\t\t\taggregations: !!widget.aggregations\n\t\t\t\t\t},\n\t\t\t\t\tinput: {\n\t\t\t\t\t\tcomponentPath: (widget.__inputComponentPath as string) || '',\n\t\t\t\t\t\texists: !!(widget.__inputComponentPath as string)\n\t\t\t\t\t},\n\t\t\t\t\tdisplay: {\n\t\t\t\t\t\tcomponentPath: (widget.__displayComponentPath as string) || '',\n\t\t\t\t\t\texists: !!(widget.__displayComponentPath as string)\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t// Widget metadata\n\t\t\t\tcanDisable: !isCore && dependencies.length === 0,\n\t\t\t\thasValidation: !!widget.GuiSchema\n\t\t\t};\n\t\t}); // Sort: core first, then alphabetically\n\t\twidgetList.sort((a, b) => {\n\t\t\tif (a.isCore && !b.isCore) return -1;\n\t\t\tif (!a.isCore && b.isCore) return 1;\n\t\t\treturn a.name.localeCompare(b.name);\n\t\t});\n\n\t\tconst duration = performance.now() - start;\n\n\t\tlogger.trace('Retrieved complete widget list', {\n\t\t\ttenantId,\n\t\t\tcoreWidgets: widgetList.filter((w) => w.isCore).length,\n\t\t\tcustomWidgets: widgetList.filter((w) => !w.isCore).length,\n\t\t\ttotalWidgets: widgetList.length\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\twidgets: widgetList,\n\t\t\t\tsummary: {\n\t\t\t\t\ttotal: widgetList.length,\n\t\t\t\t\tactive: widgetList.filter((w) => w.isActive).length,\n\t\t\t\t\tcore: widgetList.filter((w) => w.isCore).length,\n\t\t\t\t\tcustom: widgetList.filter((w) => !w.isCore).length\n\t\t\t\t},\n\t\t\t\ttenantId,\n\t\t\t\tperformance: { duration: `${duration.toFixed(2)}ms` }\n\t\t\t},\n\t\t\tmessage: 'Widget list retrieved successfully'\n\t\t});\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to get widget list: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms`, stack: err instanceof Error ? err.stack : undefined });\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}