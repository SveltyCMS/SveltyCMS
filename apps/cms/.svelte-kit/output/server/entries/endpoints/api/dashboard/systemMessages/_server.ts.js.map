{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/dashboard/systemMessages/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/dashboard/systemMessages/+server.ts\n * @description API endpoint for system messages for dashboard widgets\n *\n * ### Features\n * - **Secure Authorization:** Access is controlled centrally by `src/hooks.server.ts`.\n * - **High-Performance Log Reading:** Efficiently reads only the end of the log file.\n * - **Input Validation:** Safely validates and caps the `limit` query parameter.\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport { v4 as uuidv4 } from 'uuid';\nimport type { RequestHandler } from './$types';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\nimport type { ISODateString } from '@cms-types';\n\n// Validation\nimport * as v from 'valibot';\n\n// --- Types, Constants & Schemas ---\ntype SystemMessage = {\n\tid: string;\n\ttitle: string;\n\tmessage: string;\n\tlevel: string;\n\ttimestamp: ISODateString;\n\ttype: 'error' | 'warning' | 'info';\n};\n\nconst MAX_MESSAGES_LIMIT = 50;\nconst LOG_FILE_PATH = path.join(process.cwd(), 'logs', 'app.log');\n\nconst QuerySchema = v.object({\n\tlimit: v.optional(v.pipe(v.number(), v.minValue(1), v.maxValue(MAX_MESSAGES_LIMIT)), 5)\n});\n\nconst LOG_LINE_REGEX = /^(\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z?) \\S+ \\[(\\w+)\\]: (.+)$/;\n\n// --- Helper Functions ---\n\nasync function readLastLines(filePath: string, maxLines: number): Promise<string[]> {\n\ttry {\n\t\tconst handle = await fs.open(filePath, 'r');\n\t\tconst { size } = await handle.stat();\n\t\tconst bufferSize = Math.min(1024 * 4, size);\n\t\tconst buffer = Buffer.alloc(bufferSize);\n\t\tlet position = size;\n\t\tlet lines: string[] = [];\n\t\tlet collectedData = '';\n\n\t\twhile (lines.length < maxLines && position > 0) {\n\t\t\tconst readPosition = Math.max(0, position - bufferSize);\n\t\t\tconst bytesToRead = position - readPosition;\n\t\t\tawait handle.read(buffer, 0, bytesToRead, readPosition);\n\t\t\tcollectedData = buffer.toString('utf-8', 0, bytesToRead) + collectedData;\n\t\t\tconst currentLines = collectedData.split('\\n');\n\t\t\tif (position === size && currentLines[currentLines.length - 1] === '') {\n\t\t\t\tcurrentLines.pop();\n\t\t\t}\n\t\t\tlines = currentLines.slice(-maxLines);\n\t\t\tposition = readPosition;\n\t\t}\n\t\tawait handle.close();\n\t\treturn lines;\n\t} catch (err) {\n\t\tlogger.warn(`Could not read log file at: ${filePath}`, err);\n\t\treturn [];\n\t}\n}\n\n// --- API Handler ---\n\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\t// Authentication is handled by hooks.server.ts\n\tif (!locals.user) {\n\t\tlogger.warn('Unauthorized attempt to access system messages');\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\ttry {\n\t\tconst query = v.parse(QuerySchema, {\n\t\t\tlimit: Number(url.searchParams.get('limit')) || undefined\n\t\t});\n\n\t\tconst logLines = await readLastLines(LOG_FILE_PATH, query.limit);\n\n\t\tconst messages: SystemMessage[] = logLines\n\t\t\t.map((line): SystemMessage | null => {\n\t\t\t\tconst match = line.match(LOG_LINE_REGEX);\n\t\t\t\tif (!match) return null;\n\t\t\t\tconst [, timestamp, level, message] = match;\n\t\t\t\tconst lowerLevel = level.toLowerCase();\n\t\t\t\treturn {\n\t\t\t\t\tid: uuidv4(),\n\t\t\t\t\ttitle: `${level.toUpperCase()} Message`,\n\t\t\t\t\tmessage: message.substring(0, 100) + (message.length > 100 ? '...' : ''),\n\t\t\t\t\tlevel: lowerLevel,\n\t\t\t\t\ttimestamp: timestamp as ISODateString,\n\t\t\t\t\ttype: lowerLevel === 'error' ? 'error' : lowerLevel === 'warn' ? 'warning' : 'info'\n\t\t\t\t};\n\t\t\t})\n\t\t\t.filter((msg): msg is SystemMessage => msg !== null);\n\n\t\tif (messages.length === 0) {\n\t\t\tmessages.push({\n\t\t\t\tid: uuidv4(),\n\t\t\t\ttitle: 'System Status',\n\t\t\t\tmessage: 'System is running normally. No recent critical messages.',\n\t\t\t\tlevel: 'info',\n\t\t\t\ttimestamp: new Date().toISOString() as ISODateString,\n\t\t\t\ttype: 'info'\n\t\t\t});\n\t\t}\n\n\t\tlogger.info('System messages fetched successfully', {\n\t\t\tcount: messages.length,\n\t\t\trequestedBy: locals.user?._id\n\t\t});\n\n\t\treturn json(messages);\n\t} catch (err) {\n\t\tif (err instanceof v.ValiError) {\n\t\t\treturn json({ error: 'Invalid \"limit\" parameter.', issues: err.issues }, { status: 400 });\n\t\t}\n\t\tlogger.error('An unexpected error occurred while fetching system messages:', err);\n\t\tthrow error(500, 'An unexpected error occurred.');\n\t}\n};\n"],"names":["uuidv4"],"mappings":"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"}