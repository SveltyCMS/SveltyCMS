{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/dashboard/last5media/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/dashboard/last5media/+server.ts\n * @description API endpoint for last 5 media files for dashboard widgets using database-agnostic adapter.\n */\n\nimport type { RequestHandler } from './$types';\nimport { error, json } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Database\n// import { dbAdapter } from '@shared/database/db';\n\n// Auth\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Validation\nimport * as v from 'valibot';\n\n// --- Types & Schemas ---\n\nconst MediaItemSchema = v.object({\n\tname: v.string(),\n\tsize: v.number(),\n\tmodified: v.date(),\n\ttype: v.string(),\n\turl: v.string()\n});\n\n// --- API Handler ---\n\nexport const GET: RequestHandler = async ({ locals }) => {\n\tconst dbAdapter = locals.dbAdapter;\n\tconst { user, tenantId } = locals;\n\n\t// Authentication is handled by hooks.server.ts\n\tif (!user) {\n\t\tlogger.warn('Unauthorized attempt to access media data');\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\ttry {\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not available');\n\t\t\tthrow error(500, 'Database connection unavailable');\n\t\t}\n\n\t\t// Check if media adapter is available\n\t\tif (!dbAdapter.media || !dbAdapter.media.files || !dbAdapter.media.files.getByFolder) {\n\t\t\tlogger.warn('Media adapter not available, returning empty result');\n\t\t\treturn json([]);\n\t\t}\n\n\t\t// Use database-agnostic adapter to get recent media files\n\t\tconst result = await dbAdapter.media.files.getByFolder(undefined, {\n\t\t\tpage: 1,\n\t\t\tpageSize: 5,\n\t\t\tsortField: 'updatedAt',\n\t\t\tsortDirection: 'desc'\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tlogger.error('Failed to fetch media files from database', {\n\t\t\t\terror: result.error,\n\t\t\t\trequestedBy: user?._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\t// Return empty array instead of throwing error for dashboard widgets\n\t\t\treturn json([]);\n\t\t}\n\n\t\t// Check if we have data and items\n\t\tif (!result.data || !result.data.items || !Array.isArray(result.data.items)) {\n\t\t\tlogger.warn('No media items found or invalid response structure');\n\t\t\treturn json([]);\n\t\t}\n\n\t\t// Transform the data to match the expected format\n\t\tlet items = result.data.items;\n\n\t\t// --- MULTI-TENANCY: Filter by tenantId if enabled ---\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && tenantId) {\n\t\t\titems = items.filter((file) => (file as unknown as Record<string, unknown>).tenantId === tenantId);\n\t\t}\n\n\t\tconst recentMedia = items.map((file) => {\n\t\t\tlet url = file.path || '';\n\t\t\t// Strip 'mediaFolder/' or 'files/' prefix\n\t\t\turl = url.replace(/^mediaFolder\\//, '').replace(/^files\\//, '');\n\t\t\t// Ensure no leading slash before prepending /files/\n\t\t\turl = url.replace(/^\\/+/, '');\n\n\t\t\treturn {\n\t\t\t\tname: file.filename || 'Unknown',\n\t\t\t\tsize: file.size || 0,\n\t\t\t\tmodified: new Date(file.updatedAt),\n\t\t\t\ttype: file.mimeType.split('/')[1] || 'unknown',\n\t\t\t\turl: `/files/${url}`\n\t\t\t};\n\t\t});\n\t\tconst validatedData = v.parse(v.array(MediaItemSchema), recentMedia);\n\n\t\tlogger.info('Recent media fetched successfully via database adapter', {\n\t\t\tcount: validatedData.length,\n\t\t\ttotal: result.data.total,\n\t\t\trequestedBy: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\treturn json(validatedData);\n\t} catch (err) {\n\t\tif (err instanceof v.ValiError) {\n\t\t\tlogger.error('Media data failed validation', { error: err.issues });\n\t\t\tthrow error(500, 'Internal Server Error: Could not prepare media data.');\n\t\t}\n\t\tlogger.error('Error fetching recent media:', err);\n\t\tthrow error(500, 'An unexpected error occurred.');\n\t}\n};\n"],"names":[],"mappings":";;;;AAsBA,MAAM,kBAAkB,EAAE,OAAO;AAAA,EAChC,MAAM,EAAE,OAAA;AAAA,EACR,MAAM,EAAE,OAAA;AAAA,EACR,UAAU,EAAE,KAAA;AAAA,EACZ,MAAM,EAAE,OAAA;AAAA,EACR,KAAK,EAAE,OAAA;AACR,CAAC;AAIM,MAAM,MAAsB,OAAO,EAAE,aAAa;AACxD,QAAM,YAAY,OAAO;AACzB,QAAM,EAAE,MAAM,SAAA,IAAa;AAG3B,MAAI,CAAC,MAAM;AACV,WAAO,KAAK,2CAA2C;AACvD,UAAM,MAAM,KAAK,cAAc;AAAA,EAChC;AAEA,MAAI;AACH,QAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,YAAM,MAAM,KAAK,oDAAoD;AAAA,IACtE;AAEA,QAAI,CAAC,WAAW;AACf,aAAO,MAAM,gCAAgC;AAC7C,YAAM,MAAM,KAAK,iCAAiC;AAAA,IACnD;AAGA,QAAI,CAAC,UAAU,SAAS,CAAC,UAAU,MAAM,SAAS,CAAC,UAAU,MAAM,MAAM,aAAa;AACrF,aAAO,KAAK,qDAAqD;AACjE,aAAO,KAAK,CAAA,CAAE;AAAA,IACf;AAGA,UAAM,SAAS,MAAM,UAAU,MAAM,MAAM,YAAY,QAAW;AAAA,MACjE,MAAM;AAAA,MACN,UAAU;AAAA,MACV,WAAW;AAAA,MACX,eAAe;AAAA,IAAA,CACf;AAED,QAAI,CAAC,OAAO,SAAS;AACpB,aAAO,MAAM,6CAA6C;AAAA,QACzD,OAAO,OAAO;AAAA,QACd,aAAa,MAAM;AAAA,QACnB;AAAA,MAAA,CACA;AAED,aAAO,KAAK,CAAA,CAAE;AAAA,IACf;AAGA,QAAI,CAAC,OAAO,QAAQ,CAAC,OAAO,KAAK,SAAS,CAAC,MAAM,QAAQ,OAAO,KAAK,KAAK,GAAG;AAC5E,aAAO,KAAK,oDAAoD;AAChE,aAAO,KAAK,CAAA,CAAE;AAAA,IACf;AAGA,QAAI,QAAQ,OAAO,KAAK;AAGxB,QAAI,sBAAsB,cAAc,KAAK,UAAU;AACtD,cAAQ,MAAM,OAAO,CAAC,SAAU,KAA4C,aAAa,QAAQ;AAAA,IAClG;AAEA,UAAM,cAAc,MAAM,IAAI,CAAC,SAAS;AACvC,UAAI,MAAM,KAAK,QAAQ;AAEvB,YAAM,IAAI,QAAQ,kBAAkB,EAAE,EAAE,QAAQ,YAAY,EAAE;AAE9D,YAAM,IAAI,QAAQ,QAAQ,EAAE;AAE5B,aAAO;AAAA,QACN,MAAM,KAAK,YAAY;AAAA,QACvB,MAAM,KAAK,QAAQ;AAAA,QACnB,UAAU,IAAI,KAAK,KAAK,SAAS;AAAA,QACjC,MAAM,KAAK,SAAS,MAAM,GAAG,EAAE,CAAC,KAAK;AAAA,QACrC,KAAK,UAAU,GAAG;AAAA,MAAA;AAAA,IAEpB,CAAC;AACD,UAAM,gBAAgB,EAAE,MAAM,EAAE,MAAM,eAAe,GAAG,WAAW;AAEnE,WAAO,KAAK,0DAA0D;AAAA,MACrE,OAAO,cAAc;AAAA,MACrB,OAAO,OAAO,KAAK;AAAA,MACnB,aAAa,MAAM;AAAA,MACnB;AAAA,IAAA,CACA;AAED,WAAO,KAAK,aAAa;AAAA,EAC1B,SAAS,KAAK;AACb,QAAI,eAAe,EAAE,WAAW;AAC/B,aAAO,MAAM,gCAAgC,EAAE,OAAO,IAAI,QAAQ;AAClE,YAAM,MAAM,KAAK,sDAAsD;AAAA,IACxE;AACA,WAAO,MAAM,gCAAgC,GAAG;AAChD,UAAM,MAAM,KAAK,+BAA+B;AAAA,EACjD;AACD;"}