{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/systemsetting/import/+server.ts"],"sourcesContent":["import { json, type RequestHandler } from '@sveltejs/kit';\nimport { getDb } from '@shared/database/db';\nimport { getAllSettings, invalidateSettingsCache } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { decryptData } from '@shared/utils/crypto';\nimport type {\n\tExportData,\n\tImportOptions,\n\tValidationResult,\n\tValidationError,\n\tValidationWarning,\n\tConflict,\n\tImportResult,\n\tExportMetadata\n} from '@cms-types';\n\nasync function decryptSensitiveData(encryptedData: string, password: string): Promise<Record<string, unknown>> {\n\ttry {\n\t\treturn await decryptData(encryptedData, password);\n\t} catch {\n\t\tthrow new Error('Failed to decrypt sensitive data. Password may be incorrect.');\n\t}\n}\n\nasync function validateImportData(data: ExportData): Promise<ValidationResult> {\n\tconst errors: ValidationError[] = [];\n\tconst warnings: ValidationWarning[] = [];\n\tif (!data.metadata) {\n\t\terrors.push({ path: 'metadata', message: 'Missing required metadata', code: 'MISSING_METADATA' });\n\t} else {\n\t\tif (!data.metadata.exported_at) {\n\t\t\terrors.push({ path: 'metadata.exported_at', message: 'Missing export timestamp', code: 'MISSING_TIMESTAMP' });\n\t\t}\n\t\tif (!data.metadata.cms_version) {\n\t\t\twarnings.push({ path: 'metadata.cms_version', message: 'Missing CMS version - compatibility cannot be verified', code: 'MISSING_VERSION' });\n\t\t}\n\t}\n\tif (data.settings) {\n\t\tif (typeof data.settings !== 'object') {\n\t\t\terrors.push({ path: 'settings', message: 'Settings must be an object', code: 'INVALID_SETTINGS_TYPE' });\n\t\t} else {\n\t\t\tfor (const [key, value] of Object.entries(data.settings)) {\n\t\t\t\tif (key === '' || key === null || key === undefined) {\n\t\t\t\t\terrors.push({ path: `settings.${key}`, message: 'Invalid setting key', code: 'INVALID_SETTING_KEY' });\n\t\t\t\t}\n\t\t\t\tif (value === null || value === undefined) {\n\t\t\t\t\twarnings.push({ path: `settings.${key}`, message: 'Setting has null or undefined value', code: 'NULL_SETTING_VALUE' });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tif (data.collections) {\n\t\tif (!Array.isArray(data.collections)) {\n\t\t\terrors.push({ path: 'collections', message: 'Collections must be an array', code: 'INVALID_COLLECTIONS_TYPE' });\n\t\t} else {\n\t\t\tdata.collections.forEach((collection, index) => {\n\t\t\t\tif (!collection.id) {\n\t\t\t\t\terrors.push({ path: `collections[${index}].id`, message: 'Collection missing required id', code: 'MISSING_COLLECTION_ID' });\n\t\t\t\t}\n\t\t\t\tif (!collection.name) {\n\t\t\t\t\terrors.push({ path: `collections[${index}].name`, message: 'Collection missing required name', code: 'MISSING_COLLECTION_NAME' });\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\tif (!data.settings && !data.collections) {\n\t\twarnings.push({ path: 'root', message: 'Export contains no settings or collections', code: 'EMPTY_EXPORT' });\n\t}\n\treturn { valid: errors.length === 0, errors, warnings };\n}\n\nasync function detectConflicts(importData: ExportData): Promise<Conflict[]> {\n\tconst conflicts: Conflict[] = [];\n\tif (importData.settings) {\n\t\tconst currentSettings = await getAllSettings();\n\t\tfor (const [key, importValue] of Object.entries(importData.settings)) {\n\t\t\tconst currentValue = (currentSettings as Record<string, unknown>)[key];\n\t\t\tif (currentValue !== undefined) {\n\t\t\t\tif (JSON.stringify(currentValue) !== JSON.stringify(importValue)) {\n\t\t\t\t\tconflicts.push({ type: 'setting', key, current: currentValue, import: importValue, recommendation: 'overwrite' });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn conflicts;\n}\n\nfunction mergeValues(current: unknown, imported: unknown): unknown {\n\tif (typeof current === 'object' && typeof imported === 'object' && current !== null && imported !== null) {\n\t\tif (Array.isArray(current) && Array.isArray(imported)) {\n\t\t\treturn [...new Set([...current, ...imported])];\n\t\t}\n\t\treturn { ...current, ...imported };\n\t}\n\treturn imported;\n}\n\nasync function applyImport(importData: ExportData, options: ImportOptions, conflicts: Conflict[]): Promise<ImportResult> {\n\tconst result: ImportResult = { success: true, imported: 0, skipped: 0, merged: 0, errors: [], conflicts };\n\tconst db = getDb();\n\n\tif (!db) {\n\t\tlogger.error('Database adapter not initialized');\n\t\tthrow new Error('Database adapter not initialized');\n\t}\n\n\tif (importData.settings) {\n\t\tfor (const [key, value] of Object.entries(importData.settings)) {\n\t\t\tconst conflict = conflicts.find((c) => c.key === key);\n\t\t\tif (conflict) {\n\t\t\t\tif (options.strategy === 'skip') {\n\t\t\t\t\tlogger.debug(`Skipping conflicted setting: ${key}`);\n\t\t\t\t\tresult.skipped++;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (options.strategy === 'merge') {\n\t\t\t\t\tconst mergedValue = mergeValues(conflict.current, conflict.import);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait db.systemPreferences.set(key, mergedValue, 'system');\n\t\t\t\t\t\tresult.merged++;\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tresult.errors.push({ key, message: error instanceof Error ? error.message : 'Unknown error', code: 'MERGE_FAILED' });\n\t\t\t\t\t\tresult.success = false;\n\t\t\t\t\t}\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tawait db.systemPreferences.set(key, value, 'system');\n\t\t\t\tresult.imported++;\n\t\t\t} catch (error) {\n\t\t\t\tresult.errors.push({ key, message: error instanceof Error ? error.message : 'Unknown error', code: 'IMPORT_FAILED' });\n\t\t\t\tresult.success = false;\n\t\t\t}\n\t\t}\n\t}\n\tif (result.success) {\n\t\tinvalidateSettingsCache();\n\t\tconst { loadSettingsFromDB } = await import('@shared/database/db');\n\t\tawait loadSettingsFromDB();\n\t\tlogger.info('Settings cache invalidated and reloaded after import');\n\t}\n\tlogger.info('Import completed', { imported: result.imported, skipped: result.skipped, merged: result.merged, errors: result.errors.length });\n\treturn result;\n}\n\nasync function logImport(userId: string, metadata: ExportMetadata, result: ImportResult): Promise<void> {\n\tlogger.info('Import audit log', {\n\t\tuserId,\n\t\timport_id: metadata.export_id,\n\t\timported_at: new Date().toISOString(),\n\t\tsuccess: result.success,\n\t\timported: result.imported,\n\t\tskipped: result.skipped,\n\t\tmerged: result.merged,\n\t\terrors: result.errors.length\n\t});\n}\n\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\tif (!locals.user) {\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\ttry {\n\t\tconst body = await request.json();\n\t\tconst importData: ExportData = body.data;\n\t\tconst options: ImportOptions = body.options || {};\n\t\tconst importOptions: ImportOptions = {\n\t\t\tstrategy: options.strategy || 'skip',\n\t\t\tdryRun: options.dryRun ?? false,\n\t\t\tvalidateOnly: options.validateOnly ?? false,\n\t\t\tsensitivePassword: options.sensitivePassword\n\t\t};\n\t\tif (importData.hasSensitiveData && importData.encryptedSensitive) {\n\t\t\tif (!importOptions.sensitivePassword) {\n\t\t\t\treturn json(\n\t\t\t\t\t{ success: false, error: 'Password required', message: 'This import contains encrypted sensitive data. Please provide the password.' },\n\t\t\t\t\t{ status: 400 }\n\t\t\t\t);\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tconst decryptedSensitive = await decryptSensitiveData(importData.encryptedSensitive, importOptions.sensitivePassword);\n\t\t\t\timportData.settings = { ...importData.settings, ...decryptedSensitive };\n\t\t\t\tlogger.info(`Decrypted ${Object.keys(decryptedSensitive).length} sensitive settings`);\n\t\t\t} catch (decryptError) {\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: 'Decryption failed',\n\t\t\t\t\t\tmessage: decryptError instanceof Error ? decryptError.message : 'Failed to decrypt sensitive data'\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 400 }\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\tconst validation = await validateImportData(importData);\n\t\tif (!validation.valid) {\n\t\t\treturn json({ success: false, errors: validation.errors, warnings: validation.warnings }, { status: 400 });\n\t\t}\n\t\tif (importOptions.validateOnly) {\n\t\t\treturn json({ success: true, valid: true, errors: validation.errors, warnings: validation.warnings });\n\t\t}\n\t\tconst conflicts = await detectConflicts(importData);\n\t\tif (importOptions.dryRun) {\n\t\t\treturn json({ success: true, dryRun: true, conflicts, validation });\n\t\t}\n\t\tconst result: ImportResult = await applyImport(importData, importOptions, conflicts);\n\t\tawait logImport(locals.user._id, importData.metadata, result);\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: result.success,\n\t\t\t\timported: result.imported,\n\t\t\t\tskipped: result.skipped,\n\t\t\t\tmerged: result.merged,\n\t\t\t\tconflicts: result.conflicts,\n\t\t\t\terrors: result.errors,\n\t\t\t\twarnings: validation.warnings,\n\t\t\t\tmetadata: importData.metadata\n\t\t\t},\n\t\t\t{ status: result.success ? 200 : 207 }\n\t\t);\n\t} catch (error) {\n\t\tlogger.error('Import error:', error);\n\t\treturn json({ success: false, error: 'Import failed', message: error instanceof Error ? error.message : 'Unknown error' }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":";;;;;AAgBA,eAAe,qBAAqB,eAAuB,UAAoD;AAC9G,MAAI;AACH,WAAO,MAAM,YAAY,eAAe,QAAQ;AAAA,EACjD,QAAQ;AACP,UAAM,IAAI,MAAM,8DAA8D;AAAA,EAC/E;AACD;AAEA,eAAe,mBAAmB,MAA6C;AAC9E,QAAM,SAA4B,CAAA;AAClC,QAAM,WAAgC,CAAA;AACtC,MAAI,CAAC,KAAK,UAAU;AACnB,WAAO,KAAK,EAAE,MAAM,YAAY,SAAS,6BAA6B,MAAM,oBAAoB;AAAA,EACjG,OAAO;AACN,QAAI,CAAC,KAAK,SAAS,aAAa;AAC/B,aAAO,KAAK,EAAE,MAAM,wBAAwB,SAAS,4BAA4B,MAAM,qBAAqB;AAAA,IAC7G;AACA,QAAI,CAAC,KAAK,SAAS,aAAa;AAC/B,eAAS,KAAK,EAAE,MAAM,wBAAwB,SAAS,0DAA0D,MAAM,mBAAmB;AAAA,IAC3I;AAAA,EACD;AACA,MAAI,KAAK,UAAU;AAClB,QAAI,OAAO,KAAK,aAAa,UAAU;AACtC,aAAO,KAAK,EAAE,MAAM,YAAY,SAAS,8BAA8B,MAAM,yBAAyB;AAAA,IACvG,OAAO;AACN,iBAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,KAAK,QAAQ,GAAG;AACzD,YAAI,QAAQ,MAAM,QAAQ,QAAQ,QAAQ,QAAW;AACpD,iBAAO,KAAK,EAAE,MAAM,YAAY,GAAG,IAAI,SAAS,uBAAuB,MAAM,sBAAA,CAAuB;AAAA,QACrG;AACA,YAAI,UAAU,QAAQ,UAAU,QAAW;AAC1C,mBAAS,KAAK,EAAE,MAAM,YAAY,GAAG,IAAI,SAAS,uCAAuC,MAAM,qBAAA,CAAsB;AAAA,QACtH;AAAA,MACD;AAAA,IACD;AAAA,EACD;AACA,MAAI,KAAK,aAAa;AACrB,QAAI,CAAC,MAAM,QAAQ,KAAK,WAAW,GAAG;AACrC,aAAO,KAAK,EAAE,MAAM,eAAe,SAAS,gCAAgC,MAAM,4BAA4B;AAAA,IAC/G,OAAO;AACN,WAAK,YAAY,QAAQ,CAAC,YAAY,UAAU;AAC/C,YAAI,CAAC,WAAW,IAAI;AACnB,iBAAO,KAAK,EAAE,MAAM,eAAe,KAAK,QAAQ,SAAS,kCAAkC,MAAM,wBAAA,CAAyB;AAAA,QAC3H;AACA,YAAI,CAAC,WAAW,MAAM;AACrB,iBAAO,KAAK,EAAE,MAAM,eAAe,KAAK,UAAU,SAAS,oCAAoC,MAAM,0BAAA,CAA2B;AAAA,QACjI;AAAA,MACD,CAAC;AAAA,IACF;AAAA,EACD;AACA,MAAI,CAAC,KAAK,YAAY,CAAC,KAAK,aAAa;AACxC,aAAS,KAAK,EAAE,MAAM,QAAQ,SAAS,8CAA8C,MAAM,gBAAgB;AAAA,EAC5G;AACA,SAAO,EAAE,OAAO,OAAO,WAAW,GAAG,QAAQ,SAAA;AAC9C;AAEA,eAAe,gBAAgB,YAA6C;AAC3E,QAAM,YAAwB,CAAA;AAC9B,MAAI,WAAW,UAAU;AACxB,UAAM,kBAAkB,MAAM,eAAA;AAC9B,eAAW,CAAC,KAAK,WAAW,KAAK,OAAO,QAAQ,WAAW,QAAQ,GAAG;AACrE,YAAM,eAAgB,gBAA4C,GAAG;AACrE,UAAI,iBAAiB,QAAW;AAC/B,YAAI,KAAK,UAAU,YAAY,MAAM,KAAK,UAAU,WAAW,GAAG;AACjE,oBAAU,KAAK,EAAE,MAAM,WAAW,KAAK,SAAS,cAAc,QAAQ,aAAa,gBAAgB,YAAA,CAAa;AAAA,QACjH;AAAA,MACD;AAAA,IACD;AAAA,EACD;AACA,SAAO;AACR;AAEA,SAAS,YAAY,SAAkB,UAA4B;AAClE,MAAI,OAAO,YAAY,YAAY,OAAO,aAAa,YAAY,YAAY,QAAQ,aAAa,MAAM;AACzG,QAAI,MAAM,QAAQ,OAAO,KAAK,MAAM,QAAQ,QAAQ,GAAG;AACtD,aAAO,CAAC,GAAG,oBAAI,IAAI,CAAC,GAAG,SAAS,GAAG,QAAQ,CAAC,CAAC;AAAA,IAC9C;AACA,WAAO,EAAE,GAAG,SAAS,GAAG,SAAA;AAAA,EACzB;AACA,SAAO;AACR;AAEA,eAAe,YAAY,YAAwB,SAAwB,WAA8C;AACxH,QAAM,SAAuB,EAAE,SAAS,MAAM,UAAU,GAAG,SAAS,GAAG,QAAQ,GAAG,QAAQ,CAAA,GAAI,UAAA;AAC9F,QAAM,KAAK,MAAA;AAEX,MAAI,CAAC,IAAI;AACR,WAAO,MAAM,kCAAkC;AAC/C,UAAM,IAAI,MAAM,kCAAkC;AAAA,EACnD;AAEA,MAAI,WAAW,UAAU;AACxB,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,WAAW,QAAQ,GAAG;AAC/D,YAAM,WAAW,UAAU,KAAK,CAAC,MAAM,EAAE,QAAQ,GAAG;AACpD,UAAI,UAAU;AACb,YAAI,QAAQ,aAAa,QAAQ;AAChC,iBAAO,MAAM,gCAAgC,GAAG,EAAE;AAClD,iBAAO;AACP;AAAA,QACD;AACA,YAAI,QAAQ,aAAa,SAAS;AACjC,gBAAM,cAAc,YAAY,SAAS,SAAS,SAAS,MAAM;AACjE,cAAI;AACH,kBAAM,GAAG,kBAAkB,IAAI,KAAK,aAAa,QAAQ;AACzD,mBAAO;AAAA,UACR,SAAS,OAAO;AACf,mBAAO,OAAO,KAAK,EAAE,KAAK,SAAS,iBAAiB,QAAQ,MAAM,UAAU,iBAAiB,MAAM,eAAA,CAAgB;AACnH,mBAAO,UAAU;AAAA,UAClB;AACA;AAAA,QACD;AAAA,MACD;AACA,UAAI;AACH,cAAM,GAAG,kBAAkB,IAAI,KAAK,OAAO,QAAQ;AACnD,eAAO;AAAA,MACR,SAAS,OAAO;AACf,eAAO,OAAO,KAAK,EAAE,KAAK,SAAS,iBAAiB,QAAQ,MAAM,UAAU,iBAAiB,MAAM,gBAAA,CAAiB;AACpH,eAAO,UAAU;AAAA,MAClB;AAAA,IACD;AAAA,EACD;AACA,MAAI,OAAO,SAAS;AACnB,4BAAA;AACA,UAAM,EAAE,mBAAA,IAAuB,MAAM,OAAO,6BAAqB,EAAA,KAAA,OAAA,EAAA,CAAA;AACjE,UAAM,mBAAA;AACN,WAAO,KAAK,sDAAsD;AAAA,EACnE;AACA,SAAO,KAAK,oBAAoB,EAAE,UAAU,OAAO,UAAU,SAAS,OAAO,SAAS,QAAQ,OAAO,QAAQ,QAAQ,OAAO,OAAO,QAAQ;AAC3I,SAAO;AACR;AAEA,eAAe,UAAU,QAAgB,UAA0B,QAAqC;AACvG,SAAO,KAAK,oBAAoB;AAAA,IAC/B;AAAA,IACA,WAAW,SAAS;AAAA,IACpB,cAAa,oBAAI,KAAA,GAAO,YAAA;AAAA,IACxB,SAAS,OAAO;AAAA,IAChB,UAAU,OAAO;AAAA,IACjB,SAAS,OAAO;AAAA,IAChB,QAAQ,OAAO;AAAA,IACf,QAAQ,OAAO,OAAO;AAAA,EAAA,CACtB;AACF;AAEO,MAAM,OAAuB,OAAO,EAAE,QAAQ,cAAc;AAClE,MAAI,CAAC,OAAO,MAAM;AACjB,WAAO,KAAK,EAAE,OAAO,eAAA,GAAkB,EAAE,QAAQ,KAAK;AAAA,EACvD;AACA,MAAI;AACH,UAAM,OAAO,MAAM,QAAQ,KAAA;AAC3B,UAAM,aAAyB,KAAK;AACpC,UAAM,UAAyB,KAAK,WAAW,CAAA;AAC/C,UAAM,gBAA+B;AAAA,MACpC,UAAU,QAAQ,YAAY;AAAA,MAC9B,QAAQ,QAAQ,UAAU;AAAA,MAC1B,cAAc,QAAQ,gBAAgB;AAAA,MACtC,mBAAmB,QAAQ;AAAA,IAAA;AAE5B,QAAI,WAAW,oBAAoB,WAAW,oBAAoB;AACjE,UAAI,CAAC,cAAc,mBAAmB;AACrC,eAAO;AAAA,UACN,EAAE,SAAS,OAAO,OAAO,qBAAqB,SAAS,8EAAA;AAAA,UACvD,EAAE,QAAQ,IAAA;AAAA,QAAI;AAAA,MAEhB;AACA,UAAI;AACH,cAAM,qBAAqB,MAAM,qBAAqB,WAAW,oBAAoB,cAAc,iBAAiB;AACpH,mBAAW,WAAW,EAAE,GAAG,WAAW,UAAU,GAAG,mBAAA;AACnD,eAAO,KAAK,aAAa,OAAO,KAAK,kBAAkB,EAAE,MAAM,qBAAqB;AAAA,MACrF,SAAS,cAAc;AACtB,eAAO;AAAA,UACN;AAAA,YACC,SAAS;AAAA,YACT,OAAO;AAAA,YACP,SAAS,wBAAwB,QAAQ,aAAa,UAAU;AAAA,UAAA;AAAA,UAEjE,EAAE,QAAQ,IAAA;AAAA,QAAI;AAAA,MAEhB;AAAA,IACD;AACA,UAAM,aAAa,MAAM,mBAAmB,UAAU;AACtD,QAAI,CAAC,WAAW,OAAO;AACtB,aAAO,KAAK,EAAE,SAAS,OAAO,QAAQ,WAAW,QAAQ,UAAU,WAAW,SAAA,GAAY,EAAE,QAAQ,KAAK;AAAA,IAC1G;AACA,QAAI,cAAc,cAAc;AAC/B,aAAO,KAAK,EAAE,SAAS,MAAM,OAAO,MAAM,QAAQ,WAAW,QAAQ,UAAU,WAAW,SAAA,CAAU;AAAA,IACrG;AACA,UAAM,YAAY,MAAM,gBAAgB,UAAU;AAClD,QAAI,cAAc,QAAQ;AACzB,aAAO,KAAK,EAAE,SAAS,MAAM,QAAQ,MAAM,WAAW,YAAY;AAAA,IACnE;AACA,UAAM,SAAuB,MAAM,YAAY,YAAY,eAAe,SAAS;AACnF,UAAM,UAAU,OAAO,KAAK,KAAK,WAAW,UAAU,MAAM;AAC5D,WAAO;AAAA,MACN;AAAA,QACC,SAAS,OAAO;AAAA,QAChB,UAAU,OAAO;AAAA,QACjB,SAAS,OAAO;AAAA,QAChB,QAAQ,OAAO;AAAA,QACf,WAAW,OAAO;AAAA,QAClB,QAAQ,OAAO;AAAA,QACf,UAAU,WAAW;AAAA,QACrB,UAAU,WAAW;AAAA,MAAA;AAAA,MAEtB,EAAE,QAAQ,OAAO,UAAU,MAAM,IAAA;AAAA,IAAI;AAAA,EAEvC,SAAS,OAAO;AACf,WAAO,MAAM,iBAAiB,KAAK;AACnC,WAAO,KAAK,EAAE,SAAS,OAAO,OAAO,iBAAiB,SAAS,iBAAiB,QAAQ,MAAM,UAAU,gBAAA,GAAmB,EAAE,QAAQ,KAAK;AAAA,EAC3I;AACD;"}