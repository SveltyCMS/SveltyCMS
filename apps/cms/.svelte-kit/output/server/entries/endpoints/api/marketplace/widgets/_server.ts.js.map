{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/marketplace/widgets/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/marketplace/widgets/+server.ts\n * @description API endpoint for browsing marketplace widgets\n */\n\nimport { json, error } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\n// Mock marketplace widgets - replace with actual marketplace API integration\nconst MARKETPLACE_WIDGETS = [\n\t{\n\t\tid: 'premium-gallery',\n\t\tname: 'Premium Gallery',\n\t\tdescription: 'Advanced image gallery with lightbox, zoom, and slideshow features',\n\t\tversion: '2.1.0',\n\t\tauthor: 'WidgetCorp',\n\t\ticon: 'mdi:view-gallery',\n\t\tprice: '$29.99',\n\t\tcategory: 'Media',\n\t\trating: 4.8,\n\t\tdownloads: 1250,\n\t\tscreenshots: ['/marketplace/premium-gallery-1.jpg', '/marketplace/premium-gallery-2.jpg'],\n\t\tdependencies: ['mediaUpload'],\n\t\tcompatibility: '>=1.0.0'\n\t},\n\t{\n\t\tid: 'advanced-calendar',\n\t\tname: 'Advanced Calendar',\n\t\tdescription: 'Full-featured calendar widget with event management and recurring events',\n\t\tversion: '1.5.2',\n\t\tauthor: 'CalendarPro',\n\t\ticon: 'mdi:calendar-multiple',\n\t\tprice: 'Free',\n\t\tcategory: 'Productivity',\n\t\trating: 4.6,\n\t\tdownloads: 890,\n\t\tscreenshots: ['/marketplace/calendar-1.jpg'],\n\t\tdependencies: ['date', 'dateTime'],\n\t\tcompatibility: '>=1.0.0'\n\t},\n\t{\n\t\tid: 'social-media-embed',\n\t\tname: 'Social Media Embed',\n\t\tdescription: 'Embed content from Twitter, Instagram, YouTube, and other social platforms',\n\t\tversion: '3.0.1',\n\t\tauthor: 'SocialWidgets',\n\t\ticon: 'mdi:share-variant',\n\t\tprice: '$19.99',\n\t\tcategory: 'Social',\n\t\trating: 4.9,\n\t\tdownloads: 2100,\n\t\tscreenshots: ['/marketplace/social-1.jpg', '/marketplace/social-2.jpg'],\n\t\tdependencies: [],\n\t\tcompatibility: '>=1.2.0'\n\t},\n\t{\n\t\tid: 'ecommerce-product',\n\t\tname: 'E-commerce Product',\n\t\tdescription: 'Complete product widget with variants, pricing, inventory, and cart integration',\n\t\tversion: '2.3.0',\n\t\tauthor: 'EcommercePlus',\n\t\ticon: 'mdi:shopping',\n\t\tprice: '$49.99',\n\t\tcategory: 'E-commerce',\n\t\trating: 4.7,\n\t\tdownloads: 560,\n\t\tscreenshots: ['/marketplace/ecommerce-1.jpg'],\n\t\tdependencies: ['currency', 'mediaUpload'],\n\t\tcompatibility: '>=1.1.0'\n\t},\n\t{\n\t\tid: 'advanced-form-builder',\n\t\tname: 'Advanced Form Builder',\n\t\tdescription: 'Drag-and-drop form builder with conditional logic and validation rules',\n\t\tversion: '1.8.0',\n\t\tauthor: 'FormMaster',\n\t\ticon: 'mdi:form-select',\n\t\tprice: '$39.99',\n\t\tcategory: 'Forms',\n\t\trating: 4.8,\n\t\tdownloads: 720,\n\t\tscreenshots: ['/marketplace/form-builder-1.jpg'],\n\t\tdependencies: ['input', 'checkbox', 'radio'],\n\t\tcompatibility: '>=1.0.0'\n\t},\n\t{\n\t\tid: 'weather-widget',\n\t\tname: 'Weather Display',\n\t\tdescription: 'Real-time weather information with forecasts and customizable layouts',\n\t\tversion: '1.2.3',\n\t\tauthor: 'WeatherApp',\n\t\ticon: 'mdi:weather-partly-cloudy',\n\t\tprice: 'Free',\n\t\tcategory: 'Information',\n\t\trating: 4.4,\n\t\tdownloads: 1800,\n\t\tscreenshots: ['/marketplace/weather-1.jpg'],\n\t\tdependencies: [],\n\t\tcompatibility: '>=1.0.0'\n\t}\n];\n\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\ttry {\n\t\tconst { user } = locals;\n\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\t// Check permission\n\t\tconst hasWidgetPermission = hasPermissionWithRoles(user, 'api:widgets', locals.roles || []);\n\t\tif (!hasWidgetPermission) {\n\t\t\tlogger.warn(`User ${user._id} denied access to marketplace API due to insufficient permissions`);\n\t\t\tthrow error(403, 'Insufficient permissions');\n\t\t}\n\n\t\t// Get query parameters for filtering/searching\n\t\tconst category = url.searchParams.get('category');\n\t\tconst search = url.searchParams.get('search');\n\t\tconst sort = url.searchParams.get('sort') || 'downloads'; // downloads, rating, name, price\n\t\tconst order = url.searchParams.get('order') || 'desc'; // asc, desc\n\n\t\tlet widgets = [...MARKETPLACE_WIDGETS];\n\n\t\t// Filter by category\n\t\tif (category && category !== 'all') {\n\t\t\twidgets = widgets.filter((w) => w.category.toLowerCase() === category.toLowerCase());\n\t\t}\n\n\t\t// Search functionality\n\t\tif (search) {\n\t\t\tconst searchLower = search.toLowerCase();\n\t\t\twidgets = widgets.filter(\n\t\t\t\t(w) =>\n\t\t\t\t\tw.name.toLowerCase().includes(searchLower) ||\n\t\t\t\t\tw.description.toLowerCase().includes(searchLower) ||\n\t\t\t\t\tw.author.toLowerCase().includes(searchLower)\n\t\t\t);\n\t\t}\n\n\t\t// Sort widgets\n\t\twidgets.sort((a, b) => {\n\t\t\tlet comparison = 0;\n\n\t\t\tswitch (sort) {\n\t\t\t\tcase 'name':\n\t\t\t\t\tcomparison = a.name.localeCompare(b.name);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'rating':\n\t\t\t\t\tcomparison = a.rating - b.rating;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'downloads':\n\t\t\t\t\tcomparison = a.downloads - b.downloads;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'price': {\n\t\t\t\t\tconst priceA = a.price === 'Free' ? 0 : parseFloat(a.price.replace('$', ''));\n\t\t\t\t\tconst priceB = b.price === 'Free' ? 0 : parseFloat(b.price.replace('$', ''));\n\t\t\t\t\tcomparison = priceA - priceB;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn order === 'desc' ? -comparison : comparison;\n\t\t});\n\n\t\tlogger.trace(`Retrieved ${widgets.length} marketplace widgets (filtered: category=${category}, search=${search})`);\n\n\t\treturn json({\n\t\t\twidgets,\n\t\t\ttotal: widgets.length,\n\t\t\tfilters: {\n\t\t\t\tcategory,\n\t\t\t\tsearch,\n\t\t\t\tsort,\n\t\t\t\torder\n\t\t\t}\n\t\t});\n\t} catch (err) {\n\t\tconst message = `Failed to get marketplace widgets: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":[],"mappings":";;;AAWA,MAAM,sBAAsB;AAAA,EAC3B;AAAA,IACC,IAAI;AAAA,IACJ,MAAM;AAAA,IACN,aAAa;AAAA,IACb,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,OAAO;AAAA,IACP,UAAU;AAAA,IACV,QAAQ;AAAA,IACR,WAAW;AAAA,IACX,aAAa,CAAC,sCAAsC,oCAAoC;AAAA,IACxF,cAAc,CAAC,aAAa;AAAA,IAC5B,eAAe;AAAA,EAAA;AAAA,EAEhB;AAAA,IACC,IAAI;AAAA,IACJ,MAAM;AAAA,IACN,aAAa;AAAA,IACb,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,OAAO;AAAA,IACP,UAAU;AAAA,IACV,QAAQ;AAAA,IACR,WAAW;AAAA,IACX,aAAa,CAAC,6BAA6B;AAAA,IAC3C,cAAc,CAAC,QAAQ,UAAU;AAAA,IACjC,eAAe;AAAA,EAAA;AAAA,EAEhB;AAAA,IACC,IAAI;AAAA,IACJ,MAAM;AAAA,IACN,aAAa;AAAA,IACb,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,OAAO;AAAA,IACP,UAAU;AAAA,IACV,QAAQ;AAAA,IACR,WAAW;AAAA,IACX,aAAa,CAAC,6BAA6B,2BAA2B;AAAA,IACtE,cAAc,CAAA;AAAA,IACd,eAAe;AAAA,EAAA;AAAA,EAEhB;AAAA,IACC,IAAI;AAAA,IACJ,MAAM;AAAA,IACN,aAAa;AAAA,IACb,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,OAAO;AAAA,IACP,UAAU;AAAA,IACV,QAAQ;AAAA,IACR,WAAW;AAAA,IACX,aAAa,CAAC,8BAA8B;AAAA,IAC5C,cAAc,CAAC,YAAY,aAAa;AAAA,IACxC,eAAe;AAAA,EAAA;AAAA,EAEhB;AAAA,IACC,IAAI;AAAA,IACJ,MAAM;AAAA,IACN,aAAa;AAAA,IACb,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,OAAO;AAAA,IACP,UAAU;AAAA,IACV,QAAQ;AAAA,IACR,WAAW;AAAA,IACX,aAAa,CAAC,iCAAiC;AAAA,IAC/C,cAAc,CAAC,SAAS,YAAY,OAAO;AAAA,IAC3C,eAAe;AAAA,EAAA;AAAA,EAEhB;AAAA,IACC,IAAI;AAAA,IACJ,MAAM;AAAA,IACN,aAAa;AAAA,IACb,SAAS;AAAA,IACT,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,OAAO;AAAA,IACP,UAAU;AAAA,IACV,QAAQ;AAAA,IACR,WAAW;AAAA,IACX,aAAa,CAAC,4BAA4B;AAAA,IAC1C,cAAc,CAAA;AAAA,IACd,eAAe;AAAA,EAAA;AAEjB;AAEO,MAAM,MAAsB,OAAO,EAAE,KAAK,aAAa;AAC7D,MAAI;AACH,UAAM,EAAE,SAAS;AAEjB,QAAI,CAAC,MAAM;AACV,YAAM,MAAM,KAAK,cAAc;AAAA,IAChC;AAGA,UAAM,sBAAsB,uBAAuB,MAAM,eAAe,OAAO,SAAS,EAAE;AAC1F,QAAI,CAAC,qBAAqB;AACzB,aAAO,KAAK,QAAQ,KAAK,GAAG,mEAAmE;AAC/F,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAGA,UAAM,WAAW,IAAI,aAAa,IAAI,UAAU;AAChD,UAAM,SAAS,IAAI,aAAa,IAAI,QAAQ;AAC5C,UAAM,OAAO,IAAI,aAAa,IAAI,MAAM,KAAK;AAC7C,UAAM,QAAQ,IAAI,aAAa,IAAI,OAAO,KAAK;AAE/C,QAAI,UAAU,CAAC,GAAG,mBAAmB;AAGrC,QAAI,YAAY,aAAa,OAAO;AACnC,gBAAU,QAAQ,OAAO,CAAC,MAAM,EAAE,SAAS,YAAA,MAAkB,SAAS,aAAa;AAAA,IACpF;AAGA,QAAI,QAAQ;AACX,YAAM,cAAc,OAAO,YAAA;AAC3B,gBAAU,QAAQ;AAAA,QACjB,CAAC,MACA,EAAE,KAAK,cAAc,SAAS,WAAW,KACzC,EAAE,YAAY,cAAc,SAAS,WAAW,KAChD,EAAE,OAAO,YAAA,EAAc,SAAS,WAAW;AAAA,MAAA;AAAA,IAE9C;AAGA,YAAQ,KAAK,CAAC,GAAG,MAAM;AACtB,UAAI,aAAa;AAEjB,cAAQ,MAAA;AAAA,QACP,KAAK;AACJ,uBAAa,EAAE,KAAK,cAAc,EAAE,IAAI;AACxC;AAAA,QACD,KAAK;AACJ,uBAAa,EAAE,SAAS,EAAE;AAC1B;AAAA,QACD,KAAK;AACJ,uBAAa,EAAE,YAAY,EAAE;AAC7B;AAAA,QACD,KAAK,SAAS;AACb,gBAAM,SAAS,EAAE,UAAU,SAAS,IAAI,WAAW,EAAE,MAAM,QAAQ,KAAK,EAAE,CAAC;AAC3E,gBAAM,SAAS,EAAE,UAAU,SAAS,IAAI,WAAW,EAAE,MAAM,QAAQ,KAAK,EAAE,CAAC;AAC3E,uBAAa,SAAS;AACtB;AAAA,QACD;AAAA,MAAA;AAGD,aAAO,UAAU,SAAS,CAAC,aAAa;AAAA,IACzC,CAAC;AAED,WAAO,MAAM,aAAa,QAAQ,MAAM,4CAA4C,QAAQ,YAAY,MAAM,GAAG;AAEjH,WAAO,KAAK;AAAA,MACX;AAAA,MACA,OAAO,QAAQ;AAAA,MACf,SAAS;AAAA,QACR;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MAAA;AAAA,IACD,CACA;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,sCAAsC,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACtG,WAAO,MAAM,OAAO;AACpB,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}