{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/active/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/active/+server.ts\n * @description API endpoint for getting active widgets with 3-pillar architecture metadata\n */\nimport { json, error } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestHandler } from './$types';\nimport { widgets, getWidgetFunction, isWidgetCore } from '@shared/stores/widgetStore.svelte';\nimport { cacheService } from '@shared/database/CacheService';\nimport { CacheCategory } from '@shared/database/CacheCategory';\n\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\tconst start = performance.now();\n\tconst { tenantId } = locals;\n\n\ttry {\n\t\t// Support ?refresh=true to bypass cache (useful for debugging)\n\t\tconst forceRefresh = url.searchParams.get('refresh') === 'true';\n\n\t\tif (forceRefresh) {\n\t\t\tlogger.trace('[/api/widgets/active] Force refresh requested, clearing cache', { tenantId });\n\t\t\tawait cacheService.delete('widget:active:all', tenantId);\n\t\t}\n\n\t\t// Try to get from cache first\n\t\tconst cacheKey = 'widget:active:all';\n\t\tconst cachedData = await cacheService.get<any>(cacheKey, tenantId);\n\t\tif (cachedData && !forceRefresh) {\n\t\t\tlogger.trace('[/api/widgets/active] Serving from cache', { tenantId });\n\t\t\treturn json({\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: cachedData,\n\t\t\t\tmessage: 'Active widgets retrieved from cache'\n\t\t\t});\n\t\t}\n\n\t\t// Initialize widgets if not already loaded\n\t\tawait widgets.initialize(tenantId);\n\n\t\t// Get active widgets from database\n\t\tconst dbAdapter = locals.dbAdapter;\n\t\tif (!dbAdapter?.widgets?.getActiveWidgets) {\n\t\t\tlogger.error('Widget database adapter not available');\n\t\t\tthrow error(500, 'Widget database adapter not available');\n\t\t}\n\n\t\tconst result = await dbAdapter.widgets.getActiveWidgets();\n\t\tlogger.trace('[/api/widgets/active] Raw result from getActiveWidgets()', {\n\t\t\ttenantId,\n\t\t\tresultType: Array.isArray(result) ? 'array' : typeof result,\n\t\t\tresultLength: Array.isArray(result) ? result.length : undefined\n\t\t});\n\n\t\tlet widgetNames: string[] = [];\n\t\tif (Array.isArray(result)) {\n\t\t\t// If result is an array, check if it's an array of strings or objects\n\t\t\tif (typeof result[0] === 'string' || result.length === 0) {\n\t\t\t\twidgetNames = result as string[];\n\t\t\t} else if (typeof result[0] === 'object' && 'name' in result[0]) {\n\t\t\t\t// If it's an array of Widget objects, extract the name property\n\t\t\t\twidgetNames = (result as { name: string }[]).map((w) => w.name);\n\t\t\t}\n\t\t} else if (result && typeof result === 'object' && 'success' in result && result.success) {\n\t\t\t// Accept both Widget[] and string[] in result.data\n\t\t\tconst data = (result as { data: unknown }).data;\n\t\t\tif (Array.isArray(data)) {\n\t\t\t\tif (typeof data[0] === 'string' || data.length === 0) {\n\t\t\t\t\twidgetNames = data as string[];\n\t\t\t\t} else if (typeof data[0] === 'object' && 'name' in data[0]) {\n\t\t\t\t\twidgetNames = (data as { name: string }[]).map((w) => w.name);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Ensure core widgets are always included\n\t\t// Use WidgetRegistryService (server-side) instead of widgetStore (client-side) to avoid build issues\n\t\tconst { widgetRegistryService } = await import('@shared/services/WidgetRegistryService');\n\t\tawait widgetRegistryService.initialize();\n\t\tconst allWidgets = widgetRegistryService.getAllWidgets();\n\n\t\tconst uniqueNames = new Set(widgetNames);\n\n\t\tfor (const [name, factory] of allWidgets.entries()) {\n\t\t\tif ((factory as any).__widgetType === 'core') {\n\t\t\t\tuniqueNames.add(name);\n\t\t\t}\n\t\t}\n\n\t\twidgetNames = Array.from(uniqueNames);\n\n\t\tlogger.trace('[/api/widgets/active] Extracted widget names (including core)', {\n\t\t\ttenantId,\n\t\t\tcount: widgetNames.length,\n\t\t\twidgets: widgetNames,\n\t\t\tallRegistryKeys: Array.from(allWidgets.keys()),\n\t\t\tinputWidgetType: allWidgets.get('Input') ? (allWidgets.get('Input') as any).__widgetType : 'NOT_FOUND'\n\t\t});\n\n\t\t// Enrich widget data with metadata from widget functions (3-pillar architecture)\n\t\tconst enrichedWidgets = widgetNames.map((name) => {\n\t\t\tconst widgetFn = getWidgetFunction(name) as any;\n\t\t\treturn {\n\t\t\t\tname,\n\t\t\t\tisCore: isWidgetCore(name),\n\t\t\t\ticon: widgetFn?.Icon || 'mdi:puzzle',\n\t\t\t\tdescription: widgetFn?.Description || '',\n\t\t\t\t// 3-Pillar Architecture metadata\n\t\t\t\tinputComponentPath: widgetFn?.__inputComponentPath || '',\n\t\t\t\tdisplayComponentPath: widgetFn?.__displayComponentPath || '',\n\t\t\t\tdependencies: widgetFn?.__dependencies || []\n\t\t\t};\n\t\t});\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.trace('Retrieved active widgets with metadata', {\n\t\t\ttenantId,\n\t\t\twidgetCount: enrichedWidgets.length,\n\t\t\twidgetNames: enrichedWidgets.map((w) => w.name),\n\t\t\tduration: `${duration.toFixed(2)}ms`\n\t\t});\n\t\tconst responseData = {\n\t\t\twidgets: enrichedWidgets,\n\t\t\ttenantId\n\t\t};\n\n\t\t// Cache the enriched results\n\t\tawait cacheService.setWithCategory(cacheKey, responseData, CacheCategory.WIDGET, tenantId);\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: responseData,\n\t\t\tmessage: 'Active widgets retrieved successfully',\n\t\t\tperformance: { duration: `${duration.toFixed(2)}ms` }\n\t\t});\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to get active widgets: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms` });\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}