{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/settings/public/stream/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/settings/public/stream/+server.ts\n * @description SSE endpoint for real-time settings change notifications\n *\n * Clients connect once and receive notifications only when settings actually change.\n * Much more efficient than polling every 5 seconds.\n */\n\nimport type { RequestHandler } from './$types';\nimport { subscribeToSettingsChanges } from '@shared/utils/server/settingsVersion';\n\nexport const GET: RequestHandler = async () => {\n\tconst stream = new ReadableStream({\n\t\tstart(controller) {\n\t\t\t// Send initial connection message\n\t\t\tcontroller.enqueue(`data: ${JSON.stringify({ type: 'connected' })}\\n\\n`);\n\n\t\t\t// Subscribe to settings changes\n\t\t\tconst unsubscribe = subscribeToSettingsChanges((version) => {\n\t\t\t\tcontroller.enqueue(`data: ${JSON.stringify({ type: 'update', version })}\\n\\n`);\n\t\t\t});\n\n\t\t\t// Keep connection alive with heartbeat every 30 seconds\n\t\t\tconst heartbeat = setInterval(() => {\n\t\t\t\ttry {\n\t\t\t\t\tcontroller.enqueue(`: heartbeat\\n\\n`);\n\t\t\t\t} catch {\n\t\t\t\t\tclearInterval(heartbeat);\n\t\t\t\t}\n\t\t\t}, 30000);\n\n\t\t\t// Cleanup on connection close\n\t\t\treturn () => {\n\t\t\t\tclearInterval(heartbeat);\n\t\t\t\tunsubscribe();\n\t\t\t};\n\t\t}\n\t});\n\n\treturn new Response(stream, {\n\t\theaders: {\n\t\t\t'Content-Type': 'text/event-stream',\n\t\t\t'Cache-Control': 'no-cache',\n\t\t\tConnection: 'keep-alive'\n\t\t}\n\t});\n};\n"],"names":[],"mappings":";AAWO,MAAM,MAAsB,YAAY;AAC9C,QAAM,SAAS,IAAI,eAAe;AAAA,IACjC,MAAM,YAAY;AAEjB,iBAAW,QAAQ,SAAS,KAAK,UAAU,EAAE,MAAM,aAAa,CAAC;AAAA;AAAA,CAAM;AAGvE,YAAM,cAAc,2BAA2B,CAAC,YAAY;AAC3D,mBAAW,QAAQ,SAAS,KAAK,UAAU,EAAE,MAAM,UAAU,SAAS,CAAC;AAAA;AAAA,CAAM;AAAA,MAC9E,CAAC;AAGD,YAAM,YAAY,YAAY,MAAM;AACnC,YAAI;AACH,qBAAW,QAAQ;AAAA;AAAA,CAAiB;AAAA,QACrC,QAAQ;AACP,wBAAc,SAAS;AAAA,QACxB;AAAA,MACD,GAAG,GAAK;AAGR,aAAO,MAAM;AACZ,sBAAc,SAAS;AACvB,oBAAA;AAAA,MACD;AAAA,IACD;AAAA,EAAA,CACA;AAED,SAAO,IAAI,SAAS,QAAQ;AAAA,IAC3B,SAAS;AAAA,MACR,gBAAgB;AAAA,MAChB,iBAAiB;AAAA,MACjB,YAAY;AAAA,IAAA;AAAA,EACb,CACA;AACF;"}