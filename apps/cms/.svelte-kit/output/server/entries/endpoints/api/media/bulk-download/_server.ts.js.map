{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../../shared/utils/src/media/bulkDownload.ts","../../../../../../../../src/routes/api/media/bulk-download/+server.ts"],"sourcesContent":["/**\n * @file src/utils/media/bulkDownload.ts\n * @description Server-side bulk media download as ZIP/TAR.GZ\n *\n * Features:\n * - Simple TAR + GZIP (no external deps)\n * - Safe filename sanitization\n * - Progress-ready (extensible)\n * - Stream to response\n * - Automatic cleanup\n */\n\nimport { createWriteStream, createReadStream } from 'fs';\nimport { pipeline } from 'stream/promises';\nimport { createGzip } from 'zlib';\nimport { join } from 'path';\nimport { mkdir, unlink, stat } from 'fs/promises';\n\nimport type { MediaBase } from './mediaModels';\nimport { logger } from '@shared/utils/logger.server';\n\n/** Minimal TAR creator */\nclass TarBuilder {\n\tentries: { name: string; path: string; size: number }[] = [];\n\n\tadd(name: string, path: string, size: number) {\n\t\tthis.entries.push({ name, path, size });\n\t}\n\n\tasync write(outputPath: string): Promise<void> {\n\t\tconst out = createWriteStream(outputPath);\n\n\t\tfor (const e of this.entries) {\n\t\t\tconst header = Buffer.alloc(512, 0);\n\n\t\t\t// Name (100 bytes)\n\t\t\tBuffer.from(e.name.slice(0, 99)).copy(header, 0);\n\n\t\t\t// Mode, uid, gid\n\t\t\t'0000644 \\0'.split('').forEach((c, i) => header.writeUInt8(c.charCodeAt(0), 100 + i));\n\t\t\t'0000000 \\0'.split('').forEach((c, i) => header.writeUInt8(c.charCodeAt(0), 108 + i));\n\t\t\t'0000000 \\0'.split('').forEach((c, i) => header.writeUInt8(c.charCodeAt(0), 116 + i));\n\n\t\t\t// Size (octal)\n\t\t\tconst sizeOct = e.size.toString(8).padStart(11, '0') + '\\0';\n\t\t\tBuffer.from(sizeOct).copy(header, 124);\n\n\t\t\t// Mtime\n\t\t\tconst mtimeOct =\n\t\t\t\tMath.floor(Date.now() / 1000)\n\t\t\t\t\t.toString(8)\n\t\t\t\t\t.padStart(11, '0') + '\\0';\n\t\t\tBuffer.from(mtimeOct).copy(header, 136);\n\n\t\t\t// Checksum placeholder\n\t\t\t'        '.split('').forEach((c, i) => header.writeUInt8(c.charCodeAt(0), 148 + i));\n\n\t\t\t// Type: regular file\n\t\t\theader[156] = 48; // '0'\n\n\t\t\t// Checksum\n\t\t\tlet sum = 0;\n\t\t\tfor (let i = 0; i < 512; i++) sum += header[i];\n\t\t\tconst chksum = sum.toString(8).padStart(6, '0') + '\\0 ';\n\t\t\tBuffer.from(chksum).copy(header, 148);\n\n\t\t\tout.write(header);\n\n\t\t\t// File data\n\t\t\tconst inStream = createReadStream(e.path);\n\t\t\tawait new Promise((res, rej) => {\n\t\t\t\tinStream.on('error', rej);\n\t\t\t\tinStream.on('end', res);\n\t\t\t\tinStream.pipe(out, { end: false });\n\t\t\t});\n\n\t\t\t// Padding\n\t\t\tconst pad = 512 - (e.size % 512);\n\t\t\tif (pad < 512) out.write(Buffer.alloc(pad));\n\t\t}\n\n\t\t// End of archive\n\t\tout.write(Buffer.alloc(1024));\n\t\tout.end();\n\n\t\tawait new Promise((res, rej) => {\n\t\t\tout.on('finish', res);\n\t\t\tout.on('error', rej);\n\t\t});\n\t}\n}\n\n/** Create TAR.GZ archive */\nexport async function createBulkArchive(files: MediaBase[], outputDir: string): Promise<{ path: string; size: number; filename: string }> {\n\tconst ts = Date.now();\n\tconst tarPath = join(outputDir, `bulk-${ts}.tar`);\n\tconst gzPath = join(outputDir, `bulk-${ts}.tar.gz`);\n\n\ttry {\n\t\tawait mkdir(outputDir, { recursive: true });\n\n\t\tconst tar = new TarBuilder();\n\t\tfor (const f of files) {\n\t\t\tif (!f.path || !f.size) continue;\n\t\t\tconst name = f.filename.replace(/[^a-zA-Z0-9.-]/g, '_');\n\t\t\ttar.add(name, f.path, f.size);\n\t\t}\n\n\t\tawait tar.write(tarPath);\n\n\t\tawait pipeline(createReadStream(tarPath), createGzip({ level: 6 }), createWriteStream(gzPath));\n\n\t\tawait unlink(tarPath);\n\n\t\tconst { size } = await stat(gzPath);\n\n\t\treturn {\n\t\t\tpath: gzPath,\n\t\t\tsize,\n\t\t\tfilename: `media-bulk-${ts}.tar.gz`\n\t\t};\n\t} catch (err) {\n\t\tlogger.error('Bulk archive creation failed', err);\n\t\tawait Promise.allSettled([unlink(tarPath), unlink(gzPath)]);\n\t\tthrow err;\n\t}\n}\n\n/** Stream archive to response */\nexport function streamArchive(archivePath: string, filename: string, setHeader: (name: string, value: string) => void): ReadableStream {\n\tsetHeader('Content-Type', 'application/gzip');\n\tsetHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n\n\tconst nodeStream = createReadStream(archivePath);\n\n\treturn new ReadableStream({\n\t\tstart(controller) {\n\t\t\tnodeStream.on('data', (chunk) => controller.enqueue(chunk));\n\t\t\tnodeStream.on('end', () => controller.close());\n\t\t\tnodeStream.on('error', (err) => controller.error(err));\n\t\t},\n\t\tcancel() {\n\t\t\tnodeStream.destroy();\n\t\t}\n\t});\n}\n\n/** Cleanup archive file */\nexport async function cleanupArchive(path: string): Promise<void> {\n\ttry {\n\t\tawait unlink(path);\n\t} catch (err) {\n\t\tlogger.warn('Archive cleanup failed', { path, error: err });\n\t}\n}\n\n/** Aliases for backward compatibility */\nexport const createBulkDownloadArchive = createBulkArchive;\nexport const streamArchiveToResponse = streamArchive;\n","/**\n * @file src/routes/api/media/bulk-download/+server.ts\n * @description API endpoint for bulk downloading multiple media files as TAR.GZ archive\n *\n * @example POST /api/media/bulk-download\n *\n * Features:\n * - Downloads multiple files as compressed archive\n * - Uses Node.js built-in modules (no external packages)\n * - Streaming for efficient memory usage\n * - Automatic cleanup of temporary files\n */\n\nimport { error } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { createBulkDownloadArchive, streamArchiveToResponse, cleanupArchive } from '@shared/utils/media/bulkDownload';\nimport { dbAdapter } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\nimport type { MediaItem } from '@shared/database/dbInterface';\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\ttry {\n\t\t// Authentication check\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\t// Parse request body\n\t\tconst body = await request.json();\n\t\tconst { fileIds } = body;\n\n\t\tif (!Array.isArray(fileIds) || fileIds.length === 0) {\n\t\t\tthrow error(400, 'Invalid request: fileIds array is required');\n\t\t}\n\n\t\tlogger.info('Bulk download requested', {\n\t\t\tuserId: user._id,\n\t\t\tfileCount: fileIds.length,\n\t\t\ttenantId\n\t\t});\n\n\t\t// Fetch files from database\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database not available');\n\t\t}\n\n\t\tconst filesPromises = fileIds.map(async (id) => {\n\t\t\tif (!dbAdapter) return null;\n\t\t\tconst result = await dbAdapter.crud.findOne<MediaItem>('MediaItem', { _id: id });\n\t\t\tif (result.success && result.data) {\n\t\t\t\treturn result.data;\n\t\t\t}\n\t\t\treturn null;\n\t\t});\n\n\t\tconst files = (await Promise.all(filesPromises)).filter(Boolean) as MediaItem[];\n\t\tif (files.length === 0) {\n\t\t\tthrow error(404, 'No files found');\n\t\t}\n\n\t\tlogger.debug('Files fetched for bulk download', {\n\t\t\trequested: fileIds.length,\n\t\t\tfound: files.length\n\t\t});\n\n\t\t// Create archive\n\t\tconst outputDir = '/tmp/archives';\n\t\tconst archive = await createBulkDownloadArchive(files as unknown as import('@shared/utils/media/mediaModels').MediaBase[], outputDir);\n\t\tlogger.info('Archive created successfully', {\n\t\t\tpath: archive.path,\n\t\t\tsize: archive.size,\n\t\t\tfilename: archive.filename\n\t\t});\n\n\t\t// Stream to response\n\n\t\tconst setHeader = (_name: string, _value: string) => {\n\t\t\t// Headers will be set in Response constructor\n\t\t};\n\t\tconst stream = await streamArchiveToResponse(archive.path, archive.filename, setHeader); // Schedule cleanup after stream ends\n\t\tsetTimeout(() => {\n\t\t\tcleanupArchive(archive.path).catch((err) => {\n\t\t\t\tlogger.warn('Failed to cleanup archive', { error: err, path: archive.path });\n\t\t\t});\n\t\t}, 5000); // Cleanup after 5 seconds\n\n\t\treturn new Response(stream, {\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/gzip',\n\t\t\t\t'Content-Disposition': `attachment; filename=\"${archive.filename}\"`,\n\t\t\t\t'Content-Length': archive.size.toString()\n\t\t\t}\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tconst status = typeof err === 'object' && err !== null && 'status' in err ? (err as { status: number }).status : 500;\n\n\t\tlogger.error('Bulk download failed', {\n\t\t\terror: message,\n\t\t\tuserId: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\tthrow error(status, message);\n\t}\n};\n"],"names":[],"mappings":"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"}