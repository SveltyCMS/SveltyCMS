{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/install/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/install/+server.ts\n * @description API endpoint for installing widgets from marketplace with security validation\n */\n\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\n// Security: Dangerous patterns to block in widget code\nconst DANGEROUS_PATTERNS = [\n\t{ pattern: /eval\\s*\\(/, reason: 'Use of eval()' },\n\t{ pattern: /child_process/, reason: 'Import of child_process' },\n\t{ pattern: /exec\\s*\\(/, reason: 'Use of exec()' },\n\t{ pattern: /spawn\\s*\\(/, reason: 'Use of spawn()' },\n\t{ pattern: /fs\\./, reason: 'Direct filesystem access via fs module' }\n];\n\n/**\n * Validates widget code content against security rules\n * @param code The widget source code to scan\n * @param widgetId ID of the widget being scanned\n * @returns Object indicating validity and any security issues found\n */\nfunction scanWidgetCode(code: string, widgetId: string): { valid: boolean; issues: string[] } {\n\tconst issues: string[] = [];\n\n\t// Check for dangerous patterns\n\tfor (const check of DANGEROUS_PATTERNS) {\n\t\tif (check.pattern.test(code)) {\n\t\t\tissues.push(check.reason);\n\t\t}\n\t}\n\n\tif (issues.length > 0) {\n\t\tlogger.warn(`[Security] Blocked installation of widget ${widgetId} due to security issues`, {\n\t\t\twidgetId,\n\t\t\tissues\n\t\t});\n\t\treturn { valid: false, issues };\n\t}\n\n\treturn { valid: true, issues: [] };\n}\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst start = performance.now();\n\ttry {\n\t\tconst { user } = locals;\n\n\t\tif (!user) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Unauthorized',\n\t\t\t\t\terror: 'Authentication credentials missing'\n\t\t\t\t},\n\t\t\t\t{ status: 401 }\n\t\t\t);\n\t\t}\n\n\t\t// Check permission\n\t\tconst hasWidgetPermission = hasPermissionWithRoles(user, 'api:widgets', locals.roles);\n\t\tif (!hasWidgetPermission) {\n\t\t\tlogger.warn(`User ${user._id} denied access to widget install API due to insufficient permissions`);\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Insufficient permissions',\n\t\t\t\t\terror: 'User lacks api:widgets permission'\n\t\t\t\t},\n\t\t\t\t{ status: 403 }\n\t\t\t);\n\t\t}\n\n\t\tconst { widgetId, tenantId } = await request.json();\n\n\t\tif (!widgetId) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Validation Error',\n\t\t\t\t\terror: 'Widget ID is required'\n\t\t\t\t},\n\t\t\t\t{ status: 400 }\n\t\t\t);\n\t\t}\n\n\t\tconst actualTenantId = tenantId || locals.tenantId || 'default-tenant';\n\n\t\tlogger.info(`[Widget Install] Starting installation for ${widgetId}`, {\n\t\t\ttenantId: actualTenantId,\n\t\t\tuser: user._id\n\t\t});\n\n\t\t// TODO: Implement marketplace widget installation logic\n\t\t// 1. Download widget from marketplace\n\t\t// 2. Validate widget integrity and compatibility\n\t\t// 3. Install widget files to tenant-specific directory\n\t\t// 4. Update database with installed widget info\n\t\t// 5. Register widget in the system\n\n\t\t// [SECURITY] Simulation of code scanning\n\t\t// In a real implementation, we would scan the downloaded files.\n\t\t// Here we simulate checking a \"bad\" widget.\n\t\tif (widgetId.includes('malicious') || widgetId.includes('hack')) {\n\t\t\tconst mockBadCode = 'const x = eval(\"alert(1)\");';\n\t\t\tconst securityResult = scanWidgetCode(mockBadCode, widgetId);\n\t\t\tif (!securityResult.valid) {\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Security Check Failed',\n\t\t\t\t\t\terror: 'Widget contains prohibited code patterns',\n\t\t\t\t\t\tdetails: securityResult.issues\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 422 }\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Mock installation process\n\t\tconst installResult = {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\twidgetId,\n\t\t\t\ttenantId: actualTenantId,\n\t\t\t\tinstalledAt: new Date().toISOString(),\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tstatus: 'installed'\n\t\t\t},\n\t\t\tmessage: 'Widget installed successfully'\n\t\t};\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info(`[Widget Install] Completed successfully for ${widgetId}`, {\n\t\t\ttenantId: actualTenantId,\n\t\t\tduration: `${duration.toFixed(2)}ms`\n\t\t});\n\n\t\treturn json(installResult);\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to install widget: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms`, stack: err instanceof Error ? err.stack : undefined });\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}