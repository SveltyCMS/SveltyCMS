{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../../src/routes/api/collections/[collectionId]/[entryId]/revisions/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/collections/[collectionId]/[entryId]/revisions/+server.ts\n * @description API endpoint for retrieving entry revision history\n *\n * @example: GET /api/collections/posts/123/revisions\n *\n * Features:\n * * Lists all revisions for a specific entry within the current tenant\n * * Provides diff comparison between revisions\n * * Supports pagination for large revision histories\n * * Permission checking for revision access\n */\n\nimport { json, error, type RequestHandler } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\n// Shared logic for retrieving revisions\nimport { getRevisions } from '@shared/services/RevisionService';\n\n// GET: Retrieves revision history for an entry\nexport const GET: RequestHandler = async ({ locals, params, url }) => {\n\tconst start = performance.now();\n\tconst endpoint = `GET /api/collections/${params.collectionId}/${params.entryId}/revisions`;\n\tconst { user, tenantId, dbAdapter } = locals;\n\n\tif (!user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\tif (!dbAdapter) {\n\t\tthrow error(503, 'Service Unavailable: Database service is not properly initialized');\n\t}\n\n\ttry {\n\t\tconst page = parseInt(url.searchParams.get('page') ?? '1', 10);\n\t\tconst limit = parseInt(url.searchParams.get('limit') ?? '10', 10);\n\n\t\t// Fetch schema to pass to shared service\n\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t// @ts-ignore\n\t\tconst { contentManager } = await import('@content/ContentManager');\n\t\tconst schema = await contentManager.getCollectionById(params.collectionId, tenantId);\n\n\t\tif (!schema) {\n\t\t\tthrow error(404, 'Collection not found');\n\t\t}\n\n\t\tconst result = await getRevisions({\n\t\t\tcollection: schema as any,\n\t\t\tentryId: params.entryId,\n\t\t\ttenantId: tenantId || '',\n\t\t\tdbAdapter,\n\t\t\tpage,\n\t\t\tlimit\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tlogger.error(`${endpoint} - Failed to get revisions`, {\n\t\t\t\tcollectionId: params.collectionId,\n\t\t\t\tentryId: params.entryId,\n\t\t\t\terror: result.error?.message || 'Unknown error',\n\t\t\t\tuserId: user._id\n\t\t\t});\n\t\t\tif (result.error?.message === 'Collection not found' || result.error?.message === 'Entry not found') {\n\t\t\t\tthrow error(404, result.error.message);\n\t\t\t}\n\t\t\tthrow error(500, 'Failed to get revisions');\n\t\t}\n\n\t\tconst paginatedResult = result.data;\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info(`Revisions for entry ${params.entryId} in tenant ${tenantId} retrieved in ${duration.toFixed(2)}ms`);\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\trevisions: paginatedResult.items,\n\t\t\t\ttotal: paginatedResult.total,\n\t\t\t\tpage: paginatedResult.page,\n\t\t\t\tlimit: paginatedResult.pageSize,\n\t\t\t\ttotalPages: paginatedResult.total ? Math.ceil(paginatedResult.total / paginatedResult.pageSize) : undefined\n\t\t\t},\n\t\t\tperformance: { duration }\n\t\t});\n\t} catch (e) {\n\t\tif (typeof e === 'object' && e !== null && 'status' in e) throw e;\n\n\t\tconst duration = performance.now() - start;\n\t\tconst errorMsg = e instanceof Error ? e.message : 'Unknown error';\n\t\tlogger.error(`Failed to get revisions for entry ${params.entryId}: ${errorMsg} in ${duration.toFixed(2)}ms`);\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n"],"names":[],"mappings":";;;AAmBO,MAAM,MAAsB,OAAO,EAAE,QAAQ,QAAQ,UAAU;AACrE,QAAM,QAAQ,YAAY,IAAA;AAC1B,QAAM,WAAW,wBAAwB,OAAO,YAAY,IAAI,OAAO,OAAO;AAC9E,QAAM,EAAE,MAAM,UAAU,UAAA,IAAc;AAEtC,MAAI,CAAC,MAAM;AACV,UAAM,MAAM,KAAK,cAAc;AAAA,EAChC;AAEA,MAAI,CAAC,WAAW;AACf,UAAM,MAAM,KAAK,mEAAmE;AAAA,EACrF;AAEA,MAAI;AACH,UAAM,OAAO,SAAS,IAAI,aAAa,IAAI,MAAM,KAAK,KAAK,EAAE;AAC7D,UAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,MAAM,EAAE;AAKhE,UAAM,EAAE,eAAA,IAAmB,MAAM,OAAO,+CAAyB;AACjE,UAAM,SAAS,MAAM,eAAe,kBAAkB,OAAO,cAAc,QAAQ;AAEnF,QAAI,CAAC,QAAQ;AACZ,YAAM,MAAM,KAAK,sBAAsB;AAAA,IACxC;AAEA,UAAM,SAAS,MAAM,aAAa;AAAA,MACjC,YAAY;AAAA,MACZ,SAAS,OAAO;AAAA,MAChB,UAAU,YAAY;AAAA,MACtB;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACA;AAED,QAAI,CAAC,OAAO,SAAS;AACpB,aAAO,MAAM,GAAG,QAAQ,8BAA8B;AAAA,QACrD,cAAc,OAAO;AAAA,QACrB,SAAS,OAAO;AAAA,QAChB,OAAO,OAAO,OAAO,WAAW;AAAA,QAChC,QAAQ,KAAK;AAAA,MAAA,CACb;AACD,UAAI,OAAO,OAAO,YAAY,0BAA0B,OAAO,OAAO,YAAY,mBAAmB;AACpG,cAAM,MAAM,KAAK,OAAO,MAAM,OAAO;AAAA,MACtC;AACA,YAAM,MAAM,KAAK,yBAAyB;AAAA,IAC3C;AAEA,UAAM,kBAAkB,OAAO;AAC/B,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,WAAO,KAAK,uBAAuB,OAAO,OAAO,cAAc,QAAQ,iBAAiB,SAAS,QAAQ,CAAC,CAAC,IAAI;AAE/G,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,QACL,WAAW,gBAAgB;AAAA,QAC3B,OAAO,gBAAgB;AAAA,QACvB,MAAM,gBAAgB;AAAA,QACtB,OAAO,gBAAgB;AAAA,QACvB,YAAY,gBAAgB,QAAQ,KAAK,KAAK,gBAAgB,QAAQ,gBAAgB,QAAQ,IAAI;AAAA,MAAA;AAAA,MAEnG,aAAa,EAAE,SAAA;AAAA,IAAS,CACxB;AAAA,EACF,SAAS,GAAG;AACX,QAAI,OAAO,MAAM,YAAY,MAAM,QAAQ,YAAY,EAAG,OAAM;AAEhE,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,UAAM,WAAW,aAAa,QAAQ,EAAE,UAAU;AAClD,WAAO,MAAM,qCAAqC,OAAO,OAAO,KAAK,QAAQ,OAAO,SAAS,QAAQ,CAAC,CAAC,IAAI;AAC3G,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;"}