{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../../shared/utils/src/media/advancedSearch.ts","../../../../../../../../src/routes/api/media/search/+server.ts"],"sourcesContent":["/**\n * @file src/utils/media/advancedSearch.ts\n * @description Advanced client-side media search with filtering & suggestions\n */\n\nimport type { MediaBase, MediaImage } from './mediaModels';\n\nexport interface SearchCriteria {\n\t// Text\n\tfilename?: string;\n\ttags?: string[];\n\n\t// Dimensions (images)\n\tminWidth?: number;\n\tmaxWidth?: number;\n\tminHeight?: number;\n\tmaxHeight?: number;\n\taspectRatio?: 'landscape' | 'portrait' | 'square';\n\n\t// File\n\tminSize?: number; // bytes\n\tmaxSize?: number;\n\tfileTypes?: string[]; // MIME types\n\n\t// Dates\n\tuploadedAfter?: Date;\n\tuploadedBefore?: Date;\n\n\t// Metadata\n\thasEXIF?: boolean;\n\tcamera?: string;\n\tlocation?: string;\n\n\t// Duplicates\n\tshowDuplicatesOnly?: boolean;\n\thashMatch?: string;\n\tdominantColor?: string;\n}\n\nexport interface SearchResult {\n\tfiles: MediaBase[];\n\ttotal: number;\n\tmatched: string[];\n}\n\n/** Advanced search with detailed matched criteria */\nexport function advancedSearch(files: MediaBase[], criteria: SearchCriteria): SearchResult {\n\tconst matched: string[] = [];\n\tconst result: MediaBase[] = [];\n\n\tfor (const file of files) {\n\t\tlet ok = true;\n\n\t\tif (criteria.filename) {\n\t\t\tok &&= file.filename.toLowerCase().includes(criteria.filename.toLowerCase());\n\t\t\tif (ok) matched.push(`Filename: \"${criteria.filename}\"`);\n\t\t}\n\n\t\tif (criteria.tags?.length) {\n\t\t\tconst fileTags = (file.metadata?.tags as string[] | undefined) ?? [];\n\t\t\tok &&= criteria.tags.every((t) => fileTags.some((ft) => ft.toLowerCase() === t.toLowerCase()));\n\t\t\tif (ok) matched.push(`Tags: ${criteria.tags.join(', ')}`);\n\t\t}\n\n\t\t// Image-specific\n\t\tif ('width' in file && 'height' in file) {\n\t\t\tconst img = file as MediaImage;\n\n\t\t\tif (criteria.minWidth !== undefined) ok &&= img.width! >= criteria.minWidth;\n\t\t\tif (criteria.maxWidth !== undefined) ok &&= img.width! <= criteria.maxWidth;\n\t\t\tif (criteria.minHeight !== undefined) ok &&= img.height! >= criteria.minHeight;\n\t\t\tif (criteria.maxHeight !== undefined) ok &&= img.height! <= criteria.maxHeight;\n\n\t\t\tif (criteria.aspectRatio && img.width && img.height) {\n\t\t\t\tconst ratio = img.width / img.height;\n\t\t\t\tconst isLandscape = ratio > 1.1;\n\t\t\t\tconst isPortrait = ratio < 0.9;\n\t\t\t\tconst isSquare = ratio >= 0.9 && ratio <= 1.1;\n\n\t\t\t\tok &&= criteria.aspectRatio === 'landscape' ? isLandscape : criteria.aspectRatio === 'portrait' ? isPortrait : isSquare;\n\n\t\t\t\tif (ok) matched.push(`Aspect: ${criteria.aspectRatio}`);\n\t\t\t}\n\t\t}\n\n\t\tif (criteria.minSize !== undefined) ok &&= (file.size ?? 0) >= criteria.minSize;\n\t\tif (criteria.maxSize !== undefined) ok &&= (file.size ?? 0) <= criteria.maxSize;\n\n\t\tif (criteria.fileTypes?.length) ok &&= criteria.fileTypes.includes(file.mimeType);\n\n\t\tif (criteria.uploadedAfter) ok &&= new Date(file.createdAt) >= criteria.uploadedAfter;\n\t\tif (criteria.uploadedBefore) ok &&= new Date(file.createdAt) <= criteria.uploadedBefore;\n\n\t\tif (criteria.hasEXIF !== undefined) ok &&= !!file.metadata?.exif === criteria.hasEXIF;\n\n\t\tif (criteria.camera) {\n\t\t\tconst exif = file.metadata?.exif as { Make?: string; Model?: string } | undefined;\n\t\t\tconst cam = `${exif?.Make ?? ''} ${exif?.Model ?? ''}`.trim().toLowerCase();\n\t\t\tok &&= cam.includes(criteria.camera.toLowerCase());\n\t\t}\n\n\t\tif (criteria.location) {\n\t\t\tconst exif = file.metadata?.exif as { GPSLatitude?: number; GPSLongitude?: number; location?: string } | undefined;\n\t\t\tconst loc = (exif?.location ?? '').toLowerCase();\n\t\t\tok &&= loc.includes(criteria.location.toLowerCase());\n\t\t}\n\n\t\tif (criteria.showDuplicatesOnly) {\n\t\t\tconst dupCount = files.filter((f) => f.hash === file.hash).length;\n\t\t\tok &&= dupCount > 1;\n\t\t}\n\n\t\tif (criteria.dominantColor) {\n\t\t\tconst metadata = file.metadata as { dominantColor?: string } | undefined;\n\t\t\tok &&= !!metadata?.dominantColor && metadata.dominantColor.toLowerCase().includes(criteria.dominantColor.toLowerCase());\n\t\t}\n\n\t\tif (ok) result.push(file);\n\t}\n\n\treturn {\n\t\tfiles: result,\n\t\ttotal: result.length,\n\t\tmatched: [...new Set(matched)]\n\t};\n}\n\n/** Search suggestions from media library */\nexport function getSuggestions(files: MediaBase[]) {\n\tconst tags = new Set<string>();\n\tconst cameras = new Set<string>();\n\tconst dimensions = new Map<string, number>();\n\n\tfor (const file of files) {\n\t\t(file.metadata?.tags as string[] | undefined)?.forEach((t) => tags.add(t));\n\n\t\tconst exif = file.metadata?.exif as { Make?: string; Model?: string } | undefined;\n\t\tif (exif) {\n\t\t\tconst cam = `${exif.Make ?? ''} ${exif.Model ?? ''}`.trim();\n\t\t\tif (cam) cameras.add(cam);\n\t\t}\n\n\t\tif ('width' in file && 'height' in file) {\n\t\t\tconst key = `${file.width}x${file.height}`;\n\t\t\tdimensions.set(key, (dimensions.get(key) ?? 0) + 1);\n\t\t}\n\t}\n\n\treturn {\n\t\ttags: Array.from(tags).sort(),\n\t\tcameras: Array.from(cameras).sort(),\n\t\tcommonDimensions: Array.from(dimensions.entries())\n\t\t\t.sort((a, b) => b[1] - a[1])\n\t\t\t.slice(0, 10)\n\t\t\t.map(([dim]) => dim),\n\t\tsizeRanges: [\n\t\t\t{ min: 0, max: 100_000, label: '< 100 KB' },\n\t\t\t{ min: 100_000, max: 1_000_000, label: '100 KB – 1 MB' },\n\t\t\t{ min: 1_000_000, max: 5_000_000, label: '1 – 5 MB' },\n\t\t\t{ min: 5_000_000, max: 10_000_000, label: '5 – 10 MB' },\n\t\t\t{ min: 10_000_000, max: Infinity, label: '> 10 MB' }\n\t\t]\n\t};\n}\n\n/** Alias for backward compatibility */\nexport const getSearchSuggestions = getSuggestions;\n\n/** Human-readable bytes */\nexport function formatBytes(bytes: number): string {\n\tif (bytes === 0) return '0 B';\n\tconst units = ['B', 'KB', 'MB', 'GB'];\n\tconst i = Math.floor(Math.log(bytes) / Math.log(1024));\n\treturn `${(bytes / Math.pow(1024, i)).toFixed(1)} ${units[i]}`;\n}\n","/**\n * @file src/routes/api/media/search/+server.ts\n * @description API endpoint for advanced media search with multiple criteria\n *\n * @example POST /api/media/search\n *\n * Features:\n * - Multi-criteria search (dimensions, EXIF, dates, etc.)\n * - Search suggestions\n * - Filters by file properties\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { advancedSearch, getSearchSuggestions, type SearchCriteria } from '@shared/utils/media/advancedSearch';\nimport { dbAdapter } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\nimport type { MediaItem } from '@shared/database/dbInterface';\nimport type { MediaBase } from '@shared/utils/media/mediaModels';\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\ttry {\n\t\t// Authentication check\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database adapter not initialized');\n\t\t}\n\n\t\tconst body = await request.json();\n\t\tconst { criteria } = body as { criteria: SearchCriteria };\n\n\t\tif (!criteria || typeof criteria !== 'object') {\n\t\t\tthrow error(400, 'Invalid request: search criteria is required');\n\t\t}\n\n\t\tlogger.info('Advanced search requested', {\n\t\t\tuserId: user._id,\n\t\t\tcriteria: Object.keys(criteria),\n\t\t\ttenantId\n\t\t});\n\n\t\t// Fetch all media files\n\t\tconst result = await dbAdapter.crud.findMany<MediaItem>('MediaItem', {});\n\n\t\tif (!result.success) {\n\t\t\tthrow error(500, 'Failed to fetch media files');\n\t\t}\n\n\t\tconst files = result.data as unknown as MediaBase[];\n\n\t\t// Perform advanced search\n\t\tconst searchResult = advancedSearch(files, criteria);\n\n\t\tlogger.info('Advanced search completed', {\n\t\t\ttotalFiles: files.length,\n\t\t\tmatchedFiles: searchResult.files.length,\n\t\t\tmatchedCriteria: searchResult.matched\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\t...searchResult\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tconst status = typeof err === 'object' && err !== null && 'status' in err ? (err as { status: number }).status : 500;\n\n\t\tlogger.error('Advanced search failed', {\n\t\t\terror: message,\n\t\t\tuserId: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\tthrow error(status, message);\n\t}\n};\n\nexport const GET: RequestHandler = async ({ locals }) => {\n\tconst { user, tenantId } = locals;\n\n\ttry {\n\t\t// Authentication check\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database adapter not initialized');\n\t\t}\n\n\t\tlogger.info('Search suggestions requested', { userId: user._id, tenantId });\n\n\t\t// Fetch all media files\n\t\tconst result = await dbAdapter.crud.findMany<MediaItem>('MediaItem', {});\n\n\t\tif (!result.success) {\n\t\t\tthrow error(500, 'Failed to fetch media files');\n\t\t}\n\n\t\tconst files = result.data as unknown as MediaBase[];\n\n\t\t// Get search suggestions\n\t\tconst suggestions = getSearchSuggestions(files);\n\n\t\tlogger.info('Search suggestions generated', {\n\t\t\ttags: suggestions.tags.length,\n\t\t\tcameras: suggestions.cameras.length,\n\t\t\tdimensions: suggestions.commonDimensions.length\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tsuggestions\n\t\t});\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tconst status = typeof err === 'object' && err !== null && 'status' in err ? (err as { status: number }).status : 500;\n\n\t\tlogger.error('Failed to get search suggestions', {\n\t\t\terror: message,\n\t\t\tuserId: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\tthrow error(status, message);\n\t}\n};\n"],"names":[],"mappings":"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"}