{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/telemetry/report/+server.ts"],"sourcesContent":["/*\n * @files api/telemetry/report/+server.ts\n * @description Telemetry Report Proxy\n *\n * ### Features\n * - Admin/Guest Access\n * - Forward to telemetry.sveltycms.com\n *\n * ### Security\n * - Input validation with Valibot schema\n * - Payload size limits (10KB max)\n * - Request timeout protection (5s)\n * - Server-side data enrichment\n * - Fail silently - telemetry should never break the app\n *\n * ### Performance\n * - Response caching (12h TTL per version)\n * - LRU cache eviction (max 100 entries)\n */\nimport { json, error } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { object, string, optional, safeParse, maxLength, pipe, boolean, number, union, array } from 'valibot';\nimport { createHash, createHmac } from 'node:crypto';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestEvent } from './$types';\n\n// Telemetry payload validation schema\nconst telemetrySchema = object({\n\tcurrent_version: pipe(string(), maxLength(20)), // âœ… Required\n\tnode_version: optional(pipe(string(), maxLength(20))),\n\tos: optional(pipe(string(), maxLength(20))),\n\tenvironment: optional(pipe(string(), maxLength(20))),\n\tis_ephemeral: optional(boolean()),\n\tinstallation_id: optional(pipe(string(), maxLength(64))),\n\tstable_id: optional(pipe(string(), maxLength(64))),\n\tdb_type: optional(pipe(string(), maxLength(20))),\n\tlocation: optional(\n\t\tobject({\n\t\t\tcountry: optional(pipe(string(), maxLength(128))),\n\t\t\tcountry_code: optional(pipe(string(), maxLength(2))),\n\t\t\tregion: optional(pipe(string(), maxLength(128))),\n\t\t\tcity: optional(pipe(string(), maxLength(128))),\n\t\t\tlatitude: optional(number()),\n\t\t\tlongitude: optional(number()),\n\t\t\tisp: optional(pipe(string(), maxLength(128))),\n\t\t\torg: optional(pipe(string(), maxLength(128)))\n\t\t})\n\t),\n\tusage_metrics: optional(\n\t\tobject({\n\t\t\tusers: optional(number()),\n\t\t\tcollections: optional(number()),\n\t\t\troles: optional(number())\n\t\t})\n\t),\n\tsystem_info: optional(\n\t\tobject({\n\t\t\tcpu_count: optional(number()),\n\t\t\tcpu_model: optional(string()),\n\t\t\ttotal_memory_gb: optional(number()),\n\t\t\tos_type: optional(string()),\n\t\t\tos_release: optional(string()),\n\t\t\tos_arch: optional(string())\n\t\t})\n\t),\n\twidgets: optional(union([pipe(string(), maxLength(5000)), array(string())])),\n\ttimestamp: optional(number()),\n\tsignature: optional(string())\n});\n\n// Response cache with TTL\n// Default TTL: 12 hours (Ecology Standard)\nconst responseCache = new Map<string, { data: any; timestamp: number }>();\nconst CACHE_TTL = 12 * 60 * 60 * 1000; // 12 hours\nconst MAX_CACHE_SIZE = 100;\nconst MAX_PAYLOAD_SIZE = 10000; // 10KB\nconst REQUEST_TIMEOUT = 5000; // 5 seconds\n\nexport async function POST({ request }: RequestEvent) {\n\t// 1. Check telemetry setting\n\tconst telemetryEnabled = await getPrivateSettingSync('SVELTYCMS_TELEMETRY');\n\n\tif (telemetryEnabled === false) {\n\t\treturn json({ status: 'disabled' }, { status: 200 });\n\t}\n\n\ttry {\n\t\t// 2. Payload size limit check (prevent DoS)\n\t\tconst contentLength = request.headers.get('content-length');\n\t\tif (contentLength && parseInt(contentLength) > MAX_PAYLOAD_SIZE) {\n\t\t\tlogger.warn('Telemetry payload too large:', contentLength);\n\t\t\tthrow error(413, 'Payload too large');\n\t\t}\n\n\t\t// 3. Parse and validate input\n\t\tconst rawData = await request.json();\n\t\tconst validation = safeParse(telemetrySchema, rawData);\n\n\t\tif (!validation.success) {\n\t\t\tlogger.warn('Invalid telemetry payload'); // simplified log\n\t\t\tthrow error(400, 'Invalid payload');\n\t\t}\n\n\t\tconst data = validation.output;\n\t\tconst currentVersion = data.current_version;\n\n\t\t// 4. Check cache first (based on version)\n\t\tconst cacheKey = `v${currentVersion}`;\n\t\tconst cached = responseCache.get(cacheKey);\n\n\t\tif (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n\t\t\treturn json(cached.data, {\n\t\t\t\theaders: { 'X-Cache': 'HIT' }\n\t\t\t});\n\t\t}\n\n\t\t// 5. Build forwarding payload with HMAC signature\n\t\tconst jwtSecret = (await getPrivateSettingSync('JWT_SECRET_KEY')) || 'fallback_secret';\n\t\tconst installationId = data.installation_id || createHash('sha256').update(jwtSecret).digest('hex');\n\t\tconst timestamp = data.timestamp || Date.now();\n\t\tconst current_version = data.current_version;\n\n\t\t// Recompute signature to ensure authenticity\n\t\tconst TELEMETRY_SALT = 'sveltycms-telemetry';\n\t\tconst signature = createHmac('sha256', TELEMETRY_SALT).update(`${installationId}:${current_version}:${timestamp}`).digest('hex');\n\n\t\tconst forwardData = {\n\t\t\t...data,\n\t\t\tinstallation_id: installationId,\n\t\t\ttimestamp,\n\t\t\tsignature\n\t\t};\n\n\t\t// 6. Timeout protection (prevent hanging)\n\t\tconst controller = new AbortController();\n\t\tconst timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);\n\n\t\tconst telemetryEndpoint = process.env.TELEMETRY_ENDPOINT || 'https://telemetry.sveltycms.com/api/check-update';\n\t\tconst response = await fetch(telemetryEndpoint, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t'User-Agent': 'SveltyCMS-Telemetry/1.0'\n\t\t\t},\n\t\t\tbody: JSON.stringify(forwardData),\n\t\t\tsignal: controller.signal\n\t\t});\n\n\t\tclearTimeout(timeoutId);\n\n\t\tif (!response.ok) {\n\t\t\tlogger.warn(`Telemetry upstream failed: ${response.status}`);\n\t\t\tthrow new Error('Telemetry server unreachable');\n\t\t}\n\n\t\tconst result = await response.json();\n\n\t\t// 7. Validate response (don't trust upstream)\n\t\tif (typeof result !== 'object' || result === null) {\n\t\t\tthrow new Error('Invalid upstream response');\n\t\t}\n\n\t\t// 8. Cache successful response\n\t\tresponseCache.set(cacheKey, {\n\t\t\tdata: result,\n\t\t\ttimestamp: Date.now()\n\t\t});\n\n\t\t// 9. LRU eviction (limit cache size)\n\t\tif (responseCache.size > MAX_CACHE_SIZE) {\n\t\t\tconst oldestKey = Array.from(responseCache.keys())[0];\n\t\t\tresponseCache.delete(oldestKey);\n\t\t}\n\n\t\treturn json(result, {\n\t\t\theaders: { 'X-Cache': 'MISS' }\n\t\t});\n\t} catch (err) {\n\t\t// Fail silently but log for monitoring\n\t\tif (err instanceof Error) {\n\t\t\tif (err.name === 'AbortError') {\n\t\t\t\tlogger.warn('Telemetry request timeout');\n\t\t\t} else {\n\t\t\t\tlogger.error(`Telemetry error: ${err.message}`);\n\t\t\t}\n\t\t}\n\t\treturn json({ status: 'error' }, { status: 200 });\n\t}\n}\n"],"names":[],"mappings":"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"}