{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/auth/2fa/backup-codes/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/auth/2fa/backup-codes/+server.ts\n * @description API endpoint for managing backup codes\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { getDefaultTwoFactorAuthService } from '@shared/database/auth/twoFactorAuth';\nimport { auth } from '@shared/database/db';\n\n// GET - Get 2FA status including backup codes count\nexport const GET: RequestHandler = async ({ locals }) => {\n\ttry {\n\t\t// Ensure user is authenticated\n\t\tif (!locals.user) {\n\t\t\tlogger.warn('Unauthorized 2FA status request');\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tconst user = locals.user;\n\t\tconst tenantId = user.tenantId;\n\n\t\t// Ensure auth service is initialized\n\t\tif (!auth) {\n\t\t\tlogger.error('Auth service not initialized during 2FA status request');\n\t\t\tthrow error(500, 'Auth service not available');\n\t\t}\n\n\t\tconst twoFactorService = getDefaultTwoFactorAuthService(auth.authInterface);\n\t\tconst status = await twoFactorService.get2FAStatus(user._id, tenantId);\n\n\t\tlogger.debug('2FA status retrieved', { userId: user._id, tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: status\n\t\t});\n\t} catch (err) {\n\t\tconst message = `Failed to get 2FA status: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\n\t\tif (err instanceof Response) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, 'Failed to get 2FA status');\n\t}\n};\n\n// POST - Regenerate backup codes\nexport const POST: RequestHandler = async ({ locals }) => {\n\ttry {\n\t\t// Ensure user is authenticated\n\t\tif (!locals.user) {\n\t\t\tlogger.warn('Unauthorized backup code regeneration attempt');\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tconst user = locals.user;\n\t\tconst tenantId = user.tenantId;\n\n\t\t// Check if 2FA is enabled\n\t\tif (!user.is2FAEnabled) {\n\t\t\tlogger.warn('Backup code regeneration attempted for user without 2FA enabled', {\n\t\t\t\tuserId: user._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\tthrow error(400, '2FA is not enabled for this account');\n\t\t}\n\n\t\t// Ensure auth service is initialized\n\t\tif (!auth) {\n\t\t\tlogger.error('Auth service not initialized during backup code regeneration');\n\t\t\tthrow error(500, 'Auth service not available');\n\t\t}\n\n\t\t// Regenerate backup codes\n\t\tconst twoFactorService = getDefaultTwoFactorAuthService(auth.authInterface);\n\t\tconst newBackupCodes = await twoFactorService.regenerateBackupCodes(user._id, tenantId);\n\n\t\tlogger.info('Backup codes regenerated', { userId: user._id, tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tbackupCodes: newBackupCodes\n\t\t\t},\n\t\t\tmessage: 'New backup codes generated. Please save these codes in a secure location. Your old backup codes are no longer valid.'\n\t\t});\n\t} catch (err) {\n\t\tconst message = `Backup code regeneration failed: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\n\t\tif (err instanceof Response) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, 'Failed to regenerate backup codes');\n\t}\n};\n"],"names":[],"mappings":";;;;AAYO,MAAM,MAAsB,OAAO,EAAE,aAAa;AACxD,MAAI;AAEH,QAAI,CAAC,OAAO,MAAM;AACjB,aAAO,KAAK,iCAAiC;AAC7C,YAAM,MAAM,KAAK,yBAAyB;AAAA,IAC3C;AAEA,UAAM,OAAO,OAAO;AACpB,UAAM,WAAW,KAAK;AAGtB,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,wDAAwD;AACrE,YAAM,MAAM,KAAK,4BAA4B;AAAA,IAC9C;AAEA,UAAM,mBAAmB,+BAA+B,KAAK,aAAa;AAC1E,UAAM,SAAS,MAAM,iBAAiB,aAAa,KAAK,KAAK,QAAQ;AAErE,WAAO,MAAM,wBAAwB,EAAE,QAAQ,KAAK,KAAK,UAAU;AAEnE,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,IAAA,CACN;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,6BAA6B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC7F,WAAO,MAAM,OAAO;AAEpB,QAAI,eAAe,UAAU;AAC5B,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,0BAA0B;AAAA,EAC5C;AACD;AAGO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AAEH,QAAI,CAAC,OAAO,MAAM;AACjB,aAAO,KAAK,+CAA+C;AAC3D,YAAM,MAAM,KAAK,yBAAyB;AAAA,IAC3C;AAEA,UAAM,OAAO,OAAO;AACpB,UAAM,WAAW,KAAK;AAGtB,QAAI,CAAC,KAAK,cAAc;AACvB,aAAO,KAAK,mEAAmE;AAAA,QAC9E,QAAQ,KAAK;AAAA,QACb;AAAA,MAAA,CACA;AACD,YAAM,MAAM,KAAK,qCAAqC;AAAA,IACvD;AAGA,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,8DAA8D;AAC3E,YAAM,MAAM,KAAK,4BAA4B;AAAA,IAC9C;AAGA,UAAM,mBAAmB,+BAA+B,KAAK,aAAa;AAC1E,UAAM,iBAAiB,MAAM,iBAAiB,sBAAsB,KAAK,KAAK,QAAQ;AAEtF,WAAO,KAAK,4BAA4B,EAAE,QAAQ,KAAK,KAAK,UAAU;AAEtE,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,QACL,aAAa;AAAA,MAAA;AAAA,MAEd,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,oCAAoC,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACpG,WAAO,MAAM,OAAO;AAEpB,QAAI,eAAe,UAAU;AAC5B,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,mCAAmC;AAAA,EACrD;AACD;"}