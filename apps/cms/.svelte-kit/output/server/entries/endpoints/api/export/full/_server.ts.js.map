{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/export/full/+server.ts"],"sourcesContent":["import { json, type RequestHandler } from '@sveltejs/kit';\nimport { getAllSettings } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { encryptData } from '@shared/utils/crypto';\nimport { nanoid } from 'nanoid';\nimport type { ExportOptions, ExportData, ExportMetadata, CollectionExport, Schema } from '@cms-types';\nimport { dbAdapter } from '@shared/database/db';\nimport { collections } from '@shared/stores/collectionStore.svelte';\n\n// Sensitive field patterns\nconst SENSITIVE_PATTERNS: string[] = [\n\t'PASSWORD',\n\t'SECRET',\n\t'TOKEN',\n\t'KEY',\n\t'CLIENT_SECRET',\n\t'PRIVATE_KEY',\n\t'JWT_SECRET',\n\t'ENCRYPTION_KEY',\n\t'API_KEY'\n];\n\n/**\n * Encrypt data using AES-256-GCM with Argon2-derived key\n * Uses enterprise-grade cryptography from shared utils\n */\nasync function encryptSensitiveData(data: Record<string, unknown>, password: string): Promise<string> {\n\treturn encryptData(data, password);\n}\n\n/**\n * Check if a field key is sensitive\n */\nfunction isSensitiveField(key: string): boolean {\n\tconst upperKey = key.toUpperCase();\n\treturn SENSITIVE_PATTERNS.some((pattern) => upperKey.includes(pattern));\n}\n\n/**\n * Export all settings, separating sensitive data\n */\nasync function exportSettings(options: ExportOptions): Promise<{ settings: Record<string, unknown>; sensitive: Record<string, unknown> }> {\n\tlogger.info('Exporting settings', { options });\n\n\tconst allSettings = await getAllSettings();\n\tconst settings: Record<string, unknown> = {};\n\tconst sensitive: Record<string, unknown> = {};\n\n\tfor (const [key, value] of Object.entries(allSettings)) {\n\t\tif (isSensitiveField(key)) {\n\t\t\tif (options.includeSensitive) {\n\t\t\t\t// Separate sensitive data for encryption\n\t\t\t\tsensitive[key] = value;\n\t\t\t\tlogger.trace(`Collected sensitive field for encryption: ${key}`);\n\t\t\t} else {\n\t\t\t\tlogger.trace(`Skipping sensitive field: ${key}`);\n\t\t\t}\n\t\t} else {\n\t\t\t// Non-sensitive data goes directly to settings\n\t\t\tsettings[key] = value;\n\t\t}\n\t}\n\n\tlogger.info(`Exported ${Object.keys(settings).length} regular settings, ${Object.keys(sensitive).length} sensitive settings`);\n\treturn { settings, sensitive };\n}\n\n/**\n * Export all collection schemas and data\n */\nasync function exportCollections(options: ExportOptions): Promise<CollectionExport[]> {\n\tlogger.info('Exporting collections', { options });\n\n\tconst availableCollections = (collections as any).all as Record<string, Schema>;\n\tconst exportedCollections: CollectionExport[] = [];\n\n\t// Filter collections if specified\n\tconst targetCollections = options.collections\n\t\t? Object.values(availableCollections).filter((c) => c.name && options.collections?.includes(c.name))\n\t\t: Object.values(availableCollections);\n\n\tfor (const collection of targetCollections) {\n\t\tconst collectionExport: CollectionExport = {\n\t\t\tid: collection._id || '',\n\t\t\tname: collection.name || '',\n\t\t\tlabel: collection.label || collection.name || '',\n\t\t\tfields: collection.fields,\n\t\t\tschema: collection,\n\t\t\tdocuments: []\n\t\t};\n\n\t\t// Fetch documents if dbAdapter is available\n\t\tif (dbAdapter) {\n\t\t\ttry {\n\t\t\t\tconst result = await dbAdapter.crud.findMany(`collection_${collection._id}`, {});\n\t\t\t\tif (result.success) {\n\t\t\t\t\tcollectionExport.documents = result.data as unknown as Record<string, unknown>[];\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error(`Failed to export documents for collection ${collection.name}`, error);\n\t\t\t}\n\t\t}\n\n\t\texportedCollections.push(collectionExport);\n\t}\n\n\tlogger.info(`Exported ${exportedCollections.length} collections`);\n\treturn exportedCollections;\n}\n\n/**\n * Create export metadata\n */\nfunction createExportMetadata(userId: string): ExportMetadata {\n\treturn {\n\t\texported_at: new Date().toISOString(),\n\t\tcms_version: process.env.npm_package_version || 'unknown',\n\t\tenvironment: process.env.NODE_ENV || 'development',\n\t\texported_by: userId,\n\t\texport_id: nanoid()\n\t};\n}\n\n/**\n * Create complete export data\n */\nasync function createExport(userId: string, options: ExportOptions): Promise<ExportData> {\n\tlogger.info('Creating export', { userId, options });\n\n\tconst exportData: ExportData = {\n\t\tmetadata: createExportMetadata(userId),\n\t\thasSensitiveData: false\n\t};\n\n\tif (options.includeSettings) {\n\t\tconst { settings, sensitive } = await exportSettings(options);\n\t\texportData.settings = settings;\n\n\t\t// Handle sensitive data encryption\n\t\tif (options.includeSensitive && Object.keys(sensitive).length > 0) {\n\t\t\tif (!options.sensitivePassword) {\n\t\t\t\tthrow new Error('sensitivePassword is required when includeSensitive is true');\n\t\t\t}\n\n\t\t\t// Encrypt sensitive data with password using Argon2-derived key\n\t\t\texportData.encryptedSensitive = await encryptSensitiveData(sensitive, options.sensitivePassword);\n\t\t\texportData.hasSensitiveData = true;\n\n\t\t\tlogger.info(`Encrypted ${Object.keys(sensitive).length} sensitive settings`);\n\t\t}\n\t}\n\n\tif (options.includeCollections) {\n\t\texportData.collections = await exportCollections(options);\n\t}\n\n\tlogger.info('Export created successfully', {\n\t\texport_id: exportData.metadata.export_id,\n\t\thas_settings: !!exportData.settings,\n\t\thas_collections: !!exportData.collections,\n\t\thas_sensitive: exportData.hasSensitiveData\n\t});\n\n\treturn exportData;\n}\n\n/**\n * Export full system configuration\n * POST /api/export/full\n *\n * Exports settings and optionally collections with metadata.\n * Supports filtering by groups/collections and sensitive data inclusion.\n *\n * Permissions: config:settings:read (or admin)\n */\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\t// Check authentication\n\t// Authentication already handled by hooks.server.ts (API_PERMISSIONS)\n\tif (!locals.user) {\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\n\ttry {\n\t\t// Parse export options from request body\n\t\tconst options: ExportOptions = await request.json();\n\n\t\t// Default options if not provided\n\t\tconst exportOptions: ExportOptions = {\n\t\t\tincludeSettings: options.includeSettings ?? true,\n\t\t\tincludeCollections: options.includeCollections ?? false,\n\t\t\tincludeSensitive: options.includeSensitive ?? false,\n\t\t\tformat: options.format ?? 'json',\n\t\t\tgroups: options.groups,\n\t\t\tcollections: options.collections\n\t\t};\n\n\t\t// Create export (use _id as the user identifier)\n\t\tconst exportData = await createExport(locals.user._id, exportOptions);\n\n\t\t// Determine filename\n\t\tconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n\t\tconst environment = exportData.metadata.environment || 'unknown';\n\t\tconst filename = `sveltycms-export-${environment}-${timestamp}.json`;\n\n\t\t// Return export data\n\t\treturn json(exportData, {\n\t\t\tstatus: 200,\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t'Content-Disposition': `attachment; filename=\"${filename}\"`\n\t\t\t}\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Export error:', error);\n\t\treturn json(\n\t\t\t{\n\t\t\t\terror: 'Export failed',\n\t\t\t\tmessage: error instanceof Error ? error.message : 'Unknown error'\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}