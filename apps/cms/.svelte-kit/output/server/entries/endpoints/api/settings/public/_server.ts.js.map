{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/settings/public/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/settings/public/+server.ts\n * @description API endpoint to get all public settings.\n * This is used by the client to fetch updated settings when the version changes.\n */\n\nimport { json } from '@sveltejs/kit';\nimport { dbAdapter } from '@shared/database/db';\nimport { settingsGroups } from '../../../config/settingsGroups';\nimport { defaultPublicSettings } from '@shared/utils/config/defaults';\n\nexport const GET = async () => {\n\t// 1. Get list of public keys from our definitions\n\t// Use a Set for faster lookup if we had many keys, but array is fine here\n\tconst publicKeys = settingsGroups\n\t\t.flatMap((g) => g.fields)\n\t\t.filter((f) => f.category === 'public')\n\t\t.map((f) => f.key);\n\n\t// 2. Initialize with defaults (fast in-memory operation)\n\t// We create a base object with all default values appropriately typed\n\tconst publicSettings: Record<string, unknown> = {};\n\n\t// Create a map of defaults for O(1) access during merge if needed,\n\t// but mostly we just populate the initial state.\n\tfor (const setting of defaultPublicSettings) {\n\t\tif (publicKeys.includes(setting.key)) {\n\t\t\tpublicSettings[setting.key] = setting.value;\n\t\t}\n\t}\n\n\t// 3. If DB is available, fetch overrides in a single batch query\n\tif (dbAdapter?.systemPreferences) {\n\t\ttry {\n\t\t\tconst dbResult = await dbAdapter.systemPreferences.getMany(publicKeys);\n\n\t\t\tif (dbResult.success && dbResult.data) {\n\t\t\t\tfor (const key of publicKeys) {\n\t\t\t\t\tconst dbEntry = dbResult.data[key];\n\t\t\t\t\tif (dbEntry !== undefined) {\n\t\t\t\t\t\t// Handle wrapped values (legacy or metadata-rich format) vs raw values\n\t\t\t\t\t\t// SveltyCMS sometimes stores settings as { value: ..., category: ... }\n\t\t\t\t\t\tconst val = dbEntry !== null && typeof dbEntry === 'object' && 'value' in dbEntry ? (dbEntry as { value: unknown }).value : dbEntry;\n\n\t\t\t\t\t\t// Debug logging for languages\n\t\t\t\t\t\tif (key === 'AVAILABLE_CONTENT_LANGUAGES') {\n\t\t\t\t\t\t\tconsole.log('[SettingsAPI] Found languages in DB:', val);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Type safety check for arrays (like languages) to ensure we don't return malformed data\n\t\t\t\t\t\tif (key === 'AVAILABLE_CONTENT_LANGUAGES' || key === 'LOCALES') {\n\t\t\t\t\t\t\tif (Array.isArray(val)) {\n\t\t\t\t\t\t\t\tpublicSettings[key] = val;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconsole.warn(`[SettingsAPI] Expected array for ${key} but got:`, typeof val);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tpublicSettings[key] = val;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\t// Fail gracefully - user gets defaults if DB fails\n\t\t\tconsole.error('[SettingsAPI] Failed to fetch overrides:', error);\n\t\t}\n\t}\n\n\t// 4. Return JSON response\n\t// setting cache-control to ensure freshness while avoiding hammering\n\treturn json(publicSettings, {\n\t\theaders: {\n\t\t\t'Cache-Control': 'public, max-age=30' // Cache for 30s\n\t\t}\n\t});\n};\n"],"names":[],"mappings":";;;AAWO,MAAM,MAAM,YAAY;AAG9B,QAAM,aAAa,eACjB,QAAQ,CAAC,MAAM,EAAE,MAAM,EACvB,OAAO,CAAC,MAAM,EAAE,aAAa,QAAQ,EACrC,IAAI,CAAC,MAAM,EAAE,GAAG;AAIlB,QAAM,iBAA0C,CAAA;AAIhD,aAAW,WAAW,uBAAuB;AAC5C,QAAI,WAAW,SAAS,QAAQ,GAAG,GAAG;AACrC,qBAAe,QAAQ,GAAG,IAAI,QAAQ;AAAA,IACvC;AAAA,EACD;AAGA,MAAI,WAAW,mBAAmB;AACjC,QAAI;AACH,YAAM,WAAW,MAAM,UAAU,kBAAkB,QAAQ,UAAU;AAErE,UAAI,SAAS,WAAW,SAAS,MAAM;AACtC,mBAAW,OAAO,YAAY;AAC7B,gBAAM,UAAU,SAAS,KAAK,GAAG;AACjC,cAAI,YAAY,QAAW;AAG1B,kBAAM,MAAM,YAAY,QAAQ,OAAO,YAAY,YAAY,WAAW,UAAW,QAA+B,QAAQ;AAG5H,gBAAI,QAAQ,+BAA+B;AAC1C,sBAAQ,IAAI,wCAAwC,GAAG;AAAA,YACxD;AAGA,gBAAI,QAAQ,iCAAiC,QAAQ,WAAW;AAC/D,kBAAI,MAAM,QAAQ,GAAG,GAAG;AACvB,+BAAe,GAAG,IAAI;AAAA,cACvB,OAAO;AACN,wBAAQ,KAAK,oCAAoC,GAAG,aAAa,OAAO,GAAG;AAAA,cAC5E;AAAA,YACD,OAAO;AACN,6BAAe,GAAG,IAAI;AAAA,YACvB;AAAA,UACD;AAAA,QACD;AAAA,MACD;AAAA,IACD,SAAS,OAAO;AAEf,cAAQ,MAAM,4CAA4C,KAAK;AAAA,IAChE;AAAA,EACD;AAIA,SAAO,KAAK,gBAAgB;AAAA,IAC3B,SAAS;AAAA,MACR,iBAAiB;AAAA;AAAA,IAAA;AAAA,EAClB,CACA;AACF;"}