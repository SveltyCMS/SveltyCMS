{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/sendMail/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/sendMail/+server.ts\n * @description API endpoint for rendering and sending emails using Svelte templates and Nodemailer.\n *\n * This module provides functionality to:\n * - Receive a request to send an email based on a template.\n * - Render email content using Svelte components and better-svelte-email.\n * - Send emails using Nodemailer with SMTP configuration from environment variables.\n * - Support multiple email templates and dynamic props.\n * - Handle internationalization for email content (basic structure).\n *\n * Features:\n * - Template-based email rendering with Tailwind CSS.\n * - SMTP configuration using environment variables.\n * - Support for plain text and HTML email content.\n * - Language-specific email content (via props and template logic).\n * - Robust error handling and logging.\n *\n * Usage:\n * POST /api/sendMail\n * Body (JSON):\n * {\n * \"recipientEmail\": \"test@example.com\",\n * \"subject\": \"Your Subject Here\",\n * \"templateName\": \"welcomeUser\", // Key from the 'templates' object\n * \"props\": { ... } // Props to pass to the Svelte email component\n * }\n *\n * Note: Ensure SMTP configuration (SMTP_HOST, SMTP_PORT, SMTP_EMAIL, SMTP_PASSWORD)\n * is properly set in environment variables for successful email delivery.\n */\n\nimport { json, error as svelteKitError } from '@sveltejs/kit';\nimport type { ComponentType } from 'svelte';\nimport type { RequestHandler } from './$types';\n\n// Database adapter for SMTP configuration\nimport { dbAdapter } from '@shared/database/db';\n\n// Permissions\n\n// Nodemailer for actual email sending\nimport nodemailer from 'nodemailer';\nimport type { TransportOptions } from 'nodemailer';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Svelte SSR rendering\nimport { render } from 'svelte/server';\n\n// --- Dynamic Email Template Imports ---\n// This will find all .svelte files in the specified directory\nconst svelteEmailModules = import.meta.glob('/src/components/emails/*.svelte');\n\n// Props that your email templates might accept.\nexport interface EmailTemplateProps {\n\tsitename?: string;\n\tusername?: string;\n\temail?: string; // This 'email' prop is for template data, distinct from recipient 'email'\n\trole?: string;\n\ttoken?: string;\n\texpires_in?: string;\n\texpiresIn?: string | Date; // Can be string or Date\n\texpiresInLabel?: string;\n\thostLink?: string;\n\tresetLink?: string;\n\ttokenLink?: string;\n\t// Add any other props your templates might use\n\t[key: string]: unknown; // Allow other props\n}\n\n// Function to get a specific email template component dynamically\nasync function getEmailTemplate(templateName: string): Promise<ComponentType | null> {\n\tconst path = `/src/components/emails/${templateName}.svelte`;\n\tconst moduleImporter = svelteEmailModules[path];\n\n\tif (moduleImporter) {\n\t\ttry {\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\tconst module = (await moduleImporter()) as any;\n\t\t\t// Assuming the default export is the Svelte component\n\t\t\treturn module.default as ComponentType;\n\t\t} catch (e) {\n\t\t\tlogger.error(`Failed to import email template '${templateName}' from path '${path}':`, e);\n\t\t\treturn null;\n\t\t}\n\t}\n\tlogger.warn(`Email template '${templateName}' not found at path '${path}'. Available modules:`, Object.keys(svelteEmailModules));\n\treturn null;\n}\n\ntype RenderedEmailContent = { html: string; text: string };\n\n// Renders a Svelte email component to HTML and plain text\nconst renderEmailToStrings = async (\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tcomponent: any,\n\ttemplateNameForLog: string,\n\tprops?: EmailTemplateProps\n): Promise<RenderedEmailContent> => {\n\ttry {\n\t\t// Use Svelte's server-side render function\n\t\tconst result = render(component, { props: props || {} });\n\t\t// Extract HTML and create a simple text version\n\n\t\tconst html = result.body;\n\t\t// Create a simple text version by stripping HTML tags\n\t\tconst text = html\n\t\t\t.replace(/<[^>]*>/g, '')\n\t\t\t.replace(/\\s+/g, ' ')\n\t\t\t.trim();\n\n\t\treturn { html, text };\n\t} catch (err) {\n\t\tconst renderError = err as Error;\n\t\tlogger.error('Failed to render email template to string:', {\n\t\t\ttemplateName: templateNameForLog,\n\t\t\terror: renderError.message,\n\t\t\tstack: renderError.stack\n\t\t});\n\t\tthrow new Error(`Email template '${templateNameForLog}' rendering failed: ${renderError.message}`);\n\t}\n};\n\n// Generates a standardized JSON error response\nfunction createErrorResponse(message: string, status: number = 500): never {\n\tlogger.error(`API Error in /api/sendMail (${status}): ${message}`);\n\tthrow svelteKitError(status, message);\n}\n\n// --- POST Handler ---\nexport const POST: RequestHandler = async ({ request, locals }): Promise<Response> => {\n\tconst { user, tenantId } = locals;\n\t// Check for internal API calls (from createToken API)\n\tconst isInternalCall = request.headers.get('x-internal-call') === 'true';\n\t// Check sendMail permissions (skip for internal calls)\n\tif (!isInternalCall) {\n\t\t// Authentication is handled by hooks.server.ts - user presence confirms access\n\n\t\tlogger.debug(`User '${user?.email || 'Unknown'}' calling /api/sendMail`, { tenantId });\n\t} else {\n\t\tlogger.debug('Internal API call to /api/sendMail', { tenantId });\n\t}\n\n\tlet requestBody: {\n\t\trecipientEmail: string;\n\t\tsubject: string;\n\t\ttemplateName: string;\n\t\tprops?: EmailTemplateProps;\n\t\tlanguageTag?: string; // Optional language tag from client\n\t};\n\n\ttry {\n\t\trequestBody = await request.json();\n\t} catch (error) {\n\t\tlogger.error('Invalid JSON in request body:', { error, tenantId });\n\t\treturn createErrorResponse('Invalid JSON in request body.', 400);\n\t}\n\n\tconst { recipientEmail, subject, templateName, props = {}, languageTag = 'en' } = requestBody;\n\t// Basic input validation\n\tif (!recipientEmail || !subject || !templateName) {\n\t\treturn createErrorResponse('Missing required fields: recipientEmail, subject, or templateName.', 400);\n\t}\n\tif (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(recipientEmail)) {\n\t\treturn createErrorResponse('Invalid recipient email address format.', 400);\n\t} // 1. Get the email template component dynamically\n\n\tconst SelectedTemplateComponent = await getEmailTemplate(templateName);\n\tif (!SelectedTemplateComponent) {\n\t\tconst availableTemplateNames = Object.keys(svelteEmailModules).map((path) => path.split('/').pop()?.replace('.svelte', ''));\n\t\treturn createErrorResponse(`Invalid email template name: '${templateName}'. Available templates: ${availableTemplateNames.join(', ')}`, 400);\n\t}\n\n\tif (!dbAdapter) {\n\t\tlogger.error('Database adapter is not initialized');\n\t\treturn createErrorResponse('Database adapter is not available', 500);\n\t}\n\n\t// Validate SMTP configuration from database settings\n\tconst smtpHostResult = await dbAdapter.systemPreferences.get<string>('SMTP_HOST', 'system');\n\tconst smtpPortResult = await dbAdapter.systemPreferences.get<string>('SMTP_PORT', 'system');\n\tconst smtpUserResult = await dbAdapter.systemPreferences.get<string>('SMTP_USER', 'system');\n\tconst smtpPassResult = await dbAdapter.systemPreferences.get<string>('SMTP_PASS', 'system');\n\n\tconst smtpHost = smtpHostResult?.success ? smtpHostResult.data : null;\n\tconst smtpPort = smtpPortResult?.success ? smtpPortResult.data : null;\n\tconst smtpUser = smtpUserResult?.success ? smtpUserResult.data : null;\n\tconst smtpPass = smtpPassResult?.success ? smtpPassResult.data : null;\n\n\tconst missingVars: string[] = [];\n\tif (!smtpHost) missingVars.push('SMTP_HOST');\n\tif (!smtpPort) missingVars.push('SMTP_PORT');\n\tif (!smtpUser) missingVars.push('SMTP_USER');\n\tif (!smtpPass) missingVars.push('SMTP_PASS');\n\tif (missingVars.length > 0) {\n\t\tlogger.warn('SMTP configuration incomplete. Email sending skipped.', {\n\t\t\tmissingVars,\n\t\t\ttenantId\n\t\t});\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'SMTP settings not configured. Please configure email settings in System Settings to enable email notifications.',\n\t\t\tdev_mode: true,\n\t\t\tmissing_config: missingVars,\n\t\t\tsmtp_not_configured: true,\n\t\t\tuser_message: 'Email notifications are not configured yet. Please contact your administrator to set up SMTP settings.'\n\t\t});\n\t}\n\n\t// If SMTP host is a known dummy/placeholder, skip sending in dev-friendly way\n\tconst dummyHost = String(smtpHost || '').toLowerCase();\n\tif (/dummy|example|\\.invalid$/.test(dummyHost)) {\n\t\tlogger.warn('SMTP host appears to be a placeholder; skipping email send.', { host: smtpHost, tenantId });\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'Email sending skipped due to dummy SMTP host (development mode).',\n\t\t\tdev_mode: true,\n\t\t\tdummy_host: smtpHost\n\t\t});\n\t}\n\t// Enhance props with languageTag if your templates expect it\n\n\tconst templateProps = {\n\t\t...props,\n\t\tlanguageTag: languageTag\n\t};\n\t// 2. Render email content (HTML and Text)\n\n\tlet emailHtml: string, emailText: string;\n\ttry {\n\t\tconst rendered = await renderEmailToStrings(SelectedTemplateComponent, templateName, templateProps);\n\t\temailHtml = rendered.html;\n\t\temailText = rendered.text;\n\t} catch (renderErr) {\n\t\treturn createErrorResponse((renderErr as Error).message, 500);\n\t}\n\t// 3. Configure Nodemailer Transporter\n\tconst smtpPortNum = Number(smtpPort);\n\tconst secureConnection = smtpPortNum === 465;\n\n\tconst transporter = nodemailer.createTransport({\n\t\thost: smtpHost,\n\t\tport: smtpPortNum,\n\t\tsecure: secureConnection,\n\t\tauth: {\n\t\t\tuser: smtpUser,\n\t\t\tpass: smtpPass\n\t\t},\n\t\ttls: {\n\t\t\trejectUnauthorized: process.env.NODE_ENV === 'development' ? false : true\n\t\t},\n\t\tdebug: process.env.NODE_ENV === 'development'\n\t} as TransportOptions);\n\t// 4. Define Mail Options\n\n\tconst fromName = props?.sitename || 'SveltyCMS';\n\tconst smtpMailFromResult = await dbAdapter.systemPreferences.get<string>('SMTP_MAIL_FROM', 'system');\n\tconst mailFrom = (smtpMailFromResult?.success ? smtpMailFromResult.data : null) || smtpUser;\n\tconst mailOptions = {\n\t\tfrom: `\"${fromName}\" <${mailFrom}>`,\n\t\tto: recipientEmail,\n\t\tsubject: subject,\n\t\ttext: emailText,\n\t\thtml: emailHtml\n\t};\n\t// 5. Send Email\n\ttry {\n\t\tconst info = await transporter.sendMail(mailOptions);\n\t\tlogger.info('Email sent successfully via Nodemailer from /api/sendMail:', {\n\t\t\trecipientEmail,\n\t\t\tsubject,\n\t\t\ttemplateName,\n\t\t\tmessageId: info.messageId,\n\t\t\ttenantId\n\t\t});\n\t\treturn json({ success: true, message: 'Email sent successfully.' });\n\t} catch (err) {\n\t\tconst sendError = err as Error;\n\t\tlogger.error('Nodemailer failed to send email from /api/sendMail:', {\n\t\t\trecipientEmail,\n\t\t\tsubject,\n\t\t\ttemplateName,\n\t\t\terror: sendError.message,\n\t\t\ttenantId\n\t\t});\n\t\treturn createErrorResponse(`Email sending failed: ${sendError.message}`, 500);\n\t}\n};\n"],"names":["svelteKitError","error"],"mappings":"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"}