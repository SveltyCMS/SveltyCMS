{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/media/get/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/get/+server.ts\n * @description\n * API endpoint for retrieving media files, scoped to the current tenant.\n *\n * @example GET /api/media/get?url=https://example.com/image.jpg\n *\n * Features:\n * - Centralized permission checking for media access\n * - Requires authentication and media read permissions\n * - Admin override for unrestricted access\n * - Secure, tenant-aware file retrieval with proper headers\n */\n\nimport type { RequestHandler } from './$types';\nimport { error } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Permissions\n\n// Media\nimport { getFile } from '@shared/utils/media/mediaStorage.server';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\tconst { user, tenantId } = locals;\n\n\t// Authentication is handled by hooks.server.ts\n\tif (!user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t}\n\n\ttry {\n\t\tconst fileUrl = url.searchParams.get('url');\n\t\tif (!fileUrl) {\n\t\t\tthrow error(400, 'URL parameter is required');\n\t\t}\n\n\t\t// Retrieve the file from storage\n\t\tconst buffer = await getFile(fileUrl);\n\n\t\tlogger.debug('Media file retrieved successfully', {\n\t\t\tfileUrl,\n\t\t\tfileSize: buffer.length,\n\t\t\tuserId: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\treturn new Response(new Uint8Array(buffer), {\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/octet-stream',\n\t\t\t\t'Content-Disposition': `attachment; filename=\"${fileUrl.split('/').pop()}\"`,\n\t\t\t\t'Content-Length': buffer.length.toString()\n\t\t\t}\n\t\t});\n\t} catch (err) {\n\t\tconst message = `Error retrieving file: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, {\n\t\t\tfileUrl: url.searchParams.get('url'),\n\t\t\tuserId: user?._id,\n\t\t\ttenantId\n\t\t});\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":[],"mappings":";;;;AA0BO,MAAM,MAAsB,OAAO,EAAE,KAAK,aAAa;AAC7D,QAAM,EAAE,MAAM,SAAA,IAAa;AAG3B,MAAI,CAAC,MAAM;AACV,UAAM,MAAM,KAAK,cAAc;AAAA,EAChC;AAEA,MAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,UAAM,MAAM,KAAK,oDAAoD;AAAA,EACtE;AAEA,MAAI;AACH,UAAM,UAAU,IAAI,aAAa,IAAI,KAAK;AAC1C,QAAI,CAAC,SAAS;AACb,YAAM,MAAM,KAAK,2BAA2B;AAAA,IAC7C;AAGA,UAAM,SAAS,MAAM,QAAQ,OAAO;AAEpC,WAAO,MAAM,qCAAqC;AAAA,MACjD;AAAA,MACA,UAAU,OAAO;AAAA,MACjB,QAAQ,MAAM;AAAA,MACd;AAAA,IAAA,CACA;AAED,WAAO,IAAI,SAAS,IAAI,WAAW,MAAM,GAAG;AAAA,MAC3C,SAAS;AAAA,QACR,gBAAgB;AAAA,QAChB,uBAAuB,yBAAyB,QAAQ,MAAM,GAAG,EAAE,KAAK;AAAA,QACxE,kBAAkB,OAAO,OAAO,SAAA;AAAA,MAAS;AAAA,IAC1C,CACA;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,0BAA0B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC1F,WAAO,MAAM,SAAS;AAAA,MACrB,SAAS,IAAI,aAAa,IAAI,KAAK;AAAA,MACnC,QAAQ,MAAM;AAAA,MACd;AAAA,IAAA,CACA;AACD,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}