{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/system/version/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/system/version/+server.ts\n * @description API endpoint for checking system version and security updates.\n */\nimport { json, type RequestHandler } from '@sveltejs/kit';\nimport pkg from '@root/package.json';\n\n// In-memory cache to prevent hitting GitHub API rate limits\nlet cachedRelease = {\n\ttag: '',\n\ttimestamp: 0\n};\nconst CACHE_CHLL = 1000 * 60 * 60; // 1 hour\n\nexport const GET: RequestHandler = async () => {\n\t// Return cached version if valid\n\tif (cachedRelease.tag && Date.now() - cachedRelease.timestamp < CACHE_CHLL) {\n\t\treturn json({\n\t\t\tstatus: 'active',\n\t\t\tlatest: cachedRelease.tag,\n\t\t\tsecurity_issue: false,\n\t\t\tmessage: ''\n\t\t});\n\t}\n\n\ttry {\n\t\tconst response = await fetch('https://api.github.com/repos/SveltyCMS/SveltyCMS/releases/latest', {\n\t\t\theaders: { 'User-Agent': 'SveltyCMS-Instance' },\n\t\t\tsignal: AbortSignal.timeout(5000) // 5 second timeout\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(`GitHub API Error: ${response.status}`);\n\t\t}\n\n\t\tconst data = await response.json();\n\t\tconst latestVersion = data.tag_name.replace(/^v/, '');\n\n\t\t// Update cache\n\t\tcachedRelease = {\n\t\t\ttag: latestVersion,\n\t\t\ttimestamp: Date.now()\n\t\t};\n\n\t\treturn json({\n\t\t\tstatus: 'active',\n\t\t\tlatest: latestVersion,\n\t\t\tsecurity_issue: false,\n\t\t\tmessage: ''\n\t\t});\n\t} catch (error) {\n\t\tconsole.error('GitHub version check failed:', error);\n\t\t// Fallback to local version on error\n\t\treturn json({\n\t\t\tstatus: 'error',\n\t\t\tlatest: pkg.version,\n\t\t\tsecurity_issue: false,\n\t\t\tmessage: 'Could not connect to GitHub'\n\t\t});\n\t}\n};\n"],"names":[],"mappings":";;AAQA,IAAI,gBAAgB;AAAA,EACnB,KAAK;AAAA,EACL,WAAW;AACZ;AACA,MAAM,aAAa,MAAO,KAAK;AAExB,MAAM,MAAsB,YAAY;AAE9C,MAAI,cAAc,OAAO,KAAK,QAAQ,cAAc,YAAY,YAAY;AAC3E,WAAO,KAAK;AAAA,MACX,QAAQ;AAAA,MACR,QAAQ,cAAc;AAAA,MACtB,gBAAgB;AAAA,MAChB,SAAS;AAAA,IAAA,CACT;AAAA,EACF;AAEA,MAAI;AACH,UAAM,WAAW,MAAM,MAAM,oEAAoE;AAAA,MAChG,SAAS,EAAE,cAAc,qBAAA;AAAA,MACzB,QAAQ,YAAY,QAAQ,GAAI;AAAA;AAAA,IAAA,CAChC;AAED,QAAI,CAAC,SAAS,IAAI;AACjB,YAAM,IAAI,MAAM,qBAAqB,SAAS,MAAM,EAAE;AAAA,IACvD;AAEA,UAAM,OAAO,MAAM,SAAS,KAAA;AAC5B,UAAM,gBAAgB,KAAK,SAAS,QAAQ,MAAM,EAAE;AAGpD,oBAAgB;AAAA,MACf,KAAK;AAAA,MACL,WAAW,KAAK,IAAA;AAAA,IAAI;AAGrB,WAAO,KAAK;AAAA,MACX,QAAQ;AAAA,MACR,QAAQ;AAAA,MACR,gBAAgB;AAAA,MAChB,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,OAAO;AACf,YAAQ,MAAM,gCAAgC,KAAK;AAEnD,WAAO,KAAK;AAAA,MACX,QAAQ;AAAA,MACR,QAAQ,IAAI;AAAA,MACZ,gBAAgB;AAAA,MAChB,SAAS;AAAA,IAAA,CACT;AAAA,EACF;AACD;"}