{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/metrics/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/metrics/+server.ts\n * @description Unified metrics API endpoint for monitoring and observability\n *\n * ### Features\n * - Comprehensive system metrics from unified MetricsService\n * - Prometheus-compatible format support\n * - Admin-only access with proper authorization\n * - Multiple output formats (JSON, Prometheus)\n * - Real-time performance data\n *\n * ### Endpoints\n * - `GET /api/metrics` - JSON format metrics\n * - `GET /api/metrics?format=prometheus` - Prometheus format\n * - `POST /api/metrics/reset` - Reset metrics (admin only)\n *\n * @monitoring Provides enterprise-grade metrics for system monitoring\n */\n\nimport { json, type RequestHandler } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport { metricsService } from '@shared/services/MetricsService';\nimport { error } from '@sveltejs/kit';\n\n/**\n * GET /api/metrics\n * Returns comprehensive system metrics\n */\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\t// Check authentication\n\tif (!locals.user) {\n\t\tthrow error(401, 'Authentication required');\n\t}\n\n\t// Check admin permissions for metrics access\n\tif (!locals.isAdmin) {\n\t\tthrow error(403, 'Admin privileges required to access metrics');\n\t}\n\n\tconst format = url.searchParams.get('format') || 'json';\n\n\ttry {\n\t\tif (format === 'prometheus') {\n\t\t\t// Return Prometheus-formatted metrics\n\t\t\tconst prometheusMetrics = metricsService.exportPrometheus();\n\n\t\t\treturn new Response(prometheusMetrics, {\n\t\t\t\tstatus: 200,\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'text/plain; version=0.0.4; charset=utf-8',\n\t\t\t\t\t'Cache-Control': 'no-cache, no-store, must-revalidate'\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Default: Return JSON metrics\n\t\tconst report = metricsService.getReport();\n\n\t\treturn json(report, {\n\t\t\theaders: {\n\t\t\t\t'Cache-Control': 'no-cache, no-store, must-revalidate'\n\t\t\t}\n\t\t});\n\t} catch (err) {\n\t\tlogger.error('Error retrieving metrics:', err);\n\t\tthrow error(500, 'Failed to retrieve metrics');\n\t}\n};\n\n/**\n * POST /api/metrics/reset\n * Resets all metrics counters (admin only)\n */\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\t// Check authentication\n\tif (!locals.user) {\n\t\tthrow error(401, 'Authentication required');\n\t}\n\n\t// Check admin permissions\n\tif (!locals.isAdmin) {\n\t\tthrow error(403, 'Admin privileges required to reset metrics');\n\t}\n\n\ttry {\n\t\tconst body = await request.json();\n\n\t\t// Optional: Allow resetting specific metric categories\n\t\tif (body?.action === 'reset') {\n\t\t\tmetricsService.reset();\n\n\t\t\treturn json({\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: 'All metrics have been reset',\n\t\t\t\tresetAt: new Date().toISOString()\n\t\t\t});\n\t\t}\n\n\t\tthrow error(400, 'Invalid action. Use {\"action\": \"reset\"} to reset metrics.');\n\t} catch (err) {\n\t\tif (err instanceof Error && err.message.includes('Invalid action')) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tlogger.error('Error resetting metrics:', err);\n\t\tthrow error(500, 'Failed to reset metrics');\n\t}\n};\n"],"names":[],"mappings":";;;AA4BO,MAAM,MAAsB,OAAO,EAAE,KAAK,aAAa;AAE7D,MAAI,CAAC,OAAO,MAAM;AACjB,UAAM,MAAM,KAAK,yBAAyB;AAAA,EAC3C;AAGA,MAAI,CAAC,OAAO,SAAS;AACpB,UAAM,MAAM,KAAK,6CAA6C;AAAA,EAC/D;AAEA,QAAM,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK;AAEjD,MAAI;AACH,QAAI,WAAW,cAAc;AAE5B,YAAM,oBAAoB,eAAe,iBAAA;AAEzC,aAAO,IAAI,SAAS,mBAAmB;AAAA,QACtC,QAAQ;AAAA,QACR,SAAS;AAAA,UACR,gBAAgB;AAAA,UAChB,iBAAiB;AAAA,QAAA;AAAA,MAClB,CACA;AAAA,IACF;AAGA,UAAM,SAAS,eAAe,UAAA;AAE9B,WAAO,KAAK,QAAQ;AAAA,MACnB,SAAS;AAAA,QACR,iBAAiB;AAAA,MAAA;AAAA,IAClB,CACA;AAAA,EACF,SAAS,KAAK;AACb,WAAO,MAAM,6BAA6B,GAAG;AAC7C,UAAM,MAAM,KAAK,4BAA4B;AAAA,EAC9C;AACD;AAMO,MAAM,OAAuB,OAAO,EAAE,QAAQ,cAAc;AAElE,MAAI,CAAC,OAAO,MAAM;AACjB,UAAM,MAAM,KAAK,yBAAyB;AAAA,EAC3C;AAGA,MAAI,CAAC,OAAO,SAAS;AACpB,UAAM,MAAM,KAAK,4CAA4C;AAAA,EAC9D;AAEA,MAAI;AACH,UAAM,OAAO,MAAM,QAAQ,KAAA;AAG3B,QAAI,MAAM,WAAW,SAAS;AAC7B,qBAAe,MAAA;AAEf,aAAO,KAAK;AAAA,QACX,SAAS;AAAA,QACT,SAAS;AAAA,QACT,UAAS,oBAAI,KAAA,GAAO,YAAA;AAAA,MAAY,CAChC;AAAA,IACF;AAEA,UAAM,MAAM,KAAK,2DAA2D;AAAA,EAC7E,SAAS,KAAK;AACb,QAAI,eAAe,SAAS,IAAI,QAAQ,SAAS,gBAAgB,GAAG;AACnE,YAAM;AAAA,IACP;AAEA,WAAO,MAAM,4BAA4B,GAAG;AAC5C,UAAM,MAAM,KAAK,yBAAyB;AAAA,EAC3C;AACD;"}