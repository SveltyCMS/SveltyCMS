{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/token/batch/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/token/batch/+server.ts\n * @description Unified API endpoint for performing batch actions on tokens.\n *\n * This module provides a single endpoint to perform the following actions on one or more tokens:\n * - Delete tokens\n * - Block tokens\n * - Unblock tokens\n *\n * Each action is protected by its own specific permission and uses the corresponding\n * batch method defined in the authDBInterface for database-agnostic efficiency.\n *\n * @usage\n * POST /api/token/batch\n * @body {\n * \"tokenIds\": [\"id1\", \"id2\"],\n * \"action\": \"delete\"\n * }\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nimport { error, json, type HttpError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\n// Auth\nimport { auth } from '@shared/database/db';\n\n// Validation\nimport { object, parse, picklist, string, type ValiError } from 'valibot';\n\n// Cache invalidation\nimport { cacheService } from '@shared/database/CacheService';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nimport { array } from 'valibot';\n\nconst batchTokenActionSchema = object({\n\ttokenIds: array(string()),\n\taction: picklist(['delete', 'block', 'unblock'], 'Invalid action specified.')\n});\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\ttry {\n\t\tconst { user, tenantId } = locals; // Destructure user and tenantId\n\t\tconst body = await request.json().catch(() => {\n\t\t\tthrow error(400, 'Invalid JSON in request body');\n\t\t});\n\t\tconst parsed = parse(batchTokenActionSchema, body);\n\t\tconst { tokenIds, action } = parsed;\n\t\tif (!Array.isArray(tokenIds) || tokenIds.length === 0) {\n\t\t\tthrow error(400, 'At least one token ID is required.');\n\t\t}\n\t\t// Authentication is handled by hooks.server.ts - user presence confirms access\n\n\t\tif (!auth) {\n\t\t\tlogger.error('Database authentication adapter not initialized');\n\t\t\tthrow error(500, 'Database authentication not available');\n\t\t}\n\n\t\t// --- MULTI-TENANCY SECURITY CHECK ---\n\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\tif (!tenantId) {\n\t\t\t\tthrow error(500, 'Tenant could not be identified for this operation.');\n\t\t\t}\n\t\t\t// Use auth.getAllTokens if available to verify ownership\n\t\t\ttry {\n\t\t\t\tconst filter = { tenantId } as { tenantId?: string };\n\t\t\t\tconst tokensResult = await auth.getAllTokens(filter);\n\t\t\t\tif (!tokensResult.success || !tokensResult.data) {\n\t\t\t\t\tthrow new Error('Failed to retrieve tokens');\n\t\t\t\t}\n\t\t\t\tconst tokenSet = new Set(tokensResult.data.map((t) => t.token));\n\t\t\t\tconst allOwned = tokenIds.every((id) => tokenSet.has(id));\n\t\t\t\tif (!allOwned) {\n\t\t\t\t\tlogger.warn('Attempt to act on tokens outside of tenant', { userId: user?._id, tenantId, requestedTokenIds: tokenIds });\n\t\t\t\t\tthrow error(403, 'Forbidden: One or more tokens do not belong to your tenant or do not exist.');\n\t\t\t\t}\n\t\t\t} catch (verifyErr) {\n\t\t\t\tlogger.error('Failed to verify tenant token ownership', { error: verifyErr });\n\t\t\t\tthrow error(500, 'Failed to verify token ownership');\n\t\t\t}\n\t\t}\n\n\t\tlet successMessage = '';\n\n\t\t// Directly invoke database-agnostic methods (now bound in auth adapter)\n\t\tswitch (action) {\n\t\t\tcase 'delete': {\n\t\t\t\tawait auth.deleteTokens(tokenIds, tenantId);\n\t\t\t\tsuccessMessage = 'Tokens deleted successfully.';\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'block': {\n\t\t\t\tawait auth.blockTokens(tokenIds, tenantId);\n\t\t\t\tsuccessMessage = 'Tokens blocked successfully.';\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'unblock': {\n\t\t\t\tawait auth.unblockTokens(tokenIds, tenantId);\n\t\t\t\tsuccessMessage = 'Tokens unblocked successfully.';\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t// Invalidate the tokens cache so changes appear immediately in admin area\n\t\tcacheService.delete('tokens', tenantId).catch((err) => {\n\t\t\tlogger.warn(`Failed to invalidate tokens cache: ${err.message}`);\n\t\t});\n\n\t\tlogger.info(`Batch token action '${action}' completed.`, {\n\t\t\taffectedIds: tokenIds,\n\t\t\texecutedBy: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\treturn json({ success: true, message: successMessage });\n\t} catch (err) {\n\t\tif (err && typeof err === 'object' && 'name' in err && err.name === 'ValiError') {\n\t\t\tconst valiError = err as ValiError<typeof batchTokenActionSchema>;\n\t\t\tconst issues = valiError.issues.map((issue) => issue.message).join(', ');\n\t\t\tlogger.warn('Invalid input for token batch API:', { issues });\n\t\t\tthrow error(400, `Invalid input: ${issues}`);\n\t\t}\n\t\tconst httpError = err as HttpError;\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'An unexpected error occurred.';\n\t\tlogger.error('Error in token batch API:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\tstatus\n\t\t});\n\t\treturn json({ success: false, message: status === 500 ? 'Internal Server Error' : message }, { status });\n\t}\n};\n"],"names":[],"mappings":"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"}