{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/user/saveAvatar/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/user/saveAvatar/+server.ts\n * @description API endpoint for saving a user's avatar image.\n *\n * This module provides functionality to:\n * - Save a new avatar image for a user\n * - Update the user's profile with the new avatar URL\n *\n * Features:\n * - File upload handling\n * - Avatar image processing and storage\n * - User profile update\n * - **Defense in Depth**: Specific permission checking within the endpoint.\n * - Error handling and logging\n *\n * Usage:\n * POST /api/user/saveAvatar\n * Body: FormData with 'avatar' file\n */\n\nimport { error, json, type HttpError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\n// Config\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Auth and permission helpers\nimport { auth } from '@shared/database/db';\n\n// System logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Media storage\nimport { cacheService } from '@shared/database/CacheService';\nimport { saveAvatarImage, moveMediaToTrash } from '@shared/utils/media/mediaStorage.server';\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\ttry {\n\t\t// Check authentication\n\t\tif (!locals.user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tif (!auth) {\n\t\t\tthrow error(500, 'Authentication system not available');\n\t\t}\n\n\t\t// Check if user is updating their own avatar or has admin permissions\n\t\tconst formData = await request.formData();\n\t\tconst targetUserId = (formData.get('userId') as string) || (formData.get('user_id') as string) || locals.user._id; // Default to self if no userId provided\n\n\t\t// Role-based access is handled by hooks.server.ts\n\t\tconst isEditingSelf = targetUserId === locals.user._id;\n\n\t\t// In multi-tenant mode, ensure target user is in same tenant when editing others\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !isEditingSelf) {\n\t\t\tconst tenantId = locals.tenantId;\n\t\t\tconst targetUser = await auth.getUserById(targetUserId, tenantId);\n\t\t\tif (!targetUser || targetUser.tenantId !== tenantId) {\n\t\t\t\tlogger.warn('Admin attempted to update avatar for user outside their tenant', {\n\t\t\t\t\tadminId: locals.user._id,\n\t\t\t\t\ttargetUserId,\n\t\t\t\t\ttenantId\n\t\t\t\t});\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\terror: 'Forbidden: You can only update avatars for users within your own tenant.'\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 403 }\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tconst avatarFile = formData.get('avatar') as File | null;\n\n\t\tif (!avatarFile) {\n\t\t\tlogger.error('No avatar file provided', { userId: locals.user._id, targetUserId });\n\t\t\tthrow error(400, 'No avatar file provided');\n\t\t}\n\n\t\t// Validate file type on the server as a secondary check\n\t\tconst allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml', 'image/avif'];\n\t\tif (!allowedTypes.includes(avatarFile.type)) {\n\t\t\tlogger.error('Invalid file type for avatar', {\n\t\t\t\tuserId: locals.user._id,\n\t\t\t\ttargetUserId,\n\t\t\t\tfileType: avatarFile.type\n\t\t\t});\n\t\t\tthrow error(400, 'Invalid file type. Only JPEG, PNG, GIF, WebP, and SVG are allowed.');\n\t\t}\n\n\t\t// Before saving a new avatar, move the old one to trash if it exists.\n\t\tconst currentUser = await auth.getUserById(targetUserId);\n\t\tif (currentUser && currentUser.avatar) {\n\t\t\ttry {\n\t\t\t\t// moveMediaToTrash handles all URL normalization internally\n\t\t\t\t// Just pass the avatar URL as-is (can be /files/..., http://..., or relative path)\n\t\t\t\tawait moveMediaToTrash(currentUser.avatar);\n\t\t\t\tlogger.info('Old avatar moved to trash', { userId: targetUserId, oldAvatar: currentUser.avatar });\n\t\t\t} catch (err) {\n\t\t\t\t// Log the error but don't block the upload if moving the old file fails.\n\t\t\t\tlogger.warn('Failed to move old avatar to trash. Proceeding with new avatar upload.', {\n\t\t\t\t\tuserId: targetUserId,\n\t\t\t\t\terror: err instanceof Error ? err.message : String(err)\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Save the new avatar image and update the user's profile\n\t\tconst avatarUrl = await saveAvatarImage(avatarFile, targetUserId);\n\n\t\t// The avatarUrl from saveAvatarImage is already in the correct format:\n\t\t// - For local storage: /files/avatars/...\n\t\t// - For cloud storage: https://cdn.example.com/mediaFolder/avatars/...\n\t\t// We can use it directly\n\n\t\t// Persist DB with the avatar URL\n\t\tawait auth.updateUserAttributes(targetUserId, { avatar: avatarUrl }, locals.tenantId);\n\n\t\t// Invalidate any cached session data to reflect the change immediately.\n\t\tconst session_id = locals.session_id;\n\t\tif (session_id) {\n\t\t\tconst user = await auth.validateSession(session_id);\n\t\t\tawait cacheService.set(session_id, { user, timestamp: Date.now() }, 3600);\n\t\t}\n\n\t\t// Invalidate cache for users list so UI updates\n\t\ttry {\n\t\t\tawait cacheService.clearByPattern('api:*:/api/admin/users*', locals.tenantId);\n\t\t\tlogger.debug('Cache invalidated for users list after avatar update');\n\t\t} catch (cacheError) {\n\t\t\tlogger.warn('Failed to invalidate cache after avatar update', { error: cacheError });\n\t\t}\n\n\t\tlogger.info('Avatar saved successfully', { userId: targetUserId, avatarUrl });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'Avatar saved successfully',\n\t\t\tavatarUrl\n\t\t});\n\t} catch (err) {\n\t\tconst httpError = err as HttpError;\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'Internal Server Error';\n\n\t\tlogger.error('Error in saveAvatar API:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\tstatus\n\t\t});\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: status === 500 ? 'Internal Server Error' : message\n\t\t\t},\n\t\t\t{ status }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}