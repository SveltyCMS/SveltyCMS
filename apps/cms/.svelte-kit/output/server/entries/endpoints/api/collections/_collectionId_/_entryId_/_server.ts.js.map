{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/collections/[collectionId]/[entryId]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/collections/[collectionId]/[entryId]/+server.ts\n * @description API endpoint for updating and deleting a single collection entry\n *\n * @example PATCH/DELETE /api/collections/:collectionId/:entryId\n *\n * Features:\n * * ❌ GET removed - use +page.server.ts load() for SSR data fetching\n * * Handles PATCH and DELETE verbs for full CRUD on a single entry\n * * Secure, granular access control per operation, scoped to the current tenant\n * * Automatic metadata updates on modification (updatedBy)\n * * ModifyRequest support for widget-based data processing\n * * Status-based access control for non-admin users\n */\n\nimport { json, error, type RequestHandler } from '@sveltejs/kit';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Databases\nimport type { DatabaseId } from '@shared/database/dbInterface';\n\n// Auth\nimport { contentManager } from '@content/ContentManager';\nimport { modifyRequest } from '@api/collections/modifyRequest';\n\n// Types\nimport type { FieldInstance } from '@cms-types';\n\n// Helper function to normalize collection names for database operations\nconst normalizeCollectionName = (collectionId: string): string => {\n\t// Remove hyphens from UUID for MongoDB collection naming\n\tconst cleanId = collectionId.replace(/-/g, '');\n\treturn `collection_${cleanId}`;\n};\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// ❌ REMOVED: GET handler - SSR data loading should use +page.server.ts load() function\n// This prevents redundant data fetching and improves SSR performance.\n// For single entry reads, use the load() function in +page.server.ts with editEntryId param.\n\n// PATCH: Updates an existing entry\nexport const PATCH: RequestHandler = async ({ locals, params, request }) => {\n\tconst startTime = performance.now();\n\tconst endpoint = `PATCH /api/collections/${params.collectionId}/${params.entryId}`;\n\tconst { user, tenantId } = locals;\n\n\tlogger.info(`${endpoint} - Request started`, { userId: user?._id, tenantId });\n\n\ttry {\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Could not identify the tenant for this request.');\n\t\t}\n\n\t\tconst schema = await contentManager.getCollectionById(params.collectionId, tenantId);\n\t\tif (!schema) {\n\t\t\tthrow error(404, 'Collection not found');\n\t\t}\n\n\t\tif (!schema._id) {\n\t\t\tthrow error(500, 'Collection ID is missing');\n\t\t}\n\n\t\t// User access already validated by hooks\n\n\t\tlet body;\n\t\tconst contentType = request.headers.get('content-type');\n\n\t\tif (contentType?.includes('application/json')) {\n\t\t\tbody = await request.json();\n\t\t} else if (contentType?.includes('multipart/form-data')) {\n\t\t\tconst formData = await request.formData();\n\t\t\tbody = Object.fromEntries(formData.entries());\n\t\t} else {\n\t\t\tthrow error(400, 'Unsupported content type');\n\t\t}\n\n\t\tconst updateData = { ...body, updatedBy: user._id };\n\n\t\tconst dataArray = [updateData];\n\n\t\tconst dbAdapter = locals.dbAdapter;\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(503, 'Service Unavailable: Database service is not properly initialized');\n\t\t}\n\n\t\tconst collectionModel = await dbAdapter.collection.getModel(schema._id);\n\t\ttry {\n\t\t\tawait modifyRequest({\n\t\t\t\tdata: dataArray,\n\t\t\t\tfields: schema.fields as FieldInstance[],\n\t\t\t\tcollection: collectionModel,\n\t\t\t\tuser,\n\t\t\t\ttype: 'PATCH',\n\t\t\t\ttenantId\n\t\t\t});\n\t\t} catch (modifyError) {\n\t\t\tlogger.warn(`${endpoint} - ModifyRequest pre-processing failed`, { error: (modifyError as Error).message });\n\t\t}\n\n\t\tconst collectionName = `collection_${schema._id}`;\n\t\t// First verify the entry exists and belongs to the current tenant\n\t\tconst query: { _id: DatabaseId; tenantId?: string } = { _id: params.entryId as DatabaseId };\n\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\tquery.tenantId = tenantId;\n\t\t}\n\n\t\tconst verificationResult = await dbAdapter.crud.findOne(collectionName, query);\n\t\tif (!verificationResult.success || !verificationResult.data) {\n\t\t\tthrow error(404, 'Entry not found or access denied');\n\t\t}\n\n\t\tconst result = await dbAdapter.crud.update(collectionName, params.entryId as DatabaseId, dataArray[0]);\n\n\t\tif (!result.success) {\n\t\t\tthrow new Error(result.error.message);\n\t\t}\n\n\t\tif (!result.data) {\n\t\t\tthrow error(404, 'Entry not found');\n\t\t}\n\n\t\tconst duration = performance.now() - startTime;\n\t\tconst responseData = { success: true, data: result.data, performance: { duration } };\n\n\t\t// Invalidate server-side page cache for this collection\n\t\tconst cacheService = (await import('@shared/database/CacheService')).cacheService;\n\t\tconst cachePattern = `collection:${schema._id}:*`;\n\t\tawait cacheService.clearByPattern(cachePattern, tenantId).catch((err) => {\n\t\t\tlogger.warn('Failed to invalidate page cache after PATCH', { pattern: cachePattern, error: err });\n\t\t});\n\n\t\t// Also invalidate specific caches in ContentManager\n\t\tawait contentManager.invalidateSpecificCaches([schema.path || '', schema._id as string].filter(Boolean));\n\n\t\t// Publish entryUpdated event\n\t\ttry {\n\t\t\tconst { pubSub } = await import('@shared/services/pubSub');\n\t\t\tpubSub.publish('entryUpdated', {\n\t\t\t\tcollection: schema.name || params.collectionId,\n\t\t\t\tid: params.entryId,\n\t\t\t\taction: 'update',\n\t\t\t\tdata: result.data,\n\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\tuser: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername: user.username,\n\t\t\t\t\temail: user.email\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (pubSubError) {\n\t\t\tlogger.warn('Failed to publish entryUpdated event', { error: pubSubError });\n\t\t}\n\n\t\tlogger.info(`${endpoint} - Entry updated successfully`, { duration: `${duration.toFixed(2)}ms` });\n\n\t\treturn json(responseData);\n\t} catch (e) {\n\t\tif (typeof e === 'object' && e !== null && 'status' in e) {\n\t\t\tthrow e;\n\t\t}\n\t\tlogger.error(`${endpoint} - Unexpected error`, {\n\t\t\terror: (e as any).message,\n\t\t\tstack: (e as any).stack\n\t\t});\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n\n// DELETE: Removes an entry from a collection\nexport const DELETE: RequestHandler = async ({ locals, params }) => {\n\tconst startTime = performance.now();\n\tconst endpoint = `DELETE /api/collections/${params.collectionId}/${params.entryId}`;\n\tconst { user, tenantId } = locals;\n\n\tlogger.info(`${endpoint} - Request started`, { userId: user?._id, tenantId });\n\n\ttry {\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Could not identify the tenant for this request.');\n\t\t}\n\n\t\tconst schema = await contentManager.getCollectionById(params.collectionId, tenantId);\n\t\tif (!schema) {\n\t\t\tthrow error(404, 'Collection not found');\n\t\t}\n\n\t\tconst dbAdapter = locals.dbAdapter;\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(503, 'Service Unavailable: Database service is not properly initialized');\n\t\t}\n\n\t\tif (!schema._id) {\n\t\t\tthrow error(500, 'Collection ID is missing');\n\t\t}\n\n\t\tconst normalizedCollectionId = normalizeCollectionName(schema._id);\n\n\t\t// First verify the entry exists and belongs to the current tenant\n\t\tconst query: { _id: DatabaseId; tenantId?: string } = { _id: params.entryId as DatabaseId };\n\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\tquery.tenantId = tenantId;\n\t\t}\n\n\t\tconst verificationResult = await dbAdapter.crud.findOne(normalizedCollectionId, query);\n\t\tif (!verificationResult.success || !verificationResult.data) {\n\t\t\tthrow error(404, 'Entry not found or access denied');\n\t\t}\n\n\t\tconst result = await dbAdapter.crud.delete(normalizedCollectionId, params.entryId as DatabaseId);\n\n\t\tif (!result.success) {\n\t\t\tif (result.error.message.includes('not found')) {\n\t\t\t\tthrow error(404, 'Entry not found');\n\t\t\t}\n\t\t\tthrow error(500, 'Failed to delete entry');\n\t\t}\n\n\t\t// Invalidate server-side page cache for this collection\n\t\tconst cacheService = (await import('@shared/database/CacheService')).cacheService;\n\t\tconst cachePattern = `collection:${schema._id}:*`;\n\t\tawait cacheService.clearByPattern(cachePattern, tenantId).catch((err) => {\n\t\t\tlogger.warn('Failed to invalidate page cache after DELETE', { pattern: cachePattern, error: err });\n\t\t});\n\n\t\t// Also invalidate specific caches in ContentManager\n\t\tawait contentManager.invalidateSpecificCaches([schema.path || '', schema._id as string].filter(Boolean));\n\n\t\t// Publish entryUpdated event\n\t\ttry {\n\t\t\tconst { pubSub } = await import('@shared/services/pubSub');\n\t\t\tpubSub.publish('entryUpdated', {\n\t\t\t\tcollection: schema.name || params.collectionId,\n\t\t\t\tid: params.entryId,\n\t\t\t\taction: 'delete',\n\t\t\t\tdata: { _id: params.entryId }, // Minimal data for delete\n\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\tuser: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername: user.username,\n\t\t\t\t\temail: user.email\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (pubSubError) {\n\t\t\tlogger.warn('Failed to publish entryUpdated event', { error: pubSubError });\n\t\t}\n\n\t\tconst duration = performance.now() - startTime;\n\t\tlogger.info(`${endpoint} - Entry deleted successfully`, { duration: `${duration.toFixed(2)}ms` });\n\n\t\treturn new Response(null, { status: 204 }); // 204 No Content\n\t} catch (e) {\n\t\tif (typeof e === 'object' && e !== null && 'status' in e) {\n\t\t\tthrow e;\n\t\t}\n\t\tlogger.error(`${endpoint} - Unexpected error`, {\n\t\t\terror: (e as any).message,\n\t\t\tstack: (e as any).stack\n\t\t});\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n"],"names":[],"mappings":";;;;;AA6BA,MAAM,0BAA0B,CAAC,iBAAiC;AAEjE,QAAM,UAAU,aAAa,QAAQ,MAAM,EAAE;AAC7C,SAAO,cAAc,OAAO;AAC7B;AAUO,MAAM,QAAwB,OAAO,EAAE,QAAQ,QAAQ,cAAc;AAC3E,QAAM,YAAY,YAAY,IAAA;AAC9B,QAAM,WAAW,0BAA0B,OAAO,YAAY,IAAI,OAAO,OAAO;AAChF,QAAM,EAAE,MAAM,SAAA,IAAa;AAE3B,SAAO,KAAK,GAAG,QAAQ,sBAAsB,EAAE,QAAQ,MAAM,KAAK,UAAU;AAE5E,MAAI;AACH,QAAI,CAAC,MAAM;AACV,YAAM,MAAM,KAAK,cAAc;AAAA,IAChC;AAEA,QAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,YAAM,MAAM,KAAK,iDAAiD;AAAA,IACnE;AAEA,UAAM,SAAS,MAAM,eAAe,kBAAkB,OAAO,cAAc,QAAQ;AACnF,QAAI,CAAC,QAAQ;AACZ,YAAM,MAAM,KAAK,sBAAsB;AAAA,IACxC;AAEA,QAAI,CAAC,OAAO,KAAK;AAChB,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAIA,QAAI;AACJ,UAAM,cAAc,QAAQ,QAAQ,IAAI,cAAc;AAEtD,QAAI,aAAa,SAAS,kBAAkB,GAAG;AAC9C,aAAO,MAAM,QAAQ,KAAA;AAAA,IACtB,WAAW,aAAa,SAAS,qBAAqB,GAAG;AACxD,YAAM,WAAW,MAAM,QAAQ,SAAA;AAC/B,aAAO,OAAO,YAAY,SAAS,QAAA,CAAS;AAAA,IAC7C,OAAO;AACN,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAEA,UAAM,aAAa,EAAE,GAAG,MAAM,WAAW,KAAK,IAAA;AAE9C,UAAM,YAAY,CAAC,UAAU;AAE7B,UAAM,YAAY,OAAO;AACzB,QAAI,CAAC,WAAW;AACf,YAAM,MAAM,KAAK,mEAAmE;AAAA,IACrF;AAEA,UAAM,kBAAkB,MAAM,UAAU,WAAW,SAAS,OAAO,GAAG;AACtE,QAAI;AACH,YAAM,cAAc;AAAA,QACnB,MAAM;AAAA,QACN,QAAQ,OAAO;AAAA,QACf,YAAY;AAAA,QACZ;AAAA,QACA,MAAM;AAAA,QACN;AAAA,MAAA,CACA;AAAA,IACF,SAAS,aAAa;AACrB,aAAO,KAAK,GAAG,QAAQ,0CAA0C,EAAE,OAAQ,YAAsB,SAAS;AAAA,IAC3G;AAEA,UAAM,iBAAiB,cAAc,OAAO,GAAG;AAE/C,UAAM,QAAgD,EAAE,KAAK,OAAO,QAAA;AACpE,QAAI,sBAAsB,cAAc,GAAG;AAC1C,YAAM,WAAW;AAAA,IAClB;AAEA,UAAM,qBAAqB,MAAM,UAAU,KAAK,QAAQ,gBAAgB,KAAK;AAC7E,QAAI,CAAC,mBAAmB,WAAW,CAAC,mBAAmB,MAAM;AAC5D,YAAM,MAAM,KAAK,kCAAkC;AAAA,IACpD;AAEA,UAAM,SAAS,MAAM,UAAU,KAAK,OAAO,gBAAgB,OAAO,SAAuB,UAAU,CAAC,CAAC;AAErG,QAAI,CAAC,OAAO,SAAS;AACpB,YAAM,IAAI,MAAM,OAAO,MAAM,OAAO;AAAA,IACrC;AAEA,QAAI,CAAC,OAAO,MAAM;AACjB,YAAM,MAAM,KAAK,iBAAiB;AAAA,IACnC;AAEA,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,UAAM,eAAe,EAAE,SAAS,MAAM,MAAM,OAAO,MAAM,aAAa,EAAE,WAAS;AAGjF,UAAM,gBAAgB,MAAM,OAAO,0CAA+B,GAAG;AACrE,UAAM,eAAe,cAAc,OAAO,GAAG;AAC7C,UAAM,aAAa,eAAe,cAAc,QAAQ,EAAE,MAAM,CAAC,QAAQ;AACxE,aAAO,KAAK,+CAA+C,EAAE,SAAS,cAAc,OAAO,KAAK;AAAA,IACjG,CAAC;AAGD,UAAM,eAAe,yBAAyB,CAAC,OAAO,QAAQ,IAAI,OAAO,GAAa,EAAE,OAAO,OAAO,CAAC;AAGvG,QAAI;AACH,YAAM,EAAE,OAAA,IAAW,MAAM,OAAO,oCAAyB;AACzD,aAAO,QAAQ,gBAAgB;AAAA,QAC9B,YAAY,OAAO,QAAQ,OAAO;AAAA,QAClC,IAAI,OAAO;AAAA,QACX,QAAQ;AAAA,QACR,MAAM,OAAO;AAAA,QACb,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,QACtB,MAAM;AAAA,UACL,KAAK,KAAK;AAAA,UACV,UAAU,KAAK;AAAA,UACf,OAAO,KAAK;AAAA,QAAA;AAAA,MACb,CACA;AAAA,IACF,SAAS,aAAa;AACrB,aAAO,KAAK,wCAAwC,EAAE,OAAO,aAAa;AAAA,IAC3E;AAEA,WAAO,KAAK,GAAG,QAAQ,iCAAiC,EAAE,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC,KAAA,CAAM;AAEhG,WAAO,KAAK,YAAY;AAAA,EACzB,SAAS,GAAG;AACX,QAAI,OAAO,MAAM,YAAY,MAAM,QAAQ,YAAY,GAAG;AACzD,YAAM;AAAA,IACP;AACA,WAAO,MAAM,GAAG,QAAQ,uBAAuB;AAAA,MAC9C,OAAQ,EAAU;AAAA,MAClB,OAAQ,EAAU;AAAA,IAAA,CAClB;AACD,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;AAGO,MAAM,SAAyB,OAAO,EAAE,QAAQ,aAAa;AACnE,QAAM,YAAY,YAAY,IAAA;AAC9B,QAAM,WAAW,2BAA2B,OAAO,YAAY,IAAI,OAAO,OAAO;AACjF,QAAM,EAAE,MAAM,SAAA,IAAa;AAE3B,SAAO,KAAK,GAAG,QAAQ,sBAAsB,EAAE,QAAQ,MAAM,KAAK,UAAU;AAE5E,MAAI;AACH,QAAI,CAAC,MAAM;AACV,YAAM,MAAM,KAAK,cAAc;AAAA,IAChC;AAEA,QAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,YAAM,MAAM,KAAK,iDAAiD;AAAA,IACnE;AAEA,UAAM,SAAS,MAAM,eAAe,kBAAkB,OAAO,cAAc,QAAQ;AACnF,QAAI,CAAC,QAAQ;AACZ,YAAM,MAAM,KAAK,sBAAsB;AAAA,IACxC;AAEA,UAAM,YAAY,OAAO;AACzB,QAAI,CAAC,WAAW;AACf,YAAM,MAAM,KAAK,mEAAmE;AAAA,IACrF;AAEA,QAAI,CAAC,OAAO,KAAK;AAChB,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAEA,UAAM,yBAAyB,wBAAwB,OAAO,GAAG;AAGjE,UAAM,QAAgD,EAAE,KAAK,OAAO,QAAA;AACpE,QAAI,sBAAsB,cAAc,GAAG;AAC1C,YAAM,WAAW;AAAA,IAClB;AAEA,UAAM,qBAAqB,MAAM,UAAU,KAAK,QAAQ,wBAAwB,KAAK;AACrF,QAAI,CAAC,mBAAmB,WAAW,CAAC,mBAAmB,MAAM;AAC5D,YAAM,MAAM,KAAK,kCAAkC;AAAA,IACpD;AAEA,UAAM,SAAS,MAAM,UAAU,KAAK,OAAO,wBAAwB,OAAO,OAAqB;AAE/F,QAAI,CAAC,OAAO,SAAS;AACpB,UAAI,OAAO,MAAM,QAAQ,SAAS,WAAW,GAAG;AAC/C,cAAM,MAAM,KAAK,iBAAiB;AAAA,MACnC;AACA,YAAM,MAAM,KAAK,wBAAwB;AAAA,IAC1C;AAGA,UAAM,gBAAgB,MAAM,OAAO,0CAA+B,GAAG;AACrE,UAAM,eAAe,cAAc,OAAO,GAAG;AAC7C,UAAM,aAAa,eAAe,cAAc,QAAQ,EAAE,MAAM,CAAC,QAAQ;AACxE,aAAO,KAAK,gDAAgD,EAAE,SAAS,cAAc,OAAO,KAAK;AAAA,IAClG,CAAC;AAGD,UAAM,eAAe,yBAAyB,CAAC,OAAO,QAAQ,IAAI,OAAO,GAAa,EAAE,OAAO,OAAO,CAAC;AAGvG,QAAI;AACH,YAAM,EAAE,OAAA,IAAW,MAAM,OAAO,oCAAyB;AACzD,aAAO,QAAQ,gBAAgB;AAAA,QAC9B,YAAY,OAAO,QAAQ,OAAO;AAAA,QAClC,IAAI,OAAO;AAAA,QACX,QAAQ;AAAA,QACR,MAAM,EAAE,KAAK,OAAO,QAAA;AAAA;AAAA,QACpB,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,QACtB,MAAM;AAAA,UACL,KAAK,KAAK;AAAA,UACV,UAAU,KAAK;AAAA,UACf,OAAO,KAAK;AAAA,QAAA;AAAA,MACb,CACA;AAAA,IACF,SAAS,aAAa;AACrB,aAAO,KAAK,wCAAwC,EAAE,OAAO,aAAa;AAAA,IAC3E;AAEA,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,WAAO,KAAK,GAAG,QAAQ,iCAAiC,EAAE,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC,KAAA,CAAM;AAEhG,WAAO,IAAI,SAAS,MAAM,EAAE,QAAQ,KAAK;AAAA,EAC1C,SAAS,GAAG;AACX,QAAI,OAAO,MAAM,YAAY,MAAM,QAAQ,YAAY,GAAG;AACzD,YAAM;AAAA,IACP;AACA,WAAO,MAAM,GAAG,QAAQ,uBAAuB;AAAA,MAC9C,OAAQ,EAAU;AAAA,MAClB,OAAQ,EAAU;AAAA,IAAA,CAClB;AACD,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;"}