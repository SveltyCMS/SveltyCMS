{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/user/logout/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/user/logout/+server.ts\n * @description API endpoint for user logout.\n *\n * This endpoint handles user logout operations by:\n * - Revoking the Google OAuth token if the user signed in with Google.\n * - Destroying the user's active session on the server.\n * - Removing the session from any in-memory stores or caches.\n * - Clearing the session cookie from the client's browser.\n *\n * Features:\n * - Secure Google token revocation on logout.\n * - Secure local session destruction.\n * - Reliable cookie invalidation.\n * - Robust error handling and logging.\n */\n\nimport { error, json, type HttpError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n// Auth\nimport { SESSION_COOKIE_NAME } from '@shared/database/auth/constants';\nimport { cacheService } from '@shared/database/CacheService';\nimport { auth } from '@shared/database/db';\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nexport const POST: RequestHandler = async ({ cookies, locals }) => {\n\tconst { user, session_id, tenantId } = locals;\n\ttry {\n\t\tif (!auth) {\n\t\t\tlogger.error('Authentication system is not initialized.');\n\t\t\tthrow error(500, 'Internal Server Error: Auth system not initialized');\n\t\t} // Check if a user session actually exists for this request.\n\n\t\tif (session_id && user) {\n\t\t\t// Revoke Google OAuth Token\n\t\t\t// Check if user has googleRefreshToken (property exists in full User type but not in minimal locals type)\n\t\t\tconst fullUser = user as { googleRefreshToken?: string | null } & typeof user;\n\t\t\tif (fullUser.googleRefreshToken) {\n\t\t\t\ttry {\n\t\t\t\t\tconst refreshToken = fullUser.googleRefreshToken;\n\t\t\t\t\tconst response = await fetch(`https://oauth2.googleapis.com/revoke?token=${refreshToken}`, {\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'Content-type': 'application/x-www-form-urlencoded'\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\tlogger.info('Successfully revoked Google OAuth token for user', { userId: user._id, tenantId }); // Clear the refresh token from the database, scoped by tenant.\n\t\t\t\t\t\tawait auth.updateUserAttributes(user._id, { googleRefreshToken: undefined }, tenantId);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst errorBody = await response.json();\n\t\t\t\t\t\tlogger.warn('Failed to revoke Google OAuth token. It may have already been revoked.', {\n\t\t\t\t\t\t\tuserId: user._id,\n\t\t\t\t\t\t\ttenantId,\n\t\t\t\t\t\t\terror: errorBody\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} catch (revokeError) {\n\t\t\t\t\t// Log the error but don't block the local logout process.\n\t\t\t\t\tlogger.error('Error while trying to revoke Google OAuth token', { userId: user._id, error: revokeError, tenantId });\n\t\t\t\t}\n\t\t\t} // Destroy the session on the server-side (database, cache, etc.).\n\n\t\t\tawait auth.destroySession(session_id); // Also clear the session from cache\n\n\t\t\ttry {\n\t\t\t\tawait cacheService.delete(session_id);\n\t\t\t} catch (cacheError) {\n\t\t\t\tlogger.warn(`Failed to clear session cache: ${cacheError}`);\n\t\t\t}\n\n\t\t\tlogger.info('Session destroyed for user', {\n\t\t\t\temail: user.email,\n\t\t\t\tsessionId: session_id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t} else {\n\t\t\t// If there's no session, there's nothing to destroy, but we can still log it.\n\t\t\tlogger.warn('Logout endpoint was called, but no active session was found.');\n\t\t} // Clear the session cookie from the client's browser.\n\n\t\tcookies.delete(SESSION_COOKIE_NAME, {\n\t\t\tpath: '/',\n\t\t\thttpOnly: true,\n\t\t\tsecure: false, // Set to true in production with HTTPS\n\t\t\tsameSite: 'lax'\n\t\t}); // Clear the user from `locals` for the remainder of the current request lifecycle.\n\n\t\tlocals.user = null;\n\t\tlocals.session_id = undefined;\n\t\tlocals.tenantId = undefined;\n\n\t\treturn json({ success: true, message: 'You have been logged out successfully.' });\n\t} catch (err) {\n\t\t// This block catches unexpected errors during session destruction.\n\t\tconst httpError = err as HttpError;\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'An unexpected error occurred during logout.';\n\n\t\tlogger.error('Error during logout process:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\ttenantId: locals.tenantId,\n\t\t\tstatus\n\t\t}); // Even if an error occurs, we still try to clear the cookie as a failsafe.\n\n\t\ttry {\n\t\t\tcookies.delete(SESSION_COOKIE_NAME, { path: '/' });\n\t\t} catch (cookieError) {\n\t\t\tlogger.error('Failed to clear cookie during logout error handling.', { cookieError });\n\t\t}\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: status === 500 ? 'Internal Server Error' : message\n\t\t\t},\n\t\t\t{ status }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":";;;;AA0BO,MAAM,OAAuB,OAAO,EAAE,SAAS,aAAa;AAClE,QAAM,EAAE,MAAM,YAAY,SAAA,IAAa;AACvC,MAAI;AACH,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,2CAA2C;AACxD,YAAM,MAAM,KAAK,oDAAoD;AAAA,IACtE;AAEA,QAAI,cAAc,MAAM;AAGvB,YAAM,WAAW;AACjB,UAAI,SAAS,oBAAoB;AAChC,YAAI;AACH,gBAAM,eAAe,SAAS;AAC9B,gBAAM,WAAW,MAAM,MAAM,8CAA8C,YAAY,IAAI;AAAA,YAC1F,QAAQ;AAAA,YACR,SAAS;AAAA,cACR,gBAAgB;AAAA,YAAA;AAAA,UACjB,CACA;AAED,cAAI,SAAS,IAAI;AAChB,mBAAO,KAAK,oDAAoD,EAAE,QAAQ,KAAK,KAAK,UAAU;AAC9F,kBAAM,KAAK,qBAAqB,KAAK,KAAK,EAAE,oBAAoB,OAAA,GAAa,QAAQ;AAAA,UACtF,OAAO;AACN,kBAAM,YAAY,MAAM,SAAS,KAAA;AACjC,mBAAO,KAAK,0EAA0E;AAAA,cACrF,QAAQ,KAAK;AAAA,cACb;AAAA,cACA,OAAO;AAAA,YAAA,CACP;AAAA,UACF;AAAA,QACD,SAAS,aAAa;AAErB,iBAAO,MAAM,mDAAmD,EAAE,QAAQ,KAAK,KAAK,OAAO,aAAa,UAAU;AAAA,QACnH;AAAA,MACD;AAEA,YAAM,KAAK,eAAe,UAAU;AAEpC,UAAI;AACH,cAAM,aAAa,OAAO,UAAU;AAAA,MACrC,SAAS,YAAY;AACpB,eAAO,KAAK,kCAAkC,UAAU,EAAE;AAAA,MAC3D;AAEA,aAAO,KAAK,8BAA8B;AAAA,QACzC,OAAO,KAAK;AAAA,QACZ,WAAW;AAAA,QACX;AAAA,MAAA,CACA;AAAA,IACF,OAAO;AAEN,aAAO,KAAK,8DAA8D;AAAA,IAC3E;AAEA,YAAQ,OAAO,qBAAqB;AAAA,MACnC,MAAM;AAAA,MACN,UAAU;AAAA,MACV,QAAQ;AAAA;AAAA,MACR,UAAU;AAAA,IAAA,CACV;AAED,WAAO,OAAO;AACd,WAAO,aAAa;AACpB,WAAO,WAAW;AAElB,WAAO,KAAK,EAAE,SAAS,MAAM,SAAS,0CAA0C;AAAA,EACjF,SAAS,KAAK;AAEb,UAAM,YAAY;AAClB,UAAM,SAAS,UAAU,UAAU;AACnC,UAAM,UAAU,UAAU,MAAM,WAAW;AAE3C,WAAO,MAAM,gCAAgC;AAAA,MAC5C,OAAO;AAAA,MACP,OAAO,eAAe,QAAQ,IAAI,QAAQ;AAAA,MAC1C,QAAQ,OAAO,MAAM;AAAA,MACrB,UAAU,OAAO;AAAA,MACjB;AAAA,IAAA,CACA;AAED,QAAI;AACH,cAAQ,OAAO,qBAAqB,EAAE,MAAM,KAAK;AAAA,IAClD,SAAS,aAAa;AACrB,aAAO,MAAM,wDAAwD,EAAE,YAAA,CAAa;AAAA,IACrF;AAEA,WAAO;AAAA,MACN;AAAA,QACC,SAAS;AAAA,QACT,SAAS,WAAW,MAAM,0BAA0B;AAAA,MAAA;AAAA,MAErD,EAAE,OAAA;AAAA,IAAO;AAAA,EAEX;AACD;"}