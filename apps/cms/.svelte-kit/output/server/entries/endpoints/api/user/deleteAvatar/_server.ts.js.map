{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/user/deleteAvatar/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/user/deleteAvatar/+server.ts\n * @description API endpoint for moving a user's avatar image to trash.\n *\n * This module provides functionality to:\n * - Move the current avatar image for a user to the trash folder, within the correct tenant.\n * - Update the user's profile to remove the avatar URL.\n *\n * Features:\n * - **Two-Level Permission System**: Users can delete their own avatar, admins can delete any user's avatar within their tenant.\n * - User profile update to remove avatar reference\n * - Error handling and comprehensive logging\n *\n * Usage:\n * DELETE /api/user/deleteAvatar\n * Body: JSON object with optional 'userId' (defaults to current user)\n */\n\nimport { error, json, type HttpError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Auth and permission helpers\nimport { auth } from '@shared/database/db';\n\n// System logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Media storage\nimport { moveMediaToTrash } from '@shared/utils/media/mediaStorage.server';\n\n// Cache service\nimport { cacheService } from '@shared/database/CacheService';\n\nexport const DELETE: RequestHandler = async ({ request, locals }) => {\n\tconst { user: currentUser, tenantId } = locals;\n\ttry {\n\t\tif (!currentUser) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t} // Parse request body to get optional target user ID and avatar URL\n\n\t\tlet targetUserId = currentUser._id; // Default to self\n\t\tlet avatarUrlToDelete: string | null = null;\n\n\t\ttry {\n\t\t\tconst body = await request.json();\n\t\t\tif (body.userId) {\n\t\t\t\ttargetUserId = body.userId;\n\t\t\t}\n\t\t\tif (body.avatarUrl) {\n\t\t\t\tavatarUrlToDelete = body.avatarUrl;\n\t\t\t}\n\t\t} catch {\n\t\t\t// If no body or invalid JSON, use default (self)\n\t\t} // **TWO-LEVEL PERMISSION SYSTEM**: Check if user is deleting their own avatar or has admin permissions\n\t\t// Role-based access is handled by hooks.server.ts, we just need to check if editing self vs others\n\n\t\tconst isEditingSelf = currentUser._id === targetUserId;\n\n\t\t// In multi-tenant mode, ensure target user is in same tenant when editing others\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !isEditingSelf) {\n\t\t\t// Ensure the authentication system is initialized\n\t\t\tif (!auth) {\n\t\t\t\tlogger.error('Authentication system is not initialized');\n\t\t\t\tthrow error(500, 'Internal Server Error: Auth system not initialized');\n\t\t\t}\n\n\t\t\tconst targetUser = await auth.getUserById(targetUserId, tenantId);\n\t\t\tif (!targetUser || targetUser.tenantId !== tenantId) {\n\t\t\t\tlogger.warn('Admin attempted to delete avatar for user outside their tenant', {\n\t\t\t\t\tadminId: currentUser._id,\n\t\t\t\t\ttargetUserId,\n\t\t\t\t\ttenantId\n\t\t\t\t});\n\t\t\t\tthrow error(403, 'Forbidden: You can only delete avatars for users within your own tenant.');\n\t\t\t}\n\t\t}\n\n\t\t// Ensure the authentication system is initialized\n\n\t\tif (!auth) {\n\t\t\tlogger.error('Authentication system is not initialized');\n\t\t\tthrow error(500, 'Internal Server Error: Auth system not initialized');\n\t\t}\n\n\t\t// Fetch the user, ensuring they belong to the current tenant.\n\t\tconst user = await auth.getUserById(targetUserId, tenantId);\n\n\t\tif (!user) {\n\t\t\tthrow error(404, 'User not found');\n\t\t}\n\n\t\t// Use avatar URL from request body if provided, otherwise use user.avatar from DB\n\t\tconst avatarToDelete = avatarUrlToDelete || user.avatar;\n\n\t\tif (avatarToDelete && avatarToDelete !== '/Default_User.svg') {\n\t\t\ttry {\n\t\t\t\t// Move avatar to trash\n\t\t\t\tawait moveMediaToTrash(avatarToDelete);\n\t\t\t\tlogger.info('Avatar moved to trash successfully', { userId: user._id, avatar: avatarToDelete, deletedBy: currentUser._id, tenantId });\n\t\t\t} catch (moveError) {\n\t\t\t\tlogger.error('Error in moveMediaToTrash', {\n\t\t\t\t\tuserId: user._id,\n\t\t\t\t\tavatar: avatarToDelete,\n\t\t\t\t\terror: moveError,\n\t\t\t\t\terrorMessage: moveError instanceof Error ? moveError.message : String(moveError),\n\t\t\t\t\terrorStack: moveError instanceof Error ? moveError.stack : undefined\n\t\t\t\t});\n\t\t\t\tif (moveError instanceof Error && moveError.message.includes('ENOENT')) {\n\t\t\t\t\tlogger.warn('Avatar file not found, but proceeding to remove it from user profile.', {\n\t\t\t\t\t\tuserId: user._id,\n\t\t\t\t\t\tavatar: avatarToDelete,\n\t\t\t\t\t\terror: moveError.message\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst errorMsg = moveError instanceof Error ? moveError.message : String(moveError);\n\t\t\t\t\tlogger.error(`Failed to move avatar file to trash: ${errorMsg}`, { userId: user._id });\n\t\t\t\t\tthrow error(500, `Failed to move avatar to trash: ${errorMsg}`);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tlogger.info('No avatar to move to trash for user.', { userId: user._id, tenantId });\n\t\t\treturn json({ success: true, message: 'No avatar to remove.' });\n\t\t} // Remove the avatar URL from the user's profile.\n\n\t\tawait auth.updateUserAttributes(targetUserId, { avatar: undefined }, tenantId);\n\t\tlogger.info('User avatar attribute removed from profile.', { userId: targetUserId, removedBy: currentUser._id, tenantId });\n\n\t\t// Invalidate cache for users list so UI updates\n\t\ttry {\n\t\t\t// Invalidate all user-related caches for all users (since admin user list includes all users)\n\t\t\tawait cacheService.clearByPattern('api:*:/api/admin/users*', tenantId);\n\t\t\tlogger.debug('Cache invalidated for users list after avatar deletion');\n\t\t} catch (cacheError) {\n\t\t\t// Log but don't fail the request if cache invalidation fails\n\t\t\tlogger.warn('Failed to invalidate cache after avatar deletion', { error: cacheError });\n\t\t}\n\n\t\t// Return normalized default avatar to update UI and allow client refresh\n\t\tconst defaultUrl = '/Default_User.svg';\n\t\treturn json({ success: true, message: 'Avatar removed successfully', avatarUrl: defaultUrl });\n\t} catch (err) {\n\t\tconst httpError = err as HttpError;\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'Internal Server Error';\n\n\t\tlogger.error('Error in deleteAvatar API:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\ttenantId: locals.tenantId,\n\t\t\tstatus\n\t\t});\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: status === 500 ? 'Internal Server Error' : message\n\t\t\t},\n\t\t\t{ status }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}