{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/database/pool-diagnostics/+server.ts"],"sourcesContent":["import { json, error as svelteError } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\n\n/**\n * Get database connection pool diagnostics\n * GET /api/database/pool-diagnostics\n *\n * Returns real-time connection pool statistics including:\n * - Total/active/idle connections\n * - Pool utilization percentage\n * - Waiting requests\n * - Health status (healthy/degraded/critical)\n * - Optimization recommendations\n *\n * Authorization: Requires admin role\n */\nexport const GET: RequestHandler = async ({ locals }) => {\n\ttry {\n\t\t// Check authentication\n\t\tif (!locals.user) {\n\t\t\tthrow svelteError(401, 'Authentication required');\n\t\t}\n\n\t\t// Check authorization - only admins can view pool diagnostics\n\t\tif (locals.user.role !== 'admin') {\n\t\t\tthrow svelteError(403, 'Admin access required to view pool diagnostics');\n\t\t}\n\n\t\t// Get database adapter\n\t\tconst { getDb } = await import('@shared/database/db');\n\t\tconst db = getDb();\n\n\t\tif (!db) {\n\t\t\tthrow svelteError(503, 'Database not initialized');\n\t\t}\n\n\t\t// Check if performance.getMetrics exists\n\t\tif (!db.performance || typeof db.performance.getMetrics !== 'function') {\n\t\t\tlogger.warn('Pool diagnostics not available - method not implemented');\n\t\t\tthrow svelteError(501, 'Pool diagnostics not implemented for this database adapter');\n\t\t}\n\n\t\t// Get pool diagnostics\n\t\tconst metricsResult = await db.performance.getMetrics();\n\n\t\tif (!metricsResult.success) {\n\t\t\tthrow svelteError(500, metricsResult.message || 'Failed to retrieve pool diagnostics');\n\t\t}\n\n\t\tconst healthResult = await db.getConnectionHealth();\n\t\tconst healthData = healthResult.success ? healthResult.data : null;\n\n\t\tconst data = {\n\t\t\t...(metricsResult.data || {}),\n\t\t\tpoolUtilization: metricsResult.data?.connectionPoolUsage,\n\t\t\thealthStatus: healthData ? (healthData.healthy ? 'healthy' : 'unhealthy') : 'unknown',\n\t\t\tlatency: healthData?.latency,\n\t\t\tactiveConnections: healthData?.activeConnections\n\t\t};\n\n\t\tlogger.debug('Pool diagnostics retrieved', {\n\t\t\tuser: locals.user.email,\n\t\t\tutilization: data.poolUtilization,\n\t\t\thealthStatus: data.healthStatus\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata\n\t\t});\n\t} catch (err) {\n\t\t// Re-throw SvelteKit errors\n\t\tif (err && typeof err === 'object' && 'status' in err) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tlogger.error('Error retrieving pool diagnostics', { error: err });\n\t\tthrow svelteError(500, 'Failed to retrieve pool diagnostics');\n\t}\n};\n"],"names":["svelteError"],"mappings":";;AAiBO,MAAM,MAAsB,OAAO,EAAE,aAAa;AACxD,MAAI;AAEH,QAAI,CAAC,OAAO,MAAM;AACjB,YAAMA,MAAY,KAAK,yBAAyB;AAAA,IACjD;AAGA,QAAI,OAAO,KAAK,SAAS,SAAS;AACjC,YAAMA,MAAY,KAAK,gDAAgD;AAAA,IACxE;AAGA,UAAM,EAAE,MAAA,IAAU,MAAM,OAAO,6BAAqB,EAAA,KAAA,OAAA,EAAA,CAAA;AACpD,UAAM,KAAK,MAAA;AAEX,QAAI,CAAC,IAAI;AACR,YAAMA,MAAY,KAAK,0BAA0B;AAAA,IAClD;AAGA,QAAI,CAAC,GAAG,eAAe,OAAO,GAAG,YAAY,eAAe,YAAY;AACvE,aAAO,KAAK,yDAAyD;AACrE,YAAMA,MAAY,KAAK,4DAA4D;AAAA,IACpF;AAGA,UAAM,gBAAgB,MAAM,GAAG,YAAY,WAAA;AAE3C,QAAI,CAAC,cAAc,SAAS;AAC3B,YAAMA,MAAY,KAAK,cAAc,WAAW,qCAAqC;AAAA,IACtF;AAEA,UAAM,eAAe,MAAM,GAAG,oBAAA;AAC9B,UAAM,aAAa,aAAa,UAAU,aAAa,OAAO;AAE9D,UAAM,OAAO;AAAA,MACZ,GAAI,cAAc,QAAQ,CAAA;AAAA,MAC1B,iBAAiB,cAAc,MAAM;AAAA,MACrC,cAAc,aAAc,WAAW,UAAU,YAAY,cAAe;AAAA,MAC5E,SAAS,YAAY;AAAA,MACrB,mBAAmB,YAAY;AAAA,IAAA;AAGhC,WAAO,MAAM,8BAA8B;AAAA,MAC1C,MAAM,OAAO,KAAK;AAAA,MAClB,aAAa,KAAK;AAAA,MAClB,cAAc,KAAK;AAAA,IAAA,CACnB;AAED,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT;AAAA,IAAA,CACA;AAAA,EACF,SAAS,KAAK;AAEb,QAAI,OAAO,OAAO,QAAQ,YAAY,YAAY,KAAK;AACtD,YAAM;AAAA,IACP;AAEA,WAAO,MAAM,qCAAqC,EAAE,OAAO,KAAK;AAChE,UAAMA,MAAY,KAAK,qCAAqC;AAAA,EAC7D;AACD;"}