{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/collections/[collectionId]/export/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/collections/[collectionId]/export/+server.ts\n * @description API endpoint for exporting data from a specific collection\n *\n * Features:\n * - Export specific collection data\n * - Multiple format support (JSON, CSV)\n * - Filter and pagination options\n * - Permission-based access control\n *\n * Usage:\n * GET /api/collections/{collectionId}/export?format=json&limit=100&offset=0\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\n\n// Database adapter\nimport { dbAdapter } from '@shared/database/db';\n\n// Content Management\nimport { contentManager } from '@content/ContentManager';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nexport const GET: RequestHandler = async ({ params, url, locals }) => {\n\tconst startTime = performance.now();\n\tconst { collectionId } = params;\n\n\ttry {\n\t\tif (!locals.user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\t// Get collection schema\n\t\tconst schema = await contentManager.getCollection(collectionId);\n\n\t\tif (!schema) {\n\t\t\tthrow error(404, `Collection '${collectionId}' not found`);\n\t\t}\n\n\t\t// Parse query parameters\n\t\tconst format = url.searchParams.get('format') || 'json';\n\t\tconst limit = parseInt(url.searchParams.get('limit') || '0');\n\t\tconst offset = parseInt(url.searchParams.get('offset') || '0');\n\t\tconst filter = url.searchParams.get('filter');\n\t\tconst sortField = url.searchParams.get('sortField');\n\t\tconst sortDirection = (url.searchParams.get('sortDirection') as 'asc' | 'desc') || 'desc';\n\n\t\t// Build query options\n\t\tconst queryOptions: Record<string, unknown> = {};\n\n\t\tif (limit > 0) {\n\t\t\tqueryOptions.limit = Math.min(limit, 10000); // Cap at 10k for safety\n\t\t}\n\n\t\tif (offset > 0) {\n\t\t\tqueryOptions.offset = offset;\n\t\t}\n\n\t\tif (sortField) {\n\t\t\tqueryOptions.sort = { [sortField]: sortDirection === 'asc' ? 1 : -1 };\n\t\t}\n\n\t\t// Build filter\n\t\tlet filterQuery = {};\n\t\tif (filter) {\n\t\t\ttry {\n\t\t\t\t// Simple filter parsing - in production you might want more sophisticated filtering\n\t\t\t\tfilterQuery = JSON.parse(filter);\n\t\t\t} catch (err) {\n\t\t\t\tconst errorMsg = err instanceof Error ? err.message : 'Unknown error';\n\t\t\t\tlogger.warn('Invalid filter format', { filter, error: errorMsg });\n\t\t\t}\n\t\t}\n\n\t\t// Fetch data from collection\n\t\tlogger.trace(`Exporting collection ${collectionId}`, {\n\t\t\tuserId: locals.user._id,\n\t\t\tformat,\n\t\t\tlimit,\n\t\t\toffset,\n\t\t\tfilter: filterQuery\n\t\t});\n\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(500, 'Database adapter not initialized');\n\t\t}\n\n\t\tconst result = await dbAdapter.crud.findMany(`collection_${schema._id}`, filterQuery, queryOptions);\n\n\t\tif (!result.success) {\n\t\t\tthrow error(500, `Failed to export collection data: ${result.error}`);\n\t\t}\n\n\t\tconst exportData = result.data || [];\n\t\tconst duration = performance.now() - startTime;\n\n\t\tlogger.info(`Collection ${collectionId} exported successfully`, {\n\t\t\tuserId: locals.user._id,\n\t\t\trecordCount: exportData.length,\n\t\t\tduration: `${duration.toFixed(2)}ms`,\n\t\t\tformat\n\t\t});\n\n\t\t// Return data based on format\n\t\tif (format === 'csv') {\n\t\t\tconst csvData = convertToCSV(exportData);\n\t\t\treturn new Response(csvData, {\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'text/csv',\n\t\t\t\t\t'Content-Disposition': `attachment; filename=\"${collectionId}-export.csv\"`\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\t// Default to JSON\n\t\t\treturn json({\n\t\t\t\tsuccess: true,\n\t\t\t\tcollection: collectionId,\n\t\t\t\tdata: exportData,\n\t\t\t\tmetadata: {\n\t\t\t\t\ttotal: exportData.length,\n\t\t\t\t\toffset: offset,\n\t\t\t\t\tlimit: limit,\n\t\t\t\t\texportedAt: new Date().toISOString(),\n\t\t\t\t\tschema: {\n\t\t\t\t\t\tname: schema.name,\n\t\t\t\t\t\tlabel: schema.label,\n\t\t\t\t\t\tfields: schema.fields?.map((f: unknown) => {\n\t\t\t\t\t\t\tconst field = f as Record<string, unknown>;\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tname: field.name,\n\t\t\t\t\t\t\t\ttype: field.widget,\n\t\t\t\t\t\t\t\tlabel: field.label,\n\t\t\t\t\t\t\t\trequired: field.required\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t} catch (err) {\n\t\tconst duration = performance.now() - startTime;\n\t\tconst errorMsg = err instanceof Error ? err.message : 'Unknown error';\n\t\tlogger.error(`Collection export failed for ${collectionId}`, {\n\t\t\tuserId: locals.user?._id,\n\t\t\terror: errorMsg,\n\t\t\tduration: `${duration.toFixed(2)}ms`\n\t\t});\n\n\t\tif (typeof err === 'object' && err !== null && 'status' in err && 'body' in err) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, `Export failed: ${errorMsg}`);\n\t}\n};\n\n/**\n * Convert array of objects to CSV format\n */\nfunction convertToCSV(data: unknown[]): string {\n\tif (!data || data.length === 0) {\n\t\treturn '';\n\t}\n\n\t// Get all unique keys from the data\n\tconst allKeys = new Set<string>();\n\tdata.forEach((item) => {\n\t\tif (item && typeof item === 'object') {\n\t\t\tObject.keys(item as Record<string, unknown>).forEach((key) => allKeys.add(key));\n\t\t}\n\t});\n\n\tconst headers = Array.from(allKeys);\n\n\t// Create CSV content\n\tconst csvRows = [\n\t\t// Header row\n\t\theaders.map((header) => `\"${header}\"`).join(','),\n\t\t// Data rows\n\t\t...data.map((item) => {\n\t\t\tconst record = item as Record<string, unknown>;\n\t\t\treturn headers\n\t\t\t\t.map((header) => {\n\t\t\t\t\tconst value = record[header];\n\t\t\t\t\tif (value === null || value === undefined) {\n\t\t\t\t\t\treturn '\"\"';\n\t\t\t\t\t}\n\t\t\t\t\t// Escape quotes and wrap in quotes\n\t\t\t\t\tconst stringValue = String(value).replace(/\"/g, '\"\"');\n\t\t\t\t\treturn `\"${stringValue}\"`;\n\t\t\t\t})\n\t\t\t\t.join(',');\n\t\t})\n\t];\n\n\treturn csvRows.join('\\n');\n}\n"],"names":[],"mappings":";;;;AA0BO,MAAM,MAAsB,OAAO,EAAE,QAAQ,KAAK,aAAa;AACrE,QAAM,YAAY,YAAY,IAAA;AAC9B,QAAM,EAAE,iBAAiB;AAEzB,MAAI;AACH,QAAI,CAAC,OAAO,MAAM;AACjB,YAAM,MAAM,KAAK,cAAc;AAAA,IAChC;AAGA,UAAM,SAAS,MAAM,eAAe,cAAc,YAAY;AAE9D,QAAI,CAAC,QAAQ;AACZ,YAAM,MAAM,KAAK,eAAe,YAAY,aAAa;AAAA,IAC1D;AAGA,UAAM,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK;AACjD,UAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,GAAG;AAC3D,UAAM,SAAS,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK,GAAG;AAC7D,UAAM,SAAS,IAAI,aAAa,IAAI,QAAQ;AAC5C,UAAM,YAAY,IAAI,aAAa,IAAI,WAAW;AAClD,UAAM,gBAAiB,IAAI,aAAa,IAAI,eAAe,KAAwB;AAGnF,UAAM,eAAwC,CAAA;AAE9C,QAAI,QAAQ,GAAG;AACd,mBAAa,QAAQ,KAAK,IAAI,OAAO,GAAK;AAAA,IAC3C;AAEA,QAAI,SAAS,GAAG;AACf,mBAAa,SAAS;AAAA,IACvB;AAEA,QAAI,WAAW;AACd,mBAAa,OAAO,EAAE,CAAC,SAAS,GAAG,kBAAkB,QAAQ,IAAI,GAAA;AAAA,IAClE;AAGA,QAAI,cAAc,CAAA;AAClB,QAAI,QAAQ;AACX,UAAI;AAEH,sBAAc,KAAK,MAAM,MAAM;AAAA,MAChC,SAAS,KAAK;AACb,cAAM,WAAW,eAAe,QAAQ,IAAI,UAAU;AACtD,eAAO,KAAK,yBAAyB,EAAE,QAAQ,OAAO,UAAU;AAAA,MACjE;AAAA,IACD;AAGA,WAAO,MAAM,wBAAwB,YAAY,IAAI;AAAA,MACpD,QAAQ,OAAO,KAAK;AAAA,MACpB;AAAA,MACA;AAAA,MACA;AAAA,MACA,QAAQ;AAAA,IAAA,CACR;AAED,QAAI,CAAC,WAAW;AACf,YAAM,MAAM,KAAK,kCAAkC;AAAA,IACpD;AAEA,UAAM,SAAS,MAAM,UAAU,KAAK,SAAS,cAAc,OAAO,GAAG,IAAI,aAAa,YAAY;AAElG,QAAI,CAAC,OAAO,SAAS;AACpB,YAAM,MAAM,KAAK,qCAAqC,OAAO,KAAK,EAAE;AAAA,IACrE;AAEA,UAAM,aAAa,OAAO,QAAQ,CAAA;AAClC,UAAM,WAAW,YAAY,IAAA,IAAQ;AAErC,WAAO,KAAK,cAAc,YAAY,0BAA0B;AAAA,MAC/D,QAAQ,OAAO,KAAK;AAAA,MACpB,aAAa,WAAW;AAAA,MACxB,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC;AAAA,MAChC;AAAA,IAAA,CACA;AAGD,QAAI,WAAW,OAAO;AACrB,YAAM,UAAU,aAAa,UAAU;AACvC,aAAO,IAAI,SAAS,SAAS;AAAA,QAC5B,SAAS;AAAA,UACR,gBAAgB;AAAA,UAChB,uBAAuB,yBAAyB,YAAY;AAAA,QAAA;AAAA,MAC7D,CACA;AAAA,IACF,OAAO;AAEN,aAAO,KAAK;AAAA,QACX,SAAS;AAAA,QACT,YAAY;AAAA,QACZ,MAAM;AAAA,QACN,UAAU;AAAA,UACT,OAAO,WAAW;AAAA,UAClB;AAAA,UACA;AAAA,UACA,aAAY,oBAAI,KAAA,GAAO,YAAA;AAAA,UACvB,QAAQ;AAAA,YACP,MAAM,OAAO;AAAA,YACb,OAAO,OAAO;AAAA,YACd,QAAQ,OAAO,QAAQ,IAAI,CAAC,MAAe;AAC1C,oBAAM,QAAQ;AACd,qBAAO;AAAA,gBACN,MAAM,MAAM;AAAA,gBACZ,MAAM,MAAM;AAAA,gBACZ,OAAO,MAAM;AAAA,gBACb,UAAU,MAAM;AAAA,cAAA;AAAA,YAElB,CAAC;AAAA,UAAA;AAAA,QACF;AAAA,MACD,CACA;AAAA,IACF;AAAA,EACD,SAAS,KAAK;AACb,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,UAAM,WAAW,eAAe,QAAQ,IAAI,UAAU;AACtD,WAAO,MAAM,gCAAgC,YAAY,IAAI;AAAA,MAC5D,QAAQ,OAAO,MAAM;AAAA,MACrB,OAAO;AAAA,MACP,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC;AAAA,IAAA,CAChC;AAED,QAAI,OAAO,QAAQ,YAAY,QAAQ,QAAQ,YAAY,OAAO,UAAU,KAAK;AAChF,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,kBAAkB,QAAQ,EAAE;AAAA,EAC9C;AACD;AAKA,SAAS,aAAa,MAAyB;AAC9C,MAAI,CAAC,QAAQ,KAAK,WAAW,GAAG;AAC/B,WAAO;AAAA,EACR;AAGA,QAAM,8BAAc,IAAA;AACpB,OAAK,QAAQ,CAAC,SAAS;AACtB,QAAI,QAAQ,OAAO,SAAS,UAAU;AACrC,aAAO,KAAK,IAA+B,EAAE,QAAQ,CAAC,QAAQ,QAAQ,IAAI,GAAG,CAAC;AAAA,IAC/E;AAAA,EACD,CAAC;AAED,QAAM,UAAU,MAAM,KAAK,OAAO;AAGlC,QAAM,UAAU;AAAA;AAAA,IAEf,QAAQ,IAAI,CAAC,WAAW,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AAAA;AAAA,IAE/C,GAAG,KAAK,IAAI,CAAC,SAAS;AACrB,YAAM,SAAS;AACf,aAAO,QACL,IAAI,CAAC,WAAW;AAChB,cAAM,QAAQ,OAAO,MAAM;AAC3B,YAAI,UAAU,QAAQ,UAAU,QAAW;AAC1C,iBAAO;AAAA,QACR;AAEA,cAAM,cAAc,OAAO,KAAK,EAAE,QAAQ,MAAM,IAAI;AACpD,eAAO,IAAI,WAAW;AAAA,MACvB,CAAC,EACA,KAAK,GAAG;AAAA,IACX,CAAC;AAAA,EAAA;AAGF,SAAO,QAAQ,KAAK,IAAI;AACzB;"}