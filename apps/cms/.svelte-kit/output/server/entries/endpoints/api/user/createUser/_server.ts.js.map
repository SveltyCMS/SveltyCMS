{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/user/createUser/+server.ts"],"sourcesContent":["/**\n * @file: src/routes/api/user/createUser/+server.ts\n * @description: API endpoint for creating a new user directly in the CMS.\n *\n * This endpoint handles POST requests to create a new user. It is a direct,\n * admin-only action and does not send an invitation email. For inviting users\n * to register themselves, use the `createToken` endpoint.\n *\n * Features:\n * - **Defense in Depth**: Specific permission check to ensure only authorized admins can create users.\n * - **Input Validation**: Uses a Valibot schema to validate and sanitize the incoming user data.\n * - **Optimized Session Creation**: Optionally creates user and session in single database transaction\n * - Safeguards against creating duplicate users within the same tenant.\n * - Comprehensive logging and secure error responses.\n *\n * @example\n * // Create user only\n * POST /api/user/createUser\n * { \"email\": \"user@example.com\", \"role\": \"user\", \"password\": \"secret\" }\n *\n * // Create user with session (optimized single transaction)\n * POST /api/user/createUser\n * { \"email\": \"user@example.com\", \"role\": \"user\", \"password\": \"secret\", \"createSession\": \"7d\" }\n * // Returns: { ...userData, sessionId: \"...\", sessionExpires: \"...\" }\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\nimport type { RequestHandler } from '@sveltejs/kit';\nimport { error, json, type HttpError } from '@sveltejs/kit';\n\n// Auth and permission helpers\nimport { auth } from '@shared/database/db';\n\n// Types\nimport type { ISODateString } from '@cms-types';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Input validation\nimport { email, object, optional, parse, pipe, string } from 'valibot';\n\n// Helper function to parse session duration strings\nfunction parseSessionDuration(duration: string): number {\n\tconst durationMap: Record<string, number> = {\n\t\t'1h': 60 * 60 * 1000, // 1 hour\n\t\t'1d': 24 * 60 * 60 * 1000, // 1 day\n\t\t'7d': 7 * 24 * 60 * 60 * 1000, // 7 days\n\t\t'30d': 30 * 24 * 60 * 60 * 1000, // 30 days\n\t\t'90d': 90 * 24 * 60 * 60 * 1000 // 90 days\n\t};\n\n\treturn durationMap[duration] || durationMap['7d']; // Default to 7 days\n}\n\n// Define a schema for the incoming user data to ensure type safety and prevent invalid data.\nconst createUserSchema = object({\n\temail: pipe(string(), email('Please provide a valid email address.')),\n\trole: string('A role ID must be provided.'),\n\tusername: optional(string()),\n\tpassword: string(),\n\tcreateSession: optional(string()) // Optional: '1h', '1d', '7d', '30d', '90d' - session duration\n});\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\ttry {\n\t\tconst { user, tenantId } = locals; // Destructure user and tenantId from locals\n\t\t// Authentication is handled by hooks.server.ts - user presence confirms access\n\n\t\tif (!auth) {\n\t\t\tlogger.error('Authentication system is not initialized');\n\t\t\tthrow error(500, 'Internal Server Error: Auth system not initialized');\n\t\t}\n\n\t\tconst body = await request.json();\n\t\t// Validate and sanitize the incoming user data.\n\t\tconst userData = parse(createUserSchema, body);\n\t\tlogger.debug('Received and validated request to create user', { email: userData.email, byUser: user?._id, tenantId });\n\t\t// Check if a user with this email already exists within the same tenant to prevent duplicates.\n\t\tconst userCheckCriteria: { email: string; tenantId?: string } = { email: userData.email };\n\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\tuserCheckCriteria.tenantId = tenantId;\n\t\t}\n\t\tconst existingUser = await auth.checkUser(userCheckCriteria);\n\t\tif (existingUser) {\n\t\t\tlogger.warn('Attempted to create a user that already exists in this tenant', { email: userData.email, tenantId });\n\t\t\tthrow error(409, 'A user with this email address already exists in this tenant.'); // 409 Conflict\n\t\t}\n\n\t\t// Check if session creation is requested\n\t\tconst shouldCreateSession = !!userData.createSession;\n\n\t\tif (shouldCreateSession) {\n\t\t\t// Use optimized createUserAndSession for single database transaction\n\t\t\tconst sessionDuration = parseSessionDuration(userData.createSession || '7d');\n\t\t\tconst expires = new Date(Date.now() + sessionDuration).toISOString() as ISODateString;\n\n\t\t\tlogger.debug('Creating user with session', {\n\t\t\t\temail: userData.email,\n\t\t\t\tsessionExpires: expires,\n\t\t\t\ttenantId\n\t\t\t});\n\n\t\t\tconst result = await auth.createUserAndSession(\n\t\t\t\t{\n\t\t\t\t\t...userData,\n\t\t\t\t\t...(getPrivateSettingSync('MULTI_TENANT') && { tenantId }),\n\t\t\t\t\tisRegistered: true,\n\t\t\t\t\tlastAuthMethod: 'password'\n\t\t\t\t},\n\t\t\t\t{ expires, tenantId }\n\t\t\t);\n\n\t\t\tif (!result.success || !result.data) {\n\t\t\t\tconst errorMessage = !result.success && 'error' in result ? result.error?.message : 'Failed to create user and session';\n\t\t\t\tthrow error(500, errorMessage);\n\t\t\t}\n\n\t\t\tlogger.info('User and session created successfully via direct API call', {\n\t\t\t\tnewUserId: result.data.user._id,\n\t\t\t\tsessionId: result.data.session._id,\n\t\t\t\tcreatedBy: user?._id,\n\t\t\t\ttenantId\n\t\t\t});\n\n\t\t\t// Return user data with session info\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\t...result.data.user,\n\t\t\t\t\tsessionId: result.data.session._id,\n\t\t\t\t\tsessionExpires: result.data.session.expires\n\t\t\t\t},\n\t\t\t\t{ status: 201 }\n\t\t\t);\n\t\t}\n\n\t\t// Create the user without session (original behavior)\n\t\tconst newUser = await auth.createUser({\n\t\t\t...userData,\n\t\t\t...(getPrivateSettingSync('MULTI_TENANT') && { tenantId }), // Conditionally add tenantId\n\t\t\tisRegistered: true, // Assuming direct creation means they are fully registered.\n\t\t\tlastAuthMethod: 'password' // Or a default value.\n\t\t});\n\t\tlogger.info('User created successfully via direct API call', { newUserId: newUser._id, createdBy: user?._id, tenantId });\n\t\t// Return the newly created user data with a 201 Created status.\n\t\treturn json(newUser, { status: 201 });\n\t} catch (err) {\n\t\t// Handle specific validation errors from Valibot.\n\t\tif (err instanceof Error && err.name === 'ValiError') {\n\t\t\tconst valiError = err as unknown as { issues: Array<{ message: string }> };\n\t\t\tconst issues = valiError.issues.map((issue: { message: string }) => issue.message).join(', ');\n\t\t\tlogger.warn('Invalid input for createUser API:', { issues });\n\t\t\tthrow error(400, `Invalid input: ${issues}`);\n\t\t}\n\n\t\t// Handle all other errors, including HTTP errors from `throw error()`.\n\t\tconst httpError = err as HttpError;\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || 'An unexpected error occurred while creating the user.';\n\n\t\tlogger.error('Error in createUser API:', {\n\t\t\terror: message,\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tuserId: locals.user?._id,\n\t\t\tstatus\n\t\t});\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: status === 500 ? 'Internal Server Error' : message\n\t\t\t},\n\t\t\t{ status }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}