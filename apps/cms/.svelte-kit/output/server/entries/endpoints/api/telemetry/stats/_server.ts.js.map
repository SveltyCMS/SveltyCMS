{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/telemetry/stats/+server.ts"],"sourcesContent":["/*\n * @files api/telemetry/stats/+server.ts\n * @description Telemetry Statistics (Mock Receiver Implementation)\n *\n * NOTE: This endpoint demonstrates how a Telemetry Receiver would aggregate data.\n * It uses mock data for demonstration purposes.\n *\n * ### Features\n * - Aggregations\n * - Admin Access Secured\n */\nimport { json } from '@sveltejs/kit';\nimport type { RequestEvent } from './$types';\n\n// Mock Database for demonstration\n// In a real Receiver implementation, this would query the telemetry database.\nconst MOCK_DB_DATA = Array.from({ length: 50 }, (_, i) => ({\n\tid: crypto.randomUUID(),\n\tdomain: i % 5 === 0 ? 'internal.corporate.com' : `blog-${i}.example.com`,\n\tversion: i % 3 === 0 ? '0.5.0' : '0.4.9',\n\tnode_version: i % 2 === 0 ? 'v20.10.0' : 'v18.17.0',\n\tdb_type: i % 4 === 0 ? 'postgres' : 'mongodb',\n\tcountry: ['US', 'DE', 'FR', 'GB', 'JP'][i % 5],\n\tlast_seen: new Date().toISOString(),\n\tenvironment: i % 10 === 0 ? 'development' : 'production',\n\trevenue_est: i % 5 === 0 ? '> $10M' : '< $1M'\n}));\n\nexport async function GET({ locals }: RequestEvent) {\n\tconst isAdmin = locals.user?.isAdmin || false;\n\n\t// 1. Calculate Aggregations\n\tconst stats = {\n\t\ttotal_installs: MOCK_DB_DATA.length,\n\t\tversions: aggregate(MOCK_DB_DATA, 'version'),\n\t\tdatabases: aggregate(MOCK_DB_DATA, 'db_type'),\n\t\tnodes: aggregate(MOCK_DB_DATA, 'node_version'),\n\t\tcountries: aggregate(MOCK_DB_DATA, 'country')\n\t};\n\n\tconst responseData = isAdmin ? { role: 'admin', aggregates: stats, raw_data: MOCK_DB_DATA } : { role: 'guest', aggregates: stats, raw_data: [] };\n\n\treturn json({\n\t\tsuccess: true,\n\t\tdata: responseData,\n\t\tmessage: 'Telemetry statistics retrieved (Mock)'\n\t});\n}\n\n// Helper to group and count\nfunction aggregate(data: any[], key: string) {\n\tconst map = new Map();\n\tdata.forEach((item) => {\n\t\tconst val = item[key];\n\t\tmap.set(val, (map.get(val) || 0) + 1);\n\t});\n\treturn Array.from(map.entries()).map(([label, count]) => ({ label, count }));\n}\n"],"names":[],"mappings":";AAgBA,MAAM,eAAe,MAAM,KAAK,EAAE,QAAQ,MAAM,CAAC,GAAG,OAAO;AAAA,EAC1D,IAAI,OAAO,WAAA;AAAA,EACX,QAAQ,IAAI,MAAM,IAAI,2BAA2B,QAAQ,CAAC;AAAA,EAC1D,SAAS,IAAI,MAAM,IAAI,UAAU;AAAA,EACjC,cAAc,IAAI,MAAM,IAAI,aAAa;AAAA,EACzC,SAAS,IAAI,MAAM,IAAI,aAAa;AAAA,EACpC,SAAS,CAAC,MAAM,MAAM,MAAM,MAAM,IAAI,EAAE,IAAI,CAAC;AAAA,EAC7C,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,EACtB,aAAa,IAAI,OAAO,IAAI,gBAAgB;AAAA,EAC5C,aAAa,IAAI,MAAM,IAAI,WAAW;AACvC,EAAE;AAEF,eAAsB,IAAI,EAAE,UAAwB;AACnD,QAAM,UAAU,OAAO,MAAM,WAAW;AAGxC,QAAM,QAAQ;AAAA,IACb,gBAAgB,aAAa;AAAA,IAC7B,UAAU,UAAU,cAAc,SAAS;AAAA,IAC3C,WAAW,UAAU,cAAc,SAAS;AAAA,IAC5C,OAAO,UAAU,cAAc,cAAc;AAAA,IAC7C,WAAW,UAAU,cAAc,SAAS;AAAA,EAAA;AAG7C,QAAM,eAAe,UAAU,EAAE,MAAM,SAAS,YAAY,OAAO,UAAU,aAAA,IAAiB,EAAE,MAAM,SAAS,YAAY,OAAO,UAAU,GAAC;AAE7I,SAAO,KAAK;AAAA,IACX,SAAS;AAAA,IACT,MAAM;AAAA,IACN,SAAS;AAAA,EAAA,CACT;AACF;AAGA,SAAS,UAAU,MAAa,KAAa;AAC5C,QAAM,0BAAU,IAAA;AAChB,OAAK,QAAQ,CAAC,SAAS;AACtB,UAAM,MAAM,KAAK,GAAG;AACpB,QAAI,IAAI,MAAM,IAAI,IAAI,GAAG,KAAK,KAAK,CAAC;AAAA,EACrC,CAAC;AACD,SAAO,MAAM,KAAK,IAAI,QAAA,CAAS,EAAE,IAAI,CAAC,CAAC,OAAO,KAAK,OAAO,EAAE,OAAO,QAAQ;AAC5E;"}