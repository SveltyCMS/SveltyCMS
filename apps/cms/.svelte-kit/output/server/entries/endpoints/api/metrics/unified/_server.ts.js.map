{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/metrics/unified/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/metrics/unified/+server.ts\n * @description Unified metrics API endpoint for dashboard widgets\n *\n * ### Features\n * - Comprehensive metrics from MetricsService\n * - Real-time performance data\n * - Security metrics integration\n * - Cache and authentication statistics\n * - Performance bottleneck identification\n *\n * @endpoint GET /api/metrics/unified\n */\n\nimport { json, type RequestHandler } from '@sveltejs/kit';\nimport { metricsService } from '@shared/services/MetricsService';\nimport { logger } from '@shared/utils/logger.server';\n\n/**\n * GET /api/metrics/unified\n * Returns comprehensive system metrics for dashboard monitoring.\n */\nexport const GET: RequestHandler = async ({ locals }) => {\n\ttry {\n\t\t// Get comprehensive metrics report\n\t\tconst metricsReport = metricsService.getReport();\n\n\t\t// Add some additional computed metrics for the dashboard\n\t\tconst enhancedMetrics = {\n\t\t\t...metricsReport,\n\n\t\t\t// Enhanced performance indicators\n\t\t\tperformance: {\n\t\t\t\t...metricsReport.performance,\n\n\t\t\t\t// Add performance score (0-100)\n\t\t\t\tperformanceScore: calculatePerformanceScore(metricsReport),\n\n\t\t\t\t// Response time classification\n\t\t\t\tresponseTimeStatus: classifyResponseTime(metricsReport.requests.avgResponseTime),\n\n\t\t\t\t// System load indicators\n\t\t\t\tsystemLoad: {\n\t\t\t\t\thigh: metricsReport.performance.slowRequests > 10,\n\t\t\t\t\tbottlenecksDetected: metricsReport.performance.bottlenecks.length > 0,\n\t\t\t\t\thookPerformanceOk: metricsReport.performance.avgHookExecutionTime < 50\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t// Enhanced authentication metrics\n\t\t\tauthentication: {\n\t\t\t\t...metricsReport.authentication,\n\n\t\t\t\t// Authentication health indicators\n\t\t\t\tauthHealthy: metricsReport.authentication.successRate > 95,\n\t\t\t\tcacheEffective: metricsReport.authentication.cacheHitRate > 80,\n\n\t\t\t\t// Cache performance classification\n\t\t\t\tcacheStatus: classifyCachePerformance(metricsReport.authentication.cacheHitRate)\n\t\t\t},\n\n\t\t\t// Enhanced API metrics\n\t\t\tapi: {\n\t\t\t\t...metricsReport.api,\n\n\t\t\t\t// API health indicators\n\t\t\t\tapiHealthy: metricsReport.api.requests > 0 ? metricsReport.api.errors / metricsReport.api.requests < 0.05 : true,\n\t\t\t\tcacheEffective: metricsReport.api.cacheHitRate > 70,\n\n\t\t\t\t// API performance classification\n\t\t\t\terrorRateStatus: classifyErrorRate(metricsReport.api.requests > 0 ? (metricsReport.api.errors / metricsReport.api.requests) * 100 : 0)\n\t\t\t},\n\n\t\t\t// Enhanced security metrics\n\t\t\tsecurity: {\n\t\t\t\t...metricsReport.security,\n\n\t\t\t\t// Security threat level\n\t\t\t\tthreatLevel: calculateThreatLevel(metricsReport.security),\n\n\t\t\t\t// Security status indicators\n\t\t\t\tsecurityHealthy:\n\t\t\t\t\tmetricsReport.security.rateLimitViolations < 20 && metricsReport.security.cspViolations < 10 && metricsReport.security.authFailures < 10\n\t\t\t},\n\n\t\t\t// System metadata\n\t\t\tmetadata: {\n\t\t\t\tlastUpdated: Date.now(),\n\t\t\t\tdataSource: 'MetricsService',\n\t\t\t\tversion: '1.0',\n\t\t\t\tisRealTime: true\n\t\t\t}\n\t\t};\n\n\t\t// Log metrics access for monitoring\n\t\tlogger.trace('Unified metrics accessed', {\n\t\t\tuserId: locals.user?._id || 'anonymous',\n\t\t\tperformanceScore: enhancedMetrics.performance.performanceScore,\n\t\t\tthreatLevel: enhancedMetrics.security.threatLevel\n\t\t});\n\n\t\treturn json(enhancedMetrics);\n\t} catch (error) {\n\t\tlogger.error('Error fetching unified metrics:', error);\n\t\treturn json(\n\t\t\t{\n\t\t\t\terror: 'Failed to fetch metrics',\n\t\t\t\ttimestamp: Date.now()\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n\n/**\n * Calculate overall performance score (0-100) based on multiple factors.\n */\nfunction calculatePerformanceScore(metrics: ReturnType<typeof metricsService.getReport>): number {\n\tconst factors = {\n\t\t// Response time score (0-30 points)\n\t\tresponseTime: Math.max(0, 30 - metrics.requests.avgResponseTime / 100),\n\n\t\t// Error rate score (0-25 points)\n\t\terrorRate: Math.max(0, 25 - metrics.requests.errorRate * 5),\n\n\t\t// Cache efficiency score (0-20 points)\n\t\tcacheEfficiency: (metrics.authentication.cacheHitRate + metrics.api.cacheHitRate) / 10,\n\n\t\t// Authentication success score (0-15 points)\n\t\tauthSuccess: Math.max(0, ((metrics.authentication.successRate - 80) / 20) * 15),\n\n\t\t// Security score (0-10 points)\n\t\tsecurity: Math.max(0, 10 - (metrics.security.rateLimitViolations / 5 + metrics.security.cspViolations / 2 + metrics.security.authFailures / 3))\n\t};\n\n\tconst totalScore = Math.min(\n\t\t100,\n\t\tMath.max(0, factors.responseTime + factors.errorRate + factors.cacheEfficiency + factors.authSuccess + factors.security)\n\t);\n\n\treturn Math.round(totalScore);\n}\n\n/**\n * Classify response time performance.\n */\nfunction classifyResponseTime(avgResponseTime: number): 'excellent' | 'good' | 'fair' | 'poor' | 'critical' {\n\tif (avgResponseTime < 100) return 'excellent';\n\tif (avgResponseTime < 300) return 'good';\n\tif (avgResponseTime < 500) return 'fair';\n\tif (avgResponseTime < 1000) return 'poor';\n\treturn 'critical';\n}\n\n/**\n * Classify cache performance.\n */\nfunction classifyCachePerformance(hitRate: number): 'excellent' | 'good' | 'fair' | 'poor' {\n\tif (hitRate >= 90) return 'excellent';\n\tif (hitRate >= 80) return 'good';\n\tif (hitRate >= 60) return 'fair';\n\treturn 'poor';\n}\n\n/**\n * Classify error rate.\n */\nfunction classifyErrorRate(errorRate: number): 'excellent' | 'good' | 'fair' | 'poor' | 'critical' {\n\tif (errorRate < 0.5) return 'excellent';\n\tif (errorRate < 1) return 'good';\n\tif (errorRate < 2) return 'fair';\n\tif (errorRate < 5) return 'poor';\n\treturn 'critical';\n}\n\n/**\n * Calculate security threat level.\n */\nfunction calculateThreatLevel(security: {\n\trateLimitViolations: number;\n\tcspViolations: number;\n\tauthFailures: number;\n}): 'low' | 'medium' | 'high' | 'critical' {\n\tconst violationScore = security.rateLimitViolations + security.cspViolations * 2 + security.authFailures * 1.5;\n\n\tif (violationScore >= 100) return 'critical';\n\tif (violationScore >= 50) return 'high';\n\tif (violationScore >= 20) return 'medium';\n\treturn 'low';\n}\n"],"names":[],"mappings":"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"}