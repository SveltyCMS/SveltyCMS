{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/validate/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/validate/+server.ts\n * @description API endpoint for validating collections and widget integrity\n */\nimport { contentManager } from '@content/ContentManager';\nimport { json } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestHandler } from './$types';\n// Helper to calculate file processing hash (Placeholder for future implementation)\n// async function calculateWidgetHash(widgetName: string): Promise<string | null> { ... }\n\nexport const GET: RequestHandler = async ({ locals, request, url }) => {\n\tconst start = performance.now();\n\tconst tenantId = request.headers.get('X-Tenant-ID') || locals.tenantId || 'default';\n\n\ttry {\n\t\t// Get active widgets from query params (sent by client)\n\t\tconst activeWidgetsParam = url.searchParams.get('activeWidgets');\n\t\tconst activeWidgets = activeWidgetsParam ? activeWidgetsParam.split(',') : [];\n\n\t\tlogger.info('[API] Validation request started', { tenantId, activeWidgetsCount: activeWidgets.length });\n\n\t\t// Get all collections from ContentManager, scoped by tenantId\n\t\tconst allCollections = contentManager.getCollections();\n\n\t\tif (!allCollections || Object.keys(allCollections).length === 0) {\n\t\t\treturn json({\n\t\t\t\tsuccess: true,\n\t\t\t\tdata: { valid: 0, invalid: 0, warnings: [], tenantId, integrityIssues: [] },\n\t\t\t\tmessage: 'No collections found to validate'\n\t\t\t});\n\t\t}\n\n\t\tconst warnings: string[] = [];\n\t\tconst integrityIssues: string[] = [];\n\t\tlet validCollections = 0;\n\t\tlet invalidCollections = 0;\n\n\t\tfor (const [, collection] of Object.entries(allCollections)) {\n\t\t\tconst coll = collection as Record<string, unknown>;\n\t\t\tif (!coll.fields) {\n\t\t\t\tvalidCollections++;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tlet collectionValid = true;\n\t\t\tconst missingWidgets: string[] = [];\n\n\t\t\tfor (const field of coll.fields as Array<Record<string, unknown>>) {\n\t\t\t\tif (field && typeof field === 'object') {\n\t\t\t\t\tlet widgetType: string | undefined;\n\n\t\t\t\t\t// Modern architecture: get widget name from widget.Name\n\t\t\t\t\tif ('widget' in field && field.widget && typeof field.widget === 'object' && 'Name' in field.widget) {\n\t\t\t\t\t\twidgetType = String(field.widget.Name);\n\t\t\t\t\t}\n\t\t\t\t\t// Legacy compatibility: fallback to type property\n\t\t\t\t\telse if ('type' in field && field.type) {\n\t\t\t\t\t\twidgetType = String(field.type);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (widgetType) {\n\t\t\t\t\t\tconst capitalizedWidget = widgetType.charAt(0).toUpperCase() + widgetType.slice(1);\n\n\t\t\t\t\t\tif (!activeWidgets.includes(capitalizedWidget)) {\n\t\t\t\t\t\t\tmissingWidgets.push(capitalizedWidget);\n\t\t\t\t\t\t\tcollectionValid = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (collectionValid) {\n\t\t\t\tvalidCollections++;\n\t\t\t} else {\n\t\t\t\tinvalidCollections++;\n\t\t\t\twarnings.push(`Collection \"${(coll.name as string) || (coll._id as string)}\" requires inactive widgets: ${missingWidgets.join(', ')}`);\n\t\t\t}\n\t\t}\n\n\t\t// Security: Integrity Check (Placeholder for now)\n\t\t// We would loop through active widgets and verify their signatures\n\t\tif (activeWidgets.length > 0) {\n\t\t\t// Example integrity check logic\n\t\t\t// for (const widget of activeWidgets) {\n\t\t\t// \tconst hash = await calculateWidgetHash(widget);\n\t\t\t// \tif (!hash) integrityIssues.push(`Integrity check failed for ${widget}`);\n\t\t\t// }\n\t\t}\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info('[API] Validation completed', {\n\t\t\ttenantId,\n\t\t\tstats: {\n\t\t\t\ttotal: Object.keys(allCollections).length,\n\t\t\t\tvalid: validCollections,\n\t\t\t\tinvalid: invalidCollections,\n\t\t\t\twarnings: warnings.length,\n\t\t\t\tintegrityIssues: integrityIssues.length\n\t\t\t},\n\t\t\tduration: `${duration.toFixed(2)}ms`\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tvalid: validCollections,\n\t\t\t\tinvalid: invalidCollections,\n\t\t\t\twarnings,\n\t\t\t\tintegrityIssues,\n\t\t\t\ttotal: Object.keys(allCollections).length,\n\t\t\t\ttenantId\n\t\t\t},\n\t\t\tmessage: 'Validation completed successfully'\n\t\t});\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to validate collections: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms`, stack: err instanceof Error ? err.stack : undefined });\n\n\t\t// Use standardized error response even for 500\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}