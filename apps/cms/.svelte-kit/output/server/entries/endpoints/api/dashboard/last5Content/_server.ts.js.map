{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/dashboard/last5Content/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/dashboard/last5Content/+server.ts\n * @description API endpoint for recent content data for dashboard widgets using database-agnostic adapter.\n *\n * @example GET /api/dashboard/last5Content\n *\n * Features:\n * - **Secure Authorization:** Access is controlled centrally by `src/hooks.server.ts`.\n * - **Database-Agnostic:** Uses standardized adapter methods for cross-database compatibility.\n * - **Input Validation:** Safely validates and caps the `limit` query parameter.\n * - **Multi-Tenant Safe:** All data lookups are scoped to the current tenant.\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { error, json } from '@sveltejs/kit';\nimport { v4 as uuidv4 } from 'uuid';\nimport type { RequestHandler } from './$types';\n\nimport { contentManager } from '@content/ContentManager';\nimport { dbAdapter } from '@shared/database/db';\nimport type { BaseEntity, ISODateString, DatabaseId } from '@cms-types';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Validation\nimport * as v from 'valibot';\nimport { nowISODateString } from '@shared/utils/dateUtils';\n\nconst QuerySchema = v.object({\n\tlimit: v.optional(v.pipe(v.number(), v.minValue(1), v.maxValue(20)), 5)\n});\n\n// All dates should be ISO date strings (see dateUtils)\nconst ContentItemSchema = v.object({\n\tid: v.string(),\n\ttitle: v.string(),\n\tcollection: v.string(),\n\tcreatedAt: v.string(), // ISODateString\n\tcreatedBy: v.string(),\n\tstatus: v.string()\n});\n\n// --- API Handler ---\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\tconst { user, tenantId } = locals;\n\ttry {\n\t\t// Authentication is handled by hooks.server.ts\n\t\tif (!user) {\n\t\t\tlogger.warn('Unauthorized attempt to access recent content data');\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\t// 1. Validate Input\n\t\tconst query = v.parse(QuerySchema, {\n\t\t\tlimit: Number(url.searchParams.get('limit')) || undefined\n\t\t});\n\n\t\t// 2. Get all collection schemas the user can read (scoped to the tenant)\n\t\tlet allCollections;\n\t\ttry {\n\t\t\tallCollections = await contentManager.getCollections();\n\t\t} catch (err) {\n\t\t\tlogger.error('Failed to get collections:', err);\n\t\t\tthrow error(500, 'Could not access collections');\n\t\t}\n\n\t\tif (!allCollections || Object.keys(allCollections).length === 0) {\n\t\t\tlogger.info('No collections found, returning empty result');\n\t\t\treturn json([]);\n\t\t}\n\n\t\t// Narrow adapter once (avoid non-null assertions later)\n\t\tconst adapter = dbAdapter;\n\t\tif (!adapter) {\n\t\t\tlogger.error('Database adapter not available');\n\t\t\tthrow error(500, 'Database connection unavailable');\n\t\t}\n\n\t\t// 3. Process all collections (hooks already validated access)\n\t\tconst collectionsEntries = Object.entries(allCollections);\n\n\t\t// 4. Query EACH collection for its top 'limit' recent items efficiently (scoped to the tenant)\n\t\t// NOTE: Generic CRUD methods require T extends BaseEntity.\n\t\t// We include createdAt/updatedAt fields in the query even if we only\n\t\t// use createdAt for ordering to satisfy the constraint.\n\t\tinterface DashboardRawEntry extends BaseEntity {\n\t\t\ttitle?: string;\n\t\t\tname?: string;\n\t\t\tlabel?: string;\n\t\t\tcreated?: ISODateString | string;\n\t\t\tdate?: ISODateString | string;\n\t\t\tcreatedBy?: string;\n\t\t\tauthor?: string;\n\t\t\tcreator?: string;\n\t\t\tstatus?: string;\n\t\t\tstate?: string;\n\t\t\ttenantId?: string;\n\t\t\t[key: string]: unknown;\n\t\t}\n\n\t\tinterface UserDoc extends BaseEntity {\n\t\t\tusername?: string;\n\t\t\tfirstName?: string;\n\t\t\tlastName?: string;\n\t\t\temail?: string;\n\t\t\t[key: string]: unknown;\n\t\t}\n\n\t\tinterface CombinedEntry extends DashboardRawEntry {\n\t\t\tcollectionName: string;\n\t\t\tcollectionId: string;\n\t\t}\n\n\t\tconst resolveTimestamp = (e: DashboardRawEntry): string | undefined =>\n\t\t\te.createdAt || (e.created as string | undefined) || (e.date as string | undefined);\n\n\t\tconst queryPromises = collectionsEntries.map(async ([collectionId, collection]) => {\n\t\t\ttry {\n\t\t\t\tconst collectionName = `collection_${collection._id}`;\n\t\t\t\tconst filter = getPrivateSettingSync('MULTI_TENANT') ? { tenantId } : {};\n\n\t\t\t\t// Use database-agnostic CRUD methods with explicit generic\n\t\t\t\tconst result = await adapter.crud.findMany<DashboardRawEntry>(collectionName, filter as Partial<DashboardRawEntry>, {\n\t\t\t\t\tlimit: query.limit,\n\t\t\t\t\tfields: ['_id', 'title', 'name', 'label', 'createdAt', 'updatedAt', 'created', 'date', 'createdBy', 'author', 'creator', 'status', 'state']\n\t\t\t\t});\n\n\t\t\t\tif (result.success && Array.isArray(result.data)) {\n\t\t\t\t\treturn (result.data as DashboardRawEntry[]).map((entry) => ({\n\t\t\t\t\t\t...entry,\n\t\t\t\t\t\tcollectionName:\n\t\t\t\t\t\t\t(collection as unknown as { name?: string; label?: string }).name ||\n\t\t\t\t\t\t\t(collection as unknown as { label?: string }).label ||\n\t\t\t\t\t\t\t'Unknown Collection',\n\t\t\t\t\t\tcollectionId\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t\treturn [];\n\t\t\t} catch (err) {\n\t\t\t\tlogger.warn(`Failed to query collection ${collection.name}:`, err);\n\t\t\t\treturn [];\n\t\t\t}\n\t\t});\n\n\t\tconst results = await Promise.all(queryPromises);\n\n\t\t// 5. Flatten and sort the combined candidates (small dataset now)\n\t\tconst allEntries: CombinedEntry[] = results.flat() as CombinedEntry[];\n\n\t\t// Sort by creation date to find the absolute most recent across all collections\n\t\tallEntries.sort((a, b) => {\n\t\t\tconst tsA = resolveTimestamp(a);\n\t\t\tconst tsB = resolveTimestamp(b);\n\t\t\treturn new Date(tsB || 0).getTime() - new Date(tsA || 0).getTime();\n\t\t});\n\n\t\t// 6. Take only the requested limit and transform to final format\n\t\tconst limitedEntries: CombinedEntry[] = allEntries.slice(0, query.limit);\n\n\t\t// 7. Get unique user IDs for username lookup\n\t\tconst userIds = [...new Set(limitedEntries.map((entry) => entry.createdBy || entry.author || entry.creator).filter(Boolean))] as DatabaseId[];\n\n\t\t// 8. Lookup usernames\n\t\tconst userLookup = new Map();\n\t\tif (userIds.length > 0) {\n\t\t\ttry {\n\t\t\t\tconst userResult = await adapter.crud.findByIds<UserDoc>('auth_users', userIds, {\n\t\t\t\t\tfields: ['_id', 'username', 'email', 'firstName', 'lastName']\n\t\t\t\t});\n\t\t\t\tif (userResult.success && userResult.data) {\n\t\t\t\t\tfor (const u of userResult.data) {\n\t\t\t\t\t\tlet displayName = u.username;\n\t\t\t\t\t\tif (!displayName && (u.firstName || u.lastName)) {\n\t\t\t\t\t\t\tdisplayName = [u.firstName, u.lastName].filter(Boolean).join(' ');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!displayName) {\n\t\t\t\t\t\t\tdisplayName = u.email?.split('@')[0] || 'Unknown';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tuserLookup.set(String(u._id), displayName);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tlogger.warn('Failed to lookup usernames for content:', err);\n\t\t\t}\n\t\t}\n\n\t\t// 9. Transform to final format with usernames\n\t\tconst recentContent = limitedEntries.map((entry) => {\n\t\t\tconst userId = entry.createdBy || entry.author || entry.creator || 'Unknown';\n\t\t\tconst username = userLookup.get(String(userId)) || 'Unknown';\n\t\t\tconst ts = resolveTimestamp(entry);\n\t\t\tconst iso = ts ? new Date(ts).toISOString() : nowISODateString();\n\t\t\treturn {\n\t\t\t\tid: String(entry._id ?? (entry as Record<string, unknown>).id ?? uuidv4()),\n\t\t\t\ttitle: entry.title || entry.name || entry.label || 'Untitled',\n\t\t\t\tcollection: entry.collectionName,\n\t\t\t\tcreatedAt: iso,\n\t\t\t\tcreatedBy: username,\n\t\t\t\tstatus: entry.status || entry.state || 'publish'\n\t\t\t};\n\t\t});\n\n\t\tconst validatedData = v.parse(v.array(ContentItemSchema), recentContent);\n\n\t\tlogger.info('Recent content fetched efficiently', {\n\t\t\tcollectionsQueried: collectionsEntries.length,\n\t\t\ttotalCandidates: allEntries.length,\n\t\t\tfinalCount: validatedData.length,\n\t\t\trequestedBy: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\treturn json(validatedData);\n\t} catch (err) {\n\t\tif (err instanceof v.ValiError) {\n\t\t\tlogger.error('Content data failed validation', { error: err.issues });\n\t\t\tthrow error(500, 'Internal Server Error: Could not prepare content data.');\n\t\t}\n\t\tlogger.error('Error fetching recent content:', err);\n\t\tthrow error(500, 'An unexpected error occurred.');\n\t}\n};\n"],"names":["uuidv4"],"mappings":"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"}