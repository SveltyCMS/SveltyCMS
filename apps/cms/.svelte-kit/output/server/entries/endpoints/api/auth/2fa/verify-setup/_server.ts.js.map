{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../src/routes/api/auth/2fa/verify-setup/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/auth/2fa/verify-setup/+server.ts\n * @description API endpoint for completing 2FA setup by verifying the first TOTP code\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { getDefaultTwoFactorAuthService } from '@shared/database/auth/twoFactorAuth';\nimport { auth } from '@shared/database/db';\nimport { object, string, array, parse } from 'valibot';\n\n// Request body schema\nconst verifySetupSchema = object({\n\tsecret: string(),\n\tverificationCode: string(),\n\tbackupCodes: array(string())\n});\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\ttry {\n\t\t// Ensure user is authenticated\n\t\tif (!locals.user) {\n\t\t\tlogger.warn('Unauthorized 2FA setup verification attempt');\n\t\t\tthrow error(401, 'Authentication required');\n\t\t}\n\n\t\tconst user = locals.user;\n\t\tconst tenantId = user.tenantId;\n\n\t\t// Check if 2FA is already enabled\n\t\tif (user.is2FAEnabled) {\n\t\t\tlogger.warn('2FA setup verification attempted for user with 2FA already enabled', {\n\t\t\t\tuserId: user._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\tthrow error(400, '2FA is already enabled for this account');\n\t\t}\n\n\t\t// Parse and validate request body\n\t\tconst body = await request.json();\n\t\tconst validatedBody = parse(verifySetupSchema, body);\n\n\t\t// Complete 2FA setup\n\t\tif (!auth) {\n\t\t\tlogger.error('Auth service not initialized during 2FA setup verification');\n\t\t\tthrow error(500, 'Auth service not available');\n\t\t}\n\t\tconst twoFactorService = getDefaultTwoFactorAuthService(auth.authInterface);\n\t\tconst success = await twoFactorService.complete2FASetup(\n\t\t\tuser._id,\n\t\t\tvalidatedBody.secret,\n\t\t\tvalidatedBody.verificationCode,\n\t\t\tvalidatedBody.backupCodes,\n\t\t\ttenantId\n\t\t);\n\n\t\tif (!success) {\n\t\t\tlogger.warn('2FA setup verification failed - invalid code', {\n\t\t\t\tuserId: user._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\tthrow error(400, 'Invalid verification code. Please try again.');\n\t\t}\n\n\t\tlogger.info('2FA setup completed successfully', { userId: user._id, tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: '2FA has been successfully enabled for your account. Please save your backup codes in a secure location.'\n\t\t});\n\t} catch (err) {\n\t\tconst message = `2FA setup verification failed: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\n\t\tif (err instanceof Response) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tthrow error(500, 'Failed to complete 2FA setup');\n\t}\n};\n"],"names":[],"mappings":";;;;;AAaA,MAAM,oBAAoB,OAAO;AAAA,EAChC,QAAQ,OAAA;AAAA,EACR,kBAAkB,OAAA;AAAA,EAClB,aAAa,MAAM,OAAA,CAAQ;AAC5B,CAAC;AAEM,MAAM,OAAuB,OAAO,EAAE,SAAS,aAAa;AAClE,MAAI;AAEH,QAAI,CAAC,OAAO,MAAM;AACjB,aAAO,KAAK,6CAA6C;AACzD,YAAM,MAAM,KAAK,yBAAyB;AAAA,IAC3C;AAEA,UAAM,OAAO,OAAO;AACpB,UAAM,WAAW,KAAK;AAGtB,QAAI,KAAK,cAAc;AACtB,aAAO,KAAK,sEAAsE;AAAA,QACjF,QAAQ,KAAK;AAAA,QACb;AAAA,MAAA,CACA;AACD,YAAM,MAAM,KAAK,yCAAyC;AAAA,IAC3D;AAGA,UAAM,OAAO,MAAM,QAAQ,KAAA;AAC3B,UAAM,gBAAgB,MAAM,mBAAmB,IAAI;AAGnD,QAAI,CAAC,MAAM;AACV,aAAO,MAAM,4DAA4D;AACzE,YAAM,MAAM,KAAK,4BAA4B;AAAA,IAC9C;AACA,UAAM,mBAAmB,+BAA+B,KAAK,aAAa;AAC1E,UAAM,UAAU,MAAM,iBAAiB;AAAA,MACtC,KAAK;AAAA,MACL,cAAc;AAAA,MACd,cAAc;AAAA,MACd,cAAc;AAAA,MACd;AAAA,IAAA;AAGD,QAAI,CAAC,SAAS;AACb,aAAO,KAAK,gDAAgD;AAAA,QAC3D,QAAQ,KAAK;AAAA,QACb;AAAA,MAAA,CACA;AACD,YAAM,MAAM,KAAK,8CAA8C;AAAA,IAChE;AAEA,WAAO,KAAK,oCAAoC,EAAE,QAAQ,KAAK,KAAK,UAAU;AAE9E,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,KAAK;AACb,UAAM,UAAU,kCAAkC,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAClG,WAAO,MAAM,OAAO;AAEpB,QAAI,eAAe,UAAU;AAC5B,YAAM;AAAA,IACP;AAEA,UAAM,MAAM,KAAK,8BAA8B;AAAA,EAChD;AACD;"}