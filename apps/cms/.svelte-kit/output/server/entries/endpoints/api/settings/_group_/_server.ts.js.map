{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/settings/[group]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/settings/[group]/+server.ts\n * @description Generic API endpoint for managing any settings group\n *\n * Handles GET/PUT/DELETE operations for all settings groups defined in settingsGroups.ts\n * Respects authentication and authorization patterns from hooks.server.ts\n */\n\nimport { json, error } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { invalidateSettingsCache } from '@shared/services/settingsService';\nimport { dbAdapter } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\nimport { getSettingGroup } from '../../../config/settingsGroups';\nimport { defaultPublicSettings, defaultPrivateSettings } from '@shared/utils/config/defaults';\nimport { updateVersion } from '@shared/utils/server/settingsVersion';\nimport { setRestartNeeded } from '@shared/utils/server/restartRequired';\n\n/**\n * GET - Retrieve current settings for a group\n * Strategy: Seed defaults as source of truth, overlay with database overrides\n */\nexport const GET: RequestHandler = async ({ locals, params }) => {\n\tif (!locals.user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\tconst { group: groupId } = params;\n\tconst groupDef = getSettingGroup(groupId);\n\n\tif (!groupDef) {\n\t\tthrow error(404, `Settings group '${groupId}' not found`);\n\t}\n\n\t// Authorization check\n\tif (groupDef.adminOnly && locals.user.role !== 'admin') {\n\t\tlogger.warn(`User ${locals.user._id} (role: ${locals.user.role}) attempted to access admin-only group: ${groupId}`);\n\t\tthrow error(403, 'Insufficient permissions');\n\t}\n\n\ttry {\n\t\tconst fieldKeys = groupDef.fields.map((f) => f.key);\n\n\t\t// 1. Start with seed defaults as source of truth\n\t\tconst finalValues: Record<string, unknown> = {};\n\t\tconst allDefaults = [...defaultPublicSettings, ...defaultPrivateSettings];\n\n\t\tlogger.debug(`[${groupId}] Looking for ${fieldKeys.length} keys in ${allDefaults.length} defaults`);\n\n\t\tfor (const key of fieldKeys) {\n\t\t\tconst found = allDefaults.find((s) => s.key === key);\n\t\t\tfinalValues[key] = found ? found.value : undefined;\n\t\t\tif (!found) {\n\t\t\t\tlogger.warn(`[${groupId}] No default found for key: ${key}`);\n\t\t\t}\n\t\t}\n\n\t\tlogger.debug(`[${groupId}] Initial values from defaults:`, finalValues);\n\n\t\t// 2. Fetch database overrides\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\tthrow error(500, 'Database not initialized');\n\t\t}\n\n\t\tconst dbResult = await dbAdapter.systemPreferences.getMany(fieldKeys);\n\n\t\t// 3. Overlay database values over defaults\n\t\tif (dbResult.success && dbResult.data) {\n\t\t\tfor (const [key, value] of Object.entries(dbResult.data)) {\n\t\t\t\tif (fieldKeys.includes(key)) {\n\t\t\t\t\t// Handle wrapped values from database\n\t\t\t\t\tif (value !== null && typeof value === 'object' && 'value' in value) {\n\t\t\t\t\t\tfinalValues[key] = (value as Record<string, unknown>).value;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfinalValues[key] = value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tlogger.info(`[${groupId}] Settings retrieved for user ${locals.user._id}`);\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tgroup: {\n\t\t\t\tid: groupDef.id,\n\t\t\t\tname: groupDef.name,\n\t\t\t\tdescription: groupDef.description,\n\t\t\t\trequiresRestart: groupDef.requiresRestart || false\n\t\t\t},\n\t\t\tvalues: finalValues\n\t\t});\n\t} catch (err) {\n\t\tconst errorMessage = err instanceof Error ? err.message : 'Unknown error';\n\t\tconst errorStack = err instanceof Error ? err.stack : undefined;\n\t\tlogger.error(`Failed to get settings for group '${groupId}':`, { message: errorMessage, stack: errorStack, err });\n\t\tthrow error(500, 'Failed to retrieve settings');\n\t}\n};\n\n/**\n * PUT - Update settings for a group\n * Validates all input and saves to database\n */\nexport const PUT: RequestHandler = async ({ request, locals, params }) => {\n\tif (!locals.user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\tconst { group: groupId } = params;\n\tconst groupDef = getSettingGroup(groupId);\n\n\tif (!groupDef) {\n\t\tthrow error(404, `Settings group '${groupId}' not found`);\n\t}\n\n\t// Authorization check\n\tif (groupDef.adminOnly && locals.user.role !== 'admin') {\n\t\tlogger.warn(`User ${locals.user._id} attempted to update admin-only group: ${groupId}`);\n\t\tthrow error(403, 'Insufficient permissions');\n\t}\n\n\ttry {\n\t\tconst updates = await request.json();\n\n\t\t// Validate that only fields from this group are being updated\n\t\tconst validKeys = groupDef.fields.map((f) => f.key);\n\t\tconst updateKeys = Object.keys(updates);\n\n\t\tfor (const key of updateKeys) {\n\t\t\tif (!validKeys.includes(key)) {\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `Invalid setting key for this group: ${key}`\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 400 }\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Validate each field according to its definition\n\t\tconst errors: Record<string, string> = {};\n\n\t\tfor (const field of groupDef.fields) {\n\t\t\tif (field.key in updates) {\n\t\t\t\tconst value = updates[field.key];\n\n\t\t\t\t// Required check\n\t\t\t\tif (field.required && (value === null || value === undefined || value === '')) {\n\t\t\t\t\terrors[field.key] = `${field.label} is required`;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Skip further validation if value is null/undefined and not required\n\t\t\t\tif (value === null || value === undefined) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Type validation\n\t\t\t\tif (field.type === 'number') {\n\t\t\t\t\tif (typeof value !== 'number' || isNaN(value)) {\n\t\t\t\t\t\terrors[field.key] = `${field.label} must be a valid number`;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tif (field.min !== undefined && value < field.min) {\n\t\t\t\t\t\terrors[field.key] = `${field.label} must be at least ${field.min}`;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tif (field.max !== undefined && value > field.max) {\n\t\t\t\t\t\terrors[field.key] = `${field.label} must be at most ${field.max}`;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (field.type === 'boolean' && typeof value !== 'boolean') {\n\t\t\t\t\terrors[field.key] = `${field.label} must be a boolean`;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif ((field.type === 'text' || field.type === 'password') && typeof value !== 'string') {\n\t\t\t\t\terrors[field.key] = `${field.label} must be a string`;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif (field.type === 'array' && !Array.isArray(value)) {\n\t\t\t\t\terrors[field.key] = `${field.label} must be an array`;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Custom validation\n\t\t\t\tif (field.validation) {\n\t\t\t\t\tconst validationError = field.validation(value);\n\t\t\t\t\tif (validationError) {\n\t\t\t\t\t\terrors[field.key] = validationError;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Return validation errors if any\n\t\tif (Object.keys(errors).length > 0) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: 'Validation failed',\n\t\t\t\t\terrors\n\t\t\t\t},\n\t\t\t\t{ status: 400 }\n\t\t\t);\n\t\t}\n\n\t\t// Update settings in database\n\t\tconst settingsArray = Object.entries(updates).map(([key, value]) => ({\n\t\t\tkey,\n\t\t\tvalue,\n\t\t\tscope: 'system' as const\n\t\t}));\n\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\tthrow error(500, 'Database not initialized');\n\t\t}\n\n\t\tconst updateResult = await dbAdapter.systemPreferences.setMany(settingsArray);\n\n\t\tif (!updateResult.success) {\n\t\t\tlogger.error('Failed to update settings in database:', updateResult.error);\n\t\t\tthrow error(500, 'Failed to save settings to database');\n\t\t}\n\n\t\t// Invalidate cache and reload settings from database to make changes immediately available\n\t\tinvalidateSettingsCache();\n\t\tconst { loadSettingsFromDB } = await import('@shared/database/db');\n\t\tawait loadSettingsFromDB();\n\n\t\t// Update the settings version to notify clients\n\t\tupdateVersion();\n\n\t\tif (groupDef.requiresRestart) {\n\t\t\tsetRestartNeeded(true);\n\t\t}\n\n\t\tlogger.info(`Settings group '${groupId}' updated by user ${locals.user._id}`, {\n\t\t\tkeys: Object.keys(updates)\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'Settings updated successfully',\n\t\t\trequiresRestart: groupDef.requiresRestart || false\n\t\t});\n\t} catch (err) {\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\tthrow err; // Re-throw SvelteKit errors\n\t\t}\n\t\tlogger.error(`Failed to update settings for group '${groupId}':`, err);\n\t\tthrow error(500, 'Failed to update settings');\n\t}\n};\n\n/**\n * DELETE - Reset settings to defaults for a group\n * Removes database overrides, allowing defaults to take effect\n */\nexport const DELETE: RequestHandler = async ({ locals, params }) => {\n\tif (!locals.user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\t// Must be admin to reset settings\n\tif (locals.user.role !== 'admin') {\n\t\tlogger.warn(`User ${locals.user._id} attempted to reset settings without admin privileges`);\n\t\tthrow error(403, 'Insufficient permissions - admin only');\n\t}\n\n\tconst { group: groupId } = params;\n\tconst groupDef = getSettingGroup(groupId);\n\n\tif (!groupDef) {\n\t\tthrow error(404, `Settings group '${groupId}' not found`);\n\t}\n\n\ttry {\n\t\tconst keysToReset = groupDef.fields.map((f) => f.key);\n\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not initialized');\n\t\t\tthrow error(500, 'Database not initialized');\n\t\t}\n\n\t\t// Delete database overrides - settings will revert to seed defaults\n\t\tconst deleteResult = await dbAdapter.systemPreferences.deleteMany(keysToReset);\n\n\t\tif (!deleteResult.success) {\n\t\t\tlogger.error('Failed to delete settings:', deleteResult.error);\n\t\t\tthrow error(500, 'Failed to reset settings to defaults');\n\t\t}\n\n\t\t// Invalidate cache and reload settings from database to make changes immediately available\n\t\tinvalidateSettingsCache();\n\t\tconst { loadSettingsFromDB } = await import('@shared/database/db');\n\t\tawait loadSettingsFromDB();\n\n\t\t// Update the settings version to notify clients\n\t\tupdateVersion();\n\n\t\tif (groupDef.requiresRestart) {\n\t\t\tsetRestartNeeded(true);\n\t\t}\n\n\t\tlogger.info(`Settings group '${groupId}' reset to defaults by user ${locals.user._id}`);\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'Settings reset to defaults',\n\t\t\trequiresRestart: groupDef.requiresRestart || false\n\t\t});\n\t} catch (err) {\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\tthrow err; // Re-throw SvelteKit errors\n\t\t}\n\t\tlogger.error(`Failed to reset settings for group '${groupId}':`, err);\n\t\tthrow error(500, 'Failed to reset settings');\n\t}\n};\n"],"names":[],"mappings":"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"}