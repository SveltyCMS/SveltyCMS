{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/website-tokens/+server.ts"],"sourcesContent":["import { json, error } from '@sveltejs/kit';\nimport { dbAdapter } from '@shared/database/db';\nimport { logger } from '@shared/utils/logger.server';\nimport crypto from 'crypto';\n\nexport async function GET({ locals, url }: { locals: App.Locals; url: URL }): Promise<Response> {\n\tif (!locals.user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\tif (!dbAdapter) {\n\t\tthrow error(500, 'Database not available');\n\t}\n\n\tconst page = Number(url.searchParams.get('page') ?? 1);\n\tconst limit = Number(url.searchParams.get('limit') ?? 10);\n\tconst sort = url.searchParams.get('sort') ?? 'createdAt';\n\tconst order = url.searchParams.get('order') ?? 'desc';\n\n\t// Note: The current dbAdapter.websiteTokens.getAll() doesn't support filter parameter\n\t// Search/filter functionality would need to be added to the database adapter\n\t// For now, we fetch all and can filter client-side if needed\n\n\tconst result = await dbAdapter.websiteTokens.getAll({\n\t\tlimit,\n\t\tskip: (page - 1) * limit,\n\t\tsort,\n\t\torder\n\t});\n\n\tif (!result.success) {\n\t\tlogger.error('Failed to fetch website tokens:', result.error);\n\t\tthrow error(500, 'Failed to fetch website tokens');\n\t}\n\n\treturn json({\n\t\tdata: result.data.data,\n\t\tpagination: {\n\t\t\ttotalItems: result.data.total\n\t\t}\n\t});\n}\n\nexport async function POST({ locals, request }: { locals: App.Locals; request: Request }): Promise<Response> {\n\tif (!locals.user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\tif (!dbAdapter) {\n\t\tthrow error(500, 'Database not available');\n\t}\n\n\tconst { name } = await request.json();\n\n\tif (!name) {\n\t\tthrow error(400, 'Token name is required');\n\t}\n\n\tconst existingToken = await dbAdapter.websiteTokens.getByName(name);\n\tif (existingToken.success && existingToken.data) {\n\t\tthrow error(409, 'A token with this name already exists');\n\t}\n\n\tconst token = `sv_${crypto.randomBytes(24).toString('hex')}`;\n\n\tconst result = await dbAdapter.websiteTokens.create({\n\t\tname,\n\t\ttoken,\n\t\tupdatedAt: new Date().toISOString() as import('@shared/database/dbInterface').ISODateString,\n\t\tcreatedBy: locals.user._id\n\t});\n\n\tif (!result.success) {\n\t\tlogger.error('Failed to create website token:', result.error);\n\t\tthrow error(500, 'Failed to create website token');\n\t}\n\n\treturn json(result.data, { status: 201 });\n}\n"],"names":[],"mappings":";;;;AAKA,eAAsB,IAAI,EAAE,QAAQ,OAA4D;AAC/F,MAAI,CAAC,OAAO,MAAM;AACjB,UAAM,MAAM,KAAK,cAAc;AAAA,EAChC;AAEA,MAAI,CAAC,WAAW;AACf,UAAM,MAAM,KAAK,wBAAwB;AAAA,EAC1C;AAEA,QAAM,OAAO,OAAO,IAAI,aAAa,IAAI,MAAM,KAAK,CAAC;AACrD,QAAM,QAAQ,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK,EAAE;AACxD,QAAM,OAAO,IAAI,aAAa,IAAI,MAAM,KAAK;AAC7C,QAAM,QAAQ,IAAI,aAAa,IAAI,OAAO,KAAK;AAM/C,QAAM,SAAS,MAAM,UAAU,cAAc,OAAO;AAAA,IACnD;AAAA,IACA,OAAO,OAAO,KAAK;AAAA,IACnB;AAAA,IACA;AAAA,EAAA,CACA;AAED,MAAI,CAAC,OAAO,SAAS;AACpB,WAAO,MAAM,mCAAmC,OAAO,KAAK;AAC5D,UAAM,MAAM,KAAK,gCAAgC;AAAA,EAClD;AAEA,SAAO,KAAK;AAAA,IACX,MAAM,OAAO,KAAK;AAAA,IAClB,YAAY;AAAA,MACX,YAAY,OAAO,KAAK;AAAA,IAAA;AAAA,EACzB,CACA;AACF;AAEA,eAAsB,KAAK,EAAE,QAAQ,WAAwE;AAC5G,MAAI,CAAC,OAAO,MAAM;AACjB,UAAM,MAAM,KAAK,cAAc;AAAA,EAChC;AAEA,MAAI,CAAC,WAAW;AACf,UAAM,MAAM,KAAK,wBAAwB;AAAA,EAC1C;AAEA,QAAM,EAAE,KAAA,IAAS,MAAM,QAAQ,KAAA;AAE/B,MAAI,CAAC,MAAM;AACV,UAAM,MAAM,KAAK,wBAAwB;AAAA,EAC1C;AAEA,QAAM,gBAAgB,MAAM,UAAU,cAAc,UAAU,IAAI;AAClE,MAAI,cAAc,WAAW,cAAc,MAAM;AAChD,UAAM,MAAM,KAAK,uCAAuC;AAAA,EACzD;AAEA,QAAM,QAAQ,MAAM,OAAO,YAAY,EAAE,EAAE,SAAS,KAAK,CAAC;AAE1D,QAAM,SAAS,MAAM,UAAU,cAAc,OAAO;AAAA,IACnD;AAAA,IACA;AAAA,IACA,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,IACtB,WAAW,OAAO,KAAK;AAAA,EAAA,CACvB;AAED,MAAI,CAAC,OAAO,SAAS;AACpB,WAAO,MAAM,mCAAmC,OAAO,KAAK;AAC5D,UAAM,MAAM,KAAK,gCAAgC;AAAA,EAClD;AAEA,SAAO,KAAK,OAAO,MAAM,EAAE,QAAQ,KAAK;AACzC;"}