{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/media/[id]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/[id]/+server.ts\n * @description API endpoint to retrieve a single media item by its ID.\n *\n * @param {string} id - The ID of the media item to retrieve.\n * @returns {Promise<Response>} - The media item as a JSON response.\n *\n * Features:\n * - Retrieves a single media item by its ID.\n * - Searches for the media item in multiple collections.\n * - Returns the media item as a JSON response.\n * - Logs errors and returns appropriate error responses.\n */\n\nimport { dbAdapter } from '@shared/database/db';\nimport { json, error } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport type { DatabaseId } from '@shared/database/dbInterface';\nimport { MediaService } from '@shared/services/MediaService.server';\n\n// List of collections to search for the media item\nconst mediaCollections = ['MediaItem', 'media_images', 'media_documents', 'media_audio', 'media_videos'];\n\nexport async function GET({ params }) {\n\tconst { id } = params;\n\n\tif (!id) {\n\t\tthrow error(400, 'Media ID is required');\n\t}\n\n\tif (!dbAdapter) {\n\t\tlogger.error('Database adapter is not initialized');\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n\n\ttry {\n\t\tfor (const collection of mediaCollections) {\n\t\t\ttry {\n\t\t\t\tconst result = await dbAdapter.crud.findOne(collection, { _id: id as unknown as DatabaseId });\n\t\t\t\tif (result.success && result.data) {\n\t\t\t\t\t// Attach collection info for context, similar to mediagallery load\n\t\t\t\t\tconst itemWithCollection = {\n\t\t\t\t\t\t...result.data,\n\t\t\t\t\t\tcollection\n\t\t\t\t\t};\n\t\t\t\t\treturn json(itemWithCollection);\n\t\t\t\t}\n\t\t\t} catch (collectionError) {\n\t\t\t\t// This can happen if a collection doesn't exist, which is fine.\n\t\t\t\tlogger.warn(`Error searching for media ${id} in collection ${collection}:`, collectionError);\n\t\t\t}\n\t\t}\n\n\t\t// If we loop through all collections and find nothing\n\t\tlogger.warn(`Media item with ID ${id} not found in any collection.`);\n\t\tthrow error(404, 'Media not found');\n\t} catch (err) {\n\t\tconst message = `Error fetching media item ${id}: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\t// Use the error thrown from the loop (e.g., 404) or a generic 500\n\t\tif (err && typeof err === 'object' && 'status' in err) {\n\t\t\tthrow err;\n\t\t}\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n}\n\nexport async function PATCH({ params, request, locals }) {\n\tconst { id } = params;\n\tif (!id) throw error(400, 'Media ID is required');\n\n\tconst { user, roles } = locals;\n\tif (!user) throw error(401, 'Unauthorized');\n\n\tconst body = await request.json();\n\tconst { metadata } = body;\n\n\tif (!metadata) throw error(400, 'Metadata is required');\n\n\tif (!dbAdapter) {\n\t\tlogger.error('Database adapter is not initialized');\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n\n\tconst mediaService = new MediaService(dbAdapter);\n\n\ttry {\n\t\t// 1. Get existing media to check access and merge metadata\n\t\tconst existing = await mediaService.getMedia(id, user, roles || []);\n\n\t\t// 2. Merge metadata\n\t\tconst newMetadata = {\n\t\t\t...(existing.metadata || {}),\n\t\t\t...metadata\n\t\t};\n\n\t\t// 3. Update\n\t\tawait mediaService.updateMedia(id, { metadata: newMetadata });\n\n\t\treturn json({ success: true, data: { ...existing, metadata: newMetadata } });\n\t} catch (err) {\n\t\tlogger.error(`Error updating media ${id}:`, err);\n\t\tif (err && typeof err === 'object' && 'status' in err) {\n\t\t\tthrow err;\n\t\t}\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n}\n"],"names":[],"mappings":";;;;AAqBA,MAAM,mBAAmB,CAAC,aAAa,gBAAgB,mBAAmB,eAAe,cAAc;AAEvG,eAAsB,IAAI,EAAE,UAAU;AACrC,QAAM,EAAE,OAAO;AAEf,MAAI,CAAC,IAAI;AACR,UAAM,MAAM,KAAK,sBAAsB;AAAA,EACxC;AAEA,MAAI,CAAC,WAAW;AACf,WAAO,MAAM,qCAAqC;AAClD,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AAEA,MAAI;AACH,eAAW,cAAc,kBAAkB;AAC1C,UAAI;AACH,cAAM,SAAS,MAAM,UAAU,KAAK,QAAQ,YAAY,EAAE,KAAK,IAA6B;AAC5F,YAAI,OAAO,WAAW,OAAO,MAAM;AAElC,gBAAM,qBAAqB;AAAA,YAC1B,GAAG,OAAO;AAAA,YACV;AAAA,UAAA;AAED,iBAAO,KAAK,kBAAkB;AAAA,QAC/B;AAAA,MACD,SAAS,iBAAiB;AAEzB,eAAO,KAAK,6BAA6B,EAAE,kBAAkB,UAAU,KAAK,eAAe;AAAA,MAC5F;AAAA,IACD;AAGA,WAAO,KAAK,sBAAsB,EAAE,+BAA+B;AACnE,UAAM,MAAM,KAAK,iBAAiB;AAAA,EACnC,SAAS,KAAK;AACb,UAAM,UAAU,6BAA6B,EAAE,KAAK,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACpG,WAAO,MAAM,OAAO;AAEpB,QAAI,OAAO,OAAO,QAAQ,YAAY,YAAY,KAAK;AACtD,YAAM;AAAA,IACP;AACA,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;AAEA,eAAsB,MAAM,EAAE,QAAQ,SAAS,UAAU;AACxD,QAAM,EAAE,OAAO;AACf,MAAI,CAAC,GAAI,OAAM,MAAM,KAAK,sBAAsB;AAEhD,QAAM,EAAE,MAAM,MAAA,IAAU;AACxB,MAAI,CAAC,KAAM,OAAM,MAAM,KAAK,cAAc;AAE1C,QAAM,OAAO,MAAM,QAAQ,KAAA;AAC3B,QAAM,EAAE,aAAa;AAErB,MAAI,CAAC,SAAU,OAAM,MAAM,KAAK,sBAAsB;AAEtD,MAAI,CAAC,WAAW;AACf,WAAO,MAAM,qCAAqC;AAClD,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AAEA,QAAM,eAAe,IAAI,aAAa,SAAS;AAE/C,MAAI;AAEH,UAAM,WAAW,MAAM,aAAa,SAAS,IAAI,MAAM,SAAS,EAAE;AAGlE,UAAM,cAAc;AAAA,MACnB,GAAI,SAAS,YAAY,CAAA;AAAA,MACzB,GAAG;AAAA,IAAA;AAIJ,UAAM,aAAa,YAAY,IAAI,EAAE,UAAU,aAAa;AAE5D,WAAO,KAAK,EAAE,SAAS,MAAM,MAAM,EAAE,GAAG,UAAU,UAAU,YAAA,GAAe;AAAA,EAC5E,SAAS,KAAK;AACb,WAAO,MAAM,wBAAwB,EAAE,KAAK,GAAG;AAC/C,QAAI,OAAO,OAAO,QAAQ,YAAY,YAAY,KAAK;AACtD,YAAM;AAAA,IACP;AACA,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;"}