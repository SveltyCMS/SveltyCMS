{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../../../src/routes/api/collections/[collectionId]/[entryId]/status/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/collections/[collectionId]/[entryId]/status/+server.ts\n * @description API endpoint for updating entry status\n *\n * @example: PATCH /api/collections/posts/123/status\n *\n * Features:\n * * Dedicated endpoint for status changes\n * * Supports batch status updates via query parameters\n * * Maintains audit trail of status changes\n * * Permission checking for status modifications, scoped to the current tenant\n */\n\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { error, json, type RequestHandler } from '@sveltejs/kit';\n\n// Auth\nimport { contentManager } from '@content/ContentManager';\nimport { StatusTypes, type StatusType } from '@cms-types';\n\n// Helper function to normalize collection names for database operations\nconst normalizeCollectionName = (collectionId: string): string => {\n\t// Remove hyphens from UUID for MongoDB collection naming\n\tconst cleanId = collectionId.replace(/-/g, '');\n\treturn `collection_${cleanId}`;\n};\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\nimport type { BaseEntity, DatabaseId } from '@shared/database/dbInterface';\n\n// PATCH: Updates entry status\nexport const PATCH: RequestHandler = async ({ locals, params, request }) => {\n\tconst start = performance.now();\n\tconst { user, tenantId } = locals; // Destructure user and tenantId\n\n\tif (!user) {\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\t// Ensure ContentManager is initialized before accessing collections\n\tawait contentManager.initialize(tenantId);\n\n\tconst schema = await contentManager.getCollectionById(params.collectionId, tenantId);\n\tif (!schema) {\n\t\tthrow error(404, 'Collection not found');\n\t}\n\n\ttry {\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (parseError) {\n\t\t\tconst errorMsg = parseError instanceof Error ? parseError.message : 'Unknown parse error';\n\t\t\tlogger.error(`Failed to parse request body: ${errorMsg}`);\n\t\t\tthrow error(400, 'Invalid JSON in request body');\n\t\t}\n\n\t\tconst { status, entries } = body;\n\n\t\tif (!status) {\n\t\t\tthrow error(400, 'Status is required');\n\t\t}\n\n\t\t// All valid status types from StatusTypes constant\n\t\tconst validStatuses = Object.values(StatusTypes) as StatusType[];\n\t\tif (!validStatuses.includes(status)) {\n\t\t\tthrow error(400, `Invalid status. Must be one of: ${validStatuses.join(', ')}`);\n\t\t}\n\n\t\tconst dbAdapter = locals.dbAdapter;\n\t\tif (!dbAdapter) {\n\t\t\tthrow error(503, 'Service Unavailable: Database service is not properly initialized');\n\t\t}\n\n\t\tif (!schema._id) {\n\t\t\tthrow error(500, 'Collection ID is missing');\n\t\t}\n\n\t\tlet results = [];\n\t\tconst normalizedCollectionId = normalizeCollectionName(schema._id);\n\t\tconst updateData = { status, updatedBy: user._id };\n\t\tif (entries && Array.isArray(entries) && entries.length > 0) {\n\t\t\t// Batch status update\n\t\t\tconst query: Record<string, unknown> = { _id: { $in: entries } };\n\t\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\t\tquery.tenantId = tenantId;\n\t\t\t}\n\n\t\t\t// --- MULTI-TENANCY SECURITY CHECK ---\n\t\t\t// Verify all entries belong to the current tenant before updating.\n\t\t\tconst verificationResult = await dbAdapter.crud.findMany(normalizedCollectionId, query as any);\n\t\t\tif (!verificationResult.success || verificationResult.data.length !== entries.length) {\n\t\t\t\tlogger.warn(`Attempt to update status for entries outside of tenant`, {\n\t\t\t\t\tuserId: user._id,\n\t\t\t\t\ttenantId,\n\t\t\t\t\trequestedEntryIds: entries\n\t\t\t\t});\n\t\t\t\tthrow error(403, 'Forbidden: One or more entries do not belong to your tenant or do not exist.');\n\t\t\t}\n\n\t\t\tconst result = await dbAdapter.crud.updateMany(normalizedCollectionId, query as any, updateData as Partial<BaseEntity>);\n\t\t\tif (result.success) {\n\t\t\t\tresults = entries.map((entryId) => ({ entryId, success: true }));\n\t\t\t} else {\n\t\t\t\tthrow error(500, result.error.message);\n\t\t\t}\n\t\t} else {\n\t\t\t// Single entry status update - verify entry exists and belongs to tenant first\n\t\t\tconst query: Record<string, unknown> = { _id: params.entryId };\n\t\t\tif (getPrivateSettingSync('MULTI_TENANT')) {\n\t\t\t\tquery.tenantId = tenantId;\n\t\t\t}\n\n\t\t\t// Verify the entry exists and belongs to the current tenant\n\t\t\tconst verificationResult = await dbAdapter.crud.findOne(normalizedCollectionId, query as any);\n\t\t\tif (!verificationResult.success || !verificationResult.data) {\n\t\t\t\tthrow error(404, 'Entry not found or access denied');\n\t\t\t}\n\n\t\t\tconst result = await dbAdapter.crud.update(normalizedCollectionId, params.entryId as DatabaseId, updateData as Partial<BaseEntity>);\n\n\t\t\tif (!result.success) {\n\t\t\t\tthrow error(500, result.error.message);\n\t\t\t}\n\n\t\t\tif (!result.data) {\n\t\t\t\tthrow error(404, 'Entry not found');\n\t\t\t}\n\n\t\t\tresults = [{ entryId: params.entryId, success: true, data: result.data }];\n\t\t}\n\n\t\tconst duration = performance.now() - start;\n\t\tconst successCount = results.filter((r) => r.success).length;\n\n\t\t// Invalidate server-side page cache for this collection after status change\n\t\tconst cacheService = (await import('@shared/database/CacheService')).cacheService;\n\t\tconst cachePattern = `collection:${schema._id}:*`;\n\t\tawait cacheService.clearByPattern(cachePattern).catch((err) => {\n\t\t\tlogger.warn('Failed to invalidate page cache after status change', { pattern: cachePattern, error: err });\n\t\t});\n\n\t\tlogger.info(`Status updated for ${successCount}/${results.length} entries in ${duration.toFixed(2)}ms`, { tenantId });\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\tstatus,\n\t\t\t\tresults,\n\t\t\t\tsummary: {\n\t\t\t\t\ttotal: results.length,\n\t\t\t\t\tsuccessful: successCount,\n\t\t\t\t\tfailed: results.length - successCount\n\t\t\t\t}\n\t\t\t},\n\t\t\tperformance: { duration }\n\t\t});\n\t} catch (e) {\n\t\tif (typeof e === 'object' && e !== null && 'status' in e) {\n\t\t\tconst errorBody =\n\t\t\t\t'body' in e && typeof e.body === 'object' && e.body !== null && 'message' in e.body ? (e.body as { message?: string }).message : undefined;\n\t\t\tconst errorMsg = e instanceof Error ? e.message : 'Unknown error';\n\t\t\tlogger.error(`Status update error (${(e as any).status})`, {\n\t\t\t\terror: (e as any).message,\n\t\t\t\tstack: (e as any).stack,\n\t\t\t\tbody: errorBody || errorMsg\n\t\t\t});\n\t\t\tthrow e; // Re-throw SvelteKit errors\n\t\t}\n\n\t\tconst duration = performance.now() - start;\n\t\tconst errorMsg = e instanceof Error ? e.message : 'Unknown error';\n\t\tconst stack = e instanceof Error ? e.stack : undefined;\n\t\tlogger.error(`Failed to update status: ${errorMsg} in ${duration.toFixed(2)}ms`, {\n\t\t\terror: e,\n\t\t\tstack,\n\t\t\tcollectionId: params.collectionId,\n\t\t\tentryId: params.entryId\n\t\t});\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n"],"names":["errorMsg"],"mappings":"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"}