{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/security/incidents/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/security/incidents/+server.ts\n * @description Security incidents management API endpoints\n *\n * ### Features\n * - List active security incidents\n * - Incident resolution and management\n * - Threat level filtering and sorting\n * - Real-time incident updates\n * - Administrative controls\n *\n * @security Admin-only endpoints with comprehensive logging\n */\n\nimport { json, type RequestHandler } from '@sveltejs/kit';\nimport { securityResponseService } from '@shared/services/SecurityResponseService';\nimport { hasApiPermission } from '@shared/database/auth/apiPermissions';\nimport { logger } from '@shared/utils/logger.server';\n\n/**\n * GET /api/security/incidents\n * Returns list of active security incidents with filtering options.\n */\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\ttry {\n\t\t// Authorization check - admin only\n\t\tif (!locals.user || !hasApiPermission(locals.user.role, 'security')) {\n\t\t\tlogger.warn(`Unauthorized security incidents access attempt`, {\n\t\t\t\tuserId: locals.user?._id,\n\t\t\t\trole: locals.user?.role\n\t\t\t});\n\t\t\treturn json({ error: 'Unauthorized - Admin access required' }, { status: 403 });\n\t\t}\n\n\t\t// Get query parameters for filtering\n\t\tconst threatLevel = url.searchParams.get('threatLevel');\n\t\tconst resolved = url.searchParams.get('resolved');\n\t\tconst limit = parseInt(url.searchParams.get('limit') || '50');\n\t\tconst offset = parseInt(url.searchParams.get('offset') || '0');\n\n\t\t// Get incidents from security service\n\t\tlet incidents = securityResponseService.getActiveIncidents();\n\n\t\t// Apply filters\n\t\tif (threatLevel && threatLevel !== 'all') {\n\t\t\tincidents = incidents.filter((inc) => inc.threatLevel === threatLevel);\n\t\t}\n\n\t\tif (resolved === 'true') {\n\t\t\t// Note: getActiveIncidents() only returns unresolved incidents\n\t\t\t// In a full implementation, you'd have a method to get resolved incidents too\n\t\t\tincidents = [];\n\t\t}\n\n\t\t// Sort by timestamp (newest first)\n\t\tincidents.sort((a, b) => b.timestamp - a.timestamp);\n\n\t\t// Apply pagination\n\t\tconst paginatedIncidents = incidents.slice(offset, offset + limit);\n\n\t\tconst response = {\n\t\t\tincidents: paginatedIncidents,\n\t\t\tpagination: {\n\t\t\t\ttotal: incidents.length,\n\t\t\t\toffset,\n\t\t\t\tlimit,\n\t\t\t\thasMore: offset + limit < incidents.length\n\t\t\t},\n\t\t\tfilters: {\n\t\t\t\tthreatLevel,\n\t\t\t\tresolved,\n\t\t\t\tavailableThreatLevels: ['all', 'low', 'medium', 'high', 'critical']\n\t\t\t}\n\t\t};\n\n\t\tlogger.debug('Security incidents requested', {\n\t\t\tuserId: locals.user._id,\n\t\t\tresultCount: paginatedIncidents.length,\n\t\t\tfilters: { threatLevel, resolved }\n\t\t});\n\n\t\treturn json(response);\n\t} catch (error) {\n\t\tlogger.error('Error fetching security incidents:', error);\n\t\treturn json({ error: 'Internal server error' }, { status: 500 });\n\t}\n};\n\n/**\n * POST /api/security/incidents\n * Create a new security incident (for manual reporting).\n */\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\ttry {\n\t\t// Authorization check - admin only\n\t\tif (!locals.user || !hasApiPermission(locals.user.role, 'security')) {\n\t\t\treturn json({ error: 'Unauthorized - Admin access required' }, { status: 403 });\n\t\t}\n\n\t\tconst body = await request.json();\n\t\tconst { ip, eventType, severity, evidence, metadata } = body;\n\n\t\t// Validate required fields\n\t\tif (!ip || !eventType || !severity || !evidence) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\terror: 'Missing required fields: ip, eventType, severity, evidence'\n\t\t\t\t},\n\t\t\t\t{ status: 400 }\n\t\t\t);\n\t\t}\n\n\t\t// Validate severity range\n\t\tif (severity < 1 || severity > 10) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\terror: 'Severity must be between 1 and 10'\n\t\t\t\t},\n\t\t\t\t{ status: 400 }\n\t\t\t);\n\t\t}\n\n\t\t// Report the security event\n\t\tsecurityResponseService.reportSecurityEvent(ip, eventType, severity, evidence, {\n\t\t\t...metadata,\n\t\t\treportedBy: locals.user._id,\n\t\t\tmanual: true\n\t\t});\n\n\t\tlogger.info('Manual security incident reported', {\n\t\t\treportedBy: locals.user._id,\n\t\t\tip,\n\t\t\teventType,\n\t\t\tseverity,\n\t\t\tevidence: evidence.substring(0, 100)\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tmessage: 'Security incident reported successfully'\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Error creating security incident:', error);\n\t\treturn json({ error: 'Internal server error' }, { status: 500 });\n\t}\n};\n"],"names":[],"mappings":"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"}