{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/config_sync/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/config_sync/+server.ts\n * @description Unified API for configuration synchronization.\n * Handles the diffing, exporting, and importing of configuration entities.\n *\n * Security: Protected by hooks, admin-only.\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { configService } from '@shared/services/ConfigService';\nimport { invalidateSettingsCache } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\n\n// GET → Returns filesystem vs. database synchronization status\nexport const GET: RequestHandler = async ({ locals }) => {\n\tif (!locals.user || !locals.isAdmin) {\n\t\tthrow error(403, 'Forbidden: Administrator access required.');\n\t}\n\n\ttry {\n\t\tconst status = await configService.getStatus();\n\t\t// Return only the sync status object for frontend compatibility\n\t\treturn json(status);\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tlogger.error('Failed to get configuration status:', err);\n\t\tthrow error(500, `Configuration status check failed: ${message}`);\n\t}\n};\n\n// POST → Triggers an 'import' or 'export' synchronization action\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\tif (!locals.user || !locals.isAdmin) {\n\t\tthrow error(403, 'Forbidden: Administrator access required.');\n\t}\n\n\ttry {\n\t\tconst { action, uuids, payload } = await request.json();\n\n\t\tswitch (action) {\n\t\t\tcase 'import': {\n\t\t\t\tconst status = await configService.getStatus();\n\n\t\t\t\tif (status.unmetRequirements.length > 0) {\n\t\t\t\t\treturn json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\tmessage: 'Import blocked due to unmet requirements.',\n\t\t\t\t\t\t\tunmetRequirements: status.unmetRequirements\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{ status: 409 }\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tawait configService.performImport({ changes: payload });\n\t\t\t\tinvalidateSettingsCache();\n\n\t\t\t\treturn json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tmessage: 'Configuration imported successfully.'\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tcase 'export': {\n\t\t\t\t// Enhanced: run export in parallel for all entity types, support large datasets\n\t\t\t\tconst result = await configService.performExport({ uuids });\n\t\t\t\treturn json({\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\tmessage: 'Configuration exported successfully.',\n\t\t\t\t\toutput: result\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdefault:\n\t\t\t\treturn json({ success: false, message: 'Invalid action specified.' }, { status: 400 });\n\t\t}\n\t} catch (err) {\n\t\tconst message = err instanceof Error ? err.message : String(err);\n\t\tlogger.error('Configuration sync POST failed:', err);\n\t\tthrow error(500, `Configuration sync failed: ${message}`);\n\t}\n};\n"],"names":[],"mappings":";;;;AAeO,MAAM,MAAsB,OAAO,EAAE,aAAa;AACxD,MAAI,CAAC,OAAO,QAAQ,CAAC,OAAO,SAAS;AACpC,UAAM,MAAM,KAAK,2CAA2C;AAAA,EAC7D;AAEA,MAAI;AACH,UAAM,SAAS,MAAM,cAAc,UAAA;AAEnC,WAAO,KAAK,MAAM;AAAA,EACnB,SAAS,KAAK;AACb,UAAM,UAAU,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG;AAC/D,WAAO,MAAM,uCAAuC,GAAG;AACvD,UAAM,MAAM,KAAK,sCAAsC,OAAO,EAAE;AAAA,EACjE;AACD;AAGO,MAAM,OAAuB,OAAO,EAAE,QAAQ,cAAc;AAClE,MAAI,CAAC,OAAO,QAAQ,CAAC,OAAO,SAAS;AACpC,UAAM,MAAM,KAAK,2CAA2C;AAAA,EAC7D;AAEA,MAAI;AACH,UAAM,EAAE,QAAQ,OAAO,YAAY,MAAM,QAAQ,KAAA;AAEjD,YAAQ,QAAA;AAAA,MACP,KAAK,UAAU;AACd,cAAM,SAAS,MAAM,cAAc,UAAA;AAEnC,YAAI,OAAO,kBAAkB,SAAS,GAAG;AACxC,iBAAO;AAAA,YACN;AAAA,cACC,SAAS;AAAA,cACT,SAAS;AAAA,cACT,mBAAmB,OAAO;AAAA,YAAA;AAAA,YAE3B,EAAE,QAAQ,IAAA;AAAA,UAAI;AAAA,QAEhB;AAEA,cAAM,cAAc,cAAc,EAAE,SAAS,SAAS;AACtD,gCAAA;AAEA,eAAO,KAAK;AAAA,UACX,SAAS;AAAA,UACT,SAAS;AAAA,QAAA,CACT;AAAA,MACF;AAAA,MAEA,KAAK,UAAU;AAEd,cAAM,SAAS,MAAM,cAAc,cAAc,EAAE,OAAO;AAC1D,eAAO,KAAK;AAAA,UACX,SAAS;AAAA,UACT,SAAS;AAAA,UACT,QAAQ;AAAA,QAAA,CACR;AAAA,MACF;AAAA,MAEA;AACC,eAAO,KAAK,EAAE,SAAS,OAAO,SAAS,+BAA+B,EAAE,QAAQ,KAAK;AAAA,IAAA;AAAA,EAExF,SAAS,KAAK;AACb,UAAM,UAAU,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG;AAC/D,WAAO,MAAM,mCAAmC,GAAG;AACnD,UAAM,MAAM,KAAK,8BAA8B,OAAO,EAAE;AAAA,EACzD;AACD;"}