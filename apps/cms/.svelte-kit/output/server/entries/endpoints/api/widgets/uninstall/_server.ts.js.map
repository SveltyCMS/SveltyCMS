{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/uninstall/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/uninstall/+server.ts\n * @description API endpoint for uninstalling widgets\n */\n\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst start = performance.now();\n\ttry {\n\t\tconst { user } = locals;\n\n\t\tif (!user) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Unauthorized',\n\t\t\t\t\terror: 'Authentication credentials missing'\n\t\t\t\t},\n\t\t\t\t{ status: 401 }\n\t\t\t);\n\t\t}\n\n\t\t// Check permission\n\t\tconst hasWidgetPermission = hasPermissionWithRoles(user, 'api:widgets', locals.roles);\n\t\tif (!hasWidgetPermission) {\n\t\t\tlogger.warn(`User ${user._id} denied access to widget uninstall API due to insufficient permissions`);\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Insufficient permissions',\n\t\t\t\t\terror: 'User lacks api:widgets permission'\n\t\t\t\t},\n\t\t\t\t{ status: 403 }\n\t\t\t);\n\t\t}\n\t\tconst { widgetName, tenantId } = await request.json();\n\n\t\tif (!widgetName) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Validation Error',\n\t\t\t\t\terror: 'Widget name is required'\n\t\t\t\t},\n\t\t\t\t{ status: 400 }\n\t\t\t);\n\t\t}\n\n\t\tconst actualTenantId = tenantId || locals.tenantId || 'default-tenant';\n\n\t\t// TODO: Implement widget uninstallation logic\n\t\t// 1. Check if widget is currently active (must be deactivated first)\n\t\t// 2. Check for dependencies (other widgets depending on this one)\n\t\t// 3. Remove widget files from tenant directory\n\t\t// 4. Update database to remove widget info\n\t\t// 5. Unregister widget from the system\n\n\t\tlogger.info(`Uninstalling widget ${widgetName} for tenant: ${actualTenantId}`);\n\n\t\t// Mock uninstallation process\n\t\tconst uninstallResult = {\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\twidgetName,\n\t\t\t\ttenantId: actualTenantId,\n\t\t\t\tuninstalledAt: new Date().toISOString()\n\t\t\t},\n\t\t\tmessage: 'Widget uninstalled successfully'\n\t\t};\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info(`Widget ${widgetName} uninstalled successfully for tenant: ${actualTenantId}`, {\n\t\t\ttenantId: actualTenantId,\n\t\t\tduration: `${duration.toFixed(2)}ms`\n\t\t});\n\n\t\treturn json(uninstallResult);\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to uninstall widget: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms` });\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":";;;AAUO,MAAM,OAAuB,OAAO,EAAE,SAAS,aAAa;AAClE,QAAM,QAAQ,YAAY,IAAA;AAC1B,MAAI;AACH,UAAM,EAAE,SAAS;AAEjB,QAAI,CAAC,MAAM;AACV,aAAO;AAAA,QACN;AAAA,UACC,SAAS;AAAA,UACT,SAAS;AAAA,UACT,OAAO;AAAA,QAAA;AAAA,QAER,EAAE,QAAQ,IAAA;AAAA,MAAI;AAAA,IAEhB;AAGA,UAAM,sBAAsB,uBAAuB,MAAM,eAAe,OAAO,KAAK;AACpF,QAAI,CAAC,qBAAqB;AACzB,aAAO,KAAK,QAAQ,KAAK,GAAG,wEAAwE;AACpG,aAAO;AAAA,QACN;AAAA,UACC,SAAS;AAAA,UACT,SAAS;AAAA,UACT,OAAO;AAAA,QAAA;AAAA,QAER,EAAE,QAAQ,IAAA;AAAA,MAAI;AAAA,IAEhB;AACA,UAAM,EAAE,YAAY,SAAA,IAAa,MAAM,QAAQ,KAAA;AAE/C,QAAI,CAAC,YAAY;AAChB,aAAO;AAAA,QACN;AAAA,UACC,SAAS;AAAA,UACT,SAAS;AAAA,UACT,OAAO;AAAA,QAAA;AAAA,QAER,EAAE,QAAQ,IAAA;AAAA,MAAI;AAAA,IAEhB;AAEA,UAAM,iBAAiB,YAAY,OAAO,YAAY;AAStD,WAAO,KAAK,uBAAuB,UAAU,gBAAgB,cAAc,EAAE;AAG7E,UAAM,kBAAkB;AAAA,MACvB,SAAS;AAAA,MACT,MAAM;AAAA,QACL;AAAA,QACA,UAAU;AAAA,QACV,gBAAe,oBAAI,KAAA,GAAO,YAAA;AAAA,MAAY;AAAA,MAEvC,SAAS;AAAA,IAAA;AAGV,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,WAAO,KAAK,UAAU,UAAU,yCAAyC,cAAc,IAAI;AAAA,MAC1F,UAAU;AAAA,MACV,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC;AAAA,IAAA,CAChC;AAED,WAAO,KAAK,eAAe;AAAA,EAC5B,SAAS,KAAK;AACb,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,UAAM,UAAU,+BAA+B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC/F,WAAO,MAAM,SAAS,EAAE,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC,KAAA,CAAM;AAE9D,WAAO;AAAA,MACN;AAAA,QACC,SAAS;AAAA,QACT,SAAS;AAAA,QACT,OAAO;AAAA,MAAA;AAAA,MAER,EAAE,QAAQ,IAAA;AAAA,IAAI;AAAA,EAEhB;AACD;"}