{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/security/stats/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/security/stats/+server.ts\n * @description Security statistics API endpoint for real-time monitoring\n *\n * ### Features\n * - Real-time security metrics aggregation\n * - Threat level distribution analysis\n * - Performance metrics integration\n * - Rate limiting and access control\n * - Comprehensive security overview\n *\n * @security Admin-only endpoint with rate limiting\n */\n\nimport { json, type RequestHandler } from '@sveltejs/kit';\nimport { securityResponseService } from '@shared/services/SecurityResponseService';\nimport { metricsService } from '@shared/services/MetricsService';\nimport { hasApiPermission } from '@shared/database/auth/apiPermissions';\nimport { logger } from '@shared/utils/logger.server';\n\n/**\n * GET /api/security/stats\n * Returns comprehensive security statistics for dashboard monitoring.\n */\nexport const GET: RequestHandler = async ({ locals, getClientAddress }) => {\n\ttry {\n\t\t// Authorization check - admin only\n\t\tif (!locals.user || !hasApiPermission(locals.user.role, 'security')) {\n\t\t\tlogger.warn(`Unauthorized security stats access attempt`, {\n\t\t\t\tuserId: locals.user?._id,\n\t\t\t\trole: locals.user?.role,\n\t\t\t\tip: getClientAddress()\n\t\t\t});\n\t\t\treturn json({ error: 'Unauthorized - Admin access required' }, { status: 403 });\n\t\t}\n\n\t\t// Get security statistics from the security response service\n\t\tconst securityStats = securityResponseService.getSecurityStats();\n\n\t\t// Get general metrics from the metrics service\n\t\tconst metricsReport = metricsService.getReport();\n\n\t\t// Generate recent security events (mock data for now - would come from event log)\n\t\tconst recentEvents = generateRecentSecurityEvents();\n\n\t\t// Compile comprehensive security overview\n\t\tconst response = {\n\t\t\ttimestamp: Date.now(),\n\t\t\toverallStatus: calculateOverallSecurityStatus(securityStats, metricsReport),\n\n\t\t\t// Core security metrics\n\t\t\tactiveIncidents: securityStats.activeIncidents,\n\t\t\tblockedIPs: securityStats.blockedIPs,\n\t\t\tthrottledIPs: securityStats.throttledIPs,\n\t\t\ttotalIncidents: securityStats.totalIncidents,\n\n\t\t\t// Threat distribution\n\t\t\tthreatLevelDistribution: securityStats.threatLevelDistribution,\n\n\t\t\t// Security events\n\t\t\tcspViolations: metricsReport.security.cspViolations,\n\t\t\trateLimitHits: metricsReport.security.rateLimitViolations,\n\t\t\tauthFailures: metricsReport.security.authFailures,\n\n\t\t\t// Recent activity\n\t\t\trecentEvents: recentEvents.slice(0, 10), // Last 10 events\n\n\t\t\t// Performance impact\n\t\t\tsecurityOverhead: {\n\t\t\t\tavgResponseTime: metricsReport.requests.avgResponseTime,\n\t\t\t\terrorRate: metricsReport.requests.errorRate,\n\t\t\t\tslowRequests: metricsReport.performance.slowRequests\n\t\t\t},\n\n\t\t\t// System health correlation\n\t\t\tsystemHealth: {\n\t\t\t\tauthSuccessRate: metricsReport.authentication.successRate,\n\t\t\t\tcacheHitRate: metricsReport.api.cacheHitRate,\n\t\t\t\tuptime: metricsReport.uptime\n\t\t\t}\n\t\t};\n\n\t\tlogger.debug('Security stats requested', {\n\t\t\tuserId: locals.user._id,\n\t\t\tactiveIncidents: securityStats.activeIncidents,\n\t\t\toverallStatus: response.overallStatus\n\t\t});\n\n\t\treturn json(response);\n\t} catch (error) {\n\t\tlogger.error('Error fetching security stats:', error);\n\t\treturn json({ error: 'Internal server error' }, { status: 500 });\n\t}\n};\n\n/**\n * Calculate overall security status based on multiple factors.\n */\nfunction calculateOverallSecurityStatus(\n\tsecurityStats: ReturnType<typeof securityResponseService.getSecurityStats>,\n\tmetricsReport: ReturnType<typeof metricsService.getReport>\n): 'safe' | 'low' | 'medium' | 'high' | 'critical' {\n\tconst { threatLevelDistribution, activeIncidents } = securityStats;\n\tconst { security } = metricsReport;\n\n\t// Critical indicators\n\tif (threatLevelDistribution.critical > 0 || activeIncidents > 10) {\n\t\treturn 'critical';\n\t}\n\n\t// High threat indicators\n\tif (threatLevelDistribution.high > 0 || activeIncidents > 5 || security.cspViolations > 100 || security.authFailures > 50) {\n\t\treturn 'high';\n\t}\n\n\t// Medium threat indicators\n\tif (threatLevelDistribution.medium > 0 || activeIncidents > 2 || security.rateLimitViolations > 50 || security.cspViolations > 20) {\n\t\treturn 'medium';\n\t}\n\n\t// Low threat indicators\n\tif (threatLevelDistribution.low > 0 || activeIncidents > 0 || security.rateLimitViolations > 10 || security.authFailures > 10) {\n\t\treturn 'low';\n\t}\n\n\treturn 'safe';\n}\n\n/**\n * Generate recent security events for the timeline.\n * In a real implementation, this would query an event log database.\n */\nfunction generateRecentSecurityEvents() {\n\tconst events = [];\n\tconst now = Date.now();\n\n\t// This is mock data - replace with actual event log queries\n\tconst eventTypes = [\n\t\t{ type: 'rate_limit', severity: 'medium', message: 'Rate limit exceeded for API endpoint' },\n\t\t{ type: 'auth_failure', severity: 'low', message: 'Invalid login attempt detected' },\n\t\t{ type: 'csp_violation', severity: 'medium', message: 'Content Security Policy violation reported' },\n\t\t{ type: 'threat_detected', severity: 'high', message: 'SQL injection pattern detected in request' },\n\t\t{ type: 'ip_blocked', severity: 'high', message: 'IP address automatically blocked due to threats' }\n\t];\n\n\t// Generate 5-15 recent events\n\tconst eventCount = Math.floor(Math.random() * 10) + 5;\n\tfor (let i = 0; i < eventCount; i++) {\n\t\tconst eventTemplate = eventTypes[Math.floor(Math.random() * eventTypes.length)];\n\t\tevents.push({\n\t\t\tid: `evt_${now}_${i}`,\n\t\t\ttimestamp: now - i * 60000 - Math.random() * 300000, // Random time in last 5 minutes to 5 hours\n\t\t\ttype: eventTemplate.type,\n\t\t\tseverity: eventTemplate.severity,\n\t\t\tmessage: eventTemplate.message,\n\t\t\tip: `192.168.1.${Math.floor(Math.random() * 255)}`,\n\t\t\tdetails: {\n\t\t\t\tuserAgent: 'Mozilla/5.0...',\n\t\t\t\tendpoint: '/api/data',\n\t\t\t\tmethod: 'POST'\n\t\t\t}\n\t\t});\n\t}\n\n\treturn events.sort((a, b) => b.timestamp - a.timestamp);\n}\n"],"names":[],"mappings":"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"}