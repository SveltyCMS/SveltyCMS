{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/api/media/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/+server.ts\n * @description API endpoint for media file operations and listings using database-agnostic adapter\n *\n * @example GET /api/media?limit=5\n *\n * Features:\n * - Database-agnostic media file retrieval, scoped to the current tenant\n * - Secure, granular access control per operation\n * - Efficient pagination and sorting\n * - Consistent error handling with DatabaseResult<T>\n */\n\nimport { error, json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Database\nimport { dbAdapter } from '@shared/database/db';\n\n// Permissions\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Validation\nimport * as v from 'valibot';\n\nconst QuerySchema = v.object({\n\tlimit: v.optional(v.pipe(v.number(), v.minValue(1), v.maxValue(50)), 5)\n});\n\nexport const GET: RequestHandler = async ({ locals, url }) => {\n\tconst { user, tenantId } = locals;\n\ttry {\n\t\t// Authentication is handled by hooks.server.ts\n\t\tif (!user) {\n\t\t\tthrow error(401, 'Unauthorized');\n\t\t}\n\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t} // Validate query parameters\n\n\t\tconst query = v.parse(QuerySchema, {\n\t\t\tlimit: Number(url.searchParams.get('limit')) || undefined\n\t\t});\n\n\t\tif (!dbAdapter) {\n\t\t\tlogger.error('Database adapter not available');\n\t\t\tthrow error(500, 'Database connection unavailable');\n\t\t}\n\n\t\t// --- MULTI-TENANCY: Scope the query by tenantId ---\n\t\t// Filtering by tenantId should be handled by the adapter, not PaginationOptions\n\t\tconst result = await dbAdapter.media.files.getByFolder(undefined, {\n\t\t\tpage: 1,\n\t\t\tpageSize: query.limit,\n\t\t\tsortField: 'updatedAt',\n\t\t\tsortDirection: 'desc'\n\t\t});\n\n\t\tif (!result.success) {\n\t\t\tlogger.error('Failed to fetch media files from database', {\n\t\t\t\terror: result.error,\n\t\t\t\trequestedBy: user?._id,\n\t\t\t\ttenantId\n\t\t\t});\n\t\t\tthrow error(500, 'Failed to retrieve media files');\n\t\t} // Transform the data to match widget expectations\n\n\t\tconst mediaFiles = result.data.items.map((file) => {\n\t\t\t// Helper to map DB path (mediaFolder/...) to URL path (/files/...)\n\t\t\tconst normalizePath = (p: string) => {\n\t\t\t\t// Strip 'mediaFolder/' or 'files/' prefix if present in the raw path\n\t\t\t\tlet path = p.replace(/^mediaFolder\\//, '').replace(/^files\\//, '');\n\t\t\t\t// Ensure no leading slash before prepending /files/\n\t\t\t\tpath = path.replace(/^\\/+/, '');\n\t\t\t\treturn `/files/${path}`;\n\t\t\t};\n\n\t\t\t// Normalize thumbnails if present\n\t\t\tconst thumbnails = file.thumbnails\n\t\t\t\t? Object.entries(file.thumbnails).reduce((acc, [key, val]) => {\n\t\t\t\t\t\tif (val) {\n\t\t\t\t\t\t\tacc[key] = { ...val, url: normalizePath(val.url) };\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn acc;\n\t\t\t\t\t}, {} as any)\n\t\t\t\t: undefined;\n\n\t\t\treturn {\n\t\t\t\t...file,\n\t\t\t\turl: normalizePath(file.path),\n\t\t\t\tthumbnails\n\t\t\t};\n\t\t});\n\n\t\tlogger.info('Media files fetched successfully via database adapter', {\n\t\t\tcount: mediaFiles.length,\n\t\t\ttotal: result.data.total,\n\t\t\trequestedBy: user?._id,\n\t\t\ttenantId\n\t\t});\n\n\t\treturn json(mediaFiles);\n\t} catch (err) {\n\t\tconst httpError = err as { status?: number; body?: { message?: string }; message?: string };\n\t\tconst status = httpError.status || 500;\n\t\tconst message = httpError.body?.message || httpError.message || 'Internal Server Error';\n\t\tlogger.error('Error fetching media files:', { error: message, status, tenantId: locals.tenantId });\n\t\tthrow error(status, message);\n\t}\n};\n"],"names":[],"mappings":";;;;;AA4BA,MAAM,cAAc,EAAE,OAAO;AAAA,EAC5B,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,OAAA,GAAU,EAAE,SAAS,CAAC,GAAG,EAAE,SAAS,EAAE,CAAC,GAAG,CAAC;AACvE,CAAC;AAEM,MAAM,MAAsB,OAAO,EAAE,QAAQ,UAAU;AAC7D,QAAM,EAAE,MAAM,SAAA,IAAa;AAC3B,MAAI;AAEH,QAAI,CAAC,MAAM;AACV,YAAM,MAAM,KAAK,cAAc;AAAA,IAChC;AAEA,QAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,YAAM,MAAM,KAAK,oDAAoD;AAAA,IACtE;AAEA,UAAM,QAAQ,EAAE,MAAM,aAAa;AAAA,MAClC,OAAO,OAAO,IAAI,aAAa,IAAI,OAAO,CAAC,KAAK;AAAA,IAAA,CAChD;AAED,QAAI,CAAC,WAAW;AACf,aAAO,MAAM,gCAAgC;AAC7C,YAAM,MAAM,KAAK,iCAAiC;AAAA,IACnD;AAIA,UAAM,SAAS,MAAM,UAAU,MAAM,MAAM,YAAY,QAAW;AAAA,MACjE,MAAM;AAAA,MACN,UAAU,MAAM;AAAA,MAChB,WAAW;AAAA,MACX,eAAe;AAAA,IAAA,CACf;AAED,QAAI,CAAC,OAAO,SAAS;AACpB,aAAO,MAAM,6CAA6C;AAAA,QACzD,OAAO,OAAO;AAAA,QACd,aAAa,MAAM;AAAA,QACnB;AAAA,MAAA,CACA;AACD,YAAM,MAAM,KAAK,gCAAgC;AAAA,IAClD;AAEA,UAAM,aAAa,OAAO,KAAK,MAAM,IAAI,CAAC,SAAS;AAElD,YAAM,gBAAgB,CAAC,MAAc;AAEpC,YAAI,OAAO,EAAE,QAAQ,kBAAkB,EAAE,EAAE,QAAQ,YAAY,EAAE;AAEjE,eAAO,KAAK,QAAQ,QAAQ,EAAE;AAC9B,eAAO,UAAU,IAAI;AAAA,MACtB;AAGA,YAAM,aAAa,KAAK,aACrB,OAAO,QAAQ,KAAK,UAAU,EAAE,OAAO,CAAC,KAAK,CAAC,KAAK,GAAG,MAAM;AAC5D,YAAI,KAAK;AACR,cAAI,GAAG,IAAI,EAAE,GAAG,KAAK,KAAK,cAAc,IAAI,GAAG,EAAA;AAAA,QAChD;AACA,eAAO;AAAA,MACR,GAAG,CAAA,CAAS,IACX;AAEH,aAAO;AAAA,QACN,GAAG;AAAA,QACH,KAAK,cAAc,KAAK,IAAI;AAAA,QAC5B;AAAA,MAAA;AAAA,IAEF,CAAC;AAED,WAAO,KAAK,yDAAyD;AAAA,MACpE,OAAO,WAAW;AAAA,MAClB,OAAO,OAAO,KAAK;AAAA,MACnB,aAAa,MAAM;AAAA,MACnB;AAAA,IAAA,CACA;AAED,WAAO,KAAK,UAAU;AAAA,EACvB,SAAS,KAAK;AACb,UAAM,YAAY;AAClB,UAAM,SAAS,UAAU,UAAU;AACnC,UAAM,UAAU,UAAU,MAAM,WAAW,UAAU,WAAW;AAChE,WAAO,MAAM,+BAA+B,EAAE,OAAO,SAAS,QAAQ,UAAU,OAAO,UAAU;AACjG,UAAM,MAAM,QAAQ,OAAO;AAAA,EAC5B;AACD;"}