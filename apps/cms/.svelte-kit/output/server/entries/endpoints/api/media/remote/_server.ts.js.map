{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/media/remote/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/media/remote/+server.ts\n * @description\n * API endpoint for saving remote media files to the current tenant's storage.\n *\n * @example POST /api/media/remote\n *\n * Features:\n * - Secure, granular access control per operation.\n * - Multi-Tenant Safe: Saves files to the correct tenant's storage.\n */\n\nimport { json, error } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\n\n// Media Service\nimport { MediaService } from '@shared/services/MediaService.server';\nimport type { MediaAccess } from '@shared/utils/media/mediaModels';\nimport { dbAdapter } from '@shared/database/db';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\n// Helper function to get MediaService instance\nfunction getMediaService(): MediaService {\n\tif (!dbAdapter) {\n\t\tthrow new Error('Database adapter is not initialized');\n\t}\n\ttry {\n\t\tconst service = new MediaService(dbAdapter);\n\t\treturn service;\n\t} catch (err) {\n\t\tconst message = `Failed to initialize MediaService: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow new Error(message);\n\t}\n}\n\nexport const POST: RequestHandler = async ({ request, locals }) => {\n\tconst { user, tenantId } = locals;\n\tif (!user) {\n\t\tlogger.warn('Unauthorized: No user session found during remote media save');\n\t\tthrow error(401, 'Unauthorized');\n\t}\n\n\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\tlogger.error('Tenant ID is missing in a multi-tenant setup.');\n\t\tthrow error(400, 'Could not identify the tenant for this operation.');\n\t}\n\n\ttry {\n\t\tconst { fileUrl, access = 'public', basePath } = await request.json();\n\t\tif (!fileUrl) {\n\t\t\tthrow error(400, 'File URL is required');\n\t\t}\n\n\t\t// Validate access type\n\t\tconst validAccess: MediaAccess = ['public', 'private', 'protected'].includes(access) ? access : 'public';\n\n\t\t// Determine base path (use tenantId if multi-tenant, otherwise use provided or 'global')\n\t\tconst mediaBasePath = tenantId || basePath || 'global';\n\n\t\t// Initialize MediaService and save remote media\n\t\tconst mediaService = getMediaService();\n\t\tconst result = await mediaService.saveRemoteMedia(fileUrl, user._id.toString(), validAccess, mediaBasePath);\n\n\t\tlogger.info('Remote media saved successfully', { fileUrl, userId: user._id, tenantId, access: validAccess });\n\t\treturn json({ success: true, media: result });\n\t} catch (err) {\n\t\tconst message = `Error saving remote media: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { userId: user._id, tenantId });\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":[],"mappings":";;;;;AAyBA,SAAS,kBAAgC;AACxC,MAAI,CAAC,WAAW;AACf,UAAM,IAAI,MAAM,qCAAqC;AAAA,EACtD;AACA,MAAI;AACH,UAAM,UAAU,IAAI,aAAa,SAAS;AAC1C,WAAO;AAAA,EACR,SAAS,KAAK;AACb,UAAM,UAAU,sCAAsC,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACtG,WAAO,MAAM,OAAO;AACpB,UAAM,IAAI,MAAM,OAAO;AAAA,EACxB;AACD;AAEO,MAAM,OAAuB,OAAO,EAAE,SAAS,aAAa;AAClE,QAAM,EAAE,MAAM,SAAA,IAAa;AAC3B,MAAI,CAAC,MAAM;AACV,WAAO,KAAK,8DAA8D;AAC1E,UAAM,MAAM,KAAK,cAAc;AAAA,EAChC;AAEA,MAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,WAAO,MAAM,+CAA+C;AAC5D,UAAM,MAAM,KAAK,mDAAmD;AAAA,EACrE;AAEA,MAAI;AACH,UAAM,EAAE,SAAS,SAAS,UAAU,aAAa,MAAM,QAAQ,KAAA;AAC/D,QAAI,CAAC,SAAS;AACb,YAAM,MAAM,KAAK,sBAAsB;AAAA,IACxC;AAGA,UAAM,cAA2B,CAAC,UAAU,WAAW,WAAW,EAAE,SAAS,MAAM,IAAI,SAAS;AAGhG,UAAM,gBAAgB,YAAY,YAAY;AAG9C,UAAM,eAAe,gBAAA;AACrB,UAAM,SAAS,MAAM,aAAa,gBAAgB,SAAS,KAAK,IAAI,SAAA,GAAY,aAAa,aAAa;AAE1G,WAAO,KAAK,mCAAmC,EAAE,SAAS,QAAQ,KAAK,KAAK,UAAU,QAAQ,YAAA,CAAa;AAC3G,WAAO,KAAK,EAAE,SAAS,MAAM,OAAO,QAAQ;AAAA,EAC7C,SAAS,KAAK;AACb,UAAM,UAAU,8BAA8B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC9F,WAAO,MAAM,SAAS,EAAE,QAAQ,KAAK,KAAK,UAAU;AACpD,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}