{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/status/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/status/+server.ts\n * @description API endpoint for updating widget status (with dependency validation)\n * Database agnostic - uses dbAdapter interface\n */\nimport { json, error } from '@sveltejs/kit';\nimport { logger } from '@shared/utils/logger.server';\nimport type { RequestHandler } from './$types';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\nimport { cacheService } from '@shared/database/CacheService';\n\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\tconst start = performance.now();\n\ttry {\n\t\tconst { user } = locals;\n\n\t\t// Check authentication\n\t\tif (!user) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Unauthorized',\n\t\t\t\t\terror: 'Authentication credentials missing'\n\t\t\t\t},\n\t\t\t\t{ status: 401 }\n\t\t\t);\n\t\t}\n\n\t\t// Check permission\n\t\tconst hasWidgetPermission = hasPermissionWithRoles(user, 'api:widgets', locals.roles);\n\t\tif (!hasWidgetPermission) {\n\t\t\tlogger.warn(`User ${user._id} (role: ${user.role}) denied access to API /api/widgets due to insufficient role permissions`);\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Insufficient permissions',\n\t\t\t\t\terror: 'User lacks api:widgets permission'\n\t\t\t\t},\n\t\t\t\t{ status: 403 }\n\t\t\t);\n\t\t} // Check database adapter availability\n\t\tif (!locals.dbAdapter?.widgets) {\n\t\t\tthrow error(500, 'Widget database adapter not available');\n\t\t}\n\n\t\tconst tenantId = request.headers.get('X-Tenant-ID') || locals.tenantId;\n\t\tconst { widgetName, isActive } = await request.json();\n\n\t\tif (!widgetName || typeof isActive !== 'boolean') {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Validation Error',\n\t\t\t\t\terror: 'Missing or invalid widgetName or isActive'\n\t\t\t\t},\n\t\t\t\t{ status: 400 }\n\t\t\t);\n\t\t}\n\n\t\t// Get all widgets to find the one we're updating\n\t\tconst allWidgetsResult = await locals.dbAdapter.widgets.findAll();\n\t\tif (!allWidgetsResult.success) {\n\t\t\tthrow error(500, `Failed to fetch widgets: ${allWidgetsResult.error?.message || 'Unknown error'}`);\n\t\t}\n\n\t\tconst allWidgets = allWidgetsResult.data || [];\n\t\tconst widget = allWidgets.find((w) => w.name === widgetName);\n\n\t\tif (!widget) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Not Found',\n\t\t\t\t\terror: `Widget \"${widgetName}\" not found.`\n\t\t\t\t},\n\t\t\t\t{ status: 404 }\n\t\t\t);\n\t\t}\n\n\t\t// Note: Widget interface doesn't track isCore status in database\n\t\t// Core widgets are determined by the file system location, not database property\n\n\t\t// If deactivating, check if the widget is in use by collections\n\t\tif (!isActive) {\n\t\t\tconst contentManager = await import('@content/ContentManager').then((m) => m.contentManager);\n\n\t\t\t// Check if widget is used in any collection\n\t\t\tconst allCollections = contentManager.getCollections();\n\t\t\tconst usedInCollections: string[] = [];\n\t\t\tfor (const [, schema] of Object.entries(allCollections)) {\n\t\t\t\tconst schemaObj = schema as Record<string, unknown>;\n\t\t\t\t// Check if any fields use this widget\n\t\t\t\tif (schemaObj.fields && Array.isArray(schemaObj.fields)) {\n\t\t\t\t\tif (schemaObj.fields.some((field: Record<string, unknown>) => field.widget === widgetName)) {\n\t\t\t\t\t\tusedInCollections.push((schemaObj.name as string) || 'Unknown');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (usedInCollections.length > 0) {\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Dependency Error',\n\t\t\t\t\t\terror: `Cannot deactivate widget \"${widgetName}\". It is currently used in collections: ${usedInCollections.join(', ')}.`\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 400 }\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// If activating, check dependencies\n\t\tif (isActive && widget.dependencies && widget.dependencies.length > 0) {\n\t\t\tconst inactiveDependencies: string[] = [];\n\t\t\tfor (const depName of widget.dependencies) {\n\t\t\t\tconst dep = allWidgets.find((w) => w.name === depName);\n\t\t\t\tif (!dep || !dep.isActive) {\n\t\t\t\t\tinactiveDependencies.push(depName);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (inactiveDependencies.length > 0) {\n\t\t\t\treturn json(\n\t\t\t\t\t{\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Dependency Error',\n\t\t\t\t\t\terror:\n\t\t\t\t\t\t\t`Cannot activate widget \"${widgetName}\". Required dependencies are inactive: ${inactiveDependencies.join(', ')}. ` +\n\t\t\t\t\t\t\t`Please activate the dependencies first.`\n\t\t\t\t\t},\n\t\t\t\t\t{ status: 400 }\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Update widget status in database using dbAdapter\n\t\tif (!widget._id) {\n\t\t\tthrow error(500, 'Widget ID not found');\n\t\t}\n\n\t\tlogger.debug(`Updating widget \"${widgetName}\" in database`, {\n\t\t\twidgetId: widget._id,\n\t\t\tcurrentStatus: widget.isActive,\n\t\t\tnewStatus: isActive,\n\t\t\twidgetData: { isActive, updatedAt: new Date() }\n\t\t});\n\n\t\tconst updateResult = await locals.dbAdapter.widgets.update(widget._id, {\n\t\t\tisActive\n\t\t});\n\n\t\tif (!updateResult.success || !updateResult.data) {\n\t\t\tconst errorMsg = !updateResult.success && 'error' in updateResult ? (updateResult.error as { message?: string })?.message : undefined;\n\t\t\tlogger.error('Failed to update widget in database', {\n\t\t\t\twidgetId: widget._id,\n\t\t\t\twidgetName,\n\t\t\t\terror: errorMsg\n\t\t\t});\n\t\t\tthrow error(500, `Failed to update widget status: ${errorMsg || 'Unknown error'}`);\n\t\t}\n\n\t\t// Clear widget active cache for current tenant ID\n\t\t// The cache key is 'widget:active:all' and gets prefixed with tenant during storage\n\t\tlogger.debug('[/api/widgets/status] Clearing widget active cache and related collections', { tenantId });\n\t\tawait cacheService.delete('widget:active:all', tenantId);\n\n\t\t// Enhanced cache invalidation (moved from widgetStore)\n\t\t// Widget state changed, so ALL collection-related caches are now invalid\n\t\ttry {\n\t\t\tawait cacheService.clearByPattern('query:collections:*');\n\t\t\tawait cacheService.clearByPattern('static:page:*'); // Page layouts depend on collections\n\t\t\tawait cacheService.clearByPattern('api:widgets:*'); // Active/required widgets API cache\n\t\t\tawait cacheService.clearByPattern('api:*:/api/admin/users*'); // Admin UI may show widget data\n\t\t} catch (cacheError) {\n\t\t\tlogger.warn('[/api/widgets/status] Enhanced cache clearing failed (non-critical):', cacheError);\n\t\t}\n\n\t\tconst duration = performance.now() - start;\n\t\tlogger.info(`Widget ${widgetName} ${isActive ? 'activated' : 'deactivated'}`, {\n\t\t\ttenantId,\n\t\t\tuser: user._id,\n\t\t\twidgetId: widget._id,\n\t\t\tupdatedWidget: updateResult.data,\n\t\t\tduration: `${duration.toFixed(2)}ms`\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\twidgetName,\n\t\t\t\tisActive,\n\t\t\t\ttenantId,\n\t\t\t\tupdatedAt: new Date().toISOString()\n\t\t\t},\n\t\t\tmessage: `Widget ${widgetName} ${isActive ? 'activated' : 'deactivated'} successfully`\n\t\t});\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to update widget status: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms`, stack: err instanceof Error ? err.stack : undefined });\n\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}