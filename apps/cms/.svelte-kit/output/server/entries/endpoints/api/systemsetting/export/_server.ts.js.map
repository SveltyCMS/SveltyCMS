{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/systemsetting/export/+server.ts"],"sourcesContent":["import { json, type RequestHandler } from '@sveltejs/kit';\nimport { getAllSettings } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { encryptData } from '@shared/utils/crypto';\nimport { nanoid } from 'nanoid';\nimport type { ExportOptions, ExportData, ExportMetadata, CollectionExport } from '@cms-types';\n\nconst SENSITIVE_PATTERNS: string[] = [\n\t'PASSWORD',\n\t'SECRET',\n\t'TOKEN',\n\t'KEY',\n\t'CLIENT_SECRET',\n\t'PRIVATE_KEY',\n\t'JWT_SECRET',\n\t'ENCRYPTION_KEY',\n\t'API_KEY'\n];\n\nasync function encryptSensitiveData(data: Record<string, unknown>, password: string): Promise<string> {\n\treturn encryptData(data, password);\n}\n\nfunction isSensitiveField(key: string): boolean {\n\tconst upperKey = key.toUpperCase();\n\treturn SENSITIVE_PATTERNS.some((pattern) => upperKey.includes(pattern));\n}\n\nasync function exportSettings(options: ExportOptions): Promise<{ settings: Record<string, unknown>; sensitive: Record<string, unknown> }> {\n\tlogger.info('Exporting settings', { options });\n\tconst allSettings = await getAllSettings();\n\tconst settings: Record<string, unknown> = {};\n\tconst sensitive: Record<string, unknown> = {};\n\tfor (const [key, value] of Object.entries(allSettings)) {\n\t\tif (isSensitiveField(key)) {\n\t\t\tif (options.includeSensitive) {\n\t\t\t\tsensitive[key] = value;\n\t\t\t\tlogger.trace(`Collected sensitive field for encryption: ${key}`);\n\t\t\t} else {\n\t\t\t\tlogger.trace(`Skipping sensitive field: ${key}`);\n\t\t\t}\n\t\t} else {\n\t\t\tsettings[key] = value;\n\t\t}\n\t}\n\tlogger.info(`Exported ${Object.keys(settings).length} regular settings, ${Object.keys(sensitive).length} sensitive settings`);\n\treturn { settings, sensitive };\n}\n\nasync function exportCollections(): Promise<CollectionExport[]> {\n\tlogger.info('Exporting collections');\n\tconst collections: CollectionExport[] = [];\n\tlogger.info(`Exported ${collections.length} collections`);\n\treturn collections;\n}\n\nfunction createExportMetadata(userId: string): ExportMetadata {\n\treturn {\n\t\texported_at: new Date().toISOString(),\n\t\tcms_version: process.env.npm_package_version || 'unknown',\n\t\tenvironment: process.env.NODE_ENV || 'development',\n\t\texported_by: userId,\n\t\texport_id: nanoid()\n\t};\n}\n\nasync function createExport(userId: string, options: ExportOptions): Promise<ExportData> {\n\tlogger.info('Creating export', { userId, options });\n\tconst exportData: ExportData = {\n\t\tmetadata: createExportMetadata(userId),\n\t\thasSensitiveData: false\n\t};\n\tif (options.includeSettings) {\n\t\tconst { settings, sensitive } = await exportSettings(options);\n\t\texportData.settings = settings;\n\t\tif (options.includeSensitive && Object.keys(sensitive).length > 0) {\n\t\t\tif (!options.sensitivePassword) {\n\t\t\t\tthrow new Error('sensitivePassword is required when includeSensitive is true');\n\t\t\t}\n\t\t\texportData.encryptedSensitive = await encryptSensitiveData(sensitive, options.sensitivePassword);\n\t\t\texportData.hasSensitiveData = true;\n\t\t\tlogger.info(`Encrypted ${Object.keys(sensitive).length} sensitive settings`);\n\t\t}\n\t}\n\tif (options.includeCollections) {\n\t\texportData.collections = await exportCollections();\n\t}\n\tlogger.info('Export created successfully', {\n\t\texport_id: exportData.metadata.export_id,\n\t\thas_settings: !!exportData.settings,\n\t\thas_collections: !!exportData.collections,\n\t\thas_sensitive: exportData.hasSensitiveData\n\t});\n\treturn exportData;\n}\n\nexport const POST: RequestHandler = async ({ locals, request }) => {\n\tif (!locals.user) {\n\t\treturn json({ error: 'Unauthorized' }, { status: 401 });\n\t}\n\ttry {\n\t\tconst options: ExportOptions = await request.json();\n\t\tconst exportOptions: ExportOptions = {\n\t\t\tincludeSettings: options.includeSettings ?? true,\n\t\t\tincludeCollections: options.includeCollections ?? false,\n\t\t\tincludeSensitive: options.includeSensitive ?? false,\n\t\t\tformat: options.format ?? 'json',\n\t\t\tgroups: options.groups,\n\t\t\tcollections: options.collections\n\t\t};\n\t\tconst exportData = await createExport(locals.user._id, exportOptions);\n\t\tconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n\t\tconst environment = exportData.metadata.environment || 'unknown';\n\t\tconst filename = `sveltycms-export-${environment}-${timestamp}.json`;\n\t\treturn json(exportData, {\n\t\t\tstatus: 200,\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t'Content-Disposition': `attachment; filename=\"${filename}\"`\n\t\t\t}\n\t\t});\n\t} catch (error) {\n\t\tlogger.error('Export error:', error);\n\t\treturn json(\n\t\t\t{\n\t\t\t\terror: 'Export failed',\n\t\t\t\tmessage: error instanceof Error ? error.message : 'Unknown error'\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":"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"}