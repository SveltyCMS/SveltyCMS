{"version":3,"file":"_server.ts.js","sources":["../../../../../../../../src/routes/api/widgets/installed/+server.ts"],"sourcesContent":["/**\n * @file src/routes/api/widgets/installed/+server.ts\n * @description API endpoint for managing installed widgets per tenant with 3-pillar architecture support\n */\n\nimport { json } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { logger } from '@shared/utils/logger.server';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\nimport { widgets, getWidgetFunction } from '@shared/stores/widgetStore.svelte';\n\nexport const GET: RequestHandler = async ({ url, locals }) => {\n\tconst start = performance.now();\n\tconst tenantId = url.searchParams.get('tenantId') || locals.tenantId || 'default-tenant';\n\n\ttry {\n\t\tconst { user } = locals;\n\n\t\tif (!user) {\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Unauthorized',\n\t\t\t\t\terror: 'Authentication credentials missing'\n\t\t\t\t},\n\t\t\t\t{ status: 401 }\n\t\t\t);\n\t\t}\n\n\t\t// Check permission\n\t\tconst hasWidgetPermission = hasPermissionWithRoles(user, 'api:widgets', locals.roles);\n\t\tif (!hasWidgetPermission) {\n\t\t\tlogger.warn(`User ${user._id} denied access to widget API due to insufficient permissions`);\n\t\t\treturn json(\n\t\t\t\t{\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: 'Insufficient permissions',\n\t\t\t\t\terror: 'User lacks api:widgets permission'\n\t\t\t\t},\n\t\t\t\t{ status: 403 }\n\t\t\t);\n\t\t}\n\n\t\t// Initialize widgets to get custom widgets list\n\t\tawait widgets.initialize(tenantId);\n\n\t\t// Get all custom widgets from the file system (these are \"installed\" in the codebase)\n\t\tconst installedWidgetNames = widgets.customWidgets;\n\n\t\t// Enrich with metadata from widget functions\n\t\tconst installedWidgets = installedWidgetNames.map((name) => {\n\t\t\tconst widgetFn = getWidgetFunction(name) as any;\n\t\t\treturn {\n\t\t\t\tname,\n\t\t\t\ticon: widgetFn?.Icon || 'mdi:puzzle-plus',\n\t\t\t\tdescription: widgetFn?.Description || '',\n\t\t\t\t// 3-Pillar Architecture metadata\n\t\t\t\tinputComponentPath: widgetFn?.__inputComponentPath || '',\n\t\t\t\tdisplayComponentPath: widgetFn?.__displayComponentPath || '',\n\t\t\t\tdependencies: widgetFn?.__dependencies || [],\n\t\t\t\tisCore: false // Custom widgets are never core\n\t\t\t};\n\t\t});\n\n\t\tconst duration = performance.now() - start;\n\n\t\tlogger.trace(`Retrieved ${installedWidgets.length} installed widgets for tenant: ${tenantId}`, {\n\t\t\ttenantId,\n\t\t\tcount: installedWidgets.length\n\t\t});\n\n\t\treturn json({\n\t\t\tsuccess: true,\n\t\t\tdata: {\n\t\t\t\twidgets: installedWidgets,\n\t\t\t\ttotal: installedWidgets.length,\n\t\t\t\ttenantId,\n\t\t\t\tperformance: { duration: `${duration.toFixed(2)}ms` }\n\t\t\t},\n\t\t\tmessage: 'Installed widgets retrieved successfully'\n\t\t});\n\t} catch (err) {\n\t\tconst duration = performance.now() - start;\n\t\tconst message = `Failed to get installed widgets: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message, { duration: `${duration.toFixed(2)}ms`, stack: err instanceof Error ? err.stack : undefined });\n\n\t\t// Standardized error response\n\t\treturn json(\n\t\t\t{\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: 'Internal Server Error',\n\t\t\t\terror: message\n\t\t\t},\n\t\t\t{ status: 500 }\n\t\t);\n\t}\n};\n"],"names":[],"mappings":";;;;AAYO,MAAM,MAAsB,OAAO,EAAE,KAAK,aAAa;AAC7D,QAAM,QAAQ,YAAY,IAAA;AAC1B,QAAM,WAAW,IAAI,aAAa,IAAI,UAAU,KAAK,OAAO,YAAY;AAExE,MAAI;AACH,UAAM,EAAE,SAAS;AAEjB,QAAI,CAAC,MAAM;AACV,aAAO;AAAA,QACN;AAAA,UACC,SAAS;AAAA,UACT,SAAS;AAAA,UACT,OAAO;AAAA,QAAA;AAAA,QAER,EAAE,QAAQ,IAAA;AAAA,MAAI;AAAA,IAEhB;AAGA,UAAM,sBAAsB,uBAAuB,MAAM,eAAe,OAAO,KAAK;AACpF,QAAI,CAAC,qBAAqB;AACzB,aAAO,KAAK,QAAQ,KAAK,GAAG,8DAA8D;AAC1F,aAAO;AAAA,QACN;AAAA,UACC,SAAS;AAAA,UACT,SAAS;AAAA,UACT,OAAO;AAAA,QAAA;AAAA,QAER,EAAE,QAAQ,IAAA;AAAA,MAAI;AAAA,IAEhB;AAGA,UAAM,QAAQ,WAAW,QAAQ;AAGjC,UAAM,uBAAuB,QAAQ;AAGrC,UAAM,mBAAmB,qBAAqB,IAAI,CAAC,SAAS;AAC3D,YAAM,WAAW,kBAAkB,IAAI;AACvC,aAAO;AAAA,QACN;AAAA,QACA,MAAM,UAAU,QAAQ;AAAA,QACxB,aAAa,UAAU,eAAe;AAAA;AAAA,QAEtC,oBAAoB,UAAU,wBAAwB;AAAA,QACtD,sBAAsB,UAAU,0BAA0B;AAAA,QAC1D,cAAc,UAAU,kBAAkB,CAAA;AAAA,QAC1C,QAAQ;AAAA;AAAA,MAAA;AAAA,IAEV,CAAC;AAED,UAAM,WAAW,YAAY,IAAA,IAAQ;AAErC,WAAO,MAAM,aAAa,iBAAiB,MAAM,kCAAkC,QAAQ,IAAI;AAAA,MAC9F;AAAA,MACA,OAAO,iBAAiB;AAAA,IAAA,CACxB;AAED,WAAO,KAAK;AAAA,MACX,SAAS;AAAA,MACT,MAAM;AAAA,QACL,SAAS;AAAA,QACT,OAAO,iBAAiB;AAAA,QACxB;AAAA,QACA,aAAa,EAAE,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC,KAAA;AAAA,MAAK;AAAA,MAErD,SAAS;AAAA,IAAA,CACT;AAAA,EACF,SAAS,KAAK;AACb,UAAM,WAAW,YAAY,IAAA,IAAQ;AACrC,UAAM,UAAU,oCAAoC,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AACpG,WAAO,MAAM,SAAS,EAAE,UAAU,GAAG,SAAS,QAAQ,CAAC,CAAC,MAAM,OAAO,eAAe,QAAQ,IAAI,QAAQ,QAAW;AAGnH,WAAO;AAAA,MACN;AAAA,QACC,SAAS;AAAA,QACT,SAAS;AAAA,QACT,OAAO;AAAA,MAAA;AAAA,MAER,EAAE,QAAQ,IAAA;AAAA,IAAI;AAAA,EAEhB;AACD;"}