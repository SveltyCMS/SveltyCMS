{"version":3,"file":"_server.ts.js","sources":["../../../../../../../src/routes/files/[...path]/+server.ts"],"sourcesContent":["/**\n * @file src/routes/files/[...path]/+server.ts\n * @description Serves media files via Streams (Non-blocking) or redirects to cloud storage.\n *\n * Improvements:\n * - **Streaming:** Uses `createReadStream` to serve files with near-zero memory footprint.\n * - **Async I/O:** Uses `fs.promises` to prevent blocking the Node.js event loop.\n * - **304 Not Modified:** Handles browser caching headers to save bandwidth.\n * - **Error Handling:** Handles 'ENOENT' specifically for cleaner 404s.\n */\n\nimport { error, redirect } from '@sveltejs/kit';\nimport type { RequestHandler } from './$types';\nimport { getPublicSettingSync } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\nimport { createReadStream } from 'node:fs';\nimport { stat } from 'node:fs/promises';\nimport path from 'node:path';\nimport { Readable } from 'node:stream';\nimport { lookup } from 'mime-types';\n\nexport const GET: RequestHandler = async ({ params, request }) => {\n\ttry {\n\t\tconst filePath = params.path;\n\n\t\tif (!filePath) {\n\t\t\tlogger.warn('File request missing path');\n\t\t\tthrow error(400, 'File path is required');\n\t\t}\n\n\t\t// Check storage type\n\t\tconst storageType = getPublicSettingSync('MEDIA_STORAGE_TYPE');\n\n\t\t// --- CLOUD STORAGE REDIRECT ---\n\t\tif (storageType !== 'local') {\n\t\t\tconst cloudUrl = getPublicSettingSync('MEDIA_CLOUD_PUBLIC_URL') || getPublicSettingSync('MEDIASERVER_URL');\n\n\t\t\tif (cloudUrl) {\n\t\t\t\tconst mediaFolder = getPublicSettingSync('MEDIA_FOLDER') || '';\n\t\t\t\tconst normalizedFolder = mediaFolder.replace(/^\\.\\//, '').replace(/^\\/+/, '').replace(/\\/+$/, '');\n\t\t\t\tconst baseUrl = cloudUrl.replace(/\\/+$/, '');\n\t\t\t\tconst fullUrl = normalizedFolder ? `${baseUrl}/${normalizedFolder}/${filePath}` : `${baseUrl}/${filePath}`;\n\n\t\t\t\tlogger.debug('Redirecting to cloud storage', { filePath, cloudUrl: fullUrl });\n\t\t\t\tthrow redirect(307, fullUrl);\n\t\t\t} else {\n\t\t\t\tlogger.error('Cloud storage configured but no public URL available', { storageType });\n\t\t\t\tthrow error(500, 'Cloud storage URL not configured');\n\t\t\t}\n\t\t}\n\n\t\t// --- LOCAL STORAGE SERVING ---\n\t\tconst mediaFolder = getPublicSettingSync('MEDIA_FOLDER');\n\t\tconsole.log('Files Route Debug:', { mediaFolder, filePath, storageType });\n\n\t\tif (!mediaFolder) {\n\t\t\tlogger.error('MEDIA_FOLDER not configured');\n\t\t\tthrow error(500, 'Media storage not configured');\n\t\t}\n\n\t\tconst normalizedMediaFolder = mediaFolder.replace(/^\\.\\//, '').replace(/^\\/+/, '');\n\t\tconst fullPath = path.join(process.cwd(), normalizedMediaFolder, filePath);\n\t\tconsole.log('Files Route resolving:', fullPath);\n\n\t\t// Security: Directory Traversal Prevention\n\t\tconst resolvedPath = path.resolve(fullPath);\n\t\tconst allowedBasePath = path.resolve(process.cwd(), normalizedMediaFolder);\n\n\t\tif (!resolvedPath.startsWith(allowedBasePath)) {\n\t\t\tlogger.warn('Directory traversal attempt detected', { requestedPath: filePath, resolvedPath });\n\t\t\tthrow error(403, 'Access denied');\n\t\t}\n\n\t\t// Async Stat check (Non-blocking)\n\t\tconst stats = await stat(resolvedPath);\n\n\t\tif (!stats.isFile()) {\n\t\t\tthrow error(400, 'Invalid file request');\n\t\t}\n\n\t\t// Browser Cache Optimization (304 Not Modified)\n\t\tconst lastModified = stats.mtime.toUTCString();\n\t\tif (request.headers.get('if-modified-since') === lastModified) {\n\t\t\treturn new Response(null, { status: 304 });\n\t\t}\n\n\t\t// MIME Type\n\t\tconst mimeType = lookup(resolvedPath) || 'application/octet-stream';\n\n\t\t// STREAMING RESPONSE (Memory Efficient)\n\t\t// We convert the Node stream to a Web ReadableStream for SvelteKit\n\t\tconst nodeStream = createReadStream(resolvedPath);\n\t\tconst stream = Readable.toWeb(nodeStream);\n\n\t\treturn new Response(stream as any, {\n\t\t\tstatus: 200,\n\t\t\theaders: {\n\t\t\t\t'Content-Type': mimeType,\n\t\t\t\t'Content-Length': stats.size.toString(),\n\t\t\t\t'Cache-Control': 'public, max-age=31536000, immutable',\n\t\t\t\t'Last-Modified': lastModified\n\t\t\t}\n\t\t});\n\t} catch (err: any) {\n\t\t// Handle Redirects (SvelteKit flow control)\n\t\tif (err && typeof err === 'object' && 'status' in err) {\n\t\t\tthrow err;\n\t\t}\n\n\t\t// Handle File Not Found specifically\n\t\tif (err.code === 'ENOENT') {\n\t\t\tlogger.debug('File not found', { path: params.path });\n\t\t\tthrow error(404, 'File not found');\n\t\t}\n\n\t\tlogger.error('Error serving file', { error: err, path: params.path });\n\t\tthrow error(500, 'Failed to serve file');\n\t}\n};\n"],"names":["mediaFolder"],"mappings":";;;;;;;;AAqBO,MAAM,MAAsB,OAAO,EAAE,QAAQ,cAAc;AACjE,MAAI;AACH,UAAM,WAAW,OAAO;AAExB,QAAI,CAAC,UAAU;AACd,aAAO,KAAK,2BAA2B;AACvC,YAAM,MAAM,KAAK,uBAAuB;AAAA,IACzC;AAGA,UAAM,cAAc,qBAAqB,oBAAoB;AAG7D,QAAI,gBAAgB,SAAS;AAC5B,YAAM,WAAW,qBAAqB,wBAAwB,KAAK,qBAAqB,iBAAiB;AAEzG,UAAI,UAAU;AACb,cAAMA,eAAc,qBAAqB,cAAc,KAAK;AAC5D,cAAM,mBAAmBA,aAAY,QAAQ,SAAS,EAAE,EAAE,QAAQ,QAAQ,EAAE,EAAE,QAAQ,QAAQ,EAAE;AAChG,cAAM,UAAU,SAAS,QAAQ,QAAQ,EAAE;AAC3C,cAAM,UAAU,mBAAmB,GAAG,OAAO,IAAI,gBAAgB,IAAI,QAAQ,KAAK,GAAG,OAAO,IAAI,QAAQ;AAExG,eAAO,MAAM,gCAAgC,EAAE,UAAU,UAAU,SAAS;AAC5E,cAAM,SAAS,KAAK,OAAO;AAAA,MAC5B,OAAO;AACN,eAAO,MAAM,wDAAwD,EAAE,YAAA,CAAa;AACpF,cAAM,MAAM,KAAK,kCAAkC;AAAA,MACpD;AAAA,IACD;AAGA,UAAM,cAAc,qBAAqB,cAAc;AACvD,YAAQ,IAAI,sBAAsB,EAAE,aAAa,UAAU,aAAa;AAExE,QAAI,CAAC,aAAa;AACjB,aAAO,MAAM,6BAA6B;AAC1C,YAAM,MAAM,KAAK,8BAA8B;AAAA,IAChD;AAEA,UAAM,wBAAwB,YAAY,QAAQ,SAAS,EAAE,EAAE,QAAQ,QAAQ,EAAE;AACjF,UAAM,WAAW,KAAK,KAAK,QAAQ,IAAA,GAAO,uBAAuB,QAAQ;AACzE,YAAQ,IAAI,0BAA0B,QAAQ;AAG9C,UAAM,eAAe,KAAK,QAAQ,QAAQ;AAC1C,UAAM,kBAAkB,KAAK,QAAQ,QAAQ,IAAA,GAAO,qBAAqB;AAEzE,QAAI,CAAC,aAAa,WAAW,eAAe,GAAG;AAC9C,aAAO,KAAK,wCAAwC,EAAE,eAAe,UAAU,cAAc;AAC7F,YAAM,MAAM,KAAK,eAAe;AAAA,IACjC;AAGA,UAAM,QAAQ,MAAM,KAAK,YAAY;AAErC,QAAI,CAAC,MAAM,UAAU;AACpB,YAAM,MAAM,KAAK,sBAAsB;AAAA,IACxC;AAGA,UAAM,eAAe,MAAM,MAAM,YAAA;AACjC,QAAI,QAAQ,QAAQ,IAAI,mBAAmB,MAAM,cAAc;AAC9D,aAAO,IAAI,SAAS,MAAM,EAAE,QAAQ,KAAK;AAAA,IAC1C;AAGA,UAAM,WAAW,OAAO,YAAY,KAAK;AAIzC,UAAM,aAAa,iBAAiB,YAAY;AAChD,UAAM,SAAS,SAAS,MAAM,UAAU;AAExC,WAAO,IAAI,SAAS,QAAe;AAAA,MAClC,QAAQ;AAAA,MACR,SAAS;AAAA,QACR,gBAAgB;AAAA,QAChB,kBAAkB,MAAM,KAAK,SAAA;AAAA,QAC7B,iBAAiB;AAAA,QACjB,iBAAiB;AAAA,MAAA;AAAA,IAClB,CACA;AAAA,EACF,SAAS,KAAU;AAElB,QAAI,OAAO,OAAO,QAAQ,YAAY,YAAY,KAAK;AACtD,YAAM;AAAA,IACP;AAGA,QAAI,IAAI,SAAS,UAAU;AAC1B,aAAO,MAAM,kBAAkB,EAAE,MAAM,OAAO,MAAM;AACpD,YAAM,MAAM,KAAK,gBAAgB;AAAA,IAClC;AAEA,WAAO,MAAM,sBAAsB,EAAE,OAAO,KAAK,MAAM,OAAO,MAAM;AACpE,UAAM,MAAM,KAAK,sBAAsB;AAAA,EACxC;AACD;"}