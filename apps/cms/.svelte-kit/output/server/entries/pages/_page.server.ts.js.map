{"version":3,"file":"_page.server.ts.js","sources":["../../../../../src/routes/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/+page.server.ts\n * @description\n * Server-side logic for the root route, handling redirection to the first collection.\n * This version is updated to use the modern ContentManager for cleaner logic.\n */\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\n\nimport { contentManager } from '../content/ContentManager';\nimport { dbInitPromise } from '@shared/database/db';\nimport { error, redirect } from '@sveltejs/kit';\n\nimport type { PageServerLoad } from './$types';\nimport type { User, Role } from '@shared/database/auth/types';\n\n// Roles\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nexport const load: PageServerLoad = async ({ locals, url }) => {\n\tconst { user, tenantId, roles } = locals as { user: User | null; tenantId: string | undefined; roles: Role[] | undefined };\n\tconst tenantRoles = roles || [];\n\tif (!user) {\n\t\tlogger.debug('User is not authenticated, redirecting to login');\n\t\tthrow redirect(302, '/login');\n\t}\n\n\ttry {\n\t\t// Wait for the database and ContentManager to be ready\n\t\tawait dbInitPromise;\n\n\t\t// Verify ContentManager is ready (should be from hooks)\n\t\tconst healthStatus = contentManager.getHealthStatus();\n\t\tif (healthStatus.state !== 'initialized') {\n\t\t\tlogger.warn('ContentManager not initialized in page load', {\n\t\t\t\tstate: healthStatus.state\n\t\t\t});\n\t\t}\n\t\tlogger.debug('System is ready, proceeding with page load.', { tenantId });\n\n\t\t// For any route other than the root, just return user data\n\t\tif (url.pathname !== '/') {\n\t\t\tconst userRole = tenantRoles.find((role) => role._id === user?.role);\n\t\t\tconst isAdmin = Boolean(userRole?.isAdmin);\n\n\t\t\treturn {\n\t\t\t\tuser: { ...user, isAdmin },\n\t\t\t\tpermissions: locals.permissions\n\t\t\t};\n\t\t}\n\n\t\t// --- Start of Redirect Logic for the Root Route ('/') ---\n\t\tif (getPrivateSettingSync('MULTI_TENANT') && !tenantId) {\n\t\t\tthrow error(400, 'Tenant could not be identified for this operation.');\n\t\t}\n\n\t\t// Determine the correct language for the redirect URL\n\t\tconst redirectLanguage = url.searchParams.get('contentLanguage') || user.locale || publicEnv.DEFAULT_CONTENT_LANGUAGE || 'en';\n\n\t\t// Use the new, efficient method from ContentManager to get the redirect URL\n\t\tconst redirectUrl = await contentManager.getFirstCollectionRedirectUrl(redirectLanguage, tenantId);\n\n\t\t// If a valid collection URL is found, redirect the user\n\t\tif (redirectUrl) {\n\t\t\tlogger.info(`Redirecting to first collection: ${redirectUrl}`, { tenantId });\n\t\t\tthrow redirect(302, redirectUrl);\n\t\t}\n\n\t\t// If no collections are found, redirect to collectionbuilder\n\t\tlogger.warn('No collections found for user. Redirecting to collectionbuilder.', { tenantId });\n\t\tthrow redirect(302, '/config/collectionbuilder');\n\t\tconst userRole = tenantRoles.find((role) => role._id === user?.role);\n\t\tconst isAdmin = Boolean(userRole?.isAdmin);\n\t\treturn {\n\t\t\tuser: { ...user, isAdmin },\n\t\t\tpermissions: locals.permissions\n\t\t};\n\t} catch (err) {\n\t\t// Re-throw redirects and known errors\n\t\tif (typeof err === 'object' && err !== null && 'status' in err) {\n\t\t\tthrow err;\n\t\t}\n\t\tlogger.error('Unexpected error in root page load function', { error: err, tenantId });\n\t\tconst message = err instanceof Error ? err.message : 'An unexpected error occurred';\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":["userRole","isAdmin"],"mappings":";;;;;;AAqBO,MAAM,OAAuB,OAAO,EAAE,QAAQ,UAAU;AAC9D,QAAM,EAAE,MAAM,UAAU,MAAA,IAAU;AAClC,QAAM,cAAc,SAAS,CAAA;AAC7B,MAAI,CAAC,MAAM;AACV,WAAO,MAAM,iDAAiD;AAC9D,UAAM,SAAS,KAAK,QAAQ;AAAA,EAC7B;AAEA,MAAI;AAEH,UAAM;AAGN,UAAM,eAAe,eAAe,gBAAA;AACpC,QAAI,aAAa,UAAU,eAAe;AACzC,aAAO,KAAK,+CAA+C;AAAA,QAC1D,OAAO,aAAa;AAAA,MAAA,CACpB;AAAA,IACF;AACA,WAAO,MAAM,+CAA+C,EAAE,SAAA,CAAU;AAGxE,QAAI,IAAI,aAAa,KAAK;AACzB,YAAMA,YAAW,YAAY,KAAK,CAAC,SAAS,KAAK,QAAQ,MAAM,IAAI;AACnE,YAAMC,WAAU,QAAQD,WAAU,OAAO;AAEzC,aAAO;AAAA,QACN,MAAM,EAAE,GAAG,MAAM,SAAAC,SAAAA;AAAAA,QACjB,aAAa,OAAO;AAAA,MAAA;AAAA,IAEtB;AAGA,QAAI,sBAAsB,cAAc,KAAK,CAAC,UAAU;AACvD,YAAM,MAAM,KAAK,oDAAoD;AAAA,IACtE;AAGA,UAAM,mBAAmB,IAAI,aAAa,IAAI,iBAAiB,KAAK,KAAK,UAAU,UAAU,4BAA4B;AAGzH,UAAM,cAAc,MAAM,eAAe,8BAA8B,kBAAkB,QAAQ;AAGjG,QAAI,aAAa;AAChB,aAAO,KAAK,oCAAoC,WAAW,IAAI,EAAE,UAAU;AAC3E,YAAM,SAAS,KAAK,WAAW;AAAA,IAChC;AAGA,WAAO,KAAK,oEAAoE,EAAE,SAAA,CAAU;AAC5F,UAAM,SAAS,KAAK,2BAA2B;AAC/C,UAAM,WAAW,YAAY,KAAK,CAAC,SAAS,KAAK,QAAQ,MAAM,IAAI;AACnE,UAAM,UAAU,QAAQ,UAAU,OAAO;AACzC,WAAO;AAAA,MACN,MAAM,EAAE,GAAG,MAAM,QAAA;AAAA,MACjB,aAAa,OAAO;AAAA,IAAA;AAAA,EAEtB,SAAS,KAAK;AAEb,QAAI,OAAO,QAAQ,YAAY,QAAQ,QAAQ,YAAY,KAAK;AAC/D,YAAM;AAAA,IACP;AACA,WAAO,MAAM,+CAA+C,EAAE,OAAO,KAAK,UAAU;AACpF,UAAM,UAAU,eAAe,QAAQ,IAAI,UAAU;AACrD,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}