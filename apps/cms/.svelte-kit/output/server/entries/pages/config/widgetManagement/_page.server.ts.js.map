{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../../src/routes/config/widgetManagement/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/config/widgetManagement/+page.server.ts\n * @description Server-side logic for Widget Management page authentication and authorization.\n *\n * Handles user authentication and role-based access control for the Widget Management page.\n * Redirects unauthenticated users to the login page and restricts access based on user permissions.\n *\n * Responsibilities:\n * - Checks for authenticated user in locals (set by hooks.server.ts).\n * - Checks user permissions for widget management access.\n * - Returns user data if authentication and authorization are successful.\n * - Handles cases of unauthenticated users or insufficient permissions.\n */\n\nimport { redirect, error } from '@sveltejs/kit';\nimport type { PageServerLoad } from './$types';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nexport const load: PageServerLoad = async ({ locals }) => {\n\ttry {\n\t\tconst { user, roles: tenantRoles } = locals;\n\n\t\t// If validation fails, redirect the user to the login page\n\t\tif (!user) {\n\t\t\tlogger.warn('User not authenticated, redirecting to login');\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\n\t\tlogger.trace(`User authenticated successfully for user: ${user._id}}`);\n\n\t\t// Check user permission for widget management\n\t\t// Permissions are stored as strings like 'config:widgetManagement:manage'\n\t\tconst hasWidgetPermission = user.permissions?.includes('config:widgetManagement:manage') || tenantRoles.some((role) => role.isAdmin);\n\n\t\tif (!hasWidgetPermission) {\n\t\t\tconst message = `User ${user._id} does not have permission to access widget management`;\n\t\t\tlogger.warn(message);\n\t\t\tthrow error(403, 'Insufficient permissions');\n\t\t}\n\n\t\t// Get tenant information for multi-tenant widget management\n\t\t// Note: tenantId is not on the user object, it's in locals\n\t\tconst tenantId = locals.tenantId || 'default-tenant';\n\n\t\t// Load installed widgets for this tenant\n\t\tconst installedWidgets: string[] = [];\n\t\ttry {\n\t\t\t// TODO: Implement database query to get installed widgets for tenant\n\t\t\t// installedWidgets = await getInstalledWidgets(tenantId);\n\t\t} catch (error) {\n\t\t\tlogger.warn(`Failed to load installed widgets for tenant ${tenantId}:`, error);\n\t\t}\n\n\t\t// Check additional widget permissions\n\t\t// Permissions are stored as strings in user.permissions array\n\t\tconst canInstallWidgets = user.permissions?.includes('config:widgetInstall:manage') || tenantRoles.some((role) => role.isAdmin);\n\t\tconst canUninstallWidgets = user.permissions?.includes('config:widgetUninstall:manage') || tenantRoles.some((role) => role.isAdmin);\n\t\tconst canManageMarketplace = user.permissions?.includes('config:marketplace:manage') || tenantRoles.some((role) => role.isAdmin);\n\n\t\t// Return user data and widget management context\n\t\tconst { _id, ...rest } = user;\n\t\treturn {\n\t\t\tuser: {\n\t\t\t\t_id: _id.toString(),\n\t\t\t\t...rest\n\t\t\t},\n\t\t\ttenantId,\n\t\t\tinstalledWidgets,\n\t\t\t// Additional context for widget management\n\t\t\tcanInstallWidgets,\n\t\t\tcanUninstallWidgets,\n\t\t\tcanManageMarketplace\n\t\t};\n\t} catch (err) {\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\t// This is likely a redirect or an error we've already handled\n\t\t\tthrow err;\n\t\t}\n\t\tconst message = `Error in load function: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":["error"],"mappings":";;AAoBO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AACH,UAAM,EAAE,MAAM,OAAO,YAAA,IAAgB;AAGrC,QAAI,CAAC,MAAM;AACV,aAAO,KAAK,8CAA8C;AAC1D,YAAM,SAAS,KAAK,QAAQ;AAAA,IAC7B;AAEA,WAAO,MAAM,6CAA6C,KAAK,GAAG,GAAG;AAIrE,UAAM,sBAAsB,KAAK,aAAa,SAAS,gCAAgC,KAAK,YAAY,KAAK,CAAC,SAAS,KAAK,OAAO;AAEnI,QAAI,CAAC,qBAAqB;AACzB,YAAM,UAAU,QAAQ,KAAK,GAAG;AAChC,aAAO,KAAK,OAAO;AACnB,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAIA,UAAM,WAAW,OAAO,YAAY;AAGpC,UAAM,mBAA6B,CAAA;AACnC,QAAI;AAAA,IAGJ,SAASA,QAAO;AACf,aAAO,KAAK,+CAA+C,QAAQ,KAAKA,MAAK;AAAA,IAC9E;AAIA,UAAM,oBAAoB,KAAK,aAAa,SAAS,6BAA6B,KAAK,YAAY,KAAK,CAAC,SAAS,KAAK,OAAO;AAC9H,UAAM,sBAAsB,KAAK,aAAa,SAAS,+BAA+B,KAAK,YAAY,KAAK,CAAC,SAAS,KAAK,OAAO;AAClI,UAAM,uBAAuB,KAAK,aAAa,SAAS,2BAA2B,KAAK,YAAY,KAAK,CAAC,SAAS,KAAK,OAAO;AAG/H,UAAM,EAAE,KAAK,GAAG,KAAA,IAAS;AACzB,WAAO;AAAA,MACN,MAAM;AAAA,QACL,KAAK,IAAI,SAAA;AAAA,QACT,GAAG;AAAA,MAAA;AAAA,MAEJ;AAAA,MACA;AAAA;AAAA,MAEA;AAAA,MACA;AAAA,MACA;AAAA,IAAA;AAAA,EAEF,SAAS,KAAK;AACb,QAAI,eAAe,SAAS,YAAY,KAAK;AAE5C,YAAM;AAAA,IACP;AACA,UAAM,UAAU,2BAA2B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC3F,WAAO,MAAM,OAAO;AACpB,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}