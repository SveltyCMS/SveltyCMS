{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../src/routes/config/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/config/+page.server.ts\n * @description Server-side logic for Config page authentication and authorization.\n *\n * SECURITY ARCHITECTURE (Layer 2 of 3):\n * This provides fine-grained permission checking for UI elements.\n * Works with:\n * - Layer 1: hooks.server.ts (API/route protection)\n * - Layer 2: This file (page-level authorization)\n * - Layer 3: PermissionGuard.svelte (UI visibility control)\n */\n\nimport { redirect, error } from '@sveltejs/kit';\nimport type { PageServerLoad } from './$types';\n\n// Auth\nimport { hasPermissionByAction } from '@shared/database/auth/permissions';\nimport { permissionConfigs } from '@shared/database/auth/permissions';\nimport { permissions as allPermissions } from '@shared/database/auth/permissions';\n\n// System Logger\nimport { logger } from '@shared/utils/logger.server';\n\nexport const load: PageServerLoad = async ({ locals }) => {\n\ttry {\n\t\tconst { user } = locals;\n\n\t\tif (!user) {\n\t\t\tlogger.warn('User not authenticated, redirecting to login');\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\n\t\tlogger.trace(`User session validated successfully for user: ${user._id}`);\n\n\t\tif (!user.role) {\n\t\t\tconst message = `User role is missing for user ${user.email}`;\n\t\t\tlogger.warn(message);\n\t\t\tthrow error(403, message);\n\t\t}\n\n\t\t// Check if user is admin (for UI optimization)\n\t\tconst userRole = (locals.roles || []).find((role) => role._id === user.role);\n\t\tconst isAdmin = userRole?.isAdmin === true;\n\n\t\tconst serializableUser = {\n\t\t\t_id: user._id.toString(),\n\t\t\temail: user.email,\n\t\t\trole: user.role,\n\t\t\tpermissions: user.permissions\n\t\t};\n\n\t\t// Fine-grained permission checking for each config item\n\t\t// This allows control where each setting group,\n\t\t// menu item, or feature can have individual permissions assigned\n\t\tconst permissions: Record<string, { hasPermission: boolean; isRateLimited?: boolean }> = {};\n\n\t\tfor (const key in permissionConfigs) {\n\t\t\tconst config = permissionConfigs[key];\n\n\t\t\t// Admin bypass for efficiency (admins have all permissions)\n\t\t\tif (isAdmin) {\n\t\t\t\tpermissions[config.contextId] = { hasPermission: true, isRateLimited: false };\n\t\t\t} else {\n\t\t\t\t// Check user permission for non-admin\n\t\t\t\t// This supports fine-grained permissions like:\n\t\t\t\t// - config:settings:cache\n\t\t\t\t// - config:settings:database\n\t\t\t\t// - config:settings:email\n\t\t\t\t// etc.\n\t\t\t\tconst permissionCheck = await hasPermissionByAction(user, config.action, config.type, config.contextId, locals.roles || []);\n\t\t\t\tpermissions[config.contextId] = {\n\t\t\t\t\thasPermission: permissionCheck,\n\t\t\t\t\tisRateLimited: false\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tuser: serializableUser,\n\t\t\tpermissions,\n\t\t\tpermissionConfigs,\n\t\t\tallPermissions,\n\t\t\tisAdmin\n\t\t};\n\t} catch (err) {\n\t\tif (err instanceof Error && 'status' in err) {\n\t\t\t// This is likely a redirect or an error we've already handled\n\t\t\tthrow err;\n\t\t}\n\t\tconst message = `Error in load function: ${err instanceof Error ? err.message : String(err)}`;\n\t\tlogger.error(message);\n\t\tthrow error(500, message);\n\t}\n};\n"],"names":["permissions","allPermissions"],"mappings":";;;AAuBO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AACH,UAAM,EAAE,SAAS;AAEjB,QAAI,CAAC,MAAM;AACV,aAAO,KAAK,8CAA8C;AAC1D,YAAM,SAAS,KAAK,QAAQ;AAAA,IAC7B;AAEA,WAAO,MAAM,iDAAiD,KAAK,GAAG,EAAE;AAExE,QAAI,CAAC,KAAK,MAAM;AACf,YAAM,UAAU,iCAAiC,KAAK,KAAK;AAC3D,aAAO,KAAK,OAAO;AACnB,YAAM,MAAM,KAAK,OAAO;AAAA,IACzB;AAGA,UAAM,YAAY,OAAO,SAAS,CAAA,GAAI,KAAK,CAAC,SAAS,KAAK,QAAQ,KAAK,IAAI;AAC3E,UAAM,UAAU,UAAU,YAAY;AAEtC,UAAM,mBAAmB;AAAA,MACxB,KAAK,KAAK,IAAI,SAAA;AAAA,MACd,OAAO,KAAK;AAAA,MACZ,MAAM,KAAK;AAAA,MACX,aAAa,KAAK;AAAA,IAAA;AAMnB,UAAMA,gBAAmF,CAAA;AAEzF,eAAW,OAAO,mBAAmB;AACpC,YAAM,SAAS,kBAAkB,GAAG;AAGpC,UAAI,SAAS;AACZA,sBAAY,OAAO,SAAS,IAAI,EAAE,eAAe,MAAM,eAAe,MAAA;AAAA,MACvE,OAAO;AAON,cAAM,kBAAkB,MAAM,sBAAsB,MAAM,OAAO,QAAQ,OAAO,MAAM,OAAO,WAAW,OAAO,SAAS,CAAA,CAAE;AAC1HA,sBAAY,OAAO,SAAS,IAAI;AAAA,UAC/B,eAAe;AAAA,UACf,eAAe;AAAA,QAAA;AAAA,MAEjB;AAAA,IACD;AAEA,WAAO;AAAA,MACN,MAAM;AAAA,MAAA,aACNA;AAAAA,MACA;AAAA,MAAA,gBACAC;AAAAA,MACA;AAAA,IAAA;AAAA,EAEF,SAAS,KAAK;AACb,QAAI,eAAe,SAAS,YAAY,KAAK;AAE5C,YAAM;AAAA,IACP;AACA,UAAM,UAAU,2BAA2B,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG,CAAC;AAC3F,WAAO,MAAM,OAAO;AACpB,UAAM,MAAM,KAAK,OAAO;AAAA,EACzB;AACD;"}