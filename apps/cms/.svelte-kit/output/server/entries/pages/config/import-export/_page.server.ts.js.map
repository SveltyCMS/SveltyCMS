{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../../src/routes/config/import-export/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/config/import-export/+page.server.ts\n * @description Server-side logic for Import/Export configuration page.\n *\n * #Features:\n * - Redirects unauthenticated users to login.\n * - Verifies user permissions (`config:importexport`) against role config.\n * - Returns safe, whitelisted user data (no sensitive fields).\n * - Uses structured logging for access attempts and errors.\n * - Differentiates between 403 (forbidden) and 500 (system failure).\n */\n\nimport { error, redirect } from '@sveltejs/kit';\nimport type { PageServerLoad } from './$types';\nimport { hasPermissionWithRoles } from '@shared/database/auth/permissions';\n\nimport { logger } from '@shared/utils/logger.server';\n\nexport const load: PageServerLoad = async ({ locals }) => {\n\ttry {\n\t\tconst { user, isAdmin, roles: tenantRoles } = locals;\n\n\t\t// Auth check\n\t\tif (!user) {\n\t\t\tlogger.warn('Unauthenticated access attempt to import/export');\n\t\t\tthrow redirect(302, '/login');\n\t\t}\n\n\t\t// Permission check using cached tenantRoles from locals\n\t\tconst hasPermission = hasPermissionWithRoles(user, 'config:importexport', tenantRoles);\n\n\t\tif (!hasPermission && !isAdmin) {\n\t\t\tlogger.warn(`Permission denied: user=${user._id}, role=${user.role}, missing=config:importexport`);\n\t\t\tthrow error(403, 'Insufficient permissions');\n\t\t}\n\n\t\t// Return safe user object\n\t\treturn {\n\t\t\tuser: {\n\t\t\t\tid: user._id.toString(),\n\t\t\t\tusername: user.username || user.email,\n\t\t\t\temail: user.email,\n\t\t\t\trole: user.role,\n\t\t\t\tisAdmin\n\t\t\t}\n\t\t};\n\t} catch (err) {\n\t\t// Pass through known errors (redirect/403/etc.)\n\t\tif (err instanceof Response || (err instanceof Error && 'status' in err)) {\n\t\t\tthrow err;\n\t\t}\n\n\t\tlogger.error(`System failure in import/export: ${err instanceof Error ? err.stack : String(err)}`);\n\t\tthrow error(500, 'Internal Server Error');\n\t}\n};\n"],"names":[],"mappings":";;;AAkBO,MAAM,OAAuB,OAAO,EAAE,aAAa;AACzD,MAAI;AACH,UAAM,EAAE,MAAM,SAAS,OAAO,gBAAgB;AAG9C,QAAI,CAAC,MAAM;AACV,aAAO,KAAK,iDAAiD;AAC7D,YAAM,SAAS,KAAK,QAAQ;AAAA,IAC7B;AAGA,UAAM,gBAAgB,uBAAuB,MAAM,uBAAuB,WAAW;AAErF,QAAI,CAAC,iBAAiB,CAAC,SAAS;AAC/B,aAAO,KAAK,2BAA2B,KAAK,GAAG,UAAU,KAAK,IAAI,+BAA+B;AACjG,YAAM,MAAM,KAAK,0BAA0B;AAAA,IAC5C;AAGA,WAAO;AAAA,MACN,MAAM;AAAA,QACL,IAAI,KAAK,IAAI,SAAA;AAAA,QACb,UAAU,KAAK,YAAY,KAAK;AAAA,QAChC,OAAO,KAAK;AAAA,QACZ,MAAM,KAAK;AAAA,QACX;AAAA,MAAA;AAAA,IACD;AAAA,EAEF,SAAS,KAAK;AAEb,QAAI,eAAe,YAAa,eAAe,SAAS,YAAY,KAAM;AACzE,YAAM;AAAA,IACP;AAEA,WAAO,MAAM,oCAAoC,eAAe,QAAQ,IAAI,QAAQ,OAAO,GAAG,CAAC,EAAE;AACjG,UAAM,MAAM,KAAK,uBAAuB;AAAA,EACzC;AACD;"}