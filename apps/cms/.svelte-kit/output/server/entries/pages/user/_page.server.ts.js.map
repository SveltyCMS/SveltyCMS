{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../src/routes/user/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/(app)/user/+page.server.ts\n * @description Server-side logic for the user page in the application.\n *\n * This module handles the server-side operations for the user page, including:\n * - Form validation for adding users and changing passwords\n * - Preparing data for client-side rendering\n *\n * Features:\n * - User and role information retrieval from event.locals\n * - Form handling\n * - Error logging and handling\n *\n * Usage:\n * This file is used as the server-side counterpart for the user page in a SvelteKit application.\n * It prepares data and handles form validation for the client-side rendering.\n */\n\nimport type { PageServerLoad } from './$types';\n\n// Auth\nimport { auth } from '@shared/database/db';\nimport type { Role, User } from '@shared/database/auth/types';\nimport type { PermissionConfig } from '@shared/database/auth/permissions';\n\n// System Logger\nimport { getUntypedSetting } from '@shared/services/settingsService';\nimport { logger } from '@shared/utils/logger.server';\n\nexport const load: PageServerLoad = async (event) => {\n\ttry {\n\t\tconst user: User | null = event.locals.user;\n\t\tconst roles: Role[] = event.locals.roles || [];\n\t\tconst isFirstUser: boolean = event.locals.isFirstUser;\n\t\tconst hasManageUsersPermission: boolean = event.locals.hasManageUsersPermission;\n\n\t\t// If user or roles are missing, log details and return fallback response\n\t\tif (!user) {\n\t\t\tlogger.warn('User object missing in event.locals. Returning fallback response.', {\n\t\t\t\trequest: event.request.url\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tuser: null,\n\t\t\t\troles: [],\n\t\t\t\tisFirstUser: false,\n\t\t\t\tis2FAEnabledGlobal: Boolean(getUntypedSetting('USE_2FA')),\n\t\t\t\tmanageUsersPermissionConfig: {\n\t\t\t\t\tcontextId: 'config/userManagement',\n\t\t\t\t\trequiredRole: 'admin',\n\t\t\t\t\taction: 'manage',\n\t\t\t\t\tcontextType: 'system'\n\t\t\t\t},\n\t\t\t\tadminData: null,\n\t\t\t\tpermissions: {\n\t\t\t\t\t'config/adminArea': { hasPermission: false }\n\t\t\t\t},\n\t\t\t\terror: 'User session not found. Please log in again.'\n\t\t\t};\n\t\t}\n\n\t\t// Determine admin status properly by checking role\n\t\tconst userRole = roles.find((role) => role._id === user?.role);\n\t\tconst isAdmin = Boolean(userRole?.isAdmin);\n\n\t\t// Always fetch fresh user data from database to ensure we have the latest changes\n\t\t// This is especially important after profile updates\n\t\tlet freshUser: User | null = null;\n\t\tif (user?._id && auth) {\n\t\t\tfreshUser = await auth.getUserById(user._id.toString());\n\t\t\tif (freshUser) {\n\t\t\t\tlogger.debug('Fresh user data fetched for user page', {\n\t\t\t\t\tuserId: freshUser._id,\n\t\t\t\t\tusername: freshUser.username,\n\t\t\t\t\temail: freshUser.email\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Fallback to session user if database fetch fails\n\t\tif (!freshUser) {\n\t\t\tfreshUser = user;\n\t\t}\n\n\t\t// Prepare user object for return, ensuring _id is a string and including admin status\n\t\tconst safeUser = freshUser\n\t\t\t? {\n\t\t\t\t\t...freshUser,\n\t\t\t\t\t_id: freshUser._id.toString(),\n\t\t\t\t\tpassword: '[REDACTED]', // Ensure password is not sent to client\n\t\t\t\t\tisAdmin // Add the properly calculated admin status\n\t\t\t\t}\n\t\t\t: null;\n\n\t\t// Admin data will now be fetched on-demand via API endpoints\n\t\t// This improves initial page load performance significantly\n\t\tlet adminData = null;\n\n\t\tif (isAdmin || hasManageUsersPermission) {\n\t\t\t// No longer pre-loading allUsers and allTokens here\n\t\t\t// The AdminArea component will fetch this data via API calls\n\t\t\tadminData = {\n\t\t\t\tusers: [], // Empty arrays - data loaded on demand\n\t\t\t\ttokens: []\n\t\t\t};\n\t\t}\n\n\t\t// Provide manageUsersPermissionConfig to the client\n\t\tconst manageUsersPermissionConfig: PermissionConfig = {\n\t\t\tcontextId: 'config/userManagement',\n\t\t\taction: 'manage',\n\t\t\tcontextType: 'system',\n\t\t\tname: 'User Management',\n\t\t\tdescription: 'Manage user accounts and roles'\n\t\t};\n\n\t\t// Return data to the client\n\t\treturn {\n\t\t\tuser: safeUser,\n\t\t\troles: roles.map((role) => ({\n\t\t\t\t...role,\n\t\t\t\t_id: role._id.toString()\n\t\t\t})),\n\t\t\tisFirstUser,\n\t\t\tis2FAEnabledGlobal: Boolean(getUntypedSetting('USE_2FA')),\n\t\t\tmanageUsersPermissionConfig,\n\t\t\tadminData,\n\t\t\tpermissions: {\n\t\t\t\t'config/adminArea': { hasPermission: isAdmin || hasManageUsersPermission }\n\t\t\t},\n\t\t\tisAdmin // Pass isAdmin to client for PermissionGuard\n\t\t};\n\t} catch (err) {\n\t\t// Log error with an error code and more details\n\t\tlogger.error('Error during load function (ErrorCode: USER_LOAD_500):', err);\n\t\treturn {\n\t\t\tuser: null,\n\t\t\troles: [],\n\t\t\tisFirstUser: false,\n\t\t\tis2FAEnabledGlobal: false,\n\t\t\tmanageUsersPermissionConfig: {\n\t\t\t\tcontextId: 'config/userManagement',\n\t\t\t\trequiredRole: 'admin',\n\t\t\t\taction: 'manage',\n\t\t\t\tcontextType: 'system'\n\t\t\t},\n\t\t\tadminData: null,\n\t\t\tpermissions: {\n\t\t\t\t'config/adminArea': { hasPermission: false }\n\t\t\t},\n\t\t\tisAdmin: false,\n\t\t\terror: 'Internal Server Error. Please try again later.'\n\t\t};\n\t}\n};\n"],"names":[],"mappings":";;;AA6BO,MAAM,OAAuB,OAAO,UAAU;AACpD,MAAI;AACH,UAAM,OAAoB,MAAM,OAAO;AACvC,UAAM,QAAgB,MAAM,OAAO,SAAS,CAAA;AAC5C,UAAM,cAAuB,MAAM,OAAO;AAC1C,UAAM,2BAAoC,MAAM,OAAO;AAGvD,QAAI,CAAC,MAAM;AACV,aAAO,KAAK,qEAAqE;AAAA,QAChF,SAAS,MAAM,QAAQ;AAAA,MAAA,CACvB;AACD,aAAO;AAAA,QACN,MAAM;AAAA,QACN,OAAO,CAAA;AAAA,QACP,aAAa;AAAA,QACb,oBAAoB,QAAQ,kBAAkB,SAAS,CAAC;AAAA,QACxD,6BAA6B;AAAA,UAC5B,WAAW;AAAA,UACX,cAAc;AAAA,UACd,QAAQ;AAAA,UACR,aAAa;AAAA,QAAA;AAAA,QAEd,WAAW;AAAA,QACX,aAAa;AAAA,UACZ,oBAAoB,EAAE,eAAe,MAAA;AAAA,QAAM;AAAA,QAE5C,OAAO;AAAA,MAAA;AAAA,IAET;AAGA,UAAM,WAAW,MAAM,KAAK,CAAC,SAAS,KAAK,QAAQ,MAAM,IAAI;AAC7D,UAAM,UAAU,QAAQ,UAAU,OAAO;AAIzC,QAAI,YAAyB;AAC7B,QAAI,MAAM,OAAO,MAAM;AACtB,kBAAY,MAAM,KAAK,YAAY,KAAK,IAAI,UAAU;AACtD,UAAI,WAAW;AACd,eAAO,MAAM,yCAAyC;AAAA,UACrD,QAAQ,UAAU;AAAA,UAClB,UAAU,UAAU;AAAA,UACpB,OAAO,UAAU;AAAA,QAAA,CACjB;AAAA,MACF;AAAA,IACD;AAGA,QAAI,CAAC,WAAW;AACf,kBAAY;AAAA,IACb;AAGA,UAAM,WAAW,YACd;AAAA,MACA,GAAG;AAAA,MACH,KAAK,UAAU,IAAI,SAAA;AAAA,MACnB,UAAU;AAAA;AAAA,MACV;AAAA;AAAA,IAAA,IAEA;AAIH,QAAI,YAAY;AAEhB,QAAI,WAAW,0BAA0B;AAGxC,kBAAY;AAAA,QACX,OAAO,CAAA;AAAA;AAAA,QACP,QAAQ,CAAA;AAAA,MAAC;AAAA,IAEX;AAGA,UAAM,8BAAgD;AAAA,MACrD,WAAW;AAAA,MACX,QAAQ;AAAA,MACR,aAAa;AAAA,MACb,MAAM;AAAA,MACN,aAAa;AAAA,IAAA;AAId,WAAO;AAAA,MACN,MAAM;AAAA,MACN,OAAO,MAAM,IAAI,CAAC,UAAU;AAAA,QAC3B,GAAG;AAAA,QACH,KAAK,KAAK,IAAI,SAAA;AAAA,MAAS,EACtB;AAAA,MACF;AAAA,MACA,oBAAoB,QAAQ,kBAAkB,SAAS,CAAC;AAAA,MACxD;AAAA,MACA;AAAA,MACA,aAAa;AAAA,QACZ,oBAAoB,EAAE,eAAe,WAAW,yBAAA;AAAA,MAAyB;AAAA,MAE1E;AAAA;AAAA,IAAA;AAAA,EAEF,SAAS,KAAK;AAEb,WAAO,MAAM,0DAA0D,GAAG;AAC1E,WAAO;AAAA,MACN,MAAM;AAAA,MACN,OAAO,CAAA;AAAA,MACP,aAAa;AAAA,MACb,oBAAoB;AAAA,MACpB,6BAA6B;AAAA,QAC5B,WAAW;AAAA,QACX,cAAc;AAAA,QACd,QAAQ;AAAA,QACR,aAAa;AAAA,MAAA;AAAA,MAEd,WAAW;AAAA,MACX,aAAa;AAAA,QACZ,oBAAoB,EAAE,eAAe,MAAA;AAAA,MAAM;AAAA,MAE5C,SAAS;AAAA,MACT,OAAO;AAAA,IAAA;AAAA,EAET;AACD;"}