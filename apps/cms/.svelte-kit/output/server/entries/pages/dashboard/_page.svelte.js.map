{"version":3,"file":"_page.svelte.js","sources":["../../../../../../../../shared/stores/src/systemPreferences.svelte.ts","../../../../../../src/routes/dashboard/+page.svelte"],"sourcesContent":["/**\n * @file src/stores/systemPreferences.svelte.ts\n * @description User preferences with server persistence (Svelte 5 runes)\n */\n\nimport type { DashboardWidgetConfig, Layout } from '@cms-types/content';\nimport { logger } from '@shared/utils/logger';\n\nconst LAYOUT_KEY = 'dashboard.layout.default';\n\n// --- API Helpers ---\n\nasync function fetchLayout(): Promise<Layout | null> {\n\ttry {\n\t\tconst res = await fetch(`/api/systemPreferences?key=${LAYOUT_KEY}`);\n\t\tif (res.status === 404) {\n\t\t\tlogger.info('No saved dashboard layout, using default');\n\t\t\treturn null;\n\t\t}\n\t\tif (!res.ok) throw new Error(`Fetch failed: ${res.statusText}`);\n\t\treturn await res.json();\n\t} catch (e) {\n\t\tlogger.error('Failed to fetch preferences:', e);\n\t\tthrow e;\n\t}\n}\n\nasync function saveLayout(layout: Layout): Promise<void> {\n\ttry {\n\t\tconst res = await fetch('/api/systemPreferences', {\n\t\t\tmethod: 'POST',\n\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\tbody: JSON.stringify({ key: LAYOUT_KEY, value: layout })\n\t\t});\n\t\tif (!res.ok) throw new Error(`Save failed: ${res.statusText}`);\n\t} catch (e) {\n\t\tlogger.error('Failed to save preferences:', e);\n\t\tthrow e;\n\t}\n}\n\n// --- Store ---\n\nclass PreferencesStore {\n\tpreferences = $state<DashboardWidgetConfig[]>([]);\n\tloading = $state(true);\n\terror = $state<string | null>(null);\n\n\tasync load() {\n\t\tthis.loading = true;\n\t\tthis.error = null;\n\n\t\ttry {\n\t\t\tconst layout = await fetchLayout();\n\t\t\tthis.preferences = (layout?.preferences || []).map((w) => ({\n\t\t\t\t...w,\n\t\t\t\tsize: w.size?.w && w.size?.h ? w.size : { w: 1, h: 1 }\n\t\t\t}));\n\t\t} catch (e) {\n\t\t\tthis.error = e instanceof Error ? e.message : 'Unknown error';\n\t\t\tthis.preferences = [];\n\t\t} finally {\n\t\t\tthis.loading = false;\n\t\t}\n\t}\n\n\tasync set(preferences: DashboardWidgetConfig[]) {\n\t\tthis.preferences = preferences;\n\t\tawait saveLayout({\n\t\t\tid: 'default',\n\t\t\tname: 'Default',\n\t\t\tpreferences\n\t\t});\n\t}\n\n\tasync updateWidget(widget: DashboardWidgetConfig) {\n\t\tconst prefs = [...this.preferences];\n\t\tconst idx = prefs.findIndex((w) => w.id === widget.id);\n\n\t\tif (idx > -1) prefs[idx] = widget;\n\t\telse prefs.push(widget);\n\n\t\tthis.preferences = prefs;\n\t\tawait saveLayout({ id: 'default', name: 'Default', preferences: prefs });\n\t}\n\n\tasync updateWidgets(widgets: DashboardWidgetConfig[]) {\n\t\tconst ordered = widgets.map((w, i) => ({ ...w, order: i }));\n\t\tthis.preferences = ordered;\n\t\tawait saveLayout({ id: 'default', name: 'Default', preferences: ordered });\n\t}\n\n\tasync removeWidget(id: string) {\n\t\tconst prefs = this.preferences.filter((w) => w.id !== id);\n\t\tthis.preferences = prefs;\n\t\tawait saveLayout({ id: 'default', name: 'Default', preferences: prefs });\n\t}\n\n\t// Compatibility aliases\n\tasync loadPreferences() {\n\t\treturn this.load();\n\t}\n\n\tasync setPreferences(prefs: DashboardWidgetConfig[]) {\n\t\treturn this.set(prefs);\n\t}\n}\n\nexport const preferences = new PreferencesStore();\nexport const systemPreferences = preferences;\n","<!--\n@file src/routes/(app)/dashboard/+page.svelte\n@component\n**Dashboard page providing a user-friendly interface for managing system resources and system messages**\n\n@example\n<Dashboard />\n\n### Props\n- `data` {object} - Object containing user data\n\n### Features\n- Displays widgets for CPU usage, disk usage, memory usage, performance, user activity, and system messages\n- Fully responsive grid with dynamic width and height resizing\n- Drag-and-drop widget reordering\n- Persistent widget configurations via systemPreferences with multiple layouts\n- Layout switching (e.g., default, compact)\n- Accessible widget addition, removal, and layout switching\n- Lazy loading with Intersection Observer for optimal performance\n-->\n<script lang=\"ts\">\n\timport ImportExportManager from '@cms/components/admin/ImportExportManager.svelte';\n\timport PageTitle from '@cms/components/PageTitle.svelte';\n\timport type { DashboardWidgetConfig, DropIndicator, WidgetComponent, WidgetMeta, WidgetSize } from '@cms-types';\n\timport { themeStore } from '@shared/stores/themeStore.svelte';\n\timport { systemPreferences } from '@shared/stores/systemPreferences.svelte';\n\timport { logger } from '@shared/utils/logger';\n\timport { onMount } from 'svelte';\n\timport { flip } from 'svelte/animate';\n\timport type { PageData } from './$types';\n\n\tconst { data }: { data: PageData } = $props();\n\n\t// Define the types for the widget registry\n\tinterface WidgetRegistryEntry {\n\t\tcomponent: WidgetComponent;\n\t\tname: string;\n\t\tdescription: string;\n\t\ticon: string;\n\t\twidgetMeta: WidgetMeta;\n\t}\n\ttype WidgetRegistry = Record<string, WidgetRegistryEntry>;\n\n\tconst MAX_COLUMNS = 4;\n\tconst MAX_ROWS = 4;\n\tconst HEADER_HEIGHT = 48; // Approx height of widget header\n\n\tlet mainContainerEl: HTMLElement | null = $state(null);\n\tlet dropdownOpen = $state(false);\n\tlet searchQuery = $state('');\n\tlet registryLoaded = $state(false);\n\tlet widgetRegistry: WidgetRegistry = $state({});\n\n\t// Lazy loading state for widgets\n\tlet loadedWidgets = $state(new Map());\n\tconst widgetObservers = new Map();\n\n\tlet showImportExport = $state(false);\n\n\tlet dragState: {\n\t\titem: DashboardWidgetConfig | null;\n\t\telement: HTMLElement | null;\n\t\toffset: { x: number; y: number };\n\t\tisActive: boolean;\n\t\tgridPosition?: { row: number; col: number };\n\t} = $state({ item: null, element: null, offset: { x: 0, y: 0 }, isActive: false });\n\tlet dropIndicator: DropIndicator | null = $state(null);\n\tlet gridDropIndicator: { row: number; col: number; width: number; height: number } | null = $state(null);\n\n\tasync function loadWidgetRegistry() {\n\t\tconst modules = import.meta.glob('@cms/dashboard/widgets/*.svelte');\n\t\tconst registry: typeof widgetRegistry = {};\n\t\tfor (const path in modules) {\n\t\t\tconst name = path.split('/').pop()?.replace('.svelte', '');\n\t\t\tif (name) {\n\t\t\t\tconst module = (await modules[path]()) as { default: WidgetComponent; widgetMeta: WidgetMeta };\n\t\t\t\tregistry[name] = {\n\t\t\t\t\tcomponent: module.default,\n\t\t\t\t\tname: module.widgetMeta?.name || name,\n\t\t\t\t\tdescription: module.widgetMeta?.description || '',\n\t\t\t\t\ticon: module.widgetMeta?.icon || 'mdi:widgets',\n\t\t\t\t\twidgetMeta: module.widgetMeta\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\twidgetRegistry = registry;\n\t\tregistryLoaded = true;\n\t}\n\n\t// Lazy load individual widget when it becomes visible\n\tasync function loadWidgetComponent(widgetId: string, componentName: string) {\n\t\t// Skip if already loaded\n\t\tif (loadedWidgets.has(widgetId)) return;\n\n\t\ttry {\n\t\t\t// Dynamically import the widget component\n\t\t\tconst module = await import(`@cms/dashboard/widgets/${componentName}.svelte`);\n\t\t\tloadedWidgets.set(widgetId, module.default);\n\t\t\tloadedWidgets = new Map(loadedWidgets); // Trigger reactivity\n\t\t} catch (error) {\n\t\t\tlogger.error(`Failed to load widget: ${componentName}`, error);\n\t\t\tloadedWidgets.set(widgetId, null); // Mark as failed\n\t\t\tloadedWidgets = new Map(loadedWidgets);\n\t\t}\n\t}\n\n\t// Setup intersection observer for lazy loading (Svelte action)\n\tfunction setupWidgetObserver(element: HTMLElement, params: [string, string]) {\n\t\tconst [widgetId, componentName] = params;\n\n\t\tconst observer = new IntersectionObserver(\n\t\t\t(entries) => {\n\t\t\t\tentries.forEach((entry) => {\n\t\t\t\t\tif (entry.isIntersecting && !loadedWidgets.has(widgetId)) {\n\t\t\t\t\t\tloadWidgetComponent(widgetId, componentName);\n\t\t\t\t\t\tobserver.disconnect();\n\t\t\t\t\t\twidgetObservers.delete(widgetId);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\t{ rootMargin: '100px' } // Start loading 100px before visible\n\t\t);\n\n\t\tobserver.observe(element);\n\t\twidgetObservers.set(widgetId, observer);\n\n\t\treturn {\n\t\t\tdestroy() {\n\t\t\t\tobserver.disconnect();\n\t\t\t\twidgetObservers.delete(widgetId);\n\t\t\t}\n\t\t};\n\t}\n\n\tconst widgetComponentRegistry = $derived(widgetRegistry);\n\tconst currentPreferences = $derived(systemPreferences.preferences || []);\n\tconst availableWidgets = $derived(\n\t\tregistryLoaded && currentPreferences\n\t\t\t? Object.keys(widgetComponentRegistry).filter((name) => !currentPreferences.some((item: DashboardWidgetConfig) => item.component === name))\n\t\t\t: []\n\t);\n\tconst filteredWidgets = $derived(availableWidgets.filter((name) => name.toLowerCase().includes(searchQuery.toLowerCase())));\n\n\tconst currentTheme: 'dark' | 'light' = $derived(themeStore.isDarkMode ? 'dark' : 'light');\n\n\t// Helper function to find insertion position based on coordinates\n\tfunction findInsertionPosition(x: number, y: number): number {\n\t\tconst gridContainer = mainContainerEl?.querySelector('.responsive-dashboard-grid') as HTMLElement;\n\t\tif (!gridContainer) return currentPreferences.length;\n\n\t\t// Get all widget elements and their positions\n\t\tconst widgets = Array.from(gridContainer.querySelectorAll('.widget-container')) as HTMLElement[];\n\t\tconst widgetPositions = widgets.map((el) => {\n\t\t\tconst rect = el.getBoundingClientRect();\n\t\t\tconst gridRect = gridContainer.getBoundingClientRect();\n\t\t\treturn {\n\t\t\t\tid: el.dataset.widgetId,\n\t\t\t\tcenterX: rect.left + rect.width / 2 - gridRect.left,\n\t\t\t\tcenterY: rect.top + rect.height / 2 - gridRect.top,\n\t\t\t\trect\n\t\t\t};\n\t\t});\n\n\t\tconst relativeX = x - gridContainer.getBoundingClientRect().left;\n\t\tconst relativeY = y - gridContainer.getBoundingClientRect().top;\n\n\t\t// Find the closest widget or insertion point\n\t\tlet insertIndex = 0;\n\t\tlet minDistance = Infinity;\n\n\t\tfor (let i = 0; i <= widgetPositions.length; i++) {\n\t\t\tlet targetY, targetX;\n\n\t\t\tif (i === 0) {\n\t\t\t\t// Before first widget\n\t\t\t\ttargetY = widgetPositions[0]?.centerY || 0;\n\t\t\t\ttargetX = widgetPositions[0]?.centerX || 0;\n\t\t\t} else if (i === widgetPositions.length) {\n\t\t\t\t// After last widget\n\t\t\t\tconst lastWidget = widgetPositions[widgetPositions.length - 1];\n\t\t\t\ttargetY = lastWidget?.centerY || relativeY;\n\t\t\t\ttargetX = lastWidget?.centerX || relativeX;\n\t\t\t} else {\n\t\t\t\t// Between widgets\n\t\t\t\tconst prevWidget = widgetPositions[i - 1];\n\t\t\t\tconst nextWidget = widgetPositions[i];\n\t\t\t\ttargetY = (prevWidget.centerY + nextWidget.centerY) / 2;\n\t\t\t\ttargetX = (prevWidget.centerX + nextWidget.centerX) / 2;\n\t\t\t}\n\n\t\t\tconst distance = Math.sqrt(Math.pow(relativeX - targetX, 2) + Math.pow(relativeY - targetY, 2));\n\n\t\t\tif (distance < minDistance) {\n\t\t\t\tminDistance = distance;\n\t\t\t\tinsertIndex = i;\n\t\t\t}\n\t\t}\n\n\t\treturn insertIndex;\n\t}\n\n\t// Ensure all widgets have proper order values\n\tfunction ensureWidgetOrder() {\n\t\tconst widgets = [...currentPreferences];\n\t\tlet needsUpdate = false;\n\n\t\t// Check if any widgets are missing order property\n\t\twidgets.forEach((widget, index) => {\n\t\t\tif (typeof widget.order !== 'number') {\n\t\t\t\twidget.order = index;\n\t\t\t\tneedsUpdate = true;\n\t\t\t}\n\t\t});\n\n\t\t// Sort by existing order and reassign sequential order values\n\t\twidgets.sort((a, b) => (a.order || 0) - (b.order || 0));\n\t\twidgets.forEach((widget, index) => {\n\t\t\tif (widget.order !== index) {\n\t\t\t\twidget.order = index;\n\t\t\t\tneedsUpdate = true;\n\t\t\t}\n\t\t});\n\n\t\t// Update widgets if needed using batch update\n\t\tif (needsUpdate) {\n\t\t\tsystemPreferences.updateWidgets(widgets);\n\t\t}\n\t}\n\n\tfunction addNewWidget(componentName: string) {\n\t\tconst componentInfo = widgetComponentRegistry[componentName];\n\t\tif (!componentInfo) {\n\t\t\tlogger.error(`SveltyCMS: Widget component info for \"${componentName}\" not found in registry.`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst defaultSize = componentInfo.widgetMeta?.defaultSize || { w: 1, h: 1 };\n\n\t\tconst newItem: DashboardWidgetConfig = {\n\t\t\tid: `widget-${Math.random().toString(36).substring(2, 15)}-${Date.now().toString(36)}`,\n\t\t\tcomponent: componentName,\n\t\t\tlabel: componentInfo.name,\n\t\t\ticon: componentInfo.icon,\n\t\t\tsize: defaultSize,\n\t\t\tsettings: componentInfo.widgetMeta?.settings || {},\n\t\t\torder: currentPreferences.length // Use order instead of gridPosition\n\t\t};\n\t\tsystemPreferences.updateWidget(newItem);\n\t\tdropdownOpen = false;\n\t\tsearchQuery = '';\n\t}\n\n\tfunction removeWidget(id: string) {\n\t\tsystemPreferences.removeWidget(id);\n\t\t// Clean up loaded widget and observer\n\t\tloadedWidgets.delete(id);\n\t\tconst observer = widgetObservers.get(id);\n\t\tif (observer) {\n\t\t\tobserver.disconnect();\n\t\t\twidgetObservers.delete(id);\n\t\t}\n\t}\n\n\tfunction resetAllWidgets() {\n\t\tsystemPreferences.setPreferences([]);\n\t\t// Clean up all loaded widgets and observers\n\t\tloadedWidgets.clear();\n\t\twidgetObservers.forEach((observer) => observer.disconnect());\n\t\twidgetObservers.clear();\n\t}\n\n\tfunction resizeWidget(widgetId: string, newSize: WidgetSize) {\n\t\tconst item = currentPreferences.find((i: DashboardWidgetConfig) => i.id === widgetId);\n\t\tif (item) {\n\t\t\tconst updatedSize = {\n\t\t\t\tw: Math.max(1, Math.min(MAX_COLUMNS, newSize.w)),\n\t\t\t\th: Math.max(1, Math.min(MAX_ROWS, newSize.h))\n\t\t\t};\n\t\t\tsystemPreferences.updateWidget({ ...item, size: updatedSize });\n\t\t}\n\t}\n\n\tfunction performDrop(widget: DashboardWidgetConfig, indicator: { targetIndex: number }) {\n\t\tconst currentWidgets = [...currentPreferences];\n\t\tconst currentIndex = currentWidgets.findIndex((w) => w.id === widget.id);\n\n\t\tif (currentIndex === -1) return;\n\n\t\t// Remove from current position\n\t\tconst [movedWidget] = currentWidgets.splice(currentIndex, 1);\n\n\t\t// Insert at new position\n\t\tcurrentWidgets.splice(indicator.targetIndex, 0, movedWidget);\n\n\t\t// Update order property for all widgets and save them as a batch\n\t\tconst updatedWidgets = currentWidgets.map((w, index) => ({\n\t\t\t...w,\n\t\t\torder: index\n\t\t}));\n\n\t\tsystemPreferences.updateWidgets(updatedWidgets);\n\t}\n\tfunction handleDragStart(event: MouseEvent | TouchEvent | PointerEvent, item: DashboardWidgetConfig, element: HTMLElement) {\n\t\t// Ignore clicks on interactive elements and resize handles\n\t\tif ((event.target as HTMLElement).closest('button, a, input, select, [role=button], .resize-handles, [data-direction]')) return;\n\n\t\tconst coords = 'touches' in event ? event.touches[0] : event;\n\t\tconst rect = element.getBoundingClientRect();\n\n\t\tif (coords.clientY - rect.top > HEADER_HEIGHT) return;\n\n\t\tevent.preventDefault();\n\t\tdragState = {\n\t\t\titem,\n\t\t\telement,\n\t\t\toffset: { x: coords.clientX - rect.left, y: coords.clientY - rect.top },\n\t\t\tisActive: true\n\t\t};\n\n\t\telement.style.opacity = '0.5';\n\t\telement.style.zIndex = '1000';\n\t\tconst clone = element.cloneNode(true) as HTMLElement;\n\t\tclone.style.cssText = `position: fixed; left: ${rect.left}px; top: ${rect.top}px; width: ${rect.width}px; height: ${rect.height}px; pointer-events: none; transform: scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.15); margin: 0;`;\n\t\tdocument.body.appendChild(clone);\n\t\tdragState.element = clone;\n\n\t\t// Use pointer events to cover mouse, touch, and pen with a passive move listener\n\t\tdocument.addEventListener('pointermove', handleDragMove as EventListener, { passive: true });\n\t\tdocument.addEventListener('pointerup', handleDragEnd as EventListener, { once: true });\n\t}\n\n\tfunction handleDragMove(event: MouseEvent | TouchEvent | PointerEvent) {\n\t\tif (!dragState.isActive || !dragState.element) return;\n\n\t\tconst coords = 'touches' in event ? event.touches[0] : event;\n\t\tdragState.element.style.left = `${coords.clientX - dragState.offset.x}px`;\n\t\tdragState.element.style.top = `${coords.clientY - dragState.offset.y}px`;\n\n\t\t// Find insertion position based on mouse coordinates\n\t\tconst insertionIndex = findInsertionPosition(coords.clientX, coords.clientY);\n\n\t\t// Show visual feedback for insertion position\n\t\tif (dragState.item) {\n\t\t\tconst currentIndex = currentPreferences.findIndex((p: DashboardWidgetConfig) => p.id === dragState.item?.id);\n\t\t\tif (currentIndex !== -1 && insertionIndex !== currentIndex && insertionIndex !== currentIndex + 1) {\n\t\t\t\tdropIndicator = {\n\t\t\t\t\tshow: true,\n\t\t\t\t\tposition: insertionIndex,\n\t\t\t\t\ttargetIndex: insertionIndex > currentIndex ? insertionIndex - 1 : insertionIndex\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tdropIndicator = null;\n\t\t\t}\n\t\t}\n\n\t\t// Clear grid drop indicator as we're using linear positioning\n\t\tgridDropIndicator = null;\n\t}\n\n\tfunction handleDragEnd() {\n\t\tif (!dragState.isActive) return;\n\n\t\tconst originalElement = mainContainerEl?.querySelector(`[data-widget-id=\"${dragState.item?.id}\"]`) as HTMLElement;\n\t\tif (originalElement) {\n\t\t\toriginalElement.style.opacity = '';\n\t\t\toriginalElement.style.zIndex = '';\n\t\t}\n\n\t\tif (dragState.element) {\n\t\t\tdocument.body.removeChild(dragState.element);\n\t\t}\n\n\t\t// Handle repositioning based on drop indicator\n\t\tif (dropIndicator && dragState.item && dropIndicator.targetIndex !== undefined) {\n\t\t\tperformDrop(dragState.item, { targetIndex: dropIndicator.targetIndex });\n\t\t}\n\n\t\tdragState = { item: null, element: null, offset: { x: 0, y: 0 }, isActive: false };\n\t\tdropIndicator = null;\n\t\tgridDropIndicator = null;\n\n\t\tdocument.removeEventListener('pointermove', handleDragMove as EventListener);\n\t}\n\n\tonMount(() => {\n\t\tloadWidgetRegistry();\n\t\tsystemPreferences.loadPreferences();\n\t\t// Ensure proper widget ordering after preferences load\n\t\tsetTimeout(ensureWidgetOrder, 100);\n\n\t\t// Cleanup observers on unmount\n\t\treturn () => {\n\t\t\twidgetObservers.forEach((observer) => observer.disconnect());\n\t\t\twidgetObservers.clear();\n\t\t};\n\t});\n</script>\n\n<main bind:this={mainContainerEl} class=\"relative overflow-y-auto overflow-x-hidden\" style=\"touch-action: pan-y;\">\n\t<header class=\"mb-2 flex items-center justify-between gap-2 border-b border-surface-200 p-2 dark:text-surface-50\">\n\t\t<PageTitle name=\"Dashboard\" icon=\"bi:bar-chart-line\" showBackButton={true} backUrl=\"/config\" />\n\t\t<div class=\"flex items-center gap-2\">\n\t\t\t<!-- Reset All Button - Small and subtle -->\n\t\t\t{#if currentPreferences.length > 0}\n\t\t\t\t<button class=\"preset-outlined-surface-500 btn-icon\" onclick={resetAllWidgets} aria-label=\"Reset all widgets\" title=\"Reset all widgets\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:refresh\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t{/if}\n\t\t\t<!-- Add Widget Button -->\n\t\t\t<div class=\"relative\">\n\t\t\t\t{#if availableWidgets.length > 0}\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"preset-filled-tertiary-500 btn dark:preset-filled-primary-500\"\n\t\t\t\t\t\tonclick={() => (dropdownOpen = !dropdownOpen)}\n\t\t\t\t\t\taria-haspopup=\"true\"\n\t\t\t\t\t\taria-expanded={dropdownOpen}\n\t\t\t\t\t\taria-label=\"Add Widget\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:plus\" class=\"mr-2\"></iconify-icon>\n\t\t\t\t\t\tAdd Widget\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t\t{#if dropdownOpen}\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass=\"widget-dropdown absolute right-0 z-30 mt-2 w-72 rounded border bg-white shadow-2xl dark:border-gray-700 dark:bg-surface-900\"\n\t\t\t\t\t\trole=\"menu\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class=\"p-2\">\n\t\t\t\t\t\t\t<input type=\"text\" class=\"input w-full\" placeholder=\"Search widgets...\" bind:value={searchQuery} />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"max-h-64 overflow-y-auto py-1\">\n\t\t\t\t\t\t\t{#each filteredWidgets as widgetName (widgetName)}\n\t\t\t\t\t\t\t\t{@const widgetInfo = widgetComponentRegistry[widgetName]}\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tclass=\"flex w-full items-center gap-2 px-4 py-2 text-left transition-colors hover:bg-primary-100 dark:hover:bg-primary-900/30\"\n\t\t\t\t\t\t\t\t\tonclick={() => addNewWidget(widgetName)}\n\t\t\t\t\t\t\t\t\ttitle={widgetInfo?.description}\n\t\t\t\t\t\t\t\t\trole=\"menuitem\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<iconify-icon icon={widgetInfo?.icon || 'mdi:widgets'} class=\"text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t<div class=\"flex flex-col\">\n\t\t\t\t\t\t\t\t\t\t<span>{widgetInfo?.name || widgetName}</span>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t<div class=\"px-4 py-2 text-sm text-gray-500\">No widgets found.</div>\n\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t{/if}\n\t\t\t</div>\n\t\t</div>\n\t</header>\n\n\t<div class=\"relative m-0 w-full p-0\">\n\t\t<section class=\"w-full px-1 py-4\">\n\t\t\t{#if currentPreferences.length > 0}\n\t\t\t\t<div class=\"responsive-dashboard-grid\" role=\"grid\">\n\t\t\t\t\t<!-- Grid drop indicator -->\n\t\t\t\t\t{#if gridDropIndicator}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass=\"pointer-events-none absolute z-30 rounded-lg border-2 border-dashed border-primary-500 bg-primary-500/20\"\n\t\t\t\t\t\t\tstyle:grid-column=\"span {gridDropIndicator.width}\"\n\t\t\t\t\t\t\tstyle:grid-row=\"span {gridDropIndicator.height}\"\n\t\t\t\t\t\t\tstyle:grid-column-start={gridDropIndicator.col + 1}\n\t\t\t\t\t\t\tstyle:grid-row-start={gridDropIndicator.row + 1}\n\t\t\t\t\t\t></div>\n\t\t\t\t\t{/if}\n\n\t\t\t\t\t{#each currentPreferences.sort((a: DashboardWidgetConfig, b: DashboardWidgetConfig) => (a.order || 0) - (b.order || 0)) as item (item.id)}\n\t\t\t\t\t\t{@const WidgetComponent = loadedWidgets.get(item.id)}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\tclass=\"widget-container group relative select-none overflow-hidden rounded-lg border border-surface-200/80 bg-surface-50 shadow-sm transition-all duration-300 dark:text-surface-50 dark:bg-surface-800\"\n\t\t\t\t\t\t\tdata-widget-id={item.id}\n\t\t\t\t\t\t\tstyle:grid-column=\"span {item.size.w}\"\n\t\t\t\t\t\t\tstyle:grid-row=\"span {item.size.h}\"\n\t\t\t\t\t\t\tstyle:touch-action=\"manipulation\"\n\t\t\t\t\t\t\tstyle:min-height=\"{item.size.h * 180}px\"\n\t\t\t\t\t\t\tanimate:flip={{ duration: 300 }}\n\t\t\t\t\t\t\tonpointerdown={(event) => handleDragStart(event, item, event.currentTarget)}\n\t\t\t\t\t\t\tuse:setupWidgetObserver={[item.id, item.component]}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{#if !WidgetComponent}\n\t\t\t\t\t\t\t\t<!-- Loading skeleton -->\n\t\t\t\t\t\t\t\t<div class=\"widget-skeleton h-full animate-pulse\">\n\t\t\t\t\t\t\t\t\t<div class=\"mb-2 h-12 rounded-t bg-surface-300 dark:bg-surface-700\"></div>\n\t\t\t\t\t\t\t\t\t<div class=\"h-full rounded-b bg-surface-200 p-4 dark:bg-surface-800\">\n\t\t\t\t\t\t\t\t\t\t<div class=\"mb-3 h-8 rounded bg-surface-300 dark:bg-surface-700\"></div>\n\t\t\t\t\t\t\t\t\t\t<div class=\"mb-2 h-6 w-3/4 rounded bg-surface-300 dark:bg-surface-700\"></div>\n\t\t\t\t\t\t\t\t\t\t<div class=\"mb-2 h-6 w-1/2 rounded bg-surface-300 dark:bg-surface-700\"></div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{:else if WidgetComponent === null}\n\t\t\t\t\t\t\t\t<!-- Error state -->\n\t\t\t\t\t\t\t\t<div class=\"card preset-ghost-error-500 flex h-full flex-col items-center justify-center p-4\">\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:alert-circle-outline\" width=\"48\" class=\"mb-2 text-error-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t<h3 class=\"h4 mb-2\">Widget Load Error</h3>\n\t\t\t\t\t\t\t\t\t<p class=\"text-sm\">Failed to load: {item.component}</p>\n\t\t\t\t\t\t\t\t\t<button class=\"preset-filled-error-500 btn-sm mt-4\" onclick={() => removeWidget(item.id)}> Remove Widget </button>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t<!-- Render the actual widget - Svelte 5 dynamic components -->\n\t\t\t\t\t\t\t\t<WidgetComponent\n\t\t\t\t\t\t\t\t\tconfig={item}\n\t\t\t\t\t\t\t\t\tonRemove={() => removeWidget(item.id)}\n\t\t\t\t\t\t\t\t\tonSizeChange={(newSize: WidgetSize) => resizeWidget(item.id, newSize)}\n\t\t\t\t\t\t\t\t\ttheme={currentTheme}\n\t\t\t\t\t\t\t\t\tcurrentUser={data.pageData?.user}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t{#if dropIndicator}\n\t\t\t\t\t\t\t\t{@const currentIndex = currentPreferences.findIndex((p: DashboardWidgetConfig) => p.id === item.id)}\n\t\t\t\t\t\t\t\t{@const isDropTarget = dropIndicator.targetIndex === currentIndex}\n\t\t\t\t\t\t\t\t{#if isDropTarget}\n\t\t\t\t\t\t\t\t\t<div class=\"pointer-events-none absolute inset-x-0 top-0 z-20 h-1 bg-primary-500\" style:transform=\"translateY(-50%)\"></div>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/each}\n\t\t\t\t</div>\n\t\t\t{:else}\n\t\t\t\t<div class=\"mx-auto flex h-[60vh] w-full flex-col items-center justify-center text-center\">\n\t\t\t\t\t<div class=\"flex flex-col items-center px-10 py-12\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:view-dashboard-outline\" width=\"80\" class=\"mb-6 text-tertiary-500 drop-shadow-lg dark:text-primary-500\"\n\t\t\t\t\t\t></iconify-icon>\n\t\t\t\t\t\t<p class=\"mb-2 text-2xl font-bold text-tertiary-500 dark:text-primary-500\">Your Dashboard is Empty</p>\n\t\t\t\t\t\t<p class=\"mb-6 text-base text-surface-600 dark:text-surface-300\">Click below to add your first widget and get started.</p>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclass=\"btn rounded-full bg-tertiary-500 px-6 py-3 text-lg font-semibold text-white shadow-lg dark:bg-primary-500\"\n\t\t\t\t\t\t\tonclick={() => (dropdownOpen = true)}\n\t\t\t\t\t\t\taria-label=\"Add first widget\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:plus\" width=\"22\" class=\"mr-2\"></iconify-icon>\n\t\t\t\t\t\t\tAdd Widget\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t{/if}\n\t\t</section>\n\t</div>\n</main>\n\n<!-- Import/Export Modal -->\n{#if showImportExport}\n\t<div class=\"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4\">\n\t\t<div class=\"max-h-[90vh] w-full max-w-6xl overflow-hidden rounded-lg bg-surface-50 shadow-xl dark:bg-surface-800\">\n\t\t\t<div class=\"flex items-center justify-between border-b p-6\">\n\t\t\t\t<h3 class=\"text-xl font-semibold\">Data Import & Export</h3>\n\t\t\t\t<button onclick={() => (showImportExport = false)} class=\"preset-ghost btn-sm\" aria-label=\"Close import/export modal\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" class=\"h-5 w-5\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t<div class=\"max-h-[calc(90vh-140px)] overflow-y-auto p-6\">\n\t\t\t\t<ImportExportManager />\n\t\t\t</div>\n\n\t\t\t<div class=\"flex items-center justify-between border-t bg-surface-100 p-6 dark:bg-surface-700\">\n\t\t\t\t<div class=\"text-sm text-gray-600 dark:text-gray-400\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:shield-check\" class=\"mr-1 inline h-4 w-4\"></iconify-icon>\n\t\t\t\t\tYour data is securely managed and never leaves your server\n\t\t\t\t</div>\n\t\t\t\t<div class=\"flex space-x-2\">\n\t\t\t\t\t<button onclick={() => (showImportExport = false)} class=\"preset-filled-primary-500 btn\"> Done </button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n{/if}\n\n<style>\n\t.responsive-dashboard-grid {\n\t\tdisplay: grid;\n\t\tgap: 1rem;\n\t\tgrid-template-columns: repeat(4, 1fr);\n\t\tgrid-auto-rows: 180px;\n\t\tgrid-auto-flow: row dense;\n\t\tposition: relative;\n\t}\n</style>\n"],"names":["preferences","$.ensure_array_like","$$renderer","$.attr","$.attr_style","$.stringify","$.escape"],"mappings":"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"}