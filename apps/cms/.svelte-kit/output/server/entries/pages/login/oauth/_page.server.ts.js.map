{"version":3,"file":"_page.server.ts.js","sources":["../../../../../../../src/routes/login/oauth/+page.server.ts"],"sourcesContent":["/**\n * @file src/routes/login/oauth/+page.server.ts\n * @description Server-side logic for the OAuth page.\n */\n\nimport { error, redirect, type Cookies } from '@sveltejs/kit';\nimport type { Actions, PageServerLoad } from './$types';\nimport type { ISODateString } from '@cms-types';\n\n// Auth\nimport { google } from 'googleapis';\n\n//Db\nimport { auth, dbInitPromise } from '@shared/database/db';\n\n// Cache invalidation\nimport { invalidateUserCountCache } from '@cms/hooks/handleAuthorization';\n\n// Utils\nimport { contentManager } from '@content/ContentManager';\nimport { saveAvatarImage } from '@shared/utils/media/mediaStorage.server';\n\n// Stores\nimport { getPrivateSettingSync } from '@shared/services/settingsService';\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\nimport type { Locale } from '@shared/paraglide/runtime';\nimport { app } from '@shared/stores/store.svelte';\n\n// System Logger\nimport { generateGoogleAuthUrl, getOAuthRedirectUri } from '@shared/database/auth/googleAuth';\nimport { logger } from '@shared/utils/logger.server';\n\n// Types\ninterface GoogleUserInfo {\n\temail?: string | null;\n\tname?: string | null;\n\tgiven_name?: string | null;\n\tfamily_name?: string | null;\n\tpicture?: string | null;\n\tlocale?: string | null;\n}\n\n// Send welcome email\nasync function sendWelcomeEmail(\n\tfetchFn: (input: RequestInfo | URL, init?: RequestInit) => Promise<Response>,\n\temail: string,\n\tusername: string,\n\trequest: Request\n) {\n\ttry {\n\t\tconst userLanguage = app.systemLanguage || 'en';\n\t\tconst hostProd = publicEnv.HOST_PROD;\n\t\tconst siteName = publicEnv.SITE_NAME;\n\t\tconst emailProps = {\n\t\t\tusername,\n\t\t\temail,\n\t\t\thostLink: hostProd || `https://${request.headers.get('host')}`,\n\t\t\tsitename: siteName || 'SveltyCMS'\n\t\t};\n\n\t\tawait fetchFn('/api/sendMail', {\n\t\t\tmethod: 'POST',\n\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\tbody: JSON.stringify({\n\t\t\t\trecipientEmail: email,\n\t\t\t\tsubject: `Welcome to ${emailProps.sitename}`,\n\t\t\t\ttemplateName: 'welcomeUser',\n\t\t\t\tprops: emailProps,\n\t\t\t\tlanguageTag: userLanguage\n\t\t\t})\n\t\t});\n\t\tlogger.debug('Welcome email sent', { email: email });\n\t} catch (err) {\n\t\tlogger.error('Error sending welcome email:', err as Error);\n\t}\n}\n\n// Helper function to fetch and save Google avatar\nasync function fetchAndSaveGoogleAvatar(avatarUrl: string, userEmail: string): Promise<string | null> {\n\ttry {\n\t\tlogger.debug(`Fetching Google avatar from: ${avatarUrl}`);\n\n\t\t// Ensure database is fully initialized before saving avatar\n\t\tawait dbInitPromise;\n\n\t\tconst response = await fetch(avatarUrl);\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(`Failed to fetch avatar: ${response.statusText}`);\n\t\t}\n\t\tconst blob = await response.blob();\n\n\t\t// Determine the correct file type from the response\n\t\tconst contentType = response.headers.get('content-type') || 'image/jpeg';\n\t\tlet fileName = 'google-avatar.jpg';\n\t\tlet mimeType = 'image/jpeg';\n\n\t\tif (contentType.includes('image/png')) {\n\t\t\tfileName = 'google-avatar.png';\n\t\t\tmimeType = 'image/png';\n\t\t} else if (contentType.includes('image/webp')) {\n\t\t\tfileName = 'google-avatar.webp';\n\t\t\tmimeType = 'image/webp';\n\t\t} else if (contentType.includes('image/gif')) {\n\t\t\tfileName = 'google-avatar.gif';\n\t\t\tmimeType = 'image/gif';\n\t\t}\n\n\t\tconst avatarFile = new File([blob], fileName, { type: mimeType });\n\n\t\tlogger.debug(`Created avatar file: ${fileName}, size: ${avatarFile.size} bytes, type: ${mimeType}`);\n\n\t\tconst savedUrl = await saveAvatarImage(avatarFile, userEmail);\n\n\t\tif (!savedUrl) {\n\t\t\tthrow new Error('Failed to save avatar image');\n\t\t}\n\n\t\tlogger.debug(`Avatar saved successfully at: ${savedUrl}`);\n\t\treturn savedUrl;\n\t} catch (err) {\n\t\tlogger.error('Error fetching and saving Google avatar:', {\n\t\t\terror: err instanceof Error ? err.message : 'Unknown error',\n\t\t\tstack: err instanceof Error ? err.stack : undefined,\n\t\t\tavatarUrl\n\t\t});\n\t\treturn null;\n\t}\n}\n\n// Handle Google OAuth user data\nasync function handleGoogleUser(\n\tgoogleUser: GoogleUserInfo,\n\tisFirst: boolean,\n\ttoken: string | null,\n\trefreshToken: string | null,\n\tcookies: Cookies,\n\tfetchFn: typeof fetch,\n\trequest: Request\n): Promise<void> {\n\tconst email = googleUser.email;\n\tif (!email) {\n\t\tthrow new Error('Google did not return an email address');\n\t}\n\n\tif (googleUser.locale) {\n\t\tconst supportedLocales = (publicEnv.LOCALES || [publicEnv.BASE_LOCALE || 'en']) as Locale[];\n\t\tconst locale = googleUser.locale as Locale;\n\t\tif (supportedLocales.includes(locale)) {\n\t\t\tapp.systemLanguage = locale;\n\t\t}\n\t}\n\n\tif (!auth) {\n\t\tlogger.error('Auth adatper not initialized cannot login using oauth');\n\t}\n\n\t// Check if user exists\n\tlet user = await auth?.checkUser({ email });\n\n\tlogger.debug('OAuth user lookup for email', { email: email });\n\tlogger.debug(`User found: ${user ? 'YES' : 'NO'}`);\n\tif (user) {\n\t\tlogger.debug(`Existing user ID: ${user._id}, username: ${user.username}`);\n\t}\n\n\tif (!user) {\n\t\t// Handle new user creation with invite token validation\n\t\tif (!isFirst) {\n\t\t\t// For non-first users, validate the invite token\n\t\t\tif (!token) throw new Error('A valid invitation is required to create an account via OAuth');\n\t\t\tconst tokenValidation = await auth?.validateRegistrationToken(token);\n\t\t\tif (!tokenValidation?.isValid || !tokenValidation?.details) throw new Error('This invitation is invalid, expired, or has already been used');\n\t\t\t// Check that the OAuth email matches the invited email\n\t\t\tif (email.toLowerCase() !== tokenValidation.details.email.toLowerCase())\n\t\t\t\tthrow new Error('The Google account email does not match the invitation email');\n\t\t\t// Use the role from the token for invited users\n\t\t\tconst inviteRole = tokenValidation.details.role;\n\t\t\tlet avatarUrl: string | null = null;\n\t\t\tif (googleUser.picture) avatarUrl = await fetchAndSaveGoogleAvatar(googleUser.picture, email);\n\n\t\t\t// Create the invited user with the role from the token\n\t\t\tconst userData = {\n\t\t\t\temail,\n\t\t\t\tusername: googleUser.name ?? '',\n\t\t\t\tfirstName: googleUser.given_name ?? undefined,\n\t\t\t\tlastName: googleUser.family_name ?? undefined,\n\t\t\t\tavatar: avatarUrl ?? undefined,\n\t\t\t\trole: inviteRole,\n\t\t\t\tlastAuthMethod: 'google',\n\t\t\t\tisRegistered: true,\n\t\t\t\tblocked: false,\n\t\t\t\tgoogleRefreshToken: refreshToken ?? undefined\n\t\t\t};\n\n\t\t\tlogger.debug('Creating invited user with data:', { ...userData, email: userData.email.replace(/(.{2}).*@(.*)/, '$1****@$2') });\n\t\t\tuser = await auth?.createUser(userData, true);\n\t\t\t// Invalidate user count cache after user creation\n\t\t\tinvalidateUserCountCache();\n\n\t\t\t// Consume the invite token after successful user creation\n\t\t\tawait auth?.consumeRegistrationToken(token);\n\t\t\tlogger.info(`Invited user ${user?.username} created successfully via OAuth and token consumed`);\n\n\t\t\t// Send welcome email for invited users\n\t\t\tawait sendWelcomeEmail(fetchFn, email, googleUser.name || '', request);\n\t\t} else {\n\t\t\t// Handle first user (admin) creation - no token required\n\t\t\tlet avatarUrl: string | null = null;\n\t\t\tif (googleUser.picture) avatarUrl = await fetchAndSaveGoogleAvatar(googleUser.picture, email);\n\t\t\t// Create the first user (admin)\n\n\t\t\t// Get admin role from roles list\n\t\t\tconst roles = await auth?.getAllRoles();\n\t\t\tconst adminRole = roles?.find((r) => r.isAdmin);\n\t\t\tif (!adminRole) throw new Error('Admin role not found in roles configuration');\n\n\t\t\tconst userData = {\n\t\t\t\temail,\n\t\t\t\tusername: googleUser.name ?? '',\n\t\t\t\tfirstName: googleUser.given_name ?? undefined,\n\t\t\t\tlastName: googleUser.family_name ?? undefined,\n\t\t\t\tavatar: avatarUrl ?? undefined,\n\t\t\t\trole: adminRole._id,\n\t\t\t\tlastAuthMethod: 'google',\n\t\t\t\tisRegistered: true,\n\t\t\t\tblocked: false,\n\t\t\t\tgoogleRefreshToken: refreshToken ?? undefined\n\t\t\t};\n\n\t\t\tlogger.debug('Creating first user (admin) with data:', { ...userData, email: userData.email.replace(/(.{2}).*@(.*)/, '$1****@$2') });\n\t\t\tuser = await auth?.createUser(userData, true); // Invalidate user count cache after first user (admin) creation\n\t\t\tinvalidateUserCountCache();\n\n\t\t\t// Send welcome email for new admin\n\t\t\tawait sendWelcomeEmail(fetchFn, email, googleUser.name || '', request);\n\t\t}\n\t} else {\n\t\t// Existing user - no token required for sign-in\n\t\tlogger.debug(`Existing user signing in: ${user._id}, current avatar: ${user.avatar ? 'YES' : 'NO'}`);\n\n\t\t// Always try to update avatar from Google if available and user doesn't have one\n\t\tlet avatarUrl: string | null = null;\n\t\tif (googleUser.picture && (!user.avatar || user.avatar === null || user.avatar === undefined)) {\n\t\t\tavatarUrl = await fetchAndSaveGoogleAvatar(googleUser.picture, email);\n\t\t}\n\n\t\t// Always update user attributes (even if avatar is null, to ensure other fields are updated)\n\t\tconst updateData: Record<string, unknown> = {\n\t\t\temail,\n\t\t\tlastAuthMethod: 'google',\n\t\t\tfirstName: googleUser.given_name ?? user.firstName ?? '',\n\t\t\tlastName: googleUser.family_name ?? user.lastName ?? ''\n\t\t};\n\n\t\tif (avatarUrl) updateData.avatar = avatarUrl;\n\n\t\t//Store refresh token for existing user if we receive a new one.\n\t\tif (refreshToken) {\n\t\t\tupdateData.googleRefreshToken = refreshToken;\n\t\t}\n\n\t\tlogger.debug('Updating user attributes:', updateData);\n\t\tif (!auth) throw new Error('Auth system not initialized');\n\t\tawait auth.updateUserAttributes(user._id.toString(), updateData);\n\t\tlogger.debug(`Updated user attributes for: ${user._id}`);\n\t}\n\n\tif (!user?._id) throw new Error('User ID is missing after creation or retrieval');\n\t// Create User Session and set cookie\n\tif (!auth) throw new Error('Auth system not initialized');\n\tconst expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n\tconst session = await auth.createSession({ user_id: user._id, expires: expiresAt.toISOString() as ISODateString });\n\tconst sessionCookie = auth.createSessionCookie(session._id);\n\tconst cookieAttributes = sessionCookie.attributes as Record<string, unknown>;\n\tcookies.set(sessionCookie.name, sessionCookie.value, { ...cookieAttributes, path: '/' });\n}\n\nexport const load: PageServerLoad = async ({ url, cookies, fetch, request }) => {\n\ttry {\n\t\tawait dbInitPromise;\n\t\tlogger.debug('System ready in OAuth load function');\n\t\tif (!auth) throw error(500, 'Internal Server Error: Authentication system is not initialized');\n\n\t\tlogger.debug('OAuth Callback called:');\n\t\tconst firstUserExists = (await auth.getUserCount()) !== 0;\n\t\tlogger.debug(`First user exists: ${firstUserExists}`);\n\n\t\tconst code = url.searchParams.get('code');\n\t\tconst state = url.searchParams.get('state');\n\t\tconst error_param = url.searchParams.get('error');\n\t\tconst error_subtype = url.searchParams.get('error_subtype');\n\t\tconst token = state ? decodeURIComponent(state) : null;\n\n\t\tlogger.debug(`Authorization code from URL: ${code}`);\n\t\tlogger.debug(`Registration token from state: ${token}`);\n\t\tlogger.debug(`Is First User: ${!firstUserExists}`);\n\n\t\t// Handle OAuth errors first\n\t\tif (error_param) {\n\t\t\tlogger.error(`OAuth Error: ${error_param}`, { error_subtype, url: url.toString() });\n\t\t\tif (error_param === 'interaction_required' || error_param === 'access_denied') {\n\t\t\t\tconst authUrl = await generateGoogleAuthUrl(token, 'consent');\n\t\t\t\tredirect(302, authUrl);\n\t\t\t} else {\n\t\t\t\tthrow error(400, `OAuth Authentication Failed: ${error_param}: ${error_subtype || 'Unknown error'}`);\n\t\t\t}\n\t\t}\n\n\t\t// If no code is present, handle initial OAuth flow\n\t\tif (!code) {\n\t\t\t// For first user (no existing users), redirect directly to OAuth\n\t\t\tif (!firstUserExists) {\n\t\t\t\tconst authUrl = await generateGoogleAuthUrl(token, 'consent');\n\t\t\t\tredirect(302, authUrl);\n\t\t\t}\n\n\t\t\t// For non-first users without a token, show token input form\n\t\t\tif (firstUserExists && !token) {\n\t\t\t\treturn { isFirstUser: !firstUserExists, requiresToken: true };\n\t\t\t}\n\n\t\t\t// For non-first users with a token, redirect to OAuth with the token\n\t\t\tif (firstUserExists && token) {\n\t\t\t\tconst authUrl = await generateGoogleAuthUrl(token, 'consent');\n\t\t\t\tredirect(302, authUrl);\n\t\t\t}\n\t\t}\n\n\t\t// Process OAuth callback\n\t\ttry {\n\t\t\tif (!code) throw error(400, 'Authorization code missing');\n\t\t\tlogger.debug(`Processing OAuth callback with code: ${code.substring(0, 20)}...`);\n\n\t\t\t// Create a fresh OAuth client instance specifically for token exchange\n\t\t\t// Use the same environment detection logic as the OAuth URL generation\n\t\t\tconst redirectUri = getOAuthRedirectUri();\n\t\t\tconst googleAuthClient = new google.auth.OAuth2(\n\t\t\t\tgetPrivateSettingSync('GOOGLE_CLIENT_ID'),\n\t\t\t\tgetPrivateSettingSync('GOOGLE_CLIENT_SECRET'),\n\t\t\t\tredirectUri\n\t\t\t);\n\t\t\tconst { tokens } = await googleAuthClient.getToken(code);\n\t\t\tif (!tokens || !tokens.access_token) throw error(500, 'Failed to authenticate with Google');\n\n\t\t\tlogger.debug('Successfully obtained tokens from Google');\n\t\t\tgoogleAuthClient.setCredentials(tokens);\n\t\t\t// Fetch Google user profile\n\t\t\tconst oauth2 = google.oauth2({ auth: googleAuthClient, version: 'v2' });\n\t\t\tconst { data: googleUser } = await oauth2.userinfo.get();\n\t\t\tif (!googleUser) throw error(500, 'Could not retrieve user information');\n\n\t\t\t// Pass the refresh token from the `tokens` object to the handler function.\n\t\t\tawait handleGoogleUser(googleUser as GoogleUserInfo, !firstUserExists, token, tokens.refresh_token || null, cookies, fetch, request);\n\n\t\t\tlogger.info('Successfully processed OAuth callback and created session');\n\n\t\t\t// Redirect to the first available collection\n\t\t\tconst defaultLanguage = publicEnv.DEFAULT_CONTENT_LANGUAGE || 'en';\n\t\t\tconst userLanguage = url.searchParams.get('lang') || defaultLanguage;\n\t\t\tconst redirectUrl = await contentManager.getFirstCollectionRedirectUrl(userLanguage);\n\n\t\t\tlogger.debug(`Redirecting to: ${redirectUrl || '/'}`);\n\t\t\tthrow redirect(302, redirectUrl || '/');\n\t\t} catch (err) {\n\t\t\tif (err && typeof err === 'object' && 'status' in err && (err.status === 302 || err.status === 303)) {\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t\tconst errorMessage = err instanceof Error ? err.message : 'Unknown error during OAuth callback';\n\t\t\tlogger.error('OAuth callback processing error:', { error: err, stack: err instanceof Error ? err.stack : undefined, code, token });\n\t\t\t// Provide more specific error messages based on the error type\n\t\t\tif (errorMessage.includes('A valid invitation is required')) {\n\t\t\t\tthrow error(403, 'Admin Invitation Required: This CMS requires an invitation from an administrator to create any new account.');\n\t\t\t}\n\t\t\tif (errorMessage.includes('invitation is invalid, expired, or has already been used')) {\n\t\t\t\tthrow error(403, 'Invalid or Expired Invitation: Your invitation token is invalid, expired, or has already been used.');\n\t\t\t}\n\t\t\tif (errorMessage.includes('Google account email does not match the invitation email')) {\n\t\t\t\tthrow error(403, 'Google Account Email Mismatch: The Google account email does not match the invitation email address.');\n\t\t\t}\n\t\t\t// Provide more detailed error information\n\t\t\tthrow error(500, `OAuth Processing Failed: ${errorMessage}`);\n\t\t}\n\t} catch (err) {\n\t\t// Check if this is a redirect (which is expected and successful)\n\t\tif (err && typeof err === 'object' && 'status' in err && (err.status === 302 || err.status === 303)) {\n\t\t\tlogger.info('OAuth flow completed successfully, performing redirect');\n\t\t\tthrow err; // Re-throw the redirect\n\t\t}\n\n\t\t// Check if this is already a properly formatted error from inner catch blocks\n\t\tif (err && typeof err === 'object' && 'status' in err && 'body' in err) {\n\t\t\tlogger.debug('Re-throwing formatted error from inner handler');\n\t\t\tthrow err;\n\t\t}\n\t\tconst errorMessage = err instanceof Error ? err.message : 'Unknown error during OAuth process';\n\t\tlogger.error('Comprehensive OAuth Error:', { message: errorMessage, stack: err instanceof Error ? err.stack : 'No stack trace', fullError: err });\n\t\t// Provide more detailed error information for the user\n\t\tthrow error(500, `OAuth Authentication Failed: ${errorMessage}`);\n\t}\n\n\tthrow error(500, 'OAuth Authentication Failed: Unexpected end of OAuth flow');\n};\n\nexport const actions: Actions = {\n\tOAuth: async ({ request }) => {\n\t\tconst data = await request.formData();\n\t\tconst token = data.get('token');\n\t\ttry {\n\t\t\t// Generate OAuth URL with token in state parameter\n\t\t\tconst authUrl = await generateGoogleAuthUrl(token?.toString() || null);\n\t\t\tthrow redirect(302, authUrl);\n\t\t} catch (err) {\n\t\t\tif (err instanceof Error) {\n\t\t\t\tconst errorMessage = err.message || 'Failed to initialize OAuth';\n\t\t\t\tlogger.error('Error during OAuth initialization:', errorMessage);\n\t\t\t\tthrow error(500, { message: errorMessage });\n\t\t\t}\n\t\t\tthrow err;\n\t\t}\n\t}\n};\n"],"names":["fetch"],"mappings":"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"}