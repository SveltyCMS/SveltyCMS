{"version":3,"file":"_page.svelte.js","sources":["../../../../../../../../shared/components/src/Breadcrumb.svelte","../../../../../../../../shared/components/src/media/tagEditor/TagEditorModal.svelte","../../../../../../../../shared/features/src/mediagallery/components/MediaGrid.svelte","../../../../../../../../shared/features/src/mediagallery/components/MediaTable.svelte","../../../../../../../../shared/features/src/mediagallery/components/VirtualMediaGrid.svelte","../../../../../../../../shared/features/src/image-editor/widgets/transformerConfig.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/transformer.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/events.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Blur/regions.ts","../../../../../../../../shared/features/src/image-editor/widgets/Blur/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Blur/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Crop/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Crop/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/FocalPoint/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/FocalPoint/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Rotate/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Rotate/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Rotate/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Watermark/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Watermark/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/registry.ts","../../../../../../../../shared/features/src/image-editor/EditorSidebar.svelte","../../../../../../../../shared/features/src/image-editor/EditorCanvas.svelte","../../../../../../../../shared/features/src/image-editor/Editor.svelte","../../../../../../../../shared/features/src/image-editor/EditorToolbar.svelte","../../../../../../../../shared/features/src/image-editor/ImageEditorModal.svelte","../../../../../../src/routes/mediagallery/+page.svelte"],"sourcesContent":["<!--\n@file src/components/Breadcrumb.svelte\n@component \n**Enhanced Breadcrumb - Svelte 5 Optimized**\n\nAccessible breadcrumb navigation with icons, keyboard support, and visual feedback.\n\n@example\n<Breadcrumb {breadcrumb} {openFolder} {folders} />\n\n### Props\n- `breadcrumb` (string[]): Array of breadcrumb labels\n- `openFolder` (function): Callback to open folder by ID\n- `folders` (Folder[]): Array of folder objects\n\n### Features\n- Full keyboard navigation\n- ARIA-compliant accessibility\n- Visual current page indicator\n- Home and folder icons\n- Truncation for long paths\n- Hover states and focus indicators\n- Copy path to clipboard\n-->\n\n<script lang=\"ts\">\n\ttype Folder = {\n\t\t_id: string;\n\t\tname: string;\n\t\tpath: string[];\n\t};\n\n\tinterface Props {\n\t\tbreadcrumb: string[];\n\t\topenFolder: (folderId: string | null) => void;\n\t\tfolders: Folder[];\n\t\tmaxVisible?: number;\n\t}\n\n\tconst { breadcrumb, openFolder, folders, maxVisible = 5 }: Props = $props();\n\n\t// State\n\tlet showAll = $state(false);\n\n\t// Determine if breadcrumb needs truncation\n\tconst needsTruncation = $derived(breadcrumb.length > maxVisible && !showAll);\n\n\t// Visible breadcrumb items\n\tconst visibleBreadcrumb = $derived(() => {\n\t\tif (!needsTruncation || showAll) {\n\t\t\treturn breadcrumb;\n\t\t}\n\n\t\t// Show first, ellipsis, and last two items\n\t\treturn [breadcrumb[0], '...', ...breadcrumb.slice(-2)];\n\t});\n\n\t// Get visible indices (maps visible items to original indices)\n\tconst visibleIndices = $derived(() => {\n\t\tif (!needsTruncation || showAll) {\n\t\t\treturn breadcrumb.map((_, i) => i);\n\t\t}\n\n\t\treturn [\n\t\t\t0,\n\t\t\t-1, // Ellipsis\n\t\t\tbreadcrumb.length - 2,\n\t\t\tbreadcrumb.length - 1\n\t\t];\n\t});\n\n\t// Handle breadcrumb click\n\tfunction handleBreadcrumbClick(visibleIndex: number) {\n\t\tconst actualIndex = visibleIndices()[visibleIndex];\n\n\t\t// Skip ellipsis clicks\n\t\tif (actualIndex === -1) {\n\t\t\tshowAll = true;\n\t\t\treturn;\n\t\t}\n\n\t\tif (actualIndex === 0) {\n\t\t\t// Click on home/root\n\t\t\topenFolder(null);\n\t\t} else {\n\t\t\t// Find the folder matching the breadcrumb\n\t\t\tconst folder = folders[actualIndex];\n\t\t\topenFolder(folder ? folder._id : null);\n\t\t}\n\t}\n\n\t// Copy path to clipboard\n\tasync function copyPath() {\n\t\tconst path = breadcrumb.join(' > ');\n\t\ttry {\n\t\t\tawait navigator.clipboard.writeText(path);\n\t\t\t// Could show a toast notification here\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to copy path:', err);\n\t\t}\n\t}\n\n\t// Handle keyboard navigation\n\tfunction handleKeydown(event: KeyboardEvent, index: number) {\n\t\tif (event.key === 'Enter' || event.key === ' ') {\n\t\t\tevent.preventDefault();\n\t\t\thandleBreadcrumbClick(index);\n\t\t}\n\t}\n</script>\n\n<nav aria-label=\"Breadcrumb navigation\" class=\"flex items-center gap-2\">\n\t<!-- Breadcrumb list -->\n\t<ol class=\"flex flex-wrap items-center gap-1 text-sm text-gray-700 dark:text-gray-300\" role=\"list\">\n\t\t{#each visibleBreadcrumb() as crumb, visibleIndex (visibleIndex)}\n\t\t\t{@const actualIndex = visibleIndices()[visibleIndex]}\n\t\t\t{@const isLast = visibleIndex === visibleBreadcrumb().length - 1}\n\t\t\t{@const isEllipsis = actualIndex === -1}\n\n\t\t\t<li class=\"flex items-center\" role=\"listitem\">\n\t\t\t\t{#if isEllipsis}\n\t\t\t\t\t<!-- Ellipsis button to expand -->\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => (showAll = true)}\n\t\t\t\t\t\tclass=\"flex items-center gap-1 rounded px-2 py-1 text-sm transition-colors hover:bg-surface-100 focus:bg-surface-100 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:hover:bg-surface-800 dark:focus:bg-surface-800\"\n\t\t\t\t\t\taria-label=\"Show all breadcrumb items\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:dots-horizontal\" width=\"18\" class=\"text-surface-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t</button>\n\t\t\t\t{:else}\n\t\t\t\t\t<!-- Regular breadcrumb item -->\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => handleBreadcrumbClick(visibleIndex)}\n\t\t\t\t\t\tonkeydown={(e) => handleKeydown(e, visibleIndex)}\n\t\t\t\t\t\tclass=\"flex items-center gap-1.5 rounded px-2 py-1 text-sm transition-all {isLast\n\t\t\t\t\t\t\t? 'font-semibold text-primary-600 dark:text-primary-400'\n\t\t\t\t\t\t\t: 'hover:bg-surface-100 hover:text-primary-500 focus:bg-surface-100 focus:text-primary-500 dark:hover:bg-surface-800 dark:focus:bg-surface-800'} focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-1\"\n\t\t\t\t\t\taria-current={isLast ? 'page' : undefined}\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\ttitle={crumb}\n\t\t\t\t\t>\n\t\t\t\t\t\t{#if actualIndex === 0}\n\t\t\t\t\t\t\t<!-- Home icon -->\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:home\" width=\"18\" class=\"shrink-0 text-tertiary-500 dark:text-primary-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"max-w-[150px] truncate\">{crumb}</span>\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<!-- Folder icon -->\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:folder\" width=\"18\" class=\"shrink-0 text-tertiary-500 dark:text-primary-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"max-w-[150px] truncate\">{crumb}</span>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\n\t\t\t\t<!-- Separator (not after last item) -->\n\t\t\t\t{#if !isLast}\n\t\t\t\t\t<span class=\"mx-1 text-gray-400 dark:text-gray-600\" aria-hidden=\"true\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:chevron-right\" width=\"16\"></iconify-icon>\n\t\t\t\t\t</span>\n\t\t\t\t{/if}\n\t\t\t</li>\n\t\t{/each}\n\t</ol>\n\n\t<!-- Copy path button -->\n\t<button\n\t\tonclick={copyPath}\n\t\tclass=\"btn-icon btn-icon-sm preset-outlined-surface-500 ml-auto\"\n\t\ttitle=\"Copy path to clipboard\"\n\t\taria-label=\"Copy current path to clipboard\"\n\t\ttype=\"button\"\n\t>\n\t\t<iconify-icon icon=\"mdi:content-copy\" width=\"16\"></iconify-icon>\n\t</button>\n\n\t<!-- Screen reader announcement -->\n\t<div class=\"sr-only\" role=\"status\" aria-live=\"polite\">\n\t\tCurrent location: {breadcrumb.join(', then ')}\n\t</div>\n</nav>\n","<!--\n@file: src/components/media/tagEditor/TagEditorModal.svelte\n@component\nA modal for managing media tags.\n-->\n<script lang=\"ts\">\n\timport type { MediaImage } from '@shared/utils/media/mediaModels';\n\n\timport { toaster } from '@shared/stores/store.svelte';\n\n\t// Props\n\tlet {\n\t\tshow = $bindable(),\n\t\tfile = $bindable(null),\n\t\tonUpdate = () => {}\n\t}: {\n\t\tshow: boolean;\n\t\tfile: MediaImage | null;\n\t\tonUpdate?: (updatedFile: MediaImage) => void;\n\t} = $props();\n\n\tlet newTagInput = $state('');\n\tlet isGenerating = $state(false);\n\tlet isSaving = $state(false);\n\n\t// Edit state\n\tlet editingTag = $state<{ type: 'ai' | 'user'; index: number; value: string } | null>(null);\n\n\tfunction getImageUrl(file: MediaImage) {\n\t\t// Try to get thumbnail, fallback to original url\n\t\tconst thumbs = file.thumbnails || {};\n\t\t// Map common keys\n\t\tif ('sm' in thumbs) return thumbs.sm.url;\n\t\tif ('thumbnail' in thumbs) return thumbs.thumbnail.url;\n\t\tif ('md' in thumbs) return thumbs.md.url;\n\t\treturn file.url;\n\t}\n\n\tasync function handleAITagging() {\n\t\tif (!file?._id) return;\n\t\tisGenerating = true;\n\t\ttry {\n\t\t\tconst response = await fetch(`/api/media/${file._id}/tags`, { method: 'POST' });\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error || 'Failed.');\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t\ttoaster.success({ description: 'AI tags generated!' });\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t} finally {\n\t\t\tisGenerating = false;\n\t\t}\n\t}\n\n\tasync function addManualTag() {\n\t\tif (!file?._id || !newTagInput.trim()) return;\n\t\ttry {\n\t\t\t// Add to aiTags \"pending\" area\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...file.metadata,\n\t\t\t\t\t\taiTags: [...(file.metadata?.aiTags || []), newTagInput.trim()]\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t\tnewTagInput = '';\n\t\t\ttoaster.success({ description: 'Tag added!' });\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t}\n\t}\n\n\tasync function removeTag(tag: string, type: 'ai' | 'user') {\n\t\tif (!file?._id) return;\n\t\ttry {\n\t\t\tconst metadata = { ...file.metadata };\n\t\t\tif (type === 'ai') {\n\t\t\t\tmetadata.aiTags = metadata.aiTags?.filter((t) => t !== tag) || [];\n\t\t\t} else {\n\t\t\t\tmetadata.tags = metadata.tags?.filter((t) => t !== tag) || [];\n\t\t\t}\n\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ metadata })\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t}\n\t}\n\n\tasync function editTag(oldTag: string, newTag: string, type: 'ai' | 'user') {\n\t\tif (!file?._id || !newTag.trim() || oldTag === newTag) {\n\t\t\teditingTag = null;\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst metadata = { ...file.metadata };\n\t\t\tif (type === 'ai') {\n\t\t\t\tmetadata.aiTags = metadata.aiTags?.map((t) => (t === oldTag ? newTag.trim() : t)) || [];\n\t\t\t} else {\n\t\t\t\tmetadata.tags = metadata.tags?.map((t) => (t === oldTag ? newTag.trim() : t)) || [];\n\t\t\t}\n\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ metadata })\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t} finally {\n\t\t\teditingTag = null;\n\t\t}\n\t}\n\n\tasync function saveAITags() {\n\t\tif (!file?._id) return;\n\t\tisSaving = true;\n\t\ttry {\n\t\t\t// Merge AI tags into User tags\n\t\t\tconst currentTags = new Set(file.metadata?.tags || []);\n\t\t\tfile.metadata?.aiTags?.forEach((t) => currentTags.add(t));\n\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...file.metadata,\n\t\t\t\t\t\ttags: Array.from(currentTags),\n\t\t\t\t\t\taiTags: [] // Clear AI tags after saving\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t\ttoaster.success({ description: 'Tags saved!' });\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t} finally {\n\t\t\tisSaving = false;\n\t\t}\n\t}\n\n\tfunction close() {\n\t\tshow = false;\n\t}\n\n\tfunction autofocus(node: HTMLElement) {\n\t\tnode.focus();\n\t}\n</script>\n\n{#if show && file}\n\t<div\n\t\tclass=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm\"\n\t\trole=\"dialog\"\n\t\taria-modal=\"true\"\n\t\ttabindex=\"-1\"\n\t\tonclick={(e) => {\n\t\t\tif (e.target === e.currentTarget) close();\n\t\t}}\n\t\tonkeydown={(e) => e.key === 'Escape' && close()}\n\t>\n\t\t<div class=\"card w-full max-w-lg p-4 bg-surface-100 dark:bg-surface-800 shadow-xl m-4\" role=\"document\">\n\t\t\t<header class=\"flex justify-between items-center mb-4\">\n\t\t\t\t<h3 class=\"h3 font-bold\">Manage Tags</h3>\n\t\t\t\t<button class=\"btn-icon btn-icon-sm\" onclick={close} aria-label=\"Close Modal\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</header>\n\n\t\t\t<div class=\"space-y-4 max-h-[60vh] overflow-y-auto p-1\">\n\t\t\t\t<!-- File Info Summary -->\n\t\t\t\t<div class=\"flex items-center gap-3 p-2 bg-surface-200 dark:bg-surface-700 rounded\">\n\t\t\t\t\t<img src={getImageUrl(file)} alt=\"Thumbnail\" class=\"w-12 h-12 object-cover rounded bg-black\" />\n\t\t\t\t\t<div class=\"text-sm truncate\">\n\t\t\t\t\t\t<div class=\"font-bold truncate\">{file.filename}</div>\n\t\t\t\t\t\t<div class=\"opacity-70 text-xs\">{file.mimeType}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<!-- AI/Pending Tags -->\n\t\t\t\t<section class=\"p-3 border border-primary-500/30 rounded bg-primary-50/50 dark:bg-primary-900/10\">\n\t\t\t\t\t<div class=\"flex justify-between items-center mb-2\">\n\t\t\t\t\t\t<span class=\"text-sm font-bold flex items-center gap-1 text-primary-600 dark:text-primary-400\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:robot-excited-outline\"></iconify-icon>\n\t\t\t\t\t\t\tAI / Pending Tags\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t{#if !file.metadata?.aiTags?.length}\n\t\t\t\t\t\t\t<button class=\"btn btn-sm variant-filled-secondary\" onclick={handleAITagging} disabled={isGenerating}>\n\t\t\t\t\t\t\t\t{#if isGenerating}\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"eos-icons:loading\" class=\"animate-spin\"></iconify-icon>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:magic-staff\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t<span>Generate</span>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"flex flex-wrap gap-2 mb-3\">\n\t\t\t\t\t\t{#if file.metadata?.aiTags?.length}\n\t\t\t\t\t\t\t{#each file.metadata.aiTags as tag, i}\n\t\t\t\t\t\t\t\t{#if editingTag?.type === 'ai' && editingTag.index === i}\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\tvalue={editingTag.value}\n\t\t\t\t\t\t\t\t\t\tclass=\"input input-sm w-24 px-1 py-0 text-xs\"\n\t\t\t\t\t\t\t\t\t\toninput={(e) => (editingTag!.value = e.currentTarget.value)}\n\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter') editTag(tag, editingTag!.value, 'ai');\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Escape') editingTag = null;\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonblur={() => editTag(tag, editingTag!.value, 'ai')}\n\t\t\t\t\t\t\t\t\t\tuse:autofocus\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\tclass=\"badge variant-filled-secondary flex items-center gap-1 cursor-pointer hover:ring-2 hover:ring-secondary-300\"\n\t\t\t\t\t\t\t\t\t\tonclick={() => (editingTag = { type: 'ai', index: i, value: tag })}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{tag}\n\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\t\t\tremoveTag(tag, 'ai');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => e.key === 'Enter' && removeTag(tag, 'ai')}\n\t\t\t\t\t\t\t\t\t\t\taria-label=\"Remove Tag\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"14\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<div class=\"text-xs opacity-60 italic\">No pending tags.</div>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"flex gap-2\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tclass=\"input input-sm flex-1\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Add tag manually...\"\n\t\t\t\t\t\t\tbind:value={newTagInput}\n\t\t\t\t\t\t\tonkeydown={(e) => e.key === 'Enter' && addManualTag()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button class=\"btn btn-sm variant-filled-surface\" onclick={addManualTag} disabled={!newTagInput.trim()} aria-label=\"Add Tag\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:plus\"></iconify-icon>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{#if file.metadata?.aiTags?.length}\n\t\t\t\t\t\t<div class=\"mt-3 pt-3 border-t border-primary-500/20\">\n\t\t\t\t\t\t\t<button class=\"btn btn-sm variant-filled-success w-full\" onclick={saveAITags} disabled={isSaving}>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:check-all\"></iconify-icon>\n\t\t\t\t\t\t\t\t<span>Save All to Media Tags</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/if}\n\t\t\t\t</section>\n\n\t\t\t\t<!-- Saved Tags -->\n\t\t\t\t<section class=\"p-3 border border-surface-300 dark:border-surface-600 rounded bg-surface-50 dark:bg-surface-900\">\n\t\t\t\t\t<div class=\"mb-2 text-sm font-bold opacity-80\">Saved Tags</div>\n\t\t\t\t\t<div class=\"flex flex-wrap gap-2\">\n\t\t\t\t\t\t{#if file.metadata?.tags?.length}\n\t\t\t\t\t\t\t{#each file.metadata.tags as tag, i}\n\t\t\t\t\t\t\t\t{#if editingTag?.type === 'user' && editingTag.index === i}\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\tvalue={editingTag.value}\n\t\t\t\t\t\t\t\t\t\tclass=\"input input-sm w-24 px-1 py-0 text-xs\"\n\t\t\t\t\t\t\t\t\t\toninput={(e) => (editingTag!.value = e.currentTarget.value)}\n\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter') editTag(tag, editingTag!.value, 'user');\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Escape') editingTag = null;\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonblur={() => editTag(tag, editingTag!.value, 'user')}\n\t\t\t\t\t\t\t\t\t\tuse:autofocus\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\tclass=\"badge variant-filled-surface flex items-center gap-1 cursor-pointer hover:ring-2 hover:ring-surface-400\"\n\t\t\t\t\t\t\t\t\t\tonclick={() => (editingTag = { type: 'user', index: i, value: tag })}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{tag}\n\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\t\t\tremoveTag(tag, 'user');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => e.key === 'Enter' && removeTag(tag, 'user')}\n\t\t\t\t\t\t\t\t\t\t\taria-label=\"Remove Tag\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"14\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<div class=\"text-xs opacity-60 italic\">No saved tags.</div>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t</section>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n{/if}\n","<!--\n@file src/routes/(app)/mediagallery/MediaGrid.svelte\n@component\n**Grid view component for the media gallery. Displays media items in a responsive grid layout with file information and actions**\n\n```tsx\n<MediaGrid filteredFiles={filteredFiles} gridSize=\"small\" />\n```\n#### Props\n- `filteredFiles: MediaBase[]`: An array of media items to be displayed in the grid view.\n- `gridSize: 'small' | 'medium' | 'large'`: The size of the grid layout to be used.\t\n\nKey features:\n- Responsive grid layout for media items\n- Display of file name, size, and type\n- Thumbnail preview for images\n- Actions for file info, edit, and delete\n- Uses formatBytes for human-readable file sizes\n- Implements constructMediaUrl for proper URL handling\n-->\n\n<script lang=\"ts\">\n\t// Utils\n\timport { formatBytes } from '@shared/utils/utils';\n\timport { logger } from '@shared/utils/logger';\n\timport type { MediaImage, MediaBase } from '@shared/utils/media/mediaModels';\n\n\t// Skeleton\n\timport { Tooltip, Portal } from '@skeletonlabs/skeleton-svelte';\n\t// Svelte transitions\n\timport { scale } from 'svelte/transition';\n\timport { quintOut } from 'svelte/easing';\n\n\timport TagEditorModal from '@cms/components/media/tagEditor/TagEditorModal.svelte';\n\n\tinterface Props {\n\t\tfilteredFiles?: (MediaBase | MediaImage)[];\n\t\tgridSize?: 'tiny' | 'small' | 'medium' | 'large';\n\t\tondeleteImage?: (file: MediaBase | MediaImage) => void;\n\t\tonBulkDelete?: (files: (MediaBase | MediaImage)[]) => void;\n\t\tonEditImage?: (file: MediaImage) => void;\n\t\tonsizechange?: (detail: { size: string; type: string }) => void;\n\t\tonUpdateImage?: (file: MediaImage) => void;\n\t}\n\n\tconst {\n\t\tfilteredFiles = $bindable([]),\n\t\tgridSize = 'medium',\n\t\tondeleteImage = () => {},\n\t\tonBulkDelete = () => {},\n\t\tonEditImage = () => {},\n\t\tonsizechange = () => {},\n\t\tonUpdateImage = () => {}\n\t}: Props = $props();\n\n\tlet showInfo = $state<boolean[]>([]);\n\tlet selectedFiles = $state<Set<string>>(new Set());\n\tlet isSelectionMode = $state(false);\n\n\t// Tag Modal State\n\tlet showTagModal = $state(false);\n\tlet taggingFile = $state<MediaImage | null>(null);\n\n\tfunction openTagEditor(file: MediaImage) {\n\t\ttaggingFile = file;\n\t\tshowTagModal = true;\n\t}\n\n\t// Format MIME type for display\n\tfunction formatMimeType(mime?: string): string {\n\t\tif (!mime) return 'Unknown';\n\t\tconst parts = mime.split('/');\n\t\treturn parts[1] ? parts[1].toUpperCase() : parts[0].toUpperCase();\n\t}\n\n\t// Helper: Get icon string\n\tfunction getFileIcon(file: MediaBase): string {\n\t\t// Fallback if path is missing or not a string\n\t\tconst fileName = file.filename || '';\n\t\tconst fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();\n\n\t\tswitch (true) {\n\t\t\tcase file.type === 'image':\n\t\t\t\treturn 'fa-solid:image';\n\t\t\tcase file.type === 'video':\n\t\t\t\treturn 'fa-solid:video';\n\t\t\tcase file.type === 'audio':\n\t\t\t\treturn 'fa-solid:play-circle';\n\t\t\tcase fileExt === '.pdf':\n\t\t\t\treturn 'vscode-icons:file-type-pdf2';\n\t\t\tcase fileExt === '.doc' || fileExt === '.docx' || fileExt === '.docm':\n\t\t\t\treturn 'vscode-icons:file-type-word';\n\t\t\tcase fileExt === '.ppt' || fileExt === '.pptx':\n\t\t\t\treturn 'vscode-icons:file-type-powerpoint';\n\t\t\tcase fileExt === '.xls' || fileExt === '.xlsx':\n\t\t\t\treturn 'vscode-icons:file-type-excel';\n\t\t\tcase fileExt === '.txt':\n\t\t\t\treturn 'fa-solid:file-lines';\n\t\t\tcase fileExt === '.zip' || fileExt === '.rar':\n\t\t\t\treturn 'fa-solid:file-zipper';\n\t\t\tdefault:\n\t\t\t\treturn 'vscode-icons:file';\n\t\t}\n\t}\n\n\tfunction handleDelete(file: MediaBase | MediaImage) {\n\t\tondeleteImage(file);\n\t}\n\n\tfunction toggleSelection(file: MediaBase | MediaImage) {\n\t\tconst fileId = file._id?.toString() || file.filename;\n\t\tif (selectedFiles.has(fileId)) {\n\t\t\tselectedFiles.delete(fileId);\n\t\t} else {\n\t\t\tselectedFiles.add(fileId);\n\t\t}\n\t\tselectedFiles = selectedFiles; // Trigger reactivity\n\t}\n\n\tfunction selectAll() {\n\t\tselectedFiles = new Set(filteredFiles.map((f) => f._id?.toString() || f.filename));\n\t}\n\n\tfunction deselectAll() {\n\t\tselectedFiles = new Set();\n\t}\n\n\tfunction handleBulkDelete() {\n\t\tconst filesToDelete = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToDelete.length > 0) {\n\t\t\tonBulkDelete(filesToDelete);\n\t\t\tselectedFiles = new Set();\n\t\t\tisSelectionMode = false;\n\t\t}\n\t}\n\n\t// Update showInfo array when filteredFiles length changes\n\t$effect(() => {\n\t\tshowInfo = Array.from({ length: filteredFiles.length }, () => false);\n\t});\n\n\tfunction getThumbnails(file: MediaBase | MediaImage) {\n\t\treturn 'thumbnails' in file ? file.thumbnails || {} : {};\n\t}\n\n\tfunction getThumbnail(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnails = getThumbnails(file);\n\t\t// Map UI grid sizes to DB keys\n\t\tconst sizeMap: Record<string, string> = {\n\t\t\ttiny: 'thumbnail',\n\t\t\tsmall: 'sm',\n\t\t\tmedium: 'md',\n\t\t\tlarge: 'lg'\n\t\t};\n\t\tconst key = sizeMap[size] || size;\n\t\treturn thumbnails ? thumbnails[key as keyof typeof thumbnails] : undefined;\n\t}\n\n\tfunction getImageUrl(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnail = getThumbnail(file, size);\n\t\treturn thumbnail?.url || (file as any).url;\n\t}\n</script>\n\n<div class=\"flex flex-wrap items-center gap-4 overflow-auto\">\n\t{#if filteredFiles.length === 0}\n\t\t<div class=\"mx-auto text-center text-tertiary-500 dark:text-primary-500\">\n\t\t\t<iconify-icon icon=\"bi:exclamation-circle-fill\" height=\"44\" class=\"mb-2\"></iconify-icon>\n\t\t\t<p class=\"text-lg\">No media found</p>\n\t\t</div>\n\t{:else}\n\t\t<!-- Batch Operations Toolbar -->\n\t\t<div class=\"mb-4 flex w-full items-center justify-between gap-2 rounded border border-surface-400 bg-surface-100 p-2 dark:bg-surface-700\">\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\tisSelectionMode = !isSelectionMode;\n\t\t\t\t\t\tselectedFiles = new Set();\n\t\t\t\t\t}}\n\t\t\t\t\tclass=\"preset-outline-surface-500 btn-sm\"\n\t\t\t\t\taria-label=\"Toggle selection mode\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon={isSelectionMode ? 'mdi:close' : 'mdi:checkbox-multiple-marked'} width=\"20\"></iconify-icon>\n\t\t\t\t\t{isSelectionMode ? 'Cancel' : 'Select'}\n\t\t\t\t</button>\n\n\t\t\t\t{#if isSelectionMode}\n\t\t\t\t\t<button onclick={selectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:select-all\" width=\"20\"></iconify-icon>\n\t\t\t\t\t\tSelect All\n\t\t\t\t\t</button>\n\t\t\t\t\t<button onclick={deselectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:select-off\" width=\"20\"></iconify-icon>\n\t\t\t\t\t\tDeselect All\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t</div>\n\n\t\t\t{#if selectedFiles.size > 0}\n\t\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t\t<span class=\"text-sm\">{selectedFiles.size} selected</span>\n\t\t\t\t\t<button onclick={handleBulkDelete} class=\"preset-filled-error-500 btn-sm\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:delete\" width=\"20\"></iconify-icon>\n\t\t\t\t\t\tDelete Selected\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t{/if}\n\t\t</div>\n\n\t\t{#each filteredFiles as file, index (file._id?.toString() || file.filename)}\n\t\t\t{@const fileId = file._id?.toString() || file.filename}\n\t\t\t{@const isSelected = selectedFiles.has(fileId)}\n\t\t\t<div\n\t\t\t\tonmouseenter={() => (showInfo[index] = true)}\n\t\t\t\tonmouseleave={() => (showInfo[index] = false)}\n\t\t\t\tonclick={() => isSelectionMode && toggleSelection(file)}\n\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\tif (isSelectionMode && (e.key === 'Enter' || e.key === ' ')) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\ttoggleSelection(file);\n\t\t\t\t\t}\n\t\t\t\t}}\n\t\t\t\trole=\"button\"\n\t\t\t\ttabindex=\"0\"\n\t\t\t\tclass=\"card relative border border-surface-300 dark:border-surface-500 {isSelected ? 'ring-2 ring-primary-500' : ''}\"\n\t\t\t\tin:scale={{ duration: 300, start: 0.9, opacity: 0, easing: quintOut }}\n\t\t\t\tout:scale={{ duration: 250, start: 0.95, opacity: 0, easing: quintOut }}\n\t\t\t>\n\t\t\t\t{#if isSelectionMode}\n\t\t\t\t\t<div class=\"absolute left-2 top-2 z-10\">\n\t\t\t\t\t\t<input type=\"checkbox\" checked={isSelected} onchange={() => toggleSelection(file)} class=\"checkbox\" aria-label=\"Select file\" />\n\t\t\t\t\t</div>\n\t\t\t\t{/if}\n\n\t\t\t\t<header class=\"m-2 flex w-auto items-center justify-between\">\n\t\t\t\t\t<!-- Info Tooltip -->\n\t\t\t\t\t<Tooltip positioning={{ placement: 'right' }}>\n\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t<button aria-label=\"File Info\" class=\"btn-icon\" title=\"File Info\">\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"raphael:info\" width=\"24\" class=\"text-tertiary-500 dark:text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded-container-token z-50 border border-surface-500 bg-surface-50 p-2 shadow-xl dark:bg-surface-900\">\n\t\t\t\t\t\t\t\t\t<table class=\"table-auto text-xs\">\n\t\t\t\t\t\t\t\t\t\t<thead class=\"text-tertiary-500\">\n\t\t\t\t\t\t\t\t\t\t\t<tr class=\"divide-x divide-surface-400 border-b-2 border-surface-400 text-center\">\n\t\t\t\t\t\t\t\t\t\t\t\t<th class=\"px-2 text-left\">Format</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class=\"px-2\">Pixel</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class=\"px-2\">Size</th>\n\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t\t{#if 'width' in file && file.width && 'height' in file && file.height}\n\t\t\t\t\t\t\t\t\t\t\t\t<tr\n\t\t\t\t\t\t\t\t\t\t\t\t\t><td class=\"px-2 font-semibold\">Original:</td><td class=\"px-2\">{file.width}x{file.height}</td><td class=\"px-2\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t>{formatBytes(file.size)}</td\n\t\t\t\t\t\t\t\t\t\t\t\t\t></tr\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t{#each Object.keys(getThumbnails(file)) as size (size)}\n\t\t\t\t\t\t\t\t\t\t\t\t{@const thumbnail = getThumbnail(file, size)}\n\t\t\t\t\t\t\t\t\t\t\t\t{#if thumbnail}\n\t\t\t\t\t\t\t\t\t\t\t\t\t<tr\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclass=\"divide-x divide-surface-400 border-b border-surface-400 last:border-b-0 {size === gridSize\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'bg-primary-50 dark:bg-primary-900/20'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: ''}\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (size === 'tiny' || size === 'small' || size === 'medium' || size === 'large') {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tonsizechange({\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsize: size === 'tiny' ? 'small' : size === 'small' ? 'medium' : size === 'medium' ? 'large' : 'tiny',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: 'grid'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class=\"px-2 font-bold text-tertiary-500\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>{size}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{#if size === gridSize}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"ml-1 text-[10px] text-primary-500\">(active)</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class=\"px-2 text-right\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{#if thumbnail.width && thumbnail.height}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{thumbnail.width}x{thumbnail.height}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tN/A\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class=\"px-2 text-right\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{#if thumbnail.size}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{formatBytes(thumbnail.size)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{:else if size === 'original' && file.size}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{formatBytes(file.size)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tN/A\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-50 dark:fill-surface-900\" />\n\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t</Portal>\n\t\t\t\t\t</Tooltip>\n\n\t\t\t\t\t<div class=\"flex items-center gap-1\">\n\t\t\t\t\t\t{#if file.type === 'image'}\n\t\t\t\t\t\t\t<!-- Toggle Tags Tooltip -->\n\t\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t<button onclick={() => openTagEditor(file as MediaImage)} aria-label=\"Toggle Tags\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t{#if file.metadata?.aiTags?.length || file.metadata?.tags?.length}\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:tag-multiple\" width=\"22\" class=\"text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:tag-outline\" width=\"22\" class=\"text-surface-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\t\tView/Edit Tags\n\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t\t</Tooltip>\n\n\t\t\t\t\t\t\t<!-- Edit Tooltip -->\n\t\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t<button onclick={() => onEditImage(file as MediaImage)} aria-label=\"Edit\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:pen\" width=\"24\" class=\"text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\t\tEdit Image\n\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t<!-- Delete Tooltip -->\n\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t<button onclick={() => handleDelete(file)} aria-label=\"Delete\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"icomoon-free:bin\" width=\"24\" class=\"text-error-500\"> </iconify-icon>\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\tDelete Image\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t</div>\n\t\t\t\t</header>\n\n\t\t\t\t<section class=\"flex items-center justify-center p-2\">\n\t\t\t\t\t{#if file?.filename && file?.path && file?.hash}\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={getImageUrl(file, gridSize) ?? '/static/Default_User.svg'}\n\t\t\t\t\t\t\talt={`Thumbnail for ${file.filename}`}\n\t\t\t\t\t\t\tclass={`rounded object-cover ${\n\t\t\t\t\t\t\t\tgridSize === 'tiny' ? 'h-16 w-16' : gridSize === 'small' ? 'h-24 w-24' : gridSize === 'medium' ? 'h-48 w-48' : 'h-80 w-80'\n\t\t\t\t\t\t\t}`}\n\t\t\t\t\t\t\tonerror={(e: Event) => {\n\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\n\t\t\t\t\t\t\t\tif (target) {\n\t\t\t\t\t\t\t\t\tlogger.error('Failed to load media thumbnail for file:', file.filename);\n\t\t\t\t\t\t\t\t\ttarget.src = '/static/Default_User.svg';\n\t\t\t\t\t\t\t\t\ttarget.alt = 'Fallback thumbnail image';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tloading=\"lazy\"\n\t\t\t\t\t\t\tdecoding=\"async\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t{:else}\n\t\t\t\t\t\t<div class=\"flex h-full w-full items-center justify-center bg-surface-200 dark:bg-surface-700\" aria-label=\"Missing thumbnail\" role=\"img\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-triangle-fill\" height=\"24\" class=\"text-warning-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/if}\n\t\t\t\t</section>\n\n\t\t\t\t<!-- Media Filename (LocalUpload Style) -->\n\t\t\t\t<div class=\"label overflow-hidden text-ellipsis whitespace-nowrap p-1 text-center font-bold text-xs\" title={file.filename}>\n\t\t\t\t\t{file.filename}\n\t\t\t\t</div>\n\n\t\t\t\t<footer class=\"flex flex-col gap-2 p-1\">\n\t\t\t\t\t<!-- Tags Overlay Removed -->\n\n\t\t\t\t\t<!-- Media Type & Size (Footer - LocalUpload Style) -->\n\t\t\t\t\t<div class=\"flex grow items-center justify-between p-1 text-white\">\n\t\t\t\t\t\t<!-- Type -->\n\t\t\t\t\t\t<div class=\"bg-tertiary-500 dark:bg-primary-500/50 badge flex items-center gap-1 overflow-hidden\" title={file.type}>\n\t\t\t\t\t\t\t<iconify-icon icon={getFileIcon(file)} width=\"12\" height=\"12\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"truncate text-[10px] uppercase\">{formatMimeType(file.mimeType)}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<!-- Size -->\n\t\t\t\t\t\t<p class=\"bg-tertiary-500 dark:bg-primary-500/50 badge flex shrink-0 items-center gap-1 text-[10px]\">\n\t\t\t\t\t\t\t<span class=\"\">{(file.size / 1024).toFixed(2)}</span>\n\t\t\t\t\t\t\tKB\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t</footer>\n\t\t\t</div>\n\t\t{/each}\n\t{/if}\n</div>\n\n<TagEditorModal bind:show={showTagModal} bind:file={taggingFile} onUpdate={onUpdateImage} />\n\n<style>\n\t/* Smooth transitions for grid layout changes */\n\t.card {\n\t\ttransition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n\t}\n\n\t/* Smooth grid item repositioning */\n\t:global(.flex.flex-wrap) {\n\t\ttransition: all 0.3s ease-out;\n\t}\n</style>\n","<!--\n@file src/routes/(app)/mediagallery/MediaTable.svelte\n@component\n**Table view component for the media gallery. Displays media items in a responsive table layout with sortable columns**\n\n```tsx\n<MediaTable filteredFiles={filteredFiles} tableSize=\"small\" />\n```\n#### Props\n- `filteredFiles: MediaBase[]`: An array of media items to be displayed in the table view.\n- `tableSize: 'small' | 'medium' | 'large'`: The size of the table layout to be used.\n- `ondeleteImage?: (file: MediaBase) => void`: An optional callback function to handle image deletion.\n- `onSelectionChange?: (selectedFiles: MediaBase[]) => void`: An optional callback function to handle selection changes.\n- `onUpdateImage?: (file: MediaImage) => void`: Callback for updating image data.\n\nKey features:\n- Responsive table layout for media items\n- Sortable columns for name, size, type, and date\n- Thumbnail preview for images\n- Uses formatBytes for human-readable file sizes\n- Implements constructMediaUrl for proper URL handling\n- Pagination support (if implemented in parent component)\n- Selection support with callback function\n- Tag management via TagEditorModal\n-->\n\n<script lang=\"ts\">\n\t// Utils\n\timport type { MediaBase, MediaImage, MediaTypeEnum } from '@shared/utils/media/mediaModels';\n\timport { logger } from '@shared/utils/logger';\n\timport { formatBytes } from '@shared/utils/utils';\n\t// Components\n\timport TableFilter from '@cms/components/system/table/TableFilter.svelte';\n\timport TableIcons from '@cms/components/system/table/TableIcons.svelte';\n\timport TablePagination from '@cms/components/system/table/TablePagination.svelte';\n\timport TagEditorModal from '@cms/components/media/tagEditor/TagEditorModal.svelte';\n\timport { Tooltip, Portal } from '@skeletonlabs/skeleton-svelte';\n\n\tinterface Props {\n\t\tfilteredFiles?: (MediaBase | MediaImage)[];\n\t\ttableSize?: 'tiny' | 'small' | 'medium' | 'large';\n\t\tondeleteImage?: (file: MediaBase | MediaImage) => void;\n\t\tonSelectionChange?: (selectedFiles: (MediaBase | MediaImage)[]) => void;\n\t\tonUpdateImage?: (file: MediaImage) => void;\n\t\tonEditImage?: (file: MediaImage) => void;\n\t\tonDeleteFiles?: (files: (MediaBase | MediaImage)[]) => void;\n\t}\n\n\tinterface SortableMedia extends MediaBase {\n\t\tfilename: string;\n\t\tsize: number;\n\t\ttype: MediaTypeEnum;\n\t}\n\n\tlet {\n\t\tfilteredFiles = $bindable([]),\n\t\ttableSize = 'medium',\n\t\tondeleteImage = () => {},\n\t\tonSelectionChange = () => {},\n\t\tonUpdateImage = () => {},\n\t\tonEditImage = () => {},\n\t\tonDeleteFiles = () => {}\n\t}: Props = $props();\n\n\t// Filter state\n\tlet globalSearchValue = $state('');\n\tlet filterShow = $state(false);\n\tlet columnShow = $state(false);\n\tlet density = $state('normal');\n\n\t// Selection state\n\tconst selectedFiles = $state<Set<string>>(new Set());\n\n\t// Tag Modal State\n\tlet showTagModal = $state(false);\n\tlet taggingFile = $state<MediaImage | null>(null);\n\n\tfunction openTagEditor(file: MediaImage) {\n\t\ttaggingFile = file;\n\t\tshowTagModal = true;\n\t}\n\n\tfunction handleSelection(file: MediaBase | MediaImage, checked: boolean) {\n\t\tif (checked) {\n\t\t\tselectedFiles.add(file.filename);\n\t\t} else {\n\t\t\tselectedFiles.delete(file.filename);\n\t\t}\n\t\tonSelectionChange(filteredFiles.filter((f) => selectedFiles.has(f.filename)));\n\t}\n\n\t// Pagination state\n\tlet currentPage = $state(1);\n\tlet rowsPerPage = $state(10);\n\tconst pagesCount = $derived(Math.ceil(filteredFiles.length / rowsPerPage));\n\tconst paginatedFiles = $derived(filteredFiles.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage));\n\n\tfunction handleDelete(file: MediaBase | MediaImage) {\n\t\tondeleteImage(file);\n\t}\n\n\t// Sorting functionality\n\tlet sortColumn = $state('name');\n\tlet sortOrder = $state(1); // 1 for ascending, -1 for descending\n\n\tfunction sort(column: keyof Pick<SortableMedia, 'filename' | 'size' | 'type'>) {\n\t\tif (sortColumn === column) {\n\t\t\tsortOrder *= -1;\n\t\t} else {\n\t\t\tsortColumn = column;\n\t\t\tsortOrder = 1;\n\t\t}\n\n\t\tfilteredFiles = filteredFiles.sort((a, b) => {\n\t\t\tif (column === 'size') {\n\t\t\t\treturn ((a[column] ?? 0) - (b[column] ?? 0)) * sortOrder;\n\t\t\t} else {\n\t\t\t\treturn String(a[column as keyof SortableMedia]).localeCompare(String(b[column as keyof SortableMedia])) * sortOrder;\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction getThumbnails(file: MediaBase | MediaImage) {\n\t\treturn 'thumbnails' in file ? file.thumbnails || {} : {};\n\t}\n\n\tfunction getThumbnail(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnails = getThumbnails(file);\n\t\t// Map UI table sizes to DB keys\n\t\tconst sizeMap: Record<string, string> = {\n\t\t\ttiny: 'thumbnail', // or 'xs'\n\t\t\tsmall: 'sm',\n\t\t\tmedium: 'md',\n\t\t\tlarge: 'lg'\n\t\t};\n\t\tconst key = sizeMap[size] || size;\n\t\treturn thumbnails ? thumbnails[key as keyof typeof thumbnails] : undefined;\n\t}\n\n\tfunction getImageUrl(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnail = getThumbnail(file, size);\n\t\treturn thumbnail?.url || (file as any).url;\n\t}\n</script>\n\n<div class=\"block w-full overflow-hidden\">\n\t{#if filteredFiles.length === 0}\n\t\t<div class=\"mx-auto text-center text-tertiary-500 dark:text-primary-500\">\n\t\t\t<iconify-icon icon=\"bi:exclamation-circle-fill\" height=\"44\" class=\"mb-2\"></iconify-icon>\n\t\t\t<p class=\"text-lg\">No media found</p>\n\t\t</div>\n\t{:else}\n\t\t<!-- Header with Filter -->\n\t\t<div class=\"mb-4 flex items-center justify-between\">\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<h2 class=\"text-lg font-bold\">Media Files</h2>\n\t\t\t\t{#if selectedFiles.size > 0}\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"variant-filled-error btn btn-sm ml-4\"\n\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\tconst filesToDelete = filteredFiles.filter((f) => selectedFiles.has(f.filename));\n\t\t\t\t\t\t\tonDeleteFiles(filesToDelete);\n\t\t\t\t\t\t\tselectedFiles.clear();\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:trash-can-outline\"></iconify-icon>\n\t\t\t\t\t\t<span>Delete ({selectedFiles.size})</span>\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t</div>\n\n\t\t\t<!-- TODO: move to +page.svelte -->\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<TableFilter bind:globalSearchValue bind:filterShow bind:columnShow bind:density />\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"table-container max-h-[calc(100vh-120px)] overflow-auto\">\n\t\t\t<table class=\"table table-interactive table-hover\">\n\t\t\t\t<thead class=\"bg-surface-100-800-token sticky top-0 text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t\t<tr class=\"divide-x divide-surface-400 border-b border-black dark:border-white text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t\t\t<th class=\"w-10\">Select</th>\n\t\t\t\t\t\t<th>Thumbnail</th>\n\t\t\t\t\t\t<!-- Name -->\n\t\t\t\t\t\t<th onclick={() => sort('filename')}>\n\t\t\t\t\t\t\tName {sortColumn === 'filename' ? (sortOrder === 1 ? '▲' : '▼') : ''}\n\t\t\t\t\t\t</th>\n\t\t\t\t\t\t<!-- Size -->\n\t\t\t\t\t\t<th onclick={() => sort('size')}>\n\t\t\t\t\t\t\tSize {sortColumn === 'size' ? (sortOrder === 1 ? '▲' : '▼') : ''}\n\t\t\t\t\t\t</th>\n\t\t\t\t\t\t<!-- Type -->\n\t\t\t\t\t\t<th onclick={() => sort('type')}>\n\t\t\t\t\t\t\tType {sortColumn === 'type' ? (sortOrder === 1 ? '▲' : '▼') : ''}\n\t\t\t\t\t\t</th>\n\t\t\t\t\t\t<!-- Path -->\n\t\t\t\t\t\t<th>Path</th>\n\t\t\t\t\t\t<!-- Tags (Moved Here) -->\n\t\t\t\t\t\t<th>Tags</th>\n\t\t\t\t\t\t<!-- Actions -->\n\t\t\t\t\t\t<th>Actions</th>\n\t\t\t\t\t</tr>\n\t\t\t\t</thead>\n\t\t\t\t<tbody>\n\t\t\t\t\t{#each paginatedFiles as file (file._id)}\n\t\t\t\t\t\t<tr class=\"divide-x divide-surface-400 border-b border-black dark:border-white\">\n\t\t\t\t\t\t\t<TableIcons\n\t\t\t\t\t\t\t\tcellClass=\"w-10 text-center\"\n\t\t\t\t\t\t\t\tchecked={selectedFiles.has(file.filename)}\n\t\t\t\t\t\t\t\tonCheck={(checked: boolean) => handleSelection(file, checked)}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t{#if file?.filename && file?.path && file?.hash}\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={getImageUrl(file, tableSize) ?? '/Default_User.svg'}\n\t\t\t\t\t\t\t\t\t\talt={`Thumbnail for ${file.filename}`}\n\t\t\t\t\t\t\t\t\t\tclass={`object-cover ${tableSize === 'tiny' ? 'h-10 w-10' : tableSize === 'small' ? 'h-16 w-16' : tableSize === 'medium' ? 'h-24 w-24' : 'h-32 w-32'}`}\n\t\t\t\t\t\t\t\t\t\tonerror={(e: Event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\n\t\t\t\t\t\t\t\t\t\t\tif (target) {\n\t\t\t\t\t\t\t\t\t\t\t\tlogger.error('Failed to load media thumbnail for file:', file.filename);\n\t\t\t\t\t\t\t\t\t\t\t\ttarget.src = '/Default_User.svg';\n\t\t\t\t\t\t\t\t\t\t\t\ttarget.alt = 'Fallback thumbnail image';\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tloading=\"lazy\"\n\t\t\t\t\t\t\t\t\t\tdecoding=\"async\"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tclass=\"flex h-full w-full items-center justify-center bg-surface-200 dark:bg-surface-700\"\n\t\t\t\t\t\t\t\t\t\taria-label=\"Missing thumbnail\"\n\t\t\t\t\t\t\t\t\t\trole=\"img\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-triangle-fill\" height=\"24\" class=\"text-warning-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<td title={file.filename}>{file.filename}</td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t{#if file.size}\n\t\t\t\t\t\t\t\t\t{formatBytes(file.size)}\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\tSize unknown\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<td>{file.type || 'Unknown'}</td>\n\t\t\t\t\t\t\t<td>{file.path}</td>\n\t\t\t\t\t\t\t<!-- Tags Column (Moved Here) -->\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t<div class=\"flex flex-wrap gap-1\">\n\t\t\t\t\t\t\t\t\t{#if 'metadata' in file && (file.metadata?.tags?.length || file.metadata?.aiTags?.length)}\n\t\t\t\t\t\t\t\t\t\t{@const tags = file.metadata.tags || []}\n\t\t\t\t\t\t\t\t\t\t{@const aiTags = file.metadata.aiTags || []}\n\t\t\t\t\t\t\t\t\t\t{@const allTagsCount = tags.length + aiTags.length}\n\n\t\t\t\t\t\t\t\t\t\t{#if tags.length > 0}\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"badge variant-filled-surface text-[10px]\">{tags[0]}</span>\n\t\t\t\t\t\t\t\t\t\t{:else if aiTags.length > 0}\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"badge variant-filled-secondary text-[10px]\">{aiTags[0]}</span>\n\t\t\t\t\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t\t\t\t\t{#if allTagsCount > 1}\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"badge variant-soft text-[10px]\">+{allTagsCount - 1}</span>\n\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t<!-- Toggle Tags Tooltip -->\n\t\t\t\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\t\tclass=\"btn-icon btn-icon-sm variant-soft-primary\"\n\t\t\t\t\t\t\t\t\t\t\t\tonclick={() => openTagEditor(file as MediaImage)}\n\t\t\t\t\t\t\t\t\t\t\t\taria-label=\"Manage Tags\"\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:tag-edit\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tManage Tags\n\t\t\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<!-- Actions -->\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t<button class=\"preset-outlined-primary-500 btn-sm\" aria-label=\"Edit\" onclick={() => onEditImage(file as MediaImage)}>Edit</button>\n\t\t\t\t\t\t\t\t<button onclick={() => handleDelete(file)} class=\"preset-filled-error-500 btn-sm\" aria-label=\"Delete\"> Delete </button>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t{/each}\n\t\t\t\t</tbody>\n\t\t\t</table>\n\n\t\t\t<!-- Pagination -->\n\t\t\t<div\n\t\t\t\tclass=\" bg-surface-100-800-token sticky bottom-0 left-0 right-0 mt-2 flex flex-col items-center justify-center px-2 py-2 md:flex-row md:justify-between md:p-4\"\n\t\t\t>\n\t\t\t\t<TablePagination\n\t\t\t\t\tbind:currentPage\n\t\t\t\t\tbind:rowsPerPage\n\t\t\t\t\t{pagesCount}\n\t\t\t\t\ttotalItems={filteredFiles.length}\n\t\t\t\t\trowsPerPageOptions={[5, 10, 25, 50, 100]}\n\t\t\t\t\tonUpdatePage={(page: number) => {\n\t\t\t\t\t\tcurrentPage = page;\n\t\t\t\t\t}}\n\t\t\t\t\tonUpdateRowsPerPage={(rows: number) => {\n\t\t\t\t\t\trowsPerPage = rows;\n\t\t\t\t\t\tcurrentPage = 1;\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<!-- Tag Editor Modal -->\n\t<TagEditorModal bind:show={showTagModal} bind:file={taggingFile} onUpdate={onUpdateImage} />\n</div>\n","<!--\n@file src/routes/(app)/mediagallery/VirtualMediaGrid.svelte\n@component\n**Virtual scrolling grid for media gallery - handles 10,000+ files smoothly**\n\nImplements custom virtual scrolling without external dependencies.\n\n### Props\n- `filteredFiles: MediaImage[]`: An array of media items to be displayed in the grid view.\n- `gridSize: 'tiny' | 'small' | 'medium' | 'large'`: The size of the grid layout to be used.\n- `ondeleteImage?: (file: MediaImage) => void`: An optional callback function to handle image deletion.\n- `onBulkDelete?: (files: MediaImage[]) => void`: An optional callback function to handle bulk deletion.\n- `onBulkDownload?: (files: MediaImage[]) => void`: An optional callback function to handle bulk downloading.\n- `onBulkEdit?: (files: MediaImage[], action: string, value: any) => void`: An optional callback function to handle bulk editing.\n\n### Features:\n- Virtual scrolling for optimal performance\n- Batch operations (select, delete, download, edit)\n- Blur-up placeholders\n- Advanced search\n- Duplicate detection\n- Bulk edit operations\n-->\n\n<script lang=\"ts\">\n\timport { formatBytes } from '@shared/utils/utils';\n\n\timport type { MediaImage, MediaBase } from '@shared/utils/media/mediaModels';\n\t// import { popup } from '@skeletonlabs/skeleton-svelte';\n\timport { onMount } from 'svelte';\n\n\tinterface Props {\n\t\tfilteredFiles?: (MediaBase | MediaImage)[];\n\t\tgridSize?: 'tiny' | 'small' | 'medium' | 'large';\n\t\tondeleteImage?: (file: MediaBase | MediaImage) => void;\n\t\tonBulkDelete?: (files: (MediaBase | MediaImage)[]) => void;\n\t\tonBulkDownload?: (files: (MediaBase | MediaImage)[]) => void;\n\t\tonBulkEdit?: (files: (MediaBase | MediaImage)[], action: string, value: any) => void;\n\t\tonEditImage?: (file: MediaImage) => void;\n\t}\n\n\tconst {\n\t\tfilteredFiles = [],\n\t\tgridSize,\n\t\tondeleteImage = () => {},\n\t\tonBulkDelete = () => {},\n\t\tonBulkDownload = () => {},\n\t\tonBulkEdit = () => {},\n\t\tonEditImage = () => {}\n\t}: Props = $props();\n\n\t// Virtual scrolling state\n\tlet containerHeight = $state(600);\n\tlet scrollTop = $state(0);\n\tconst itemHeight = $derived(gridSize === 'tiny' ? 120 : gridSize === 'small' ? 160 : gridSize === 'medium' ? 280 : 400);\n\tlet itemsPerRow = $state(5);\n\tconst visibleRows = $derived(Math.ceil(containerHeight / itemHeight) + 2); // +2 for buffer\n\tconst totalRows = $derived(Math.ceil(filteredFiles.length / itemsPerRow));\n\tconst startRow = $derived(Math.max(0, Math.floor(scrollTop / itemHeight) - 1));\n\tconst endRow = $derived(Math.min(totalRows, startRow + visibleRows));\n\tconst visibleItems = $derived(filteredFiles.slice(startRow * itemsPerRow, endRow * itemsPerRow));\n\tconst paddingTop = $derived(startRow * itemHeight);\n\tconst paddingBottom = $derived((totalRows - endRow) * itemHeight);\n\n\t// Selection and operations state\n\tlet selectedFiles = $state<Set<string>>(new Set());\n\tlet isSelectionMode = $state(false);\n\tlet activePopup = $state<string | null>(null);\n\tlet showBulkEditModal = $state(false);\n\tlet bulkEditAction = $state<'rename' | 'move' | 'tag'>('tag');\n\tlet bulkEditValue = $state('');\n\n\t// Container ref\n\tlet container: HTMLDivElement;\n\n\t// Keyboard navigation state\n\t// let focusedIndex = $state(-1);\n\n\t// Drag-to-select state (Unused/Incomplete)\n\t// let isDragging = $state(false);\n\t// let selectionStart = $state<{x: number, y: number} | null>(null);\n\t// let selectionRect = $state<{left: number, top: number, width: number, height: number} | null>(null);\n\n\t// Context menu state (Unused/Incomplete)\n\t// let contextMenu = $state<{x: number, y: number, file: MediaBase | MediaImage | null} | null>(null);\n\n\t// Computed item width for selection math\n\t// const itemWidth = $derived(gridSize === 'tiny' ? 100 : gridSize === 'small' ? 140 : gridSize === 'medium' ? 260 : 380);\n\n\t// Handle keyboard navigation (Unused - connect to window or container if needed)\n\t/*\n    function handleKeyDown(e: KeyboardEvent) {\n        if (!container) return;\n        \n        // Ignore if searching or editing\n        if ((e.target as HTMLElement).tagName === 'INPUT' || (e.target as HTMLElement).tagName === 'TEXTAREA') return;\n\n        if (e.key === 'Delete' && selectedFiles.size > 0) {\n            // Trigger bulk delete\n             const filesToDelete = filteredFiles.filter(f => selectedFiles.has(f._id?.toString() || f.filename));\n             if(filesToDelete.length > 0) onBulkDelete(filesToDelete);\n        } else if (e.ctrlKey && e.key === 'a') {\n             e.preventDefault();\n             // Select All\n             const newSet = new Set<string>();\n             filteredFiles.forEach(f => newSet.add(f._id?.toString() || f.filename));\n             selectedFiles = newSet;\n        } else if (e.key === 'Escape') {\n             // Clear selection or context menu\n             if (contextMenu) contextMenu = null;\n             else selectedFiles = new Set();\n        } else if (e.key === 'ArrowRight') {\n            e.preventDefault();\n            focusedIndex = Math.min(filteredFiles.length - 1, focusedIndex + 1);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === 'ArrowLeft') {\n            e.preventDefault();\n            focusedIndex = Math.max(0, focusedIndex - 1);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === 'ArrowDown') {\n            e.preventDefault();\n            focusedIndex = Math.min(filteredFiles.length - 1, focusedIndex + itemsPerRow);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === 'ArrowUp') {\n            e.preventDefault();\n            focusedIndex = Math.max(0, focusedIndex - itemsPerRow);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === ' ' || e.key === 'Enter') {\n            e.preventDefault();\n            if (focusedIndex >= 0 && filteredFiles[focusedIndex]) {\n                 toggleSelection(filteredFiles[focusedIndex]);\n            }\n        }\n    }\n    */\n\n\t/*\n\tfunction scrollToIndex(index: number) {\n\t\tif (index < 0) return;\n\t\tconst row = Math.floor(index / itemsPerRow);\n\t\tconst top = row * itemHeight;\n\t\tconst bottom = top + itemHeight;\n\n\t\tif (top < scrollTop) {\n\t\t\tcontainer.scrollTop = top;\n\t\t} else if (bottom > scrollTop + container.clientHeight) {\n\t\t\tcontainer.scrollTop = bottom - container.clientHeight;\n\t\t}\n\t}\n\n\t// Drag Selection Logic (Unused)\n\t/*\n    function handleMouseDown(e: MouseEvent) {\n        // Ignore right click or if clicking on interactive elements\n        if (e.button !== 0 || (e.target as HTMLElement).closest('button') || (e.target as HTMLElement).closest('.interactive')) return;\n\n        // Clear context menu\n        contextMenu = null;\n\n        const rect = container.getBoundingClientRect();\n        const startX = e.clientX - rect.left + container.scrollLeft;\n        const startY = e.clientY - rect.top + container.scrollTop;\n\n        isDragging = true;\n        selectionStart = { x: startX, y: startY };\n        selectionRect = { left: startX, top: startY, width: 0, height: 0 };\n\n        // If not holding Ctrl/Shift, clear previous selection\n        if (!e.ctrlKey && !e.shiftKey) {\n            selectedFiles = new Set();\n        }\n    }\n\n    function handleMouseMove(e: MouseEvent) {\n        if (!isDragging || !selectionStart) return;\n\n        const rect = container.getBoundingClientRect();\n        const currentX = e.clientX - rect.left + container.scrollLeft;\n        const currentY = e.clientY - rect.top + container.scrollTop;\n\n        // Calculate selection box\n        const left = Math.min(selectionStart.x, currentX);\n        const top = Math.min(selectionStart.y, currentY);\n        const width = Math.abs(currentX - selectionStart.x);\n        const height = Math.abs(currentY - selectionStart.y);\n\n        selectionRect = { left, top, width, height };\n\n        // Select items intersecting with rect\n        // Optimization: only check items in relevant rows\n        const startRowIndex = Math.floor(top / itemHeight);\n        const endRowIndex = Math.floor((top + height) / itemHeight);\n        \n        // Temporary set for visual feedback during drag could be implemented, \n        // but for now we'll just update final selection on mouse up to avoid performance issues with 10k items\n        // OR we can do real-time selection if optimized.\n        // Let's do real-time selection update on a debounced set or just purely visual overlay for now?\n        // Actually, let's implement real-time selection for \"File Explorer\" feel.\n        selectItemsInRect(left, top, width, height, e.ctrlKey);\n    }\n\n    function handleMouseUp(e: MouseEvent) {\n        if (isDragging) {\n            isDragging = false;\n            selectionStart = null;\n            selectionRect = null;\n        }\n    }\n\n    function selectItemsInRect(left: number, top: number, width: number, height: number, preserveExisting: boolean) {\n         const newSet = preserveExisting ? new Set(selectedFiles) : new Set<string>();\n         \n         // Convert pixel rect to grid capacity\n         const startRowIdx = Math.max(0, Math.floor(top / itemHeight));\n         const endRowIdx = Math.min(totalRows - 1, Math.floor((top + height) / itemHeight));\n\n         for (let r = startRowIdx; r <= endRowIdx; r++) {\n             for (let c = 0; c < itemsPerRow; c++) {\n                 const index = r * itemsPerRow + c;\n                 if (index >= filteredFiles.length) break;\n\n                 // Calculate item rect\n                 // Note: Ideally use precise offsetLeft/Top if available, but math approximation works for uniform grid\n                 const itemLeft = c * itemWidth; // Approximation requires ensuring justify-start or similar\n                 const itemTop = r * itemHeight;\n                 \n                 // Intersection check\n                 if (\n                     left < itemLeft + itemWidth &&\n                     left + width > itemLeft &&\n                     top < itemTop + itemHeight &&\n                     top + height > itemTop\n                 ) {\n                     const file = filteredFiles[index];\n                     newSet.add(file._id?.toString() || file.filename);\n                 }\n             }\n         }\n         selectedFiles = newSet;\n    }\n\n    // Context Menu\n    function handleContextMenu(e: MouseEvent, file: MediaBase | MediaImage) {\n        e.preventDefault();\n        // If file not in selection, select it (exclusive)\n        const fileId = file._id?.toString() || file.filename;\n        if (!selectedFiles.has(fileId)) {\n            selectedFiles = new Set([fileId]);\n        }\n        \n        contextMenu = {\n            x: e.clientX,\n            y: e.clientY,\n            file\n        };\n    }\n    */\n\n\t// Calculate items per row based on container width\n\tfunction updateItemsPerRow() {\n\t\tif (!container) return;\n\t\tconst width = container.clientWidth;\n\t\tconst itemWidth = gridSize === 'tiny' ? 100 : gridSize === 'small' ? 140 : gridSize === 'medium' ? 260 : 380;\n\t\titemsPerRow = Math.max(1, Math.floor(width / itemWidth));\n\t}\n\n\t// Handle scroll\n\tfunction handleScroll(e: Event) {\n\t\tconst target = e.target as HTMLDivElement;\n\t\tscrollTop = target.scrollTop;\n\t}\n\n\t// Batch operations\n\tfunction toggleSelection(file: MediaBase | MediaImage) {\n\t\tconst fileId = file._id?.toString() || file.filename;\n\t\tif (selectedFiles.has(fileId)) {\n\t\t\tselectedFiles.delete(fileId);\n\t\t} else {\n\t\t\tselectedFiles.add(fileId);\n\t\t}\n\t\tselectedFiles = selectedFiles;\n\t}\n\n\tfunction selectAll() {\n\t\tselectedFiles = new Set(filteredFiles.map((f) => f._id?.toString() || f.filename));\n\t}\n\n\tfunction deselectAll() {\n\t\tselectedFiles = new Set();\n\t}\n\n\tfunction handleDelete(file: MediaBase | MediaImage) {\n\t\tondeleteImage(file);\n\t}\n\n\tfunction handleBulkDelete() {\n\t\tconst filesToDelete = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToDelete.length > 0) {\n\t\t\tonBulkDelete(filesToDelete);\n\t\t\tselectedFiles = new Set();\n\t\t\tisSelectionMode = false;\n\t\t}\n\t}\n\n\tfunction handleBulkDownload() {\n\t\tconst filesToDownload = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToDownload.length > 0) {\n\t\t\tonBulkDownload(filesToDownload);\n\t\t}\n\t}\n\n\tfunction openBulkEditModal(action: 'rename' | 'move' | 'tag') {\n\t\tbulkEditAction = action;\n\t\tshowBulkEditModal = true;\n\t}\n\n\tfunction applyBulkEdit() {\n\t\tconst filesToEdit = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToEdit.length > 0 && bulkEditValue.trim()) {\n\t\t\tonBulkEdit(filesToEdit, bulkEditAction, bulkEditValue);\n\t\t\tshowBulkEditModal = false;\n\t\t\tbulkEditValue = '';\n\t\t\tselectedFiles = new Set();\n\t\t\tisSelectionMode = false;\n\t\t}\n\t}\n\n\t// Lifecycle\n\tonMount(() => {\n\t\tupdateItemsPerRow();\n\t\tconst resizeObserver = new ResizeObserver(() => {\n\t\t\tupdateItemsPerRow();\n\t\t\tcontainerHeight = container.clientHeight;\n\t\t});\n\t\tresizeObserver.observe(container);\n\t\treturn () => resizeObserver.disconnect();\n\t});\n</script>\n\n<div class=\"flex h-full flex-col\">\n\t<!-- Batch Operations Toolbar -->\n\t<div class=\"mb-4 flex w-full flex-wrap items-center justify-between gap-2 rounded border border-surface-400 bg-surface-100 p-2 dark:bg-surface-700\">\n\t\t<div class=\"flex flex-wrap items-center gap-2\">\n\t\t\t<button\n\t\t\t\tonclick={() => {\n\t\t\t\t\tisSelectionMode = !isSelectionMode;\n\t\t\t\t\tselectedFiles = new Set();\n\t\t\t\t}}\n\t\t\t\tclass=\"preset-outline-surface-500 btn-sm\"\n\t\t\t\taria-label=\"Toggle selection mode\"\n\t\t\t>\n\t\t\t\t<iconify-icon icon={isSelectionMode ? 'mdi:close' : 'mdi:checkbox-multiple-marked'} width=\"20\"></iconify-icon>\n\t\t\t\t{isSelectionMode ? 'Cancel' : 'Select'}\n\t\t\t</button>\n\n\t\t\t{#if isSelectionMode}\n\t\t\t\t<button onclick={selectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:select-all\" width=\"20\"></iconify-icon>\n\t\t\t\t\tAll\n\t\t\t\t</button>\n\t\t\t\t<button onclick={deselectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:select-off\" width=\"20\"></iconify-icon>\n\t\t\t\t\tNone\n\t\t\t\t</button>\n\t\t\t{/if}\n\t\t</div>\n\n\t\t{#if selectedFiles.size > 0}\n\t\t\t<div class=\"flex flex-wrap items-center gap-2\">\n\t\t\t\t<span class=\"text-sm font-semibold\">{selectedFiles.size} selected</span>\n\n\t\t\t\t<button onclick={handleBulkDownload} class=\"preset-filled-primary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:download\" width=\"18\"></iconify-icon>\n\t\t\t\t\tDownload\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={() => openBulkEditModal('tag')} class=\"preset-filled-secondary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:tag-multiple\" width=\"18\"></iconify-icon>\n\t\t\t\t\tTag\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={() => openBulkEditModal('move')} class=\"preset-filled-secondary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:folder-move\" width=\"18\"></iconify-icon>\n\t\t\t\t\tMove\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={() => openBulkEditModal('rename')} class=\"preset-filled-secondary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:rename-box\" width=\"18\"></iconify-icon>\n\t\t\t\t\tRename\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={handleBulkDelete} class=\"preset-filled-error-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:delete\" width=\"18\"></iconify-icon>\n\t\t\t\t\tDelete\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n\n\t<!-- Virtual Scrolling Container -->\n\t<div bind:this={container} onscroll={handleScroll} class=\"flex-1 overflow-y-auto\" style=\"height: {containerHeight}px;\">\n\t\t{#if filteredFiles.length === 0}\n\t\t\t<div class=\"flex h-full items-center justify-center text-center text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t<div>\n\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-circle-fill\" height=\"44\" class=\"mb-2\"></iconify-icon>\n\t\t\t\t\t<p class=\"text-lg\">No media found</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{:else}\n\t\t\t<div style=\"padding-top: {paddingTop}px; padding-bottom: {paddingBottom}px;\">\n\t\t\t\t<div class=\"grid gap-4\" style=\"grid-template-columns: repeat({itemsPerRow}, 1fr);\">\n\t\t\t\t\t{#each visibleItems as file (file._id?.toString() || file.filename)}\n\t\t\t\t\t\t{@const fileId = file._id?.toString() || file.filename}\n\t\t\t\t\t\t{@const isSelected = selectedFiles.has(fileId)}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tonclick={() => isSelectionMode && toggleSelection(file)}\n\t\t\t\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\t\t\t\tif (isSelectionMode && (e.key === 'Enter' || e.key === ' ')) {\n\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\ttoggleSelection(file);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\tclass=\"card relative border border-surface-300 transition-all hover:shadow-lg dark:border-surface-500 {isSelected\n\t\t\t\t\t\t\t\t? 'ring-2 ring-primary-500'\n\t\t\t\t\t\t\t\t: ''}\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{#if isSelectionMode}\n\t\t\t\t\t\t\t\t<div class=\"absolute left-2 top-2 z-10\">\n\t\t\t\t\t\t\t\t\t<input type=\"checkbox\" checked={isSelected} onchange={() => toggleSelection(file)} class=\"checkbox\" aria-label=\"Select file\" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t\t<header class=\"m-2 flex w-auto items-center justify-between relative\">\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\tactivePopup = activePopup === fileId ? null : fileId;\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\taria-label=\"File Info\"\n\t\t\t\t\t\t\t\t\tclass=\"btn-icon\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"raphael:info\" width=\"20\" class=\"text-tertiary-500 dark:text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t\t\t{#if activePopup === fileId}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tclass=\"card preset-filled z-50 min-w-[250px] p-2 absolute left-8 top-0 shadow-xl\"\n\t\t\t\t\t\t\t\t\t\tonclick={(e) => e.stopPropagation()}\n\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => e.stopPropagation()}\n\t\t\t\t\t\t\t\t\t\trole=\"dialog\"\n\t\t\t\t\t\t\t\t\t\ttabindex=\"-1\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<table class=\" w-full table-auto text-xs\">\n\t\t\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t\t\t{#if 'width' in file && file.width && 'height' in file && file.height}\n\t\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Dimensions:</td><td>{file.width}x{file.height}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Size:</td><td>{formatBytes(file.size || 0)}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Type:</td><td>{file.mimeType || 'N/A'}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Hash:</td><td class=\"truncate\" title={file.hash}>{file.hash?.substring(0, 8) || 'N/A'}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t\t\t\t<!-- Close button for mobile/convenience -->\n\t\t\t\t\t\t\t\t\t\t<div class=\"flex justify-end mt-2\">\n\t\t\t\t\t\t\t\t\t\t\t<button class=\"btn-icon btn-icon-sm preset-filled-surface-500\" aria-label=\"Close\" onclick={() => (activePopup = null)}>\n\t\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"16\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t\t\t{#if !isSelectionMode}\n\t\t\t\t\t\t\t\t\t{#if file.type === 'image'}\n\t\t\t\t\t\t\t\t\t\t<button onclick={() => onEditImage(file as MediaImage)} aria-label=\"Edit\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:pen\" width=\"20\" class=\"text-tertiary-500 dark:text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t<button onclick={() => handleDelete(file)} aria-label=\"Delete\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:delete\" width=\"20\" class=\"text-error-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</header>\n\n\t\t\t\t\t\t\t<section class=\"flex items-center justify-center p-2\">\n\t\t\t\t\t\t\t\t{#if file?.filename && file?.url}\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={('thumbnails' in file ? file.thumbnails?.sm?.url : undefined) ?? file.url ?? '/static/Default_User.svg'}\n\t\t\t\t\t\t\t\t\t\talt={file.filename}\n\t\t\t\t\t\t\t\t\t\tclass={`rounded object-cover ${\n\t\t\t\t\t\t\t\t\t\t\tgridSize === 'tiny' ? 'h-16 w-16' : gridSize === 'small' ? 'h-24 w-24' : gridSize === 'medium' ? 'h-48 w-48' : 'h-80 w-80'\n\t\t\t\t\t\t\t\t\t\t}`}\n\t\t\t\t\t\t\t\t\t\tloading=\"lazy\"\n\t\t\t\t\t\t\t\t\t\tdecoding=\"async\"\n\t\t\t\t\t\t\t\t\t\tonerror={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\n\t\t\t\t\t\t\t\t\t\t\tif (target) {\n\t\t\t\t\t\t\t\t\t\t\t\ttarget.src = '/static/Default_User.svg';\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<div class=\"flex h-full w-full items-center justify-center bg-surface-200 dark:bg-surface-700\">\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-triangle-fill\" height=\"24\" class=\"text-warning-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</section>\n\n\t\t\t\t\t\t\t<footer class=\"p-2 text-sm\">\n\t\t\t\t\t\t\t\t<p class=\"truncate\" title={file.filename}>{file.filename}</p>\n\t\t\t\t\t\t\t\t<p class=\"text-xs text-gray-500\">{formatBytes(file.size || 0)}</p>\n\t\t\t\t\t\t\t\t<p class=\"text-xs text-gray-500\">{file.type || 'Unknown'}</p>\n\t\t\t\t\t\t\t</footer>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/each}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n\n\t<!-- Stats Footer -->\n\t<div class=\"mt-2 flex items-center justify-between border-t border-surface-400 bg-surface-100 px-4 py-2 text-sm dark:bg-surface-700\">\n\t\t<span>Showing {visibleItems.length} of {filteredFiles.length} files</span>\n\t\t<span>Virtual scrolling: {Math.round((visibleItems.length / filteredFiles.length) * 100)}% rendered</span>\n\t</div>\n</div>\n\n<!-- Bulk Edit Modal -->\n{#if showBulkEditModal}\n\t<div\n\t\tclass=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\"\n\t\tonclick={() => (showBulkEditModal = false)}\n\t\tonkeydown={(e) => {\n\t\t\tif (e.key === 'Escape') {\n\t\t\t\tshowBulkEditModal = false;\n\t\t\t}\n\t\t}}\n\t\trole=\"button\"\n\t\ttabindex=\"-1\"\n\t\taria-label=\"Close modal\"\n\t>\n\t\t<div\n\t\t\tclass=\"card w-full max-w-md p-6\"\n\t\t\tonclick={(e) => e.stopPropagation()}\n\t\t\tonkeydown={(e) => e.stopPropagation()}\n\t\t\trole=\"dialog\"\n\t\t\ttabindex=\"0\"\n\t\t\taria-labelledby=\"bulk-edit-title\"\n\t\t>\n\t\t\t<h3 id=\"bulk-edit-title\" class=\"mb-4 text-xl font-bold\">\n\t\t\t\tBulk {bulkEditAction === 'rename' ? 'Rename' : bulkEditAction === 'move' ? 'Move' : 'Tag'}\n\t\t\t</h3>\n\n\t\t\t<p class=\"mb-4 text-sm text-surface-600 dark:text-surface-50\">\n\t\t\t\t{selectedFiles.size} file{selectedFiles.size !== 1 ? 's' : ''} selected\n\t\t\t</p>\n\n\t\t\t<div class=\"mb-4\">\n\t\t\t\t<label class=\"label mb-2\" for=\"bulk-edit-input\">\n\t\t\t\t\t{#if bulkEditAction === 'rename'}\n\t\t\t\t\t\t<span>New name prefix (files will be numbered)</span>\n\t\t\t\t\t{:else if bulkEditAction === 'move'}\n\t\t\t\t\t\t<span>Destination folder</span>\n\t\t\t\t\t{:else}\n\t\t\t\t\t\t<span>Tags (comma-separated)</span>\n\t\t\t\t\t{/if}\n\t\t\t\t</label>\n\t\t\t\t<input\n\t\t\t\t\tid=\"bulk-edit-input\"\n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tbind:value={bulkEditValue}\n\t\t\t\t\tclass=\"input\"\n\t\t\t\t\tplaceholder={bulkEditAction === 'rename' ? 'image-' : bulkEditAction === 'move' ? '/folder/path' : 'tag1, tag2, tag3'}\n\t\t\t\t/>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex justify-end gap-2\">\n\t\t\t\t<button onclick={() => (showBulkEditModal = false)} class=\"preset-outline-surface-500 btn\">Cancel</button>\n\t\t\t\t<button onclick={applyBulkEdit} class=\"preset-filled-primary-500 btn\" disabled={!bulkEditValue.trim()}>Apply</button>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n{/if}\n\n<style>\n\t.grid {\n\t\tdisplay: grid;\n\t\tgap: 1rem;\n\t}\n</style>\n","/**\n * @file shared/image-editor/src/widgets/transformerConfig.ts\n * @description Shared transformer configuration for consistent styling\n *\n * All image editor widgets (Crop, Blur, Annotate, Watermark) should use these\n * shared styles for uniform appearance of resize handles and borders.\n */\nimport Konva from 'konva';\n\n/**\n * Unified transformer configuration\n * - Blue circular handles with white border\n * - Solid blue border around selection\n * - Consistent sizing across all widgets\n */\nexport const TRANSFORMER_STYLE_DEFAULT: Partial<Konva.TransformerConfig> = {\n\t// Handle appearance\n\tanchorFill: '#3b82f6', // Tailwind blue-500\n\tanchorStroke: '#ffffff',\n\tanchorStrokeWidth: 2,\n\tanchorSize: 12,\n\tanchorCornerRadius: 6, // Makes handles circular\n\n\t// Border appearance\n\tborderStroke: '#3b82f6',\n\tborderStrokeWidth: 2,\n\tborderDash: [] // Solid line\n};\n\n/**\n * Specialized style for Crop tool\n */\nexport const TRANSFORMER_STYLE_CROP: Partial<Konva.TransformerConfig> = {\n\t...TRANSFORMER_STYLE_DEFAULT,\n\tanchorFill: '#3b82f6',\n\tanchorStroke: '#ffffff',\n\tanchorSize: 14,\n\tanchorCornerRadius: 7, // Circular\n\tborderStroke: '#ffffff',\n\tborderStrokeWidth: 1.5\n};\n\n/**\n * Specialized style for Redact/Blur tool (White thin borders, blue handles)\n */\nexport const TRANSFORMER_STYLE_REDACT: Partial<Konva.TransformerConfig> = {\n\t...TRANSFORMER_STYLE_DEFAULT,\n\tborderStroke: '#ffffff',\n\tborderStrokeWidth: 1.5,\n\tanchorFill: '#3b82f6',\n\tanchorStroke: '#ffffff',\n\tanchorSize: 12,\n\tanchorCornerRadius: 6\n};\n\n/** Legacy alias to keep compatibility while transitioning */\nexport const TRANSFORMER_STYLE = TRANSFORMER_STYLE_DEFAULT;\n\n/**\n * Style for rule-of-thirds grid\n */\nexport const GRID_STYLE = {\n\tstroke: 'rgba(255, 255, 255, 0.4)',\n\tstrokeWidth: 1,\n\tlistening: false\n};\n\n/**\n * Default transformer behavior options\n */\nexport const TRANSFORMER_DEFAULTS: Partial<Konva.TransformerConfig> = {\n\tkeepRatio: true,\n\trotateEnabled: true,\n\trotationSnaps: [0, 90, 180, 270],\n\trotateAnchorOffset: 40,\n\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\tboundBoxFunc: (oldBox, newBox) => {\n\t\t// Minimum size constraint\n\t\tif (newBox.width < 20 || newBox.height < 20) return oldBox;\n\t\treturn newBox;\n\t}\n};\n\n/**\n * Creates a styled transformer with unified appearance.\n *\n * @param layer - Konva layer to add transformer to\n * @param options - Optional overrides for specific widget needs\n * @returns Configured Konva.Transformer\n *\n * @example\n * ```ts\n * const tr = createStyledTransformer(layer);\n * tr.nodes([myShape]);\n * ```\n */\nexport function createStyledTransformer(layer: Konva.Layer, options?: Partial<Konva.TransformerConfig>): Konva.Transformer {\n\tconst tr = new Konva.Transformer({\n\t\t...TRANSFORMER_STYLE,\n\t\t...TRANSFORMER_DEFAULTS,\n\t\t...options\n\t});\n\tlayer.add(tr);\n\ttr.moveToTop();\n\treturn tr;\n}\n\n/**\n * Safely attaches transformer to a node with error handling.\n *\n * @param tr - Konva transformer instance\n * @param node - Node to attach, or null to detach\n */\nexport function attachStyledTransformer(tr: Konva.Transformer, node?: Konva.Node | null): void {\n\ttry {\n\t\tif (!node) {\n\t\t\ttr.nodes([]);\n\t\t\ttr.hide();\n\t\t\treturn;\n\t\t}\n\t\ttr.nodes([node]);\n\t\ttr.show();\n\t\ttr.forceUpdate();\n\t\ttr.moveToTop();\n\t} catch {\n\t\ttry {\n\t\t\ttr.nodes([]);\n\t\t\ttr.hide();\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t}\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/transformer.ts\n * @description Transformer utilities for Annotate tool\n *\n * Re-exports shared transformer config for consistent styling across widgets.\n */\nimport Konva from 'konva';\nimport { createStyledTransformer, attachStyledTransformer } from '../transformerConfig';\n\n/**\n * Create a transformer for annotations with consistent styling.\n * Uses more anchors than other tools for flexible annotation resizing.\n */\nexport function createTransformer(layer: Konva.Layer): Konva.Transformer {\n\treturn createStyledTransformer(layer, {\n\t\tkeepRatio: false,\n\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right', 'middle-left', 'middle-right']\n\t});\n}\n\n/**\n * Re-export attach function for convenience\n */\nexport const attachTransformer = attachStyledTransformer;\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/events.ts\n * @description Event namespacing for Annotate tool\n *\n * Features:\n * - Namespacing events to avoid conflicts with other tools\n */\nexport const NS = 'annotate';\n// Namespacing events to avoid conflicts with other tools\nexport function names(event: string) {\n\treturn [`${event}.${NS}`, `${event}.annotate`].join(' ');\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Annotate/Tool.svelte\n@component\n**Annotate Tool \"Controller\"**\n\nOrchestrates the annotation lifecycle:\n- Manages the $state list of AnnotationItem instances\n- Handles stage drawing events (mousedown, mousemove, mouseup)\n- Manages the active selection and transformer\n- Registers the toolbar UI\n- Implements the critical 'apply' (bake) logic\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport AnnotateControls from './Controls.svelte';\n\timport { AnnotationItem, type AnnotationKind } from './regions';\n\timport * as draw from './draw';\n\timport { createTransformer, attachTransformer } from './transformer';\n\timport { enableTextEdit } from './editText';\n\timport { names } from './events';\n\n\t// --- Svelte 5 State ---\n\tlet transformer = $state<Konva.Transformer | null>(null);\n\tlet annotations = $state<AnnotationItem[]>([]);\n\tlet selected = $state<AnnotationItem | null>(null);\n\tlet currentTool = $state<AnnotationKind | null>(null);\n\tlet strokeColor = $state('#ff0000');\n\tlet fillColor = $state('transparent');\n\tlet strokeWidth = $state(2);\n\tlet fontSize = $state(20);\n\n\t// Drawing state machine\n\tlet isDrawing = $state(false);\n\tlet tempNode = $state<Konva.Node | null>(null);\n\tlet startPos = $state<{ x: number; y: number } | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// --- Lifecycle $effect ---\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'annotate') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: AnnotateControls,\n\t\t\t\tprops: {\n\t\t\t\t\tcurrentTool,\n\t\t\t\t\tstrokeColor,\n\t\t\t\t\tfillColor,\n\t\t\t\t\tonSetTool: (t: AnnotationKind | null) => {\n\t\t\t\t\t\tcurrentTool = t;\n\t\t\t\t\t\tdeselect(); // Deselect to allow drawing\n\t\t\t\t\t},\n\t\t\t\t\tonStrokeColorChange: (v: string) => {\n\t\t\t\t\t\tstrokeColor = v;\n\t\t\t\t\t\tselected?.node.setAttrs({ stroke: v });\n\t\t\t\t\t},\n\t\t\t\t\tonFillColorChange: (v: string) => {\n\t\t\t\t\t\tfillColor = v;\n\t\t\t\t\t\tselected?.node.setAttrs({ fill: v });\n\t\t\t\t\t},\n\t\t\t\t\tonDelete: () => deleteSelected(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === AnnotateControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\tif (!transformer) {\n\t\t\ttransformer = createTransformer(layer);\n\t\t}\n\t\tstage.on(names('mousedown'), onMouseDown);\n\t\tstage.on(names('mousemove'), onMouseMove);\n\t\tstage.on(names('mouseup'), onMouseUp);\n\t\tstage.on(names('click'), onStageClick);\n\t\tstage.on(names('dblclick'), onDblClick);\n\t\tstage.container().style.cursor = 'crosshair';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off(names('mousedown'));\n\t\tstage.off(names('mousemove'));\n\t\tstage.off(names('mouseup'));\n\t\tstage.off(names('click'));\n\t\tstage.off(names('dblclick'));\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\tdeselect();\n\t\tcurrentTool = null;\n\t\tisDrawing = false;\n\t\ttempNode = null;\n\t}\n\n\t// --- Drawing Handlers ---\n\tfunction onMouseDown(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\t// Don't draw if clicking on existing node\n\t\tif (e.target !== e.target.getStage()) return;\n\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer) return;\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\t\tif (!currentTool) return;\n\n\t\tdeselect();\n\t\tisDrawing = true;\n\t\tstartPos = pos;\n\n\t\tswitch (currentTool) {\n\t\t\tcase 'text': {\n\t\t\t\tconst txt = draw.createText(layer, pos.x, pos.y, 'Text', fontSize, strokeColor);\n\t\t\t\tconst item = finalizeNode(txt, 'text');\n\t\t\t\tselect(item);\n\t\t\t\tisDrawing = false; // Text is one-click\n\t\t\t\tcurrentTool = null; // Exit tool\n\t\t\t\tstartTextEdit(item.node as Konva.Text); // Immediately edit\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'rect':\n\t\t\t\ttempNode = draw.createRect(layer, pos.x, pos.y, 0, 0, strokeColor, fillColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'circle':\n\t\t\t\ttempNode = draw.createCircle(layer, pos.x, pos.y, 0, strokeColor, fillColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'line':\n\t\t\t\ttempNode = draw.createLine(layer, [pos.x, pos.y, pos.x, pos.y], strokeColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'arrow':\n\t\t\t\ttempNode = draw.createArrow(layer, [pos.x, pos.y, pos.x, pos.y], strokeColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tfunction onMouseMove() {\n\t\tif (!isDrawing || !tempNode || !startPos) return;\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer) return;\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\n\t\tif (tempNode instanceof Konva.Rect) {\n\t\t\ttempNode.width(pos.x - startPos.x);\n\t\t\ttempNode.height(pos.y - startPos.y);\n\t\t} else if (tempNode instanceof Konva.Circle) {\n\t\t\tconst r = Math.hypot(pos.x - startPos.x, pos.y - startPos.y);\n\t\t\ttempNode.radius(r);\n\t\t} else if (tempNode instanceof Konva.Line || tempNode instanceof Konva.Arrow) {\n\t\t\t(tempNode as Konva.Line).points([startPos.x, startPos.y, pos.x, pos.y]);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction onMouseUp() {\n\t\tif (!isDrawing || !tempNode || !currentTool) return;\n\t\tisDrawing = false;\n\n\t\t// Finalize node\n\t\tconst item = finalizeNode(tempNode, currentTool);\n\t\tselect(item);\n\n\t\ttempNode = null;\n\t\tcurrentTool = null;\n\t\tstartPos = null;\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\tfunction onStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tif (isDrawing || currentTool) return;\n\t\t// Deselect if clicking on stage background\n\t\tif (e.target === e.target.getStage()) {\n\t\t\tdeselect();\n\t\t}\n\t}\n\n\tfunction onDblClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tconst node = e.target;\n\t\tif (node instanceof Konva.Text) {\n\t\t\tconst item = annotations.find((a) => a.node === node);\n\t\t\tif (item) {\n\t\t\t\tselect(item);\n\t\t\t\tstartTextEdit(item.node as Konva.Text);\n\t\t\t}\n\t\t}\n\t}\n\n\t// --- Helper Functions ---\n\tfunction finalizeNode(node: Konva.Node, kind: AnnotationKind): AnnotationItem {\n\t\tconst { layer } = imageEditorStore.state;\n\t\tif (!layer) throw new Error('No layer');\n\t\tnode.name(`annotation-${kind}`);\n\t\tnode.draggable(true);\n\t\tconst item = new AnnotationItem(crypto.randomUUID(), node, layer, kind);\n\t\titem.onSelect(() => select(item));\n\t\tannotations = [...annotations, item];\n\t\treturn item;\n\t}\n\n\tfunction startTextEdit(textNode: Konva.Text) {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage) return;\n\t\ttextNode.hide();\n\t\ttransformer?.hide();\n\t\tenableTextEdit(stage, textNode, (newValue) => {\n\t\t\ttextNode.text(newValue);\n\t\t\ttextNode.show();\n\t\t\ttransformer?.show();\n\t\t\ttransformer?.forceUpdate();\n\t\t\timageEditorStore.state.layer?.batchDraw();\n\t\t});\n\t}\n\n\tfunction select(item: AnnotationItem) {\n\t\tselected = item;\n\t\tif (!transformer) return;\n\t\tattachTransformer(transformer, item.node);\n\t}\n\n\tfunction deselect() {\n\t\tselected = null;\n\t\tif (!transformer) return;\n\t\tattachTransformer(transformer, null);\n\t}\n\n\tfunction deleteSelected() {\n\t\tif (!selected) return;\n\t\tconst id = selected.id;\n\t\tselected.destroy();\n\t\tannotations = annotations.filter((a) => a.id !== id);\n\t\tselected = null;\n\t\tdeselect(); // Hides transformer\n\t}\n\n\tfunction cleanupAnnotations(destroy = true) {\n\t\tdeselect();\n\t\tisDrawing = false;\n\t\tcurrentTool = null;\n\t\ttempNode = null;\n\t\tif (destroy) {\n\t\t\t[...annotations].forEach((a) => a.destroy());\n\t\t\tannotations = [];\n\t\t} else {\n\t\t\t// Hide UI for baking\n\t\t\tannotations.forEach((a) => a.disableInteraction());\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t\tcleanupAnnotations(true);\n\t\t\ttransformer?.destroy();\n\t\t\ttransformer = null;\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/index.ts\n * @description Annotate tool for Konva\n *\n * Features:\n * - Text\n * - Rectangle\n * - Circle\n * - Line\n * - Arrow\n * - Text editing\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'annotate',\n\ttitle: 'Annotate',\n\ticon: 'mdi:draw',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","/**\n * @files src/routes/(app)/imageEditor/widgets/Blur/regions.ts\n * @description BlurRegion encapsulates Konva nodes, clip mapping, caching strategy,\n * and lifecycle for one blur/pixelate region.\n *\n * Features:\n * - Rectangle and ellipse shapes\n * - Blur and pixelate patterns\n * - Interactive resizing and dragging\n * - Caching strategy for performance\n * - Fast updates for interactive feel\n */\n\nimport Konva from 'konva';\nimport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\nexport type BlurShape = 'rectangle' | 'ellipse';\nexport type BlurPattern = 'blur' | 'pixelate';\nexport type RegionInit = { x?: number; y?: number; width?: number; height?: number; shape?: BlurShape; pattern?: BlurPattern; strength?: number };\n\n/**\n * BlurRegion encapsulates Konva nodes, clip mapping, caching strategy,\n * and lifecycle for one blur/pixelate region.\n */\nexport class BlurRegion {\n\tid: string;\n\tshapeNode: Konva.Rect | Konva.Ellipse;\n\toverlay: Konva.Image;\n\toverlayGroup: Konva.Group;\n\ttransformer?: Konva.Transformer;\n\ttoolbar?: Konva.Group;\n\tprivate layer: Konva.Layer;\n\tprivate imageNode: Konva.Image;\n\tprivate imageGroup: Konva.Group;\n\tprivate currentPattern: BlurPattern;\n\tprivate currentStrength: number;\n\n\tprivate _onSelect: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\tprivate _onClone: (() => void) | null = null;\n\n\t// cache debounce timer per-region\n\tprivate _cacheTimer: number | null = null;\n\n\tconstructor(opts: { id: string; layer: Konva.Layer; imageNode: Konva.Image; imageGroup: Konva.Group; init?: RegionInit }) {\n\t\tthis.id = opts.id;\n\t\tthis.layer = opts.layer;\n\t\tthis.imageNode = opts.imageNode;\n\t\tthis.imageGroup = opts.imageGroup;\n\t\tconst init = opts.init || {};\n\t\tthis.currentPattern = init.pattern || 'blur';\n\t\tthis.currentStrength = init.strength || 20;\n\n\t\tconst w = init.width ?? 160;\n\t\tconst h = init.height ?? 120;\n\n\t\t// Positing relative to imageGroup center (0,0 is group center usually)\n\t\t// But imageNode is at (-w/2, -h/2).\n\t\t// Let's place it at 0,0 (center of image)\n\t\tconst x = init.x ?? 0;\n\t\tconst y = init.y ?? 0;\n\n\t\t// create visible wireframe shape\n\t\tif (init.shape === 'ellipse') {\n\t\t\tthis.shapeNode = new Konva.Ellipse({\n\t\t\t\tx,\n\t\t\t\ty,\n\t\t\t\tradiusX: w / 2,\n\t\t\t\tradiusY: h / 2,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1.5,\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'blurShape'\n\t\t\t});\n\t\t} else {\n\t\t\tthis.shapeNode = new Konva.Rect({\n\t\t\t\tx: x - w / 2,\n\t\t\t\ty: y - h / 2,\n\t\t\t\twidth: w,\n\t\t\t\theight: h,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1.5,\n\t\t\t\tfill: 'rgba(59, 130, 246, 0.2)', // style blue selection\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'blurShape'\n\t\t\t});\n\t\t}\n\t\tthis.shapeNode.id(this.id);\n\t\t// ADD SHAPE TO GROUP\n\t\tthis.imageGroup.add(this.shapeNode);\n\n\t\t// create overlay image (ideally a clone of current state)\n\t\tthis.overlay = new Konva.Image({\n\t\t\timage: this.imageNode.image(),\n\t\t\tlistening: false,\n\t\t\tname: 'blurOverlay',\n\t\t\t// Copy all visual attributes from the main image node\n\t\t\tx: this.imageNode.x(),\n\t\t\ty: this.imageNode.y(),\n\t\t\twidth: this.imageNode.width(),\n\t\t\theight: this.imageNode.height(),\n\t\t\tscaleX: this.imageNode.scaleX(),\n\t\t\tscaleY: this.imageNode.scaleY(),\n\t\t\trotation: this.imageNode.rotation(),\n\t\t\tcornerRadius: this.imageNode.cornerRadius()\n\t\t});\n\n\t\t// Create Group for clipping\n\t\tthis.overlayGroup = new Konva.Group({ listening: false });\n\t\tthis.overlayGroup.add(this.overlay);\n\n\t\t// ensure no filters initially\n\t\tthis.overlay.filters([]);\n\t\t// install clipFunc on GROUP\n\t\tthis.overlayGroup.clipFunc(this.makeClipFunc());\n\t\tthis.imageGroup.add(this.overlayGroup);\n\n\t\t// set predictable zIndex ordering within group\n\t\tthis.imageNode.zIndex(0);\n\t\tthis.overlayGroup.zIndex(1);\n\t\tthis.shapeNode.zIndex(2); // Shape node is now in imageGroup\n\t\tthis.layer.batchDraw();\n\n\t\t// bind events (fast updates only)\n\t\tthis.shapeNode.on('dragmove transform', () => {\n\t\t\tthis.updateToolbarPosition();\n\t\t\tthis.updateOverlayClip();\n\t\t\tthis.layer.batchDraw();\n\t\t});\n\n\t\t// Trigger initial pattern/strength for immediate feedback\n\t\tthis.setPattern(this.currentPattern);\n\t\tthis.setStrength(this.currentStrength);\n\t\tthis.shapeNode.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onSelect?.();\n\t\t});\n\t}\n\n\t// Update toolbar position (local space within imageGroup)\n\tprivate updateToolbarPosition() {\n\t\tif (!this.toolbar) return;\n\t\tconst n = this.shapeNode;\n\n\t\tlet localPt = { x: 0, y: 0 };\n\t\tif (n instanceof Konva.Rect) {\n\t\t\t// Bottom center of rect\n\t\t\tlocalPt = { x: n.width() / 2, y: n.height() + 20 };\n\t\t} else {\n\t\t\t// Bottom center of ellipse (radiusY is half-height)\n\t\t\tlocalPt = { x: 0, y: (n as Konva.Ellipse).radiusY() + 20 };\n\t\t}\n\n\t\t// Transform local point to parent (imageGroup) space\n\t\t// This accounts for rotation, scaling, and position of the shape\n\t\tconst pos = n.getTransform().point(localPt);\n\n\t\tthis.toolbar.position(pos);\n\t\tthis.toolbar.rotation(n.rotation());\n\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// Update overlay clip and cache (local group logic)\n\tprivate updateOverlayClip() {\n\t\t// Both shape and overlay are in imageGroup, at same root level\n\t\t// They share the same coordinate system.\n\t\tconst bounds = this.shapeNode.getSelfRect();\n\n\t\t// Buffer for the blur radius\n\t\tconst padding = this.currentStrength * 2;\n\n\t\t// Since overlay and shape are siblings in imageGroup,\n\t\t// and overlay is matched to imageNode position...\n\t\t// We need the shape relative to overlay.\n\t\tconst x = this.shapeNode.x() - this.overlay.x();\n\t\tconst y = this.shapeNode.y() - this.overlay.y();\n\n\t\tconst cacheRect = {\n\t\t\tx: x - padding,\n\t\t\ty: y - padding,\n\t\t\twidth: bounds.width + padding * 2,\n\t\t\theight: bounds.height + padding * 2\n\t\t};\n\n\t\tif (this._cacheTimer) window.clearTimeout(this._cacheTimer);\n\t\tthis._cacheTimer = window.setTimeout(() => {\n\t\t\ttry {\n\t\t\t\tthis.overlayGroup.clearCache();\n\t\t\t\tthis.overlayGroup.cache(cacheRect);\n\t\t\t\tthis.layer.batchDraw();\n\t\t\t} catch (e) {\n\t\t\t\t/* ignore cache errors */\n\t\t\t}\n\t\t\tthis._cacheTimer = null;\n\t\t}, 0);\n\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// create a clipFunc (local sibling logic)\n\tprivate makeClipFunc(): (ctx: CanvasRenderingContext2D) => void {\n\t\tconst shape = this.shapeNode;\n\t\t// const overlay = this.overlay;\n\t\treturn (ctx: CanvasRenderingContext2D) => {\n\t\t\t// They are siblings in imageGroup.\n\t\t\t// Offset shape's local transform by overlay's position.\n\t\t\tconst tr = shape.getTransform().copy();\n\t\t\t// tr.translate(-overlay.x(), -overlay.y()); // No longer needed as overlayGroup is at 0,0 relative to imageGroup parent\n\n\t\t\tconst m = tr.m;\n\t\t\tctx.setTransform(m[0], m[1], m[2], m[3], m[4], m[5]);\n\n\t\t\tif (shape instanceof Konva.Ellipse) {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.ellipse(0, 0, shape.radiusX(), shape.radiusY(), 0, 0, Math.PI * 2);\n\t\t\t\tctx.closePath();\n\t\t\t} else {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.rect(0, 0, shape.width(), shape.height());\n\t\t\t\tctx.closePath();\n\t\t\t}\n\t\t};\n\t}\n\n\t// set filter pattern and perform necessary re-cache (slow)\n\tsetPattern(pattern: BlurPattern) {\n\t\tthis.currentPattern = pattern;\n\t\tthis.overlay.filters([]);\n\t\tif (pattern === 'blur') {\n\t\t\tthis.overlay.filters([Konva.Filters.Blur]);\n\t\t} else {\n\t\t\tthis.overlay.filters([Konva.Filters.Pixelate]);\n\t\t}\n\t\tthis.setStrength(this.currentStrength);\n\t\tthis.updateOverlayClip(); // Triggers re-cache\n\t}\n\n\t// apply strength (fast)\n\tsetStrength(strength: number) {\n\t\tthis.currentStrength = strength;\n\t\tif (this.currentPattern === 'blur') {\n\t\t\tthis.overlay.blurRadius(strength);\n\t\t} else {\n\t\t\tthis.overlay.pixelSize(Math.max(1, Math.round(strength / 2)));\n\t\t}\n\t\tthis.updateOverlayClip(); // Fast debounce cache\n\t}\n\n\t// fast resize during drawing (no cache)\n\tresizeFromStart(start: { x: number; y: number }, pos: { x: number; y: number }) {\n\t\tconst width = pos.x - start.x;\n\t\tconst height = pos.y - start.y;\n\t\tif (this.shapeNode instanceof Konva.Ellipse) {\n\t\t\tthis.shapeNode.setAttrs({\n\t\t\t\tx: start.x + width / 2,\n\t\t\t\ty: start.y + height / 2,\n\t\t\t\tradiusX: Math.abs(width / 2),\n\t\t\t\tradiusY: Math.abs(height / 2)\n\t\t\t});\n\t\t} else {\n\t\t\tthis.shapeNode.setAttrs({\n\t\t\t\tx: width > 0 ? start.x : pos.x,\n\t\t\t\ty: height > 0 ? start.y : pos.y,\n\t\t\t\twidth: Math.abs(width),\n\t\t\t\theight: Math.abs(height)\n\t\t\t});\n\t\t}\n\t}\n\n\t// finalize region and attach a transformer (fast)\n\tfinalize() {\n\t\tthis.transformer = new Konva.Transformer({\n\t\t\tnodes: [this.shapeNode],\n\t\t\t// EXPLICIT HANDLES - Blue Circles\n\t\t\tanchorFill: '#3b82f6',\n\t\t\tanchorStroke: '#ffffff',\n\t\t\tanchorStrokeWidth: 2,\n\t\t\tanchorSize: 12, // Standard size\n\t\t\tanchorCornerRadius: 6,\n\n\t\t\t// EXPLICIT BORDER - Solid White\n\t\t\tborderStroke: '#ffffff',\n\t\t\tborderStrokeWidth: 1.5,\n\t\t\tborderDash: [],\n\n\t\t\trotateEnabled: true,\n\t\t\trotationSnaps: [0, 45, 90, 135, 180, 225, 270, 315],\n\t\t\trotateAnchorOffset: 25,\n\t\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\t\t\tkeepRatio: false,\n\t\t\tignoreStroke: true,\n\t\t\tboundBoxFunc: (oldBox, newBox) => {\n\t\t\t\treturn newBox.width < 10 || newBox.height < 10 ? oldBox : newBox;\n\t\t\t}\n\t\t});\n\t\tthis.transformer.on('dragend transformend', () => {\n\t\t\timageEditorStore.takeSnapshot();\n\t\t});\n\n\t\tthis.imageGroup.add(this.transformer); // ADDED TO GROUP\n\t\tthis.transformer.moveToTop();\n\n\t\t// Add dragend/transformend to take snapshot\n\t\tthis.shapeNode.on('dragend transformend', () => {\n\t\t\timageEditorStore.takeSnapshot();\n\t\t});\n\n\t\t// Create toolbar above the region\n\t\tthis.createToolbar();\n\t}\n\n\t// Create toolbar with clone/delete icons\n\tprivate createToolbar() {\n\t\tif (this.toolbar) this.toolbar.destroy();\n\n\t\tconst bounds = this.shapeNode.getClientRect();\n\t\tconst toolbarY = bounds.y - 45;\n\t\tconst toolbarX = bounds.x + bounds.width / 2;\n\n\t\tthis.toolbar = new Konva.Group({\n\t\t\tx: toolbarX,\n\t\t\ty: toolbarY,\n\t\t\tname: 'blurToolbar'\n\t\t});\n\n\t\t// Background\n\t\tconst bg = new Konva.Rect({\n\t\t\tx: -45,\n\t\t\ty: 0,\n\t\t\twidth: 90,\n\t\t\theight: 36,\n\t\t\tfill: '#1f2937',\n\t\t\tcornerRadius: 8,\n\t\t\tshadowColor: 'black',\n\t\t\tshadowBlur: 10,\n\t\t\tshadowOpacity: 0.4\n\t\t});\n\t\tthis.toolbar.add(bg);\n\n\t\t// Add icon (Plus)\n\t\tconst addGroup = new Konva.Group({ x: -22, y: 18, cursor: 'pointer' });\n\t\taddGroup.add(\n\t\t\tnew Konva.Path({\n\t\t\t\tdata: 'M12 4v16m8-8H4',\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 2,\n\t\t\t\tlineCap: 'round',\n\t\t\t\tscale: { x: 0.8, y: 0.8 },\n\t\t\t\toffset: { x: 12, y: 12 }\n\t\t\t})\n\t\t);\n\t\taddGroup.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onClone?.();\n\t\t});\n\t\taddGroup.on('mouseenter', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'pointer';\n\t\t});\n\t\taddGroup.on('mouseleave', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'crosshair';\n\t\t});\n\t\tthis.toolbar.add(addGroup);\n\n\t\t// Delete icon (Trash)\n\t\tconst deleteGroup = new Konva.Group({ x: 22, y: 18, cursor: 'pointer' });\n\t\tdeleteGroup.add(\n\t\t\tnew Konva.Path({\n\t\t\t\tdata: 'M3 6h18M9 6v12M15 6v12M5 6v14a2 2 0 002 2h10a2 2 0 002-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2',\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 2,\n\t\t\t\tscale: { x: 0.7, y: 0.7 },\n\t\t\t\toffset: { x: 12, y: 12 }\n\t\t\t})\n\t\t);\n\t\tdeleteGroup.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis.destroy();\n\t\t});\n\t\tdeleteGroup.on('mouseenter', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'pointer';\n\t\t});\n\t\tdeleteGroup.on('mouseleave', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'crosshair';\n\t\t});\n\t\tthis.toolbar.add(deleteGroup);\n\n\t\tthis.imageGroup.add(this.toolbar); // ADDED TO GROUP\n\t\tthis.toolbar.zIndex(10);\n\t\tthis.updateToolbarPosition();\n\t}\n\n\t// detect tiny regions\n\tisTooSmall(): boolean {\n\t\tconst n = this.shapeNode;\n\t\tif (n instanceof Konva.Ellipse) return n.radiusX() < 10 || n.radiusY() < 10;\n\t\treturn n.width() < 20 || n.height() < 20;\n\t}\n\n\t// set active UI state\n\tsetActive(isActive: boolean) {\n\t\tif (this.transformer) this.transformer.visible(isActive);\n\t\tif (this.toolbar) this.toolbar.visible(isActive);\n\t\tif (isActive) {\n\t\t\tthis.transformer?.moveToTop();\n\t\t\tthis.toolbar?.moveToTop();\n\t\t\tthis.updateToolbarPosition();\n\t\t}\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// hide UI but keep overlay for baking\n\thideUI() {\n\t\tthis.transformer?.visible(false);\n\t\tthis.toolbar?.visible(false);\n\t\tthis.shapeNode.visible(false);\n\t}\n\n\t// clone overlay and its clipFunc for offscreen baking\n\tcloneForBake(): Konva.Group | null {\n\t\ttry {\n\t\t\tconst c = this.overlayGroup.clone();\n\t\t\treturn c;\n\t\t} catch (e) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tpublic rotate(deg: number) {\n\t\tthis.shapeNode.rotate(deg);\n\t\tthis.updateToolbarPosition();\n\t\tthis.updateOverlayClip();\n\t\tthis.layer.batchDraw();\n\t}\n\n\tpublic flipX() {\n\t\tthis.shapeNode.scaleX(this.shapeNode.scaleX() * -1);\n\t\tthis.updateToolbarPosition();\n\t\tthis.updateOverlayClip();\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// explicit destruction with listener removal\n\tdestroy() {\n\t\tthis.shapeNode.off('dragmove transform click tap');\n\t\tthis.transformer?.destroy();\n\t\tthis.toolbar?.destroy();\n\t\tthis.overlayGroup.destroy();\n\t\tthis.shapeNode.destroy();\n\t\tthis._onDestroy?.();\n\t}\n\n\t// callbacks\n\tonSelect(cb: () => void) {\n\t\tthis._onSelect = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n\tonClone(cb: () => void) {\n\t\tthis._onClone = cb;\n\t}\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Blur/Tool.svelte\n@component\nController for Blur tool: binds stage, manages BlurRegion instances,\nhandles drawing, applies/bakes effects, and registers toolbar.\n-->\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport Controls from './Controls.svelte';\n\timport { BlurRegion, type RegionInit, type BlurPattern, type BlurShape } from './regions';\n\n\t// reactive tool state (Svelte 5 runes)\n\tlet blurStrength = $state(20);\n\tlet pattern = $state<BlurPattern>('blur');\n\tlet shape = $state<BlurShape>('rectangle');\n\tlet regions = $state<BlurRegion[]>([]);\n\tlet activeId = $state<string | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// debounce timer for strength slider updates\n\tlet strengthDebounceTimer: number | null = null;\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'blur') {\n\t\t\tbindStageEvents();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: Controls,\n\t\t\t\tprops: {\n\t\t\t\t\tblurStrength,\n\t\t\t\t\tpattern,\n\t\t\t\t\tshape,\n\t\t\t\t\tonAdd: undefined, // Remove duplicates\n\t\t\t\t\tonDelete: undefined, // Remove duplicates\n\t\t\t\t\tonStrengthChange: (v: number) => {\n\t\t\t\t\t\tblurStrength = v;\n\t\t\t\t\t\tif (strengthDebounceTimer) clearTimeout(strengthDebounceTimer);\n\t\t\t\t\t\tstrengthDebounceTimer = window.setTimeout(() => {\n\t\t\t\t\t\t\t// ALWAYS update activeId if exists, or all regions\n\t\t\t\t\t\t\tif (activeId) {\n\t\t\t\t\t\t\t\tregions.find((r) => r.id === activeId)?.setStrength(v);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tregions.forEach((r) => r.setStrength(v));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\timageEditorStore.state.layer?.batchDraw();\n\t\t\t\t\t\t}, 30); // Fast feedback\n\t\t\t\t\t},\n\t\t\t\t\tonPatternChange: (p: BlurPattern) => {\n\t\t\t\t\t\tpattern = p;\n\t\t\t\t\t\tregions.forEach((r) => r.setPattern(p));\n\t\t\t\t\t},\n\t\t\t\t\tonShapeChange: (s: BlurShape) => {\n\t\t\t\t\t\tshape = s;\n\t\t\t\t\t\t// If there's an active region, change its shape\n\t\t\t\t\t\tif (activeId) {\n\t\t\t\t\t\t\tconst r = regions.find((x) => x.id === activeId);\n\t\t\t\t\t\t\tif (r) {\n\t\t\t\t\t\t\t\t// Remove old region and create new one with same position but new shape\n\t\t\t\t\t\t\t\tconst oldShape = r.shapeNode;\n\t\t\t\t\t\t\t\tconst bounds = oldShape.getClientRect();\n\t\t\t\t\t\t\t\tdeleteRegion(r.id);\n\t\t\t\t\t\t\t\tcreateRegion({\n\t\t\t\t\t\t\t\t\tx: bounds.x,\n\t\t\t\t\t\t\t\t\ty: bounds.y,\n\t\t\t\t\t\t\t\t\twidth: bounds.width,\n\t\t\t\t\t\t\t\t\theight: bounds.height,\n\t\t\t\t\t\t\t\t\tshape: s\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t// NEW: Add, Delete, Rotate, Flip handlers\n\t\t\t\t\tonAddRegion: () => {\n\t\t\t\t\t\tconst stage = imageEditorStore.state.stage;\n\t\t\t\t\t\tconst x = stage ? stage.width() / 2 : 100;\n\t\t\t\t\t\tconst y = stage ? stage.height() / 2 : 100;\n\t\t\t\t\t\tcreateRegion({ x, y });\n\t\t\t\t\t},\n\t\t\t\t\tonDeleteRegion: () => {\n\t\t\t\t\t\tif (activeId) deleteRegion(activeId);\n\t\t\t\t\t},\n\t\t\t\t\tonRotateLeft: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.rotate(-90);\n\t\t\t\t\t},\n\t\t\t\t\tonRotateRight: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.rotate(90);\n\t\t\t\t\t},\n\t\t\t\t\tonFlipHorizontal: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.flipX();\n\t\t\t\t\t},\n\t\t\t\t\tonReset: () => reset(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: apply\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindStageEvents();\n\t\t\t// only clear toolbar if ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === Controls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// Auto-initialize first region if empty\n\t$effect(() => {\n\t\tif (_toolBound && regions.length === 0) {\n\t\t\tcreateRegion();\n\t\t}\n\t});\n\n\t// add stage event listeners once\n\tfunction bindStageEvents() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || _toolBound) return;\n\t\tstage.on('click tap', handleStageClick);\n\t\tif (stage.container()) stage.container().style.cursor = 'crosshair';\n\t\t_toolBound = true;\n\t}\n\n\t// remove stage event listeners once\n\tfunction unbindStageEvents() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\tstage.off('click tap', handleStageClick);\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\t_toolBound = false;\n\t}\n\n\t// deselect all regions when clicking outside overlays\n\tfunction handleStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tconst t = e.target;\n\t\tif (!stage) return;\n\t\t// If clicking on stage, base image, or its group - create a new region\n\t\tif (t === stage || t === imageNode || t === imageGroup) {\n\t\t\tconst pos = stage.getPointerPosition();\n\t\t\tif (pos) {\n\t\t\t\t// Create a new region at click position with default size\n\t\t\t\tcreateRegion({\n\t\t\t\t\tx: pos.x - 100,\n\t\t\t\t\ty: pos.y - 75,\n\t\t\t\t\twidth: 200,\n\t\t\t\t\theight: 150,\n\t\t\t\t\tshape\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t// create a new region and wire lifecycle hooks\n\tfunction createRegion(init?: Partial<RegionInit>) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\tconst newR = new BlurRegion({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageNode,\n\t\t\timageGroup,\n\t\t\tinit: { shape, pattern, strength: blurStrength, ...init }\n\t\t});\n\n\t\tregions = [...regions, newR];\n\t\tactiveId = newR.id;\n\n\t\tnewR.onSelect(() => selectRegion(newR.id));\n\t\tnewR.onClone(() => {\n\t\t\tconst bounds = newR.shapeNode.getClientRect();\n\t\t\tcreateRegion({\n\t\t\t\tx: bounds.x + 20,\n\t\t\t\ty: bounds.y + 20,\n\t\t\t\twidth: bounds.width,\n\t\t\t\theight: bounds.height,\n\t\t\t\tshape: newR.shapeNode instanceof Konva.Ellipse ? 'ellipse' : 'rectangle',\n\t\t\t\tpattern: pattern,\n\t\t\t\tstrength: blurStrength\n\t\t\t});\n\t\t});\n\t\tnewR.onDestroy(() => {\n\t\t\tregions = regions.filter((x) => x.id !== newR.id);\n\t\t\tif (activeId === newR.id) activeId = null;\n\t\t});\n\n\t\t// Always finalize and apply effects for click-created regions\n\t\tnewR.setPattern(pattern);\n\t\tnewR.setStrength(blurStrength);\n\t\tnewR.finalize();\n\n\t\t// Make the new region active to show handles\n\t\tselectRegion(newR.id);\n\t}\n\n\t// make specified region active and hide others\n\tfunction selectRegion(id: string) {\n\t\tactiveId = id;\n\t\tregions.forEach((r) => r.setActive(r.id === id));\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// delete a region instance\n\tfunction deleteRegion(id: string) {\n\t\tconst r = regions.find((x) => x.id === id);\n\t\tr?.destroy();\n\t}\n\n\t// hide or destroy all regions (used before bake and during reset)\n\tfunction cleanupBlurElements(destroyRegions = true) {\n\t\tif (destroyRegions) {\n\t\t\t[...regions].forEach((region) => region.destroy());\n\t\t\tregions = [];\n\t\t} else {\n\t\t\tregions.forEach((region) => region.hideUI());\n\t\t}\n\t\tactiveId = null;\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// reset tool state and remove regions\n\texport function reset() {\n\t\tcleanupBlurElements(true);\n\t}\n\n\t// Apply blur: bake all blur regions into the image\n\texport function apply() {\n\t\t// Hide UI elements before baking\n\t\tcleanupBlurElements(false);\n\n\t\t// Take snapshot with blur regions visible\n\t\timageEditorStore.takeSnapshot();\n\n\t\t// Clean up and exit\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// cleanup invoked by parent store\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindStageEvents();\n\t\t\tcleanupBlurElements(true);\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Blur/index.ts\n * @description Blur tool for Konva\n *\n * Features:\n * - Blur\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'blur',\n\ttitle: 'Blur',\n\ticon: 'mdi:blur',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Crop/Tool.svelte\n@component\n**Crop Tool \"Controller\"**\n\nOrchestrates the CropRegion, handles rotations/flips,\nand implements the correct 'apply' logic by setting the\nimageNode's 'crop' properties.\n-->\n<script lang=\"ts\">\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport CropControls from './Controls.svelte';\n\timport CropRegion, { type CropShape } from './regions';\n\timport { showToast } from '@shared/utils/toast';\n\n\tlet cropShape = $state<CropShape>('rectangle');\n\tlet aspectRatio = $state('free');\n\n\t// This is the *only* region. We don't use an array for crop.\n\tlet region = $state<CropRegion | null>(null);\n\n\tconst { onCancel }: { onCancel: () => void } = $props();\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'crop') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: CropControls,\n\t\t\t\tprops: {\n\t\t\t\t\tcropShape,\n\t\t\t\t\tonRotateLeft: rotateLeft,\n\t\t\t\t\tonRotateRight: rotateRight,\n\t\t\t\t\tonFlipHorizontal: flipHorizontal,\n\t\t\t\t\tonCropShapeChange: (s: CropShape) => {\n\t\t\t\t\t\tcropShape = s;\n\t\t\t\t\t\tif (s === 'square' || s === 'circular') {\n\t\t\t\t\t\t\taspectRatio = '1:1';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (s === 'circular') {\n\t\t\t\t\t\t\tshowToast('Round Crop selected. Image will be saved with transparency.', 'info');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tinitDefaultRegion();\n\t\t\t\t\t},\n\t\t\t\t\tonAspectRatio: (r: number | null) => {\n\t\t\t\t\t\taspectRatio = r === null ? 'free' : `${r}`;\n\t\t\t\t\t\tif (r === 1) {\n\t\t\t\t\t\t\tcropShape = cropShape === 'circular' ? 'circular' : 'square';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcropShape = 'rectangle';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tinitDefaultRegion();\n\t\t\t\t\t},\n\t\t\t\t\tonApply: apply,\n\t\t\t\t\tonCancel: () => onCancel()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\t// Only clear controls if they are ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === CropControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// add stage event listeners once\n\tfunction bindTool() {\n\t\tif (_toolBound) return;\n\t\t_toolBound = true;\n\t\t// Initialize the crop region when tool is activated\n\t\tinitDefaultRegion();\n\t}\n\n\t// remove stage event listeners once\n\tfunction unbindTool() {\n\t\tif (!_toolBound) return;\n\t\t_toolBound = false;\n\t\tcleanup(); // Destroy region when tool is deactivated\n\t}\n\n\t// create a new region and wire lifecycle hooks\n\tfunction initDefaultRegion() {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\t// Clean up old region first\n\t\tif (region) {\n\t\t\tregion.destroy();\n\t\t\tregion = null;\n\t\t}\n\n\t\tconst newRegion = new CropRegion({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageNode,\n\t\t\timageGroup,\n\t\t\tinit: { shape: cropShape as CropShape, aspect: aspectRatio }\n\t\t});\n\n\t\t// Wire event to update cutout on drag/transform\n\t\t// ** FIX 1: This is the 'desync' fix **\n\t\tnewRegion.onTransform(() => {\n\t\t\tnewRegion.updateCutout(false); // fast update, no cache\n\t\t});\n\t\tnewRegion.onTransformEnd(() => {\n\t\t\tnewRegion.updateCutout(true); // slow update, with cache\n\t\t});\n\n\t\tnewRegion.attachTransformer();\n\t\tregion = newRegion;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateLeft() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\t// Get current rotation and add -90\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation - 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipHorizontal() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleX(imageGroup.scaleX() * -1);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateRight() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\t// Get current rotation and add +90\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation + 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\t// Apply crop: calculate the crop rect and set it on the imageNode\n\tfunction apply() {\n\t\tconst { imageNode, imageGroup, layer, stage } = imageEditorStore.state;\n\t\tif (!imageNode || !imageGroup || !region || !layer || !stage) return;\n\n\t\t// Import the cropMath utility\n\t\timport('./cropMath').then(({ stageRectToImageRect }) => {\n\t\t\t// Get the crop region's bounding box in stage coordinates\n\t\t\tconst cropRect = region!.shape.getClientRect();\n\n\t\t\t// Convert to image-local coordinates\n\t\t\tconst imageCrop = stageRectToImageRect(cropRect, imageNode, imageGroup);\n\n\t\t\t// Apply crop to the image node\n\t\t\timageNode.cropX(imageCrop.x);\n\t\t\timageNode.cropY(imageCrop.y);\n\t\t\timageNode.cropWidth(imageCrop.width);\n\t\t\timageNode.cropHeight(imageCrop.height);\n\n\t\t\t// Update image dimensions to match crop\n\t\t\timageNode.width(imageCrop.width);\n\t\t\timageNode.height(imageCrop.height);\n\n\t\t\t// Reset image position to center within the group\n\t\t\timageNode.x(-imageCrop.width / 2);\n\t\t\timageNode.y(-imageCrop.height / 2);\n\n\t\t\t// Handle round crop transparency\n\t\t\tif (cropShape === 'circular') {\n\t\t\t\timageNode.cornerRadius(Math.max(imageCrop.width, imageCrop.height));\n\t\t\t} else {\n\t\t\t\timageNode.cornerRadius(0);\n\t\t\t}\n\n\t\t\t// Recalculate scale to fit the cropped image in the viewport\n\t\t\tconst containerWidth = stage.width();\n\t\t\tconst containerHeight = stage.height();\n\t\t\tconst scaleX = (containerWidth * 0.8) / imageCrop.width;\n\t\t\tconst scaleY = (containerHeight * 0.8) / imageCrop.height;\n\t\t\tconst newScale = Math.min(scaleX, scaleY);\n\n\t\t\t// Reset imageGroup transform\n\t\t\timageGroup.scaleX(newScale);\n\t\t\timageGroup.scaleY(newScale);\n\t\t\timageGroup.rotation(0); // Reset rotation\n\t\t\timageGroup.x(containerWidth / 2);\n\t\t\timageGroup.y(containerHeight / 2);\n\n\t\t\t// Hide the crop UI\n\t\t\tregion!.hideUI();\n\n\t\t\t// Redraw and take snapshot\n\t\t\tlayer.batchDraw();\n\t\t\timageEditorStore.takeSnapshot();\n\t\t\timageEditorStore.setActiveState('');\n\t\t});\n\t}\n\n\t// cleanup invoked by parent store\n\texport function cleanup() {\n\t\tif (region) {\n\t\t\tregion.destroy();\n\t\t\tregion = null;\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n\n\t// --- Expose functions for Controls ---\n\t// These are now part of the props passed to setToolbarControls\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/index.ts\n * @description Crop tool for Konva\n *\n * Features:\n * - Crop\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'crop',\n\ttitle: 'Crop',\n\ticon: 'mdi:crop',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/FineTune/Tool.svelte\n@component\n**Fine-Tune \"Controller\" Component**\n\nOrchestrates the filter modules:\n- Manages $state for all adjustments.\n- Registers the toolbar UI.\n- Applies filters (base + custom) in a debounced $effect.\n- Handles \"Compare\" logic using Konva's cache.\n- Implements the final 'apply' (bake) logic.\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport FineTuneControls from './Controls.svelte';\n\timport { type Adjustments, DEFAULT_ADJUSTMENTS } from './adjustments';\n\timport { applyBaseFilters } from './baseFilters';\n\timport { createCustomFilter } from './customFilters';\n\n\t// --- Svelte 5 State ---\n\tlet adjustments = $state({ ...DEFAULT_ADJUSTMENTS });\n\tlet activeAdjustment = $state<keyof Adjustments>('brightness');\n\n\tconst adjustments_list = [\n\t\t{ key: 'brightness', label: 'Brightness', icon: 'mdi:brightness-6' },\n\t\t{ key: 'contrast', label: 'Contrast', icon: 'mdi:contrast-box' },\n\t\t{ key: 'saturation', label: 'Saturation', icon: 'mdi:palette' },\n\t\t{ key: 'exposure', label: 'Exposure', icon: 'mdi:brightness-7' },\n\t\t{ key: 'highlights', label: 'Highlights', icon: 'mdi:white-balance-sunny' },\n\t\t{ key: 'shadows', label: 'Shadows', icon: 'mdi:weather-night' },\n\t\t{ key: 'temperature', label: 'Temperature', icon: 'mdi:thermometer' },\n\t\t{ key: 'clarity', label: 'Clarity', icon: 'mdi:crystal-ball' },\n\t\t{ key: 'vibrance', label: 'Vibrance', icon: 'mdi:vibrate' }\n\t];\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// debounce timer for slider updates\n\tlet filterDebounceTimer: number | null = null;\n\n\t// --- Lifecycle $effect ---\n\t// Binds/unbounds the tool and registers the toolbar\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'finetune') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: FineTuneControls,\n\t\t\t\tprops: {\n\t\t\t\t\tactiveAdjustment: activeAdjustment,\n\t\t\t\t\tactiveIcon: adjustments_list.find((a) => a.key === activeAdjustment)?.icon,\n\t\t\t\t\tvalue: adjustments[activeAdjustment],\n\t\t\t\t\tonChange: (value: number) => {\n\t\t\t\t\t\tadjustments[activeAdjustment] = value;\n\t\t\t\t\t},\n\t\t\t\t\tonAdjustmentChange: (key: keyof Adjustments) => {\n\t\t\t\t\t\tactiveAdjustment = key;\n\t\t\t\t\t},\n\t\t\t\t\tonReset: () => resetAdjustment(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === FineTuneControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Core Filter Logic ---\n\t// This $effect watches for adjustment changes,\n\t// debounces them, and applies the Konva filters.\n\t$effect(() => {\n\t\tif (!_toolBound) return;\n\n\t\t// Force dependency tracking by reading adjustments state here\n\t\tconst currentAdjustments = JSON.parse(JSON.stringify(adjustments));\n\n\t\t// Debounce to prevent thrashing on slider drag\n\t\tif (filterDebounceTimer) clearTimeout(filterDebounceTimer);\n\n\t\tfilterDebounceTimer = window.setTimeout(() => {\n\t\t\tconst { imageNode, layer } = imageEditorStore.state;\n\t\t\tif (!imageNode || !layer) return;\n\n\t\t\t// Log for debugging\n\t\t\tconsole.log('Applying FineTune adjustments:', currentAdjustments);\n\n\t\t\t// 1. Prepare filter list\n\t\t\tconst activeFilters = [];\n\n\t\t\t// Base Konva filters (Brighten, Contrast, HSL for saturation/hue)\n\t\t\tactiveFilters.push(Konva.Filters.Brighten);\n\t\t\tactiveFilters.push(Konva.Filters.Contrast);\n\t\t\tactiveFilters.push(Konva.Filters.HSL);\n\n\t\t\t// 2. Check for slow, custom pixel-looping filters\n\t\t\tconst needsCustom =\n\t\t\t\tadjustments.exposure !== 0 ||\n\t\t\t\tadjustments.highlights !== 0 ||\n\t\t\t\tadjustments.shadows !== 0 ||\n\t\t\t\tadjustments.clarity !== 0 ||\n\t\t\t\tadjustments.temperature !== 0;\n\t\t\tif (needsCustom) {\n\t\t\t\tactiveFilters.push(createCustomFilter(currentAdjustments));\n\t\t\t}\n\n\t\t\t// 3. Set filters on node\n\t\t\timageNode.filters(activeFilters);\n\n\t\t\t// 4. Update the actual properties (brightness, contrast, saturation, hue)\n\t\t\tapplyBaseFilters(imageNode, currentAdjustments);\n\n\t\t\t// 5. Re-cache the node to apply all filters\n\t\t\timageNode.clearCache();\n\t\t\timageNode.cache();\n\t\t\tlayer.batchDraw();\n\t\t}, 100); // 100ms debounce\n\t});\n\n\tfunction bindTool() {\n\t\tif (_toolBound) return;\n\t\t_toolBound = true;\n\t\t// Save the current state (which should be 0s) as the 'reset' point\n\t\tadjustments = { ...DEFAULT_ADJUSTMENTS };\n\t}\n\n\tfunction unbindTool() {\n\t\tif (!_toolBound) return;\n\t\t_toolBound = false;\n\t\tif (filterDebounceTimer) clearTimeout(filterDebounceTimer);\n\t}\n\n\t/**\n\t * Toggles comparison view.\n\t * This is the *most efficient* way:\n\t * - clearCache() reverts to the pre-filter image.\n\t * - cache() re-applies the filters.\n\t */\n\tfunction resetAdjustment() {\n\t\tadjustments[activeAdjustment] = 0;\n\t}\n\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/index.ts\n * @description Registers the FineTune tool and its controls.\n *\n * Features:\n * - Registers the FineTune tool and its controls.\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'finetune',\n\ttitle: 'Fine-Tune',\n\ticon: 'mdi:tune',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file src/components/imageEditor/widgets/FocalPoint/Tool.svelte\n@component\n**FocalPoint Tool**\n\nAllows users to set the focal point of an image with rule of thirds grid overlay.\n- Displays rule of thirds grid\n- Click to set focal point\n- Shows crosshair at focal point\n- Updates toolbar with X/Y coordinates\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport FocalPointControls from './Controls.svelte';\n\n\t// --- Svelte 5 State ---\n\tlet focalPoint = $state<{ x: number; y: number }>({ x: 0.5, y: 0.5 }); // Normalized 0-1\n\tlet gridLayer = $state<Konva.Layer | null>(null);\n\tlet crosshair = $state<Konva.Group | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// --- Lifecycle $effect ---\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'focalpoint') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: FocalPointControls,\n\t\t\t\tprops: {\n\t\t\t\t\tfocalX: Math.round(focalPoint.x * 100),\n\t\t\t\t\tfocalY: Math.round(focalPoint.y * 100),\n\t\t\t\t\tonReset: () => resetFocalPoint(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === FocalPointControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, imageNode } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\t// Get existing focal point from metadata\n\t\tconst metadata = (imageNode as any).metadata;\n\t\tif (metadata?.focalPoint) {\n\t\t\tfocalPoint = { ...metadata.focalPoint };\n\t\t}\n\n\t\t// Create grid overlay\n\t\tcreateGridOverlay();\n\t\tcreateCrosshair();\n\n\t\t// Bind click event\n\t\tstage.on('click.focalpoint tap.focalpoint', onStageClick);\n\t\tstage.container().style.cursor = 'crosshair';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off('click.focalpoint tap.focalpoint');\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\n\t\t// Remove grid overlay\n\t\tgridLayer?.destroy();\n\t\tgridLayer = null;\n\t\tcrosshair = null;\n\t}\n\n\t// --- Grid Overlay ---\n\tfunction createGridOverlay() {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || !imageGroup) return;\n\n\t\t// Create a new layer for the grid (on top of everything)\n\t\tgridLayer = new Konva.Layer();\n\t\tstage.add(gridLayer);\n\t\tgridLayer.moveToTop();\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst imageX = imageGroup.x();\n\t\tconst imageY = imageGroup.y();\n\n\t\t// Calculate actual top-left of image (accounting for centering in group)\n\t\tconst originX = imageX - imageWidth / 2;\n\t\tconst originY = imageY - imageHeight / 2;\n\n\t\t// Draw rule of thirds grid\n\t\tconst lineColor = '#00ff00';\n\t\tconst lineWidth = 1;\n\t\tconst opacity = 0.7;\n\n\t\t// Vertical lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst x = originX + (imageWidth / 3) * i;\n\t\t\tconst line = new Konva.Line({\n\t\t\t\tpoints: [x, originY, x, originY + imageHeight],\n\t\t\t\tstroke: lineColor,\n\t\t\t\tstrokeWidth: lineWidth,\n\t\t\t\topacity: opacity,\n\t\t\t\tlistening: false\n\t\t\t});\n\t\t\tgridLayer.add(line);\n\t\t}\n\n\t\t// Horizontal lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst y = originY + (imageHeight / 3) * i;\n\t\t\tconst line = new Konva.Line({\n\t\t\t\tpoints: [originX, y, originX + imageWidth, y],\n\t\t\t\tstroke: lineColor,\n\t\t\t\tstrokeWidth: lineWidth,\n\t\t\t\topacity: opacity,\n\t\t\t\tlistening: false\n\t\t\t});\n\t\t\tgridLayer.add(line);\n\t\t}\n\n\t\tgridLayer.batchDraw();\n\t}\n\n\tfunction createCrosshair() {\n\t\tconst { imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!gridLayer || !imageNode || !imageGroup) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst imageX = imageGroup.x();\n\t\tconst imageY = imageGroup.y();\n\n\t\t// Calculate actual top-left of image (accounting for centering in group)\n\t\tconst originX = imageX - imageWidth / 2;\n\t\tconst originY = imageY - imageHeight / 2;\n\n\t\t// Calculate crosshair position\n\t\tconst x = originX + imageWidth * focalPoint.x;\n\t\tconst y = originY + imageHeight * focalPoint.y;\n\n\t\t// Create crosshair group\n\t\tcrosshair = new Konva.Group({\n\t\t\tx: x,\n\t\t\ty: y,\n\t\t\tlistening: false\n\t\t});\n\n\t\t// Crosshair lines\n\t\tconst size = 20;\n\t\tconst color = '#ff0000';\n\t\tconst width = 2;\n\n\t\tconst hLine = new Konva.Line({\n\t\t\tpoints: [-size, 0, size, 0],\n\t\t\tstroke: color,\n\t\t\tstrokeWidth: width\n\t\t});\n\n\t\tconst vLine = new Konva.Line({\n\t\t\tpoints: [0, -size, 0, size],\n\t\t\tstroke: color,\n\t\t\tstrokeWidth: width\n\t\t});\n\n\t\t// Center circle\n\t\tconst circle = new Konva.Circle({\n\t\t\tradius: 4,\n\t\t\tfill: color,\n\t\t\tstroke: '#ffffff',\n\t\t\tstrokeWidth: 2\n\t\t});\n\n\t\tcrosshair.add(hLine, vLine, circle);\n\t\tgridLayer.add(crosshair);\n\t\tgridLayer.batchDraw();\n\t}\n\n\t// --- Event Handlers ---\n\tfunction onStageClick() {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || !imageGroup) return;\n\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst originX = imageGroup.x() - imageWidth / 2;\n\t\tconst originY = imageGroup.y() - imageHeight / 2;\n\n\t\t// Check if click is within image bounds\n\t\tif (pos.x < originX || pos.x > originX + imageWidth || pos.y < originY || pos.y > originY + imageHeight) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Calculate normalized focal point (0-1)\n\t\tfocalPoint = {\n\t\t\tx: (pos.x - originX) / imageWidth,\n\t\t\ty: (pos.y - originY) / imageHeight\n\t\t};\n\n\t\t// Update crosshair position\n\t\tupdateCrosshair();\n\n\t\t// Update toolbar (reactive)\n\t\timageEditorStore.setToolbarControls({\n\t\t\tcomponent: FocalPointControls,\n\t\t\tprops: {\n\t\t\t\tfocalX: Math.round(focalPoint.x * 100),\n\t\t\t\tfocalY: Math.round(focalPoint.y * 100),\n\t\t\t\tonReset: () => resetFocalPoint(),\n\t\t\t\tonApply: () => apply()\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction updateCrosshair() {\n\t\tconst { imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!crosshair || !imageNode || !imageGroup) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst originX = imageGroup.x() - imageWidth / 2;\n\t\tconst originY = imageGroup.y() - imageHeight / 2;\n\n\t\tconst x = originX + imageWidth * focalPoint.x;\n\t\tconst y = originY + imageHeight * focalPoint.y;\n\n\t\tcrosshair.position({ x, y });\n\t\tgridLayer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction resetFocalPoint() {\n\t\tfocalPoint = { x: 0.5, y: 0.5 };\n\t\tupdateCrosshair();\n\t}\n\n\tfunction apply() {\n\t\tconst { imageNode } = imageEditorStore.state;\n\t\tif (!imageNode) return;\n\n\t\t// Save focal point to image metadata\n\t\t(imageNode as any).metadata = {\n\t\t\t...(imageNode as any).metadata,\n\t\t\tfocalPoint: { ...focalPoint }\n\t\t};\n\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\n\texport function saveState() {}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- No UI needed, all controls in toolbar and grid overlay -->\n","/**\n * @file src/components/imageEditor/widgets/FocalPoint/index.ts\n * @description FocalPoint widget registration\n */\n\nimport type { EditorWidget } from '../registry';\nimport Tool from './Tool.svelte';\n\nexport const editorWidget: EditorWidget = {\n\tkey: 'focalpoint',\n\ttitle: 'Focal',\n\ticon: 'mdi:target',\n\n\ttool: Tool as unknown as import('svelte').Component<Record<string, unknown>>,\n\tcontrols: null as unknown as import('svelte').Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/RotateControls.svelte\n@component\nControls for the Rotate tool\n-->\n<script lang=\"ts\">\n\tlet {\n\t\trotationAngle,\n\t\tonRotateLeft,\n\t\tonRotateRight,\n\t\tonRotationChange,\n\t\tonFlipHorizontal,\n\t\tonFlipVertical,\n\t\tonReset,\n\t\tonApply\n\t}: {\n\t\trotationAngle: number;\n\t\tonRotateLeft: () => void;\n\t\tonRotateRight: () => void;\n\t\tonRotationChange: (angle: number) => void;\n\t\tonFlipHorizontal: () => void;\n\t\tonFlipVertical: () => void;\n\t\tonReset: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n\n\tfunction handleAngleInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tonRotationChange(parseInt(target.value, 10));\n\t}\n\n\t// Normalize angle to -180 to 180 for display\n\tconst displayAngle = $derived(() => {\n\t\tlet angle = rotationAngle % 360;\n\t\tif (angle > 180) angle -= 360;\n\t\tif (angle < -180) angle += 360;\n\t\treturn Math.round(angle);\n\t});\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<span class=\"text-sm font-medium\">Rotate & Flip Image</span>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Rotate Controls -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm\">Rotate:</span>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateLeft} title=\"Rotate Left 90°\">\n\t\t\t<iconify-icon icon=\"mdi:rotate-left\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateRight} title=\"Rotate Right 90°\">\n\t\t\t<iconify-icon icon=\"mdi:rotate-right\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Fine-tune Angle -->\n\t<label class=\"flex items-center gap-2 text-sm\">\n\t\t<span>Angle:</span>\n\t\t<input type=\"range\" min=\"-180\" max=\"180\" step=\"1\" value={rotationAngle} oninput={handleAngleInput} class=\"range range-primary w-32\" />\n\t\t<span class=\"w-12 text-right\">{displayAngle()}°</span>\n\t</label>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Flip Controls -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm\">Flip:</span>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipHorizontal} title=\"Flip Horizontal\">\n\t\t\t<iconify-icon icon=\"mdi:flip-horizontal\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipVertical} title=\"Flip Vertical\">\n\t\t\t<iconify-icon icon=\"mdi:flip-vertical\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Actions -->\n\t<button onclick={onReset} class=\"btn preset-outlined-surface-500\">\n\t\t<iconify-icon icon=\"mdi:restore\"></iconify-icon>\n\t\t<span>Reset</span>\n\t</button>\n\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Apply</span>\n\t</button>\n</div>\n","<!--\n@file shared/image-editor/src/widgets/Rotate/Tool.svelte\n@component Rotate tool for rotating and flipping images\n\n-->\n<script lang=\"ts\">\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport RotateControls from './Controls.svelte';\n\n\tlet rotationAngle = $state(0);\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'rotate') {\n\t\t\t// Get current rotation when tool activates\n\t\t\tconst { imageGroup } = imageEditorStore.state;\n\t\t\tif (imageGroup) {\n\t\t\t\trotationAngle = imageGroup.rotation();\n\t\t\t}\n\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: RotateControls,\n\t\t\t\tprops: {\n\t\t\t\t\trotationAngle,\n\t\t\t\t\tonRotateLeft: rotateLeft,\n\t\t\t\t\tonRotateRight: rotateRight,\n\t\t\t\t\tonRotationChange: setRotation,\n\t\t\t\t\tonFlipHorizontal: flipHorizontal,\n\t\t\t\t\tonFlipVertical: flipVertical,\n\t\t\t\t\tonReset: reset,\n\t\t\t\t\tonApply: apply\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\t// Only clear controls if they are ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === RotateControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\tfunction rotateLeft() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation - 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\t\trotationAngle = newRotation;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateRight() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation + 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\t\trotationAngle = newRotation;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction setRotation(angle: number) {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.rotation(angle);\n\t\trotationAngle = angle;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipHorizontal() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleX(imageGroup.scaleX() * -1);\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipVertical() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleY(imageGroup.scaleY() * -1);\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction reset() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.rotation(0);\n\t\timageGroup.scaleX(Math.abs(imageGroup.scaleX()));\n\t\timageGroup.scaleY(Math.abs(imageGroup.scaleY()));\n\t\trotationAngle = 0;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\texport function cleanup() {\n\t\t/* no cleanup needed */\n\t}\n\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n/** * @file shared/image-editor/src/widgets/Rotate/Tool.svelte * @component **Rotate tool for rotating and flipping images** ### Features: - Rotates\nand flips images - Resets rotation and flips - Applies changes to the image */ // imageEditor/widgets/Rotate/Tool.svelte /** * @file\nsrc/components/imageEditor/widgets/Rotate/Tool.svelte * @component * Rotate tool for rotating and flipping images */\n<!-- No UI needed, all controls in toolbar -->\n","/**\n * @file src/components/imageEditor/widgets/Rotate/index.ts\n * @description Rotate widget registration\n */\nimport type { EditorWidget } from '../registry';\nimport Tool from './Tool.svelte';\nimport Controls from './Controls.svelte';\n\nconst widget = {\n\tkey: 'rotate',\n\ttitle: 'Rotate',\n\ticon: 'mdi:rotate-right',\n\ttool: Tool,\n\tcontrols: Controls\n};\n\nexport const editorWidget = widget as unknown as EditorWidget;\n\nexport default editorWidget;\n","<!--\n@file: shared/image-editor/src/widgets/Watermark/Tool.svelte\n@component\n**Watermark Tool \"Controller\"**\n\nOrchestrates the watermark lifecycle:\n- Manages the $state list of WatermarkItem instances\n- Handles selection and transformer\n- Registers the toolbar UI\n- Implements the 'apply' (bake) logic\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { getContext } from 'svelte';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport WatermarkControls from './Controls.svelte';\n\timport { WatermarkItem } from './regions';\n\timport { createStyledTransformer, attachStyledTransformer } from '../transformerConfig';\n\timport type { WatermarkOptions } from '@shared/utils/media/mediaModels';\n\n\t// --- Svelte 5 State ---\n\tlet watermarks: WatermarkItem[] = $state([]);\n\tlet selected: WatermarkItem | null = $state(null);\n\tlet transformer: Konva.Transformer | null = $state(null);\n\tlet opacity = $state(0.8);\n\tlet fileInput: HTMLInputElement;\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\t// guard to prevent loading preset multiple times\n\tlet _presetLoaded = $state(false);\n\n\t// Get watermark preset from parent context (set by ImageEditorModal)\n\tconst getWatermarkPreset = getContext<(() => WatermarkOptions | null) | undefined>('watermarkPreset');\n\n\t// --- Lifecycle $effect ---\n\t// Binds/unbounds the tool and registers the toolbar\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'watermark') {\n\t\t\tbindTool();\n\n\t\t\t// Auto-load preset watermark if available and not already loaded\n\t\t\tconst preset = getWatermarkPreset?.();\n\t\t\tif (preset?.url && watermarks.length === 0 && !_presetLoaded) {\n\t\t\t\t_presetLoaded = true;\n\t\t\t\tloadPresetWatermark(preset);\n\t\t\t}\n\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: WatermarkControls,\n\t\t\t\tprops: {\n\t\t\t\t\thasSelection: !!selected,\n\t\t\t\t\tonAddWatermark: () => fileInput?.click(),\n\t\t\t\t\tonDeleteWatermark: () => deleteSelected(),\n\t\t\t\t\tonPositionChange: (position: string) => selected?.snapTo(position),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\t_presetLoaded = false; // Reset for next activation\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === WatermarkControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\tif (!transformer) {\n\t\t\ttransformer = createStyledTransformer(layer);\n\t\t}\n\t\tstage.on('click.watermark tap.watermark', onStageClick);\n\t\tstage.container().style.cursor = 'default';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off('click.watermark tap.watermark');\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\tdeselect();\n\t}\n\n\t// --- Event Handlers ---\n\tfunction onStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\t// Deselect if clicking on stage background\n\t\tif (e.target === e.target.getStage()) {\n\t\t\tdeselect();\n\t\t}\n\t}\n\n\t// --- Preset Watermark Loading ---\n\tasync function loadPresetWatermark(preset: WatermarkOptions) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\ttry {\n\t\t\t// Fetch the watermark image from the preset URL\n\t\t\tconst response = await fetch(preset.url);\n\t\t\tif (!response.ok) {\n\t\t\t\tconsole.warn('Failed to fetch preset watermark:', preset.url);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst blob = await response.blob();\n\t\t\tconst filename = preset.url.split('/').pop() || 'preset-watermark.png';\n\t\t\tconst file = new File([blob], filename, { type: blob.type || 'image/png' });\n\n\t\t\tconst item = new WatermarkItem({\n\t\t\t\tid: crypto.randomUUID(),\n\t\t\t\tlayer,\n\t\t\t\timageGroup\n\t\t\t});\n\n\t\t\titem.onSelect(() => select(item));\n\t\t\titem.onDestroy(() => {\n\t\t\t\twatermarks = watermarks.filter((w) => w.id !== item.id);\n\t\t\t\tif (selected?.id === item.id) deselect();\n\t\t\t});\n\n\t\t\twatermarks = [...watermarks, item];\n\t\t\tselect(item);\n\n\t\t\t// Load with preset opacity (convert percentage scale to 0-1 if needed)\n\t\t\tconst presetOpacity = typeof preset.scale === 'number' && preset.scale > 1 ? preset.scale / 100 : (preset.scale ?? 0.8);\n\n\t\t\tawait item.loadImage(file, {\n\t\t\t\topacity: presetOpacity,\n\t\t\t\tstageWidth: stage.width(),\n\t\t\t\tstageHeight: stage.height()\n\t\t\t});\n\n\t\t\t// Apply preset position if specified\n\t\t\tif (preset.position) {\n\t\t\t\titem.snapTo(preset.position);\n\t\t\t}\n\n\t\t\tattachStyledTransformer(transformer!, item.node);\n\t\t\tlayer.batchDraw();\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to load preset watermark', err);\n\t\t}\n\t}\n\n\t// --- Watermark Lifecycle ---\n\tasync function addWatermark(file: File) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\tconst item = new WatermarkItem({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageGroup\n\t\t});\n\n\t\titem.onSelect(() => select(item));\n\t\titem.onDestroy(() => {\n\t\t\twatermarks = watermarks.filter((w) => w.id !== item.id);\n\t\t\tif (selected?.id === item.id) deselect();\n\t\t});\n\n\t\twatermarks = [...watermarks, item];\n\t\tselect(item);\n\n\t\ttry {\n\t\t\t// Asynchronously load the image file\n\t\t\tawait item.loadImage(file, {\n\t\t\t\topacity: opacity,\n\t\t\t\tstageWidth: stage.width(),\n\t\t\t\tstageHeight: stage.height()\n\t\t\t});\n\t\t\t// Attach transformer *after* image is loaded and sized\n\t\t\tattachStyledTransformer(transformer!, item.node);\n\t\t\tlayer.batchDraw();\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to load watermark image', err);\n\t\t\titem.destroy(); // Clean up if load fails\n\t\t}\n\t}\n\n\tfunction select(item: WatermarkItem) {\n\t\tselected = item;\n\t\tif (!transformer) return;\n\t\tattachStyledTransformer(transformer, item.node);\n\t\t// Update controls to match selected item's opacity\n\t\topacity = item.node.opacity();\n\t}\n\n\tfunction deselect() {\n\t\tselected = null;\n\t\tif (!transformer) return;\n\t\tattachStyledTransformer(transformer, null);\n\t}\n\n\tfunction deleteSelected() {\n\t\tif (!selected) return;\n\t\tselected.destroy();\n\t\t// State update is handled by the 'onDestroy' callback\n\t}\n\n\tfunction cleanupWatermarks(destroy = true) {\n\t\tdeselect();\n\t\tif (destroy) {\n\t\t\t[...watermarks].forEach((w) => w.destroy());\n\t\t\twatermarks = [];\n\t\t} else {\n\t\t\t// Hide UI for baking\n\t\t\twatermarks.forEach((w) => w.disableInteraction());\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\tfunction handleFileChange(e: Event) {\n\t\tconst target = e.target as HTMLInputElement;\n\t\tif (target.files && target.files.length > 0) {\n\t\t\taddWatermark(target.files[0]);\n\t\t}\n\t\t// Reset input so the same file can be chosen again\n\t\ttarget.value = '';\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t\tcleanupWatermarks(true);\n\t\t\ttransformer?.destroy();\n\t\t\ttransformer = null;\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<input type=\"file\" accept=\"image/png, image/svg+xml\" class=\"hidden\" bind:this={fileInput} onchange={handleFileChange} />\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file shared/image-editor/src/widgets/Watermark/index.ts\n * @description Registers the Watermark tool and its controls.\n *\n * ### Features:\n * - Registers the Watermark tool and its controls.\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'watermark',\n\ttitle: 'Watermark',\n\ticon: 'mdi:copyright',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","/**\n * @file shared/image-editor/src/widgets/registry.ts\n * @description Dynamic widgets registry using import.meta.glob for discoverability\n *\n * Features:\n * - Dynamic widgets registry using import.meta.glob for discoverability\n */\nimport type { Component } from 'svelte';\n\nexport interface EditorWidget {\n\tkey: string;\n\ttitle: string;\n\ticon?: string;\n\ttool: Component<Record<string, unknown>>;\n\tcontrols?: Component<Record<string, unknown>>; // Optional: widgets register controls dynamically via imageEditorStore\n}\n\n// Load all widgets declared under ./<Widget>/index.ts (PascalCase folders only)\nconst modules = import.meta.glob('./[A-Z]*/index.ts', { eager: true }) as Record<string, unknown>;\n\nexport const editorWidgets: EditorWidget[] = Object.values(modules)\n\t.map((m) => {\n\t\tconst mod = m as { default?: EditorWidget; editorWidget?: EditorWidget };\n\t\treturn mod.default ?? mod.editorWidget;\n\t})\n\t.filter((w): w is EditorWidget => !!w);\n","<!--\n@file: shared/image-editor/src/EditorSidebar.svelte\n@component\n**Left sidebar with vertical tool layout**\nProvides easy access to all editing tools with clean, minimal design\nand proper active state indication.\n\n#### Props\n- `activeState`: Currently active tool state\n- `onToolSelect`: Function called when a tool is selected\n- `hasImage`: Whether an image is loaded for conditional tool availability\n-->\n\n<script lang=\"ts\">\n\t// Props\n\tconst {\n\t\tactiveState,\n\t\tonToolSelect,\n\t\thasImage = false\n\t}: {\n\t\tactiveState: string;\n\t\tonToolSelect: (tool: string) => void;\n\t\thasImage?: boolean;\n\t} = $props();\n\n\t// Drive tools from the widgets registry, with a focalpoint fallback\n\timport { editorWidgets, type EditorWidget } from './widgets/registry';\n\n\tconst tools = [...editorWidgets.map((w: EditorWidget) => ({ id: w.key, name: w.title, icon: w.icon ?? 'mdi:cog', description: '' }))];\n\n\tfunction handleToolClick(tool: any) {\n\t\tif (!hasImage) return;\n\t\tonToolSelect(tool.id);\n\t}\n\n\tfunction isToolActive(tool: any): boolean {\n\t\treturn activeState === tool.id;\n\t}\n</script>\n\n<div class=\"editor-sidebar flex w-20 flex-col border-r lg:w-24\">\n\t<div class=\"sidebar-tools flex flex-1 flex-col gap-1 p-1.5 lg:p-2 max-lg:gap-0.5 max-lg:p-1\">\n\t\t{#each tools as tool}\n\t\t\t<button\n\t\t\t\tclass=\"btn preset-filled-primary-500 group relative flex flex-col items-center justify-center gap-1 py-2\"\n\t\t\t\tclass:active={isToolActive(tool)}\n\t\t\t\tclass:disabled={!hasImage}\n\t\t\t\tclass:bg-primary-500={isToolActive(tool)}\n\t\t\t\tclass:text-white={isToolActive(tool)}\n\t\t\t\tclass:shadow-md={isToolActive(tool)}\n\t\t\t\tclass:hover:bg-primary-600={isToolActive(tool)}\n\t\t\t\tclass:cursor-not-allowed={!hasImage}\n\t\t\t\tclass:opacity-50={!hasImage}\n\t\t\t\tclass:bg-transparent={!hasImage}\n\t\t\t\tonclick={() => handleToolClick(tool)}\n\t\t\t\taria-label={tool.name}\n\t\t\t\tdisabled={!hasImage}\n\t\t\t>\n\t\t\t\t<div class=\"tool-icon flex items-center justify-center\">\n\t\t\t\t\t<iconify-icon icon={tool.icon} width=\"24\"></iconify-icon>\n\t\t\t\t</div>\n\t\t\t\t<span class=\"tool-label text-[10px] font-medium leading-none lg:text-xs\">{tool.name}</span>\n\n\t\t\t\t<!-- Tooltip -->\n\t\t\t\t<div\n\t\t\t\t\tclass=\"tooltip pointer-events-none absolute left-full top-1/2 z-50 ml-2 -translate-y-1/2 whitespace-nowrap rounded bg-surface-900 px-2 py-1 text-xs text-white opacity-0 transition-opacity duration-200 group-hover:opacity-100 dark:bg-surface-700 shadow-lg\"\n\t\t\t\t>\n\t\t\t\t\t<div class=\"font-medium\">{tool.name}</div>\n\t\t\t\t\t{#if tool.description}\n\t\t\t\t\t\t<div class=\"text-[10px] text-surface-300\">{tool.description}</div>\n\t\t\t\t\t{/if}\n\t\t\t\t\t<!-- Arrow -->\n\t\t\t\t\t<div class=\"absolute -left-1 top-1/2 -mt-1 h-2 w-2 -rotate-45 bg-surface-900 dark:bg-surface-700\"></div>\n\t\t\t\t</div>\n\n\t\t\t\t<!-- coming soon badge removed; driven by registry now -->\n\t\t\t</button>\n\t\t{/each}\n\t</div>\n\n\t<div class=\"sidebar-footer border-t p-2\">\n\t\t{#if !hasImage}\n\t\t\t<div class=\"no-image-hint flex flex-col items-center gap-1 p-2 text-center\">\n\t\t\t\t<iconify-icon icon=\"mdi:information-outline\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50\"> Upload an image to enable tools </span>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n</div>\n\n<style>\n\t.editor-sidebar {\n\t\tbackground-color: rgb(var(--color-surface-100) / 1);\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t\tmin-height: 100%;\n\t}\n\n\t:global(.dark) .editor-sidebar {\n\t\tbackground-color: rgb(var(--color-surface-800) / 1);\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n\n\t.sidebar-footer {\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t}\n\n\t:global(.dark) .sidebar-footer {\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/EditorCanvas.svelte\n@component\n**Responsive canvas wrapper for the Konva stage**\nHandles canvas sizing, empty states, and provides proper container\nfor the image editor canvas with responsive behavior.\n\n#### Props\n- `hasImage`: Whether an image is currently loaded\n- `containerRef`: Reference to bind the container element\n-->\n\n<script lang=\"ts\">\n\timport { fade } from 'svelte/transition';\n\timport type { Snippet } from 'svelte';\n\n\t// Props\n\tlet {\n\t\thasImage = false,\n\t\tisLoading = false,\n\t\tloadingMessage = 'Loading...',\n\t\tcontainerRef = $bindable(),\n\t\tchildren\n\t}: {\n\t\thasImage?: boolean;\n\t\tisLoading?: boolean;\n\t\tloadingMessage?: string;\n\t\tcontainerRef?: HTMLDivElement;\n\t\tchildren?: Snippet;\n\t} = $props();\n\n\tlet mounted = $state(false);\n\n\t$effect(() => {\n\t\tmounted = true;\n\t});\n</script>\n\n<div\n\tclass=\"editor-canvas-wrapper relative flex-1 overflow-hidden rounded-lg border border-surface-200 transition-all duration-300 ease-in-out focus-within:ring-2 focus-within:ring-primary-500 focus-within:ring-offset-2 focus-within:ring-offset-surface-50 dark:focus-within:ring-offset-surface-900 md:rounded-lg md:border md:border-surface-200 max-md:rounded-none max-md:border-0 max-md:border-b max-md:border-t\"\n>\n\t<!-- Canvas container - ALWAYS present for Konva stage -->\n\t<div class=\"canvas-container h-full w-full transition-all duration-300 ease-in-out\" bind:this={containerRef}>\n\t\t<!-- Konva stage will be mounted here by ImageEditor -->\n\t</div>\n\n\t<!-- Empty state overlay - shown when no image -->\n\t{#if !hasImage}\n\t\t<div class=\"empty-state pointer-events-none absolute inset-0 z-10 flex items-center justify-center\">\n\t\t\t<div class=\"empty-state-content flex max-w-md flex-col items-center gap-6 p-8 text-center max-md:p-6\">\n\t\t\t\t<div\n\t\t\t\t\tclass=\"empty-icon flex h-20 w-20 items-center justify-center rounded-full bg-surface-200 ring-4 ring-surface-300 dark:bg-surface-700 dark:ring-surface-600 max-md:h-16 max-md:w-16\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:image-plus\" width=\"48\" class=\"text-surface-400 dark:text-surface-500\"></iconify-icon>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"empty-text\">\n\t\t\t\t\t<h3 class=\"mb-2 text-lg font-medium text-surface-700 dark:text-surface-300 max-md:text-base\">No Image Selected</h3>\n\t\t\t\t\t<p class=\"text-sm text-surface-500 dark:text-surface-50 max-md:text-xs\">Upload an image to start editing</p>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"empty-hints flex flex-col gap-2\">\n\t\t\t\t\t<div class=\"hint-item flex items-center justify-center gap-2\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:gesture-tap\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50 max-md:text-[10px]\"> Drag & drop supported </span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"hint-item flex items-center justify-center gap-2\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:file-image\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50 max-md:text-[10px]\"> PNG, JPG, WebP, GIF </span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<!-- Slot for overlays (like crop toolbar) -->\n\t{@render children?.()}\n\n\t<!-- Loading overlay -->\n\t{#if (hasImage && !mounted) || isLoading}\n\t\t<div\n\t\t\tclass=\"loading-overlay absolute inset-0 flex flex-col items-center justify-center gap-3 bg-surface-50/80 backdrop-blur-sm dark:bg-surface-900/80 z-20\"\n\t\t\ttransition:fade={{ duration: 200 }}\n\t\t>\n\t\t\t<div class=\"loading-spinner flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-lg dark:bg-surface-800\">\n\t\t\t\t<iconify-icon icon=\"mdi:loading\" width=\"32\" class=\"animate-spin text-primary-500\"></iconify-icon>\n\t\t\t</div>\n\t\t\t<span class=\"text-sm text-surface-600 dark:text-surface-300\">{loadingMessage}</span>\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t.editor-canvas-wrapper {\n\t\tbackground-color: rgb(var(--color-surface-50) / 1);\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t\tmin-height: 400px;\n\t}\n\n\t:global(.dark) .editor-canvas-wrapper {\n\t\tbackground-color: rgb(var(--color-surface-900) / 1);\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n\n\t.canvas-container {\n\t\tbackground-color: rgb(var(--color-surface-100) / 1);\n\t\t/* Checkered pattern for transparency visualization */\n\t\tbackground-image:\n\t\t\tlinear-gradient(45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%), linear-gradient(-45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%),\n\t\t\tlinear-gradient(45deg, transparent 75%, rgba(0, 0, 0, 0.05) 75%), linear-gradient(-45deg, transparent 75%, rgba(0, 0, 0, 0.05) 75%);\n\t\tbackground-size: 20px 20px;\n\t\tbackground-position:\n\t\t\t0 0,\n\t\t\t0 10px,\n\t\t\t10px -10px,\n\t\t\t-10px 0px;\n\t}\n\n\t:global(.dark) .canvas-container {\n\t\tbackground-color: rgb(var(--color-surface-800) / 1);\n\t\tbackground-image:\n\t\t\tlinear-gradient(45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%), linear-gradient(-45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%),\n\t\t\tlinear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.03) 75%), linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.03) 75%);\n\t}\n\n\t.empty-state {\n\t\tbackground: linear-gradient(to bottom right, rgb(var(--color-surface-50) / 0.95), rgb(var(--color-surface-100) / 0.95));\n\t}\n\n\t:global(.dark) .empty-state {\n\t\tbackground: linear-gradient(to bottom right, rgb(var(--color-surface-900) / 1), rgb(var(--color-surface-800) / 1));\n\t}\n\n\t/* Responsive adjustments */\n\t@media (max-width: 768px) {\n\t\t.editor-canvas-wrapper {\n\t\t\tmin-height: 50vh;\n\t\t}\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/Editor.svelte\n@component\n**Enhanced Image Editor - Svelte 5 Optimized**\n\nComprehensive image editing interface with Konva.js integration.\n\n@example\n<Editor \n  initialImageSrc={image.url}\n  mediaId={image._id}\n  {onsave}\n  {oncancel}\n/>\n\n### Props\n- `imageFile` (File): Image file object\n- `initialImageSrc` (string): Initial image URL\n- `mediaId` (string): Media ID for saving\n- `focalPoint` (object): Initial focal point coordinates\n- `onsave` (function): Save callback\n- `oncancel` (function): Cancel callback\n\n### Features\n- Full Konva.js integration\n- Undo/redo support with history\n- Multiple editing tools (crop, filters, text, shapes)\n- Keyboard shortcuts\n- Responsive canvas\n- AVIF/WebP export\n- Accessibility compliant\n- Error boundaries\n-->\n\n<script lang=\"ts\">\n\timport { onMount, onDestroy } from 'svelte';\n\timport { logger } from '@shared/utils/logger';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\n\timport EditorSidebar from './EditorSidebar.svelte';\n\timport EditorCanvas from './EditorCanvas.svelte';\n\n\timport Konva from 'konva';\n\timport { editorWidgets } from './widgets/registry';\n\n\tinterface Props {\n\t\timageFile?: File | null;\n\t\tinitialImageSrc?: string;\n\t\tfocalPoint?: { x: number; y: number };\n\t\tonsave?: (detail: { dataURL: string; file: File }) => void;\n\t\toncancel?: () => void;\n\t}\n\n\tconst { imageFile = null, initialImageSrc = '', onsave = () => {}, oncancel = () => {} }: Props = $props();\n\n\t// State\n\tlet selectedImage = $state('');\n\tlet containerRef = $state<HTMLDivElement | undefined>(undefined);\n\tlet initialImageLoaded = $state(false);\n\tlet isProcessing = $state(false);\n\tlet error = $state<string | null>(null);\n\tlet preToolSnapshot = $state<string | null>(null);\n\n\t// Derived values\n\tconst storeState = imageEditorStore.state;\n\tconst activeState = $derived(imageEditorStore.state.activeState);\n\tconst hasImage = $derived(!!storeState.imageNode);\n\n\t// Active tool component\n\tconst activeToolComponent = $derived.by(() => {\n\t\tif (!activeState) return null;\n\n\t\tconst widget = editorWidgets.find((w) => w.key === activeState);\n\t\tif (widget?.tool) return widget.tool;\n\n\t\tif (activeState === 'focalpoint') return null; // Handled separately\n\n\t\tlogger.warn(`Tool not found for state: ${activeState}`);\n\t\treturn null;\n\t});\n\n\t// Cleanup effect for selected image\n\t$effect(() => {\n\t\treturn () => {\n\t\t\tif (selectedImage && selectedImage.startsWith('blob:')) {\n\t\t\t\tURL.revokeObjectURL(selectedImage);\n\t\t\t}\n\t\t};\n\t});\n\n\t// Load initial image effect\n\t$effect(() => {\n\t\tif (containerRef && !initialImageLoaded && (initialImageSrc || imageFile)) {\n\t\t\tif (initialImageSrc) {\n\t\t\t\tlogger.debug('Loading initial image from src:', initialImageSrc);\n\t\t\t\tselectedImage = initialImageSrc;\n\t\t\t\tloadImageAndSetupKonva(selectedImage);\n\t\t\t} else if (imageFile) {\n\t\t\t\tlogger.debug('Loading initial image from file');\n\t\t\t\tselectedImage = URL.createObjectURL(imageFile);\n\t\t\t\tloadImageAndSetupKonva(selectedImage, imageFile);\n\t\t\t}\n\t\t\tinitialImageLoaded = true;\n\t\t}\n\t});\n\n\t// Load image and setup Konva\n\tfunction loadImageAndSetupKonva(imageSrc: string, file?: File) {\n\t\tif (!containerRef) {\n\t\t\tlogger.error('Container ref not available');\n\t\t\terror = 'Container not ready';\n\t\t\treturn;\n\t\t}\n\n\t\tisProcessing = true;\n\t\terror = null;\n\n\t\tconst img = new Image();\n\n\t\t// Determine crossOrigin\n\t\ttry {\n\t\t\tconst currentOrigin = window.location.origin;\n\t\t\tconst imageOrigin = new URL(imageSrc, currentOrigin).origin;\n\n\t\t\tif (imageOrigin !== currentOrigin) {\n\t\t\t\timg.crossOrigin = 'anonymous';\n\t\t\t}\n\t\t\t// For same-origin (including local relative paths), we don't set crossOrigin\n\t\t\t// to ensure cookies/auth headers are sent if needed.\n\t\t} catch (e) {\n\t\t\t// Fallback for invalid URLs or other parsing errors\n\t\t\timg.crossOrigin = 'anonymous';\n\t\t}\n\n\t\timg.onerror = () => {\n\t\t\terror = 'Failed to load image';\n\t\t\tisProcessing = false;\n\t\t\tlogger.error('Image load error');\n\t\t};\n\n\t\timg.onload = () => {\n\t\t\ttry {\n\t\t\t\tconst containerWidth = containerRef!.clientWidth;\n\t\t\t\tconst containerHeight = containerRef!.clientHeight;\n\n\t\t\t\t// Clear existing stage\n\t\t\t\tconst existingStage = imageEditorStore.state.stage;\n\t\t\t\tif (existingStage) {\n\t\t\t\t\texistingStage.destroy();\n\t\t\t\t}\n\n\t\t\t\t// Create stage\n\t\t\t\tconst stage = new Konva.Stage({\n\t\t\t\t\tcontainer: containerRef!,\n\t\t\t\t\twidth: containerWidth,\n\t\t\t\t\theight: containerHeight\n\t\t\t\t});\n\n\t\t\t\tconst layer = new Konva.Layer();\n\t\t\t\tstage.add(layer);\n\n\t\t\t\t// Calculate scale\n\t\t\t\tconst scaleX = (containerWidth * 0.8) / img.width;\n\t\t\t\tconst scaleY = (containerHeight * 0.8) / img.height;\n\t\t\t\tconst scale = Math.min(scaleX, scaleY);\n\n\t\t\t\t// Create image node\n\t\t\t\tconst imageNode = new Konva.Image({\n\t\t\t\t\timage: img,\n\t\t\t\t\twidth: img.width,\n\t\t\t\t\theight: img.height,\n\t\t\t\t\tx: -img.width / 2,\n\t\t\t\t\ty: -img.height / 2\n\t\t\t\t});\n\n\t\t\t\t// Create group for transforms\n\t\t\t\tconst imageGroup = new Konva.Group({\n\t\t\t\t\tx: containerWidth / 2,\n\t\t\t\t\ty: containerHeight / 2,\n\t\t\t\t\tscaleX: scale,\n\t\t\t\t\tscaleY: scale\n\t\t\t\t});\n\n\t\t\t\timageGroup.add(imageNode);\n\t\t\t\tlayer.add(imageGroup);\n\t\t\t\tlayer.draw();\n\n\t\t\t\t// Update store\n\t\t\t\timageEditorStore.setStage(stage);\n\t\t\t\timageEditorStore.setLayer(layer);\n\t\t\t\timageEditorStore.setImageNode(imageNode);\n\t\t\t\timageEditorStore.setImageGroup(imageGroup);\n\n\t\t\t\tif (file) {\n\t\t\t\t\timageEditorStore.setFile(file);\n\t\t\t\t}\n\n\t\t\t\t// Initial snapshot\n\t\t\t\timageEditorStore.takeSnapshot();\n\n\t\t\t\tisProcessing = false;\n\t\t\t} catch (err) {\n\t\t\t\terror = 'Failed to setup editor';\n\t\t\t\tisProcessing = false;\n\t\t\t\tlogger.error('Konva setup error:', err);\n\t\t\t}\n\t\t};\n\n\t\timg.src = imageSrc;\n\t}\n\n\t// Handle resize\n\tfunction handleResize() {\n\t\tconst { stage, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !containerRef) return;\n\n\t\tconst containerWidth = containerRef.clientWidth;\n\t\tconst containerHeight = containerRef.clientHeight;\n\n\t\tstage.width(containerWidth);\n\t\tstage.height(containerHeight);\n\n\t\t// Recenter image\n\t\tif (imageGroup) {\n\t\t\timageGroup.position({\n\t\t\t\tx: containerWidth / 2,\n\t\t\t\ty: containerHeight / 2\n\t\t\t});\n\t\t}\n\n\t\tstage.batchDraw();\n\t}\n\n\t// Handle keyboard shortcuts\n\tfunction handleKeyDown(event: KeyboardEvent) {\n\t\t// Skip if typing in input\n\t\tconst target = event.target as HTMLElement;\n\t\tconst isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.contentEditable === 'true';\n\t\tif (isInput) return;\n\n\t\tconst cmdOrCtrl = event.metaKey || event.ctrlKey;\n\t\tconst shift = event.shiftKey;\n\n\t\t// Escape: Exit tool\n\t\tif (event.key === 'Escape') {\n\t\t\tconst currentState = imageEditorStore.state.activeState;\n\t\t\tif (currentState) {\n\t\t\t\timageEditorStore.saveToolState();\n\t\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\t\timageEditorStore.setActiveState('');\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// Ctrl/Cmd+Z: Undo\n\t\tif (cmdOrCtrl && !shift && event.key === 'z') {\n\t\t\tevent.preventDefault();\n\t\t\thandleUndo();\n\t\t\treturn;\n\t\t}\n\n\t\t// Ctrl/Cmd+Shift+Z: Redo\n\t\tif (cmdOrCtrl && shift && event.key === 'z') {\n\t\t\tevent.preventDefault();\n\t\t\thandleRedo();\n\t\t\treturn;\n\t\t}\n\n\t\t// Delete: Remove selected\n\t\tif (event.key === 'Delete') {\n\t\t\tconst currentState = imageEditorStore.state.activeState;\n\t\t\tif (currentState === 'textoverlay' || currentState === 'shapeoverlay') {\n\t\t\t\tconst deleteBtn = document.querySelector('.preset-filled-error-500.btn') as HTMLButtonElement;\n\t\t\t\tdeleteBtn?.click();\n\t\t\t}\n\t\t}\n\t}\n\n\t// Undo/Redo\n\texport function handleUndo() {\n\t\tif (!imageEditorStore.canUndoState) return;\n\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (currentState) {\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t}\n\n\t\tconst stateData = imageEditorStore.undoState();\n\t\tif (stateData) {\n\t\t\trestoreFromStateData(stateData);\n\t\t}\n\t}\n\n\texport function handleRedo() {\n\t\tif (!imageEditorStore.canRedoState) return;\n\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (currentState) {\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t}\n\n\t\tconst stateData = imageEditorStore.redoState();\n\t\tif (stateData) {\n\t\t\trestoreFromStateData(stateData);\n\t\t}\n\t}\n\n\t// Restore state\n\tfunction restoreFromStateData(stateData: string) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\ttry {\n\t\t\t// Deep cleanup before restoration\n\t\t\timageEditorStore.cleanupTempNodes();\n\n\t\t\tconst rawData = JSON.parse(stateData);\n\t\t\t// Support both legacy (pure stage JSON) and new format (snapshot object)\n\t\t\tconst isNewFormat = rawData.stage && rawData.activeState !== undefined;\n\t\t\tconst stateJSON = isNewFormat ? JSON.parse(rawData.stage) : rawData;\n\n\t\t\tif (isNewFormat) {\n\t\t\t\timageEditorStore.setActiveState(rawData.activeState);\n\t\t\t}\n\n\t\t\t// Clear filters to ensure a clean slate\n\t\t\timageNode.filters([]);\n\t\t\timageNode.clearCache();\n\n\t\t\t// The JSON structure is typically Stage -> Layer -> [Children]\n\t\t\t// We look for our expected hierarchy: imageGroup -> imageNode\n\t\t\tconst findImageGroupState = (nodes: any[]): any => {\n\t\t\t\tfor (const node of nodes) {\n\t\t\t\t\tif (node.className === 'Group' && node.children?.some((c: any) => c.className === 'Image')) {\n\t\t\t\t\t\treturn node;\n\t\t\t\t\t}\n\t\t\t\t\tif (node.children) {\n\t\t\t\t\t\tconst found = findImageGroupState(node.children);\n\t\t\t\t\t\tif (found) return found;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\n\t\t\tconst imageGroupState = findImageGroupState(stateJSON.children || []);\n\n\t\t\tif (imageGroupState && imageGroupState.attrs) {\n\t\t\t\t// Restore image group transforms\n\t\t\t\timageGroup.setAttrs({\n\t\t\t\t\tx: imageGroupState.attrs.x ?? stage.width() / 2,\n\t\t\t\t\ty: imageGroupState.attrs.y ?? stage.height() / 2,\n\t\t\t\t\tscaleX: imageGroupState.attrs.scaleX ?? 1,\n\t\t\t\t\tscaleY: imageGroupState.attrs.scaleY ?? 1,\n\t\t\t\t\trotation: imageGroupState.attrs.rotation ?? 0\n\t\t\t\t});\n\n\t\t\t\tconst imageNodeState = imageGroupState.children.find((c: any) => c.className === 'Image');\n\t\t\t\tif (imageNodeState && imageNodeState.attrs) {\n\t\t\t\t\t// Restore image node properties\n\t\t\t\t\timageNode.setAttrs({\n\t\t\t\t\t\tcropX: imageNodeState.attrs.cropX,\n\t\t\t\t\t\tcropY: imageNodeState.attrs.cropY,\n\t\t\t\t\t\tcropWidth: imageNodeState.attrs.cropWidth,\n\t\t\t\t\t\tcropHeight: imageNodeState.attrs.cropHeight,\n\t\t\t\t\t\twidth: imageNodeState.attrs.width,\n\t\t\t\t\t\theight: imageNodeState.attrs.height,\n\t\t\t\t\t\tx: imageNodeState.attrs.x,\n\t\t\t\t\t\ty: imageNodeState.attrs.y,\n\t\t\t\t\t\tcornerRadius: imageNodeState.attrs.cornerRadius ?? 0\n\t\t\t\t\t} as any);\n\n\t\t\t\t\t// Restore Filters\n\t\t\t\t\tif (imageNodeState.attrs.filters?.length > 0) {\n\t\t\t\t\t\t// Convert filter names to actual Konva filter functions if needed\n\t\t\t\t\t\t// but usually Konva restores them if registered.\n\t\t\t\t\t\t// To be safe, we re-apply based on attrs\n\t\t\t\t\t\tconst activeFilters = [];\n\t\t\t\t\t\tif (imageNodeState.attrs.brightness !== undefined) activeFilters.push(Konva.Filters.Brighten);\n\t\t\t\t\t\tif (imageNodeState.attrs.contrast !== undefined) activeFilters.push(Konva.Filters.Contrast);\n\t\t\t\t\t\tif (imageNodeState.attrs.saturation !== undefined || imageNodeState.attrs.luminance !== undefined) activeFilters.push(Konva.Filters.HSL);\n\n\t\t\t\t\t\timageNode.filters(activeFilters);\n\t\t\t\t\t\timageNode.setAttrs(imageNodeState.attrs);\n\t\t\t\t\t\timageNode.cache();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlayer.batchDraw();\n\t\t\tstage.batchDraw();\n\t\t} catch (err) {\n\t\t\tlogger.error('Failed to restore state:', err);\n\t\t\terror = 'Failed to restore state';\n\t\t}\n\t}\n\n\t// Save\n\texport async function handleSave() {\n\t\tconst { stage, file } = imageEditorStore.state;\n\t\tif (!stage || !file) {\n\t\t\terror = 'Nothing to save';\n\t\t\treturn;\n\t\t}\n\n\t\tisProcessing = true;\n\t\terror = null;\n\n\t\ttry {\n\t\t\t// CRITICAL: Hide all UI elements before taking the snapshot\n\t\t\t// to avoid baking handles/toolbars into the image.\n\t\t\timageEditorStore.hideAllUI();\n\n\t\t\tlet dataURL: string;\n\t\t\tlet mimeType: string;\n\t\t\tlet fileExtension: string;\n\n\t\t\t// Try AVIF first, fallback to WebP\n\t\t\ttry {\n\t\t\t\tdataURL = stage.toDataURL({\n\t\t\t\t\tmimeType: 'image/avif',\n\t\t\t\t\tquality: 0.85,\n\t\t\t\t\tpixelRatio: 1\n\t\t\t\t});\n\n\t\t\t\tif (dataURL.startsWith('data:image/avif')) {\n\t\t\t\t\tmimeType = 'image/avif';\n\t\t\t\t\tfileExtension = 'avif';\n\t\t\t\t\tlogger.debug('Using AVIF format');\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error('AVIF not supported');\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\tlogger.warn('AVIF not supported, using WebP');\n\t\t\t\tdataURL = stage.toDataURL({\n\t\t\t\t\tmimeType: 'image/webp',\n\t\t\t\t\tquality: 0.95,\n\t\t\t\t\tpixelRatio: 1\n\t\t\t\t});\n\t\t\t\tmimeType = 'image/webp';\n\t\t\t\tfileExtension = 'webp';\n\t\t\t}\n\n\t\t\tconst response = await fetch(dataURL);\n\t\t\tconst blob = await response.blob();\n\n\t\t\tconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n\t\t\tconst newFileName = `edited-${timestamp}.${fileExtension}`;\n\t\t\tconst editedFile = new File([blob], newFileName, { type: mimeType });\n\n\t\t\tonsave({ dataURL, file: editedFile });\n\t\t} catch (err) {\n\t\t\tlogger.error('Save error:', err);\n\t\t\terror = 'Failed to save image';\n\t\t} finally {\n\t\t\tisProcessing = false;\n\t\t}\n\t}\n\n\t// Cancel\n\texport function handleCancel() {\n\t\toncancel();\n\t}\n\n\t// Toggle tool\n\tfunction toggleTool(tool: string) {\n\t\tconst currentState = imageEditorStore.state.activeState;\n\n\t\tif (currentState && currentState !== tool) {\n\t\t\timageEditorStore.saveToolState();\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\n\t\t\t// Recenter if drifted\n\t\t\tconst { stage, imageGroup } = imageEditorStore.state;\n\t\t\tif (stage && imageGroup) {\n\t\t\t\tconst expectedX = stage.width() / 2;\n\t\t\t\tconst expectedY = stage.height() / 2;\n\t\t\t\tconst currentX = imageGroup.x();\n\t\t\t\tconst currentY = imageGroup.y();\n\n\t\t\t\tif (Math.abs(currentX - expectedX) > 5 || Math.abs(currentY - expectedY) > 5) {\n\t\t\t\t\timageGroup.position({ x: expectedX, y: expectedY });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst newState = currentState === tool ? '' : tool;\n\n\t\t// Capture snapshot before entering a new tool for 'Cancel' functionality\n\t\tif (newState !== '' && newState !== currentState) {\n\t\t\tpreToolSnapshot = imageEditorStore.undoState(true); // Get current state without undoing\n\t\t}\n\n\t\timageEditorStore.setActiveState(newState);\n\n\t\tif (newState === '') {\n\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\tpreToolSnapshot = null;\n\t\t}\n\t}\n\n\t// Cancel tool (Discard changes)\n\texport function handleCancelTool() {\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (!currentState) return;\n\n\t\tif (preToolSnapshot) {\n\t\t\trestoreFromStateData(preToolSnapshot);\n\t\t\t// Also clear history forward if needed? No, undoState(true) just returns top.\n\t\t}\n\n\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\timageEditorStore.setActiveState('');\n\t\timageEditorStore.setToolbarControls(null);\n\t\tpreToolSnapshot = null;\n\t}\n\n\t// Lifecycle\n\tonMount(() => {\n\t\timageEditorStore.reset();\n\t\twindow.addEventListener('resize', handleResize);\n\t\twindow.addEventListener('keydown', handleKeyDown);\n\n\t\treturn () => {\n\t\t\twindow.removeEventListener('resize', handleResize);\n\t\t\twindow.removeEventListener('keydown', handleKeyDown);\n\t\t\timageEditorStore.cleanupTempNodes();\n\t\t\timageEditorStore.reset();\n\t\t};\n\t});\n\n\tonDestroy(() => {\n\t\tif (selectedImage && selectedImage.startsWith('blob:')) {\n\t\t\tURL.revokeObjectURL(selectedImage);\n\t\t}\n\t});\n</script>\n\n<div class=\"image-editor flex h-full w-full flex-col overflow-hidden\" role=\"application\" aria-label=\"Image editor\" aria-busy={isProcessing}>\n\t{#if error}\n\t\t<div class=\"error-banner bg-error-50 border-l-4 border-error-500 p-4 text-error-700 dark:bg-error-900/20 dark:text-error-300\" role=\"alert\">\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<iconify-icon icon=\"mdi:alert-circle\" width=\"20\"></iconify-icon>\n\t\t\t\t<span>{error}</span>\n\t\t\t\t<button onclick={() => (error = null)} class=\"ml-auto text-error-600 hover:text-error-800\" aria-label=\"Dismiss error\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"18\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<div class=\"editor-layout flex h-full overflow-hidden\">\n\t\t<EditorSidebar activeState={activeState ?? ''} onToolSelect={toggleTool} {hasImage} />\n\n\t\t<div class=\"editor-main flex min-w-0 flex-1 flex-col\">\n\t\t\t<div class=\"canvas-wrapper relative flex flex-1 flex-col\">\n\t\t\t\t<EditorCanvas bind:containerRef {hasImage}>\n\t\t\t\t\t{#if storeState.stage && storeState.layer && storeState.imageNode && storeState.imageGroup}\n\t\t\t\t\t\t{#if activeToolComponent}\n\t\t\t\t\t\t\t{@const Component = activeToolComponent}\n\t\t\t\t\t\t\t<Component onCancel={handleCancelTool} />\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t{/if}\n\t\t\t\t</EditorCanvas>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n\n<style>\n\t:global(.crop-bottom-bar) {\n\t\tposition: absolute;\n\t\tbottom: 1rem;\n\t\tleft: 50%;\n\t\ttransform: translateX(-50%);\n\t\tz-index: 10;\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/EditorToolbar.svelte\n@component\nThe new single, intelligent bottom toolbar for the image editor.\nIt dynamically renders controls based on the active tool.\n-->\n<script lang=\"ts\">\n\timport { fade } from 'svelte/transition';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\n\tconst toolbarControls = $derived(imageEditorStore.state.toolbarControls);\n</script>\n\n<div class=\"border-t border-surface-300 bg-surface-100 p-2 shadow-lg dark:text-surface-50 dark:bg-surface-800\">\n\t<div class=\"mx-auto flex h-16 max-w-7xl items-center gap-4 px-4\">\n\t\t<!-- Tool-Specific Controls (Dynamic) -->\n\t\t<div class=\"flex h-full flex-1 items-center gap-3\">\n\t\t\t{#if toolbarControls?.component}\n\t\t\t\t{@const Component = toolbarControls.component}\n\t\t\t\t{#if Component}\n\t\t\t\t\t<Component {...toolbarControls.props} />\n\t\t\t\t{/if}\n\t\t\t{/if}\n\t\t</div>\n\t</div>\n\n\t<!-- Validation Error Banner -->\n\t{#if imageEditorStore.state.error}\n\t\t<div\n\t\t\tclass=\"absolute bottom-full left-0 right-0 flex items-center justify-center bg-error-500 py-1 text-xs font-medium text-white\"\n\t\t\ttransition:fade={{ duration: 200 }}\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:alert-circle\" width=\"14\" class=\"mr-1\"></iconify-icon>\n\t\t\t{imageEditorStore.state.error}\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t:global(.dark) .border-t {\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/ImageEditorModal.svelte\n@component\nA reusable modal that wraps the main Image Editor.\n-->\n<script lang=\"ts\">\n\timport type { MediaImage, WatermarkOptions } from '@shared/utils/media/mediaModels';\n\timport { setContext } from 'svelte';\n\timport Editor from './Editor.svelte';\n\timport EditorToolbar from './EditorToolbar.svelte';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport { editorWidgets } from './widgets/registry';\n\n\tlet {\n\t\timage = null,\n\t\twatermarkPreset = null,\n\t\tonsave = () => {},\n\t\tclose = () => {}\n\t}: {\n\t\timage: MediaImage | null;\n\t\t/** Optional watermark preset to auto-apply when editing */\n\t\twatermarkPreset?: WatermarkOptions | null;\n\t\tonsave?: (detail: any) => void;\n\t\tclose?: () => void;\n\t} = $props();\n\n\t// Provide watermark preset to child widgets via context\n\tsetContext('watermarkPreset', () => watermarkPreset);\n\n\tlet editorComponent: Editor | undefined = $state();\n\n\tconst activeState = $derived(imageEditorStore.state.activeState);\n\tconst activeWidget = $derived(editorWidgets.find((w: any) => w.key === activeState));\n\n\t// For Fine-Tune, we want to show the specific adjustment (e.g. contrast)\n\t// We'll peek into the toolbar props if available\n\tconst subInfo = $derived.by(() => {\n\t\tif (activeState === 'finetune') {\n\t\t\tconst props = imageEditorStore.state.toolbarControls?.props;\n\t\t\tif (props?.activeAdjustment) {\n\t\t\t\t// Capitalize first letter\n\t\t\t\tconst adj = props.activeAdjustment;\n\t\t\t\treturn {\n\t\t\t\t\tlabel: adj.charAt(0).toUpperCase() + adj.slice(1),\n\t\t\t\t\ticon: props.activeIcon\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t});\n\n\tfunction handleClose() {\n\t\tif (imageEditorStore.canUndoState) {\n\t\t\tif (!confirm('You have unsaved changes. Are you sure you want to close?')) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tclose();\n\t}\n\n\tfunction handleCancelClick() {\n\t\t// If a tool is active, exit the tool first\n\t\tif (activeState) {\n\t\t\timageEditorStore.cleanupToolSpecific(activeState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t} else {\n\t\t\t// No tool active, ask for confirmation if dirty\n\t\t\tif (imageEditorStore.canUndoState) {\n\t\t\t\tif (!confirm('You have unsaved changes. Are you sure you want to discard them?')) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\thandleClose();\n\t\t}\n\t}\n</script>\n\n{#if image}\n\t<div class=\"relative flex h-full min-h-[500px] w-full flex-col overflow-hidden bg-surface-100 shadow-xl dark:bg-surface-800\">\n\t\t<header\n\t\t\tclass=\"flex items-center justify-between border-b border-surface-300 p-3 lg:p-4 dark:text-surface-50 bg-surface-100/80 dark:bg-surface-800/80 sticky top-0 z-10\"\n\t\t>\n\t\t\t<div class=\"flex items-center gap-3 overflow-hidden\">\n\t\t\t\t{#if activeWidget}\n\t\t\t\t\t<div class=\"flex items-center gap-2 text-primary-500 shrink-0\">\n\t\t\t\t\t\t<iconify-icon icon={activeWidget.icon} width=\"24\" class=\"max-sm:width-[20px]\"></iconify-icon>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"flex flex-col min-w-0\">\n\t\t\t\t\t\t<h2 id=\"image-editor-title\" class=\"text-sm lg:text-lg font-bold truncate leading-tight flex items-center gap-1.5\">\n\t\t\t\t\t\t\t<span class=\"max-sm:hidden\">{activeWidget.title}</span>\n\t\t\t\t\t\t\t{#if subInfo}\n\t\t\t\t\t\t\t\t<span class=\"max-sm:hidden text-surface-400\">:</span>\n\t\t\t\t\t\t\t\t<span class=\"flex items-center gap-1 text-primary-600 dark:text-primary-400 font-extrabold\">\n\t\t\t\t\t\t\t\t\t{#if subInfo.icon}\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon={subInfo.icon} width=\"16\" class=\"lg:width-[20px]\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t<span>{subInfo.label}</span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t<span class=\"sm:hidden\">{activeWidget.title}</span>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t</div>\n\t\t\t\t{:else}\n\t\t\t\t\t<h2 id=\"image-editor-title\" class=\"text-tertiary-500 dark:text-primary-400 text-lg font-semibold shrink-0\">Image Editor</h2>\n\t\t\t\t{/if}\n\t\t\t</div>\n\n\t\t\t<!-- Global Actions -->\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => editorComponent?.handleUndo()}\n\t\t\t\t\tdisabled={!imageEditorStore.canUndoState}\n\t\t\t\t\tclass=\"btn-icon preset-outlined-surface-500\"\n\t\t\t\t\ttitle=\"Undo (Ctrl+Z)\"\n\t\t\t\t\taria-label=\"Undo\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:undo\" width=\"20\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => editorComponent?.handleRedo()}\n\t\t\t\t\tdisabled={!imageEditorStore.canRedoState}\n\t\t\t\t\tclass=\"btn-icon preset-outlined-surface-500\"\n\t\t\t\t\ttitle=\"Redo (Ctrl+Shift+Z)\"\n\t\t\t\t\taria-label=\"Redo\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:redo\" width=\"20\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t\t\t<button onclick={handleCancelClick} class=\"btn preset-outlined-surface-500\">\n\t\t\t\t\t{activeState ? 'Exit Tool' : 'Cancel'}\n\t\t\t\t</button>\n\t\t\t\t<button onclick={() => editorComponent?.handleSave()} class=\"btn preset-filled-tertiary-500 dark:preset-filled-primary-500\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:content-save\" width=\"18\"></iconify-icon>\n\t\t\t\t\t<span>Save</span>\n\t\t\t\t</button>\n\t\t\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t\t\t<button onclick={handleClose} class=\"btn-icon preset-outlined-surface-500\" aria-label=\"Close\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</header>\n\n\t\t<main class=\"flex-1 overflow-auto bg-surface-50/50 dark:bg-surface-900/50\">\n\t\t\t<Editor\n\t\t\t\tbind:this={editorComponent}\n\t\t\t\tinitialImageSrc={image.url}\n\t\t\t\tfocalPoint={image?.metadata?.focalPoint as { x: number; y: number } | undefined}\n\t\t\t\tonsave={(detail) => onsave(detail)}\n\t\t\t\toncancel={handleClose}\n\t\t\t/>\n\t\t</main>\n\t\t<EditorToolbar />\n\t</div>\n{/if}\n","<!--\n@file src/routes/(app)/mediagallery/+page.svelte\n@component\n**Media Gallery Page**\n\nDisplays a collection of media files (images, documents, audio, video) with:\n- Virtual folder navigation and breadcrumb trails\n- Search and filter by media type\n- Grid and table view modes with size options\n- Upload and folder management capabilities\n\n### Props:\n- `data.user` - Current user information\n- `data.media` - Array of media files to display\n- `data.systemVirtualFolders` - Virtual folder structure\n\n### Features:\n- Client-side search and filtering\n- Responsive grid/table layouts\n- Virtual folder CRUD operations\n- Media file deletion\n-->\n\n<script lang=\"ts\">\n\timport { goto } from '$app/navigation';\n\timport axios from 'axios';\n\t// Stores\n\timport { toggleUIElement } from '@shared/stores/UIStore.svelte';\n\timport { globalLoadingStore, loadingOperations } from '@shared/stores/loadingStore.svelte';\n\t// Logger\n\timport { logger } from '@shared/utils/logger';\n\t// Utils & Media\n\timport { publicEnv } from '@shared/stores/globalSettings.svelte';\n\timport { MediaTypeEnum, type MediaBase, type MediaImage } from '@shared/utils/media/mediaModels';\n\t// Components\n\timport Breadcrumb from '@cms/components/Breadcrumb.svelte';\n\timport PageTitle from '@cms/components/PageTitle.svelte';\n\timport { MediaGrid, MediaTable, VirtualMediaGrid, AdvancedSearchModal } from '@cms/mediagallery';\n\timport ImageEditorModal from '@cms/image-editor/ImageEditorModal.svelte';\n\t// Skeleton\n\timport { toaster } from '@shared/stores/store.svelte';\n\t// Import types\n\timport type { SystemVirtualFolder } from '@shared/database/dbInterface';\n\timport type { SearchCriteria } from '@shared/utils/media/advancedSearch';\n\n\t// Initialize modal store\n\t// const modalStore = getModalStore();\n\timport { modalState } from '@shared/utils/modalState.svelte';\n\timport { showConfirm } from '@shared/utils/modalUtils';\n\timport ModalPrompt from '@cms/components/ModalPrompt.svelte';\n\n\timport type { PageData } from './$types';\n\n\t// Props using runes\n\tlet { data }: { data: PageData } = $props();\n\n\t// State using runes\n\tlet files: (MediaBase | MediaImage)[] = $state([]);\n\tlet allSystemVirtualFolders: any[] = $state([]);\n\tlet currentSystemVirtualFolder: SystemVirtualFolder | null = $state(null);\n\tlet breadcrumb: string[] = $state([]);\n\n\tlet globalSearchValue = $state('');\n\tlet selectedMediaType: 'All' | MediaTypeEnum = $state('All');\n\tlet view: 'grid' | 'table' = $state('grid');\n\tlet gridSize: 'tiny' | 'small' | 'medium' | 'large' = $state('small');\n\tlet tableSize: 'tiny' | 'small' | 'medium' | 'large' = $state('small');\n\tlet isLoading = $state(false);\n\n\t// Enterprise features state\n\tlet advancedSearchCriteria: SearchCriteria | null = $state(null);\n\n\t// Performance optimization: Use virtual scrolling for large collections\n\tconst USE_VIRTUAL_THRESHOLD = 100;\n\n\ttype MediaTypeOption = {\n\t\tvalue: 'All' | MediaTypeEnum;\n\t\tlabel: string;\n\t};\n\n\t// Media types with proper typing\n\tconst mediaTypes: MediaTypeOption[] = [\n\t\t{ value: 'All', label: 'ALL' },\n\t\t{ value: MediaTypeEnum.Image, label: 'IMAGE' },\n\t\t{ value: MediaTypeEnum.Document, label: 'DOCUMENT' },\n\t\t{ value: MediaTypeEnum.Audio, label: 'AUDIO' },\n\t\t{ value: MediaTypeEnum.Video, label: 'VIDEO' },\n\t\t{ value: MediaTypeEnum.RemoteVideo, label: 'REMOTE VIDEO' }\n\t];\n\n\t// Computed value for filtered files based on search and type\n\tconst filteredFiles = $derived.by(() => {\n\t\tconst results = files.filter((file) => {\n\t\t\tconst matchesSearch = (file.filename || '').toLowerCase().includes(globalSearchValue.toLowerCase());\n\t\t\tconst matchesType = selectedMediaType === 'All' || file.type === selectedMediaType;\n\t\t\treturn matchesSearch && matchesType;\n\t\t});\n\n\t\t// Apply advanced search criteria if set\n\t\tif (advancedSearchCriteria) {\n\t\t\t// Import the advancedSearch function if criteria is active\n\t\t\t// This will be handled by the modal's onSearch callback\n\t\t\treturn results;\n\t\t}\n\n\t\treturn results;\n\t});\n\n\t// Performance optimization: Use virtual scrolling for large collections\n\tconst useVirtualScrolling = $derived(filteredFiles.length > USE_VIRTUAL_THRESHOLD);\n\n\t// Computed folders for breadcrumb - create a mapping of breadcrumb paths to folder IDs\n\tconst breadcrumbFolders = $derived.by(() => {\n\t\tconst folders: { _id: string; name: string; path: string[] }[] = [];\n\n\t\t// Always add root as first folder\n\t\tfolders.push({\n\t\t\t_id: 'root',\n\t\t\tname: 'Media Root',\n\t\t\tpath: []\n\t\t});\n\n\t\tif (!currentSystemVirtualFolder) {\n\t\t\treturn folders;\n\t\t}\n\n\t\tlet current: SystemVirtualFolder | null = currentSystemVirtualFolder;\n\t\tconst pathSegments: string[] = [];\n\n\t\tconst tempFolders: { _id: string; name: string; path: string[] }[] = [];\n\t\twhile (current) {\n\t\t\tpathSegments.unshift(current.name);\n\t\t\ttempFolders.unshift({\n\t\t\t\t_id: current._id,\n\t\t\t\tname: current.name,\n\t\t\t\tpath: [...pathSegments] // Copy the current path\n\t\t\t});\n\t\t\t// Find the parent folder\n\t\t\tcurrent = allSystemVirtualFolders.find((f) => f._id === current?.parentId) || null;\n\t\t}\n\n\t\treturn [...folders, ...tempFolders];\n\t});\n\n\t// Handle user preferences\n\tfunction storeUserPreference(\n\t\tview: 'grid' | 'table',\n\t\tgridSize: 'tiny' | 'small' | 'medium' | 'large',\n\t\ttableSize: 'tiny' | 'small' | 'medium' | 'large'\n\t) {\n\t\tlocalStorage.setItem('GalleryUserPreference', `${view}/${gridSize}/${tableSize}`);\n\t}\n\n\tfunction getUserPreferenceFromLocalStorageOrCookie(): string | null {\n\t\treturn localStorage.getItem('GalleryUserPreference');\n\t}\n\n\t// Mobile navigation helper - hides sidebar on mobile before navigation\n\tfunction handleMobileNavigation(path: string) {\n\t\tif (typeof window !== 'undefined' && window.innerWidth < 768) {\n\t\t\ttoggleUIElement('leftSidebar', 'hidden');\n\t\t}\n\t\tgoto(path);\n\t}\n\n\t// Computed safe table size (MediaTable doesn't support 'tiny')\n\tconst safeTableSize = $derived(tableSize);\n\n\t// Initialize component with runes\n\t// Run once on mount to set up initial data\n\t$effect(() => {\n\t\t// Load initial data from server\n\t\tif (data && data.systemVirtualFolders) {\n\t\t\tallSystemVirtualFolders = data.systemVirtualFolders.map((folder: SystemVirtualFolder) => ({\n\t\t\t\t...folder,\n\t\t\t\tpath: Array.isArray(folder.path) ? folder.path : folder.path?.split('/')\n\t\t\t}));\n\t\t}\n\n\t\tif (data && data.currentFolder) {\n\t\t\tcurrentSystemVirtualFolder = data.currentFolder;\n\t\t}\n\n\t\tif (data && data.media) {\n\t\t\tfiles = data.media.map((m: any) => ({\n\t\t\t\t...m,\n\t\t\t\tuser: typeof m.user === 'object' && m.user ? m.user._id : m.user\n\t\t\t})) as (MediaBase | MediaImage)[];\n\t\t}\n\n\t\t// Load user preferences\n\t\tconst userPreference = getUserPreferenceFromLocalStorageOrCookie();\n\t\tif (userPreference) {\n\t\t\tconst [preferredView, preferredGridSize, preferredTableSize] = userPreference.split('/');\n\t\t\tview = preferredView as 'grid' | 'table';\n\t\t\tgridSize = preferredGridSize as 'tiny' | 'small' | 'medium' | 'large';\n\t\t\ttableSize = preferredTableSize as 'tiny' | 'small' | 'medium' | 'large';\n\t\t}\n\n\t\t// Listen for folder selection events\n\t\tconst handleSystemVirtualFolderSelected = (event: CustomEvent) => {\n\t\t\tconst { folderId } = event.detail;\n\t\t\topenSystemVirtualFolder(folderId && folderId !== 'root' ? folderId : null);\n\t\t};\n\n\t\tdocument.addEventListener('systemVirtualFolderSelected', handleSystemVirtualFolderSelected as EventListener);\n\n\t\treturn () => {\n\t\t\tdocument.removeEventListener('systemVirtualFolderSelected', handleSystemVirtualFolderSelected as EventListener);\n\t\t};\n\t});\n\n\t// Update breadcrumb when current folder changes\n\t$effect(() => {\n\t\t// This effect only runs when currentSystemVirtualFolder or allSystemVirtualFolders changes\n\t\tupdateBreadcrumb();\n\t});\n\t// Function to update breadcrumb based on current folder\n\tfunction updateBreadcrumb() {\n\t\tif (!currentSystemVirtualFolder) {\n\t\t\t// At root level - show Media Root\n\t\t\tbreadcrumb = ['Media Root'];\n\t\t\treturn;\n\t\t}\n\n\t\t// Build breadcrumb by traversing up the parent hierarchy\n\t\tconst buildBreadcrumb = (folder: SystemVirtualFolder): string[] => {\n\t\t\tconst path: string[] = ['Media Root']; // Always start with root\n\t\t\tlet current: SystemVirtualFolder | null = folder;\n\n\t\t\tconst folderPath: string[] = [];\n\t\t\twhile (current) {\n\t\t\t\tfolderPath.unshift(current.name); // Add folder name to the beginning\n\t\t\t\t// Find the parent folder\n\t\t\t\tcurrent = allSystemVirtualFolders.find((f) => f._id === current?.parentId) || null;\n\t\t\t}\n\n\t\t\treturn [...path, ...folderPath];\n\t\t};\n\n\t\tbreadcrumb = buildBreadcrumb(currentSystemVirtualFolder);\n\t}\n\n\t// Create a new virtual folder with validation\n\tasync function createSystemVirtualFolder(folderName: string) {\n\t\t// Validate folder name\n\t\tconst trimmedName = folderName.trim();\n\t\tif (!trimmedName) {\n\t\t\ttoaster.error({ description: 'Folder name cannot be empty' });\n\t\t\treturn;\n\t\t}\n\n\t\tif (/[\\\\/:\"*?<>|]/.test(trimmedName)) {\n\t\t\ttoaster.error({ description: 'Folder name contains invalid characters (\\\\ / : * ? \" < > |)' });\n\t\t\treturn;\n\t\t}\n\n\t\tif (trimmedName.length > 50) {\n\t\t\ttoaster.error({ description: 'Folder name must be 50 characters or less' });\n\t\t\treturn;\n\t\t}\n\n\t\tisLoading = true;\n\t\tglobalLoadingStore.startLoading(loadingOperations.dataFetch);\n\n\t\ttry {\n\t\t\tconst parentId = currentSystemVirtualFolder?._id ?? null;\n\t\t\tconst response = await fetch('/api/systemVirtualFolder', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ name: trimmedName, parentId })\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json();\n\t\t\t\tthrow new Error(errorData.error || `HTTP error! status: ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.success) {\n\t\t\t\t// Refetch all folders and update current view\n\t\t\t\tallSystemVirtualFolders = await fetchUpdatedSystemVirtualFolders();\n\n\t\t\t\t// Notify Collections component\n\t\t\t\tdocument.dispatchEvent(\n\t\t\t\t\tnew CustomEvent('folderCreated', {\n\t\t\t\t\t\tdetail: { folder: result.folder, parentId }\n\t\t\t\t\t})\n\t\t\t\t);\n\n\t\t\t\ttoaster.success({ description: 'Folder created successfully' });\n\t\t\t} else {\n\t\t\t\tthrow new Error(result.error || 'Failed to create folder');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tlogger.error('Error creating folder:', error);\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error && error.message.includes('duplicate')\n\t\t\t\t\t? error.message\n\t\t\t\t\t: error instanceof Error && error.message.includes('invalid')\n\t\t\t\t\t\t? 'Invalid folder name'\n\t\t\t\t\t\t: 'Failed to create folder';\n\t\t\ttoaster.error({ description: errorMessage });\n\t\t} finally {\n\t\t\tisLoading = false;\n\t\t\tglobalLoadingStore.stopLoading(loadingOperations.dataFetch);\n\t\t}\n\t}\n\n\t// Fetch updated folders\n\tasync function fetchUpdatedSystemVirtualFolders() {\n\t\ttry {\n\t\t\tconst response = await fetch('/api/systemVirtualFolder');\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.success) {\n\t\t\t\treturn result.data.map((folder: SystemVirtualFolder) => ({\n\t\t\t\t\t...folder,\n\t\t\t\t\tpath: Array.isArray(folder.path) ? folder.path : folder.path?.split('/')\n\t\t\t\t}));\n\t\t\t} else {\n\t\t\t\tthrow new Error(result.error || 'Failed to fetch folders');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tlogger.error('Error fetching updated folders:', error);\n\t\t\ttoaster.error({ description: 'Failed to fetch folders' });\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t// Memoized fetch for media files\n\tlet lastSystemFolderId = $state<string | null>(null);\n\tasync function fetchMediaFiles(forceRefresh = false) {\n\t\tconst folderId = currentSystemVirtualFolder ? currentSystemVirtualFolder._id : 'root';\n\n\t\t// Skip if already loading or same folder (unless force refresh)\n\t\tif (!forceRefresh && (isLoading || folderId === lastSystemFolderId)) return;\n\n\t\tisLoading = true;\n\t\tglobalLoadingStore.startLoading(loadingOperations.dataFetch);\n\t\tlastSystemFolderId = folderId;\n\n\t\ttry {\n\t\t\tconst { data } = await axios.get(`/api/systemVirtualFolder/${folderId}`, {\n\t\t\t\ttimeout: 10000 // 10 second timeout\n\t\t\t});\n\n\t\t\tif (data.success) {\n\t\t\t\tfiles = Array.isArray(data.data.contents?.files) ? data.data.contents.files : [];\n\t\t\t\tlogger.info(`Fetched ${files.length} files for folder: ${folderId}`);\n\t\t\t\t// Folders are handled by allSystemVirtualFolders\n\t\t\t} else {\n\t\t\t\tthrow new Error(data.error || 'Unknown error');\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tlogger.error('Error fetching media files:', error);\n\t\t\tlet errorMessage = 'Failed to load media';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tif (error.message.includes('timeout')) {\n\t\t\t\t\terrorMessage = 'Request timed out - please try again';\n\t\t\t\t} else if (error.message.includes('network')) {\n\t\t\t\t\terrorMessage = 'Network error - please check your connection';\n\t\t\t\t}\n\t\t\t}\n\t\t\ttoaster.error({ description: errorMessage });\n\t\t\tfiles = [];\n\t\t} finally {\n\t\t\tisLoading = false;\n\t\t\tglobalLoadingStore.stopLoading(loadingOperations.dataFetch);\n\t\t}\n\t}\n\n\t// Open virtual folder\n\tasync function openSystemVirtualFolder(folderId: string | null) {\n\t\ttry {\n\t\t\tif (folderId === null) {\n\t\t\t\tcurrentSystemVirtualFolder = null;\n\t\t\t} else {\n\t\t\t\t// Set current folder to the selected one from allFolders\n\t\t\t\tcurrentSystemVirtualFolder = allSystemVirtualFolders.find((f) => f._id === folderId) || null;\n\t\t\t}\n\n\t\t\t// Update breadcrumb based on the current folder\n\t\t\tupdateBreadcrumb();\n\n\t\t\t// Fetch media files for the current folder\n\t\t\tawait fetchMediaFiles();\n\t\t} catch (error) {\n\t\t\tlogger.error('Error opening folder:', error);\n\t\t\ttoaster.error({ description: 'Failed to open folder' });\n\t\t}\n\t}\n\n\tfunction handleViewChange(newView: 'grid' | 'table') {\n\t\tview = newView;\n\t\tstoreUserPreference(view, gridSize, tableSize);\n\t}\n\tfunction handleSizeChange(detail: { type: string; size: string }) {\n\t\tview = detail.type as 'grid' | 'table'; // Update the view based on the type in detail\n\t\tif (detail.type === 'grid') {\n\t\t\tgridSize = detail.size as 'tiny' | 'small' | 'medium' | 'large';\n\t\t} else {\n\t\t\ttableSize = detail.size as 'tiny' | 'small' | 'medium' | 'large';\n\t\t}\n\t\tstoreUserPreference(view, gridSize, tableSize);\n\t}\n\n\t// Clear search\n\tfunction clearSearch() {\n\t\tglobalSearchValue = '';\n\t}\n\n\t// Open add virtual folder modal\n\tfunction openAddFolderModal() {\n\t\tconst currentFolderPath = currentSystemVirtualFolder\n\t\t\t? Array.isArray(currentSystemVirtualFolder.path)\n\t\t\t\t? currentSystemVirtualFolder.path.join('/')\n\t\t\t\t: currentSystemVirtualFolder.path\n\t\t\t: publicEnv?.MEDIA_FOLDER || 'mediaFiles';\n\t\tmodalState.trigger(\n\t\t\tModalPrompt as any,\n\t\t\t{\n\t\t\t\ttitle: 'Add Folder',\n\t\t\t\tbody: `Creating subfolder in: <span class=\"text-tertiary-500 dark:text-primary-500\">${currentFolderPath}</span>`\n\t\t\t},\n\t\t\t(r: string) => {\n\t\t\t\tif (r) createSystemVirtualFolder(r);\n\t\t\t}\n\t\t);\n\t}\n\n\t// Handle delete image\n\tasync function handleDeleteImage(file: MediaBase) {\n\t\t// Show confirmation modal\n\t\tshowConfirm({\n\t\t\ttitle: 'Delete Media',\n\t\t\tbody: `Are you sure you want to delete \"${file.filename}\"? This action cannot be undone.`,\n\t\t\tonConfirm: async () => {\n\t\t\t\ttry {\n\t\t\t\t\tlogger.info('Delete image request:', { _id: file._id, filename: file.filename });\n\n\t\t\t\t\tconst formData = new FormData();\n\t\t\t\t\tformData.append('imageData', JSON.stringify(file));\n\n\t\t\t\t\tconst response = await fetch('?/deleteMedia', {\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\tbody: formData\n\t\t\t\t\t});\n\n\t\t\t\t\tlogger.info('Delete response status:', response.status);\n\n\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\tconst errorText = await response.text();\n\t\t\t\t\t\tlogger.error('Delete failed with status:', response.status, errorText);\n\t\t\t\t\t\tthrow new Error(`Server error: ${response.status} - ${errorText}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst result = await response.json();\n\t\t\t\t\tlogger.debug('Delete response:', result);\n\n\t\t\t\t\t// Handle SvelteKit's wrapped response format\n\t\t\t\t\tlet data = result;\n\t\t\t\t\tif (result.type === 'success' && result.data) {\n\t\t\t\t\t\t// Parse if data is a string\n\t\t\t\t\t\tdata = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Check if it's an array response (like upload)\n\t\t\t\t\tconst success = Array.isArray(data) ? data[0]?.success : data?.success;\n\n\t\t\t\t\tif (success) {\n\t\t\t\t\t\ttoaster.success({ description: 'Media deleted successfully.' });\n\n\t\t\t\t\t\t// Reactively remove the deleted file from the files array\n\t\t\t\t\t\t// Svelte 5 runes will automatically update all derived state\n\t\t\t\t\t\tfiles = files.filter((f) => f._id !== file._id);\n\n\t\t\t\t\t\tlogger.info(`Removed file ${file.filename} from UI. Remaining: ${files.length} files`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow new Error(data?.error || 'Failed to delete media');\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\t\t\t\tlogger.error('Error deleting media:', errorMessage);\n\t\t\t\t\ttoaster.error({ description: `Error deleting media: ${errorMessage}` });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t// Handle bulk delete\n\tasync function handleBulkDelete(filesToDelete: MediaBase[]) {\n\t\t// Show confirmation modal\n\t\tshowConfirm({\n\t\t\ttitle: 'Delete Multiple Media',\n\t\t\tbody: `Are you sure you want to delete ${filesToDelete.length} file${filesToDelete.length > 1 ? 's' : ''}? This action cannot be undone.`,\n\t\t\tonConfirm: async () => {\n\t\t\t\ttry {\n\t\t\t\t\tlogger.info('Bulk delete request:', { count: filesToDelete.length });\n\n\t\t\t\t\t// Track successfully deleted files\n\t\t\t\t\tconst successfullyDeletedIds = new Set();\n\t\t\t\t\tlet successCount = 0;\n\t\t\t\t\tlet failCount = 0;\n\n\t\t\t\t\tfor (const file of filesToDelete) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst formData = new FormData();\n\t\t\t\t\t\t\tformData.append('imageData', JSON.stringify(file));\n\n\t\t\t\t\t\t\tconst response = await fetch('?/deleteMedia', {\n\t\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\t\tbody: formData\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\t\t\tconst result = await response.json();\n\t\t\t\t\t\t\t\tlet data = result;\n\t\t\t\t\t\t\t\tif (result.type === 'success' && result.data) {\n\t\t\t\t\t\t\t\t\tdata = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst success = Array.isArray(data) ? data[0]?.success : data?.success;\n\t\t\t\t\t\t\t\tif (success) {\n\t\t\t\t\t\t\t\t\tsuccessCount++;\n\t\t\t\t\t\t\t\t\tsuccessfullyDeletedIds.add(file._id as string);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tfailCount++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tfailCount++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tlogger.error('Error deleting file:', file.filename, error);\n\t\t\t\t\t\t\tfailCount++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Show result\n\t\t\t\t\tif (failCount === 0) {\n\t\t\t\t\t\ttoaster.success({ description: `Successfully deleted ${successCount} file${successCount > 1 ? 's' : ''}` });\n\t\t\t\t\t} else if (successCount === 0) {\n\t\t\t\t\t\ttoaster.error({ description: `Failed to delete ${failCount} file${failCount > 1 ? 's' : ''}` });\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttoaster.warning({ description: `Deleted ${successCount} file${successCount > 1 ? 's' : ''}, ${failCount} failed` });\n\t\t\t\t\t}\n\n\t\t\t\t\t// Reactively remove only successfully deleted files\n\t\t\t\t\t// Svelte 5 runes will automatically update filteredFiles derived state\n\t\t\t\t\tfiles = files.filter((f) => !successfullyDeletedIds.has(f._id as string));\n\n\t\t\t\t\tlogger.info(`Removed ${successCount} files from UI. Remaining: ${files.length} files`);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\t\t\t\tlogger.error('Error in bulk delete:', errorMessage);\n\t\t\t\t\ttoaster.error({ description: `Error deleting media: ${errorMessage}` });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t// Handle advanced search\n\tasync function handleAdvancedSearch(criteria: SearchCriteria) {\n\t\ttry {\n\t\t\tconst response = await fetch('/api/media/search', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ criteria })\n\t\t\t});\n\n\t\t\tif (!response.ok) throw new Error('Search failed');\n\n\t\t\tconst result = await response.json();\n\n\t\t\t// Update files with search results\n\t\t\tfiles = result.files;\n\t\t\tadvancedSearchCriteria = criteria;\n\t\t\tmodalState.close(); // Close the modal\n\n\t\t\ttoaster.success({\n\t\t\t\tdescription: `Found ${result.totalCount} file${result.totalCount === 1 ? '' : 's'} matching ${result.matchedCriteria.length} criteria`\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tlogger.error('Advanced search error:', error);\n\t\t\ttoaster.error({ description: 'Search failed. Please try again.' });\n\t\t}\n\t}\n\n\t// Clear advanced search\n\tfunction clearAdvancedSearch() {\n\t\tadvancedSearchCriteria = null;\n\t\tfetchMediaFiles(); // Reload all files\n\t}\n\n\tfunction openAdvancedSearch() {\n\t\tmodalState.trigger(AdvancedSearchModal as any, {\n\t\t\tfiles,\n\t\t\tonSearch: handleAdvancedSearch,\n\t\t\tmodalClasses: 'max-w-4xl max-h-[95vh]' // Override default width\n\t\t});\n\t}\n\n\t/*\n\t-------------------------------------------------------------------------\n\tIMAGE EDITOR HANDLERS (Via Modal)\n\t-------------------------------------------------------------------------\n\t*/\n\n\t// Define state for Image Editor\n\t// let imageToEdit: any = $state(null); // No longer needed\n\t// let showEditor = $state(false);      // No longer needed\n\n\timport { mediaUrl } from '@shared/utils/media/mediaUtils';\n\n\t// ... (existing imports)\n\n\tasync function handleEditImage(file: any) {\n\t\tconsole.log('handleEditImage called with:', file);\n\t\tif (!file) {\n\t\t\tconsole.warn('handleEditImage: File is null/undefined');\n\t\t\treturn;\n\t\t}\n\n\t\t// Ensure we have a valid URL\n\t\tconst url = file.url || mediaUrl(file);\n\t\tconst imageWithUrl = { ...file, url };\n\n\t\t// Trigger the modal via modalState\n\t\tmodalState.trigger(ImageEditorModal as any, {\n\t\t\timage: imageWithUrl,\n\t\t\tonsave: handleEditorSave,\n\t\t\tmodalClasses: 'w-full h-full max-w-none max-h-none p-0'\n\t\t});\n\t}\n\n\tasync function handleEditorSave(detail: { dataURL: string; file: File }) {\n\t\tconst { file } = detail;\n\n\t\tconst formData = new FormData();\n\t\tformData.append('files', file);\n\n\t\ttry {\n\t\t\tconst response = await fetch('/mediagallery?/upload', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tbody: formData\n\t\t\t});\n\t\t\tif (response.ok) {\n\t\t\t\ttoaster.success({ description: 'Image saved successfully!' });\n\t\t\t\tfetchMediaFiles(true); // Force refresh\n\t\t\t} else {\n\t\t\t\tthrow new Error('Failed to save edited image');\n\t\t\t}\n\t\t} catch (err) {\n\t\t\ttoaster.error({ description: 'Error saving image' });\n\t\t\tlogger.error('Error saving edited image', err);\n\t\t}\n\t}\n\tfunction handleUpdateImage(updatedFile: MediaImage) {\n\t\tconst index = files.findIndex((f) => f._id === updatedFile._id);\n\t\tif (index !== -1) {\n\t\t\tfiles[index] = updatedFile;\n\t\t}\n\t}\n</script>\n\n<!-- Page Title and Actions -->\n<div class=\"flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between\">\n\t<!-- Row 1: Page Title and Back Button (Handled by PageTitle component) -->\n\t<PageTitle\n\t\tname=\"Media Gallery\"\n\t\ticon=\"bi:images\"\n\t\tshowBackButton={true}\n\t\tbackUrl=\"/\"\n\t\tonBackClick={(defaultBehavior) => {\n\t\t\t// Custom back navigation with loading state management\n\t\t\ttry {\n\t\t\t\tdefaultBehavior();\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error('Navigation error:', error);\n\t\t\t\t// Fallback to home page if history.back() fails\n\t\t\t\tgoto('/');\n\t\t\t}\n\t\t}}\n\t/>\n\n\t<!-- Row 2: Action Buttons -->\n\t<div class=\"lgd:mt-0 flex items-center justify-center gap-4 lg:justify-end\">\n\t\t<!-- Add folder with loading state -->\n\t\t<button\n\t\t\tonclick={openAddFolderModal}\n\t\t\taria-label=\"Add folder\"\n\t\t\tclass=\"preset-filled-tertiary-500 btn gap-2\"\n\t\t\tdisabled={isLoading}\n\t\t\taria-busy={isLoading}\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:folder-add-outline\" width=\"24\"></iconify-icon>\n\t\t\t{isLoading ? 'Creating...' : 'Add folder'}\n\t\t\t{#if isLoading}\n\t\t\t\t<span class=\"loading loading-spinner loading-xs\"></span>\n\t\t\t{/if}\n\t\t</button>\n\n\t\t<!-- Add Media -->\n\t\t<button onclick={() => handleMobileNavigation('/mediagallery/uploadMedia')} aria-label=\"Add Media\" class=\"preset-filled-primary-500 btn gap-2\">\n\t\t\t<iconify-icon icon=\"carbon:add-filled\" width=\"24\"></iconify-icon>\n\t\t\tAdd Media\n\t\t</button>\n\t</div>\n</div>\n\n<!-- Breadcrumb Navigation -->\n<Breadcrumb {breadcrumb} folders={breadcrumbFolders} openFolder={openSystemVirtualFolder} />\n\n<div class=\"wrapper overflow-auto\">\n\t<div class=\"mb-8 flex w-full flex-col justify-center gap-1 md:hidden\">\n\t\t<label for=\"globalSearch\">Search</label>\n\t\t<div class=\"flex gap-2\">\n\t\t\t<div class=\"input-group input-group-divider grid flex-1 grid-cols-[auto_1fr_auto]\">\n\t\t\t\t<input id=\"globalSearch\" type=\"text\" placeholder=\"Search Media\" class=\"input\" bind:value={globalSearchValue} />\n\t\t\t\t{#if globalSearchValue}\n\t\t\t\t\t<button onclick={() => (globalSearchValue = '')} aria-label=\"Clear search\" class=\"preset-filled-surface-500 w-12\">\n\t\t\t\t\t\t<iconify-icon icon=\"ic:outline-search-off\" width=\"24\"></iconify-icon>\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t</div>\n\t\t\t<!-- Advanced Search Button (Mobile) - Outside input group -->\n\t\t\t<button onclick={openAdvancedSearch} aria-label=\"Advanced search\" class=\"preset-filled-surface-500 btn\" title=\"Advanced Search\">\n\t\t\t\t<iconify-icon icon=\"mdi:magnify-plus-outline\" width=\"24\"></iconify-icon>\n\t\t\t</button>\n\t\t</div>\n\n\t\t<div class=\"mt-4 flex justify-between\">\n\t\t\t<div class=\"flex flex-col\">\n\t\t\t\t<label for=\"mediaType\">Type</label>\n\t\t\t\t<select id=\"mediaType\" bind:value={selectedMediaType} class=\"input\">\n\t\t\t\t\t{#each mediaTypes as type}\n\t\t\t\t\t\t<option value={type.value}>{type.label}</option>\n\t\t\t\t\t{/each}\n\t\t\t\t</select>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col text-center\">\n\t\t\t\t<label for=\"sortButton\">Sort</label>\n\t\t\t\t<button id=\"sortButton\" aria-label=\"Sort\" class=\"preset-outline-surface-500 btn\">\n\t\t\t\t\t<iconify-icon icon=\"flowbite:sort-outline\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex items-center justify-center text-center text-xs md:hidden\">\n\t\t\t\t<div class=\"flex flex-col items-center justify-center\">\n\t\t\t\t\t<div class=\"flex sm:divide-x sm:divide-gray-500\">\n\t\t\t\t\t\t{#if view === 'grid'}\n\t\t\t\t\t\t\t<button onclick={() => handleViewChange('table')} aria-label=\"Table\" class=\"btn flex flex-col items-center justify-center px-1\">\n\t\t\t\t\t\t\t\t<p class=\"text-center text-xs\">Display</p>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:list-alt-outline\" height=\"44\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Table</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<button onclick={() => handleViewChange('grid')} aria-label=\"Grid\" class=\"btn flex flex-col items-center justify-center px-1\">\n\t\t\t\t\t\t\t\t<p class=\"text-center text-xs\">Display</p>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view-rounded\" height=\"42\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-center text-xs\">Grid</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"flex flex-col items-center\">\n\t\t\t\t\t<p class=\"text-xs\">Size</p>\n\t\t\t\t\t<div class=\"flex divide-x divide-gray-500\">\n\t\t\t\t\t\t{#if (view === 'grid' && gridSize === 'tiny') || (view === 'table' && tableSize === 'tiny')}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Tiny\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:apps\" height=\"40\" style=\"color:text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Tiny</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'small') || (view === 'table' && tableSize === 'small')}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Small\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:background-grid-small-sharp\" height=\"40\" style=\"color:text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Small</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'medium') || (view === 'table' && tableSize === 'medium')}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Medium\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-on-sharp\" height=\"40\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Medium</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Large\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view\" height=\"40\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Large</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t<div class=\"mb-4 hidden items-end justify-between gap-4 md:flex\">\n\t\t<!-- Left Side: Search & Advanced -->\n\t\t<div class=\"flex items-end gap-2\">\n\t\t\t<div class=\"flex flex-col gap-1\">\n\t\t\t\t<label for=\"globalSearchMd\" class=\"text-sm font-medium\">Search</label>\n\t\t\t\t<div class=\"input-group input-group-divider grid h-11 max-w-md grid-cols-[auto_1fr_auto_auto]\">\n\t\t\t\t\t<input bind:value={globalSearchValue} id=\"globalSearchMd\" type=\"text\" placeholder=\"Search\" class=\"input\" />\n\t\t\t\t\t{#if globalSearchValue}\n\t\t\t\t\t\t<button onclick={clearSearch} class=\"preset-filled-surface-500 w-12\" aria-label=\"Clear search\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"ic:outline-search-off\" width=\"24\"></iconify-icon>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{/if}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<!-- Advanced Search Button (Desktop) -->\n\t\t\t<button onclick={openAdvancedSearch} aria-label=\"Advanced search\" class=\"preset-filled-surface-500 btn gap-2\" title=\"Advanced Search\">\n\t\t\t\t<iconify-icon icon=\"mdi:magnify-plus-outline\" width=\"24\"></iconify-icon>\n\t\t\t\tAdvanced\n\t\t\t</button>\n\t\t</div>\n\n\t\t<!-- Right Side: Type, Sort, Display, Size -->\n\t\t<div class=\"flex items-end gap-4\">\n\t\t\t<div class=\"flex flex-col gap-1\">\n\t\t\t\t<label for=\"mediaTypeMd\" class=\"text-sm font-medium\">Type</label>\n\t\t\t\t<div class=\"input-group h-11\">\n\t\t\t\t\t<select id=\"mediaTypeMd\" bind:value={selectedMediaType} class=\"select\">\n\t\t\t\t\t\t{#each mediaTypes as type}\n\t\t\t\t\t\t\t<option value={type.value}>{type.label}</option>\n\t\t\t\t\t\t{/each}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col gap-1 text-center\">\n\t\t\t\t<label for=\"sortButton\" class=\"text-sm font-medium\">Sort</label>\n\t\t\t\t<button id=\"sortButton\" class=\"preset-tonal btn h-11\" aria-label=\"Sort\">\n\t\t\t\t\t<iconify-icon icon=\"flowbite:sort-outline\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col items-center gap-1\">\n\t\t\t\t<span class=\"text-sm font-medium\">Display</span>\n\t\t\t\t<div class=\"h-11 flex divide-x divide-gray-500 border border-surface-500/30 rounded-token overflow-hidden\">\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => handleViewChange('grid')}\n\t\t\t\t\t\tclass={`h-full px-3 flex flex-col items-center justify-center transition-colors ${view === 'grid' ? 'bg-primary-500/20 text-primary-500' : 'hover:bg-surface-500/10'}`}\n\t\t\t\t\t\taria-label=\"Grid\"\n\t\t\t\t\t\ttitle=\"Grid View\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view-rounded\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Grid</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => handleViewChange('table')}\n\t\t\t\t\t\tclass={`h-full px-3 flex flex-col items-center justify-center transition-colors ${view === 'table' ? 'bg-primary-500/20 text-primary-500' : 'hover:bg-surface-500/10'}`}\n\t\t\t\t\t\taria-label=\"Table\"\n\t\t\t\t\t\ttitle=\"Table View\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:list-alt-outline\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Table</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col items-center gap-1\">\n\t\t\t\t<span class=\"text-sm font-medium\">Size</span>\n\t\t\t\t<div class=\"h-11 flex divide-x divide-gray-500 border border-surface-500/30 rounded-token overflow-hidden\">\n\t\t\t\t\t{#if (view === 'grid' && gridSize === 'tiny') || (view === 'table' && tableSize === 'tiny')}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'small';\n\t\t\t\t\t\t\t\telse tableSize = 'small';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Tiny - Click for Small\"\n\t\t\t\t\t\t\ttitle=\"Tiny (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:apps\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Tiny</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'small') || (view === 'table' && tableSize === 'small')}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'medium';\n\t\t\t\t\t\t\t\telse tableSize = 'medium';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Small - Click for Medium\"\n\t\t\t\t\t\t\ttitle=\"Small (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:background-grid-small-sharp\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Small</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'medium') || (view === 'table' && tableSize === 'medium')}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'large';\n\t\t\t\t\t\t\t\telse tableSize = 'large';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Medium - Click for Large\"\n\t\t\t\t\t\t\ttitle=\"Medium (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-on-sharp\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Medium</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{:else}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'tiny';\n\t\t\t\t\t\t\t\telse tableSize = 'tiny';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Large - Click for Tiny\"\n\t\t\t\t\t\t\ttitle=\"Large (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Large</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{/if}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t{#if view === 'grid'}\n\t\t{#if useVirtualScrolling}\n\t\t\t<!-- Enterprise Virtual Scrolling for Large Collections (100+ files) -->\n\t\t\t<VirtualMediaGrid {filteredFiles} {gridSize} ondeleteImage={handleDeleteImage} onBulkDelete={handleBulkDelete} onEditImage={handleEditImage} />\n\t\t\t<div class=\"alert preset-outline-surface-500 mt-4\">\n\t\t\t\t<iconify-icon icon=\"mdi:lightning-bolt\" width=\"20\"></iconify-icon>\n\t\t\t\t<span class=\"text-sm\">\n\t\t\t\t\tVirtual scrolling enabled for optimal performance with {filteredFiles.length} files\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t{:else}\n\t\t\t<!-- Standard Grid for Smaller Collections -->\n\t\t\t<MediaGrid\n\t\t\t\t{filteredFiles}\n\t\t\t\t{gridSize}\n\t\t\t\tondeleteImage={handleDeleteImage}\n\t\t\t\tonBulkDelete={handleBulkDelete}\n\t\t\t\tonsizechange={handleSizeChange}\n\t\t\t\tonEditImage={handleEditImage}\n\t\t\t\tonUpdateImage={handleUpdateImage}\n\t\t\t/>\n\t\t{/if}\n\t{:else}\n\t\t<MediaTable\n\t\t\t{filteredFiles}\n\t\t\ttableSize={safeTableSize}\n\t\t\tondeleteImage={handleDeleteImage}\n\t\t\tonEditImage={handleEditImage}\n\t\t\tonUpdateImage={handleUpdateImage}\n\t\t\tonDeleteFiles={handleBulkDelete}\n\t\t/>\n\t{/if}\n</div>\n\n<!-- Editor Modal -->\n\n<!-- Modals -->\n\n<!-- Active Search Indicator -->\n{#if advancedSearchCriteria}\n\t<div class=\"alert preset-filled-warning-500 fixed bottom-4 right-4 z-40 max-w-sm\">\n\t\t<iconify-icon icon=\"mdi:filter\" width=\"20\"></iconify-icon>\n\t\t<div class=\"flex-1\">\n\t\t\t<p class=\"font-semibold\">Advanced search active</p>\n\t\t\t<p class=\"text-sm opacity-90\">Showing filtered results</p>\n\t\t</div>\n\t\t<button onclick={clearAdvancedSearch} class=\"preset-outline-surface-500 btn-icon btn-sm\" aria-label=\"Clear search\">\n\t\t\t<iconify-icon icon=\"mdi:close\" width=\"18\"></iconify-icon>\n\t\t</button>\n\t</div>\n{/if}\n"],"names":["$$renderer","$.attr_class","$.stringify","file","$.escape","$.attr","index","$.ensure_array_like","$.attr_style","Tool","editorWidget","widget","$.spread_props","MediaTypeEnum","view","gridSize","tableSize","data"],"mappings":"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"}