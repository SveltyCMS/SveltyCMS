{"version":3,"mappings":"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","names":["MediaType","maxVisible","showAll","$.state","needsTruncation","$.derived","$$props","visibleBreadcrumb","$.get","visibleIndices","_","i","handleBreadcrumbClick","visibleIndex","actualIndex","$.set","folder","copyPath","path","err","handleKeydown","event","index","nav","root","ol","$.index","$$anchor","crumb","isLast","isEllipsis","li","root_1","button","root_2","iconify_icon","$.child","$.reset","$.append","button_1","root_3","e","node_1","iconify_icon_1","$.first_child","fragment","span","iconify_icon_2","fragment_1","span_1","$$render","consequent_1","alternate","$.set_attribute","consequent","alternate_1","span_2","root_6","iconify_icon_3","consequent_2","button_2","$.sibling","iconify_icon_4","div","$.template_effect","$0","$.set_text","text_2","show","$.prop","file","onUpdate","newTagInput","isGenerating","isSaving","editingTag","getImageUrl","thumbs","handleAITagging","response","result","toaster","addManualTag","removeTag","tag","type","metadata","t","editTag","oldTag","newTag","saveAITags","currentTags","close","autofocus","node","div_1","header","div_2","div_3","img","div_4","div_5","div_6","section","div_7","div_8","$.each","node_5","input","root_7","$.remove_input_defaults","$.action","$$node","root_8","div_9","root_9","consequent_3","alternate_2","div_10","input_1","button_3","iconify_icon_5","div_11","root_10","button_4","iconify_icon_6","consequent_4","section_1","div_12","node_9","input_2","root_13","button_5","root_14","text_3","iconify_icon_7","consequent_5","alternate_3","div_13","root_15","consequent_6","alternate_4","text","text_1","$1","$$value","consequent_7","filteredFiles","$.proxy","gridSize","ondeleteImage","onBulkDelete","onEditImage","onsizechange","onUpdateImage","showInfo","selectedFiles","isSelectionMode","showTagModal","taggingFile","openTagEditor","formatMimeType","mime","parts","getFileIcon","fileName","fileExt","handleDelete","toggleSelection","fileId","selectAll","f","deselectAll","handleBulkDelete","filesToDelete","$.user_effect","getThumbnails","getThumbnail","size","thumbnails","key","$.set_custom_element_data","fragment_2","root_4","node_3","isSelected","root_5","node_4","$.set_checked","Tooltip","Tooltip_Trigger","Portal","node_7","Tooltip_Positioner","Tooltip_Content","table","fragment_6","tbody","tr","root_12","td","td_1","formatBytes","thumbnail","tr_1","td_2","td_3","text_5","td_4","consequent_8","$.set_class","consequent_9","Tooltip_Arrow","node_19","Tooltip_Trigger_1","root_24","root_25","root_26","consequent_10","node_22","Tooltip_Positioner_1","Tooltip_Content_1","Tooltip_Arrow_1","node_26","Tooltip_Trigger_2","button_6","root_31","iconify_icon_8","node_28","Tooltip_Positioner_2","Tooltip_Content_2","Tooltip_Arrow_2","consequent_11","node_32","Tooltip_Trigger_3","button_7","root_36","iconify_icon_9","node_34","Tooltip_Positioner_3","Tooltip_Content_3","Tooltip_Arrow_3","root_40","$.event","target","logger","$.replay_events","root_41","iconify_icon_10","consequent_12","footer","iconify_icon_11","p","span_3","text_10","$.transition","scale","quintOut","alternate_5","TagEditorModal","node_39","tableSize","onSelectionChange","onDeleteFiles","globalSearchValue","filterShow","columnShow","density","handleSelection","checked","currentPage","rowsPerPage","pagesCount","paginatedFiles","sortColumn","sortOrder","sort","column","a","b","TableFilter","node_2","thead","th","th_1","th_2","TableIcons","td_5","tags","aiTags","allTagsCount","text_9","text_11","node_10","node_12","td_6","text_4","text_8","node_16","TablePagination","page","rows","node_17","onBulkDownload","onBulkEdit","containerHeight","scrollTop","itemHeight","itemsPerRow","visibleRows","totalRows","startRow","endRow","visibleItems","paddingTop","paddingBottom","activePopup","showBulkEditModal","bulkEditAction","bulkEditValue","container","updateItemsPerRow","width","itemWidth","handleScroll","handleBulkDownload","filesToDownload","openBulkEditModal","action","applyBulkEdit","filesToEdit","onMount","resizeObserver","button_8","tr_2","tr_3","button_9","button_10","button_11","iconify_icon_12","root_11","iconify_icon_13","p_1","p_2","text_6","$.set_style","div_14","div_15","div_16","h3","p_3","div_17","label","span_4","root_16","span_5","root_17","div_18","button_12","button_13","formValues","suggestions","cameras","dimensions","fileTags","exif","imageFile","handleSearch","searchCriteria","resetForm","form","date","label_1","label_2","label_3","input_3","label_4","input_4","label_5","input_5","label_6","select","option","option_1","option_2","option_3","section_2","label_7","input_6","label_8","input_7","label_9","input_8","section_3","label_10","input_9","label_11","input_10","section_4","label_12","select_1","option_4","option_5","option_6","label_13","input_11","label_14","input_12","section_5","label_15","input_13","label_16","input_14","label_17","input_15","$$args","$.bind_value","$.bind_select_value","$.bind_checked","classes","classes_1","classes_2","classes_3","AnnotationItem","id","layer","kind","cb","createText","x","y","fontSize","color","Konva","createRect","w","h","stroke","fill","strokeWidth","r","createCircle","radius","c","createLine","points","l","createArrow","TRANSFORMER_STYLE_DEFAULT","TRANSFORMER_STYLE_CROP","TRANSFORMER_STYLE","GRID_STYLE","TRANSFORMER_DEFAULTS","oldBox","newBox","createStyledTransformer","options","attachStyledTransformer","createTransformer","attachTransformer","enableTextEdit","stage","textNode","onComplete","stageBox","textPosition","scrollX","scrollY","area","done","handleKey","NS","names","transformer","annotations","selected","currentTool","strokeColor","fillColor","isDrawing","tempNode","startPos","_toolBound","imageEditorStore","bindTool","AnnotateControls","deselect","v","deleteSelected","apply","unbindTool","onMouseDown","onMouseMove","onMouseUp","onStageClick","onDblClick","pos","txt","draw.createText","item","finalizeNode","startTextEdit","draw.createRect","draw.createCircle","draw.createLine","draw.createArrow","newValue","cleanupAnnotations","destroy","cleanup","saveState","beforeExit","index$4","Tool","hasActiveRegion","handleStrengthInput","$.set_value","BlurRegion","opts","init","n","localPt","bounds","padding","cacheRect","shape","ctx","m","pattern","strength","start","height","toolbarY","toolbarX","bg","addGroup","deleteGroup","isActive","deg","blurStrength","regions","activeId","strengthDebounceTimer","bindStageEvents","Controls","s","deleteRegion","createRegion","reset","unbindStageEvents","handleStageClick","imageNode","imageGroup","newR","selectRegion","cleanupBlurElements","destroyRegions","region","index$3","parseAspectRatio","ratio","syncHighlight","overlayGroup","cropTool","shouldCache","cut","CropRegion","sw","sh","dark","groupRect","cx","cy","shapeWidth","shapeHeight","lx","vLine","ly","hLine","rect","keepRatio","cropShape","aspectRatio","CropControls","rotateLeft","rotateRight","flipHorizontal","showToast","initDefaultRegion","newRegion","newRotation","__vitePreload","stageRectToImageRect","cropRect","imageCrop","containerWidth","scaleX","scaleY","newScale","index$2","adjustments","handleSliderInput","adj","$.clsx","DEFAULT_ADJUSTMENTS","applyBaseFilters","combinedSaturation","createCustomFilter","expFactor","highFactor","shadowFactor","clarityFactor","mid","imageData","data","g","brightness","highAmount","factor","shadowAmount","shift","activeAdjustment","adjustments_list","filterDebounceTimer","FineTuneControls","value","resetAdjustment","currentAdjustments","activeFilters","index$1","focalX","focalY","onReset","onApply","onCancel","focalPoint","gridLayer","crosshair","FocalPointControls","resetFocalPoint","createGridOverlay","createCrosshair","imageWidth","imageHeight","imageX","imageY","originX","originY","lineColor","lineWidth","opacity","line","circle","updateCrosshair","editorWidget","handleAngleInput","displayAngle","angle","rotationAngle","RotateControls","setRotation","flipVertical","widget","positions","WatermarkItem","resolve","reject","position","imageRect","nodeBox","finalPos","watermarks","fileInput","_presetLoaded","getWatermarkPreset","getContext","preset","loadPresetWatermark","WatermarkControls","blob","filename","presetOpacity","addWatermark","cleanupWatermarks","handleFileChange","modules","__vite_glob_0_0","__vite_glob_0_1","__vite_glob_0_2","__vite_glob_0_3","__vite_glob_0_4","__vite_glob_0_5","__vite_glob_0_6","editorWidgets","mod","hasImage","tools","handleToolClick","tool","isToolActive","isLoading","loadingMessage","containerRef","mounted","fade","initialImageSrc","onsave","oncancel","selectedImage","initialImageLoaded","isProcessing","error","preToolSnapshot","storeState","activeState","activeToolComponent","loadImageAndSetupKonva","imageSrc","currentOrigin","existingStage","handleResize","handleKeyDown","cmdOrCtrl","currentState","handleUndo","handleRedo","stateData","restoreFromStateData","rawData","isNewFormat","stateJSON","findImageGroupState","nodes","found","imageGroupState","imageNodeState","handleSave","dataURL","mimeType","fileExtension","newFileName","editedFile","handleCancel","toggleTool","expectedX","expectedY","currentX","currentY","newState","handleCancelTool","onDestroy","EditorSidebar","EditorCanvas","Component","Component_1","toolbarControls","$.spread_props","image","watermarkPreset","setContext","editorComponent","activeWidget","subInfo","props","handleClose","handleCancelClick","h2","h2_1","main","Editor","detail","EditorToolbar","body","inputValue","onConfirm","article","mediaUrl","publicEnv","files","allSystemVirtualFolders","currentSystemVirtualFolder","breadcrumb","selectedMediaType","view","advancedSearchCriteria","USE_VIRTUAL_THRESHOLD","mediaTypes","MediaTypeEnum","results","matchesSearch","matchesType","useVirtualScrolling","breadcrumbFolders","folders","current","pathSegments","tempFolders","storeUserPreference","getUserPreferenceFromLocalStorageOrCookie","handleMobileNavigation","toggleUIElement","goto","safeTableSize","userPreference","preferredView","preferredGridSize","preferredTableSize","handleSystemVirtualFolderSelected","folderId","openSystemVirtualFolder","updateBreadcrumb","folderPath","createSystemVirtualFolder","folderName","trimmedName","globalLoadingStore","loadingOperations","parentId","errorData","fetchUpdatedSystemVirtualFolders","errorMessage","lastSystemFolderId","fetchMediaFiles","forceRefresh","axios","handleViewChange","newView","handleSizeChange","clearSearch","openAddFolderModal","currentFolderPath","modalState","ModalPrompt","handleDeleteImage","showConfirm","formData","errorText","successfullyDeletedIds","successCount","failCount","handleAdvancedSearch","criteria","clearAdvancedSearch","openAdvancedSearch","AdvancedSearchModal","handleEditImage","url","imageWithUrl","ImageEditorModal","handleEditorSave","handleUpdateImage","updatedFile","PageTitle","defaultBehavior","Breadcrumb","option_value","newSize","div_19","div_20","option_1_value","div_21","div_22","div_23","button_14","iconify_icon_14","button_15","iconify_icon_15","div_24","div_25","button_16","iconify_icon_16","button_17","iconify_icon_17","button_18","root_18","iconify_icon_18","button_19","root_19","iconify_icon_19","alternate_6","VirtualMediaGrid","node_14","div_26","iconify_icon_20","MediaGrid","alternate_7","MediaTable","alternate_8","div_27","iconify_icon_21","button_20","iconify_icon_22"],"ignoreList":[],"sources":["../../../../../../../../shared/utils/src/media/mediaModels.ts","../../../../../../../../shared/components/src/Breadcrumb.svelte","../../../../../../../../shared/components/src/media/tagEditor/TagEditorModal.svelte","../../../../../../../../shared/features/src/mediagallery/components/MediaGrid.svelte","../../../../../../../../shared/features/src/mediagallery/components/MediaTable.svelte","../../../../../../../../shared/features/src/mediagallery/components/VirtualMediaGrid.svelte","../../../../../../../../shared/features/src/mediagallery/components/AdvancedSearchModal.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/regions.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/draw.ts","../../../../../../../../shared/features/src/image-editor/widgets/transformerConfig.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/transformer.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/editText.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/events.ts","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Annotate/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Blur/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Blur/regions.ts","../../../../../../../../shared/features/src/image-editor/widgets/Blur/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Blur/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Crop/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Crop/aspect.ts","../../../../../../../../shared/features/src/image-editor/widgets/Crop/highlight.ts","../../../../../../../../shared/features/src/image-editor/widgets/Crop/regions.ts","../../../../../../../../shared/features/src/image-editor/widgets/Crop/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Crop/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/adjustments.ts","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/baseFilters.ts","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/customFilters.ts","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/FineTune/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/FocalPoint/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/FocalPoint/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/FocalPoint/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Rotate/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Rotate/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Rotate/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/Watermark/Controls.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Watermark/regions.ts","../../../../../../../../shared/features/src/image-editor/widgets/Watermark/Tool.svelte","../../../../../../../../shared/features/src/image-editor/widgets/Watermark/index.ts","../../../../../../../../shared/features/src/image-editor/widgets/registry.ts","../../../../../../../../shared/features/src/image-editor/EditorSidebar.svelte","../../../../../../../../shared/features/src/image-editor/EditorCanvas.svelte","../../../../../../../../shared/features/src/image-editor/Editor.svelte","../../../../../../../../shared/features/src/image-editor/EditorToolbar.svelte","../../../../../../../../shared/features/src/image-editor/ImageEditorModal.svelte","../../../../../../../../shared/components/src/ModalPrompt.svelte","../../../../../../../../shared/utils/src/media/mediaUtils.ts","../../../../../../src/routes/mediagallery/+page.svelte"],"sourcesContent":["/**\n * @file src/utils/media/mediaModels.ts\n * @description Type definitions for media assets in the CMS\n *\n * Features:\n * - Unified base with specific extensions\n * - Storage-agnostic paths/URLs\n * - Flexible metadata & thumbnails\n * - Access control\n */\n\nimport type { ISODateString, DatabaseId } from '@cms-types/content';\n\nexport type StorageType = 'local' | 's3' | 'r2' | 'cloudinary';\n\nexport enum MediaType {\n\tImage = 'image',\n\tVideo = 'video',\n\tAudio = 'audio',\n\tDocument = 'document',\n\tRemoteVideo = 'remoteVideo'\n}\n\nexport type MediaAccess = 'public' | 'private' | 'protected';\n\nexport interface MediaMetadata {\n\ttitle?: string;\n\tdescription?: string;\n\tkeywords?: string[];\n\ttags?: string[];\n\taiTags?: string[];\n\tcopyright?: string;\n\tauthor?: string;\n\t/** Focal point for smart cropping (0-100 for x and y) */\n\tfocalPoint?: { x: number; y: number };\n\t/** Whether a watermark has been applied to this media */\n\twatermarkApplied?: boolean;\n\tlocation?: {\n\t\tlatitude?: number;\n\t\tlongitude?: number;\n\t\taltitude?: number;\n\t};\n\texif?: Record<string, unknown>;\n\t[key: string]: unknown;\n}\n\nexport interface WatermarkOptions {\n\turl: string;\n\tscale: number;\n\tposition:\n\t\t| 'top'\n\t\t| 'bottom'\n\t\t| 'left'\n\t\t| 'right'\n\t\t| 'centre'\n\t\t| 'north'\n\t\t| 'northeast'\n\t\t| 'east'\n\t\t| 'southeast'\n\t\t| 'south'\n\t\t| 'southwest'\n\t\t| 'west'\n\t\t| 'northwest';\n}\n\nexport interface ResizedImage {\n\turl: string;\n\twidth: number;\n\theight: number;\n\tsize: number;\n\tmimeType: string;\n}\n\nexport interface MediaVersion {\n\tversion: number;\n\turl: string;\n\tcreatedAt: ISODateString;\n\tcreatedBy: DatabaseId;\n}\n\nexport interface MediaBase {\n\t_id: DatabaseId; // Required for BaseEntity compatibility\n\ttype: MediaType;\n\thash: string;\n\tfilename: string;\n\tpath: string; // storage-relative\n\turl: string; // public URL\n\tmimeType: string;\n\tsize: number;\n\tuser: DatabaseId;\n\tcreatedAt: ISODateString;\n\tupdatedAt: ISODateString;\n\tthumbnails?: Record<string, ResizedImage>;\n\tfolderId?: DatabaseId | null;\n\toriginalId?: DatabaseId | null;\n\tmetadata?: MediaMetadata;\n\tversions?: MediaVersion[];\n\taccess?: MediaAccess;\n}\n\nexport interface MediaImage extends MediaBase {\n\ttype: MediaType.Image;\n\twidth: number;\n\theight: number;\n}\n\nexport interface MediaVideo extends MediaBase {\n\ttype: MediaType.Video;\n\tduration?: number;\n\tthumbnailUrl?: string;\n}\n\nexport interface MediaAudio extends MediaBase {\n\ttype: MediaType.Audio;\n\tduration?: number;\n}\n\nexport interface MediaDocument extends MediaBase {\n\ttype: MediaType.Document;\n\tpageCount?: number;\n}\n\nexport interface MediaRemoteVideo extends MediaBase {\n\ttype: MediaType.RemoteVideo;\n\tprovider: string; // youtube | vimeo | other\n\texternalId: string;\n\tthumbnails?: Record<string, ResizedImage>;\n}\n\nexport type MediaItem = MediaImage | MediaVideo | MediaAudio | MediaDocument | MediaRemoteVideo;\n\n/** Virtual folder for organization */\nexport interface SystemVirtualFolder {\n\t_id: string;\n\tname: string;\n\tparentId: string | null;\n\ticon?: string;\n\tcolor?: string;\n}\n\nexport { MediaType as MediaTypeEnum };\n","<!--\n@file src/components/Breadcrumb.svelte\n@component \n**Enhanced Breadcrumb - Svelte 5 Optimized**\n\nAccessible breadcrumb navigation with icons, keyboard support, and visual feedback.\n\n@example\n<Breadcrumb {breadcrumb} {openFolder} {folders} />\n\n### Props\n- `breadcrumb` (string[]): Array of breadcrumb labels\n- `openFolder` (function): Callback to open folder by ID\n- `folders` (Folder[]): Array of folder objects\n\n### Features\n- Full keyboard navigation\n- ARIA-compliant accessibility\n- Visual current page indicator\n- Home and folder icons\n- Truncation for long paths\n- Hover states and focus indicators\n- Copy path to clipboard\n-->\n\n<script lang=\"ts\">\n\ttype Folder = {\n\t\t_id: string;\n\t\tname: string;\n\t\tpath: string[];\n\t};\n\n\tinterface Props {\n\t\tbreadcrumb: string[];\n\t\topenFolder: (folderId: string | null) => void;\n\t\tfolders: Folder[];\n\t\tmaxVisible?: number;\n\t}\n\n\tconst { breadcrumb, openFolder, folders, maxVisible = 5 }: Props = $props();\n\n\t// State\n\tlet showAll = $state(false);\n\n\t// Determine if breadcrumb needs truncation\n\tconst needsTruncation = $derived(breadcrumb.length > maxVisible && !showAll);\n\n\t// Visible breadcrumb items\n\tconst visibleBreadcrumb = $derived(() => {\n\t\tif (!needsTruncation || showAll) {\n\t\t\treturn breadcrumb;\n\t\t}\n\n\t\t// Show first, ellipsis, and last two items\n\t\treturn [breadcrumb[0], '...', ...breadcrumb.slice(-2)];\n\t});\n\n\t// Get visible indices (maps visible items to original indices)\n\tconst visibleIndices = $derived(() => {\n\t\tif (!needsTruncation || showAll) {\n\t\t\treturn breadcrumb.map((_, i) => i);\n\t\t}\n\n\t\treturn [\n\t\t\t0,\n\t\t\t-1, // Ellipsis\n\t\t\tbreadcrumb.length - 2,\n\t\t\tbreadcrumb.length - 1\n\t\t];\n\t});\n\n\t// Handle breadcrumb click\n\tfunction handleBreadcrumbClick(visibleIndex: number) {\n\t\tconst actualIndex = visibleIndices()[visibleIndex];\n\n\t\t// Skip ellipsis clicks\n\t\tif (actualIndex === -1) {\n\t\t\tshowAll = true;\n\t\t\treturn;\n\t\t}\n\n\t\tif (actualIndex === 0) {\n\t\t\t// Click on home/root\n\t\t\topenFolder(null);\n\t\t} else {\n\t\t\t// Find the folder matching the breadcrumb\n\t\t\tconst folder = folders[actualIndex];\n\t\t\topenFolder(folder ? folder._id : null);\n\t\t}\n\t}\n\n\t// Copy path to clipboard\n\tasync function copyPath() {\n\t\tconst path = breadcrumb.join(' > ');\n\t\ttry {\n\t\t\tawait navigator.clipboard.writeText(path);\n\t\t\t// Could show a toast notification here\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to copy path:', err);\n\t\t}\n\t}\n\n\t// Handle keyboard navigation\n\tfunction handleKeydown(event: KeyboardEvent, index: number) {\n\t\tif (event.key === 'Enter' || event.key === ' ') {\n\t\t\tevent.preventDefault();\n\t\t\thandleBreadcrumbClick(index);\n\t\t}\n\t}\n</script>\n\n<nav aria-label=\"Breadcrumb navigation\" class=\"flex items-center gap-2\">\n\t<!-- Breadcrumb list -->\n\t<ol class=\"flex flex-wrap items-center gap-1 text-sm text-gray-700 dark:text-gray-300\" role=\"list\">\n\t\t{#each visibleBreadcrumb() as crumb, visibleIndex (visibleIndex)}\n\t\t\t{@const actualIndex = visibleIndices()[visibleIndex]}\n\t\t\t{@const isLast = visibleIndex === visibleBreadcrumb().length - 1}\n\t\t\t{@const isEllipsis = actualIndex === -1}\n\n\t\t\t<li class=\"flex items-center\" role=\"listitem\">\n\t\t\t\t{#if isEllipsis}\n\t\t\t\t\t<!-- Ellipsis button to expand -->\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => (showAll = true)}\n\t\t\t\t\t\tclass=\"flex items-center gap-1 rounded px-2 py-1 text-sm transition-colors hover:bg-surface-100 focus:bg-surface-100 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:hover:bg-surface-800 dark:focus:bg-surface-800\"\n\t\t\t\t\t\taria-label=\"Show all breadcrumb items\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:dots-horizontal\" width=\"18\" class=\"text-surface-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t</button>\n\t\t\t\t{:else}\n\t\t\t\t\t<!-- Regular breadcrumb item -->\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => handleBreadcrumbClick(visibleIndex)}\n\t\t\t\t\t\tonkeydown={(e) => handleKeydown(e, visibleIndex)}\n\t\t\t\t\t\tclass=\"flex items-center gap-1.5 rounded px-2 py-1 text-sm transition-all {isLast\n\t\t\t\t\t\t\t? 'font-semibold text-primary-600 dark:text-primary-400'\n\t\t\t\t\t\t\t: 'hover:bg-surface-100 hover:text-primary-500 focus:bg-surface-100 focus:text-primary-500 dark:hover:bg-surface-800 dark:focus:bg-surface-800'} focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-1\"\n\t\t\t\t\t\taria-current={isLast ? 'page' : undefined}\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\ttitle={crumb}\n\t\t\t\t\t>\n\t\t\t\t\t\t{#if actualIndex === 0}\n\t\t\t\t\t\t\t<!-- Home icon -->\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:home\" width=\"18\" class=\"shrink-0 text-tertiary-500 dark:text-primary-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"max-w-[150px] truncate\">{crumb}</span>\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<!-- Folder icon -->\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:folder\" width=\"18\" class=\"shrink-0 text-tertiary-500 dark:text-primary-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"max-w-[150px] truncate\">{crumb}</span>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\n\t\t\t\t<!-- Separator (not after last item) -->\n\t\t\t\t{#if !isLast}\n\t\t\t\t\t<span class=\"mx-1 text-gray-400 dark:text-gray-600\" aria-hidden=\"true\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:chevron-right\" width=\"16\"></iconify-icon>\n\t\t\t\t\t</span>\n\t\t\t\t{/if}\n\t\t\t</li>\n\t\t{/each}\n\t</ol>\n\n\t<!-- Copy path button -->\n\t<button\n\t\tonclick={copyPath}\n\t\tclass=\"btn-icon btn-icon-sm preset-outlined-surface-500 ml-auto\"\n\t\ttitle=\"Copy path to clipboard\"\n\t\taria-label=\"Copy current path to clipboard\"\n\t\ttype=\"button\"\n\t>\n\t\t<iconify-icon icon=\"mdi:content-copy\" width=\"16\"></iconify-icon>\n\t</button>\n\n\t<!-- Screen reader announcement -->\n\t<div class=\"sr-only\" role=\"status\" aria-live=\"polite\">\n\t\tCurrent location: {breadcrumb.join(', then ')}\n\t</div>\n</nav>\n","<!--\n@file: src/components/media/tagEditor/TagEditorModal.svelte\n@component\nA modal for managing media tags.\n-->\n<script lang=\"ts\">\n\timport type { MediaImage } from '@shared/utils/media/mediaModels';\n\n\timport { toaster } from '@shared/stores/store.svelte';\n\n\t// Props\n\tlet {\n\t\tshow = $bindable(),\n\t\tfile = $bindable(null),\n\t\tonUpdate = () => {}\n\t}: {\n\t\tshow: boolean;\n\t\tfile: MediaImage | null;\n\t\tonUpdate?: (updatedFile: MediaImage) => void;\n\t} = $props();\n\n\tlet newTagInput = $state('');\n\tlet isGenerating = $state(false);\n\tlet isSaving = $state(false);\n\n\t// Edit state\n\tlet editingTag = $state<{ type: 'ai' | 'user'; index: number; value: string } | null>(null);\n\n\tfunction getImageUrl(file: MediaImage) {\n\t\t// Try to get thumbnail, fallback to original url\n\t\tconst thumbs = file.thumbnails || {};\n\t\t// Map common keys\n\t\tif ('sm' in thumbs) return thumbs.sm.url;\n\t\tif ('thumbnail' in thumbs) return thumbs.thumbnail.url;\n\t\tif ('md' in thumbs) return thumbs.md.url;\n\t\treturn file.url;\n\t}\n\n\tasync function handleAITagging() {\n\t\tif (!file?._id) return;\n\t\tisGenerating = true;\n\t\ttry {\n\t\t\tconst response = await fetch(`/api/media/${file._id}/tags`, { method: 'POST' });\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error || 'Failed.');\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t\ttoaster.success({ description: 'AI tags generated!' });\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t} finally {\n\t\t\tisGenerating = false;\n\t\t}\n\t}\n\n\tasync function addManualTag() {\n\t\tif (!file?._id || !newTagInput.trim()) return;\n\t\ttry {\n\t\t\t// Add to aiTags \"pending\" area\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...file.metadata,\n\t\t\t\t\t\taiTags: [...(file.metadata?.aiTags || []), newTagInput.trim()]\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t\tnewTagInput = '';\n\t\t\ttoaster.success({ description: 'Tag added!' });\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t}\n\t}\n\n\tasync function removeTag(tag: string, type: 'ai' | 'user') {\n\t\tif (!file?._id) return;\n\t\ttry {\n\t\t\tconst metadata = { ...file.metadata };\n\t\t\tif (type === 'ai') {\n\t\t\t\tmetadata.aiTags = metadata.aiTags?.filter((t) => t !== tag) || [];\n\t\t\t} else {\n\t\t\t\tmetadata.tags = metadata.tags?.filter((t) => t !== tag) || [];\n\t\t\t}\n\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ metadata })\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t}\n\t}\n\n\tasync function editTag(oldTag: string, newTag: string, type: 'ai' | 'user') {\n\t\tif (!file?._id || !newTag.trim() || oldTag === newTag) {\n\t\t\teditingTag = null;\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst metadata = { ...file.metadata };\n\t\t\tif (type === 'ai') {\n\t\t\t\tmetadata.aiTags = metadata.aiTags?.map((t) => (t === oldTag ? newTag.trim() : t)) || [];\n\t\t\t} else {\n\t\t\t\tmetadata.tags = metadata.tags?.map((t) => (t === oldTag ? newTag.trim() : t)) || [];\n\t\t\t}\n\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ metadata })\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t} finally {\n\t\t\teditingTag = null;\n\t\t}\n\t}\n\n\tasync function saveAITags() {\n\t\tif (!file?._id) return;\n\t\tisSaving = true;\n\t\ttry {\n\t\t\t// Merge AI tags into User tags\n\t\t\tconst currentTags = new Set(file.metadata?.tags || []);\n\t\t\tfile.metadata?.aiTags?.forEach((t) => currentTags.add(t));\n\n\t\t\tconst response = await fetch(`/api/media/${file._id}`, {\n\t\t\t\tmethod: 'PATCH',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...file.metadata,\n\t\t\t\t\t\ttags: Array.from(currentTags),\n\t\t\t\t\t\taiTags: [] // Clear AI tags after saving\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t});\n\t\t\tconst result = await response.json();\n\t\t\tif (!response.ok || !result.success) throw new Error(result.error);\n\n\t\t\tif (file) {\n\t\t\t\tfile = result.data;\n\t\t\t\tonUpdate(result.data);\n\t\t\t}\n\t\t\ttoaster.success({ description: 'Tags saved!' });\n\t\t} catch (e: any) {\n\t\t\ttoaster.error({ description: e.message });\n\t\t} finally {\n\t\t\tisSaving = false;\n\t\t}\n\t}\n\n\tfunction close() {\n\t\tshow = false;\n\t}\n\n\tfunction autofocus(node: HTMLElement) {\n\t\tnode.focus();\n\t}\n</script>\n\n{#if show && file}\n\t<div\n\t\tclass=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm\"\n\t\trole=\"dialog\"\n\t\taria-modal=\"true\"\n\t\ttabindex=\"-1\"\n\t\tonclick={(e) => {\n\t\t\tif (e.target === e.currentTarget) close();\n\t\t}}\n\t\tonkeydown={(e) => e.key === 'Escape' && close()}\n\t>\n\t\t<div class=\"card w-full max-w-lg p-4 bg-surface-100 dark:bg-surface-800 shadow-xl m-4\" role=\"document\">\n\t\t\t<header class=\"flex justify-between items-center mb-4\">\n\t\t\t\t<h3 class=\"h3 font-bold\">Manage Tags</h3>\n\t\t\t\t<button class=\"btn-icon btn-icon-sm\" onclick={close} aria-label=\"Close Modal\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</header>\n\n\t\t\t<div class=\"space-y-4 max-h-[60vh] overflow-y-auto p-1\">\n\t\t\t\t<!-- File Info Summary -->\n\t\t\t\t<div class=\"flex items-center gap-3 p-2 bg-surface-200 dark:bg-surface-700 rounded\">\n\t\t\t\t\t<img src={getImageUrl(file)} alt=\"Thumbnail\" class=\"w-12 h-12 object-cover rounded bg-black\" />\n\t\t\t\t\t<div class=\"text-sm truncate\">\n\t\t\t\t\t\t<div class=\"font-bold truncate\">{file.filename}</div>\n\t\t\t\t\t\t<div class=\"opacity-70 text-xs\">{file.mimeType}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<!-- AI/Pending Tags -->\n\t\t\t\t<section class=\"p-3 border border-primary-500/30 rounded bg-primary-50/50 dark:bg-primary-900/10\">\n\t\t\t\t\t<div class=\"flex justify-between items-center mb-2\">\n\t\t\t\t\t\t<span class=\"text-sm font-bold flex items-center gap-1 text-primary-600 dark:text-primary-400\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:robot-excited-outline\"></iconify-icon>\n\t\t\t\t\t\t\tAI / Pending Tags\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t{#if !file.metadata?.aiTags?.length}\n\t\t\t\t\t\t\t<button class=\"btn btn-sm variant-filled-secondary\" onclick={handleAITagging} disabled={isGenerating}>\n\t\t\t\t\t\t\t\t{#if isGenerating}\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"eos-icons:loading\" class=\"animate-spin\"></iconify-icon>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:magic-staff\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t<span>Generate</span>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"flex flex-wrap gap-2 mb-3\">\n\t\t\t\t\t\t{#if file.metadata?.aiTags?.length}\n\t\t\t\t\t\t\t{#each file.metadata.aiTags as tag, i}\n\t\t\t\t\t\t\t\t{#if editingTag?.type === 'ai' && editingTag.index === i}\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\tvalue={editingTag.value}\n\t\t\t\t\t\t\t\t\t\tclass=\"input input-sm w-24 px-1 py-0 text-xs\"\n\t\t\t\t\t\t\t\t\t\toninput={(e) => (editingTag!.value = e.currentTarget.value)}\n\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter') editTag(tag, editingTag!.value, 'ai');\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Escape') editingTag = null;\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonblur={() => editTag(tag, editingTag!.value, 'ai')}\n\t\t\t\t\t\t\t\t\t\tuse:autofocus\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\tclass=\"badge variant-filled-secondary flex items-center gap-1 cursor-pointer hover:ring-2 hover:ring-secondary-300\"\n\t\t\t\t\t\t\t\t\t\tonclick={() => (editingTag = { type: 'ai', index: i, value: tag })}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{tag}\n\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\t\t\tremoveTag(tag, 'ai');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => e.key === 'Enter' && removeTag(tag, 'ai')}\n\t\t\t\t\t\t\t\t\t\t\taria-label=\"Remove Tag\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"14\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<div class=\"text-xs opacity-60 italic\">No pending tags.</div>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"flex gap-2\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tclass=\"input input-sm flex-1\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tplaceholder=\"Add tag manually...\"\n\t\t\t\t\t\t\tbind:value={newTagInput}\n\t\t\t\t\t\t\tonkeydown={(e) => e.key === 'Enter' && addManualTag()}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<button class=\"btn btn-sm variant-filled-surface\" onclick={addManualTag} disabled={!newTagInput.trim()} aria-label=\"Add Tag\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:plus\"></iconify-icon>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{#if file.metadata?.aiTags?.length}\n\t\t\t\t\t\t<div class=\"mt-3 pt-3 border-t border-primary-500/20\">\n\t\t\t\t\t\t\t<button class=\"btn btn-sm variant-filled-success w-full\" onclick={saveAITags} disabled={isSaving}>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:check-all\"></iconify-icon>\n\t\t\t\t\t\t\t\t<span>Save All to Media Tags</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/if}\n\t\t\t\t</section>\n\n\t\t\t\t<!-- Saved Tags -->\n\t\t\t\t<section class=\"p-3 border border-surface-300 dark:border-surface-600 rounded bg-surface-50 dark:bg-surface-900\">\n\t\t\t\t\t<div class=\"mb-2 text-sm font-bold opacity-80\">Saved Tags</div>\n\t\t\t\t\t<div class=\"flex flex-wrap gap-2\">\n\t\t\t\t\t\t{#if file.metadata?.tags?.length}\n\t\t\t\t\t\t\t{#each file.metadata.tags as tag, i}\n\t\t\t\t\t\t\t\t{#if editingTag?.type === 'user' && editingTag.index === i}\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\t\t\tvalue={editingTag.value}\n\t\t\t\t\t\t\t\t\t\tclass=\"input input-sm w-24 px-1 py-0 text-xs\"\n\t\t\t\t\t\t\t\t\t\toninput={(e) => (editingTag!.value = e.currentTarget.value)}\n\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Enter') editTag(tag, editingTag!.value, 'user');\n\t\t\t\t\t\t\t\t\t\t\tif (e.key === 'Escape') editingTag = null;\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tonblur={() => editTag(tag, editingTag!.value, 'user')}\n\t\t\t\t\t\t\t\t\t\tuse:autofocus\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\tclass=\"badge variant-filled-surface flex items-center gap-1 cursor-pointer hover:ring-2 hover:ring-surface-400\"\n\t\t\t\t\t\t\t\t\t\tonclick={() => (editingTag = { type: 'user', index: i, value: tag })}\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{tag}\n\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\t\t\tremoveTag(tag, 'user');\n\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => e.key === 'Enter' && removeTag(tag, 'user')}\n\t\t\t\t\t\t\t\t\t\t\taria-label=\"Remove Tag\"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"14\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<div class=\"text-xs opacity-60 italic\">No saved tags.</div>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t</section>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n{/if}\n","<!--\n@file src/routes/(app)/mediagallery/MediaGrid.svelte\n@component\n**Grid view component for the media gallery. Displays media items in a responsive grid layout with file information and actions**\n\n```tsx\n<MediaGrid filteredFiles={filteredFiles} gridSize=\"small\" />\n```\n#### Props\n- `filteredFiles: MediaBase[]`: An array of media items to be displayed in the grid view.\n- `gridSize: 'small' | 'medium' | 'large'`: The size of the grid layout to be used.\t\n\nKey features:\n- Responsive grid layout for media items\n- Display of file name, size, and type\n- Thumbnail preview for images\n- Actions for file info, edit, and delete\n- Uses formatBytes for human-readable file sizes\n- Implements constructMediaUrl for proper URL handling\n-->\n\n<script lang=\"ts\">\n\t// Utils\n\timport { formatBytes } from '@shared/utils/utils';\n\timport { logger } from '@shared/utils/logger';\n\timport type { MediaImage, MediaBase } from '@shared/utils/media/mediaModels';\n\n\t// Skeleton\n\timport { Tooltip, Portal } from '@skeletonlabs/skeleton-svelte';\n\t// Svelte transitions\n\timport { scale } from 'svelte/transition';\n\timport { quintOut } from 'svelte/easing';\n\n\timport TagEditorModal from '@cms/components/media/tagEditor/TagEditorModal.svelte';\n\n\tinterface Props {\n\t\tfilteredFiles?: (MediaBase | MediaImage)[];\n\t\tgridSize?: 'tiny' | 'small' | 'medium' | 'large';\n\t\tondeleteImage?: (file: MediaBase | MediaImage) => void;\n\t\tonBulkDelete?: (files: (MediaBase | MediaImage)[]) => void;\n\t\tonEditImage?: (file: MediaImage) => void;\n\t\tonsizechange?: (detail: { size: string; type: string }) => void;\n\t\tonUpdateImage?: (file: MediaImage) => void;\n\t}\n\n\tconst {\n\t\tfilteredFiles = $bindable([]),\n\t\tgridSize = 'medium',\n\t\tondeleteImage = () => {},\n\t\tonBulkDelete = () => {},\n\t\tonEditImage = () => {},\n\t\tonsizechange = () => {},\n\t\tonUpdateImage = () => {}\n\t}: Props = $props();\n\n\tlet showInfo = $state<boolean[]>([]);\n\tlet selectedFiles = $state<Set<string>>(new Set());\n\tlet isSelectionMode = $state(false);\n\n\t// Tag Modal State\n\tlet showTagModal = $state(false);\n\tlet taggingFile = $state<MediaImage | null>(null);\n\n\tfunction openTagEditor(file: MediaImage) {\n\t\ttaggingFile = file;\n\t\tshowTagModal = true;\n\t}\n\n\t// Format MIME type for display\n\tfunction formatMimeType(mime?: string): string {\n\t\tif (!mime) return 'Unknown';\n\t\tconst parts = mime.split('/');\n\t\treturn parts[1] ? parts[1].toUpperCase() : parts[0].toUpperCase();\n\t}\n\n\t// Helper: Get icon string\n\tfunction getFileIcon(file: MediaBase): string {\n\t\t// Fallback if path is missing or not a string\n\t\tconst fileName = file.filename || '';\n\t\tconst fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();\n\n\t\tswitch (true) {\n\t\t\tcase file.type === 'image':\n\t\t\t\treturn 'fa-solid:image';\n\t\t\tcase file.type === 'video':\n\t\t\t\treturn 'fa-solid:video';\n\t\t\tcase file.type === 'audio':\n\t\t\t\treturn 'fa-solid:play-circle';\n\t\t\tcase fileExt === '.pdf':\n\t\t\t\treturn 'vscode-icons:file-type-pdf2';\n\t\t\tcase fileExt === '.doc' || fileExt === '.docx' || fileExt === '.docm':\n\t\t\t\treturn 'vscode-icons:file-type-word';\n\t\t\tcase fileExt === '.ppt' || fileExt === '.pptx':\n\t\t\t\treturn 'vscode-icons:file-type-powerpoint';\n\t\t\tcase fileExt === '.xls' || fileExt === '.xlsx':\n\t\t\t\treturn 'vscode-icons:file-type-excel';\n\t\t\tcase fileExt === '.txt':\n\t\t\t\treturn 'fa-solid:file-lines';\n\t\t\tcase fileExt === '.zip' || fileExt === '.rar':\n\t\t\t\treturn 'fa-solid:file-zipper';\n\t\t\tdefault:\n\t\t\t\treturn 'vscode-icons:file';\n\t\t}\n\t}\n\n\tfunction handleDelete(file: MediaBase | MediaImage) {\n\t\tondeleteImage(file);\n\t}\n\n\tfunction toggleSelection(file: MediaBase | MediaImage) {\n\t\tconst fileId = file._id?.toString() || file.filename;\n\t\tif (selectedFiles.has(fileId)) {\n\t\t\tselectedFiles.delete(fileId);\n\t\t} else {\n\t\t\tselectedFiles.add(fileId);\n\t\t}\n\t\tselectedFiles = selectedFiles; // Trigger reactivity\n\t}\n\n\tfunction selectAll() {\n\t\tselectedFiles = new Set(filteredFiles.map((f) => f._id?.toString() || f.filename));\n\t}\n\n\tfunction deselectAll() {\n\t\tselectedFiles = new Set();\n\t}\n\n\tfunction handleBulkDelete() {\n\t\tconst filesToDelete = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToDelete.length > 0) {\n\t\t\tonBulkDelete(filesToDelete);\n\t\t\tselectedFiles = new Set();\n\t\t\tisSelectionMode = false;\n\t\t}\n\t}\n\n\t// Update showInfo array when filteredFiles length changes\n\t$effect(() => {\n\t\tshowInfo = Array.from({ length: filteredFiles.length }, () => false);\n\t});\n\n\tfunction getThumbnails(file: MediaBase | MediaImage) {\n\t\treturn 'thumbnails' in file ? file.thumbnails || {} : {};\n\t}\n\n\tfunction getThumbnail(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnails = getThumbnails(file);\n\t\t// Map UI grid sizes to DB keys\n\t\tconst sizeMap: Record<string, string> = {\n\t\t\ttiny: 'thumbnail',\n\t\t\tsmall: 'sm',\n\t\t\tmedium: 'md',\n\t\t\tlarge: 'lg'\n\t\t};\n\t\tconst key = sizeMap[size] || size;\n\t\treturn thumbnails ? thumbnails[key as keyof typeof thumbnails] : undefined;\n\t}\n\n\tfunction getImageUrl(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnail = getThumbnail(file, size);\n\t\treturn thumbnail?.url || (file as any).url;\n\t}\n</script>\n\n<div class=\"flex flex-wrap items-center gap-4 overflow-auto\">\n\t{#if filteredFiles.length === 0}\n\t\t<div class=\"mx-auto text-center text-tertiary-500 dark:text-primary-500\">\n\t\t\t<iconify-icon icon=\"bi:exclamation-circle-fill\" height=\"44\" class=\"mb-2\"></iconify-icon>\n\t\t\t<p class=\"text-lg\">No media found</p>\n\t\t</div>\n\t{:else}\n\t\t<!-- Batch Operations Toolbar -->\n\t\t<div class=\"mb-4 flex w-full items-center justify-between gap-2 rounded border border-surface-400 bg-surface-100 p-2 dark:bg-surface-700\">\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\tisSelectionMode = !isSelectionMode;\n\t\t\t\t\t\tselectedFiles = new Set();\n\t\t\t\t\t}}\n\t\t\t\t\tclass=\"preset-outline-surface-500 btn-sm\"\n\t\t\t\t\taria-label=\"Toggle selection mode\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon={isSelectionMode ? 'mdi:close' : 'mdi:checkbox-multiple-marked'} width=\"20\"></iconify-icon>\n\t\t\t\t\t{isSelectionMode ? 'Cancel' : 'Select'}\n\t\t\t\t</button>\n\n\t\t\t\t{#if isSelectionMode}\n\t\t\t\t\t<button onclick={selectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:select-all\" width=\"20\"></iconify-icon>\n\t\t\t\t\t\tSelect All\n\t\t\t\t\t</button>\n\t\t\t\t\t<button onclick={deselectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:select-off\" width=\"20\"></iconify-icon>\n\t\t\t\t\t\tDeselect All\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t</div>\n\n\t\t\t{#if selectedFiles.size > 0}\n\t\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t\t<span class=\"text-sm\">{selectedFiles.size} selected</span>\n\t\t\t\t\t<button onclick={handleBulkDelete} class=\"preset-filled-error-500 btn-sm\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:delete\" width=\"20\"></iconify-icon>\n\t\t\t\t\t\tDelete Selected\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t{/if}\n\t\t</div>\n\n\t\t{#each filteredFiles as file, index (file._id?.toString() || file.filename)}\n\t\t\t{@const fileId = file._id?.toString() || file.filename}\n\t\t\t{@const isSelected = selectedFiles.has(fileId)}\n\t\t\t<div\n\t\t\t\tonmouseenter={() => (showInfo[index] = true)}\n\t\t\t\tonmouseleave={() => (showInfo[index] = false)}\n\t\t\t\tonclick={() => isSelectionMode && toggleSelection(file)}\n\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\tif (isSelectionMode && (e.key === 'Enter' || e.key === ' ')) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\ttoggleSelection(file);\n\t\t\t\t\t}\n\t\t\t\t}}\n\t\t\t\trole=\"button\"\n\t\t\t\ttabindex=\"0\"\n\t\t\t\tclass=\"card relative border border-surface-300 dark:border-surface-500 {isSelected ? 'ring-2 ring-primary-500' : ''}\"\n\t\t\t\tin:scale={{ duration: 300, start: 0.9, opacity: 0, easing: quintOut }}\n\t\t\t\tout:scale={{ duration: 250, start: 0.95, opacity: 0, easing: quintOut }}\n\t\t\t>\n\t\t\t\t{#if isSelectionMode}\n\t\t\t\t\t<div class=\"absolute left-2 top-2 z-10\">\n\t\t\t\t\t\t<input type=\"checkbox\" checked={isSelected} onchange={() => toggleSelection(file)} class=\"checkbox\" aria-label=\"Select file\" />\n\t\t\t\t\t</div>\n\t\t\t\t{/if}\n\n\t\t\t\t<header class=\"m-2 flex w-auto items-center justify-between\">\n\t\t\t\t\t<!-- Info Tooltip -->\n\t\t\t\t\t<Tooltip positioning={{ placement: 'right' }}>\n\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t<button aria-label=\"File Info\" class=\"btn-icon\" title=\"File Info\">\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"raphael:info\" width=\"24\" class=\"text-tertiary-500 dark:text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded-container-token z-50 border border-surface-500 bg-surface-50 p-2 shadow-xl dark:bg-surface-900\">\n\t\t\t\t\t\t\t\t\t<table class=\"table-auto text-xs\">\n\t\t\t\t\t\t\t\t\t\t<thead class=\"text-tertiary-500\">\n\t\t\t\t\t\t\t\t\t\t\t<tr class=\"divide-x divide-surface-400 border-b-2 border-surface-400 text-center\">\n\t\t\t\t\t\t\t\t\t\t\t\t<th class=\"px-2 text-left\">Format</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class=\"px-2\">Pixel</th>\n\t\t\t\t\t\t\t\t\t\t\t\t<th class=\"px-2\">Size</th>\n\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t\t{#if 'width' in file && file.width && 'height' in file && file.height}\n\t\t\t\t\t\t\t\t\t\t\t\t<tr\n\t\t\t\t\t\t\t\t\t\t\t\t\t><td class=\"px-2 font-semibold\">Original:</td><td class=\"px-2\">{file.width}x{file.height}</td><td class=\"px-2\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t>{formatBytes(file.size)}</td\n\t\t\t\t\t\t\t\t\t\t\t\t\t></tr\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t{#each Object.keys(getThumbnails(file)) as size (size)}\n\t\t\t\t\t\t\t\t\t\t\t\t{@const thumbnail = getThumbnail(file, size)}\n\t\t\t\t\t\t\t\t\t\t\t\t{#if thumbnail}\n\t\t\t\t\t\t\t\t\t\t\t\t\t<tr\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclass=\"divide-x divide-surface-400 border-b border-surface-400 last:border-b-0 {size === gridSize\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'bg-primary-50 dark:bg-primary-900/20'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: ''}\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (size === 'tiny' || size === 'small' || size === 'medium' || size === 'large') {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tonsizechange({\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tsize: size === 'tiny' ? 'small' : size === 'small' ? 'medium' : size === 'medium' ? 'large' : 'tiny',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: 'grid'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class=\"px-2 font-bold text-tertiary-500\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t>{size}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{#if size === gridSize}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"ml-1 text-[10px] text-primary-500\">(active)</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class=\"px-2 text-right\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{#if thumbnail.width && thumbnail.height}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{thumbnail.width}x{thumbnail.height}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tN/A\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td class=\"px-2 text-right\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{#if thumbnail.size}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{formatBytes(thumbnail.size)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{:else if size === 'original' && file.size}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{formatBytes(file.size)}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tN/A\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-50 dark:fill-surface-900\" />\n\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t</Portal>\n\t\t\t\t\t</Tooltip>\n\n\t\t\t\t\t<div class=\"flex items-center gap-1\">\n\t\t\t\t\t\t{#if file.type === 'image'}\n\t\t\t\t\t\t\t<!-- Toggle Tags Tooltip -->\n\t\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t<button onclick={() => openTagEditor(file as MediaImage)} aria-label=\"Toggle Tags\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t{#if file.metadata?.aiTags?.length || file.metadata?.tags?.length}\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:tag-multiple\" width=\"22\" class=\"text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:tag-outline\" width=\"22\" class=\"text-surface-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\t\tView/Edit Tags\n\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t\t</Tooltip>\n\n\t\t\t\t\t\t\t<!-- Edit Tooltip -->\n\t\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t<button onclick={() => onEditImage(file as MediaImage)} aria-label=\"Edit\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:pen\" width=\"24\" class=\"text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\t\tEdit Image\n\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t<!-- Delete Tooltip -->\n\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t<button onclick={() => handleDelete(file)} aria-label=\"Delete\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"icomoon-free:bin\" width=\"24\" class=\"text-error-500\"> </iconify-icon>\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\tDelete Image\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t</div>\n\t\t\t\t</header>\n\n\t\t\t\t<section class=\"flex items-center justify-center p-2\">\n\t\t\t\t\t{#if file?.filename && file?.path && file?.hash}\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc={getImageUrl(file, gridSize) ?? '/static/Default_User.svg'}\n\t\t\t\t\t\t\talt={`Thumbnail for ${file.filename}`}\n\t\t\t\t\t\t\tclass={`rounded object-cover ${\n\t\t\t\t\t\t\t\tgridSize === 'tiny' ? 'h-16 w-16' : gridSize === 'small' ? 'h-24 w-24' : gridSize === 'medium' ? 'h-48 w-48' : 'h-80 w-80'\n\t\t\t\t\t\t\t}`}\n\t\t\t\t\t\t\tonerror={(e: Event) => {\n\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\n\t\t\t\t\t\t\t\tif (target) {\n\t\t\t\t\t\t\t\t\tlogger.error('Failed to load media thumbnail for file:', file.filename);\n\t\t\t\t\t\t\t\t\ttarget.src = '/static/Default_User.svg';\n\t\t\t\t\t\t\t\t\ttarget.alt = 'Fallback thumbnail image';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tloading=\"lazy\"\n\t\t\t\t\t\t\tdecoding=\"async\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t{:else}\n\t\t\t\t\t\t<div class=\"flex h-full w-full items-center justify-center bg-surface-200 dark:bg-surface-700\" aria-label=\"Missing thumbnail\" role=\"img\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-triangle-fill\" height=\"24\" class=\"text-warning-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/if}\n\t\t\t\t</section>\n\n\t\t\t\t<!-- Media Filename (LocalUpload Style) -->\n\t\t\t\t<div class=\"label overflow-hidden text-ellipsis whitespace-nowrap p-1 text-center font-bold text-xs\" title={file.filename}>\n\t\t\t\t\t{file.filename}\n\t\t\t\t</div>\n\n\t\t\t\t<footer class=\"flex flex-col gap-2 p-1\">\n\t\t\t\t\t<!-- Tags Overlay Removed -->\n\n\t\t\t\t\t<!-- Media Type & Size (Footer - LocalUpload Style) -->\n\t\t\t\t\t<div class=\"flex grow items-center justify-between p-1 text-white\">\n\t\t\t\t\t\t<!-- Type -->\n\t\t\t\t\t\t<div class=\"bg-tertiary-500 dark:bg-primary-500/50 badge flex items-center gap-1 overflow-hidden\" title={file.type}>\n\t\t\t\t\t\t\t<iconify-icon icon={getFileIcon(file)} width=\"12\" height=\"12\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"truncate text-[10px] uppercase\">{formatMimeType(file.mimeType)}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<!-- Size -->\n\t\t\t\t\t\t<p class=\"bg-tertiary-500 dark:bg-primary-500/50 badge flex shrink-0 items-center gap-1 text-[10px]\">\n\t\t\t\t\t\t\t<span class=\"\">{(file.size / 1024).toFixed(2)}</span>\n\t\t\t\t\t\t\tKB\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t</footer>\n\t\t\t</div>\n\t\t{/each}\n\t{/if}\n</div>\n\n<TagEditorModal bind:show={showTagModal} bind:file={taggingFile} onUpdate={onUpdateImage} />\n\n<style>\n\t/* Smooth transitions for grid layout changes */\n\t.card {\n\t\ttransition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n\t}\n\n\t/* Smooth grid item repositioning */\n\t:global(.flex.flex-wrap) {\n\t\ttransition: all 0.3s ease-out;\n\t}\n</style>\n","<!--\n@file src/routes/(app)/mediagallery/MediaTable.svelte\n@component\n**Table view component for the media gallery. Displays media items in a responsive table layout with sortable columns**\n\n```tsx\n<MediaTable filteredFiles={filteredFiles} tableSize=\"small\" />\n```\n#### Props\n- `filteredFiles: MediaBase[]`: An array of media items to be displayed in the table view.\n- `tableSize: 'small' | 'medium' | 'large'`: The size of the table layout to be used.\n- `ondeleteImage?: (file: MediaBase) => void`: An optional callback function to handle image deletion.\n- `onSelectionChange?: (selectedFiles: MediaBase[]) => void`: An optional callback function to handle selection changes.\n- `onUpdateImage?: (file: MediaImage) => void`: Callback for updating image data.\n\nKey features:\n- Responsive table layout for media items\n- Sortable columns for name, size, type, and date\n- Thumbnail preview for images\n- Uses formatBytes for human-readable file sizes\n- Implements constructMediaUrl for proper URL handling\n- Pagination support (if implemented in parent component)\n- Selection support with callback function\n- Tag management via TagEditorModal\n-->\n\n<script lang=\"ts\">\n\t// Utils\n\timport type { MediaBase, MediaImage, MediaTypeEnum } from '@shared/utils/media/mediaModels';\n\timport { logger } from '@shared/utils/logger';\n\timport { formatBytes } from '@shared/utils/utils';\n\t// Components\n\timport TableFilter from '@cms/components/system/table/TableFilter.svelte';\n\timport TableIcons from '@cms/components/system/table/TableIcons.svelte';\n\timport TablePagination from '@cms/components/system/table/TablePagination.svelte';\n\timport TagEditorModal from '@cms/components/media/tagEditor/TagEditorModal.svelte';\n\timport { Tooltip, Portal } from '@skeletonlabs/skeleton-svelte';\n\n\tinterface Props {\n\t\tfilteredFiles?: (MediaBase | MediaImage)[];\n\t\ttableSize?: 'tiny' | 'small' | 'medium' | 'large';\n\t\tondeleteImage?: (file: MediaBase | MediaImage) => void;\n\t\tonSelectionChange?: (selectedFiles: (MediaBase | MediaImage)[]) => void;\n\t\tonUpdateImage?: (file: MediaImage) => void;\n\t\tonEditImage?: (file: MediaImage) => void;\n\t\tonDeleteFiles?: (files: (MediaBase | MediaImage)[]) => void;\n\t}\n\n\tinterface SortableMedia extends MediaBase {\n\t\tfilename: string;\n\t\tsize: number;\n\t\ttype: MediaTypeEnum;\n\t}\n\n\tlet {\n\t\tfilteredFiles = $bindable([]),\n\t\ttableSize = 'medium',\n\t\tondeleteImage = () => {},\n\t\tonSelectionChange = () => {},\n\t\tonUpdateImage = () => {},\n\t\tonEditImage = () => {},\n\t\tonDeleteFiles = () => {}\n\t}: Props = $props();\n\n\t// Filter state\n\tlet globalSearchValue = $state('');\n\tlet filterShow = $state(false);\n\tlet columnShow = $state(false);\n\tlet density = $state('normal');\n\n\t// Selection state\n\tconst selectedFiles = $state<Set<string>>(new Set());\n\n\t// Tag Modal State\n\tlet showTagModal = $state(false);\n\tlet taggingFile = $state<MediaImage | null>(null);\n\n\tfunction openTagEditor(file: MediaImage) {\n\t\ttaggingFile = file;\n\t\tshowTagModal = true;\n\t}\n\n\tfunction handleSelection(file: MediaBase | MediaImage, checked: boolean) {\n\t\tif (checked) {\n\t\t\tselectedFiles.add(file.filename);\n\t\t} else {\n\t\t\tselectedFiles.delete(file.filename);\n\t\t}\n\t\tonSelectionChange(filteredFiles.filter((f) => selectedFiles.has(f.filename)));\n\t}\n\n\t// Pagination state\n\tlet currentPage = $state(1);\n\tlet rowsPerPage = $state(10);\n\tconst pagesCount = $derived(Math.ceil(filteredFiles.length / rowsPerPage));\n\tconst paginatedFiles = $derived(filteredFiles.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage));\n\n\tfunction handleDelete(file: MediaBase | MediaImage) {\n\t\tondeleteImage(file);\n\t}\n\n\t// Sorting functionality\n\tlet sortColumn = $state('name');\n\tlet sortOrder = $state(1); // 1 for ascending, -1 for descending\n\n\tfunction sort(column: keyof Pick<SortableMedia, 'filename' | 'size' | 'type'>) {\n\t\tif (sortColumn === column) {\n\t\t\tsortOrder *= -1;\n\t\t} else {\n\t\t\tsortColumn = column;\n\t\t\tsortOrder = 1;\n\t\t}\n\n\t\tfilteredFiles = filteredFiles.sort((a, b) => {\n\t\t\tif (column === 'size') {\n\t\t\t\treturn ((a[column] ?? 0) - (b[column] ?? 0)) * sortOrder;\n\t\t\t} else {\n\t\t\t\treturn String(a[column as keyof SortableMedia]).localeCompare(String(b[column as keyof SortableMedia])) * sortOrder;\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction getThumbnails(file: MediaBase | MediaImage) {\n\t\treturn 'thumbnails' in file ? file.thumbnails || {} : {};\n\t}\n\n\tfunction getThumbnail(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnails = getThumbnails(file);\n\t\t// Map UI table sizes to DB keys\n\t\tconst sizeMap: Record<string, string> = {\n\t\t\ttiny: 'thumbnail', // or 'xs'\n\t\t\tsmall: 'sm',\n\t\t\tmedium: 'md',\n\t\t\tlarge: 'lg'\n\t\t};\n\t\tconst key = sizeMap[size] || size;\n\t\treturn thumbnails ? thumbnails[key as keyof typeof thumbnails] : undefined;\n\t}\n\n\tfunction getImageUrl(file: MediaBase | MediaImage, size: string) {\n\t\tconst thumbnail = getThumbnail(file, size);\n\t\treturn thumbnail?.url || (file as any).url;\n\t}\n</script>\n\n<div class=\"block w-full overflow-hidden\">\n\t{#if filteredFiles.length === 0}\n\t\t<div class=\"mx-auto text-center text-tertiary-500 dark:text-primary-500\">\n\t\t\t<iconify-icon icon=\"bi:exclamation-circle-fill\" height=\"44\" class=\"mb-2\"></iconify-icon>\n\t\t\t<p class=\"text-lg\">No media found</p>\n\t\t</div>\n\t{:else}\n\t\t<!-- Header with Filter -->\n\t\t<div class=\"mb-4 flex items-center justify-between\">\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<h2 class=\"text-lg font-bold\">Media Files</h2>\n\t\t\t\t{#if selectedFiles.size > 0}\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"variant-filled-error btn btn-sm ml-4\"\n\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\tconst filesToDelete = filteredFiles.filter((f) => selectedFiles.has(f.filename));\n\t\t\t\t\t\t\tonDeleteFiles(filesToDelete);\n\t\t\t\t\t\t\tselectedFiles.clear();\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:trash-can-outline\"></iconify-icon>\n\t\t\t\t\t\t<span>Delete ({selectedFiles.size})</span>\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t</div>\n\n\t\t\t<!-- TODO: move to +page.svelte -->\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<TableFilter bind:globalSearchValue bind:filterShow bind:columnShow bind:density />\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div class=\"table-container max-h-[calc(100vh-120px)] overflow-auto\">\n\t\t\t<table class=\"table table-interactive table-hover\">\n\t\t\t\t<thead class=\"bg-surface-100-800-token sticky top-0 text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t\t<tr class=\"divide-x divide-surface-400 border-b border-black dark:border-white text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t\t\t<th class=\"w-10\">Select</th>\n\t\t\t\t\t\t<th>Thumbnail</th>\n\t\t\t\t\t\t<!-- Name -->\n\t\t\t\t\t\t<th onclick={() => sort('filename')}>\n\t\t\t\t\t\t\tName {sortColumn === 'filename' ? (sortOrder === 1 ? '' : '') : ''}\n\t\t\t\t\t\t</th>\n\t\t\t\t\t\t<!-- Size -->\n\t\t\t\t\t\t<th onclick={() => sort('size')}>\n\t\t\t\t\t\t\tSize {sortColumn === 'size' ? (sortOrder === 1 ? '' : '') : ''}\n\t\t\t\t\t\t</th>\n\t\t\t\t\t\t<!-- Type -->\n\t\t\t\t\t\t<th onclick={() => sort('type')}>\n\t\t\t\t\t\t\tType {sortColumn === 'type' ? (sortOrder === 1 ? '' : '') : ''}\n\t\t\t\t\t\t</th>\n\t\t\t\t\t\t<!-- Path -->\n\t\t\t\t\t\t<th>Path</th>\n\t\t\t\t\t\t<!-- Tags (Moved Here) -->\n\t\t\t\t\t\t<th>Tags</th>\n\t\t\t\t\t\t<!-- Actions -->\n\t\t\t\t\t\t<th>Actions</th>\n\t\t\t\t\t</tr>\n\t\t\t\t</thead>\n\t\t\t\t<tbody>\n\t\t\t\t\t{#each paginatedFiles as file (file._id)}\n\t\t\t\t\t\t<tr class=\"divide-x divide-surface-400 border-b border-black dark:border-white\">\n\t\t\t\t\t\t\t<TableIcons\n\t\t\t\t\t\t\t\tcellClass=\"w-10 text-center\"\n\t\t\t\t\t\t\t\tchecked={selectedFiles.has(file.filename)}\n\t\t\t\t\t\t\t\tonCheck={(checked: boolean) => handleSelection(file, checked)}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t{#if file?.filename && file?.path && file?.hash}\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={getImageUrl(file, tableSize) ?? '/Default_User.svg'}\n\t\t\t\t\t\t\t\t\t\talt={`Thumbnail for ${file.filename}`}\n\t\t\t\t\t\t\t\t\t\tclass={`object-cover ${tableSize === 'tiny' ? 'h-10 w-10' : tableSize === 'small' ? 'h-16 w-16' : tableSize === 'medium' ? 'h-24 w-24' : 'h-32 w-32'}`}\n\t\t\t\t\t\t\t\t\t\tonerror={(e: Event) => {\n\t\t\t\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\n\t\t\t\t\t\t\t\t\t\t\tif (target) {\n\t\t\t\t\t\t\t\t\t\t\t\tlogger.error('Failed to load media thumbnail for file:', file.filename);\n\t\t\t\t\t\t\t\t\t\t\t\ttarget.src = '/Default_User.svg';\n\t\t\t\t\t\t\t\t\t\t\t\ttarget.alt = 'Fallback thumbnail image';\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t\tloading=\"lazy\"\n\t\t\t\t\t\t\t\t\t\tdecoding=\"async\"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tclass=\"flex h-full w-full items-center justify-center bg-surface-200 dark:bg-surface-700\"\n\t\t\t\t\t\t\t\t\t\taria-label=\"Missing thumbnail\"\n\t\t\t\t\t\t\t\t\t\trole=\"img\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-triangle-fill\" height=\"24\" class=\"text-warning-500\" aria-hidden=\"true\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<td title={file.filename}>{file.filename}</td>\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t{#if file.size}\n\t\t\t\t\t\t\t\t\t{formatBytes(file.size)}\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\tSize unknown\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<td>{file.type || 'Unknown'}</td>\n\t\t\t\t\t\t\t<td>{file.path}</td>\n\t\t\t\t\t\t\t<!-- Tags Column (Moved Here) -->\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t<div class=\"flex flex-wrap gap-1\">\n\t\t\t\t\t\t\t\t\t{#if 'metadata' in file && (file.metadata?.tags?.length || file.metadata?.aiTags?.length)}\n\t\t\t\t\t\t\t\t\t\t{@const tags = file.metadata.tags || []}\n\t\t\t\t\t\t\t\t\t\t{@const aiTags = file.metadata.aiTags || []}\n\t\t\t\t\t\t\t\t\t\t{@const allTagsCount = tags.length + aiTags.length}\n\n\t\t\t\t\t\t\t\t\t\t{#if tags.length > 0}\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"badge variant-filled-surface text-[10px]\">{tags[0]}</span>\n\t\t\t\t\t\t\t\t\t\t{:else if aiTags.length > 0}\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"badge variant-filled-secondary text-[10px]\">{aiTags[0]}</span>\n\t\t\t\t\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t\t\t\t\t{#if allTagsCount > 1}\n\t\t\t\t\t\t\t\t\t\t\t<span class=\"badge variant-soft text-[10px]\">+{allTagsCount - 1}</span>\n\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t<!-- Toggle Tags Tooltip -->\n\t\t\t\t\t\t\t\t\t<Tooltip positioning={{ placement: 'top' }}>\n\t\t\t\t\t\t\t\t\t\t<Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\t\t\t\tclass=\"btn-icon btn-icon-sm variant-soft-primary\"\n\t\t\t\t\t\t\t\t\t\t\t\tonclick={() => openTagEditor(file as MediaImage)}\n\t\t\t\t\t\t\t\t\t\t\t\taria-label=\"Manage Tags\"\n\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:tag-edit\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t\t</Tooltip.Trigger>\n\t\t\t\t\t\t\t\t\t\t<Portal>\n\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Content class=\"rounded bg-surface-900 px-2 py-1 text-xs text-white shadow-xl dark:bg-surface-100 dark:text-black\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tManage Tags\n\t\t\t\t\t\t\t\t\t\t\t\t\t<Tooltip.Arrow class=\"fill-surface-900 dark:fill-surface-100\" />\n\t\t\t\t\t\t\t\t\t\t\t\t</Tooltip.Content>\n\t\t\t\t\t\t\t\t\t\t\t</Tooltip.Positioner>\n\t\t\t\t\t\t\t\t\t\t</Portal>\n\t\t\t\t\t\t\t\t\t</Tooltip>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t<!-- Actions -->\n\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t<button class=\"preset-outlined-primary-500 btn-sm\" aria-label=\"Edit\" onclick={() => onEditImage(file as MediaImage)}>Edit</button>\n\t\t\t\t\t\t\t\t<button onclick={() => handleDelete(file)} class=\"preset-filled-error-500 btn-sm\" aria-label=\"Delete\"> Delete </button>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t{/each}\n\t\t\t\t</tbody>\n\t\t\t</table>\n\n\t\t\t<!-- Pagination -->\n\t\t\t<div\n\t\t\t\tclass=\" bg-surface-100-800-token sticky bottom-0 left-0 right-0 mt-2 flex flex-col items-center justify-center px-2 py-2 md:flex-row md:justify-between md:p-4\"\n\t\t\t>\n\t\t\t\t<TablePagination\n\t\t\t\t\tbind:currentPage\n\t\t\t\t\tbind:rowsPerPage\n\t\t\t\t\t{pagesCount}\n\t\t\t\t\ttotalItems={filteredFiles.length}\n\t\t\t\t\trowsPerPageOptions={[5, 10, 25, 50, 100]}\n\t\t\t\t\tonUpdatePage={(page: number) => {\n\t\t\t\t\t\tcurrentPage = page;\n\t\t\t\t\t}}\n\t\t\t\t\tonUpdateRowsPerPage={(rows: number) => {\n\t\t\t\t\t\trowsPerPage = rows;\n\t\t\t\t\t\tcurrentPage = 1;\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<!-- Tag Editor Modal -->\n\t<TagEditorModal bind:show={showTagModal} bind:file={taggingFile} onUpdate={onUpdateImage} />\n</div>\n","<!--\n@file src/routes/(app)/mediagallery/VirtualMediaGrid.svelte\n@component\n**Virtual scrolling grid for media gallery - handles 10,000+ files smoothly**\n\nImplements custom virtual scrolling without external dependencies.\n\n### Props\n- `filteredFiles: MediaImage[]`: An array of media items to be displayed in the grid view.\n- `gridSize: 'tiny' | 'small' | 'medium' | 'large'`: The size of the grid layout to be used.\n- `ondeleteImage?: (file: MediaImage) => void`: An optional callback function to handle image deletion.\n- `onBulkDelete?: (files: MediaImage[]) => void`: An optional callback function to handle bulk deletion.\n- `onBulkDownload?: (files: MediaImage[]) => void`: An optional callback function to handle bulk downloading.\n- `onBulkEdit?: (files: MediaImage[], action: string, value: any) => void`: An optional callback function to handle bulk editing.\n\n### Features:\n- Virtual scrolling for optimal performance\n- Batch operations (select, delete, download, edit)\n- Blur-up placeholders\n- Advanced search\n- Duplicate detection\n- Bulk edit operations\n-->\n\n<script lang=\"ts\">\n\timport { formatBytes } from '@shared/utils/utils';\n\n\timport type { MediaImage, MediaBase } from '@shared/utils/media/mediaModels';\n\t// import { popup } from '@skeletonlabs/skeleton-svelte';\n\timport { onMount } from 'svelte';\n\n\tinterface Props {\n\t\tfilteredFiles?: (MediaBase | MediaImage)[];\n\t\tgridSize?: 'tiny' | 'small' | 'medium' | 'large';\n\t\tondeleteImage?: (file: MediaBase | MediaImage) => void;\n\t\tonBulkDelete?: (files: (MediaBase | MediaImage)[]) => void;\n\t\tonBulkDownload?: (files: (MediaBase | MediaImage)[]) => void;\n\t\tonBulkEdit?: (files: (MediaBase | MediaImage)[], action: string, value: any) => void;\n\t\tonEditImage?: (file: MediaImage) => void;\n\t}\n\n\tconst {\n\t\tfilteredFiles = [],\n\t\tgridSize,\n\t\tondeleteImage = () => {},\n\t\tonBulkDelete = () => {},\n\t\tonBulkDownload = () => {},\n\t\tonBulkEdit = () => {},\n\t\tonEditImage = () => {}\n\t}: Props = $props();\n\n\t// Virtual scrolling state\n\tlet containerHeight = $state(600);\n\tlet scrollTop = $state(0);\n\tconst itemHeight = $derived(gridSize === 'tiny' ? 120 : gridSize === 'small' ? 160 : gridSize === 'medium' ? 280 : 400);\n\tlet itemsPerRow = $state(5);\n\tconst visibleRows = $derived(Math.ceil(containerHeight / itemHeight) + 2); // +2 for buffer\n\tconst totalRows = $derived(Math.ceil(filteredFiles.length / itemsPerRow));\n\tconst startRow = $derived(Math.max(0, Math.floor(scrollTop / itemHeight) - 1));\n\tconst endRow = $derived(Math.min(totalRows, startRow + visibleRows));\n\tconst visibleItems = $derived(filteredFiles.slice(startRow * itemsPerRow, endRow * itemsPerRow));\n\tconst paddingTop = $derived(startRow * itemHeight);\n\tconst paddingBottom = $derived((totalRows - endRow) * itemHeight);\n\n\t// Selection and operations state\n\tlet selectedFiles = $state<Set<string>>(new Set());\n\tlet isSelectionMode = $state(false);\n\tlet activePopup = $state<string | null>(null);\n\tlet showBulkEditModal = $state(false);\n\tlet bulkEditAction = $state<'rename' | 'move' | 'tag'>('tag');\n\tlet bulkEditValue = $state('');\n\n\t// Container ref\n\tlet container: HTMLDivElement;\n\n\t// Keyboard navigation state\n\t// let focusedIndex = $state(-1);\n\n\t// Drag-to-select state (Unused/Incomplete)\n\t// let isDragging = $state(false);\n\t// let selectionStart = $state<{x: number, y: number} | null>(null);\n\t// let selectionRect = $state<{left: number, top: number, width: number, height: number} | null>(null);\n\n\t// Context menu state (Unused/Incomplete)\n\t// let contextMenu = $state<{x: number, y: number, file: MediaBase | MediaImage | null} | null>(null);\n\n\t// Computed item width for selection math\n\t// const itemWidth = $derived(gridSize === 'tiny' ? 100 : gridSize === 'small' ? 140 : gridSize === 'medium' ? 260 : 380);\n\n\t// Handle keyboard navigation (Unused - connect to window or container if needed)\n\t/*\n    function handleKeyDown(e: KeyboardEvent) {\n        if (!container) return;\n        \n        // Ignore if searching or editing\n        if ((e.target as HTMLElement).tagName === 'INPUT' || (e.target as HTMLElement).tagName === 'TEXTAREA') return;\n\n        if (e.key === 'Delete' && selectedFiles.size > 0) {\n            // Trigger bulk delete\n             const filesToDelete = filteredFiles.filter(f => selectedFiles.has(f._id?.toString() || f.filename));\n             if(filesToDelete.length > 0) onBulkDelete(filesToDelete);\n        } else if (e.ctrlKey && e.key === 'a') {\n             e.preventDefault();\n             // Select All\n             const newSet = new Set<string>();\n             filteredFiles.forEach(f => newSet.add(f._id?.toString() || f.filename));\n             selectedFiles = newSet;\n        } else if (e.key === 'Escape') {\n             // Clear selection or context menu\n             if (contextMenu) contextMenu = null;\n             else selectedFiles = new Set();\n        } else if (e.key === 'ArrowRight') {\n            e.preventDefault();\n            focusedIndex = Math.min(filteredFiles.length - 1, focusedIndex + 1);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === 'ArrowLeft') {\n            e.preventDefault();\n            focusedIndex = Math.max(0, focusedIndex - 1);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === 'ArrowDown') {\n            e.preventDefault();\n            focusedIndex = Math.min(filteredFiles.length - 1, focusedIndex + itemsPerRow);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === 'ArrowUp') {\n            e.preventDefault();\n            focusedIndex = Math.max(0, focusedIndex - itemsPerRow);\n            scrollToIndex(focusedIndex);\n        } else if (e.key === ' ' || e.key === 'Enter') {\n            e.preventDefault();\n            if (focusedIndex >= 0 && filteredFiles[focusedIndex]) {\n                 toggleSelection(filteredFiles[focusedIndex]);\n            }\n        }\n    }\n    */\n\n\t/*\n\tfunction scrollToIndex(index: number) {\n\t\tif (index < 0) return;\n\t\tconst row = Math.floor(index / itemsPerRow);\n\t\tconst top = row * itemHeight;\n\t\tconst bottom = top + itemHeight;\n\n\t\tif (top < scrollTop) {\n\t\t\tcontainer.scrollTop = top;\n\t\t} else if (bottom > scrollTop + container.clientHeight) {\n\t\t\tcontainer.scrollTop = bottom - container.clientHeight;\n\t\t}\n\t}\n\n\t// Drag Selection Logic (Unused)\n\t/*\n    function handleMouseDown(e: MouseEvent) {\n        // Ignore right click or if clicking on interactive elements\n        if (e.button !== 0 || (e.target as HTMLElement).closest('button') || (e.target as HTMLElement).closest('.interactive')) return;\n\n        // Clear context menu\n        contextMenu = null;\n\n        const rect = container.getBoundingClientRect();\n        const startX = e.clientX - rect.left + container.scrollLeft;\n        const startY = e.clientY - rect.top + container.scrollTop;\n\n        isDragging = true;\n        selectionStart = { x: startX, y: startY };\n        selectionRect = { left: startX, top: startY, width: 0, height: 0 };\n\n        // If not holding Ctrl/Shift, clear previous selection\n        if (!e.ctrlKey && !e.shiftKey) {\n            selectedFiles = new Set();\n        }\n    }\n\n    function handleMouseMove(e: MouseEvent) {\n        if (!isDragging || !selectionStart) return;\n\n        const rect = container.getBoundingClientRect();\n        const currentX = e.clientX - rect.left + container.scrollLeft;\n        const currentY = e.clientY - rect.top + container.scrollTop;\n\n        // Calculate selection box\n        const left = Math.min(selectionStart.x, currentX);\n        const top = Math.min(selectionStart.y, currentY);\n        const width = Math.abs(currentX - selectionStart.x);\n        const height = Math.abs(currentY - selectionStart.y);\n\n        selectionRect = { left, top, width, height };\n\n        // Select items intersecting with rect\n        // Optimization: only check items in relevant rows\n        const startRowIndex = Math.floor(top / itemHeight);\n        const endRowIndex = Math.floor((top + height) / itemHeight);\n        \n        // Temporary set for visual feedback during drag could be implemented, \n        // but for now we'll just update final selection on mouse up to avoid performance issues with 10k items\n        // OR we can do real-time selection if optimized.\n        // Let's do real-time selection update on a debounced set or just purely visual overlay for now?\n        // Actually, let's implement real-time selection for \"File Explorer\" feel.\n        selectItemsInRect(left, top, width, height, e.ctrlKey);\n    }\n\n    function handleMouseUp(e: MouseEvent) {\n        if (isDragging) {\n            isDragging = false;\n            selectionStart = null;\n            selectionRect = null;\n        }\n    }\n\n    function selectItemsInRect(left: number, top: number, width: number, height: number, preserveExisting: boolean) {\n         const newSet = preserveExisting ? new Set(selectedFiles) : new Set<string>();\n         \n         // Convert pixel rect to grid capacity\n         const startRowIdx = Math.max(0, Math.floor(top / itemHeight));\n         const endRowIdx = Math.min(totalRows - 1, Math.floor((top + height) / itemHeight));\n\n         for (let r = startRowIdx; r <= endRowIdx; r++) {\n             for (let c = 0; c < itemsPerRow; c++) {\n                 const index = r * itemsPerRow + c;\n                 if (index >= filteredFiles.length) break;\n\n                 // Calculate item rect\n                 // Note: Ideally use precise offsetLeft/Top if available, but math approximation works for uniform grid\n                 const itemLeft = c * itemWidth; // Approximation requires ensuring justify-start or similar\n                 const itemTop = r * itemHeight;\n                 \n                 // Intersection check\n                 if (\n                     left < itemLeft + itemWidth &&\n                     left + width > itemLeft &&\n                     top < itemTop + itemHeight &&\n                     top + height > itemTop\n                 ) {\n                     const file = filteredFiles[index];\n                     newSet.add(file._id?.toString() || file.filename);\n                 }\n             }\n         }\n         selectedFiles = newSet;\n    }\n\n    // Context Menu\n    function handleContextMenu(e: MouseEvent, file: MediaBase | MediaImage) {\n        e.preventDefault();\n        // If file not in selection, select it (exclusive)\n        const fileId = file._id?.toString() || file.filename;\n        if (!selectedFiles.has(fileId)) {\n            selectedFiles = new Set([fileId]);\n        }\n        \n        contextMenu = {\n            x: e.clientX,\n            y: e.clientY,\n            file\n        };\n    }\n    */\n\n\t// Calculate items per row based on container width\n\tfunction updateItemsPerRow() {\n\t\tif (!container) return;\n\t\tconst width = container.clientWidth;\n\t\tconst itemWidth = gridSize === 'tiny' ? 100 : gridSize === 'small' ? 140 : gridSize === 'medium' ? 260 : 380;\n\t\titemsPerRow = Math.max(1, Math.floor(width / itemWidth));\n\t}\n\n\t// Handle scroll\n\tfunction handleScroll(e: Event) {\n\t\tconst target = e.target as HTMLDivElement;\n\t\tscrollTop = target.scrollTop;\n\t}\n\n\t// Batch operations\n\tfunction toggleSelection(file: MediaBase | MediaImage) {\n\t\tconst fileId = file._id?.toString() || file.filename;\n\t\tif (selectedFiles.has(fileId)) {\n\t\t\tselectedFiles.delete(fileId);\n\t\t} else {\n\t\t\tselectedFiles.add(fileId);\n\t\t}\n\t\tselectedFiles = selectedFiles;\n\t}\n\n\tfunction selectAll() {\n\t\tselectedFiles = new Set(filteredFiles.map((f) => f._id?.toString() || f.filename));\n\t}\n\n\tfunction deselectAll() {\n\t\tselectedFiles = new Set();\n\t}\n\n\tfunction handleDelete(file: MediaBase | MediaImage) {\n\t\tondeleteImage(file);\n\t}\n\n\tfunction handleBulkDelete() {\n\t\tconst filesToDelete = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToDelete.length > 0) {\n\t\t\tonBulkDelete(filesToDelete);\n\t\t\tselectedFiles = new Set();\n\t\t\tisSelectionMode = false;\n\t\t}\n\t}\n\n\tfunction handleBulkDownload() {\n\t\tconst filesToDownload = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToDownload.length > 0) {\n\t\t\tonBulkDownload(filesToDownload);\n\t\t}\n\t}\n\n\tfunction openBulkEditModal(action: 'rename' | 'move' | 'tag') {\n\t\tbulkEditAction = action;\n\t\tshowBulkEditModal = true;\n\t}\n\n\tfunction applyBulkEdit() {\n\t\tconst filesToEdit = filteredFiles.filter((f) => selectedFiles.has(f._id?.toString() || f.filename));\n\t\tif (filesToEdit.length > 0 && bulkEditValue.trim()) {\n\t\t\tonBulkEdit(filesToEdit, bulkEditAction, bulkEditValue);\n\t\t\tshowBulkEditModal = false;\n\t\t\tbulkEditValue = '';\n\t\t\tselectedFiles = new Set();\n\t\t\tisSelectionMode = false;\n\t\t}\n\t}\n\n\t// Lifecycle\n\tonMount(() => {\n\t\tupdateItemsPerRow();\n\t\tconst resizeObserver = new ResizeObserver(() => {\n\t\t\tupdateItemsPerRow();\n\t\t\tcontainerHeight = container.clientHeight;\n\t\t});\n\t\tresizeObserver.observe(container);\n\t\treturn () => resizeObserver.disconnect();\n\t});\n</script>\n\n<div class=\"flex h-full flex-col\">\n\t<!-- Batch Operations Toolbar -->\n\t<div class=\"mb-4 flex w-full flex-wrap items-center justify-between gap-2 rounded border border-surface-400 bg-surface-100 p-2 dark:bg-surface-700\">\n\t\t<div class=\"flex flex-wrap items-center gap-2\">\n\t\t\t<button\n\t\t\t\tonclick={() => {\n\t\t\t\t\tisSelectionMode = !isSelectionMode;\n\t\t\t\t\tselectedFiles = new Set();\n\t\t\t\t}}\n\t\t\t\tclass=\"preset-outline-surface-500 btn-sm\"\n\t\t\t\taria-label=\"Toggle selection mode\"\n\t\t\t>\n\t\t\t\t<iconify-icon icon={isSelectionMode ? 'mdi:close' : 'mdi:checkbox-multiple-marked'} width=\"20\"></iconify-icon>\n\t\t\t\t{isSelectionMode ? 'Cancel' : 'Select'}\n\t\t\t</button>\n\n\t\t\t{#if isSelectionMode}\n\t\t\t\t<button onclick={selectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:select-all\" width=\"20\"></iconify-icon>\n\t\t\t\t\tAll\n\t\t\t\t</button>\n\t\t\t\t<button onclick={deselectAll} class=\"preset-outline-surface-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:select-off\" width=\"20\"></iconify-icon>\n\t\t\t\t\tNone\n\t\t\t\t</button>\n\t\t\t{/if}\n\t\t</div>\n\n\t\t{#if selectedFiles.size > 0}\n\t\t\t<div class=\"flex flex-wrap items-center gap-2\">\n\t\t\t\t<span class=\"text-sm font-semibold\">{selectedFiles.size} selected</span>\n\n\t\t\t\t<button onclick={handleBulkDownload} class=\"preset-filled-primary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:download\" width=\"18\"></iconify-icon>\n\t\t\t\t\tDownload\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={() => openBulkEditModal('tag')} class=\"preset-filled-secondary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:tag-multiple\" width=\"18\"></iconify-icon>\n\t\t\t\t\tTag\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={() => openBulkEditModal('move')} class=\"preset-filled-secondary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:folder-move\" width=\"18\"></iconify-icon>\n\t\t\t\t\tMove\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={() => openBulkEditModal('rename')} class=\"preset-filled-secondary-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:rename-box\" width=\"18\"></iconify-icon>\n\t\t\t\t\tRename\n\t\t\t\t</button>\n\n\t\t\t\t<button onclick={handleBulkDelete} class=\"preset-filled-error-500 btn-sm\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:delete\" width=\"18\"></iconify-icon>\n\t\t\t\t\tDelete\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n\n\t<!-- Virtual Scrolling Container -->\n\t<div bind:this={container} onscroll={handleScroll} class=\"flex-1 overflow-y-auto\" style=\"height: {containerHeight}px;\">\n\t\t{#if filteredFiles.length === 0}\n\t\t\t<div class=\"flex h-full items-center justify-center text-center text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t<div>\n\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-circle-fill\" height=\"44\" class=\"mb-2\"></iconify-icon>\n\t\t\t\t\t<p class=\"text-lg\">No media found</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{:else}\n\t\t\t<div style=\"padding-top: {paddingTop}px; padding-bottom: {paddingBottom}px;\">\n\t\t\t\t<div class=\"grid gap-4\" style=\"grid-template-columns: repeat({itemsPerRow}, 1fr);\">\n\t\t\t\t\t{#each visibleItems as file (file._id?.toString() || file.filename)}\n\t\t\t\t\t\t{@const fileId = file._id?.toString() || file.filename}\n\t\t\t\t\t\t{@const isSelected = selectedFiles.has(fileId)}\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tonclick={() => isSelectionMode && toggleSelection(file)}\n\t\t\t\t\t\t\tonkeydown={(e) => {\n\t\t\t\t\t\t\t\tif (isSelectionMode && (e.key === 'Enter' || e.key === ' ')) {\n\t\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t\ttoggleSelection(file);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\tclass=\"card relative border border-surface-300 transition-all hover:shadow-lg dark:border-surface-500 {isSelected\n\t\t\t\t\t\t\t\t? 'ring-2 ring-primary-500'\n\t\t\t\t\t\t\t\t: ''}\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{#if isSelectionMode}\n\t\t\t\t\t\t\t\t<div class=\"absolute left-2 top-2 z-10\">\n\t\t\t\t\t\t\t\t\t<input type=\"checkbox\" checked={isSelected} onchange={() => toggleSelection(file)} class=\"checkbox\" aria-label=\"Select file\" />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t\t<header class=\"m-2 flex w-auto items-center justify-between relative\">\n\t\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\t\tonclick={(e) => {\n\t\t\t\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t\t\t\t\tactivePopup = activePopup === fileId ? null : fileId;\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\taria-label=\"File Info\"\n\t\t\t\t\t\t\t\t\tclass=\"btn-icon\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"raphael:info\" width=\"20\" class=\"text-tertiary-500 dark:text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t\t\t{#if activePopup === fileId}\n\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\tclass=\"card preset-filled z-50 min-w-[250px] p-2 absolute left-8 top-0 shadow-xl\"\n\t\t\t\t\t\t\t\t\t\tonclick={(e) => e.stopPropagation()}\n\t\t\t\t\t\t\t\t\t\tonkeydown={(e) => e.stopPropagation()}\n\t\t\t\t\t\t\t\t\t\trole=\"dialog\"\n\t\t\t\t\t\t\t\t\t\ttabindex=\"-1\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t<table class=\" w-full table-auto text-xs\">\n\t\t\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t\t\t{#if 'width' in file && file.width && 'height' in file && file.height}\n\t\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Dimensions:</td><td>{file.width}x{file.height}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Size:</td><td>{formatBytes(file.size || 0)}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Type:</td><td>{file.mimeType || 'N/A'}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t\t<tr><td class=\"font-semibold\">Hash:</td><td class=\"truncate\" title={file.hash}>{file.hash?.substring(0, 8) || 'N/A'}</td></tr>\n\t\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t\t\t\t<!-- Close button for mobile/convenience -->\n\t\t\t\t\t\t\t\t\t\t<div class=\"flex justify-end mt-2\">\n\t\t\t\t\t\t\t\t\t\t\t<button class=\"btn-icon btn-icon-sm preset-filled-surface-500\" aria-label=\"Close\" onclick={() => (activePopup = null)}>\n\t\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"16\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{/if}\n\n\t\t\t\t\t\t\t\t{#if !isSelectionMode}\n\t\t\t\t\t\t\t\t\t{#if file.type === 'image'}\n\t\t\t\t\t\t\t\t\t\t<button onclick={() => onEditImage(file as MediaImage)} aria-label=\"Edit\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:pen\" width=\"20\" class=\"text-tertiary-500 dark:text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t<button onclick={() => handleDelete(file)} aria-label=\"Delete\" class=\"btn-icon\">\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:delete\" width=\"20\" class=\"text-error-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</header>\n\n\t\t\t\t\t\t\t<section class=\"flex items-center justify-center p-2\">\n\t\t\t\t\t\t\t\t{#if file?.filename && file?.url}\n\t\t\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\t\t\tsrc={('thumbnails' in file ? file.thumbnails?.sm?.url : undefined) ?? file.url ?? '/static/Default_User.svg'}\n\t\t\t\t\t\t\t\t\t\talt={file.filename}\n\t\t\t\t\t\t\t\t\t\tclass={`rounded object-cover ${\n\t\t\t\t\t\t\t\t\t\t\tgridSize === 'tiny' ? 'h-16 w-16' : gridSize === 'small' ? 'h-24 w-24' : gridSize === 'medium' ? 'h-48 w-48' : 'h-80 w-80'\n\t\t\t\t\t\t\t\t\t\t}`}\n\t\t\t\t\t\t\t\t\t\tloading=\"lazy\"\n\t\t\t\t\t\t\t\t\t\tdecoding=\"async\"\n\t\t\t\t\t\t\t\t\t\tonerror={(e) => {\n\t\t\t\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\n\t\t\t\t\t\t\t\t\t\t\tif (target) {\n\t\t\t\t\t\t\t\t\t\t\t\ttarget.src = '/static/Default_User.svg';\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t\t<div class=\"flex h-full w-full items-center justify-center bg-surface-200 dark:bg-surface-700\">\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"bi:exclamation-triangle-fill\" height=\"24\" class=\"text-warning-500\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t</section>\n\n\t\t\t\t\t\t\t<footer class=\"p-2 text-sm\">\n\t\t\t\t\t\t\t\t<p class=\"truncate\" title={file.filename}>{file.filename}</p>\n\t\t\t\t\t\t\t\t<p class=\"text-xs text-gray-500\">{formatBytes(file.size || 0)}</p>\n\t\t\t\t\t\t\t\t<p class=\"text-xs text-gray-500\">{file.type || 'Unknown'}</p>\n\t\t\t\t\t\t\t</footer>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/each}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n\n\t<!-- Stats Footer -->\n\t<div class=\"mt-2 flex items-center justify-between border-t border-surface-400 bg-surface-100 px-4 py-2 text-sm dark:bg-surface-700\">\n\t\t<span>Showing {visibleItems.length} of {filteredFiles.length} files</span>\n\t\t<span>Virtual scrolling: {Math.round((visibleItems.length / filteredFiles.length) * 100)}% rendered</span>\n\t</div>\n</div>\n\n<!-- Bulk Edit Modal -->\n{#if showBulkEditModal}\n\t<div\n\t\tclass=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\"\n\t\tonclick={() => (showBulkEditModal = false)}\n\t\tonkeydown={(e) => {\n\t\t\tif (e.key === 'Escape') {\n\t\t\t\tshowBulkEditModal = false;\n\t\t\t}\n\t\t}}\n\t\trole=\"button\"\n\t\ttabindex=\"-1\"\n\t\taria-label=\"Close modal\"\n\t>\n\t\t<div\n\t\t\tclass=\"card w-full max-w-md p-6\"\n\t\t\tonclick={(e) => e.stopPropagation()}\n\t\t\tonkeydown={(e) => e.stopPropagation()}\n\t\t\trole=\"dialog\"\n\t\t\ttabindex=\"0\"\n\t\t\taria-labelledby=\"bulk-edit-title\"\n\t\t>\n\t\t\t<h3 id=\"bulk-edit-title\" class=\"mb-4 text-xl font-bold\">\n\t\t\t\tBulk {bulkEditAction === 'rename' ? 'Rename' : bulkEditAction === 'move' ? 'Move' : 'Tag'}\n\t\t\t</h3>\n\n\t\t\t<p class=\"mb-4 text-sm text-surface-600 dark:text-surface-50\">\n\t\t\t\t{selectedFiles.size} file{selectedFiles.size !== 1 ? 's' : ''} selected\n\t\t\t</p>\n\n\t\t\t<div class=\"mb-4\">\n\t\t\t\t<label class=\"label mb-2\" for=\"bulk-edit-input\">\n\t\t\t\t\t{#if bulkEditAction === 'rename'}\n\t\t\t\t\t\t<span>New name prefix (files will be numbered)</span>\n\t\t\t\t\t{:else if bulkEditAction === 'move'}\n\t\t\t\t\t\t<span>Destination folder</span>\n\t\t\t\t\t{:else}\n\t\t\t\t\t\t<span>Tags (comma-separated)</span>\n\t\t\t\t\t{/if}\n\t\t\t\t</label>\n\t\t\t\t<input\n\t\t\t\t\tid=\"bulk-edit-input\"\n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tbind:value={bulkEditValue}\n\t\t\t\t\tclass=\"input\"\n\t\t\t\t\tplaceholder={bulkEditAction === 'rename' ? 'image-' : bulkEditAction === 'move' ? '/folder/path' : 'tag1, tag2, tag3'}\n\t\t\t\t/>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex justify-end gap-2\">\n\t\t\t\t<button onclick={() => (showBulkEditModal = false)} class=\"preset-outline-surface-500 btn\">Cancel</button>\n\t\t\t\t<button onclick={applyBulkEdit} class=\"preset-filled-primary-500 btn\" disabled={!bulkEditValue.trim()}>Apply</button>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n{/if}\n\n<style>\n\t.grid {\n\t\tdisplay: grid;\n\t\tgap: 1rem;\n\t}\n</style>\n","<!--\n@file src/routes/(app)/mediagallery/AdvancedSearchModal.svelte\n@component\n**Advanced Search Modal for Media Gallery**\n\nProvides comprehensive search interface with multiple criteria:\n- File properties (name, size, type)\n- Dimensions (width, height, aspect ratio)\n- Dates (upload range)\n- EXIF metadata\n- Duplicate detection\n\nStructure optimized for LLM integration and AI-powered search.\n\n### Props\n- `files: MediaBase[]` - All available media files\n- `onSearch: (criteria: SearchCriteria) => void` - Callback with search results\n- `onClose: () => void` - Callback to close modal\n\n### Features\n- Multi-criteria form\n- Search suggestions (tags, cameras, common dimensions)\n- Real-time validation\n- Keyboard shortcuts (Enter to search, Escape to close)\n- Accessible form controls\n-->\n\n<script lang=\"ts\">\n\timport type { MediaBase } from '@shared/utils/media/mediaModels';\n\timport type { SearchCriteria } from '@shared/utils/media/advancedSearch';\n\n\tinterface Props {\n\t\tfiles: MediaBase[];\n\t\tonSearch: (criteria: SearchCriteria) => void;\n\t\tonClose: () => void;\n\t}\n\n\tconst { files, onSearch, onClose }: Props = $props();\n\n\t// Search criteria state (not used directly, converted from formValues)\n\t// let criteria = $state<SearchCriteria>({...});\n\n\t// Form input values (separate from criteria for easier binding)\n\tlet formValues = $state({\n\t\tfilename: '',\n\t\ttagsInput: '',\n\t\tminWidth: '',\n\t\tmaxWidth: '',\n\t\tminHeight: '',\n\t\tmaxHeight: '',\n\t\taspectRatio: 'any',\n\t\tminSize: '',\n\t\tmaxSize: '',\n\t\tfileTypesInput: '',\n\t\tuploadedAfter: '',\n\t\tuploadedBefore: '',\n\t\thasEXIF: 'any',\n\t\tcamera: '',\n\t\tlocation: '',\n\t\tdominantColor: '',\n\t\tshowDuplicatesOnly: false,\n\t\thashMatch: ''\n\t});\n\n\t// Search suggestions (computed from files)\n\tconst suggestions = $derived.by(() => {\n\t\tconst tags = new Set<string>();\n\t\tconst cameras = new Set<string>();\n\t\tconst dimensions = new Set<string>();\n\n\t\tfiles.forEach((file) => {\n\t\t\t// Extract tags - handle type safety\n\t\t\tif (file.metadata && typeof file.metadata === 'object' && 'tags' in file.metadata) {\n\t\t\t\tconst fileTags = file.metadata.tags as string[] | undefined;\n\t\t\t\tif (Array.isArray(fileTags)) {\n\t\t\t\t\tfileTags.forEach((tag) => tags.add(tag));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Extract camera info - handle type safety\n\t\t\tif (file.metadata && typeof file.metadata === 'object' && 'exif' in file.metadata) {\n\t\t\t\tconst exif = file.metadata.exif as Record<string, unknown> | undefined;\n\t\t\t\tif (exif && 'camera' in exif && typeof exif.camera === 'string') {\n\t\t\t\t\tcameras.add(exif.camera);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Extract common dimensions - use MediaImage type\n\t\t\tconst imageFile = file as { width?: number; height?: number };\n\t\t\tif (imageFile.width && imageFile.height) {\n\t\t\t\tdimensions.add(`${imageFile.width}x${imageFile.height}`);\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\ttags: Array.from(tags).slice(0, 10),\n\t\t\tcameras: Array.from(cameras).slice(0, 10),\n\t\t\tdimensions: Array.from(dimensions).slice(0, 10)\n\t\t};\n\t});\n\n\t// Handle search\n\tfunction handleSearch() {\n\t\t// Convert form values to criteria\n\t\tconst searchCriteria: SearchCriteria = {\n\t\t\tfilename: formValues.filename || undefined,\n\t\t\ttags: formValues.tagsInput ? formValues.tagsInput.split(',').map((t) => t.trim()) : undefined,\n\t\t\tminWidth: formValues.minWidth ? parseInt(formValues.minWidth) : undefined,\n\t\t\tmaxWidth: formValues.maxWidth ? parseInt(formValues.maxWidth) : undefined,\n\t\t\tminHeight: formValues.minHeight ? parseInt(formValues.minHeight) : undefined,\n\t\t\tmaxHeight: formValues.maxHeight ? parseInt(formValues.maxHeight) : undefined,\n\t\t\taspectRatio: formValues.aspectRatio !== 'any' ? (formValues.aspectRatio as 'landscape' | 'portrait' | 'square') : undefined,\n\t\t\tminSize: formValues.minSize ? parseInt(formValues.minSize) * 1024 * 1024 : undefined, // Convert MB to bytes\n\t\t\tmaxSize: formValues.maxSize ? parseInt(formValues.maxSize) * 1024 * 1024 : undefined,\n\t\t\tfileTypes: formValues.fileTypesInput ? formValues.fileTypesInput.split(',').map((t) => t.trim()) : undefined,\n\t\t\tuploadedAfter: formValues.uploadedAfter ? new Date(formValues.uploadedAfter) : undefined,\n\t\t\tuploadedBefore: formValues.uploadedBefore ? new Date(formValues.uploadedBefore) : undefined,\n\t\t\thasEXIF: formValues.hasEXIF !== 'any' ? formValues.hasEXIF === 'yes' : undefined,\n\t\t\tcamera: formValues.camera || undefined,\n\t\t\tlocation: formValues.location || undefined,\n\t\t\tdominantColor: formValues.dominantColor || undefined,\n\t\t\tshowDuplicatesOnly: formValues.showDuplicatesOnly,\n\t\t\thashMatch: formValues.hashMatch || undefined\n\t\t};\n\n\t\tonSearch(searchCriteria);\n\t}\n\n\t// Reset form\n\tfunction resetForm() {\n\t\tformValues = {\n\t\t\tfilename: '',\n\t\t\ttagsInput: '',\n\t\t\tminWidth: '',\n\t\t\tmaxWidth: '',\n\t\t\tminHeight: '',\n\t\t\tmaxHeight: '',\n\t\t\taspectRatio: 'any',\n\t\t\tminSize: '',\n\t\t\tmaxSize: '',\n\t\t\tfileTypesInput: '',\n\t\t\tuploadedAfter: '',\n\t\t\tuploadedBefore: '',\n\t\t\thasEXIF: 'any',\n\t\t\tcamera: '',\n\t\t\tlocation: '',\n\t\t\tdominantColor: '',\n\t\t\tshowDuplicatesOnly: false,\n\t\t\thashMatch: ''\n\t\t};\n\t}\n\n\t// Keyboard shortcuts\n\tfunction handleKeydown(e: KeyboardEvent) {\n\t\tif (e.key === 'Escape') {\n\t\t\tonClose();\n\t\t} else if (e.key === 'Enter' && e.ctrlKey) {\n\t\t\thandleSearch();\n\t\t}\n\t}\n</script>\n\n<!-- Modal Content Wrapper -->\n<div class=\"h-full w-full flex flex-col items-center justify-center p-4\">\n\t<div\n\t\tclass=\"card max-h-[85vh] w-full max-w-4xl flex flex-col overflow-hidden bg-surface-100 dark:bg-surface-800 shadow-xl\"\n\t\tonclick={(e) => e.stopPropagation()}\n\t\tonkeydown={(e) => {\n\t\t\tif (e.key === 'Enter') e.stopPropagation();\n\t\t\thandleKeydown(e);\n\t\t}}\n\t\trole=\"dialog\"\n\t\taria-labelledby=\"advanced-search-title\"\n\t\ttabindex=\"0\"\n\t>\n\t\t<!-- Header -->\n\t\t<div class=\"flex-none border-b border-surface-300 p-4 dark:border-surface-600 bg-surface-200/50 dark:bg-surface-700/50\">\n\t\t\t<h2 id=\"advanced-search-title\" class=\"text-center text-2xl font-bold text-tertiary-500 underline dark:text-primary-500\">Advanced Search</h2>\n\t\t</div>\n\n\t\t<!-- Scrollable Body -->\n\t\t<div class=\"flex-1 overflow-y-auto p-6\">\n\t\t\t<form\n\t\t\t\tid=\"advanced-search-form\"\n\t\t\t\tonsubmit={(e) => {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\thandleSearch();\n\t\t\t\t}}\n\t\t\t\tclass=\"space-y-6\"\n\t\t\t>\n\t\t\t\t<!-- Search Presets -->\n\t\t\t\t<div class=\"flex flex-wrap gap-2\">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tclass=\"chip preset-outlined-primary-500 hover:preset-filled-primary-500 transition-colors\"\n\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\tconst date = new Date();\n\t\t\t\t\t\t\tdate.setDate(date.getDate() - 7);\n\t\t\t\t\t\t\tformValues.uploadedAfter = date.toISOString().split('T')[0];\n\t\t\t\t\t\t\tformValues.uploadedBefore = '';\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:calendar-week\"></iconify-icon>\n\t\t\t\t\t\t<span>Recent (7 days)</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tclass=\"chip preset-outlined-primary-500 hover:preset-filled-primary-500 transition-colors\"\n\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\tconst date = new Date();\n\t\t\t\t\t\t\tdate.setDate(date.getDate() - 30);\n\t\t\t\t\t\t\tformValues.uploadedAfter = date.toISOString().split('T')[0];\n\t\t\t\t\t\t\tformValues.uploadedBefore = '';\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:calendar-month\"></iconify-icon>\n\t\t\t\t\t\t<span>Recent (30 days)</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tclass=\"chip preset-outlined-primary-500 hover:preset-filled-primary-500 transition-colors\"\n\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\tformValues.minSize = '5';\n\t\t\t\t\t\t\tformValues.maxSize = '';\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:file-star\"></iconify-icon>\n\t\t\t\t\t\t<span>Large (>5MB)</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\tclass=\"chip preset-outlined-primary-500 hover:preset-filled-primary-500 transition-colors\"\n\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\tformValues.minWidth = '3840';\n\t\t\t\t\t\t\tformValues.minHeight = '2160';\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:monitor-screenshot\"></iconify-icon>\n\t\t\t\t\t\t<span>4K+ Images</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<hr class=\"border-surface-300 dark:border-surface-600\" />\n\n\t\t\t\t<!-- Basic Search -->\n\t\t\t\t<section>\n\t\t\t\t\t<h3 class=\"mb-3 text-lg font-semibold text-tertiary-500 dark:text-primary-500\">Basic Criteria</h3>\n\t\t\t\t\t<div class=\"grid gap-4 md:grid-cols-2\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Filename</span>\n\t\t\t\t\t\t\t<input type=\"text\" bind:value={formValues.filename} class=\"input\" placeholder=\"image.jpg\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Tags (comma-separated)</span>\n\t\t\t\t\t\t\t<input type=\"text\" bind:value={formValues.tagsInput} class=\"input\" placeholder=\"landscape, nature\" />\n\t\t\t\t\t\t\t{#if suggestions.tags.length > 0}\n\t\t\t\t\t\t\t\t<div class=\"mt-1 text-xs text-surface-600 dark:text-surface-50\">\n\t\t\t\t\t\t\t\t\tSuggestions: {suggestions.tags.join(', ')}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</section>\n\n\t\t\t\t<!-- Dimensions -->\n\t\t\t\t<section>\n\t\t\t\t\t<h3 class=\"mb-3 text-lg font-semibold text-tertiary-500 dark:text-primary-500\">Dimensions</h3>\n\t\t\t\t\t<div class=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Min Width (px)</span>\n\t\t\t\t\t\t\t<input type=\"number\" bind:value={formValues.minWidth} class=\"input\" placeholder=\"1920\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Max Width (px)</span>\n\t\t\t\t\t\t\t<input type=\"number\" bind:value={formValues.maxWidth} class=\"input\" placeholder=\"3840\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Min Height (px)</span>\n\t\t\t\t\t\t\t<input type=\"number\" bind:value={formValues.minHeight} class=\"input\" placeholder=\"1080\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Max Height (px)</span>\n\t\t\t\t\t\t\t<input type=\"number\" bind:value={formValues.maxHeight} class=\"input\" placeholder=\"2160\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class=\"mt-4\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Aspect Ratio</span>\n\t\t\t\t\t\t\t<select bind:value={formValues.aspectRatio} class=\"select\">\n\t\t\t\t\t\t\t\t<option value=\"any\">Any</option>\n\t\t\t\t\t\t\t\t<option value=\"landscape\">Landscape</option>\n\t\t\t\t\t\t\t\t<option value=\"portrait\">Portrait</option>\n\t\t\t\t\t\t\t\t<option value=\"square\">Square</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{#if suggestions.dimensions.length > 0}\n\t\t\t\t\t\t<div class=\"mt-2 text-xs text-surface-600 dark:text-surface-50\">\n\t\t\t\t\t\t\tCommon dimensions: {suggestions.dimensions.join(', ')}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/if}\n\t\t\t\t</section>\n\n\t\t\t\t<!-- File Properties -->\n\t\t\t\t<section>\n\t\t\t\t\t<h3 class=\"mb-3 text-lg font-semibold text-tertiary-500 dark:text-primary-500\">File Properties</h3>\n\t\t\t\t\t<div class=\"grid gap-4 md:grid-cols-3\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Min Size (MB)</span>\n\t\t\t\t\t\t\t<input type=\"number\" bind:value={formValues.minSize} class=\"input\" placeholder=\"1\" step=\"0.1\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Max Size (MB)</span>\n\t\t\t\t\t\t\t<input type=\"number\" bind:value={formValues.maxSize} class=\"input\" placeholder=\"50\" step=\"0.1\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>File Types</span>\n\t\t\t\t\t\t\t<input type=\"text\" bind:value={formValues.fileTypesInput} class=\"input\" placeholder=\"image/jpeg, image/png\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</section>\n\n\t\t\t\t<!-- Dates -->\n\t\t\t\t<section>\n\t\t\t\t\t<h3 class=\"mb-3 text-lg font-semibold text-tertiary-500 dark:text-primary-500\">Upload Dates</h3>\n\t\t\t\t\t<div class=\"grid gap-4 md:grid-cols-2\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Uploaded After</span>\n\t\t\t\t\t\t\t<input type=\"date\" bind:value={formValues.uploadedAfter} class=\"input\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Uploaded Before</span>\n\t\t\t\t\t\t\t<input type=\"date\" bind:value={formValues.uploadedBefore} class=\"input\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</section>\n\n\t\t\t\t<!-- EXIF & Metadata -->\n\t\t\t\t<section>\n\t\t\t\t\t<h3 class=\"mb-3 text-lg font-semibold text-tertiary-500 dark:text-primary-500\">Metadata & EXIF</h3>\n\t\t\t\t\t<div class=\"grid gap-4 md:grid-cols-3\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Has EXIF Data</span>\n\t\t\t\t\t\t\t<select bind:value={formValues.hasEXIF} class=\"select\">\n\t\t\t\t\t\t\t\t<option value=\"any\">Any</option>\n\t\t\t\t\t\t\t\t<option value=\"yes\">Yes</option>\n\t\t\t\t\t\t\t\t<option value=\"no\">No</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Camera</span>\n\t\t\t\t\t\t\t<input type=\"text\" bind:value={formValues.camera} class=\"input\" placeholder=\"Canon EOS 5D\" />\n\t\t\t\t\t\t\t{#if suggestions.cameras.length > 0}\n\t\t\t\t\t\t\t\t<div class=\"mt-1 text-xs text-surface-600 dark:text-surface-50\">\n\t\t\t\t\t\t\t\t\tFound: {suggestions.cameras.join(', ')}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Location</span>\n\t\t\t\t\t\t\t<input type=\"text\" bind:value={formValues.location} class=\"input\" placeholder=\"New York\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</section>\n\n\t\t\t\t<!-- Advanced -->\n\t\t\t\t<section>\n\t\t\t\t\t<h3 class=\"mb-3 text-lg font-semibold text-tertiary-500 dark:text-primary-500\">Advanced</h3>\n\t\t\t\t\t<div class=\"grid gap-4 md:grid-cols-2\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Dominant Color (hex)</span>\n\t\t\t\t\t\t\t<input type=\"text\" bind:value={formValues.dominantColor} class=\"input\" placeholder=\"#FF5733\" />\n\t\t\t\t\t\t</label>\n\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span>Hash Match</span>\n\t\t\t\t\t\t\t<input type=\"text\" bind:value={formValues.hashMatch} class=\"input\" placeholder=\"a1b2c3d4...\" />\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<label class=\"mt-4 flex items-center gap-2\">\n\t\t\t\t\t\t<input type=\"checkbox\" bind:checked={formValues.showDuplicatesOnly} class=\"checkbox\" />\n\t\t\t\t\t\t<span>Show Duplicates Only</span>\n\t\t\t\t\t</label>\n\t\t\t\t</section>\n\t\t\t</form>\n\t\t</div>\n\n\t\t<!-- Footer -->\n\t\t<div class=\"flex-none border-t border-surface-300 p-4 dark:border-surface-600 bg-surface-200/50 dark:bg-surface-700/50\">\n\t\t\t<div class=\"flex items-center justify-between\">\n\t\t\t\t<div class=\"text-sm hidden sm:block\">\n\t\t\t\t\t<strong class=\"text-tertiary-500 dark:text-primary-500\">Tip:</strong> Press\n\t\t\t\t\t<kbd class=\"preset-filled-tertiary-500 badge dark:preset-filled-primary-500\">Ctrl+Enter</kbd>\n\t\t\t\t\tto search\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"flex gap-3 ml-auto\">\n\t\t\t\t\t<button type=\"button\" onclick={resetForm} class=\"preset-outlined-surface-500 btn\">Reset</button>\n\t\t\t\t\t<button type=\"button\" onclick={onClose} class=\"preset-outlined-surface-500 btn\">Cancel</button>\n\t\t\t\t\t<button type=\"submit\" form=\"advanced-search-form\" class=\"preset-filled-primary-500 btn\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:magnify\" width=\"20\"></iconify-icon>\n\t\t\t\t\t\tSearch\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n","<!--\n@file: src/components/imageEditor/toolbars/AnnotateControls.svelte\n@component\nControls for the Annotate tool: tool selection (text, arrow, shapes) and styling (colors).\n-->\n<script lang=\"ts\">\n\ttype ToolType = 'text' | 'arrow' | 'rectangle' | 'circle' | null;\n\n\tlet {\n\t\tcurrentTool,\n\t\tstrokeColor,\n\t\tfillColor,\n\t\tonSetTool,\n\t\tonStrokeColorChange,\n\t\tonFillColorChange,\n\t\tonDelete,\n\t\tonApply\n\t}: {\n\t\tcurrentTool: ToolType;\n\t\tstrokeColor: string;\n\t\tfillColor: string;\n\t\tonSetTool: (tool: ToolType) => void;\n\t\tonStrokeColorChange: (color: string) => void;\n\t\tonFillColorChange: (color: string) => void;\n\t\tonDelete: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<!-- Tool Selection -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={currentTool === 'text'} onclick={() => onSetTool(currentTool === 'text' ? null : 'text')} title=\"Add Text\">\n\t\t\t<iconify-icon icon=\"mdi:format-text\"></iconify-icon>\n\t\t</button>\n\t\t<button\n\t\t\tclass=\"btn-sm\"\n\t\t\tclass:active={currentTool === 'arrow'}\n\t\t\tonclick={() => onSetTool(currentTool === 'arrow' ? null : 'arrow')}\n\t\t\ttitle=\"Draw Arrow\"\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:arrow-top-right\"></iconify-icon>\n\t\t</button>\n\t\t<button\n\t\t\tclass=\"btn-sm\"\n\t\t\tclass:active={currentTool === 'rectangle'}\n\t\t\tonclick={() => onSetTool(currentTool === 'rectangle' ? null : 'rectangle')}\n\t\t\ttitle=\"Draw Rectangle\"\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:rectangle-outline\"></iconify-icon>\n\t\t</button>\n\t\t<button\n\t\t\tclass=\"btn-sm\"\n\t\t\tclass:active={currentTool === 'circle'}\n\t\t\tonclick={() => onSetTool(currentTool === 'circle' ? null : 'circle')}\n\t\t\ttitle=\"Draw Circle\"\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:circle-outline\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Color Pickers -->\n\t<label class=\"flex items-center gap-2 text-sm\" title=\"Stroke Color\">\n\t\t<iconify-icon icon=\"mdi:water-opacity\"></iconify-icon>\n\t\t<input type=\"color\" class=\"input-color\" oninput={(e) => onStrokeColorChange(e.currentTarget.value)} value={strokeColor} />\n\t</label>\n\t<label class=\"flex items-center gap-2 text-sm\" title=\"Fill Color\">\n\t\t<iconify-icon icon=\"mdi:format-color-fill\"></iconify-icon>\n\t\t<input type=\"color\" class=\"input-color\" oninput={(e) => onFillColorChange(e.currentTarget.value)} value={fillColor} />\n\t</label>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Actions -->\n\t<button onclick={onDelete} class=\"btn preset-outlined-error-500\">\n\t\t<iconify-icon icon=\"mdi:delete-outline\"></iconify-icon>\n\t\t<span>Delete</span>\n\t</button>\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Done</span>\n\t</button>\n</div>\n\n<style>\n\t.input-color {\n\t\theight: var(--spacing-8, 2rem);\n\t\twidth: var(--spacing-8, 2rem);\n\t\tcursor: pointer;\n\t\tappearance: none;\n\t\tborder-radius: var(--radius-base, 0.375rem);\n\t\tborder: none;\n\t\tbackground-color: transparent;\n\t\tpadding: 0;\n\t}\n\t.input-color::-webkit-color-swatch-wrapper {\n\t\tpadding: 0;\n\t}\n\t.input-color::-webkit-color-swatch {\n\t\tborder-color: var(--color-surface-400);\n\t\tborder-radius: var(--radius-base, 0.375rem);\n\t\tborder-width: 1px;\n\t\tborder-style: solid;\n\t}\n</style>\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/regions.ts\n * @description Regions for Annotate tool\n *\n * Features:\n * - Text\n * - Rectangle\n * - Circle\n * - Line\n * - Arrow\n * - Text editing\n * - Namespacing events to avoid conflicts with other tools\n */\nimport Konva from 'konva';\n\nexport type AnnotationKind = 'text' | 'rect' | 'circle' | 'arrow' | 'line';\n\n/**\n * AnnotationItem encapsulates one annotation (node) and provides lifecycle methods.\n */\nexport class AnnotationItem {\n\tid: string;\n\tnode: Konva.Node;\n\tlayer: Konva.Layer;\n\tkind: AnnotationKind;\n\n\tprivate _onSelect: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\n\tconstructor(id: string, node: Konva.Node, layer: Konva.Layer, kind: AnnotationKind) {\n\t\tthis.id = id;\n\t\tthis.node = node;\n\t\tthis.layer = layer;\n\t\tthis.kind = kind;\n\n\t\t// attach selection handler\n\t\tthis.node.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onSelect?.();\n\t\t});\n\t}\n\n\t// one-line: make node draggable and focusable\n\tenableInteraction() {\n\t\t(this.node as any).draggable(true);\n\t}\n\n\t// one-line: disable interaction\n\tdisableInteraction() {\n\t\t(this.node as any).draggable(false);\n\t}\n\n\t// one-line: attach a generic event listener\n\ton(event: string, cb: Function) {\n\t\tthis.node.on(event, cb as any);\n\t}\n\n\t// one-line: remove a generic event listener\n\toff(event: string) {\n\t\tthis.node.off(event);\n\t}\n\n\t// one-line: destroy node and call destructor\n\tdestroy() {\n\t\ttry {\n\t\t\tthis.node.destroy();\n\t\t} catch (e) {}\n\t\tthis._onDestroy?.();\n\t}\n\n\tonSelect(cb: () => void) {\n\t\tthis._onSelect = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n}\n\nexport default AnnotationItem;\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/draw.ts\n * @description Draw tools for Konva\n *\n * Features:\n * - Text\n * - Rectangle\n * - Circle\n * - Line\n * - Arrow\n */\n\nimport Konva from 'konva';\n\n/** Create a Text node ready for editing */\nexport function createText(layer: Konva.Layer, x: number, y: number, text = 'Text', fontSize = 20, color = '#000') {\n\tconst t = new Konva.Text({ x, y, text, fontSize, fontFamily: 'Arial', fill: color, draggable: true, name: 'annotation-text' });\n\tlayer.add(t);\n\treturn t;\n}\n\n/** Create rect */\nexport function createRect(layer: Konva.Layer, x: number, y: number, w = 0, h = 0, stroke = '#f00', fill = 'transparent', strokeWidth = 2) {\n\tconst r = new Konva.Rect({ x, y, width: w, height: h, stroke, fill, strokeWidth, draggable: true, name: 'annotation-rect' });\n\tlayer.add(r);\n\treturn r;\n}\n\n/** Create circle */\nexport function createCircle(layer: Konva.Layer, x: number, y: number, radius = 0, stroke = '#f00', fill = 'transparent', strokeWidth = 2) {\n\tconst c = new Konva.Circle({ x, y, radius, stroke, fill, strokeWidth, draggable: true, name: 'annotation-circle' });\n\tlayer.add(c);\n\treturn c;\n}\n\n/** Create line */\nexport function createLine(layer: Konva.Layer, points: number[], stroke = '#f00', strokeWidth = 2) {\n\tconst l = new Konva.Line({ points, stroke, strokeWidth, lineCap: 'round', lineJoin: 'round', name: 'annotation-line', draggable: false });\n\tlayer.add(l);\n\treturn l;\n}\n\n/** Create arrow */\nexport function createArrow(layer: Konva.Layer, points: number[], stroke = '#f00', strokeWidth = 2) {\n\tconst a = new Konva.Arrow({\n\t\tpoints,\n\t\tstroke,\n\t\tfill: stroke,\n\t\tstrokeWidth,\n\t\tpointerLength: 10,\n\t\tpointerWidth: 8,\n\t\tname: 'annotation-arrow',\n\t\tdraggable: false\n\t});\n\tlayer.add(a);\n\treturn a;\n}\n","/**\n * @file shared/image-editor/src/widgets/transformerConfig.ts\n * @description Shared transformer configuration for consistent styling\n *\n * All image editor widgets (Crop, Blur, Annotate, Watermark) should use these\n * shared styles for uniform appearance of resize handles and borders.\n */\nimport Konva from 'konva';\n\n/**\n * Unified transformer configuration\n * - Blue circular handles with white border\n * - Solid blue border around selection\n * - Consistent sizing across all widgets\n */\nexport const TRANSFORMER_STYLE_DEFAULT: Partial<Konva.TransformerConfig> = {\n\t// Handle appearance\n\tanchorFill: '#3b82f6', // Tailwind blue-500\n\tanchorStroke: '#ffffff',\n\tanchorStrokeWidth: 2,\n\tanchorSize: 12,\n\tanchorCornerRadius: 6, // Makes handles circular\n\n\t// Border appearance\n\tborderStroke: '#3b82f6',\n\tborderStrokeWidth: 2,\n\tborderDash: [] // Solid line\n};\n\n/**\n * Specialized style for Crop tool\n */\nexport const TRANSFORMER_STYLE_CROP: Partial<Konva.TransformerConfig> = {\n\t...TRANSFORMER_STYLE_DEFAULT,\n\tanchorFill: '#3b82f6',\n\tanchorStroke: '#ffffff',\n\tanchorSize: 14,\n\tanchorCornerRadius: 7, // Circular\n\tborderStroke: '#ffffff',\n\tborderStrokeWidth: 1.5\n};\n\n/**\n * Specialized style for Redact/Blur tool (White thin borders, blue handles)\n */\nexport const TRANSFORMER_STYLE_REDACT: Partial<Konva.TransformerConfig> = {\n\t...TRANSFORMER_STYLE_DEFAULT,\n\tborderStroke: '#ffffff',\n\tborderStrokeWidth: 1.5,\n\tanchorFill: '#3b82f6',\n\tanchorStroke: '#ffffff',\n\tanchorSize: 12,\n\tanchorCornerRadius: 6\n};\n\n/** Legacy alias to keep compatibility while transitioning */\nexport const TRANSFORMER_STYLE = TRANSFORMER_STYLE_DEFAULT;\n\n/**\n * Style for rule-of-thirds grid\n */\nexport const GRID_STYLE = {\n\tstroke: 'rgba(255, 255, 255, 0.4)',\n\tstrokeWidth: 1,\n\tlistening: false\n};\n\n/**\n * Default transformer behavior options\n */\nexport const TRANSFORMER_DEFAULTS: Partial<Konva.TransformerConfig> = {\n\tkeepRatio: true,\n\trotateEnabled: true,\n\trotationSnaps: [0, 90, 180, 270],\n\trotateAnchorOffset: 40,\n\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\tboundBoxFunc: (oldBox, newBox) => {\n\t\t// Minimum size constraint\n\t\tif (newBox.width < 20 || newBox.height < 20) return oldBox;\n\t\treturn newBox;\n\t}\n};\n\n/**\n * Creates a styled transformer with unified appearance.\n *\n * @param layer - Konva layer to add transformer to\n * @param options - Optional overrides for specific widget needs\n * @returns Configured Konva.Transformer\n *\n * @example\n * ```ts\n * const tr = createStyledTransformer(layer);\n * tr.nodes([myShape]);\n * ```\n */\nexport function createStyledTransformer(layer: Konva.Layer, options?: Partial<Konva.TransformerConfig>): Konva.Transformer {\n\tconst tr = new Konva.Transformer({\n\t\t...TRANSFORMER_STYLE,\n\t\t...TRANSFORMER_DEFAULTS,\n\t\t...options\n\t});\n\tlayer.add(tr);\n\ttr.moveToTop();\n\treturn tr;\n}\n\n/**\n * Safely attaches transformer to a node with error handling.\n *\n * @param tr - Konva transformer instance\n * @param node - Node to attach, or null to detach\n */\nexport function attachStyledTransformer(tr: Konva.Transformer, node?: Konva.Node | null): void {\n\ttry {\n\t\tif (!node) {\n\t\t\ttr.nodes([]);\n\t\t\ttr.hide();\n\t\t\treturn;\n\t\t}\n\t\ttr.nodes([node]);\n\t\ttr.show();\n\t\ttr.forceUpdate();\n\t\ttr.moveToTop();\n\t} catch {\n\t\ttry {\n\t\t\ttr.nodes([]);\n\t\t\ttr.hide();\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t}\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/transformer.ts\n * @description Transformer utilities for Annotate tool\n *\n * Re-exports shared transformer config for consistent styling across widgets.\n */\nimport Konva from 'konva';\nimport { createStyledTransformer, attachStyledTransformer } from '../transformerConfig';\n\n/**\n * Create a transformer for annotations with consistent styling.\n * Uses more anchors than other tools for flexible annotation resizing.\n */\nexport function createTransformer(layer: Konva.Layer): Konva.Transformer {\n\treturn createStyledTransformer(layer, {\n\t\tkeepRatio: false,\n\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right', 'middle-left', 'middle-right']\n\t});\n}\n\n/**\n * Re-export attach function for convenience\n */\nexport const attachTransformer = attachStyledTransformer;\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/editText.ts\n * @description Text editor for Konva.Text nodes\n *\n * Features:\n * - HTML textarea overlay\n * - Accounts for stage position and page scroll\n * - Maintains Konva.Text properties\n * - Responsive to user input\n * - Clean up on completion\n */\n\nimport type Konva from 'konva';\n\n/**\n * Create an HTML textarea over stage for editing Konva.Text.\n * This correctly accounts for stage position and page scroll.\n */\nexport function enableTextEdit(stage: Konva.Stage, textNode: Konva.Text, onComplete: (txt: string) => void) {\n\t// Get stage container's position relative to viewport\n\tconst stageBox = stage.container().getBoundingClientRect();\n\n\t// Get text node's position relative to stage\n\tconst textPosition = textNode.absolutePosition();\n\n\t// Get current page scroll\n\tconst scrollX = window.scrollX;\n\tconst scrollY = window.scrollY;\n\n\tconst area = document.createElement('textarea');\n\tdocument.body.appendChild(area);\n\n\tarea.value = textNode.text();\n\tarea.style.position = 'absolute';\n\n\t// ** FIX: Add scroll offsets **\n\tarea.style.top = `${stageBox.top + textPosition.y + scrollY}px`;\n\tarea.style.left = `${stageBox.left + textPosition.x + scrollX}px`;\n\n\t// Apply styles from Konva node\n\tarea.style.width = `${textNode.width()}px`;\n\tarea.style.height = `${textNode.height() + 10}px`; // Add padding\n\tarea.style.fontSize = `${textNode.fontSize()}px`;\n\tarea.style.fontFamily = String(textNode.fontFamily()) || 'Arial';\n\tarea.style.color = String(textNode.fill()) || '#000';\n\tarea.style.lineHeight = String(textNode.lineHeight());\n\tarea.style.padding = textNode.padding() + 'px';\n\n\t// General styles\n\tarea.style.background = 'white';\n\tarea.style.border = '1px solid #0066ff';\n\tarea.style.boxShadow = '0 0 5px rgba(0,0,0,0.2)';\n\tarea.style.margin = '0';\n\tarea.style.resize = 'none';\n\tarea.style.overflow = 'hidden';\n\tarea.style.zIndex = '10000';\n\n\tarea.focus();\n\tarea.select();\n\n\tfunction done() {\n\t\tonComplete(area.value);\n\t\tdocument.body.removeChild(area);\n\t\twindow.removeEventListener('keydown', handleKey);\n\t\tarea.removeEventListener('blur', done);\n\t}\n\n\tfunction handleKey(e: KeyboardEvent) {\n\t\t// Finish on Escape\n\t\tif (e.key === 'Escape') {\n\t\t\tdone();\n\t\t}\n\t\t// Finish on Enter (without Shift)\n\t\tif (e.key === 'Enter' && !e.shiftKey) {\n\t\t\tdone();\n\t\t}\n\t}\n\n\twindow.addEventListener('keydown', handleKey);\n\tarea.addEventListener('blur', done);\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/events.ts\n * @description Event namespacing for Annotate tool\n *\n * Features:\n * - Namespacing events to avoid conflicts with other tools\n */\nexport const NS = 'annotate';\n// Namespacing events to avoid conflicts with other tools\nexport function names(event: string) {\n\treturn [`${event}.${NS}`, `${event}.annotate`].join(' ');\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Annotate/Tool.svelte\n@component\n**Annotate Tool \"Controller\"**\n\nOrchestrates the annotation lifecycle:\n- Manages the $state list of AnnotationItem instances\n- Handles stage drawing events (mousedown, mousemove, mouseup)\n- Manages the active selection and transformer\n- Registers the toolbar UI\n- Implements the critical 'apply' (bake) logic\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport AnnotateControls from './Controls.svelte';\n\timport { AnnotationItem, type AnnotationKind } from './regions';\n\timport * as draw from './draw';\n\timport { createTransformer, attachTransformer } from './transformer';\n\timport { enableTextEdit } from './editText';\n\timport { names } from './events';\n\n\t// --- Svelte 5 State ---\n\tlet transformer = $state<Konva.Transformer | null>(null);\n\tlet annotations = $state<AnnotationItem[]>([]);\n\tlet selected = $state<AnnotationItem | null>(null);\n\tlet currentTool = $state<AnnotationKind | null>(null);\n\tlet strokeColor = $state('#ff0000');\n\tlet fillColor = $state('transparent');\n\tlet strokeWidth = $state(2);\n\tlet fontSize = $state(20);\n\n\t// Drawing state machine\n\tlet isDrawing = $state(false);\n\tlet tempNode = $state<Konva.Node | null>(null);\n\tlet startPos = $state<{ x: number; y: number } | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// --- Lifecycle $effect ---\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'annotate') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: AnnotateControls,\n\t\t\t\tprops: {\n\t\t\t\t\tcurrentTool,\n\t\t\t\t\tstrokeColor,\n\t\t\t\t\tfillColor,\n\t\t\t\t\tonSetTool: (t: AnnotationKind | null) => {\n\t\t\t\t\t\tcurrentTool = t;\n\t\t\t\t\t\tdeselect(); // Deselect to allow drawing\n\t\t\t\t\t},\n\t\t\t\t\tonStrokeColorChange: (v: string) => {\n\t\t\t\t\t\tstrokeColor = v;\n\t\t\t\t\t\tselected?.node.setAttrs({ stroke: v });\n\t\t\t\t\t},\n\t\t\t\t\tonFillColorChange: (v: string) => {\n\t\t\t\t\t\tfillColor = v;\n\t\t\t\t\t\tselected?.node.setAttrs({ fill: v });\n\t\t\t\t\t},\n\t\t\t\t\tonDelete: () => deleteSelected(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === AnnotateControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\tif (!transformer) {\n\t\t\ttransformer = createTransformer(layer);\n\t\t}\n\t\tstage.on(names('mousedown'), onMouseDown);\n\t\tstage.on(names('mousemove'), onMouseMove);\n\t\tstage.on(names('mouseup'), onMouseUp);\n\t\tstage.on(names('click'), onStageClick);\n\t\tstage.on(names('dblclick'), onDblClick);\n\t\tstage.container().style.cursor = 'crosshair';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off(names('mousedown'));\n\t\tstage.off(names('mousemove'));\n\t\tstage.off(names('mouseup'));\n\t\tstage.off(names('click'));\n\t\tstage.off(names('dblclick'));\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\tdeselect();\n\t\tcurrentTool = null;\n\t\tisDrawing = false;\n\t\ttempNode = null;\n\t}\n\n\t// --- Drawing Handlers ---\n\tfunction onMouseDown(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\t// Don't draw if clicking on existing node\n\t\tif (e.target !== e.target.getStage()) return;\n\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer) return;\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\t\tif (!currentTool) return;\n\n\t\tdeselect();\n\t\tisDrawing = true;\n\t\tstartPos = pos;\n\n\t\tswitch (currentTool) {\n\t\t\tcase 'text': {\n\t\t\t\tconst txt = draw.createText(layer, pos.x, pos.y, 'Text', fontSize, strokeColor);\n\t\t\t\tconst item = finalizeNode(txt, 'text');\n\t\t\t\tselect(item);\n\t\t\t\tisDrawing = false; // Text is one-click\n\t\t\t\tcurrentTool = null; // Exit tool\n\t\t\t\tstartTextEdit(item.node as Konva.Text); // Immediately edit\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'rect':\n\t\t\t\ttempNode = draw.createRect(layer, pos.x, pos.y, 0, 0, strokeColor, fillColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'circle':\n\t\t\t\ttempNode = draw.createCircle(layer, pos.x, pos.y, 0, strokeColor, fillColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'line':\n\t\t\t\ttempNode = draw.createLine(layer, [pos.x, pos.y, pos.x, pos.y], strokeColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'arrow':\n\t\t\t\ttempNode = draw.createArrow(layer, [pos.x, pos.y, pos.x, pos.y], strokeColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tfunction onMouseMove() {\n\t\tif (!isDrawing || !tempNode || !startPos) return;\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer) return;\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\n\t\tif (tempNode instanceof Konva.Rect) {\n\t\t\ttempNode.width(pos.x - startPos.x);\n\t\t\ttempNode.height(pos.y - startPos.y);\n\t\t} else if (tempNode instanceof Konva.Circle) {\n\t\t\tconst r = Math.hypot(pos.x - startPos.x, pos.y - startPos.y);\n\t\t\ttempNode.radius(r);\n\t\t} else if (tempNode instanceof Konva.Line || tempNode instanceof Konva.Arrow) {\n\t\t\t(tempNode as Konva.Line).points([startPos.x, startPos.y, pos.x, pos.y]);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction onMouseUp() {\n\t\tif (!isDrawing || !tempNode || !currentTool) return;\n\t\tisDrawing = false;\n\n\t\t// Finalize node\n\t\tconst item = finalizeNode(tempNode, currentTool);\n\t\tselect(item);\n\n\t\ttempNode = null;\n\t\tcurrentTool = null;\n\t\tstartPos = null;\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\tfunction onStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tif (isDrawing || currentTool) return;\n\t\t// Deselect if clicking on stage background\n\t\tif (e.target === e.target.getStage()) {\n\t\t\tdeselect();\n\t\t}\n\t}\n\n\tfunction onDblClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tconst node = e.target;\n\t\tif (node instanceof Konva.Text) {\n\t\t\tconst item = annotations.find((a) => a.node === node);\n\t\t\tif (item) {\n\t\t\t\tselect(item);\n\t\t\t\tstartTextEdit(item.node as Konva.Text);\n\t\t\t}\n\t\t}\n\t}\n\n\t// --- Helper Functions ---\n\tfunction finalizeNode(node: Konva.Node, kind: AnnotationKind): AnnotationItem {\n\t\tconst { layer } = imageEditorStore.state;\n\t\tif (!layer) throw new Error('No layer');\n\t\tnode.name(`annotation-${kind}`);\n\t\tnode.draggable(true);\n\t\tconst item = new AnnotationItem(crypto.randomUUID(), node, layer, kind);\n\t\titem.onSelect(() => select(item));\n\t\tannotations = [...annotations, item];\n\t\treturn item;\n\t}\n\n\tfunction startTextEdit(textNode: Konva.Text) {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage) return;\n\t\ttextNode.hide();\n\t\ttransformer?.hide();\n\t\tenableTextEdit(stage, textNode, (newValue) => {\n\t\t\ttextNode.text(newValue);\n\t\t\ttextNode.show();\n\t\t\ttransformer?.show();\n\t\t\ttransformer?.forceUpdate();\n\t\t\timageEditorStore.state.layer?.batchDraw();\n\t\t});\n\t}\n\n\tfunction select(item: AnnotationItem) {\n\t\tselected = item;\n\t\tif (!transformer) return;\n\t\tattachTransformer(transformer, item.node);\n\t}\n\n\tfunction deselect() {\n\t\tselected = null;\n\t\tif (!transformer) return;\n\t\tattachTransformer(transformer, null);\n\t}\n\n\tfunction deleteSelected() {\n\t\tif (!selected) return;\n\t\tconst id = selected.id;\n\t\tselected.destroy();\n\t\tannotations = annotations.filter((a) => a.id !== id);\n\t\tselected = null;\n\t\tdeselect(); // Hides transformer\n\t}\n\n\tfunction cleanupAnnotations(destroy = true) {\n\t\tdeselect();\n\t\tisDrawing = false;\n\t\tcurrentTool = null;\n\t\ttempNode = null;\n\t\tif (destroy) {\n\t\t\t[...annotations].forEach((a) => a.destroy());\n\t\t\tannotations = [];\n\t\t} else {\n\t\t\t// Hide UI for baking\n\t\t\tannotations.forEach((a) => a.disableInteraction());\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t\tcleanupAnnotations(true);\n\t\t\ttransformer?.destroy();\n\t\t\ttransformer = null;\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/index.ts\n * @description Annotate tool for Konva\n *\n * Features:\n * - Text\n * - Rectangle\n * - Circle\n * - Line\n * - Arrow\n * - Text editing\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'annotate',\n\ttitle: 'Annotate',\n\ticon: 'mdi:draw',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/BlurControls.svelte\n@component\nPintura-style controls for the Blur tool with add/delete/rotate/flip functionality.\n-->\n<script lang=\"ts\">\n\timport type { BlurPattern, BlurShape } from '@cms/components/imageEditor/widgets/Blur/regions';\n\n\tlet {\n\t\tblurStrength,\n\t\tshape,\n\t\tpattern,\n\t\thasActiveRegion = false,\n\t\tonStrengthChange,\n\t\tonShapeChange,\n\t\tonPatternChange,\n\t\tonAddRegion,\n\t\tonDeleteRegion,\n\t\tonRotateLeft,\n\t\tonRotateRight,\n\t\tonFlipHorizontal,\n\t\tonReset,\n\t\tonCancel,\n\t\tonApply\n\t}: {\n\t\tblurStrength: number;\n\t\tshape: BlurShape;\n\t\tpattern: BlurPattern;\n\t\thasActiveRegion?: boolean;\n\t\tonStrengthChange: (value: number) => void;\n\t\tonShapeChange: (value: BlurShape) => void;\n\t\tonPatternChange: (value: BlurPattern) => void;\n\t\tonAddRegion: () => void;\n\t\tonDeleteRegion: () => void;\n\t\tonRotateLeft: () => void;\n\t\tonRotateRight: () => void;\n\t\tonFlipHorizontal: () => void;\n\t\tonReset: () => void;\n\t\tonCancel: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n\n\tfunction handleStrengthInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tonStrengthChange(parseInt(target.value, 10));\n\t}\n</script>\n\n<div class=\"flex w-full items-center gap-3\">\n\t<!-- Add Region -->\n\t<button class=\"btn btn-sm preset-filled-primary-500\" onclick={onAddRegion} title=\"Add Blur Region\">\n\t\t<iconify-icon icon=\"mdi:plus\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Add</span>\n\t</button>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Shape Selection -->\n\t<span class=\"hidden text-sm sm:inline\">Shape:</span>\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={shape === 'rectangle'} onclick={() => onShapeChange('rectangle')} title=\"Rectangle\">\n\t\t\t<iconify-icon icon=\"mdi:crop-square\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn-sm\" class:active={shape === 'ellipse'} onclick={() => onShapeChange('ellipse')} title=\"Ellipse\">\n\t\t\t<iconify-icon icon=\"mdi:circle-outline\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Pattern Selection -->\n\t<span class=\"hidden text-sm sm:inline\">Pattern:</span>\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={pattern === 'blur'} onclick={() => onPatternChange('blur')} title=\"Blur\">\n\t\t\t<iconify-icon icon=\"mdi:blur\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn-sm\" class:active={pattern === 'pixelate'} onclick={() => onPatternChange('pixelate')} title=\"Pixelate\">\n\t\t\t<iconify-icon icon=\"mdi:grid\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Strength Slider -->\n\t<label class=\"flex items-center gap-2 text-sm\">\n\t\t<span class=\"hidden sm:inline\">{pattern === 'pixelate' ? 'Size:' : 'Strength:'}</span>\n\t\t<input\n\t\t\ttype=\"range\"\n\t\t\tmin=\"5\"\n\t\t\tmax={pattern === 'pixelate' ? 50 : 100}\n\t\t\tstep=\"1\"\n\t\t\tvalue={blurStrength}\n\t\t\toninput={handleStrengthInput}\n\t\t\tclass=\"range range-primary w-24\"\n\t\t/>\n\t\t<span class=\"w-6 text-right text-xs\">{blurStrength}</span>\n\t</label>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Transform Controls (Rotate/Flip) - Only enabled when region is active -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn btn-icon btn-sm\" onclick={onRotateLeft} title=\"Rotate Region Left\" disabled={!hasActiveRegion}>\n\t\t\t<iconify-icon icon=\"mdi:rotate-left\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm\" onclick={onRotateRight} title=\"Rotate Region Right\" disabled={!hasActiveRegion}>\n\t\t\t<iconify-icon icon=\"mdi:rotate-right\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm\" onclick={onFlipHorizontal} title=\"Flip Region\" disabled={!hasActiveRegion}>\n\t\t\t<iconify-icon icon=\"mdi:flip-horizontal\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<!-- Delete Selected Region -->\n\t<button class=\"btn btn-sm preset-outlined-error-500\" onclick={onDeleteRegion} title=\"Delete Selected Region\" disabled={!hasActiveRegion}>\n\t\t<iconify-icon icon=\"mdi:delete\"></iconify-icon>\n\t</button>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Action Buttons -->\n\t<button onclick={onReset} class=\"btn btn-sm preset-outlined-surface-500\">\n\t\t<iconify-icon icon=\"mdi:restore\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Reset</span>\n\t</button>\n\n\t<button onclick={onCancel} class=\"btn btn-sm preset-outlined-error-500\">\n\t\t<iconify-icon icon=\"mdi:close\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Cancel</span>\n\t</button>\n\n\t<button class=\"btn btn-sm preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Apply</span>\n\t</button>\n</div>\n","/**\n * @files src/routes/(app)/imageEditor/widgets/Blur/regions.ts\n * @description BlurRegion encapsulates Konva nodes, clip mapping, caching strategy,\n * and lifecycle for one blur/pixelate region.\n *\n * Features:\n * - Rectangle and ellipse shapes\n * - Blur and pixelate patterns\n * - Interactive resizing and dragging\n * - Caching strategy for performance\n * - Fast updates for interactive feel\n */\n\nimport Konva from 'konva';\nimport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\nexport type BlurShape = 'rectangle' | 'ellipse';\nexport type BlurPattern = 'blur' | 'pixelate';\nexport type RegionInit = { x?: number; y?: number; width?: number; height?: number; shape?: BlurShape; pattern?: BlurPattern; strength?: number };\n\n/**\n * BlurRegion encapsulates Konva nodes, clip mapping, caching strategy,\n * and lifecycle for one blur/pixelate region.\n */\nexport class BlurRegion {\n\tid: string;\n\tshapeNode: Konva.Rect | Konva.Ellipse;\n\toverlay: Konva.Image;\n\toverlayGroup: Konva.Group;\n\ttransformer?: Konva.Transformer;\n\ttoolbar?: Konva.Group;\n\tprivate layer: Konva.Layer;\n\tprivate imageNode: Konva.Image;\n\tprivate imageGroup: Konva.Group;\n\tprivate currentPattern: BlurPattern;\n\tprivate currentStrength: number;\n\n\tprivate _onSelect: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\tprivate _onClone: (() => void) | null = null;\n\n\t// cache debounce timer per-region\n\tprivate _cacheTimer: number | null = null;\n\n\tconstructor(opts: { id: string; layer: Konva.Layer; imageNode: Konva.Image; imageGroup: Konva.Group; init?: RegionInit }) {\n\t\tthis.id = opts.id;\n\t\tthis.layer = opts.layer;\n\t\tthis.imageNode = opts.imageNode;\n\t\tthis.imageGroup = opts.imageGroup;\n\t\tconst init = opts.init || {};\n\t\tthis.currentPattern = init.pattern || 'blur';\n\t\tthis.currentStrength = init.strength || 20;\n\n\t\tconst w = init.width ?? 160;\n\t\tconst h = init.height ?? 120;\n\n\t\t// Positing relative to imageGroup center (0,0 is group center usually)\n\t\t// But imageNode is at (-w/2, -h/2).\n\t\t// Let's place it at 0,0 (center of image)\n\t\tconst x = init.x ?? 0;\n\t\tconst y = init.y ?? 0;\n\n\t\t// create visible wireframe shape\n\t\tif (init.shape === 'ellipse') {\n\t\t\tthis.shapeNode = new Konva.Ellipse({\n\t\t\t\tx,\n\t\t\t\ty,\n\t\t\t\tradiusX: w / 2,\n\t\t\t\tradiusY: h / 2,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1.5,\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'blurShape'\n\t\t\t});\n\t\t} else {\n\t\t\tthis.shapeNode = new Konva.Rect({\n\t\t\t\tx: x - w / 2,\n\t\t\t\ty: y - h / 2,\n\t\t\t\twidth: w,\n\t\t\t\theight: h,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1.5,\n\t\t\t\tfill: 'rgba(59, 130, 246, 0.2)', // style blue selection\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'blurShape'\n\t\t\t});\n\t\t}\n\t\tthis.shapeNode.id(this.id);\n\t\t// ADD SHAPE TO GROUP\n\t\tthis.imageGroup.add(this.shapeNode);\n\n\t\t// create overlay image (ideally a clone of current state)\n\t\tthis.overlay = new Konva.Image({\n\t\t\timage: this.imageNode.image(),\n\t\t\tlistening: false,\n\t\t\tname: 'blurOverlay',\n\t\t\t// Copy all visual attributes from the main image node\n\t\t\tx: this.imageNode.x(),\n\t\t\ty: this.imageNode.y(),\n\t\t\twidth: this.imageNode.width(),\n\t\t\theight: this.imageNode.height(),\n\t\t\tscaleX: this.imageNode.scaleX(),\n\t\t\tscaleY: this.imageNode.scaleY(),\n\t\t\trotation: this.imageNode.rotation(),\n\t\t\tcornerRadius: this.imageNode.cornerRadius()\n\t\t});\n\n\t\t// Create Group for clipping\n\t\tthis.overlayGroup = new Konva.Group({ listening: false });\n\t\tthis.overlayGroup.add(this.overlay);\n\n\t\t// ensure no filters initially\n\t\tthis.overlay.filters([]);\n\t\t// install clipFunc on GROUP\n\t\tthis.overlayGroup.clipFunc(this.makeClipFunc());\n\t\tthis.imageGroup.add(this.overlayGroup);\n\n\t\t// set predictable zIndex ordering within group\n\t\tthis.imageNode.zIndex(0);\n\t\tthis.overlayGroup.zIndex(1);\n\t\tthis.shapeNode.zIndex(2); // Shape node is now in imageGroup\n\t\tthis.layer.batchDraw();\n\n\t\t// bind events (fast updates only)\n\t\tthis.shapeNode.on('dragmove transform', () => {\n\t\t\tthis.updateToolbarPosition();\n\t\t\tthis.updateOverlayClip();\n\t\t\tthis.layer.batchDraw();\n\t\t});\n\n\t\t// Trigger initial pattern/strength for immediate feedback\n\t\tthis.setPattern(this.currentPattern);\n\t\tthis.setStrength(this.currentStrength);\n\t\tthis.shapeNode.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onSelect?.();\n\t\t});\n\t}\n\n\t// Update toolbar position (local space within imageGroup)\n\tprivate updateToolbarPosition() {\n\t\tif (!this.toolbar) return;\n\t\tconst n = this.shapeNode;\n\n\t\tlet localPt = { x: 0, y: 0 };\n\t\tif (n instanceof Konva.Rect) {\n\t\t\t// Bottom center of rect\n\t\t\tlocalPt = { x: n.width() / 2, y: n.height() + 20 };\n\t\t} else {\n\t\t\t// Bottom center of ellipse (radiusY is half-height)\n\t\t\tlocalPt = { x: 0, y: (n as Konva.Ellipse).radiusY() + 20 };\n\t\t}\n\n\t\t// Transform local point to parent (imageGroup) space\n\t\t// This accounts for rotation, scaling, and position of the shape\n\t\tconst pos = n.getTransform().point(localPt);\n\n\t\tthis.toolbar.position(pos);\n\t\tthis.toolbar.rotation(n.rotation());\n\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// Update overlay clip and cache (local group logic)\n\tprivate updateOverlayClip() {\n\t\t// Both shape and overlay are in imageGroup, at same root level\n\t\t// They share the same coordinate system.\n\t\tconst bounds = this.shapeNode.getSelfRect();\n\n\t\t// Buffer for the blur radius\n\t\tconst padding = this.currentStrength * 2;\n\n\t\t// Since overlay and shape are siblings in imageGroup,\n\t\t// and overlay is matched to imageNode position...\n\t\t// We need the shape relative to overlay.\n\t\tconst x = this.shapeNode.x() - this.overlay.x();\n\t\tconst y = this.shapeNode.y() - this.overlay.y();\n\n\t\tconst cacheRect = {\n\t\t\tx: x - padding,\n\t\t\ty: y - padding,\n\t\t\twidth: bounds.width + padding * 2,\n\t\t\theight: bounds.height + padding * 2\n\t\t};\n\n\t\tif (this._cacheTimer) window.clearTimeout(this._cacheTimer);\n\t\tthis._cacheTimer = window.setTimeout(() => {\n\t\t\ttry {\n\t\t\t\tthis.overlayGroup.clearCache();\n\t\t\t\tthis.overlayGroup.cache(cacheRect);\n\t\t\t\tthis.layer.batchDraw();\n\t\t\t} catch (e) {\n\t\t\t\t/* ignore cache errors */\n\t\t\t}\n\t\t\tthis._cacheTimer = null;\n\t\t}, 0);\n\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// create a clipFunc (local sibling logic)\n\tprivate makeClipFunc(): (ctx: CanvasRenderingContext2D) => void {\n\t\tconst shape = this.shapeNode;\n\t\t// const overlay = this.overlay;\n\t\treturn (ctx: CanvasRenderingContext2D) => {\n\t\t\t// They are siblings in imageGroup.\n\t\t\t// Offset shape's local transform by overlay's position.\n\t\t\tconst tr = shape.getTransform().copy();\n\t\t\t// tr.translate(-overlay.x(), -overlay.y()); // No longer needed as overlayGroup is at 0,0 relative to imageGroup parent\n\n\t\t\tconst m = tr.m;\n\t\t\tctx.setTransform(m[0], m[1], m[2], m[3], m[4], m[5]);\n\n\t\t\tif (shape instanceof Konva.Ellipse) {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.ellipse(0, 0, shape.radiusX(), shape.radiusY(), 0, 0, Math.PI * 2);\n\t\t\t\tctx.closePath();\n\t\t\t} else {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.rect(0, 0, shape.width(), shape.height());\n\t\t\t\tctx.closePath();\n\t\t\t}\n\t\t};\n\t}\n\n\t// set filter pattern and perform necessary re-cache (slow)\n\tsetPattern(pattern: BlurPattern) {\n\t\tthis.currentPattern = pattern;\n\t\tthis.overlay.filters([]);\n\t\tif (pattern === 'blur') {\n\t\t\tthis.overlay.filters([Konva.Filters.Blur]);\n\t\t} else {\n\t\t\tthis.overlay.filters([Konva.Filters.Pixelate]);\n\t\t}\n\t\tthis.setStrength(this.currentStrength);\n\t\tthis.updateOverlayClip(); // Triggers re-cache\n\t}\n\n\t// apply strength (fast)\n\tsetStrength(strength: number) {\n\t\tthis.currentStrength = strength;\n\t\tif (this.currentPattern === 'blur') {\n\t\t\tthis.overlay.blurRadius(strength);\n\t\t} else {\n\t\t\tthis.overlay.pixelSize(Math.max(1, Math.round(strength / 2)));\n\t\t}\n\t\tthis.updateOverlayClip(); // Fast debounce cache\n\t}\n\n\t// fast resize during drawing (no cache)\n\tresizeFromStart(start: { x: number; y: number }, pos: { x: number; y: number }) {\n\t\tconst width = pos.x - start.x;\n\t\tconst height = pos.y - start.y;\n\t\tif (this.shapeNode instanceof Konva.Ellipse) {\n\t\t\tthis.shapeNode.setAttrs({\n\t\t\t\tx: start.x + width / 2,\n\t\t\t\ty: start.y + height / 2,\n\t\t\t\tradiusX: Math.abs(width / 2),\n\t\t\t\tradiusY: Math.abs(height / 2)\n\t\t\t});\n\t\t} else {\n\t\t\tthis.shapeNode.setAttrs({\n\t\t\t\tx: width > 0 ? start.x : pos.x,\n\t\t\t\ty: height > 0 ? start.y : pos.y,\n\t\t\t\twidth: Math.abs(width),\n\t\t\t\theight: Math.abs(height)\n\t\t\t});\n\t\t}\n\t}\n\n\t// finalize region and attach a transformer (fast)\n\tfinalize() {\n\t\tthis.transformer = new Konva.Transformer({\n\t\t\tnodes: [this.shapeNode],\n\t\t\t// EXPLICIT HANDLES - Blue Circles\n\t\t\tanchorFill: '#3b82f6',\n\t\t\tanchorStroke: '#ffffff',\n\t\t\tanchorStrokeWidth: 2,\n\t\t\tanchorSize: 12, // Standard size\n\t\t\tanchorCornerRadius: 6,\n\n\t\t\t// EXPLICIT BORDER - Solid White\n\t\t\tborderStroke: '#ffffff',\n\t\t\tborderStrokeWidth: 1.5,\n\t\t\tborderDash: [],\n\n\t\t\trotateEnabled: true,\n\t\t\trotationSnaps: [0, 45, 90, 135, 180, 225, 270, 315],\n\t\t\trotateAnchorOffset: 25,\n\t\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\t\t\tkeepRatio: false,\n\t\t\tignoreStroke: true,\n\t\t\tboundBoxFunc: (oldBox, newBox) => {\n\t\t\t\treturn newBox.width < 10 || newBox.height < 10 ? oldBox : newBox;\n\t\t\t}\n\t\t});\n\t\tthis.transformer.on('dragend transformend', () => {\n\t\t\timageEditorStore.takeSnapshot();\n\t\t});\n\n\t\tthis.imageGroup.add(this.transformer); // ADDED TO GROUP\n\t\tthis.transformer.moveToTop();\n\n\t\t// Add dragend/transformend to take snapshot\n\t\tthis.shapeNode.on('dragend transformend', () => {\n\t\t\timageEditorStore.takeSnapshot();\n\t\t});\n\n\t\t// Create toolbar above the region\n\t\tthis.createToolbar();\n\t}\n\n\t// Create toolbar with clone/delete icons\n\tprivate createToolbar() {\n\t\tif (this.toolbar) this.toolbar.destroy();\n\n\t\tconst bounds = this.shapeNode.getClientRect();\n\t\tconst toolbarY = bounds.y - 45;\n\t\tconst toolbarX = bounds.x + bounds.width / 2;\n\n\t\tthis.toolbar = new Konva.Group({\n\t\t\tx: toolbarX,\n\t\t\ty: toolbarY,\n\t\t\tname: 'blurToolbar'\n\t\t});\n\n\t\t// Background\n\t\tconst bg = new Konva.Rect({\n\t\t\tx: -45,\n\t\t\ty: 0,\n\t\t\twidth: 90,\n\t\t\theight: 36,\n\t\t\tfill: '#1f2937',\n\t\t\tcornerRadius: 8,\n\t\t\tshadowColor: 'black',\n\t\t\tshadowBlur: 10,\n\t\t\tshadowOpacity: 0.4\n\t\t});\n\t\tthis.toolbar.add(bg);\n\n\t\t// Add icon (Plus)\n\t\tconst addGroup = new Konva.Group({ x: -22, y: 18, cursor: 'pointer' });\n\t\taddGroup.add(\n\t\t\tnew Konva.Path({\n\t\t\t\tdata: 'M12 4v16m8-8H4',\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 2,\n\t\t\t\tlineCap: 'round',\n\t\t\t\tscale: { x: 0.8, y: 0.8 },\n\t\t\t\toffset: { x: 12, y: 12 }\n\t\t\t})\n\t\t);\n\t\taddGroup.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onClone?.();\n\t\t});\n\t\taddGroup.on('mouseenter', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'pointer';\n\t\t});\n\t\taddGroup.on('mouseleave', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'crosshair';\n\t\t});\n\t\tthis.toolbar.add(addGroup);\n\n\t\t// Delete icon (Trash)\n\t\tconst deleteGroup = new Konva.Group({ x: 22, y: 18, cursor: 'pointer' });\n\t\tdeleteGroup.add(\n\t\t\tnew Konva.Path({\n\t\t\t\tdata: 'M3 6h18M9 6v12M15 6v12M5 6v14a2 2 0 002 2h10a2 2 0 002-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2',\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 2,\n\t\t\t\tscale: { x: 0.7, y: 0.7 },\n\t\t\t\toffset: { x: 12, y: 12 }\n\t\t\t})\n\t\t);\n\t\tdeleteGroup.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis.destroy();\n\t\t});\n\t\tdeleteGroup.on('mouseenter', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'pointer';\n\t\t});\n\t\tdeleteGroup.on('mouseleave', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'crosshair';\n\t\t});\n\t\tthis.toolbar.add(deleteGroup);\n\n\t\tthis.imageGroup.add(this.toolbar); // ADDED TO GROUP\n\t\tthis.toolbar.zIndex(10);\n\t\tthis.updateToolbarPosition();\n\t}\n\n\t// detect tiny regions\n\tisTooSmall(): boolean {\n\t\tconst n = this.shapeNode;\n\t\tif (n instanceof Konva.Ellipse) return n.radiusX() < 10 || n.radiusY() < 10;\n\t\treturn n.width() < 20 || n.height() < 20;\n\t}\n\n\t// set active UI state\n\tsetActive(isActive: boolean) {\n\t\tif (this.transformer) this.transformer.visible(isActive);\n\t\tif (this.toolbar) this.toolbar.visible(isActive);\n\t\tif (isActive) {\n\t\t\tthis.transformer?.moveToTop();\n\t\t\tthis.toolbar?.moveToTop();\n\t\t\tthis.updateToolbarPosition();\n\t\t}\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// hide UI but keep overlay for baking\n\thideUI() {\n\t\tthis.transformer?.visible(false);\n\t\tthis.toolbar?.visible(false);\n\t\tthis.shapeNode.visible(false);\n\t}\n\n\t// clone overlay and its clipFunc for offscreen baking\n\tcloneForBake(): Konva.Group | null {\n\t\ttry {\n\t\t\tconst c = this.overlayGroup.clone();\n\t\t\treturn c;\n\t\t} catch (e) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tpublic rotate(deg: number) {\n\t\tthis.shapeNode.rotate(deg);\n\t\tthis.updateToolbarPosition();\n\t\tthis.updateOverlayClip();\n\t\tthis.layer.batchDraw();\n\t}\n\n\tpublic flipX() {\n\t\tthis.shapeNode.scaleX(this.shapeNode.scaleX() * -1);\n\t\tthis.updateToolbarPosition();\n\t\tthis.updateOverlayClip();\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// explicit destruction with listener removal\n\tdestroy() {\n\t\tthis.shapeNode.off('dragmove transform click tap');\n\t\tthis.transformer?.destroy();\n\t\tthis.toolbar?.destroy();\n\t\tthis.overlayGroup.destroy();\n\t\tthis.shapeNode.destroy();\n\t\tthis._onDestroy?.();\n\t}\n\n\t// callbacks\n\tonSelect(cb: () => void) {\n\t\tthis._onSelect = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n\tonClone(cb: () => void) {\n\t\tthis._onClone = cb;\n\t}\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Blur/Tool.svelte\n@component\nController for Blur tool: binds stage, manages BlurRegion instances,\nhandles drawing, applies/bakes effects, and registers toolbar.\n-->\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport Controls from './Controls.svelte';\n\timport { BlurRegion, type RegionInit, type BlurPattern, type BlurShape } from './regions';\n\n\t// reactive tool state (Svelte 5 runes)\n\tlet blurStrength = $state(20);\n\tlet pattern = $state<BlurPattern>('blur');\n\tlet shape = $state<BlurShape>('rectangle');\n\tlet regions = $state<BlurRegion[]>([]);\n\tlet activeId = $state<string | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// debounce timer for strength slider updates\n\tlet strengthDebounceTimer: number | null = null;\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'blur') {\n\t\t\tbindStageEvents();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: Controls,\n\t\t\t\tprops: {\n\t\t\t\t\tblurStrength,\n\t\t\t\t\tpattern,\n\t\t\t\t\tshape,\n\t\t\t\t\tonAdd: undefined, // Remove duplicates\n\t\t\t\t\tonDelete: undefined, // Remove duplicates\n\t\t\t\t\tonStrengthChange: (v: number) => {\n\t\t\t\t\t\tblurStrength = v;\n\t\t\t\t\t\tif (strengthDebounceTimer) clearTimeout(strengthDebounceTimer);\n\t\t\t\t\t\tstrengthDebounceTimer = window.setTimeout(() => {\n\t\t\t\t\t\t\t// ALWAYS update activeId if exists, or all regions\n\t\t\t\t\t\t\tif (activeId) {\n\t\t\t\t\t\t\t\tregions.find((r) => r.id === activeId)?.setStrength(v);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tregions.forEach((r) => r.setStrength(v));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\timageEditorStore.state.layer?.batchDraw();\n\t\t\t\t\t\t}, 30); // Fast feedback\n\t\t\t\t\t},\n\t\t\t\t\tonPatternChange: (p: BlurPattern) => {\n\t\t\t\t\t\tpattern = p;\n\t\t\t\t\t\tregions.forEach((r) => r.setPattern(p));\n\t\t\t\t\t},\n\t\t\t\t\tonShapeChange: (s: BlurShape) => {\n\t\t\t\t\t\tshape = s;\n\t\t\t\t\t\t// If there's an active region, change its shape\n\t\t\t\t\t\tif (activeId) {\n\t\t\t\t\t\t\tconst r = regions.find((x) => x.id === activeId);\n\t\t\t\t\t\t\tif (r) {\n\t\t\t\t\t\t\t\t// Remove old region and create new one with same position but new shape\n\t\t\t\t\t\t\t\tconst oldShape = r.shapeNode;\n\t\t\t\t\t\t\t\tconst bounds = oldShape.getClientRect();\n\t\t\t\t\t\t\t\tdeleteRegion(r.id);\n\t\t\t\t\t\t\t\tcreateRegion({\n\t\t\t\t\t\t\t\t\tx: bounds.x,\n\t\t\t\t\t\t\t\t\ty: bounds.y,\n\t\t\t\t\t\t\t\t\twidth: bounds.width,\n\t\t\t\t\t\t\t\t\theight: bounds.height,\n\t\t\t\t\t\t\t\t\tshape: s\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t// NEW: Add, Delete, Rotate, Flip handlers\n\t\t\t\t\tonAddRegion: () => {\n\t\t\t\t\t\tconst stage = imageEditorStore.state.stage;\n\t\t\t\t\t\tconst x = stage ? stage.width() / 2 : 100;\n\t\t\t\t\t\tconst y = stage ? stage.height() / 2 : 100;\n\t\t\t\t\t\tcreateRegion({ x, y });\n\t\t\t\t\t},\n\t\t\t\t\tonDeleteRegion: () => {\n\t\t\t\t\t\tif (activeId) deleteRegion(activeId);\n\t\t\t\t\t},\n\t\t\t\t\tonRotateLeft: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.rotate(-90);\n\t\t\t\t\t},\n\t\t\t\t\tonRotateRight: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.rotate(90);\n\t\t\t\t\t},\n\t\t\t\t\tonFlipHorizontal: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.flipX();\n\t\t\t\t\t},\n\t\t\t\t\tonReset: () => reset(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: apply\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindStageEvents();\n\t\t\t// only clear toolbar if ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === Controls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// Auto-initialize first region if empty\n\t$effect(() => {\n\t\tif (_toolBound && regions.length === 0) {\n\t\t\tcreateRegion();\n\t\t}\n\t});\n\n\t// add stage event listeners once\n\tfunction bindStageEvents() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || _toolBound) return;\n\t\tstage.on('click tap', handleStageClick);\n\t\tif (stage.container()) stage.container().style.cursor = 'crosshair';\n\t\t_toolBound = true;\n\t}\n\n\t// remove stage event listeners once\n\tfunction unbindStageEvents() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\tstage.off('click tap', handleStageClick);\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\t_toolBound = false;\n\t}\n\n\t// deselect all regions when clicking outside overlays\n\tfunction handleStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tconst t = e.target;\n\t\tif (!stage) return;\n\t\t// If clicking on stage, base image, or its group - create a new region\n\t\tif (t === stage || t === imageNode || t === imageGroup) {\n\t\t\tconst pos = stage.getPointerPosition();\n\t\t\tif (pos) {\n\t\t\t\t// Create a new region at click position with default size\n\t\t\t\tcreateRegion({\n\t\t\t\t\tx: pos.x - 100,\n\t\t\t\t\ty: pos.y - 75,\n\t\t\t\t\twidth: 200,\n\t\t\t\t\theight: 150,\n\t\t\t\t\tshape\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t// create a new region and wire lifecycle hooks\n\tfunction createRegion(init?: Partial<RegionInit>) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\tconst newR = new BlurRegion({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageNode,\n\t\t\timageGroup,\n\t\t\tinit: { shape, pattern, strength: blurStrength, ...init }\n\t\t});\n\n\t\tregions = [...regions, newR];\n\t\tactiveId = newR.id;\n\n\t\tnewR.onSelect(() => selectRegion(newR.id));\n\t\tnewR.onClone(() => {\n\t\t\tconst bounds = newR.shapeNode.getClientRect();\n\t\t\tcreateRegion({\n\t\t\t\tx: bounds.x + 20,\n\t\t\t\ty: bounds.y + 20,\n\t\t\t\twidth: bounds.width,\n\t\t\t\theight: bounds.height,\n\t\t\t\tshape: newR.shapeNode instanceof Konva.Ellipse ? 'ellipse' : 'rectangle',\n\t\t\t\tpattern: pattern,\n\t\t\t\tstrength: blurStrength\n\t\t\t});\n\t\t});\n\t\tnewR.onDestroy(() => {\n\t\t\tregions = regions.filter((x) => x.id !== newR.id);\n\t\t\tif (activeId === newR.id) activeId = null;\n\t\t});\n\n\t\t// Always finalize and apply effects for click-created regions\n\t\tnewR.setPattern(pattern);\n\t\tnewR.setStrength(blurStrength);\n\t\tnewR.finalize();\n\n\t\t// Make the new region active to show handles\n\t\tselectRegion(newR.id);\n\t}\n\n\t// make specified region active and hide others\n\tfunction selectRegion(id: string) {\n\t\tactiveId = id;\n\t\tregions.forEach((r) => r.setActive(r.id === id));\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// delete a region instance\n\tfunction deleteRegion(id: string) {\n\t\tconst r = regions.find((x) => x.id === id);\n\t\tr?.destroy();\n\t}\n\n\t// hide or destroy all regions (used before bake and during reset)\n\tfunction cleanupBlurElements(destroyRegions = true) {\n\t\tif (destroyRegions) {\n\t\t\t[...regions].forEach((region) => region.destroy());\n\t\t\tregions = [];\n\t\t} else {\n\t\t\tregions.forEach((region) => region.hideUI());\n\t\t}\n\t\tactiveId = null;\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// reset tool state and remove regions\n\texport function reset() {\n\t\tcleanupBlurElements(true);\n\t}\n\n\t// Apply blur: bake all blur regions into the image\n\texport function apply() {\n\t\t// Hide UI elements before baking\n\t\tcleanupBlurElements(false);\n\n\t\t// Take snapshot with blur regions visible\n\t\timageEditorStore.takeSnapshot();\n\n\t\t// Clean up and exit\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// cleanup invoked by parent store\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindStageEvents();\n\t\t\tcleanupBlurElements(true);\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Blur/index.ts\n * @description Blur tool for Konva\n *\n * Features:\n * - Blur\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'blur',\n\ttitle: 'Blur',\n\ticon: 'mdi:blur',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/CropControls.svelte\n@component\nModern controls for the Crop tool. Injected into the master toolbar.\n-->\n<script lang=\"ts\">\n\tlet {\n\t\tonRotateLeft,\n\t\tonRotateRight,\n\t\tonFlipHorizontal,\n\t\tonCropShapeChange,\n\t\tonAspectRatio,\n\t\tonApply,\n\t\tonCancel,\n\t\tcropShape\n\t}: {\n\t\tonRotateLeft: () => void;\n\t\tonRotateRight: () => void;\n\t\tonFlipHorizontal: () => void;\n\t\tonCropShapeChange: (shape: 'rectangle' | 'circular') => void;\n\t\tonAspectRatio: (ratio: number | null) => void;\n\t\tonApply: () => void;\n\t\tonCancel: () => void;\n\t\tcropShape: 'rectangle' | 'circular';\n\t} = $props();\n</script>\n\n<div class=\"flex items-center gap-3\">\n\t<!-- Aspect Ratio Presets -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(null)}>Free</button>\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(1)}>1:1</button>\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(16 / 9)}>16:9</button>\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(4 / 3)}>4:3</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Shape -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={cropShape === 'rectangle'} onclick={() => onCropShapeChange('rectangle')} title=\"Rectangle\">\n\t\t\t<iconify-icon icon=\"mdi:rectangle-outline\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn-sm\" class:active={cropShape === 'circular'} onclick={() => onCropShapeChange('circular')} title=\"Circle\">\n\t\t\t<iconify-icon icon=\"mdi:circle-outline\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Rotate & Flip -->\n\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateLeft} title=\"Rotate Left\">\n\t\t<iconify-icon icon=\"mdi:rotate-left\"></iconify-icon>\n\t</button>\n\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateRight} title=\"Rotate Right\">\n\t\t<iconify-icon icon=\"mdi:rotate-right\"></iconify-icon>\n\t</button>\n\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipHorizontal} title=\"Flip Horizontal\">\n\t\t<iconify-icon icon=\"mdi:flip-horizontal\"></iconify-icon>\n\t</button>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Cancel -->\n\t<button class=\"btn preset-outlined-error-500\" onclick={onCancel}>\n\t\t<iconify-icon icon=\"mdi:close\"></iconify-icon>\n\t\t<span>Cancel</span>\n\t</button>\n\n\t<!-- Apply -->\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Apply Crop</span>\n\t</button>\n</div>\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/aspect.ts\n * @description Aspect ratio parser for Konva\n *\n * Features:\n * - Parse aspect ratio string into numeric ratio or null\n */\nexport function parseAspectRatio(ratio: string | null): number | null {\n\tif (!ratio || ratio === 'free') return null;\n\tconst parts = ratio.split(':').map((p) => Number(p));\n\tif (parts.length !== 2 || Number.isNaN(parts[0]) || Number.isNaN(parts[1]) || parts[1] === 0) return null;\n\treturn parts[0] / parts[1];\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/highlight.ts\n * @description Highlight for Konva\n *\n * Features:\n * - Syncs the overlay cutout with the visible crop tool; optionally re-cache\n */\nimport Konva from 'konva';\n\n/** Syncs the overlay cutout with the visible crop tool; optionally re-cache */\nexport function syncHighlight(overlayGroup: Konva.Group, cropTool: Konva.Shape, shouldCache = true) {\n\tconst cut = overlayGroup.findOne('.cropCut') as Konva.Shape | undefined;\n\tif (!cut) return;\n\tif (cropTool instanceof Konva.Circle && cut instanceof Konva.Circle) {\n\t\tcut.position(cropTool.position());\n\t\tcut.radius((cropTool as Konva.Circle).radius());\n\t\tcut.rotation(cropTool.rotation());\n\t} else if (cropTool instanceof Konva.Rect && cut instanceof Konva.Rect) {\n\t\tcut.setAttrs({\n\t\t\tx: cropTool.x(),\n\t\t\ty: cropTool.y(),\n\t\t\twidth: cropTool.width() * cropTool.scaleX(),\n\t\t\theight: cropTool.height() * cropTool.scaleY(),\n\t\t\trotation: cropTool.rotation()\n\t\t});\n\t}\n\tif (shouldCache) {\n\t\tconst s = overlayGroup.getStage();\n\t\toverlayGroup.cache({ x: 0, y: 0, width: s?.width() ?? 0, height: s?.height() ?? 0, pixelRatio: 1 });\n\t}\n\toverlayGroup.getLayer()?.batchDraw();\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/region.ts\n * @description Regions for Crop tool\n *\n * Features:\n * - CropRegion encapsulates a single crop UI: overlay (cutout), tool border, transformer.\n */\nimport Konva from 'konva';\nimport { parseAspectRatio } from './aspect';\nimport { syncHighlight } from './highlight';\nimport { TRANSFORMER_STYLE_CROP, GRID_STYLE } from '../transformerConfig';\n\nexport type CropShape = 'rectangle' | 'square' | 'circular';\nexport type RegionInit = { x?: number; y?: number; width?: number; height?: number; shape?: CropShape; aspect?: string };\n\n/**\n * CropRegion encapsulates a single crop UI: overlay (cutout), tool border, transformer.\n */\nexport class CropRegion {\n\tid: string; // region id\n\tlayer: Konva.Layer; // owning layer\n\timageNode: Konva.Image; // reference to image node\n\timageGroup: Konva.Group; // reference to image group\n\n\tshape: Konva.Rect | Konva.Circle; // visible crop tool\n\toverlayGroup: Konva.Group; // cached overlay group that holds dark overlay + cutout\n\tgridGroup?: Konva.Group; // rule-of-thirds grid\n\ttransformer?: Konva.Transformer; // transformer for resize/rotate\n\tprivate aspect: string | null = null; // aspect ratio string\n\n\t// --- FIX: Event callback properties ---\n\tprivate _onTransform: (() => void) | null = null;\n\tprivate _onTransformEnd: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\n\tconstructor(opts: { id: string; layer: Konva.Layer; imageNode: Konva.Image; imageGroup: Konva.Group; init?: RegionInit }) {\n\t\tthis.id = opts.id;\n\t\tthis.layer = opts.layer;\n\t\tthis.imageNode = opts.imageNode;\n\t\tthis.imageGroup = opts.imageGroup;\n\t\tconst init = opts.init || {};\n\n\t\tthis.aspect = init.aspect ?? null;\n\n\t\t// create overlay group and shape\n\t\tthis.overlayGroup = new Konva.Group({ name: 'cropOverlayGroup' });\n\n\t\t// create dark full-screen rect (will be cached)\n\t\tconst stage = this.layer.getStage();\n\t\tconst sw = stage?.width() ?? 0;\n\t\tconst sh = stage?.height() ?? 0;\n\n\t\tconst dark = new Konva.Rect({ x: 0, y: 0, width: sw, height: sh, fill: 'rgba(0,0,0,0.8)', listening: false, name: 'cropOverlay' });\n\t\tthis.overlayGroup.add(dark);\n\n\t\t// compute initial size & center inside imageGroup visible area\n\t\tconst groupRect = this.imageGroup.getClientRect();\n\t\tconst size = Math.min(groupRect.width, groupRect.height) * 0.8;\n\t\tconst cx = groupRect.x + groupRect.width / 2;\n\t\tconst cy = groupRect.y + groupRect.height / 2;\n\n\t\tlet shapeWidth: number, shapeHeight: number;\n\t\tconst ratio = parseAspectRatio(this.aspect);\n\n\t\tif (ratio) {\n\t\t\tshapeWidth = size;\n\t\t\tshapeHeight = size / ratio;\n\t\t} else {\n\t\t\tshapeWidth = size;\n\t\t\tshapeHeight = size * 0.75; // Default freeform\n\t\t}\n\n\t\t// create cutout as circle or rect inside overlay group\n\t\tif (init.shape === 'circular') {\n\t\t\tconst radius = size / 2;\n\t\t\tconst cut = new Konva.Circle({\n\t\t\t\tx: cx,\n\t\t\t\ty: cy,\n\t\t\t\tradius: radius,\n\t\t\t\tfill: 'black',\n\t\t\t\tglobalCompositeOperation: 'destination-out',\n\t\t\t\tlistening: false,\n\t\t\t\tname: 'cropCut'\n\t\t\t});\n\t\t\tthis.overlayGroup.add(cut);\n\t\t\tthis.shape = new Konva.Circle({ x: cx, y: cy, radius: radius, stroke: 'white', strokeWidth: 3, draggable: true, name: 'cropTool' });\n\t\t} else {\n\t\t\tconst cut = new Konva.Rect({\n\t\t\t\tx: cx - shapeWidth / 2,\n\t\t\t\ty: cy - shapeHeight / 2,\n\t\t\t\twidth: shapeWidth,\n\t\t\t\theight: shapeHeight,\n\t\t\t\tfill: 'black',\n\t\t\t\tglobalCompositeOperation: 'destination-out',\n\t\t\t\tlistening: false,\n\t\t\t\tname: 'cropCut'\n\t\t\t});\n\t\t\tthis.overlayGroup.add(cut);\n\t\t\tthis.shape = new Konva.Rect({\n\t\t\t\tx: cx - shapeWidth / 2,\n\t\t\t\ty: cy - shapeHeight / 2,\n\t\t\t\twidth: shapeWidth,\n\t\t\t\theight: shapeHeight,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1,\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'cropTool'\n\t\t\t});\n\n\t\t\t// Create Grid for Rect\n\t\t\tthis.createGrid();\n\t\t}\n\n\t\t// cache overlay group to make globalCompositeOperation effect efficient\n\t\tthis.overlayGroup.cache({ x: 0, y: 0, width: sw, height: sh, pixelRatio: 1 });\n\t\tthis.layer.add(this.overlayGroup);\n\t\tthis.layer.add(this.shape);\n\n\t\t// layering: ensure imageGroup at bottom, overlay above image and shape above overlay\n\t\tthis.imageGroup.zIndex(0);\n\t\tthis.overlayGroup.zIndex(1);\n\t\tthis.gridGroup?.zIndex(2);\n\t\tthis.shape.zIndex(3);\n\n\t\t// ** FIX: Event wiring **\n\t\t// Wire up events to the internal callbacks\n\t\tthis.shape.on('dragmove transform', () => {\n\t\t\tthis._onTransform?.();\n\t\t\tthis.updateCutout(false); // Immediate shade update\n\t\t\tthis.updateGrid();\n\t\t});\n\t\tthis.shape.on('dragend transformend', () => {\n\t\t\tthis._onTransformEnd?.();\n\t\t});\n\t}\n\n\t/** Create 3x3 rule-of-thirds grid */\n\tprivate createGrid() {\n\t\tif (!(this.shape instanceof Konva.Rect)) return;\n\t\tif (this.gridGroup) this.gridGroup.destroy();\n\n\t\tthis.gridGroup = new Konva.Group({ listening: false });\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tthis.gridGroup.add(new Konva.Line({ name: `v${i}`, points: [0, 0, 0, 0], ...GRID_STYLE }));\n\t\t\tthis.gridGroup.add(new Konva.Line({ name: `h${i}`, points: [0, 0, 0, 0], ...GRID_STYLE }));\n\t\t}\n\t\tthis.layer.add(this.gridGroup);\n\t\tthis.updateGrid();\n\t}\n\n\t/** Update grid lines to match shape bounds */\n\tprivate updateGrid() {\n\t\tif (!this.gridGroup || !(this.shape instanceof Konva.Rect)) return;\n\n\t\tconst x = this.shape.x();\n\t\tconst y = this.shape.y();\n\t\tconst w = this.shape.width() * this.shape.scaleX();\n\t\tconst h = this.shape.height() * this.shape.scaleY();\n\n\t\t// Vertical lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst lx = x + (w * i) / 3;\n\t\t\tconst vLine = this.gridGroup.findOne(`.v${i}`) as Konva.Line;\n\t\t\tif (vLine) vLine.points([lx, y, lx, y + h]);\n\n\t\t\tconst ly = y + (h * i) / 3;\n\t\t\tconst hLine = this.gridGroup.findOne(`.h${i}`) as Konva.Line;\n\t\t\tif (hLine) hLine.points([x, ly, x + w, ly]);\n\t\t}\n\t}\n\n\t// ** FIX: Use the 'highlight.ts' util **\n\t// one-line comment: update cutout to match shape transform\n\tupdateCutout(shouldCache = true) {\n\t\tsyncHighlight(this.overlayGroup, this.shape, shouldCache);\n\t}\n\n\t// ** NEW: Helper to re-center region **\n\tcenterIn(rect: { x: number; y: number; width: number; height: number }) {\n\t\tconst cx = rect.x + rect.width / 2;\n\t\tconst cy = rect.y + rect.height / 2;\n\t\tthis.shape.position({ x: cx, y: cy });\n\t\tthis.transformer?.forceUpdate();\n\t}\n\n\t// one-line comment: attach transformer with aspect handling\n\tattachTransformer() {\n\t\tif (this.transformer) this.transformer.destroy();\n\t\tconst ratio = parseAspectRatio(this.aspect ?? 'free');\n\t\tconst keepRatio = this.shape instanceof Konva.Circle || this.aspect === '1:1' || (ratio !== null && typeof ratio === 'number');\n\n\t\tthis.transformer = new Konva.Transformer({\n\t\t\tnodes: [this.shape],\n\t\t\t...TRANSFORMER_STYLE_CROP,\n\t\t\tkeepRatio: keepRatio,\n\t\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\t\t\trotateEnabled: false, // Rotation is handled by the main tool\n\t\t\tboundBoxFunc: (oldBox, newBox) => {\n\t\t\t\tif (newBox.width < 30 || newBox.height < 30) return oldBox;\n\t\t\t\t// Enforce aspect ratio if set\n\t\t\t\tif (ratio && keepRatio && this.shape instanceof Konva.Rect) {\n\t\t\t\t\tnewBox.height = newBox.width / ratio;\n\t\t\t\t}\n\t\t\t\treturn newBox;\n\t\t\t}\n\t\t});\n\t\tthis.layer.add(this.transformer);\n\t\tthis.transformer.zIndex(4);\n\t\tthis.transformer.moveToTop();\n\t}\n\n\t// one-line comment: hide UI for baking\n\thideUI() {\n\t\tthis.transformer?.visible(false);\n\t\tthis.shape.visible(false);\n\t\tthis.gridGroup?.visible(false);\n\t\tthis.overlayGroup.visible(false); // Hide the whole overlay\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// one-line comment: destroy region and call destructor\n\tdestroy() {\n\t\tthis.shape.off('dragmove transform dragend transformend');\n\t\tthis.transformer?.destroy();\n\t\tthis.gridGroup?.destroy();\n\t\tthis.overlayGroup.destroy();\n\t\tthis.shape.destroy();\n\t\tthis._onDestroy?.();\n\t}\n\n\t// --- FIX: Expose event setters ---\n\tonTransform(cb: () => void) {\n\t\tthis._onTransform = cb;\n\t}\n\tonTransformEnd(cb: () => void) {\n\t\tthis._onTransformEnd = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n}\n\nexport default CropRegion;\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Crop/Tool.svelte\n@component\n**Crop Tool \"Controller\"**\n\nOrchestrates the CropRegion, handles rotations/flips,\nand implements the correct 'apply' logic by setting the\nimageNode's 'crop' properties.\n-->\n<script lang=\"ts\">\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport CropControls from './Controls.svelte';\n\timport CropRegion, { type CropShape } from './regions';\n\timport { showToast } from '@shared/utils/toast';\n\n\tlet cropShape = $state<CropShape>('rectangle');\n\tlet aspectRatio = $state('free');\n\n\t// This is the *only* region. We don't use an array for crop.\n\tlet region = $state<CropRegion | null>(null);\n\n\tconst { onCancel }: { onCancel: () => void } = $props();\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'crop') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: CropControls,\n\t\t\t\tprops: {\n\t\t\t\t\tcropShape,\n\t\t\t\t\tonRotateLeft: rotateLeft,\n\t\t\t\t\tonRotateRight: rotateRight,\n\t\t\t\t\tonFlipHorizontal: flipHorizontal,\n\t\t\t\t\tonCropShapeChange: (s: CropShape) => {\n\t\t\t\t\t\tcropShape = s;\n\t\t\t\t\t\tif (s === 'square' || s === 'circular') {\n\t\t\t\t\t\t\taspectRatio = '1:1';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (s === 'circular') {\n\t\t\t\t\t\t\tshowToast('Round Crop selected. Image will be saved with transparency.', 'info');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tinitDefaultRegion();\n\t\t\t\t\t},\n\t\t\t\t\tonAspectRatio: (r: number | null) => {\n\t\t\t\t\t\taspectRatio = r === null ? 'free' : `${r}`;\n\t\t\t\t\t\tif (r === 1) {\n\t\t\t\t\t\t\tcropShape = cropShape === 'circular' ? 'circular' : 'square';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcropShape = 'rectangle';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tinitDefaultRegion();\n\t\t\t\t\t},\n\t\t\t\t\tonApply: apply,\n\t\t\t\t\tonCancel: () => onCancel()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\t// Only clear controls if they are ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === CropControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// add stage event listeners once\n\tfunction bindTool() {\n\t\tif (_toolBound) return;\n\t\t_toolBound = true;\n\t\t// Initialize the crop region when tool is activated\n\t\tinitDefaultRegion();\n\t}\n\n\t// remove stage event listeners once\n\tfunction unbindTool() {\n\t\tif (!_toolBound) return;\n\t\t_toolBound = false;\n\t\tcleanup(); // Destroy region when tool is deactivated\n\t}\n\n\t// create a new region and wire lifecycle hooks\n\tfunction initDefaultRegion() {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\t// Clean up old region first\n\t\tif (region) {\n\t\t\tregion.destroy();\n\t\t\tregion = null;\n\t\t}\n\n\t\tconst newRegion = new CropRegion({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageNode,\n\t\t\timageGroup,\n\t\t\tinit: { shape: cropShape as CropShape, aspect: aspectRatio }\n\t\t});\n\n\t\t// Wire event to update cutout on drag/transform\n\t\t// ** FIX 1: This is the 'desync' fix **\n\t\tnewRegion.onTransform(() => {\n\t\t\tnewRegion.updateCutout(false); // fast update, no cache\n\t\t});\n\t\tnewRegion.onTransformEnd(() => {\n\t\t\tnewRegion.updateCutout(true); // slow update, with cache\n\t\t});\n\n\t\tnewRegion.attachTransformer();\n\t\tregion = newRegion;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateLeft() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\t// Get current rotation and add -90\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation - 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipHorizontal() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleX(imageGroup.scaleX() * -1);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateRight() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\t// Get current rotation and add +90\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation + 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\t// Apply crop: calculate the crop rect and set it on the imageNode\n\tfunction apply() {\n\t\tconst { imageNode, imageGroup, layer, stage } = imageEditorStore.state;\n\t\tif (!imageNode || !imageGroup || !region || !layer || !stage) return;\n\n\t\t// Import the cropMath utility\n\t\timport('./cropMath').then(({ stageRectToImageRect }) => {\n\t\t\t// Get the crop region's bounding box in stage coordinates\n\t\t\tconst cropRect = region!.shape.getClientRect();\n\n\t\t\t// Convert to image-local coordinates\n\t\t\tconst imageCrop = stageRectToImageRect(cropRect, imageNode, imageGroup);\n\n\t\t\t// Apply crop to the image node\n\t\t\timageNode.cropX(imageCrop.x);\n\t\t\timageNode.cropY(imageCrop.y);\n\t\t\timageNode.cropWidth(imageCrop.width);\n\t\t\timageNode.cropHeight(imageCrop.height);\n\n\t\t\t// Update image dimensions to match crop\n\t\t\timageNode.width(imageCrop.width);\n\t\t\timageNode.height(imageCrop.height);\n\n\t\t\t// Reset image position to center within the group\n\t\t\timageNode.x(-imageCrop.width / 2);\n\t\t\timageNode.y(-imageCrop.height / 2);\n\n\t\t\t// Handle round crop transparency\n\t\t\tif (cropShape === 'circular') {\n\t\t\t\timageNode.cornerRadius(Math.max(imageCrop.width, imageCrop.height));\n\t\t\t} else {\n\t\t\t\timageNode.cornerRadius(0);\n\t\t\t}\n\n\t\t\t// Recalculate scale to fit the cropped image in the viewport\n\t\t\tconst containerWidth = stage.width();\n\t\t\tconst containerHeight = stage.height();\n\t\t\tconst scaleX = (containerWidth * 0.8) / imageCrop.width;\n\t\t\tconst scaleY = (containerHeight * 0.8) / imageCrop.height;\n\t\t\tconst newScale = Math.min(scaleX, scaleY);\n\n\t\t\t// Reset imageGroup transform\n\t\t\timageGroup.scaleX(newScale);\n\t\t\timageGroup.scaleY(newScale);\n\t\t\timageGroup.rotation(0); // Reset rotation\n\t\t\timageGroup.x(containerWidth / 2);\n\t\t\timageGroup.y(containerHeight / 2);\n\n\t\t\t// Hide the crop UI\n\t\t\tregion!.hideUI();\n\n\t\t\t// Redraw and take snapshot\n\t\t\tlayer.batchDraw();\n\t\t\timageEditorStore.takeSnapshot();\n\t\t\timageEditorStore.setActiveState('');\n\t\t});\n\t}\n\n\t// cleanup invoked by parent store\n\texport function cleanup() {\n\t\tif (region) {\n\t\t\tregion.destroy();\n\t\t\tregion = null;\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n\n\t// --- Expose functions for Controls ---\n\t// These are now part of the props passed to setToolbarControls\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/index.ts\n * @description Crop tool for Konva\n *\n * Features:\n * - Crop\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'crop',\n\ttitle: 'Crop',\n\ticon: 'mdi:crop',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/FineTuneControls.svelte\n@component\nControls for the FineTune tool, including a dropdown for adjustment type and a slider.\n-->\n<script lang=\"ts\">\n\timport type { Adjustments } from '@cms/components/imageEditor/widgets/FineTune/adjustments';\n\n\tconst {\n\t\tactiveAdjustment,\n\t\tvalue,\n\t\tonChange,\n\t\tonAdjustmentChange,\n\t\tonReset,\n\t\tonCancel,\n\t\tonApply\n\t}: {\n\t\tactiveAdjustment: keyof Adjustments;\n\t\tvalue: number;\n\t\tonChange: (value: number) => void;\n\t\tonAdjustmentChange: (key: keyof Adjustments) => void;\n\t\tonReset: () => void;\n\t\tonCancel: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n\n\tconst adjustments: { key: keyof Adjustments; label: string; icon: string }[] = [\n\t\t{ key: 'brightness', label: 'Brightness', icon: 'mdi:brightness-6' },\n\t\t{ key: 'contrast', label: 'Contrast', icon: 'mdi:contrast-box' },\n\t\t{ key: 'saturation', label: 'Saturation', icon: 'mdi:palette' },\n\t\t{ key: 'exposure', label: 'Exposure', icon: 'mdi:brightness-7' },\n\t\t{ key: 'highlights', label: 'Highlights', icon: 'mdi:white-balance-sunny' },\n\t\t{ key: 'shadows', label: 'Shadows', icon: 'mdi:weather-night' },\n\t\t{ key: 'temperature', label: 'Temperature', icon: 'mdi:thermometer' },\n\t\t{ key: 'clarity', label: 'Clarity', icon: 'mdi:crystal-ball' },\n\t\t{ key: 'vibrance', label: 'Vibrance', icon: 'mdi:vibrate' }\n\t];\n\n\tfunction handleSliderInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tonChange(parseInt(target.value, 10));\n\t}\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<!-- Adjustment Selector (Horizontal Scroll) -->\n\t<div class=\"flex-1 overflow-x-auto no-scrollbar py-1\">\n\t\t<div class=\"flex items-center gap-1 min-w-max px-2\">\n\t\t\t{#each adjustments as adj}\n\t\t\t\t<button\n\t\t\t\t\tclass=\"btn-sm preset-outlined-surface-500flex flex-col items-center gap-1 w-20 h-14\"\n\t\t\t\t\tclass:preset-filled-primary-500={activeAdjustment === adj.key}\n\t\t\t\t\tonclick={() => onAdjustmentChange(adj.key)}\n\t\t\t\t\ttitle={adj.label}\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon={adj.icon} width=\"18\"></iconify-icon>\n\t\t\t\t\t<span class=\"text-[10px] uppercase tracking-tighter leading-none\">{adj.label}</span>\n\t\t\t\t</button>\n\t\t\t{/each}\n\t\t</div>\n\t</div>\n\n\t<!-- Slider -->\n\t<div class=\"w-48 px-2 flex flex-col gap-1\">\n\t\t<div class=\"flex justify-between text-[10px] text-surface-500 uppercase font-bold\">\n\t\t\t<span>{adjustments.find((a) => a.key === activeAdjustment)?.label}</span>\n\t\t\t<span class={value !== 0 ? 'text-primary-500' : ''}>{value}</span>\n\t\t</div>\n\t\t<input type=\"range\" min=\"-100\" max=\"100\" step=\"1\" {value} oninput={handleSliderInput} class=\"range range-primary range-sm\" />\n\t</div>\n\n\t<!-- Reset -->\n\t<button onclick={onReset} class=\"btn-sm btn-icon preset-outlined-surface-500\" title=\"Reset this adjustment\" disabled={value === 0}>\n\t\t<iconify-icon icon=\"mdi:restore\"></iconify-icon>\n\t</button>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Cancel -->\n\t<button class=\"btn preset-outlined-error-500\" onclick={onCancel}>\n\t\t<iconify-icon icon=\"mdi:close\"></iconify-icon>\n\t\t<span>Cancel</span>\n\t</button>\n\n\t<!-- Apply -->\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Apply</span>\n\t</button>\n</div>\n\n<style>\n\t.no-scrollbar::-webkit-scrollbar {\n\t\tdisplay: none;\n\t}\n\t.no-scrollbar {\n\t\t-ms-overflow-style: none;\n\t\tscrollbar-width: none;\n\t}\n</style>\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/controls/adjustments.ts\n * @description Central adjustment definitions used by FineTune tool.\n *\n * Features:\n * - Central adjustment definitions used by FineTune tool.\n */\nexport interface Adjustments {\n\tbrightness: number;\n\tcontrast: number;\n\tsaturation: number;\n\ttemperature: number;\n\texposure: number;\n\thighlights: number;\n\tshadows: number;\n\tclarity: number;\n\tvibrance: number;\n}\n\nexport const DEFAULT_ADJUSTMENTS: Adjustments = {\n\tbrightness: 0,\n\tcontrast: 0,\n\tsaturation: 0,\n\ttemperature: 0,\n\texposure: 0,\n\thighlights: 0,\n\tshadows: 0,\n\tclarity: 0,\n\tvibrance: 0\n};\n\nexport const ADJUSTMENT_OPTIONS = [\n\t{ key: 'brightness', label: 'Brightness' },\n\t{ key: 'contrast', label: 'Contrast' },\n\t{ key: 'saturation', label: 'Saturation' },\n\t{ key: 'temperature', label: 'Temperature' },\n\t{ key: 'exposure', label: 'Exposure' },\n\t{ key: 'highlights', label: 'Highlights' },\n\t{ key: 'shadows', label: 'Shadows' },\n\t{ key: 'clarity', label: 'Clarity' },\n\t{ key: 'vibrance', label: 'Vibrance' }\n] as const;\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/filters/baseFilters.ts\n * @description Applies standard Konva provided filters.\n *\n * Features:\n * - Applies standard Konva provided filters.\n */\nimport Konva from 'konva';\nimport type { Adjustments } from './adjustments';\n\n/**\n * Applies fast, Konva-native filters (non-pixel-looping)\n * to the image node.\n */\nexport function applyBaseFilters(node: Konva.Image, adj: Adjustments) {\n\tnode.brightness(adj.brightness / 100);\n\tnode.contrast(adj.contrast / 100);\n\n\t// Combine saturation and vibrance\n\t// Vibrance is a \"smart\" saturation, apply it at a lower intensity\n\tconst combinedSaturation = (adj.saturation + adj.vibrance * 0.7) / 100;\n\tnode.saturation(combinedSaturation);\n\n\t// Konva has HSL filters, but they are often less intuitive\n\t// for 'saturation' than the built-in property.\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/filters/customFilters.ts\n * @description Custom pixel-level filter logic for exposure, shadows, clarity.\n *\n * Features:\n * - Custom pixel-level filter logic for exposure, shadows, clarity.\n */\nimport type { Adjustments } from './adjustments';\n\n/**\n * Creates a slow, pixel-looping filter function for Konva\n * to handle adjustments not built-in (exposure, shadows, etc.).\n */\nexport function createCustomFilter(adj: Adjustments) {\n\t// Pre-calculate factors for performance\n\tconst expFactor = 1 + adj.exposure / 100;\n\tconst highFactor = 1 + adj.highlights / 100;\n\tconst shadowFactor = 1 + adj.shadows / 100;\n\tconst clarityFactor = 1 + adj.clarity / 100;\n\tconst mid = 128;\n\n\treturn function (imageData: ImageData) {\n\t\tconst data = imageData.data;\n\n\t\tfor (let i = 0; i < data.length; i += 4) {\n\t\t\tlet r = data[i];\n\t\t\tlet g = data[i + 1];\n\t\t\tlet b = data[i + 2];\n\n\t\t\t// 1. Exposure (simple multiply)\n\t\t\tif (adj.exposure !== 0) {\n\t\t\t\tr *= expFactor;\n\t\t\t\tg *= expFactor;\n\t\t\t\tb *= expFactor;\n\t\t\t}\n\n\t\t\t// Get perceived brightness (luminance)\n\t\t\tconst brightness = 0.299 * r + 0.587 * g + 0.114 * b;\n\n\t\t\t// 2. Highlights (affect bright areas)\n\t\t\tif (adj.highlights !== 0 && brightness > 150) {\n\t\t\t\t// Target brights\n\t\t\t\tconst highAmount = (brightness - 150) / 105; // 0..1\n\t\t\t\tconst factor = 1 + (highFactor - 1) * highAmount;\n\t\t\t\tr *= factor;\n\t\t\t\tg *= factor;\n\t\t\t\tb *= factor;\n\t\t\t}\n\n\t\t\t// 3. Shadows (affect dark areas)\n\t\t\tif (adj.shadows !== 0 && brightness < 100) {\n\t\t\t\t// Target darks\n\t\t\t\tconst shadowAmount = (100 - brightness) / 100; // 0..1\n\t\t\t\tconst factor = 1 + (shadowFactor - 1) * shadowAmount;\n\t\t\t\tr *= factor;\n\t\t\t\tg *= factor;\n\t\t\t\tb *= factor;\n\t\t\t}\n\n\t\t\t// 4. Clarity (increases mid-tone contrast)\n\t\t\tif (adj.clarity !== 0) {\n\t\t\t\tr = mid + (r - mid) * clarityFactor;\n\t\t\t\tg = mid + (g - mid) * clarityFactor;\n\t\t\t\tb = mid + (b - mid) * clarityFactor;\n\t\t\t}\n\n\t\t\t// 5. Temperature (Warm/Cool)\n\t\t\tif (adj.temperature !== 0) {\n\t\t\t\tconst shift = (adj.temperature / 100) * 20; // Max 20 unit shift\n\t\t\t\tr += shift;\n\t\t\t\tb -= shift;\n\t\t\t}\n\n\t\t\t// Clamp values\n\t\t\tdata[i] = Math.min(255, Math.max(0, r));\n\t\t\tdata[i + 1] = Math.min(255, Math.max(0, g));\n\t\t\tdata[i + 2] = Math.min(255, Math.max(0, b));\n\t\t}\n\t};\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/FineTune/Tool.svelte\n@component\n**Fine-Tune \"Controller\" Component**\n\nOrchestrates the filter modules:\n- Manages $state for all adjustments.\n- Registers the toolbar UI.\n- Applies filters (base + custom) in a debounced $effect.\n- Handles \"Compare\" logic using Konva's cache.\n- Implements the final 'apply' (bake) logic.\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport FineTuneControls from './Controls.svelte';\n\timport { type Adjustments, DEFAULT_ADJUSTMENTS } from './adjustments';\n\timport { applyBaseFilters } from './baseFilters';\n\timport { createCustomFilter } from './customFilters';\n\n\t// --- Svelte 5 State ---\n\tlet adjustments = $state({ ...DEFAULT_ADJUSTMENTS });\n\tlet activeAdjustment = $state<keyof Adjustments>('brightness');\n\n\tconst adjustments_list = [\n\t\t{ key: 'brightness', label: 'Brightness', icon: 'mdi:brightness-6' },\n\t\t{ key: 'contrast', label: 'Contrast', icon: 'mdi:contrast-box' },\n\t\t{ key: 'saturation', label: 'Saturation', icon: 'mdi:palette' },\n\t\t{ key: 'exposure', label: 'Exposure', icon: 'mdi:brightness-7' },\n\t\t{ key: 'highlights', label: 'Highlights', icon: 'mdi:white-balance-sunny' },\n\t\t{ key: 'shadows', label: 'Shadows', icon: 'mdi:weather-night' },\n\t\t{ key: 'temperature', label: 'Temperature', icon: 'mdi:thermometer' },\n\t\t{ key: 'clarity', label: 'Clarity', icon: 'mdi:crystal-ball' },\n\t\t{ key: 'vibrance', label: 'Vibrance', icon: 'mdi:vibrate' }\n\t];\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// debounce timer for slider updates\n\tlet filterDebounceTimer: number | null = null;\n\n\t// --- Lifecycle $effect ---\n\t// Binds/unbounds the tool and registers the toolbar\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'finetune') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: FineTuneControls,\n\t\t\t\tprops: {\n\t\t\t\t\tactiveAdjustment: activeAdjustment,\n\t\t\t\t\tactiveIcon: adjustments_list.find((a) => a.key === activeAdjustment)?.icon,\n\t\t\t\t\tvalue: adjustments[activeAdjustment],\n\t\t\t\t\tonChange: (value: number) => {\n\t\t\t\t\t\tadjustments[activeAdjustment] = value;\n\t\t\t\t\t},\n\t\t\t\t\tonAdjustmentChange: (key: keyof Adjustments) => {\n\t\t\t\t\t\tactiveAdjustment = key;\n\t\t\t\t\t},\n\t\t\t\t\tonReset: () => resetAdjustment(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === FineTuneControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Core Filter Logic ---\n\t// This $effect watches for adjustment changes,\n\t// debounces them, and applies the Konva filters.\n\t$effect(() => {\n\t\tif (!_toolBound) return;\n\n\t\t// Force dependency tracking by reading adjustments state here\n\t\tconst currentAdjustments = JSON.parse(JSON.stringify(adjustments));\n\n\t\t// Debounce to prevent thrashing on slider drag\n\t\tif (filterDebounceTimer) clearTimeout(filterDebounceTimer);\n\n\t\tfilterDebounceTimer = window.setTimeout(() => {\n\t\t\tconst { imageNode, layer } = imageEditorStore.state;\n\t\t\tif (!imageNode || !layer) return;\n\n\t\t\t// Log for debugging\n\t\t\tconsole.log('Applying FineTune adjustments:', currentAdjustments);\n\n\t\t\t// 1. Prepare filter list\n\t\t\tconst activeFilters = [];\n\n\t\t\t// Base Konva filters (Brighten, Contrast, HSL for saturation/hue)\n\t\t\tactiveFilters.push(Konva.Filters.Brighten);\n\t\t\tactiveFilters.push(Konva.Filters.Contrast);\n\t\t\tactiveFilters.push(Konva.Filters.HSL);\n\n\t\t\t// 2. Check for slow, custom pixel-looping filters\n\t\t\tconst needsCustom =\n\t\t\t\tadjustments.exposure !== 0 ||\n\t\t\t\tadjustments.highlights !== 0 ||\n\t\t\t\tadjustments.shadows !== 0 ||\n\t\t\t\tadjustments.clarity !== 0 ||\n\t\t\t\tadjustments.temperature !== 0;\n\t\t\tif (needsCustom) {\n\t\t\t\tactiveFilters.push(createCustomFilter(currentAdjustments));\n\t\t\t}\n\n\t\t\t// 3. Set filters on node\n\t\t\timageNode.filters(activeFilters);\n\n\t\t\t// 4. Update the actual properties (brightness, contrast, saturation, hue)\n\t\t\tapplyBaseFilters(imageNode, currentAdjustments);\n\n\t\t\t// 5. Re-cache the node to apply all filters\n\t\t\timageNode.clearCache();\n\t\t\timageNode.cache();\n\t\t\tlayer.batchDraw();\n\t\t}, 100); // 100ms debounce\n\t});\n\n\tfunction bindTool() {\n\t\tif (_toolBound) return;\n\t\t_toolBound = true;\n\t\t// Save the current state (which should be 0s) as the 'reset' point\n\t\tadjustments = { ...DEFAULT_ADJUSTMENTS };\n\t}\n\n\tfunction unbindTool() {\n\t\tif (!_toolBound) return;\n\t\t_toolBound = false;\n\t\tif (filterDebounceTimer) clearTimeout(filterDebounceTimer);\n\t}\n\n\t/**\n\t * Toggles comparison view.\n\t * This is the *most efficient* way:\n\t * - clearCache() reverts to the pre-filter image.\n\t * - cache() re-applies the filters.\n\t */\n\tfunction resetAdjustment() {\n\t\tadjustments[activeAdjustment] = 0;\n\t}\n\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/index.ts\n * @description Registers the FineTune tool and its controls.\n *\n * Features:\n * - Registers the FineTune tool and its controls.\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'finetune',\n\ttitle: 'Fine-Tune',\n\ticon: 'mdi:tune',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file src/components/imageEditor/toolbars/FocalPointControls.svelte\n@component\nToolbar controls for the FocalPoint widget\n-->\n\n<script lang=\"ts\">\n\tinterface Props {\n\t\tfocalX?: number;\n\t\tfocalY?: number;\n\t\tonReset?: () => void;\n\t\tonApply?: () => void;\n\t\tonCancel?: () => void;\n\t}\n\n\tconst { focalX = 50, focalY = 50, onReset = () => {}, onApply = () => {}, onCancel = () => {} }: Props = $props();\n</script>\n\n<div class=\"flex items-center gap-4 flex-wrap\">\n\t<!-- Focal Point Coordinates -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm font-medium\">Focal Point:</span>\n\t\t<div class=\"flex items-center gap-1\">\n\t\t\t<span class=\"badge variant-soft-primary text-xs\">X: {focalX}%</span>\n\t\t\t<span class=\"badge variant-soft-primary text-xs\">Y: {focalY}%</span>\n\t\t</div>\n\t</div>\n\n\t<!-- Instructions -->\n\t<span class=\"text-xs text-surface-600 dark:text-surface-50\"> Click on the image to set focal point </span>\n\n\t<!-- Spacer -->\n\t<div class=\"flex-1\"></div>\n\n\t<!-- Actions -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<button onclick={onReset} class=\"btn preset-outlined-surface-500btn-sm\" title=\"Reset to center\">\n\t\t\t<iconify-icon icon=\"mdi:restore\" width=\"18\"></iconify-icon>\n\t\t\t<span>Reset</span>\n\t\t</button>\n\n\t\t<button onclick={onCancel} class=\"btn preset-outlined-error-500 btn-sm\" title=\"Discard changes\">\n\t\t\t<iconify-icon icon=\"mdi:close\" width=\"18\"></iconify-icon>\n\t\t\t<span>Cancel</span>\n\t\t</button>\n\n\t\t<button onclick={onApply} class=\"btn preset-filled-primary-500 btn-sm\" title=\"Apply focal point\">\n\t\t\t<iconify-icon icon=\"mdi:check\" width=\"18\"></iconify-icon>\n\t\t\t<span>Apply</span>\n\t\t</button>\n\t</div>\n</div>\n","<!--\n@file src/components/imageEditor/widgets/FocalPoint/Tool.svelte\n@component\n**FocalPoint Tool**\n\nAllows users to set the focal point of an image with rule of thirds grid overlay.\n- Displays rule of thirds grid\n- Click to set focal point\n- Shows crosshair at focal point\n- Updates toolbar with X/Y coordinates\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport FocalPointControls from './Controls.svelte';\n\n\t// --- Svelte 5 State ---\n\tlet focalPoint = $state<{ x: number; y: number }>({ x: 0.5, y: 0.5 }); // Normalized 0-1\n\tlet gridLayer = $state<Konva.Layer | null>(null);\n\tlet crosshair = $state<Konva.Group | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// --- Lifecycle $effect ---\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'focalpoint') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: FocalPointControls,\n\t\t\t\tprops: {\n\t\t\t\t\tfocalX: Math.round(focalPoint.x * 100),\n\t\t\t\t\tfocalY: Math.round(focalPoint.y * 100),\n\t\t\t\t\tonReset: () => resetFocalPoint(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === FocalPointControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, imageNode } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\t// Get existing focal point from metadata\n\t\tconst metadata = (imageNode as any).metadata;\n\t\tif (metadata?.focalPoint) {\n\t\t\tfocalPoint = { ...metadata.focalPoint };\n\t\t}\n\n\t\t// Create grid overlay\n\t\tcreateGridOverlay();\n\t\tcreateCrosshair();\n\n\t\t// Bind click event\n\t\tstage.on('click.focalpoint tap.focalpoint', onStageClick);\n\t\tstage.container().style.cursor = 'crosshair';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off('click.focalpoint tap.focalpoint');\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\n\t\t// Remove grid overlay\n\t\tgridLayer?.destroy();\n\t\tgridLayer = null;\n\t\tcrosshair = null;\n\t}\n\n\t// --- Grid Overlay ---\n\tfunction createGridOverlay() {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || !imageGroup) return;\n\n\t\t// Create a new layer for the grid (on top of everything)\n\t\tgridLayer = new Konva.Layer();\n\t\tstage.add(gridLayer);\n\t\tgridLayer.moveToTop();\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst imageX = imageGroup.x();\n\t\tconst imageY = imageGroup.y();\n\n\t\t// Calculate actual top-left of image (accounting for centering in group)\n\t\tconst originX = imageX - imageWidth / 2;\n\t\tconst originY = imageY - imageHeight / 2;\n\n\t\t// Draw rule of thirds grid\n\t\tconst lineColor = '#00ff00';\n\t\tconst lineWidth = 1;\n\t\tconst opacity = 0.7;\n\n\t\t// Vertical lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst x = originX + (imageWidth / 3) * i;\n\t\t\tconst line = new Konva.Line({\n\t\t\t\tpoints: [x, originY, x, originY + imageHeight],\n\t\t\t\tstroke: lineColor,\n\t\t\t\tstrokeWidth: lineWidth,\n\t\t\t\topacity: opacity,\n\t\t\t\tlistening: false\n\t\t\t});\n\t\t\tgridLayer.add(line);\n\t\t}\n\n\t\t// Horizontal lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst y = originY + (imageHeight / 3) * i;\n\t\t\tconst line = new Konva.Line({\n\t\t\t\tpoints: [originX, y, originX + imageWidth, y],\n\t\t\t\tstroke: lineColor,\n\t\t\t\tstrokeWidth: lineWidth,\n\t\t\t\topacity: opacity,\n\t\t\t\tlistening: false\n\t\t\t});\n\t\t\tgridLayer.add(line);\n\t\t}\n\n\t\tgridLayer.batchDraw();\n\t}\n\n\tfunction createCrosshair() {\n\t\tconst { imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!gridLayer || !imageNode || !imageGroup) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst imageX = imageGroup.x();\n\t\tconst imageY = imageGroup.y();\n\n\t\t// Calculate actual top-left of image (accounting for centering in group)\n\t\tconst originX = imageX - imageWidth / 2;\n\t\tconst originY = imageY - imageHeight / 2;\n\n\t\t// Calculate crosshair position\n\t\tconst x = originX + imageWidth * focalPoint.x;\n\t\tconst y = originY + imageHeight * focalPoint.y;\n\n\t\t// Create crosshair group\n\t\tcrosshair = new Konva.Group({\n\t\t\tx: x,\n\t\t\ty: y,\n\t\t\tlistening: false\n\t\t});\n\n\t\t// Crosshair lines\n\t\tconst size = 20;\n\t\tconst color = '#ff0000';\n\t\tconst width = 2;\n\n\t\tconst hLine = new Konva.Line({\n\t\t\tpoints: [-size, 0, size, 0],\n\t\t\tstroke: color,\n\t\t\tstrokeWidth: width\n\t\t});\n\n\t\tconst vLine = new Konva.Line({\n\t\t\tpoints: [0, -size, 0, size],\n\t\t\tstroke: color,\n\t\t\tstrokeWidth: width\n\t\t});\n\n\t\t// Center circle\n\t\tconst circle = new Konva.Circle({\n\t\t\tradius: 4,\n\t\t\tfill: color,\n\t\t\tstroke: '#ffffff',\n\t\t\tstrokeWidth: 2\n\t\t});\n\n\t\tcrosshair.add(hLine, vLine, circle);\n\t\tgridLayer.add(crosshair);\n\t\tgridLayer.batchDraw();\n\t}\n\n\t// --- Event Handlers ---\n\tfunction onStageClick() {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || !imageGroup) return;\n\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst originX = imageGroup.x() - imageWidth / 2;\n\t\tconst originY = imageGroup.y() - imageHeight / 2;\n\n\t\t// Check if click is within image bounds\n\t\tif (pos.x < originX || pos.x > originX + imageWidth || pos.y < originY || pos.y > originY + imageHeight) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Calculate normalized focal point (0-1)\n\t\tfocalPoint = {\n\t\t\tx: (pos.x - originX) / imageWidth,\n\t\t\ty: (pos.y - originY) / imageHeight\n\t\t};\n\n\t\t// Update crosshair position\n\t\tupdateCrosshair();\n\n\t\t// Update toolbar (reactive)\n\t\timageEditorStore.setToolbarControls({\n\t\t\tcomponent: FocalPointControls,\n\t\t\tprops: {\n\t\t\t\tfocalX: Math.round(focalPoint.x * 100),\n\t\t\t\tfocalY: Math.round(focalPoint.y * 100),\n\t\t\t\tonReset: () => resetFocalPoint(),\n\t\t\t\tonApply: () => apply()\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction updateCrosshair() {\n\t\tconst { imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!crosshair || !imageNode || !imageGroup) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst originX = imageGroup.x() - imageWidth / 2;\n\t\tconst originY = imageGroup.y() - imageHeight / 2;\n\n\t\tconst x = originX + imageWidth * focalPoint.x;\n\t\tconst y = originY + imageHeight * focalPoint.y;\n\n\t\tcrosshair.position({ x, y });\n\t\tgridLayer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction resetFocalPoint() {\n\t\tfocalPoint = { x: 0.5, y: 0.5 };\n\t\tupdateCrosshair();\n\t}\n\n\tfunction apply() {\n\t\tconst { imageNode } = imageEditorStore.state;\n\t\tif (!imageNode) return;\n\n\t\t// Save focal point to image metadata\n\t\t(imageNode as any).metadata = {\n\t\t\t...(imageNode as any).metadata,\n\t\t\tfocalPoint: { ...focalPoint }\n\t\t};\n\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\n\texport function saveState() {}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- No UI needed, all controls in toolbar and grid overlay -->\n","/**\n * @file src/components/imageEditor/widgets/FocalPoint/index.ts\n * @description FocalPoint widget registration\n */\n\nimport type { EditorWidget } from '../registry';\nimport Tool from './Tool.svelte';\n\nexport const editorWidget: EditorWidget = {\n\tkey: 'focalpoint',\n\ttitle: 'Focal',\n\ticon: 'mdi:target',\n\n\ttool: Tool as unknown as import('svelte').Component<Record<string, unknown>>,\n\tcontrols: null as unknown as import('svelte').Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/RotateControls.svelte\n@component\nControls for the Rotate tool\n-->\n<script lang=\"ts\">\n\tlet {\n\t\trotationAngle,\n\t\tonRotateLeft,\n\t\tonRotateRight,\n\t\tonRotationChange,\n\t\tonFlipHorizontal,\n\t\tonFlipVertical,\n\t\tonReset,\n\t\tonApply\n\t}: {\n\t\trotationAngle: number;\n\t\tonRotateLeft: () => void;\n\t\tonRotateRight: () => void;\n\t\tonRotationChange: (angle: number) => void;\n\t\tonFlipHorizontal: () => void;\n\t\tonFlipVertical: () => void;\n\t\tonReset: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n\n\tfunction handleAngleInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tonRotationChange(parseInt(target.value, 10));\n\t}\n\n\t// Normalize angle to -180 to 180 for display\n\tconst displayAngle = $derived(() => {\n\t\tlet angle = rotationAngle % 360;\n\t\tif (angle > 180) angle -= 360;\n\t\tif (angle < -180) angle += 360;\n\t\treturn Math.round(angle);\n\t});\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<span class=\"text-sm font-medium\">Rotate & Flip Image</span>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Rotate Controls -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm\">Rotate:</span>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateLeft} title=\"Rotate Left 90\">\n\t\t\t<iconify-icon icon=\"mdi:rotate-left\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateRight} title=\"Rotate Right 90\">\n\t\t\t<iconify-icon icon=\"mdi:rotate-right\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Fine-tune Angle -->\n\t<label class=\"flex items-center gap-2 text-sm\">\n\t\t<span>Angle:</span>\n\t\t<input type=\"range\" min=\"-180\" max=\"180\" step=\"1\" value={rotationAngle} oninput={handleAngleInput} class=\"range range-primary w-32\" />\n\t\t<span class=\"w-12 text-right\">{displayAngle()}</span>\n\t</label>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Flip Controls -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm\">Flip:</span>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipHorizontal} title=\"Flip Horizontal\">\n\t\t\t<iconify-icon icon=\"mdi:flip-horizontal\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipVertical} title=\"Flip Vertical\">\n\t\t\t<iconify-icon icon=\"mdi:flip-vertical\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Actions -->\n\t<button onclick={onReset} class=\"btn preset-outlined-surface-500\">\n\t\t<iconify-icon icon=\"mdi:restore\"></iconify-icon>\n\t\t<span>Reset</span>\n\t</button>\n\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Apply</span>\n\t</button>\n</div>\n","<!--\n@file shared/image-editor/src/widgets/Rotate/Tool.svelte\n@component Rotate tool for rotating and flipping images\n\n-->\n<script lang=\"ts\">\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport RotateControls from './Controls.svelte';\n\n\tlet rotationAngle = $state(0);\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'rotate') {\n\t\t\t// Get current rotation when tool activates\n\t\t\tconst { imageGroup } = imageEditorStore.state;\n\t\t\tif (imageGroup) {\n\t\t\t\trotationAngle = imageGroup.rotation();\n\t\t\t}\n\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: RotateControls,\n\t\t\t\tprops: {\n\t\t\t\t\trotationAngle,\n\t\t\t\t\tonRotateLeft: rotateLeft,\n\t\t\t\t\tonRotateRight: rotateRight,\n\t\t\t\t\tonRotationChange: setRotation,\n\t\t\t\t\tonFlipHorizontal: flipHorizontal,\n\t\t\t\t\tonFlipVertical: flipVertical,\n\t\t\t\t\tonReset: reset,\n\t\t\t\t\tonApply: apply\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\t// Only clear controls if they are ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === RotateControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\tfunction rotateLeft() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation - 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\t\trotationAngle = newRotation;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateRight() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation + 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\t\trotationAngle = newRotation;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction setRotation(angle: number) {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.rotation(angle);\n\t\trotationAngle = angle;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipHorizontal() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleX(imageGroup.scaleX() * -1);\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipVertical() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleY(imageGroup.scaleY() * -1);\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction reset() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.rotation(0);\n\t\timageGroup.scaleX(Math.abs(imageGroup.scaleX()));\n\t\timageGroup.scaleY(Math.abs(imageGroup.scaleY()));\n\t\trotationAngle = 0;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\texport function cleanup() {\n\t\t/* no cleanup needed */\n\t}\n\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n/** * @file shared/image-editor/src/widgets/Rotate/Tool.svelte * @component **Rotate tool for rotating and flipping images** ### Features: - Rotates\nand flips images - Resets rotation and flips - Applies changes to the image */ // imageEditor/widgets/Rotate/Tool.svelte /** * @file\nsrc/components/imageEditor/widgets/Rotate/Tool.svelte * @component * Rotate tool for rotating and flipping images */\n<!-- No UI needed, all controls in toolbar -->\n","/**\n * @file src/components/imageEditor/widgets/Rotate/index.ts\n * @description Rotate widget registration\n */\nimport type { EditorWidget } from '../registry';\nimport Tool from './Tool.svelte';\nimport Controls from './Controls.svelte';\n\nconst widget = {\n\tkey: 'rotate',\n\ttitle: 'Rotate',\n\ticon: 'mdi:rotate-right',\n\ttool: Tool,\n\tcontrols: Controls\n};\n\nexport const editorWidget = widget as unknown as EditorWidget;\n\nexport default editorWidget;\n","<!--\n@file: shared/image-editor/src/widgets/Watermark/Controls.svelte\n@component\nControls for the Watermark tool. Allows adding, deleting, and positioning watermarks.\n-->\n<script lang=\"ts\">\n\tlet {\n\t\tonAddWatermark,\n\t\tonDeleteWatermark,\n\t\tonPositionChange,\n\t\thasSelection\n\t}: {\n\t\tonAddWatermark: () => void;\n\t\tonDeleteWatermark: () => void;\n\t\tonPositionChange: (position: string) => void;\n\t\thasSelection: boolean;\n\t} = $props();\n\n\tconst positions = [\n\t\t{ value: 'top-left', icon: 'mdi:align-vertical-top' },\n\t\t{ value: 'top-center', icon: 'mdi:align-vertical-center' },\n\t\t{ value: 'top-right', icon: 'mdi:align-vertical-top' },\n\t\t{ value: 'center-left', icon: 'mdi:align-horizontal-left' },\n\t\t{ value: 'center', icon: 'mdi:align-horizontal-center' },\n\t\t{ value: 'center-right', icon: 'mdi:align-horizontal-right' },\n\t\t{ value: 'bottom-left', icon: 'mdi:align-vertical-bottom' },\n\t\t{ value: 'bottom-center', icon: 'mdi:align-vertical-center' },\n\t\t{ value: 'bottom-right', icon: 'mdi:align-vertical-bottom' }\n\t];\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<button onclick={onAddWatermark} class=\"btn preset-outlined-surface-500\">\n\t\t<iconify-icon icon=\"mdi:plus-box-outline\"></iconify-icon>\n\t\t<span>Add Watermark</span>\n\t</button>\n\n\t{#if hasSelection}\n\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t<span class=\"text-sm\">Position:</span>\n\t\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t\t{#each positions as pos}\n\t\t\t\t<button class=\"btn-sm\" onclick={() => onPositionChange(pos.value)} title={pos.value}>\n\t\t\t\t\t<iconify-icon icon={pos.icon}></iconify-icon>\n\t\t\t\t</button>\n\t\t\t{/each}\n\t\t</div>\n\n\t\t<div class=\"grow\"></div>\n\n\t\t<button onclick={onDeleteWatermark} class=\"btn preset-outlined-error-500\">\n\t\t\t<iconify-icon icon=\"mdi:delete-outline\"></iconify-icon>\n\t\t\t<span>Delete</span>\n\t\t</button>\n\t{/if}\n</div>\n","/**\n * @file shared/image-editor/src/widgets/Watermark/regions.ts\n * @description Regions for Watermark tool\n *\n * ### Features:\n * - WatermarkItem encapsulates a Konva.Image node, its transformer,\n * and the async logic to load an image from a File.\n */\n\nimport Konva from 'konva';\n\nexport class WatermarkItem {\n\tid: string;\n\tnode: Konva.Image;\n\tlayer: Konva.Layer;\n\timageGroup: Konva.Group;\n\tprivate objectUrl: string | null = null; // To revoke on destroy\n\n\tprivate _onSelect: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\n\tconstructor(opts: { id: string; layer: Konva.Layer; imageGroup: Konva.Group }) {\n\t\tthis.id = opts.id;\n\t\tthis.layer = opts.layer;\n\t\tthis.imageGroup = opts.imageGroup;\n\n\t\t// Create an empty Konva.Image node as a placeholder\n\t\tthis.node = new Konva.Image({\n\t\t\timage: undefined,\n\t\t\tdraggable: true,\n\t\t\tname: 'watermark'\n\t\t});\n\t\tthis.layer.add(this.node);\n\t\tthis.node.zIndex(5); // Watermarks go on top of annotations\n\n\t\t// Attach selection handler\n\t\tthis.node.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onSelect?.();\n\t\t});\n\t}\n\n\t/**\n\t * Asynchronously loads an image from a File object into the\n\t * Konva.Image node.\n\t */\n\tloadImage(file: File, options: { opacity: number; stageWidth: number; stageHeight: number }): Promise<void> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.objectUrl = URL.createObjectURL(file);\n\t\t\tconst img = new Image();\n\t\t\timg.onload = () => {\n\t\t\t\t// Calculate initial size (e.g., 20% of stage width)\n\t\t\t\tconst scale = (options.stageWidth * 0.2) / img.width;\n\t\t\t\tconst w = img.width * scale;\n\t\t\t\tconst h = img.height * scale;\n\n\t\t\t\t// Position in center\n\t\t\t\tconst x = options.stageWidth / 2 - w / 2;\n\t\t\t\tconst y = options.stageHeight / 2 - h / 2;\n\n\t\t\t\tthis.node.setAttrs({\n\t\t\t\t\timage: img,\n\t\t\t\t\tx: x,\n\t\t\t\t\ty: y,\n\t\t\t\t\twidth: w,\n\t\t\t\t\theight: h,\n\t\t\t\t\topacity: options.opacity\n\t\t\t\t});\n\n\t\t\t\tthis.layer.batchDraw();\n\t\t\t\tresolve();\n\t\t\t};\n\t\t\timg.onerror = (err) => {\n\t\t\t\treject(err);\n\t\t\t};\n\t\t\timg.src = this.objectUrl;\n\t\t});\n\t}\n\n\tsetOpacity(opacity: number) {\n\t\tthis.node.opacity(opacity);\n\t\tthis.layer.batchDraw();\n\t}\n\n\t/**\n\t * Snaps the watermark to a predefined position.\n\t * (tl, tc, tr, cl, c, cr, bl, bc, br)\n\t */\n\tsnapTo(position: string) {\n\t\tconst stage = this.layer.getStage();\n\t\tconst imageRect = this.imageGroup.getClientRect();\n\t\tconst nodeBox = this.node.getClientRect();\n\n\t\tconst padding = 10; // 10px padding from edge\n\n\t\tlet x: number, y: number;\n\n\t\t// Y-position\n\t\tif (position.startsWith('t')) {\n\t\t\ty = imageRect.y + padding;\n\t\t} else if (position.startsWith('c')) {\n\t\t\ty = imageRect.y + imageRect.height / 2 - nodeBox.height / 2;\n\t\t} else {\n\t\t\t// 'b'\n\t\t\ty = imageRect.y + imageRect.height - nodeBox.height - padding;\n\t\t}\n\n\t\t// X-position\n\t\tif (position.endsWith('l')) {\n\t\t\tx = imageRect.x + padding;\n\t\t} else if (position.endsWith('c')) {\n\t\t\tx = imageRect.x + imageRect.width / 2 - nodeBox.width / 2;\n\t\t} else {\n\t\t\t// 'r'\n\t\t\tx = imageRect.x + imageRect.width - nodeBox.width - padding;\n\t\t}\n\n\t\t// Need to account for stage transform\n\t\tconst stageAbs = stage.getAbsoluteTransform().copy().invert();\n\t\tconst finalPos = stageAbs.point({ x, y });\n\n\t\tthis.node.position(finalPos);\n\t\tthis.layer.batchDraw();\n\t}\n\n\tdisableInteraction() {\n\t\tthis.node.draggable(false);\n\t}\n\n\tdestroy() {\n\t\tthis.node.off('click tap');\n\t\tthis.node.destroy();\n\t\tif (this.objectUrl) {\n\t\t\tURL.revokeObjectURL(this.objectUrl);\n\t\t}\n\t\tthis._onDestroy?.();\n\t}\n\n\t// --- Event Callbacks ---\n\tonSelect(cb: () => void) {\n\t\tthis._onSelect = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n}\n","<!--\n@file: shared/image-editor/src/widgets/Watermark/Tool.svelte\n@component\n**Watermark Tool \"Controller\"**\n\nOrchestrates the watermark lifecycle:\n- Manages the $state list of WatermarkItem instances\n- Handles selection and transformer\n- Registers the toolbar UI\n- Implements the 'apply' (bake) logic\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { getContext } from 'svelte';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport WatermarkControls from './Controls.svelte';\n\timport { WatermarkItem } from './regions';\n\timport { createStyledTransformer, attachStyledTransformer } from '../transformerConfig';\n\timport type { WatermarkOptions } from '@shared/utils/media/mediaModels';\n\n\t// --- Svelte 5 State ---\n\tlet watermarks: WatermarkItem[] = $state([]);\n\tlet selected: WatermarkItem | null = $state(null);\n\tlet transformer: Konva.Transformer | null = $state(null);\n\tlet opacity = $state(0.8);\n\tlet fileInput: HTMLInputElement;\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\t// guard to prevent loading preset multiple times\n\tlet _presetLoaded = $state(false);\n\n\t// Get watermark preset from parent context (set by ImageEditorModal)\n\tconst getWatermarkPreset = getContext<(() => WatermarkOptions | null) | undefined>('watermarkPreset');\n\n\t// --- Lifecycle $effect ---\n\t// Binds/unbounds the tool and registers the toolbar\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'watermark') {\n\t\t\tbindTool();\n\n\t\t\t// Auto-load preset watermark if available and not already loaded\n\t\t\tconst preset = getWatermarkPreset?.();\n\t\t\tif (preset?.url && watermarks.length === 0 && !_presetLoaded) {\n\t\t\t\t_presetLoaded = true;\n\t\t\t\tloadPresetWatermark(preset);\n\t\t\t}\n\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: WatermarkControls,\n\t\t\t\tprops: {\n\t\t\t\t\thasSelection: !!selected,\n\t\t\t\t\tonAddWatermark: () => fileInput?.click(),\n\t\t\t\t\tonDeleteWatermark: () => deleteSelected(),\n\t\t\t\t\tonPositionChange: (position: string) => selected?.snapTo(position),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\t_presetLoaded = false; // Reset for next activation\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === WatermarkControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\tif (!transformer) {\n\t\t\ttransformer = createStyledTransformer(layer);\n\t\t}\n\t\tstage.on('click.watermark tap.watermark', onStageClick);\n\t\tstage.container().style.cursor = 'default';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off('click.watermark tap.watermark');\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\tdeselect();\n\t}\n\n\t// --- Event Handlers ---\n\tfunction onStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\t// Deselect if clicking on stage background\n\t\tif (e.target === e.target.getStage()) {\n\t\t\tdeselect();\n\t\t}\n\t}\n\n\t// --- Preset Watermark Loading ---\n\tasync function loadPresetWatermark(preset: WatermarkOptions) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\ttry {\n\t\t\t// Fetch the watermark image from the preset URL\n\t\t\tconst response = await fetch(preset.url);\n\t\t\tif (!response.ok) {\n\t\t\t\tconsole.warn('Failed to fetch preset watermark:', preset.url);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst blob = await response.blob();\n\t\t\tconst filename = preset.url.split('/').pop() || 'preset-watermark.png';\n\t\t\tconst file = new File([blob], filename, { type: blob.type || 'image/png' });\n\n\t\t\tconst item = new WatermarkItem({\n\t\t\t\tid: crypto.randomUUID(),\n\t\t\t\tlayer,\n\t\t\t\timageGroup\n\t\t\t});\n\n\t\t\titem.onSelect(() => select(item));\n\t\t\titem.onDestroy(() => {\n\t\t\t\twatermarks = watermarks.filter((w) => w.id !== item.id);\n\t\t\t\tif (selected?.id === item.id) deselect();\n\t\t\t});\n\n\t\t\twatermarks = [...watermarks, item];\n\t\t\tselect(item);\n\n\t\t\t// Load with preset opacity (convert percentage scale to 0-1 if needed)\n\t\t\tconst presetOpacity = typeof preset.scale === 'number' && preset.scale > 1 ? preset.scale / 100 : (preset.scale ?? 0.8);\n\n\t\t\tawait item.loadImage(file, {\n\t\t\t\topacity: presetOpacity,\n\t\t\t\tstageWidth: stage.width(),\n\t\t\t\tstageHeight: stage.height()\n\t\t\t});\n\n\t\t\t// Apply preset position if specified\n\t\t\tif (preset.position) {\n\t\t\t\titem.snapTo(preset.position);\n\t\t\t}\n\n\t\t\tattachStyledTransformer(transformer!, item.node);\n\t\t\tlayer.batchDraw();\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to load preset watermark', err);\n\t\t}\n\t}\n\n\t// --- Watermark Lifecycle ---\n\tasync function addWatermark(file: File) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\tconst item = new WatermarkItem({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageGroup\n\t\t});\n\n\t\titem.onSelect(() => select(item));\n\t\titem.onDestroy(() => {\n\t\t\twatermarks = watermarks.filter((w) => w.id !== item.id);\n\t\t\tif (selected?.id === item.id) deselect();\n\t\t});\n\n\t\twatermarks = [...watermarks, item];\n\t\tselect(item);\n\n\t\ttry {\n\t\t\t// Asynchronously load the image file\n\t\t\tawait item.loadImage(file, {\n\t\t\t\topacity: opacity,\n\t\t\t\tstageWidth: stage.width(),\n\t\t\t\tstageHeight: stage.height()\n\t\t\t});\n\t\t\t// Attach transformer *after* image is loaded and sized\n\t\t\tattachStyledTransformer(transformer!, item.node);\n\t\t\tlayer.batchDraw();\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to load watermark image', err);\n\t\t\titem.destroy(); // Clean up if load fails\n\t\t}\n\t}\n\n\tfunction select(item: WatermarkItem) {\n\t\tselected = item;\n\t\tif (!transformer) return;\n\t\tattachStyledTransformer(transformer, item.node);\n\t\t// Update controls to match selected item's opacity\n\t\topacity = item.node.opacity();\n\t}\n\n\tfunction deselect() {\n\t\tselected = null;\n\t\tif (!transformer) return;\n\t\tattachStyledTransformer(transformer, null);\n\t}\n\n\tfunction deleteSelected() {\n\t\tif (!selected) return;\n\t\tselected.destroy();\n\t\t// State update is handled by the 'onDestroy' callback\n\t}\n\n\tfunction cleanupWatermarks(destroy = true) {\n\t\tdeselect();\n\t\tif (destroy) {\n\t\t\t[...watermarks].forEach((w) => w.destroy());\n\t\t\twatermarks = [];\n\t\t} else {\n\t\t\t// Hide UI for baking\n\t\t\twatermarks.forEach((w) => w.disableInteraction());\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\tfunction handleFileChange(e: Event) {\n\t\tconst target = e.target as HTMLInputElement;\n\t\tif (target.files && target.files.length > 0) {\n\t\t\taddWatermark(target.files[0]);\n\t\t}\n\t\t// Reset input so the same file can be chosen again\n\t\ttarget.value = '';\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t\tcleanupWatermarks(true);\n\t\t\ttransformer?.destroy();\n\t\t\ttransformer = null;\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<input type=\"file\" accept=\"image/png, image/svg+xml\" class=\"hidden\" bind:this={fileInput} onchange={handleFileChange} />\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file shared/image-editor/src/widgets/Watermark/index.ts\n * @description Registers the Watermark tool and its controls.\n *\n * ### Features:\n * - Registers the Watermark tool and its controls.\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'watermark',\n\ttitle: 'Watermark',\n\ticon: 'mdi:copyright',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","/**\n * @file shared/image-editor/src/widgets/registry.ts\n * @description Dynamic widgets registry using import.meta.glob for discoverability\n *\n * Features:\n * - Dynamic widgets registry using import.meta.glob for discoverability\n */\nimport type { Component } from 'svelte';\n\nexport interface EditorWidget {\n\tkey: string;\n\ttitle: string;\n\ticon?: string;\n\ttool: Component<Record<string, unknown>>;\n\tcontrols?: Component<Record<string, unknown>>; // Optional: widgets register controls dynamically via imageEditorStore\n}\n\n// Load all widgets declared under ./<Widget>/index.ts (PascalCase folders only)\nconst modules = import.meta.glob('./[A-Z]*/index.ts', { eager: true }) as Record<string, unknown>;\n\nexport const editorWidgets: EditorWidget[] = Object.values(modules)\n\t.map((m) => {\n\t\tconst mod = m as { default?: EditorWidget; editorWidget?: EditorWidget };\n\t\treturn mod.default ?? mod.editorWidget;\n\t})\n\t.filter((w): w is EditorWidget => !!w);\n","<!--\n@file: shared/image-editor/src/EditorSidebar.svelte\n@component\n**Left sidebar with vertical tool layout**\nProvides easy access to all editing tools with clean, minimal design\nand proper active state indication.\n\n#### Props\n- `activeState`: Currently active tool state\n- `onToolSelect`: Function called when a tool is selected\n- `hasImage`: Whether an image is loaded for conditional tool availability\n-->\n\n<script lang=\"ts\">\n\t// Props\n\tconst {\n\t\tactiveState,\n\t\tonToolSelect,\n\t\thasImage = false\n\t}: {\n\t\tactiveState: string;\n\t\tonToolSelect: (tool: string) => void;\n\t\thasImage?: boolean;\n\t} = $props();\n\n\t// Drive tools from the widgets registry, with a focalpoint fallback\n\timport { editorWidgets, type EditorWidget } from './widgets/registry';\n\n\tconst tools = [...editorWidgets.map((w: EditorWidget) => ({ id: w.key, name: w.title, icon: w.icon ?? 'mdi:cog', description: '' }))];\n\n\tfunction handleToolClick(tool: any) {\n\t\tif (!hasImage) return;\n\t\tonToolSelect(tool.id);\n\t}\n\n\tfunction isToolActive(tool: any): boolean {\n\t\treturn activeState === tool.id;\n\t}\n</script>\n\n<div class=\"editor-sidebar flex w-20 flex-col border-r lg:w-24\">\n\t<div class=\"sidebar-tools flex flex-1 flex-col gap-1 p-1.5 lg:p-2 max-lg:gap-0.5 max-lg:p-1\">\n\t\t{#each tools as tool}\n\t\t\t<button\n\t\t\t\tclass=\"btn preset-filled-primary-500 group relative flex flex-col items-center justify-center gap-1 py-2\"\n\t\t\t\tclass:active={isToolActive(tool)}\n\t\t\t\tclass:disabled={!hasImage}\n\t\t\t\tclass:bg-primary-500={isToolActive(tool)}\n\t\t\t\tclass:text-white={isToolActive(tool)}\n\t\t\t\tclass:shadow-md={isToolActive(tool)}\n\t\t\t\tclass:hover:bg-primary-600={isToolActive(tool)}\n\t\t\t\tclass:cursor-not-allowed={!hasImage}\n\t\t\t\tclass:opacity-50={!hasImage}\n\t\t\t\tclass:bg-transparent={!hasImage}\n\t\t\t\tonclick={() => handleToolClick(tool)}\n\t\t\t\taria-label={tool.name}\n\t\t\t\tdisabled={!hasImage}\n\t\t\t>\n\t\t\t\t<div class=\"tool-icon flex items-center justify-center\">\n\t\t\t\t\t<iconify-icon icon={tool.icon} width=\"24\"></iconify-icon>\n\t\t\t\t</div>\n\t\t\t\t<span class=\"tool-label text-[10px] font-medium leading-none lg:text-xs\">{tool.name}</span>\n\n\t\t\t\t<!-- Tooltip -->\n\t\t\t\t<div\n\t\t\t\t\tclass=\"tooltip pointer-events-none absolute left-full top-1/2 z-50 ml-2 -translate-y-1/2 whitespace-nowrap rounded bg-surface-900 px-2 py-1 text-xs text-white opacity-0 transition-opacity duration-200 group-hover:opacity-100 dark:bg-surface-700 shadow-lg\"\n\t\t\t\t>\n\t\t\t\t\t<div class=\"font-medium\">{tool.name}</div>\n\t\t\t\t\t{#if tool.description}\n\t\t\t\t\t\t<div class=\"text-[10px] text-surface-300\">{tool.description}</div>\n\t\t\t\t\t{/if}\n\t\t\t\t\t<!-- Arrow -->\n\t\t\t\t\t<div class=\"absolute -left-1 top-1/2 -mt-1 h-2 w-2 -rotate-45 bg-surface-900 dark:bg-surface-700\"></div>\n\t\t\t\t</div>\n\n\t\t\t\t<!-- coming soon badge removed; driven by registry now -->\n\t\t\t</button>\n\t\t{/each}\n\t</div>\n\n\t<div class=\"sidebar-footer border-t p-2\">\n\t\t{#if !hasImage}\n\t\t\t<div class=\"no-image-hint flex flex-col items-center gap-1 p-2 text-center\">\n\t\t\t\t<iconify-icon icon=\"mdi:information-outline\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50\"> Upload an image to enable tools </span>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n</div>\n\n<style>\n\t.editor-sidebar {\n\t\tbackground-color: rgb(var(--color-surface-100) / 1);\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t\tmin-height: 100%;\n\t}\n\n\t:global(.dark) .editor-sidebar {\n\t\tbackground-color: rgb(var(--color-surface-800) / 1);\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n\n\t.sidebar-footer {\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t}\n\n\t:global(.dark) .sidebar-footer {\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/EditorCanvas.svelte\n@component\n**Responsive canvas wrapper for the Konva stage**\nHandles canvas sizing, empty states, and provides proper container\nfor the image editor canvas with responsive behavior.\n\n#### Props\n- `hasImage`: Whether an image is currently loaded\n- `containerRef`: Reference to bind the container element\n-->\n\n<script lang=\"ts\">\n\timport { fade } from 'svelte/transition';\n\timport type { Snippet } from 'svelte';\n\n\t// Props\n\tlet {\n\t\thasImage = false,\n\t\tisLoading = false,\n\t\tloadingMessage = 'Loading...',\n\t\tcontainerRef = $bindable(),\n\t\tchildren\n\t}: {\n\t\thasImage?: boolean;\n\t\tisLoading?: boolean;\n\t\tloadingMessage?: string;\n\t\tcontainerRef?: HTMLDivElement;\n\t\tchildren?: Snippet;\n\t} = $props();\n\n\tlet mounted = $state(false);\n\n\t$effect(() => {\n\t\tmounted = true;\n\t});\n</script>\n\n<div\n\tclass=\"editor-canvas-wrapper relative flex-1 overflow-hidden rounded-lg border border-surface-200 transition-all duration-300 ease-in-out focus-within:ring-2 focus-within:ring-primary-500 focus-within:ring-offset-2 focus-within:ring-offset-surface-50 dark:focus-within:ring-offset-surface-900 md:rounded-lg md:border md:border-surface-200 max-md:rounded-none max-md:border-0 max-md:border-b max-md:border-t\"\n>\n\t<!-- Canvas container - ALWAYS present for Konva stage -->\n\t<div class=\"canvas-container h-full w-full transition-all duration-300 ease-in-out\" bind:this={containerRef}>\n\t\t<!-- Konva stage will be mounted here by ImageEditor -->\n\t</div>\n\n\t<!-- Empty state overlay - shown when no image -->\n\t{#if !hasImage}\n\t\t<div class=\"empty-state pointer-events-none absolute inset-0 z-10 flex items-center justify-center\">\n\t\t\t<div class=\"empty-state-content flex max-w-md flex-col items-center gap-6 p-8 text-center max-md:p-6\">\n\t\t\t\t<div\n\t\t\t\t\tclass=\"empty-icon flex h-20 w-20 items-center justify-center rounded-full bg-surface-200 ring-4 ring-surface-300 dark:bg-surface-700 dark:ring-surface-600 max-md:h-16 max-md:w-16\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:image-plus\" width=\"48\" class=\"text-surface-400 dark:text-surface-500\"></iconify-icon>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"empty-text\">\n\t\t\t\t\t<h3 class=\"mb-2 text-lg font-medium text-surface-700 dark:text-surface-300 max-md:text-base\">No Image Selected</h3>\n\t\t\t\t\t<p class=\"text-sm text-surface-500 dark:text-surface-50 max-md:text-xs\">Upload an image to start editing</p>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"empty-hints flex flex-col gap-2\">\n\t\t\t\t\t<div class=\"hint-item flex items-center justify-center gap-2\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:gesture-tap\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50 max-md:text-[10px]\"> Drag & drop supported </span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"hint-item flex items-center justify-center gap-2\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:file-image\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50 max-md:text-[10px]\"> PNG, JPG, WebP, GIF </span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<!-- Slot for overlays (like crop toolbar) -->\n\t{@render children?.()}\n\n\t<!-- Loading overlay -->\n\t{#if (hasImage && !mounted) || isLoading}\n\t\t<div\n\t\t\tclass=\"loading-overlay absolute inset-0 flex flex-col items-center justify-center gap-3 bg-surface-50/80 backdrop-blur-sm dark:bg-surface-900/80 z-20\"\n\t\t\ttransition:fade={{ duration: 200 }}\n\t\t>\n\t\t\t<div class=\"loading-spinner flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-lg dark:bg-surface-800\">\n\t\t\t\t<iconify-icon icon=\"mdi:loading\" width=\"32\" class=\"animate-spin text-primary-500\"></iconify-icon>\n\t\t\t</div>\n\t\t\t<span class=\"text-sm text-surface-600 dark:text-surface-300\">{loadingMessage}</span>\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t.editor-canvas-wrapper {\n\t\tbackground-color: rgb(var(--color-surface-50) / 1);\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t\tmin-height: 400px;\n\t}\n\n\t:global(.dark) .editor-canvas-wrapper {\n\t\tbackground-color: rgb(var(--color-surface-900) / 1);\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n\n\t.canvas-container {\n\t\tbackground-color: rgb(var(--color-surface-100) / 1);\n\t\t/* Checkered pattern for transparency visualization */\n\t\tbackground-image:\n\t\t\tlinear-gradient(45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%), linear-gradient(-45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%),\n\t\t\tlinear-gradient(45deg, transparent 75%, rgba(0, 0, 0, 0.05) 75%), linear-gradient(-45deg, transparent 75%, rgba(0, 0, 0, 0.05) 75%);\n\t\tbackground-size: 20px 20px;\n\t\tbackground-position:\n\t\t\t0 0,\n\t\t\t0 10px,\n\t\t\t10px -10px,\n\t\t\t-10px 0px;\n\t}\n\n\t:global(.dark) .canvas-container {\n\t\tbackground-color: rgb(var(--color-surface-800) / 1);\n\t\tbackground-image:\n\t\t\tlinear-gradient(45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%), linear-gradient(-45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%),\n\t\t\tlinear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.03) 75%), linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.03) 75%);\n\t}\n\n\t.empty-state {\n\t\tbackground: linear-gradient(to bottom right, rgb(var(--color-surface-50) / 0.95), rgb(var(--color-surface-100) / 0.95));\n\t}\n\n\t:global(.dark) .empty-state {\n\t\tbackground: linear-gradient(to bottom right, rgb(var(--color-surface-900) / 1), rgb(var(--color-surface-800) / 1));\n\t}\n\n\t/* Responsive adjustments */\n\t@media (max-width: 768px) {\n\t\t.editor-canvas-wrapper {\n\t\t\tmin-height: 50vh;\n\t\t}\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/Editor.svelte\n@component\n**Enhanced Image Editor - Svelte 5 Optimized**\n\nComprehensive image editing interface with Konva.js integration.\n\n@example\n<Editor \n  initialImageSrc={image.url}\n  mediaId={image._id}\n  {onsave}\n  {oncancel}\n/>\n\n### Props\n- `imageFile` (File): Image file object\n- `initialImageSrc` (string): Initial image URL\n- `mediaId` (string): Media ID for saving\n- `focalPoint` (object): Initial focal point coordinates\n- `onsave` (function): Save callback\n- `oncancel` (function): Cancel callback\n\n### Features\n- Full Konva.js integration\n- Undo/redo support with history\n- Multiple editing tools (crop, filters, text, shapes)\n- Keyboard shortcuts\n- Responsive canvas\n- AVIF/WebP export\n- Accessibility compliant\n- Error boundaries\n-->\n\n<script lang=\"ts\">\n\timport { onMount, onDestroy } from 'svelte';\n\timport { logger } from '@shared/utils/logger';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\n\timport EditorSidebar from './EditorSidebar.svelte';\n\timport EditorCanvas from './EditorCanvas.svelte';\n\n\timport Konva from 'konva';\n\timport { editorWidgets } from './widgets/registry';\n\n\tinterface Props {\n\t\timageFile?: File | null;\n\t\tinitialImageSrc?: string;\n\t\tfocalPoint?: { x: number; y: number };\n\t\tonsave?: (detail: { dataURL: string; file: File }) => void;\n\t\toncancel?: () => void;\n\t}\n\n\tconst { imageFile = null, initialImageSrc = '', onsave = () => {}, oncancel = () => {} }: Props = $props();\n\n\t// State\n\tlet selectedImage = $state('');\n\tlet containerRef = $state<HTMLDivElement | undefined>(undefined);\n\tlet initialImageLoaded = $state(false);\n\tlet isProcessing = $state(false);\n\tlet error = $state<string | null>(null);\n\tlet preToolSnapshot = $state<string | null>(null);\n\n\t// Derived values\n\tconst storeState = imageEditorStore.state;\n\tconst activeState = $derived(imageEditorStore.state.activeState);\n\tconst hasImage = $derived(!!storeState.imageNode);\n\n\t// Active tool component\n\tconst activeToolComponent = $derived.by(() => {\n\t\tif (!activeState) return null;\n\n\t\tconst widget = editorWidgets.find((w) => w.key === activeState);\n\t\tif (widget?.tool) return widget.tool;\n\n\t\tif (activeState === 'focalpoint') return null; // Handled separately\n\n\t\tlogger.warn(`Tool not found for state: ${activeState}`);\n\t\treturn null;\n\t});\n\n\t// Cleanup effect for selected image\n\t$effect(() => {\n\t\treturn () => {\n\t\t\tif (selectedImage && selectedImage.startsWith('blob:')) {\n\t\t\t\tURL.revokeObjectURL(selectedImage);\n\t\t\t}\n\t\t};\n\t});\n\n\t// Load initial image effect\n\t$effect(() => {\n\t\tif (containerRef && !initialImageLoaded && (initialImageSrc || imageFile)) {\n\t\t\tif (initialImageSrc) {\n\t\t\t\tlogger.debug('Loading initial image from src:', initialImageSrc);\n\t\t\t\tselectedImage = initialImageSrc;\n\t\t\t\tloadImageAndSetupKonva(selectedImage);\n\t\t\t} else if (imageFile) {\n\t\t\t\tlogger.debug('Loading initial image from file');\n\t\t\t\tselectedImage = URL.createObjectURL(imageFile);\n\t\t\t\tloadImageAndSetupKonva(selectedImage, imageFile);\n\t\t\t}\n\t\t\tinitialImageLoaded = true;\n\t\t}\n\t});\n\n\t// Load image and setup Konva\n\tfunction loadImageAndSetupKonva(imageSrc: string, file?: File) {\n\t\tif (!containerRef) {\n\t\t\tlogger.error('Container ref not available');\n\t\t\terror = 'Container not ready';\n\t\t\treturn;\n\t\t}\n\n\t\tisProcessing = true;\n\t\terror = null;\n\n\t\tconst img = new Image();\n\n\t\t// Determine crossOrigin\n\t\ttry {\n\t\t\tconst currentOrigin = window.location.origin;\n\t\t\tconst imageOrigin = new URL(imageSrc, currentOrigin).origin;\n\n\t\t\tif (imageOrigin !== currentOrigin) {\n\t\t\t\timg.crossOrigin = 'anonymous';\n\t\t\t}\n\t\t\t// For same-origin (including local relative paths), we don't set crossOrigin\n\t\t\t// to ensure cookies/auth headers are sent if needed.\n\t\t} catch (e) {\n\t\t\t// Fallback for invalid URLs or other parsing errors\n\t\t\timg.crossOrigin = 'anonymous';\n\t\t}\n\n\t\timg.onerror = () => {\n\t\t\terror = 'Failed to load image';\n\t\t\tisProcessing = false;\n\t\t\tlogger.error('Image load error');\n\t\t};\n\n\t\timg.onload = () => {\n\t\t\ttry {\n\t\t\t\tconst containerWidth = containerRef!.clientWidth;\n\t\t\t\tconst containerHeight = containerRef!.clientHeight;\n\n\t\t\t\t// Clear existing stage\n\t\t\t\tconst existingStage = imageEditorStore.state.stage;\n\t\t\t\tif (existingStage) {\n\t\t\t\t\texistingStage.destroy();\n\t\t\t\t}\n\n\t\t\t\t// Create stage\n\t\t\t\tconst stage = new Konva.Stage({\n\t\t\t\t\tcontainer: containerRef!,\n\t\t\t\t\twidth: containerWidth,\n\t\t\t\t\theight: containerHeight\n\t\t\t\t});\n\n\t\t\t\tconst layer = new Konva.Layer();\n\t\t\t\tstage.add(layer);\n\n\t\t\t\t// Calculate scale\n\t\t\t\tconst scaleX = (containerWidth * 0.8) / img.width;\n\t\t\t\tconst scaleY = (containerHeight * 0.8) / img.height;\n\t\t\t\tconst scale = Math.min(scaleX, scaleY);\n\n\t\t\t\t// Create image node\n\t\t\t\tconst imageNode = new Konva.Image({\n\t\t\t\t\timage: img,\n\t\t\t\t\twidth: img.width,\n\t\t\t\t\theight: img.height,\n\t\t\t\t\tx: -img.width / 2,\n\t\t\t\t\ty: -img.height / 2\n\t\t\t\t});\n\n\t\t\t\t// Create group for transforms\n\t\t\t\tconst imageGroup = new Konva.Group({\n\t\t\t\t\tx: containerWidth / 2,\n\t\t\t\t\ty: containerHeight / 2,\n\t\t\t\t\tscaleX: scale,\n\t\t\t\t\tscaleY: scale\n\t\t\t\t});\n\n\t\t\t\timageGroup.add(imageNode);\n\t\t\t\tlayer.add(imageGroup);\n\t\t\t\tlayer.draw();\n\n\t\t\t\t// Update store\n\t\t\t\timageEditorStore.setStage(stage);\n\t\t\t\timageEditorStore.setLayer(layer);\n\t\t\t\timageEditorStore.setImageNode(imageNode);\n\t\t\t\timageEditorStore.setImageGroup(imageGroup);\n\n\t\t\t\tif (file) {\n\t\t\t\t\timageEditorStore.setFile(file);\n\t\t\t\t}\n\n\t\t\t\t// Initial snapshot\n\t\t\t\timageEditorStore.takeSnapshot();\n\n\t\t\t\tisProcessing = false;\n\t\t\t} catch (err) {\n\t\t\t\terror = 'Failed to setup editor';\n\t\t\t\tisProcessing = false;\n\t\t\t\tlogger.error('Konva setup error:', err);\n\t\t\t}\n\t\t};\n\n\t\timg.src = imageSrc;\n\t}\n\n\t// Handle resize\n\tfunction handleResize() {\n\t\tconst { stage, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !containerRef) return;\n\n\t\tconst containerWidth = containerRef.clientWidth;\n\t\tconst containerHeight = containerRef.clientHeight;\n\n\t\tstage.width(containerWidth);\n\t\tstage.height(containerHeight);\n\n\t\t// Recenter image\n\t\tif (imageGroup) {\n\t\t\timageGroup.position({\n\t\t\t\tx: containerWidth / 2,\n\t\t\t\ty: containerHeight / 2\n\t\t\t});\n\t\t}\n\n\t\tstage.batchDraw();\n\t}\n\n\t// Handle keyboard shortcuts\n\tfunction handleKeyDown(event: KeyboardEvent) {\n\t\t// Skip if typing in input\n\t\tconst target = event.target as HTMLElement;\n\t\tconst isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.contentEditable === 'true';\n\t\tif (isInput) return;\n\n\t\tconst cmdOrCtrl = event.metaKey || event.ctrlKey;\n\t\tconst shift = event.shiftKey;\n\n\t\t// Escape: Exit tool\n\t\tif (event.key === 'Escape') {\n\t\t\tconst currentState = imageEditorStore.state.activeState;\n\t\t\tif (currentState) {\n\t\t\t\timageEditorStore.saveToolState();\n\t\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\t\timageEditorStore.setActiveState('');\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// Ctrl/Cmd+Z: Undo\n\t\tif (cmdOrCtrl && !shift && event.key === 'z') {\n\t\t\tevent.preventDefault();\n\t\t\thandleUndo();\n\t\t\treturn;\n\t\t}\n\n\t\t// Ctrl/Cmd+Shift+Z: Redo\n\t\tif (cmdOrCtrl && shift && event.key === 'z') {\n\t\t\tevent.preventDefault();\n\t\t\thandleRedo();\n\t\t\treturn;\n\t\t}\n\n\t\t// Delete: Remove selected\n\t\tif (event.key === 'Delete') {\n\t\t\tconst currentState = imageEditorStore.state.activeState;\n\t\t\tif (currentState === 'textoverlay' || currentState === 'shapeoverlay') {\n\t\t\t\tconst deleteBtn = document.querySelector('.preset-filled-error-500.btn') as HTMLButtonElement;\n\t\t\t\tdeleteBtn?.click();\n\t\t\t}\n\t\t}\n\t}\n\n\t// Undo/Redo\n\texport function handleUndo() {\n\t\tif (!imageEditorStore.canUndoState) return;\n\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (currentState) {\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t}\n\n\t\tconst stateData = imageEditorStore.undoState();\n\t\tif (stateData) {\n\t\t\trestoreFromStateData(stateData);\n\t\t}\n\t}\n\n\texport function handleRedo() {\n\t\tif (!imageEditorStore.canRedoState) return;\n\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (currentState) {\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t}\n\n\t\tconst stateData = imageEditorStore.redoState();\n\t\tif (stateData) {\n\t\t\trestoreFromStateData(stateData);\n\t\t}\n\t}\n\n\t// Restore state\n\tfunction restoreFromStateData(stateData: string) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\ttry {\n\t\t\t// Deep cleanup before restoration\n\t\t\timageEditorStore.cleanupTempNodes();\n\n\t\t\tconst rawData = JSON.parse(stateData);\n\t\t\t// Support both legacy (pure stage JSON) and new format (snapshot object)\n\t\t\tconst isNewFormat = rawData.stage && rawData.activeState !== undefined;\n\t\t\tconst stateJSON = isNewFormat ? JSON.parse(rawData.stage) : rawData;\n\n\t\t\tif (isNewFormat) {\n\t\t\t\timageEditorStore.setActiveState(rawData.activeState);\n\t\t\t}\n\n\t\t\t// Clear filters to ensure a clean slate\n\t\t\timageNode.filters([]);\n\t\t\timageNode.clearCache();\n\n\t\t\t// The JSON structure is typically Stage -> Layer -> [Children]\n\t\t\t// We look for our expected hierarchy: imageGroup -> imageNode\n\t\t\tconst findImageGroupState = (nodes: any[]): any => {\n\t\t\t\tfor (const node of nodes) {\n\t\t\t\t\tif (node.className === 'Group' && node.children?.some((c: any) => c.className === 'Image')) {\n\t\t\t\t\t\treturn node;\n\t\t\t\t\t}\n\t\t\t\t\tif (node.children) {\n\t\t\t\t\t\tconst found = findImageGroupState(node.children);\n\t\t\t\t\t\tif (found) return found;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\n\t\t\tconst imageGroupState = findImageGroupState(stateJSON.children || []);\n\n\t\t\tif (imageGroupState && imageGroupState.attrs) {\n\t\t\t\t// Restore image group transforms\n\t\t\t\timageGroup.setAttrs({\n\t\t\t\t\tx: imageGroupState.attrs.x ?? stage.width() / 2,\n\t\t\t\t\ty: imageGroupState.attrs.y ?? stage.height() / 2,\n\t\t\t\t\tscaleX: imageGroupState.attrs.scaleX ?? 1,\n\t\t\t\t\tscaleY: imageGroupState.attrs.scaleY ?? 1,\n\t\t\t\t\trotation: imageGroupState.attrs.rotation ?? 0\n\t\t\t\t});\n\n\t\t\t\tconst imageNodeState = imageGroupState.children.find((c: any) => c.className === 'Image');\n\t\t\t\tif (imageNodeState && imageNodeState.attrs) {\n\t\t\t\t\t// Restore image node properties\n\t\t\t\t\timageNode.setAttrs({\n\t\t\t\t\t\tcropX: imageNodeState.attrs.cropX,\n\t\t\t\t\t\tcropY: imageNodeState.attrs.cropY,\n\t\t\t\t\t\tcropWidth: imageNodeState.attrs.cropWidth,\n\t\t\t\t\t\tcropHeight: imageNodeState.attrs.cropHeight,\n\t\t\t\t\t\twidth: imageNodeState.attrs.width,\n\t\t\t\t\t\theight: imageNodeState.attrs.height,\n\t\t\t\t\t\tx: imageNodeState.attrs.x,\n\t\t\t\t\t\ty: imageNodeState.attrs.y,\n\t\t\t\t\t\tcornerRadius: imageNodeState.attrs.cornerRadius ?? 0\n\t\t\t\t\t} as any);\n\n\t\t\t\t\t// Restore Filters\n\t\t\t\t\tif (imageNodeState.attrs.filters?.length > 0) {\n\t\t\t\t\t\t// Convert filter names to actual Konva filter functions if needed\n\t\t\t\t\t\t// but usually Konva restores them if registered.\n\t\t\t\t\t\t// To be safe, we re-apply based on attrs\n\t\t\t\t\t\tconst activeFilters = [];\n\t\t\t\t\t\tif (imageNodeState.attrs.brightness !== undefined) activeFilters.push(Konva.Filters.Brighten);\n\t\t\t\t\t\tif (imageNodeState.attrs.contrast !== undefined) activeFilters.push(Konva.Filters.Contrast);\n\t\t\t\t\t\tif (imageNodeState.attrs.saturation !== undefined || imageNodeState.attrs.luminance !== undefined) activeFilters.push(Konva.Filters.HSL);\n\n\t\t\t\t\t\timageNode.filters(activeFilters);\n\t\t\t\t\t\timageNode.setAttrs(imageNodeState.attrs);\n\t\t\t\t\t\timageNode.cache();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlayer.batchDraw();\n\t\t\tstage.batchDraw();\n\t\t} catch (err) {\n\t\t\tlogger.error('Failed to restore state:', err);\n\t\t\terror = 'Failed to restore state';\n\t\t}\n\t}\n\n\t// Save\n\texport async function handleSave() {\n\t\tconst { stage, file } = imageEditorStore.state;\n\t\tif (!stage || !file) {\n\t\t\terror = 'Nothing to save';\n\t\t\treturn;\n\t\t}\n\n\t\tisProcessing = true;\n\t\terror = null;\n\n\t\ttry {\n\t\t\t// CRITICAL: Hide all UI elements before taking the snapshot\n\t\t\t// to avoid baking handles/toolbars into the image.\n\t\t\timageEditorStore.hideAllUI();\n\n\t\t\tlet dataURL: string;\n\t\t\tlet mimeType: string;\n\t\t\tlet fileExtension: string;\n\n\t\t\t// Try AVIF first, fallback to WebP\n\t\t\ttry {\n\t\t\t\tdataURL = stage.toDataURL({\n\t\t\t\t\tmimeType: 'image/avif',\n\t\t\t\t\tquality: 0.85,\n\t\t\t\t\tpixelRatio: 1\n\t\t\t\t});\n\n\t\t\t\tif (dataURL.startsWith('data:image/avif')) {\n\t\t\t\t\tmimeType = 'image/avif';\n\t\t\t\t\tfileExtension = 'avif';\n\t\t\t\t\tlogger.debug('Using AVIF format');\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error('AVIF not supported');\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\tlogger.warn('AVIF not supported, using WebP');\n\t\t\t\tdataURL = stage.toDataURL({\n\t\t\t\t\tmimeType: 'image/webp',\n\t\t\t\t\tquality: 0.95,\n\t\t\t\t\tpixelRatio: 1\n\t\t\t\t});\n\t\t\t\tmimeType = 'image/webp';\n\t\t\t\tfileExtension = 'webp';\n\t\t\t}\n\n\t\t\tconst response = await fetch(dataURL);\n\t\t\tconst blob = await response.blob();\n\n\t\t\tconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n\t\t\tconst newFileName = `edited-${timestamp}.${fileExtension}`;\n\t\t\tconst editedFile = new File([blob], newFileName, { type: mimeType });\n\n\t\t\tonsave({ dataURL, file: editedFile });\n\t\t} catch (err) {\n\t\t\tlogger.error('Save error:', err);\n\t\t\terror = 'Failed to save image';\n\t\t} finally {\n\t\t\tisProcessing = false;\n\t\t}\n\t}\n\n\t// Cancel\n\texport function handleCancel() {\n\t\toncancel();\n\t}\n\n\t// Toggle tool\n\tfunction toggleTool(tool: string) {\n\t\tconst currentState = imageEditorStore.state.activeState;\n\n\t\tif (currentState && currentState !== tool) {\n\t\t\timageEditorStore.saveToolState();\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\n\t\t\t// Recenter if drifted\n\t\t\tconst { stage, imageGroup } = imageEditorStore.state;\n\t\t\tif (stage && imageGroup) {\n\t\t\t\tconst expectedX = stage.width() / 2;\n\t\t\t\tconst expectedY = stage.height() / 2;\n\t\t\t\tconst currentX = imageGroup.x();\n\t\t\t\tconst currentY = imageGroup.y();\n\n\t\t\t\tif (Math.abs(currentX - expectedX) > 5 || Math.abs(currentY - expectedY) > 5) {\n\t\t\t\t\timageGroup.position({ x: expectedX, y: expectedY });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst newState = currentState === tool ? '' : tool;\n\n\t\t// Capture snapshot before entering a new tool for 'Cancel' functionality\n\t\tif (newState !== '' && newState !== currentState) {\n\t\t\tpreToolSnapshot = imageEditorStore.undoState(true); // Get current state without undoing\n\t\t}\n\n\t\timageEditorStore.setActiveState(newState);\n\n\t\tif (newState === '') {\n\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\tpreToolSnapshot = null;\n\t\t}\n\t}\n\n\t// Cancel tool (Discard changes)\n\texport function handleCancelTool() {\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (!currentState) return;\n\n\t\tif (preToolSnapshot) {\n\t\t\trestoreFromStateData(preToolSnapshot);\n\t\t\t// Also clear history forward if needed? No, undoState(true) just returns top.\n\t\t}\n\n\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\timageEditorStore.setActiveState('');\n\t\timageEditorStore.setToolbarControls(null);\n\t\tpreToolSnapshot = null;\n\t}\n\n\t// Lifecycle\n\tonMount(() => {\n\t\timageEditorStore.reset();\n\t\twindow.addEventListener('resize', handleResize);\n\t\twindow.addEventListener('keydown', handleKeyDown);\n\n\t\treturn () => {\n\t\t\twindow.removeEventListener('resize', handleResize);\n\t\t\twindow.removeEventListener('keydown', handleKeyDown);\n\t\t\timageEditorStore.cleanupTempNodes();\n\t\t\timageEditorStore.reset();\n\t\t};\n\t});\n\n\tonDestroy(() => {\n\t\tif (selectedImage && selectedImage.startsWith('blob:')) {\n\t\t\tURL.revokeObjectURL(selectedImage);\n\t\t}\n\t});\n</script>\n\n<div class=\"image-editor flex h-full w-full flex-col overflow-hidden\" role=\"application\" aria-label=\"Image editor\" aria-busy={isProcessing}>\n\t{#if error}\n\t\t<div class=\"error-banner bg-error-50 border-l-4 border-error-500 p-4 text-error-700 dark:bg-error-900/20 dark:text-error-300\" role=\"alert\">\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<iconify-icon icon=\"mdi:alert-circle\" width=\"20\"></iconify-icon>\n\t\t\t\t<span>{error}</span>\n\t\t\t\t<button onclick={() => (error = null)} class=\"ml-auto text-error-600 hover:text-error-800\" aria-label=\"Dismiss error\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"18\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<div class=\"editor-layout flex h-full overflow-hidden\">\n\t\t<EditorSidebar activeState={activeState ?? ''} onToolSelect={toggleTool} {hasImage} />\n\n\t\t<div class=\"editor-main flex min-w-0 flex-1 flex-col\">\n\t\t\t<div class=\"canvas-wrapper relative flex flex-1 flex-col\">\n\t\t\t\t<EditorCanvas bind:containerRef {hasImage}>\n\t\t\t\t\t{#if storeState.stage && storeState.layer && storeState.imageNode && storeState.imageGroup}\n\t\t\t\t\t\t{#if activeToolComponent}\n\t\t\t\t\t\t\t{@const Component = activeToolComponent}\n\t\t\t\t\t\t\t<Component onCancel={handleCancelTool} />\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t{/if}\n\t\t\t\t</EditorCanvas>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n\n<style>\n\t:global(.crop-bottom-bar) {\n\t\tposition: absolute;\n\t\tbottom: 1rem;\n\t\tleft: 50%;\n\t\ttransform: translateX(-50%);\n\t\tz-index: 10;\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/EditorToolbar.svelte\n@component\nThe new single, intelligent bottom toolbar for the image editor.\nIt dynamically renders controls based on the active tool.\n-->\n<script lang=\"ts\">\n\timport { fade } from 'svelte/transition';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\n\tconst toolbarControls = $derived(imageEditorStore.state.toolbarControls);\n</script>\n\n<div class=\"border-t border-surface-300 bg-surface-100 p-2 shadow-lg dark:text-surface-50 dark:bg-surface-800\">\n\t<div class=\"mx-auto flex h-16 max-w-7xl items-center gap-4 px-4\">\n\t\t<!-- Tool-Specific Controls (Dynamic) -->\n\t\t<div class=\"flex h-full flex-1 items-center gap-3\">\n\t\t\t{#if toolbarControls?.component}\n\t\t\t\t{@const Component = toolbarControls.component}\n\t\t\t\t{#if Component}\n\t\t\t\t\t<Component {...toolbarControls.props} />\n\t\t\t\t{/if}\n\t\t\t{/if}\n\t\t</div>\n\t</div>\n\n\t<!-- Validation Error Banner -->\n\t{#if imageEditorStore.state.error}\n\t\t<div\n\t\t\tclass=\"absolute bottom-full left-0 right-0 flex items-center justify-center bg-error-500 py-1 text-xs font-medium text-white\"\n\t\t\ttransition:fade={{ duration: 200 }}\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:alert-circle\" width=\"14\" class=\"mr-1\"></iconify-icon>\n\t\t\t{imageEditorStore.state.error}\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t:global(.dark) .border-t {\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n</style>\n","<!--\n@file: shared/image-editor/src/ImageEditorModal.svelte\n@component\nA reusable modal that wraps the main Image Editor.\n-->\n<script lang=\"ts\">\n\timport type { MediaImage, WatermarkOptions } from '@shared/utils/media/mediaModels';\n\timport { setContext } from 'svelte';\n\timport Editor from './Editor.svelte';\n\timport EditorToolbar from './EditorToolbar.svelte';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport { editorWidgets } from './widgets/registry';\n\n\tlet {\n\t\timage = null,\n\t\twatermarkPreset = null,\n\t\tonsave = () => {},\n\t\tclose = () => {}\n\t}: {\n\t\timage: MediaImage | null;\n\t\t/** Optional watermark preset to auto-apply when editing */\n\t\twatermarkPreset?: WatermarkOptions | null;\n\t\tonsave?: (detail: any) => void;\n\t\tclose?: () => void;\n\t} = $props();\n\n\t// Provide watermark preset to child widgets via context\n\tsetContext('watermarkPreset', () => watermarkPreset);\n\n\tlet editorComponent: Editor | undefined = $state();\n\n\tconst activeState = $derived(imageEditorStore.state.activeState);\n\tconst activeWidget = $derived(editorWidgets.find((w: any) => w.key === activeState));\n\n\t// For Fine-Tune, we want to show the specific adjustment (e.g. contrast)\n\t// We'll peek into the toolbar props if available\n\tconst subInfo = $derived.by(() => {\n\t\tif (activeState === 'finetune') {\n\t\t\tconst props = imageEditorStore.state.toolbarControls?.props;\n\t\t\tif (props?.activeAdjustment) {\n\t\t\t\t// Capitalize first letter\n\t\t\t\tconst adj = props.activeAdjustment;\n\t\t\t\treturn {\n\t\t\t\t\tlabel: adj.charAt(0).toUpperCase() + adj.slice(1),\n\t\t\t\t\ticon: props.activeIcon\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t});\n\n\tfunction handleClose() {\n\t\tif (imageEditorStore.canUndoState) {\n\t\t\tif (!confirm('You have unsaved changes. Are you sure you want to close?')) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tclose();\n\t}\n\n\tfunction handleCancelClick() {\n\t\t// If a tool is active, exit the tool first\n\t\tif (activeState) {\n\t\t\timageEditorStore.cleanupToolSpecific(activeState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t} else {\n\t\t\t// No tool active, ask for confirmation if dirty\n\t\t\tif (imageEditorStore.canUndoState) {\n\t\t\t\tif (!confirm('You have unsaved changes. Are you sure you want to discard them?')) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\thandleClose();\n\t\t}\n\t}\n</script>\n\n{#if image}\n\t<div class=\"relative flex h-full min-h-[500px] w-full flex-col overflow-hidden bg-surface-100 shadow-xl dark:bg-surface-800\">\n\t\t<header\n\t\t\tclass=\"flex items-center justify-between border-b border-surface-300 p-3 lg:p-4 dark:text-surface-50 bg-surface-100/80 dark:bg-surface-800/80 sticky top-0 z-10\"\n\t\t>\n\t\t\t<div class=\"flex items-center gap-3 overflow-hidden\">\n\t\t\t\t{#if activeWidget}\n\t\t\t\t\t<div class=\"flex items-center gap-2 text-primary-500 shrink-0\">\n\t\t\t\t\t\t<iconify-icon icon={activeWidget.icon} width=\"24\" class=\"max-sm:width-[20px]\"></iconify-icon>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"flex flex-col min-w-0\">\n\t\t\t\t\t\t<h2 id=\"image-editor-title\" class=\"text-sm lg:text-lg font-bold truncate leading-tight flex items-center gap-1.5\">\n\t\t\t\t\t\t\t<span class=\"max-sm:hidden\">{activeWidget.title}</span>\n\t\t\t\t\t\t\t{#if subInfo}\n\t\t\t\t\t\t\t\t<span class=\"max-sm:hidden text-surface-400\">:</span>\n\t\t\t\t\t\t\t\t<span class=\"flex items-center gap-1 text-primary-600 dark:text-primary-400 font-extrabold\">\n\t\t\t\t\t\t\t\t\t{#if subInfo.icon}\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon={subInfo.icon} width=\"16\" class=\"lg:width-[20px]\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t<span>{subInfo.label}</span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t<span class=\"sm:hidden\">{activeWidget.title}</span>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t</div>\n\t\t\t\t{:else}\n\t\t\t\t\t<h2 id=\"image-editor-title\" class=\"text-tertiary-500 dark:text-primary-400 text-lg font-semibold shrink-0\">Image Editor</h2>\n\t\t\t\t{/if}\n\t\t\t</div>\n\n\t\t\t<!-- Global Actions -->\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => editorComponent?.handleUndo()}\n\t\t\t\t\tdisabled={!imageEditorStore.canUndoState}\n\t\t\t\t\tclass=\"btn-icon preset-outlined-surface-500\"\n\t\t\t\t\ttitle=\"Undo (Ctrl+Z)\"\n\t\t\t\t\taria-label=\"Undo\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:undo\" width=\"20\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => editorComponent?.handleRedo()}\n\t\t\t\t\tdisabled={!imageEditorStore.canRedoState}\n\t\t\t\t\tclass=\"btn-icon preset-outlined-surface-500\"\n\t\t\t\t\ttitle=\"Redo (Ctrl+Shift+Z)\"\n\t\t\t\t\taria-label=\"Redo\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:redo\" width=\"20\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t\t\t<button onclick={handleCancelClick} class=\"btn preset-outlined-surface-500\">\n\t\t\t\t\t{activeState ? 'Exit Tool' : 'Cancel'}\n\t\t\t\t</button>\n\t\t\t\t<button onclick={() => editorComponent?.handleSave()} class=\"btn preset-filled-tertiary-500 dark:preset-filled-primary-500\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:content-save\" width=\"18\"></iconify-icon>\n\t\t\t\t\t<span>Save</span>\n\t\t\t\t</button>\n\t\t\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t\t\t<button onclick={handleClose} class=\"btn-icon preset-outlined-surface-500\" aria-label=\"Close\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</header>\n\n\t\t<main class=\"flex-1 overflow-auto bg-surface-50/50 dark:bg-surface-900/50\">\n\t\t\t<Editor\n\t\t\t\tbind:this={editorComponent}\n\t\t\t\tinitialImageSrc={image.url}\n\t\t\t\tfocalPoint={image?.metadata?.focalPoint as { x: number; y: number } | undefined}\n\t\t\t\tonsave={(detail) => onsave(detail)}\n\t\t\t\toncancel={handleClose}\n\t\t\t/>\n\t\t</main>\n\t\t<EditorToolbar />\n\t</div>\n{/if}\n","<!-- \n @file src/components/ModalPrompt.svelte\n @component \n **ModalPrompt component**\n @example\n <ModalPrompt title=\"Prompt\" body=\"Are you sure?\" value=\"\" type=\"text\" response={(value) => console.log(value)} parent={modalState} /> \n\n ### Features\n - Modal prompt with title, body, and input field\n - Input field can be of type text, number, or email\n - Modal has a confirm and cancel button\n - Modal can be closed by clicking the cancel button or by submitting the form\n -->\n\n<script lang=\"ts\">\n\tlet {\n\t\tbody = '',\n\t\tvalue = '',\n\t\ttype = 'text',\n\t\t// The close function is passed down automatically by DialogManager\n\t\tclose\n\t}: {\n\t\tbody?: string;\n\t\tvalue?: string;\n\t\ttype?: string;\n\t\tclose?: (result: any) => void;\n\t} = $props();\n\n\t// svelte-ignore state_referenced_locally\n\tlet inputValue = $state(value);\n\n\tfunction onConfirm() {\n\t\tclose?.(inputValue);\n\t}\n\n\tfunction onCancel() {\n\t\tclose?.(null); // Return null or false to indicate cancellation\n\t}\n</script>\n\n<div class=\"space-y-4\">\n\t{#if body}\n\t\t<article class=\"text-sm opacity-80\">\n\t\t\t{@html body}\n\t\t</article>\n\t{/if}\n\n\t<form\n\t\tclass=\"flex flex-col gap-2\"\n\t\tonsubmit={(e) => {\n\t\t\te.preventDefault();\n\t\t\tonConfirm();\n\t\t}}\n\t>\n\t\t<input class=\"input p-2 border rounded-container-token bg-surface-200-800\" {type} bind:value={inputValue} />\n\t</form>\n\n\t<div class=\"flex justify-end gap-2 pt-2\">\n\t\t<button type=\"button\" class=\"btn preset-tonal\" onclick={onCancel}> Cancel </button>\n\t\t<button type=\"button\" class=\"btn preset-filled-primary\" onclick={onConfirm}> Confirm </button>\n\t</div>\n</div>\n","/**\n * @file src/utils/media/mediaUtils.ts\n * @description Client-safe media utilities (MIME, URL construction, validation)\n */\n\nimport { publicEnv } from '@shared/stores/globalSettings.svelte';\nimport { formatBytes, removeExtension } from '@shared/utils/utils';\n// import { logger } from '@shared/utils/logger';\n\nimport type { MediaBase } from './mediaModels';\n\n/** Browser-compatible MIME lookup */\nexport function getMimeType(name: string): string | null {\n\tconst ext = name.toLowerCase().split('.').pop();\n\tif (!ext) return null;\n\n\tconst map: Record<string, string> = {\n\t\t// Images\n\t\tjpg: 'image/jpeg',\n\t\tjpeg: 'image/jpeg',\n\t\tpng: 'image/png',\n\t\tgif: 'image/gif',\n\t\twebp: 'image/webp',\n\t\tsvg: 'image/svg+xml',\n\t\tavif: 'image/avif',\n\t\tbmp: 'image/bmp',\n\t\tico: 'image/x-icon',\n\n\t\t// Documents\n\t\tpdf: 'application/pdf',\n\t\ttxt: 'text/plain',\n\n\t\t// Audio\n\t\tmp3: 'audio/mpeg',\n\t\twav: 'audio/wav',\n\t\togg: 'audio/ogg',\n\t\taac: 'audio/aac',\n\t\tflac: 'audio/flac',\n\t\tm4a: 'audio/mp4',\n\n\t\t// Video\n\t\tmp4: 'video/mp4',\n\t\twebm: 'video/webm',\n\t\tmov: 'video/quicktime'\n\t};\n\n\treturn map[ext] ?? null;\n}\n\n/** Construct public media URL */\nexport function mediaUrl(item: MediaBase, size?: string): string {\n\tif (!item?.url) return '';\n\n\tif (publicEnv.MEDIASERVER_URL) {\n\t\treturn `${publicEnv.MEDIASERVER_URL.replace(/\\/+$/, '')}/${item.url}`;\n\t}\n\n\tif (size && 'thumbnails' in item && (item.thumbnails as any)?.[size]?.url) {\n\t\treturn (item.thumbnails as any)[size].url;\n\t}\n\n\treturn `/files/${item.url}`;\n}\n\n/** Build URL from parts (hash-based naming) */\nexport function buildUrl(path: string, hash: string, filename: string, ext: string, category: string, size?: string): string {\n\tif (!path || !hash || !filename || !ext || !category) return '';\n\n\tconst base = removeExtension(filename);\n\tconst file = `${base}-${hash}.${ext}`;\n\n\tlet rel: string;\n\n\tif (path === 'global') {\n\t\trel = size ? `${category}/sizes/${size}/${file}` : `${category}/original/${file}`;\n\t} else if (path === 'unique') {\n\t\trel = `${category}/original/${file}`;\n\t} else {\n\t\trel = size ? `${path}/${size}/${file}` : `${path}/${file}`;\n\t}\n\n\treturn publicEnv.MEDIASERVER_URL ? `${publicEnv.MEDIASERVER_URL.replace(/\\/+$/, '')}/files/${rel}` : `/files/${rel}`;\n}\n\n/** Client-side file validation */\nexport function validateFile(file: File, allowedPattern: RegExp, maxSize = 10 * 1024 * 1024): { valid: boolean; message?: string } {\n\tconst type = getMimeType(file.name) ?? file.type;\n\n\tif (!type || !allowedPattern.test(type)) {\n\t\treturn { valid: false, message: `Invalid type: ${type}` };\n\t}\n\n\tif (file.size > maxSize) {\n\t\treturn { valid: false, message: `Size exceeds ${formatBytes(maxSize)}` };\n\t}\n\n\treturn { valid: true };\n}\n\n/** Server-side buffer validation */\nexport function validateBuffer(\n\tbuffer: Buffer,\n\tname: string,\n\tallowedPattern: RegExp,\n\tmaxSize = 10 * 1024 * 1024\n): { valid: boolean; message?: string } {\n\tconst type = getMimeType(name) ?? 'application/octet-stream';\n\n\tif (!allowedPattern.test(type)) {\n\t\treturn { valid: false, message: `Invalid type: ${type}` };\n\t}\n\n\tif (buffer.length > maxSize) {\n\t\treturn { valid: false, message: `Size exceeds ${formatBytes(maxSize)}` };\n\t}\n\n\treturn { valid: true };\n}\n\n/** Aliases for backward compatibility */\nexport const validateMediaFileServer = validateBuffer;\nexport const constructUrl = mediaUrl;\nexport const constructMediaUrl = mediaUrl;\n","<!--\n@file src/routes/(app)/mediagallery/+page.svelte\n@component\n**Media Gallery Page**\n\nDisplays a collection of media files (images, documents, audio, video) with:\n- Virtual folder navigation and breadcrumb trails\n- Search and filter by media type\n- Grid and table view modes with size options\n- Upload and folder management capabilities\n\n### Props:\n- `data.user` - Current user information\n- `data.media` - Array of media files to display\n- `data.systemVirtualFolders` - Virtual folder structure\n\n### Features:\n- Client-side search and filtering\n- Responsive grid/table layouts\n- Virtual folder CRUD operations\n- Media file deletion\n-->\n\n<script lang=\"ts\">\n\timport { goto } from '$app/navigation';\n\timport axios from 'axios';\n\t// Stores\n\timport { toggleUIElement } from '@shared/stores/UIStore.svelte';\n\timport { globalLoadingStore, loadingOperations } from '@shared/stores/loadingStore.svelte';\n\t// Logger\n\timport { logger } from '@shared/utils/logger';\n\t// Utils & Media\n\timport { publicEnv } from '@shared/stores/globalSettings.svelte';\n\timport { MediaTypeEnum, type MediaBase, type MediaImage } from '@shared/utils/media/mediaModels';\n\t// Components\n\timport Breadcrumb from '@cms/components/Breadcrumb.svelte';\n\timport PageTitle from '@cms/components/PageTitle.svelte';\n\timport { MediaGrid, MediaTable, VirtualMediaGrid, AdvancedSearchModal } from '@cms/mediagallery';\n\timport ImageEditorModal from '@cms/image-editor/ImageEditorModal.svelte';\n\t// Skeleton\n\timport { toaster } from '@shared/stores/store.svelte';\n\t// Import types\n\timport type { SystemVirtualFolder } from '@shared/database/dbInterface';\n\timport type { SearchCriteria } from '@shared/utils/media/advancedSearch';\n\n\t// Initialize modal store\n\t// const modalStore = getModalStore();\n\timport { modalState } from '@shared/utils/modalState.svelte';\n\timport { showConfirm } from '@shared/utils/modalUtils';\n\timport ModalPrompt from '@cms/components/ModalPrompt.svelte';\n\n\timport type { PageData } from './$types';\n\n\t// Props using runes\n\tlet { data }: { data: PageData } = $props();\n\n\t// State using runes\n\tlet files: (MediaBase | MediaImage)[] = $state([]);\n\tlet allSystemVirtualFolders: any[] = $state([]);\n\tlet currentSystemVirtualFolder: SystemVirtualFolder | null = $state(null);\n\tlet breadcrumb: string[] = $state([]);\n\n\tlet globalSearchValue = $state('');\n\tlet selectedMediaType: 'All' | MediaTypeEnum = $state('All');\n\tlet view: 'grid' | 'table' = $state('grid');\n\tlet gridSize: 'tiny' | 'small' | 'medium' | 'large' = $state('small');\n\tlet tableSize: 'tiny' | 'small' | 'medium' | 'large' = $state('small');\n\tlet isLoading = $state(false);\n\n\t// Enterprise features state\n\tlet advancedSearchCriteria: SearchCriteria | null = $state(null);\n\n\t// Performance optimization: Use virtual scrolling for large collections\n\tconst USE_VIRTUAL_THRESHOLD = 100;\n\n\ttype MediaTypeOption = {\n\t\tvalue: 'All' | MediaTypeEnum;\n\t\tlabel: string;\n\t};\n\n\t// Media types with proper typing\n\tconst mediaTypes: MediaTypeOption[] = [\n\t\t{ value: 'All', label: 'ALL' },\n\t\t{ value: MediaTypeEnum.Image, label: 'IMAGE' },\n\t\t{ value: MediaTypeEnum.Document, label: 'DOCUMENT' },\n\t\t{ value: MediaTypeEnum.Audio, label: 'AUDIO' },\n\t\t{ value: MediaTypeEnum.Video, label: 'VIDEO' },\n\t\t{ value: MediaTypeEnum.RemoteVideo, label: 'REMOTE VIDEO' }\n\t];\n\n\t// Computed value for filtered files based on search and type\n\tconst filteredFiles = $derived.by(() => {\n\t\tconst results = files.filter((file) => {\n\t\t\tconst matchesSearch = (file.filename || '').toLowerCase().includes(globalSearchValue.toLowerCase());\n\t\t\tconst matchesType = selectedMediaType === 'All' || file.type === selectedMediaType;\n\t\t\treturn matchesSearch && matchesType;\n\t\t});\n\n\t\t// Apply advanced search criteria if set\n\t\tif (advancedSearchCriteria) {\n\t\t\t// Import the advancedSearch function if criteria is active\n\t\t\t// This will be handled by the modal's onSearch callback\n\t\t\treturn results;\n\t\t}\n\n\t\treturn results;\n\t});\n\n\t// Performance optimization: Use virtual scrolling for large collections\n\tconst useVirtualScrolling = $derived(filteredFiles.length > USE_VIRTUAL_THRESHOLD);\n\n\t// Computed folders for breadcrumb - create a mapping of breadcrumb paths to folder IDs\n\tconst breadcrumbFolders = $derived.by(() => {\n\t\tconst folders: { _id: string; name: string; path: string[] }[] = [];\n\n\t\t// Always add root as first folder\n\t\tfolders.push({\n\t\t\t_id: 'root',\n\t\t\tname: 'Media Root',\n\t\t\tpath: []\n\t\t});\n\n\t\tif (!currentSystemVirtualFolder) {\n\t\t\treturn folders;\n\t\t}\n\n\t\tlet current: SystemVirtualFolder | null = currentSystemVirtualFolder;\n\t\tconst pathSegments: string[] = [];\n\n\t\tconst tempFolders: { _id: string; name: string; path: string[] }[] = [];\n\t\twhile (current) {\n\t\t\tpathSegments.unshift(current.name);\n\t\t\ttempFolders.unshift({\n\t\t\t\t_id: current._id,\n\t\t\t\tname: current.name,\n\t\t\t\tpath: [...pathSegments] // Copy the current path\n\t\t\t});\n\t\t\t// Find the parent folder\n\t\t\tcurrent = allSystemVirtualFolders.find((f) => f._id === current?.parentId) || null;\n\t\t}\n\n\t\treturn [...folders, ...tempFolders];\n\t});\n\n\t// Handle user preferences\n\tfunction storeUserPreference(\n\t\tview: 'grid' | 'table',\n\t\tgridSize: 'tiny' | 'small' | 'medium' | 'large',\n\t\ttableSize: 'tiny' | 'small' | 'medium' | 'large'\n\t) {\n\t\tlocalStorage.setItem('GalleryUserPreference', `${view}/${gridSize}/${tableSize}`);\n\t}\n\n\tfunction getUserPreferenceFromLocalStorageOrCookie(): string | null {\n\t\treturn localStorage.getItem('GalleryUserPreference');\n\t}\n\n\t// Mobile navigation helper - hides sidebar on mobile before navigation\n\tfunction handleMobileNavigation(path: string) {\n\t\tif (typeof window !== 'undefined' && window.innerWidth < 768) {\n\t\t\ttoggleUIElement('leftSidebar', 'hidden');\n\t\t}\n\t\tgoto(path);\n\t}\n\n\t// Computed safe table size (MediaTable doesn't support 'tiny')\n\tconst safeTableSize = $derived(tableSize);\n\n\t// Initialize component with runes\n\t// Run once on mount to set up initial data\n\t$effect(() => {\n\t\t// Load initial data from server\n\t\tif (data && data.systemVirtualFolders) {\n\t\t\tallSystemVirtualFolders = data.systemVirtualFolders.map((folder: SystemVirtualFolder) => ({\n\t\t\t\t...folder,\n\t\t\t\tpath: Array.isArray(folder.path) ? folder.path : folder.path?.split('/')\n\t\t\t}));\n\t\t}\n\n\t\tif (data && data.currentFolder) {\n\t\t\tcurrentSystemVirtualFolder = data.currentFolder;\n\t\t}\n\n\t\tif (data && data.media) {\n\t\t\tfiles = data.media.map((m: any) => ({\n\t\t\t\t...m,\n\t\t\t\tuser: typeof m.user === 'object' && m.user ? m.user._id : m.user\n\t\t\t})) as (MediaBase | MediaImage)[];\n\t\t}\n\n\t\t// Load user preferences\n\t\tconst userPreference = getUserPreferenceFromLocalStorageOrCookie();\n\t\tif (userPreference) {\n\t\t\tconst [preferredView, preferredGridSize, preferredTableSize] = userPreference.split('/');\n\t\t\tview = preferredView as 'grid' | 'table';\n\t\t\tgridSize = preferredGridSize as 'tiny' | 'small' | 'medium' | 'large';\n\t\t\ttableSize = preferredTableSize as 'tiny' | 'small' | 'medium' | 'large';\n\t\t}\n\n\t\t// Listen for folder selection events\n\t\tconst handleSystemVirtualFolderSelected = (event: CustomEvent) => {\n\t\t\tconst { folderId } = event.detail;\n\t\t\topenSystemVirtualFolder(folderId && folderId !== 'root' ? folderId : null);\n\t\t};\n\n\t\tdocument.addEventListener('systemVirtualFolderSelected', handleSystemVirtualFolderSelected as EventListener);\n\n\t\treturn () => {\n\t\t\tdocument.removeEventListener('systemVirtualFolderSelected', handleSystemVirtualFolderSelected as EventListener);\n\t\t};\n\t});\n\n\t// Update breadcrumb when current folder changes\n\t$effect(() => {\n\t\t// This effect only runs when currentSystemVirtualFolder or allSystemVirtualFolders changes\n\t\tupdateBreadcrumb();\n\t});\n\t// Function to update breadcrumb based on current folder\n\tfunction updateBreadcrumb() {\n\t\tif (!currentSystemVirtualFolder) {\n\t\t\t// At root level - show Media Root\n\t\t\tbreadcrumb = ['Media Root'];\n\t\t\treturn;\n\t\t}\n\n\t\t// Build breadcrumb by traversing up the parent hierarchy\n\t\tconst buildBreadcrumb = (folder: SystemVirtualFolder): string[] => {\n\t\t\tconst path: string[] = ['Media Root']; // Always start with root\n\t\t\tlet current: SystemVirtualFolder | null = folder;\n\n\t\t\tconst folderPath: string[] = [];\n\t\t\twhile (current) {\n\t\t\t\tfolderPath.unshift(current.name); // Add folder name to the beginning\n\t\t\t\t// Find the parent folder\n\t\t\t\tcurrent = allSystemVirtualFolders.find((f) => f._id === current?.parentId) || null;\n\t\t\t}\n\n\t\t\treturn [...path, ...folderPath];\n\t\t};\n\n\t\tbreadcrumb = buildBreadcrumb(currentSystemVirtualFolder);\n\t}\n\n\t// Create a new virtual folder with validation\n\tasync function createSystemVirtualFolder(folderName: string) {\n\t\t// Validate folder name\n\t\tconst trimmedName = folderName.trim();\n\t\tif (!trimmedName) {\n\t\t\ttoaster.error({ description: 'Folder name cannot be empty' });\n\t\t\treturn;\n\t\t}\n\n\t\tif (/[\\\\/:\"*?<>|]/.test(trimmedName)) {\n\t\t\ttoaster.error({ description: 'Folder name contains invalid characters (\\\\ / : * ? \" < > |)' });\n\t\t\treturn;\n\t\t}\n\n\t\tif (trimmedName.length > 50) {\n\t\t\ttoaster.error({ description: 'Folder name must be 50 characters or less' });\n\t\t\treturn;\n\t\t}\n\n\t\tisLoading = true;\n\t\tglobalLoadingStore.startLoading(loadingOperations.dataFetch);\n\n\t\ttry {\n\t\t\tconst parentId = currentSystemVirtualFolder?._id ?? null;\n\t\t\tconst response = await fetch('/api/systemVirtualFolder', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ name: trimmedName, parentId })\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst errorData = await response.json();\n\t\t\t\tthrow new Error(errorData.error || `HTTP error! status: ${response.status}`);\n\t\t\t}\n\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.success) {\n\t\t\t\t// Refetch all folders and update current view\n\t\t\t\tallSystemVirtualFolders = await fetchUpdatedSystemVirtualFolders();\n\n\t\t\t\t// Notify Collections component\n\t\t\t\tdocument.dispatchEvent(\n\t\t\t\t\tnew CustomEvent('folderCreated', {\n\t\t\t\t\t\tdetail: { folder: result.folder, parentId }\n\t\t\t\t\t})\n\t\t\t\t);\n\n\t\t\t\ttoaster.success({ description: 'Folder created successfully' });\n\t\t\t} else {\n\t\t\t\tthrow new Error(result.error || 'Failed to create folder');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tlogger.error('Error creating folder:', error);\n\t\t\tconst errorMessage =\n\t\t\t\terror instanceof Error && error.message.includes('duplicate')\n\t\t\t\t\t? error.message\n\t\t\t\t\t: error instanceof Error && error.message.includes('invalid')\n\t\t\t\t\t\t? 'Invalid folder name'\n\t\t\t\t\t\t: 'Failed to create folder';\n\t\t\ttoaster.error({ description: errorMessage });\n\t\t} finally {\n\t\t\tisLoading = false;\n\t\t\tglobalLoadingStore.stopLoading(loadingOperations.dataFetch);\n\t\t}\n\t}\n\n\t// Fetch updated folders\n\tasync function fetchUpdatedSystemVirtualFolders() {\n\t\ttry {\n\t\t\tconst response = await fetch('/api/systemVirtualFolder');\n\t\t\tconst result = await response.json();\n\n\t\t\tif (result.success) {\n\t\t\t\treturn result.data.map((folder: SystemVirtualFolder) => ({\n\t\t\t\t\t...folder,\n\t\t\t\t\tpath: Array.isArray(folder.path) ? folder.path : folder.path?.split('/')\n\t\t\t\t}));\n\t\t\t} else {\n\t\t\t\tthrow new Error(result.error || 'Failed to fetch folders');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tlogger.error('Error fetching updated folders:', error);\n\t\t\ttoaster.error({ description: 'Failed to fetch folders' });\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t// Memoized fetch for media files\n\tlet lastSystemFolderId = $state<string | null>(null);\n\tasync function fetchMediaFiles(forceRefresh = false) {\n\t\tconst folderId = currentSystemVirtualFolder ? currentSystemVirtualFolder._id : 'root';\n\n\t\t// Skip if already loading or same folder (unless force refresh)\n\t\tif (!forceRefresh && (isLoading || folderId === lastSystemFolderId)) return;\n\n\t\tisLoading = true;\n\t\tglobalLoadingStore.startLoading(loadingOperations.dataFetch);\n\t\tlastSystemFolderId = folderId;\n\n\t\ttry {\n\t\t\tconst { data } = await axios.get(`/api/systemVirtualFolder/${folderId}`, {\n\t\t\t\ttimeout: 10000 // 10 second timeout\n\t\t\t});\n\n\t\t\tif (data.success) {\n\t\t\t\tfiles = Array.isArray(data.data.contents?.files) ? data.data.contents.files : [];\n\t\t\t\tlogger.info(`Fetched ${files.length} files for folder: ${folderId}`);\n\t\t\t\t// Folders are handled by allSystemVirtualFolders\n\t\t\t} else {\n\t\t\t\tthrow new Error(data.error || 'Unknown error');\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tlogger.error('Error fetching media files:', error);\n\t\t\tlet errorMessage = 'Failed to load media';\n\t\t\tif (error instanceof Error) {\n\t\t\t\tif (error.message.includes('timeout')) {\n\t\t\t\t\terrorMessage = 'Request timed out - please try again';\n\t\t\t\t} else if (error.message.includes('network')) {\n\t\t\t\t\terrorMessage = 'Network error - please check your connection';\n\t\t\t\t}\n\t\t\t}\n\t\t\ttoaster.error({ description: errorMessage });\n\t\t\tfiles = [];\n\t\t} finally {\n\t\t\tisLoading = false;\n\t\t\tglobalLoadingStore.stopLoading(loadingOperations.dataFetch);\n\t\t}\n\t}\n\n\t// Open virtual folder\n\tasync function openSystemVirtualFolder(folderId: string | null) {\n\t\ttry {\n\t\t\tif (folderId === null) {\n\t\t\t\tcurrentSystemVirtualFolder = null;\n\t\t\t} else {\n\t\t\t\t// Set current folder to the selected one from allFolders\n\t\t\t\tcurrentSystemVirtualFolder = allSystemVirtualFolders.find((f) => f._id === folderId) || null;\n\t\t\t}\n\n\t\t\t// Update breadcrumb based on the current folder\n\t\t\tupdateBreadcrumb();\n\n\t\t\t// Fetch media files for the current folder\n\t\t\tawait fetchMediaFiles();\n\t\t} catch (error) {\n\t\t\tlogger.error('Error opening folder:', error);\n\t\t\ttoaster.error({ description: 'Failed to open folder' });\n\t\t}\n\t}\n\n\tfunction handleViewChange(newView: 'grid' | 'table') {\n\t\tview = newView;\n\t\tstoreUserPreference(view, gridSize, tableSize);\n\t}\n\tfunction handleSizeChange(detail: { type: string; size: string }) {\n\t\tview = detail.type as 'grid' | 'table'; // Update the view based on the type in detail\n\t\tif (detail.type === 'grid') {\n\t\t\tgridSize = detail.size as 'tiny' | 'small' | 'medium' | 'large';\n\t\t} else {\n\t\t\ttableSize = detail.size as 'tiny' | 'small' | 'medium' | 'large';\n\t\t}\n\t\tstoreUserPreference(view, gridSize, tableSize);\n\t}\n\n\t// Clear search\n\tfunction clearSearch() {\n\t\tglobalSearchValue = '';\n\t}\n\n\t// Open add virtual folder modal\n\tfunction openAddFolderModal() {\n\t\tconst currentFolderPath = currentSystemVirtualFolder\n\t\t\t? Array.isArray(currentSystemVirtualFolder.path)\n\t\t\t\t? currentSystemVirtualFolder.path.join('/')\n\t\t\t\t: currentSystemVirtualFolder.path\n\t\t\t: publicEnv?.MEDIA_FOLDER || 'mediaFiles';\n\t\tmodalState.trigger(\n\t\t\tModalPrompt as any,\n\t\t\t{\n\t\t\t\ttitle: 'Add Folder',\n\t\t\t\tbody: `Creating subfolder in: <span class=\"text-tertiary-500 dark:text-primary-500\">${currentFolderPath}</span>`\n\t\t\t},\n\t\t\t(r: string) => {\n\t\t\t\tif (r) createSystemVirtualFolder(r);\n\t\t\t}\n\t\t);\n\t}\n\n\t// Handle delete image\n\tasync function handleDeleteImage(file: MediaBase) {\n\t\t// Show confirmation modal\n\t\tshowConfirm({\n\t\t\ttitle: 'Delete Media',\n\t\t\tbody: `Are you sure you want to delete \"${file.filename}\"? This action cannot be undone.`,\n\t\t\tonConfirm: async () => {\n\t\t\t\ttry {\n\t\t\t\t\tlogger.info('Delete image request:', { _id: file._id, filename: file.filename });\n\n\t\t\t\t\tconst formData = new FormData();\n\t\t\t\t\tformData.append('imageData', JSON.stringify(file));\n\n\t\t\t\t\tconst response = await fetch('?/deleteMedia', {\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\tbody: formData\n\t\t\t\t\t});\n\n\t\t\t\t\tlogger.info('Delete response status:', response.status);\n\n\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\tconst errorText = await response.text();\n\t\t\t\t\t\tlogger.error('Delete failed with status:', response.status, errorText);\n\t\t\t\t\t\tthrow new Error(`Server error: ${response.status} - ${errorText}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst result = await response.json();\n\t\t\t\t\tlogger.debug('Delete response:', result);\n\n\t\t\t\t\t// Handle SvelteKit's wrapped response format\n\t\t\t\t\tlet data = result;\n\t\t\t\t\tif (result.type === 'success' && result.data) {\n\t\t\t\t\t\t// Parse if data is a string\n\t\t\t\t\t\tdata = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Check if it's an array response (like upload)\n\t\t\t\t\tconst success = Array.isArray(data) ? data[0]?.success : data?.success;\n\n\t\t\t\t\tif (success) {\n\t\t\t\t\t\ttoaster.success({ description: 'Media deleted successfully.' });\n\n\t\t\t\t\t\t// Reactively remove the deleted file from the files array\n\t\t\t\t\t\t// Svelte 5 runes will automatically update all derived state\n\t\t\t\t\t\tfiles = files.filter((f) => f._id !== file._id);\n\n\t\t\t\t\t\tlogger.info(`Removed file ${file.filename} from UI. Remaining: ${files.length} files`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow new Error(data?.error || 'Failed to delete media');\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\t\t\t\tlogger.error('Error deleting media:', errorMessage);\n\t\t\t\t\ttoaster.error({ description: `Error deleting media: ${errorMessage}` });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t// Handle bulk delete\n\tasync function handleBulkDelete(filesToDelete: MediaBase[]) {\n\t\t// Show confirmation modal\n\t\tshowConfirm({\n\t\t\ttitle: 'Delete Multiple Media',\n\t\t\tbody: `Are you sure you want to delete ${filesToDelete.length} file${filesToDelete.length > 1 ? 's' : ''}? This action cannot be undone.`,\n\t\t\tonConfirm: async () => {\n\t\t\t\ttry {\n\t\t\t\t\tlogger.info('Bulk delete request:', { count: filesToDelete.length });\n\n\t\t\t\t\t// Track successfully deleted files\n\t\t\t\t\tconst successfullyDeletedIds = new Set();\n\t\t\t\t\tlet successCount = 0;\n\t\t\t\t\tlet failCount = 0;\n\n\t\t\t\t\tfor (const file of filesToDelete) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst formData = new FormData();\n\t\t\t\t\t\t\tformData.append('imageData', JSON.stringify(file));\n\n\t\t\t\t\t\t\tconst response = await fetch('?/deleteMedia', {\n\t\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\t\tbody: formData\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\t\t\tconst result = await response.json();\n\t\t\t\t\t\t\t\tlet data = result;\n\t\t\t\t\t\t\t\tif (result.type === 'success' && result.data) {\n\t\t\t\t\t\t\t\t\tdata = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst success = Array.isArray(data) ? data[0]?.success : data?.success;\n\t\t\t\t\t\t\t\tif (success) {\n\t\t\t\t\t\t\t\t\tsuccessCount++;\n\t\t\t\t\t\t\t\t\tsuccessfullyDeletedIds.add(file._id as string);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tfailCount++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tfailCount++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tlogger.error('Error deleting file:', file.filename, error);\n\t\t\t\t\t\t\tfailCount++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Show result\n\t\t\t\t\tif (failCount === 0) {\n\t\t\t\t\t\ttoaster.success({ description: `Successfully deleted ${successCount} file${successCount > 1 ? 's' : ''}` });\n\t\t\t\t\t} else if (successCount === 0) {\n\t\t\t\t\t\ttoaster.error({ description: `Failed to delete ${failCount} file${failCount > 1 ? 's' : ''}` });\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttoaster.warning({ description: `Deleted ${successCount} file${successCount > 1 ? 's' : ''}, ${failCount} failed` });\n\t\t\t\t\t}\n\n\t\t\t\t\t// Reactively remove only successfully deleted files\n\t\t\t\t\t// Svelte 5 runes will automatically update filteredFiles derived state\n\t\t\t\t\tfiles = files.filter((f) => !successfullyDeletedIds.has(f._id as string));\n\n\t\t\t\t\tlogger.info(`Removed ${successCount} files from UI. Remaining: ${files.length} files`);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\t\t\t\tlogger.error('Error in bulk delete:', errorMessage);\n\t\t\t\t\ttoaster.error({ description: `Error deleting media: ${errorMessage}` });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t// Handle advanced search\n\tasync function handleAdvancedSearch(criteria: SearchCriteria) {\n\t\ttry {\n\t\t\tconst response = await fetch('/api/media/search', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\tbody: JSON.stringify({ criteria })\n\t\t\t});\n\n\t\t\tif (!response.ok) throw new Error('Search failed');\n\n\t\t\tconst result = await response.json();\n\n\t\t\t// Update files with search results\n\t\t\tfiles = result.files;\n\t\t\tadvancedSearchCriteria = criteria;\n\t\t\tmodalState.close(); // Close the modal\n\n\t\t\ttoaster.success({\n\t\t\t\tdescription: `Found ${result.totalCount} file${result.totalCount === 1 ? '' : 's'} matching ${result.matchedCriteria.length} criteria`\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tlogger.error('Advanced search error:', error);\n\t\t\ttoaster.error({ description: 'Search failed. Please try again.' });\n\t\t}\n\t}\n\n\t// Clear advanced search\n\tfunction clearAdvancedSearch() {\n\t\tadvancedSearchCriteria = null;\n\t\tfetchMediaFiles(); // Reload all files\n\t}\n\n\tfunction openAdvancedSearch() {\n\t\tmodalState.trigger(AdvancedSearchModal as any, {\n\t\t\tfiles,\n\t\t\tonSearch: handleAdvancedSearch,\n\t\t\tmodalClasses: 'max-w-4xl max-h-[95vh]' // Override default width\n\t\t});\n\t}\n\n\t/*\n\t-------------------------------------------------------------------------\n\tIMAGE EDITOR HANDLERS (Via Modal)\n\t-------------------------------------------------------------------------\n\t*/\n\n\t// Define state for Image Editor\n\t// let imageToEdit: any = $state(null); // No longer needed\n\t// let showEditor = $state(false);      // No longer needed\n\n\timport { mediaUrl } from '@shared/utils/media/mediaUtils';\n\n\t// ... (existing imports)\n\n\tasync function handleEditImage(file: any) {\n\t\tconsole.log('handleEditImage called with:', file);\n\t\tif (!file) {\n\t\t\tconsole.warn('handleEditImage: File is null/undefined');\n\t\t\treturn;\n\t\t}\n\n\t\t// Ensure we have a valid URL\n\t\tconst url = file.url || mediaUrl(file);\n\t\tconst imageWithUrl = { ...file, url };\n\n\t\t// Trigger the modal via modalState\n\t\tmodalState.trigger(ImageEditorModal as any, {\n\t\t\timage: imageWithUrl,\n\t\t\tonsave: handleEditorSave,\n\t\t\tmodalClasses: 'w-full h-full max-w-none max-h-none p-0'\n\t\t});\n\t}\n\n\tasync function handleEditorSave(detail: { dataURL: string; file: File }) {\n\t\tconst { file } = detail;\n\n\t\tconst formData = new FormData();\n\t\tformData.append('files', file);\n\n\t\ttry {\n\t\t\tconst response = await fetch('/mediagallery?/upload', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tbody: formData\n\t\t\t});\n\t\t\tif (response.ok) {\n\t\t\t\ttoaster.success({ description: 'Image saved successfully!' });\n\t\t\t\tfetchMediaFiles(true); // Force refresh\n\t\t\t} else {\n\t\t\t\tthrow new Error('Failed to save edited image');\n\t\t\t}\n\t\t} catch (err) {\n\t\t\ttoaster.error({ description: 'Error saving image' });\n\t\t\tlogger.error('Error saving edited image', err);\n\t\t}\n\t}\n\tfunction handleUpdateImage(updatedFile: MediaImage) {\n\t\tconst index = files.findIndex((f) => f._id === updatedFile._id);\n\t\tif (index !== -1) {\n\t\t\tfiles[index] = updatedFile;\n\t\t}\n\t}\n</script>\n\n<!-- Page Title and Actions -->\n<div class=\"flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between\">\n\t<!-- Row 1: Page Title and Back Button (Handled by PageTitle component) -->\n\t<PageTitle\n\t\tname=\"Media Gallery\"\n\t\ticon=\"bi:images\"\n\t\tshowBackButton={true}\n\t\tbackUrl=\"/\"\n\t\tonBackClick={(defaultBehavior) => {\n\t\t\t// Custom back navigation with loading state management\n\t\t\ttry {\n\t\t\t\tdefaultBehavior();\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error('Navigation error:', error);\n\t\t\t\t// Fallback to home page if history.back() fails\n\t\t\t\tgoto('/');\n\t\t\t}\n\t\t}}\n\t/>\n\n\t<!-- Row 2: Action Buttons -->\n\t<div class=\"lgd:mt-0 flex items-center justify-center gap-4 lg:justify-end\">\n\t\t<!-- Add folder with loading state -->\n\t\t<button\n\t\t\tonclick={openAddFolderModal}\n\t\t\taria-label=\"Add folder\"\n\t\t\tclass=\"preset-filled-tertiary-500 btn gap-2\"\n\t\t\tdisabled={isLoading}\n\t\t\taria-busy={isLoading}\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:folder-add-outline\" width=\"24\"></iconify-icon>\n\t\t\t{isLoading ? 'Creating...' : 'Add folder'}\n\t\t\t{#if isLoading}\n\t\t\t\t<span class=\"loading loading-spinner loading-xs\"></span>\n\t\t\t{/if}\n\t\t</button>\n\n\t\t<!-- Add Media -->\n\t\t<button onclick={() => handleMobileNavigation('/mediagallery/uploadMedia')} aria-label=\"Add Media\" class=\"preset-filled-primary-500 btn gap-2\">\n\t\t\t<iconify-icon icon=\"carbon:add-filled\" width=\"24\"></iconify-icon>\n\t\t\tAdd Media\n\t\t</button>\n\t</div>\n</div>\n\n<!-- Breadcrumb Navigation -->\n<Breadcrumb {breadcrumb} folders={breadcrumbFolders} openFolder={openSystemVirtualFolder} />\n\n<div class=\"wrapper overflow-auto\">\n\t<div class=\"mb-8 flex w-full flex-col justify-center gap-1 md:hidden\">\n\t\t<label for=\"globalSearch\">Search</label>\n\t\t<div class=\"flex gap-2\">\n\t\t\t<div class=\"input-group input-group-divider grid flex-1 grid-cols-[auto_1fr_auto]\">\n\t\t\t\t<input id=\"globalSearch\" type=\"text\" placeholder=\"Search Media\" class=\"input\" bind:value={globalSearchValue} />\n\t\t\t\t{#if globalSearchValue}\n\t\t\t\t\t<button onclick={() => (globalSearchValue = '')} aria-label=\"Clear search\" class=\"preset-filled-surface-500 w-12\">\n\t\t\t\t\t\t<iconify-icon icon=\"ic:outline-search-off\" width=\"24\"></iconify-icon>\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t</div>\n\t\t\t<!-- Advanced Search Button (Mobile) - Outside input group -->\n\t\t\t<button onclick={openAdvancedSearch} aria-label=\"Advanced search\" class=\"preset-filled-surface-500 btn\" title=\"Advanced Search\">\n\t\t\t\t<iconify-icon icon=\"mdi:magnify-plus-outline\" width=\"24\"></iconify-icon>\n\t\t\t</button>\n\t\t</div>\n\n\t\t<div class=\"mt-4 flex justify-between\">\n\t\t\t<div class=\"flex flex-col\">\n\t\t\t\t<label for=\"mediaType\">Type</label>\n\t\t\t\t<select id=\"mediaType\" bind:value={selectedMediaType} class=\"input\">\n\t\t\t\t\t{#each mediaTypes as type}\n\t\t\t\t\t\t<option value={type.value}>{type.label}</option>\n\t\t\t\t\t{/each}\n\t\t\t\t</select>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col text-center\">\n\t\t\t\t<label for=\"sortButton\">Sort</label>\n\t\t\t\t<button id=\"sortButton\" aria-label=\"Sort\" class=\"preset-outline-surface-500 btn\">\n\t\t\t\t\t<iconify-icon icon=\"flowbite:sort-outline\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex items-center justify-center text-center text-xs md:hidden\">\n\t\t\t\t<div class=\"flex flex-col items-center justify-center\">\n\t\t\t\t\t<div class=\"flex sm:divide-x sm:divide-gray-500\">\n\t\t\t\t\t\t{#if view === 'grid'}\n\t\t\t\t\t\t\t<button onclick={() => handleViewChange('table')} aria-label=\"Table\" class=\"btn flex flex-col items-center justify-center px-1\">\n\t\t\t\t\t\t\t\t<p class=\"text-center text-xs\">Display</p>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:list-alt-outline\" height=\"44\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Table</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<button onclick={() => handleViewChange('grid')} aria-label=\"Grid\" class=\"btn flex flex-col items-center justify-center px-1\">\n\t\t\t\t\t\t\t\t<p class=\"text-center text-xs\">Display</p>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view-rounded\" height=\"42\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-center text-xs\">Grid</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"flex flex-col items-center\">\n\t\t\t\t\t<p class=\"text-xs\">Size</p>\n\t\t\t\t\t<div class=\"flex divide-x divide-gray-500\">\n\t\t\t\t\t\t{#if (view === 'grid' && gridSize === 'tiny') || (view === 'table' && tableSize === 'tiny')}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Tiny\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:apps\" height=\"40\" style=\"color:text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Tiny</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'small') || (view === 'table' && tableSize === 'small')}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Small\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:background-grid-small-sharp\" height=\"40\" style=\"color:text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Small</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'medium') || (view === 'table' && tableSize === 'medium')}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Medium\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-on-sharp\" height=\"40\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Medium</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\t\tconst newSize =\n\t\t\t\t\t\t\t\t\t\tview === 'grid'\n\t\t\t\t\t\t\t\t\t\t\t? gridSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: gridSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'tiny'\n\t\t\t\t\t\t\t\t\t\t\t\t? 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'small'\n\t\t\t\t\t\t\t\t\t\t\t\t\t? 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t: tableSize === 'medium'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t? 'large'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t: 'tiny';\n\n\t\t\t\t\t\t\t\t\tif (view === 'grid') {\n\t\t\t\t\t\t\t\t\t\tgridSize = newSize;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\ttableSize = newSize;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\t\taria-label=\"Large\"\n\t\t\t\t\t\t\t\tclass=\"px-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view\" height=\"40\" style=\"color: text-black dark:text-white\"></iconify-icon>\n\t\t\t\t\t\t\t\t<p class=\"text-xs\">Large</p>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t<div class=\"mb-4 hidden items-end justify-between gap-4 md:flex\">\n\t\t<!-- Left Side: Search & Advanced -->\n\t\t<div class=\"flex items-end gap-2\">\n\t\t\t<div class=\"flex flex-col gap-1\">\n\t\t\t\t<label for=\"globalSearchMd\" class=\"text-sm font-medium\">Search</label>\n\t\t\t\t<div class=\"input-group input-group-divider grid h-11 max-w-md grid-cols-[auto_1fr_auto_auto]\">\n\t\t\t\t\t<input bind:value={globalSearchValue} id=\"globalSearchMd\" type=\"text\" placeholder=\"Search\" class=\"input\" />\n\t\t\t\t\t{#if globalSearchValue}\n\t\t\t\t\t\t<button onclick={clearSearch} class=\"preset-filled-surface-500 w-12\" aria-label=\"Clear search\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"ic:outline-search-off\" width=\"24\"></iconify-icon>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{/if}\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<!-- Advanced Search Button (Desktop) -->\n\t\t\t<button onclick={openAdvancedSearch} aria-label=\"Advanced search\" class=\"preset-filled-surface-500 btn gap-2\" title=\"Advanced Search\">\n\t\t\t\t<iconify-icon icon=\"mdi:magnify-plus-outline\" width=\"24\"></iconify-icon>\n\t\t\t\tAdvanced\n\t\t\t</button>\n\t\t</div>\n\n\t\t<!-- Right Side: Type, Sort, Display, Size -->\n\t\t<div class=\"flex items-end gap-4\">\n\t\t\t<div class=\"flex flex-col gap-1\">\n\t\t\t\t<label for=\"mediaTypeMd\" class=\"text-sm font-medium\">Type</label>\n\t\t\t\t<div class=\"input-group h-11\">\n\t\t\t\t\t<select id=\"mediaTypeMd\" bind:value={selectedMediaType} class=\"select\">\n\t\t\t\t\t\t{#each mediaTypes as type}\n\t\t\t\t\t\t\t<option value={type.value}>{type.label}</option>\n\t\t\t\t\t\t{/each}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col gap-1 text-center\">\n\t\t\t\t<label for=\"sortButton\" class=\"text-sm font-medium\">Sort</label>\n\t\t\t\t<button id=\"sortButton\" class=\"preset-tonal btn h-11\" aria-label=\"Sort\">\n\t\t\t\t\t<iconify-icon icon=\"flowbite:sort-outline\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col items-center gap-1\">\n\t\t\t\t<span class=\"text-sm font-medium\">Display</span>\n\t\t\t\t<div class=\"h-11 flex divide-x divide-gray-500 border border-surface-500/30 rounded-token overflow-hidden\">\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => handleViewChange('grid')}\n\t\t\t\t\t\tclass={`h-full px-3 flex flex-col items-center justify-center transition-colors ${view === 'grid' ? 'bg-primary-500/20 text-primary-500' : 'hover:bg-surface-500/10'}`}\n\t\t\t\t\t\taria-label=\"Grid\"\n\t\t\t\t\t\ttitle=\"Grid View\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view-rounded\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Grid</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => handleViewChange('table')}\n\t\t\t\t\t\tclass={`h-full px-3 flex flex-col items-center justify-center transition-colors ${view === 'table' ? 'bg-primary-500/20 text-primary-500' : 'hover:bg-surface-500/10'}`}\n\t\t\t\t\t\taria-label=\"Table\"\n\t\t\t\t\t\ttitle=\"Table View\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:list-alt-outline\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Table</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class=\"flex flex-col items-center gap-1\">\n\t\t\t\t<span class=\"text-sm font-medium\">Size</span>\n\t\t\t\t<div class=\"h-11 flex divide-x divide-gray-500 border border-surface-500/30 rounded-token overflow-hidden\">\n\t\t\t\t\t{#if (view === 'grid' && gridSize === 'tiny') || (view === 'table' && tableSize === 'tiny')}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'small';\n\t\t\t\t\t\t\t\telse tableSize = 'small';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Tiny - Click for Small\"\n\t\t\t\t\t\t\ttitle=\"Tiny (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:apps\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Tiny</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'small') || (view === 'table' && tableSize === 'small')}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'medium';\n\t\t\t\t\t\t\t\telse tableSize = 'medium';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Small - Click for Medium\"\n\t\t\t\t\t\t\ttitle=\"Small (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:background-grid-small-sharp\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Small</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{:else if (view === 'grid' && gridSize === 'medium') || (view === 'table' && tableSize === 'medium')}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'large';\n\t\t\t\t\t\t\t\telse tableSize = 'large';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Medium - Click for Large\"\n\t\t\t\t\t\t\ttitle=\"Medium (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-on-sharp\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Medium</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{:else}\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={() => {\n\t\t\t\t\t\t\t\tif (view === 'grid') gridSize = 'tiny';\n\t\t\t\t\t\t\t\telse tableSize = 'tiny';\n\t\t\t\t\t\t\t\tstoreUserPreference(view, gridSize, tableSize);\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tclass=\"h-full px-3 flex flex-col items-center justify-center transition-colors hover:bg-surface-500/10\"\n\t\t\t\t\t\t\taria-label=\"Large - Click for Tiny\"\n\t\t\t\t\t\t\ttitle=\"Large (Click to change)\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:grid-view\" height=\"20\"></iconify-icon>\n\t\t\t\t\t\t\t<span class=\"text-[10px] hidden xl:inline\">Large</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t{/if}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t{#if view === 'grid'}\n\t\t{#if useVirtualScrolling}\n\t\t\t<!-- Enterprise Virtual Scrolling for Large Collections (100+ files) -->\n\t\t\t<VirtualMediaGrid {filteredFiles} {gridSize} ondeleteImage={handleDeleteImage} onBulkDelete={handleBulkDelete} onEditImage={handleEditImage} />\n\t\t\t<div class=\"alert preset-outline-surface-500 mt-4\">\n\t\t\t\t<iconify-icon icon=\"mdi:lightning-bolt\" width=\"20\"></iconify-icon>\n\t\t\t\t<span class=\"text-sm\">\n\t\t\t\t\tVirtual scrolling enabled for optimal performance with {filteredFiles.length} files\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t{:else}\n\t\t\t<!-- Standard Grid for Smaller Collections -->\n\t\t\t<MediaGrid\n\t\t\t\t{filteredFiles}\n\t\t\t\t{gridSize}\n\t\t\t\tondeleteImage={handleDeleteImage}\n\t\t\t\tonBulkDelete={handleBulkDelete}\n\t\t\t\tonsizechange={handleSizeChange}\n\t\t\t\tonEditImage={handleEditImage}\n\t\t\t\tonUpdateImage={handleUpdateImage}\n\t\t\t/>\n\t\t{/if}\n\t{:else}\n\t\t<MediaTable\n\t\t\t{filteredFiles}\n\t\t\ttableSize={safeTableSize}\n\t\t\tondeleteImage={handleDeleteImage}\n\t\t\tonEditImage={handleEditImage}\n\t\t\tonUpdateImage={handleUpdateImage}\n\t\t\tonDeleteFiles={handleBulkDelete}\n\t\t/>\n\t{/if}\n</div>\n\n<!-- Editor Modal -->\n\n<!-- Modals -->\n\n<!-- Active Search Indicator -->\n{#if advancedSearchCriteria}\n\t<div class=\"alert preset-filled-warning-500 fixed bottom-4 right-4 z-40 max-w-sm\">\n\t\t<iconify-icon icon=\"mdi:filter\" width=\"20\"></iconify-icon>\n\t\t<div class=\"flex-1\">\n\t\t\t<p class=\"font-semibold\">Advanced search active</p>\n\t\t\t<p class=\"text-sm opacity-90\">Showing filtered results</p>\n\t\t</div>\n\t\t<button onclick={clearAdvancedSearch} class=\"preset-outline-surface-500 btn-icon btn-sm\" aria-label=\"Clear search\">\n\t\t\t<iconify-icon icon=\"mdi:close\" width=\"18\"></iconify-icon>\n\t\t</button>\n\t</div>\n{/if}\n"],"file":"21.y6o_i9qX.js"}