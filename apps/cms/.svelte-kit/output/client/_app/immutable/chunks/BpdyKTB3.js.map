{"version":3,"file":"BpdyKTB3.js","sources":["../../../../../../../../shared/stores/src/themeStore.svelte.ts"],"sourcesContent":["/**\n * @file src/stores/themeStore.svelte.ts\n * @description Centralized, rune-based theme management store.\n * Supports explicit theme preferences: 'system', 'light', 'dark'\n * Pure Tailwind CSS implementation - no Skeleton Labs dependencies\n */\nimport { browser } from '$app/environment';\nimport type { Theme } from '@shared/database/dbInterface';\nimport { nowISODateString } from '@shared/utils/dateUtils';\nimport type { ISODateString } from '@cms-types/content';\nimport { logger } from '@shared/utils/logger';\n\n// --- Theme Preference Type ---\nexport type ThemePreference = 'system' | 'light' | 'dark' | 'unknown';\n\n// --- State Shape ---\ninterface ThemeState {\n\tcurrentTheme: Theme | null;\n\tisLoading: boolean;\n\terror: string | null;\n\tlastUpdateAttempt: ISODateString | null;\n\tthemePreference: ThemePreference; // User's explicit preference\n\tresolvedDarkMode: boolean; // Computed dark mode state (considering system preference)\n\tautoRefreshEnabled: boolean;\n}\n\n// --- Core State ---\nconst state = $state<ThemeState>({\n\tcurrentTheme: null,\n\tisLoading: false,\n\terror: null,\n\tlastUpdateAttempt: null,\n\tthemePreference: 'unknown',\n\tresolvedDarkMode: true, // Default to true to match app.html\n\tautoRefreshEnabled: false\n});\n\n// --- Derived State ---\nconst currentTheme = $derived(state.currentTheme);\nconst hasTheme = $derived(!!state.currentTheme);\nconst themeName = $derived(state.currentTheme?.name ?? 'default');\nconst isLoading = $derived(state.isLoading);\nconst error = $derived(state.error);\nconst themePreference = $derived(state.themePreference);\nconst isDarkMode = $derived(state.resolvedDarkMode);\nconst autoRefreshEnabled = $derived(state.autoRefreshEnabled);\n\n// --- Exported Store Object ---\nexport const themeStore = {\n\tget currentTheme() {\n\t\treturn currentTheme;\n\t},\n\tget hasTheme() {\n\t\treturn hasTheme;\n\t},\n\tget themeName() {\n\t\treturn themeName;\n\t},\n\tget isLoading() {\n\t\treturn isLoading;\n\t},\n\tget error() {\n\t\treturn error;\n\t},\n\tget themePreference() {\n\t\treturn themePreference;\n\t},\n\tget isDarkMode() {\n\t\treturn isDarkMode;\n\t},\n\tget autoRefreshEnabled() {\n\t\treturn autoRefreshEnabled;\n\t}\n};\n\n// --- Actions ---\n\nlet systemThemeListener: ((this: MediaQueryList, ev: MediaQueryListEvent) => void) | null = null;\nconst THEME_COOKIE_KEY = 'theme';\n\n/**\n * Resolve the actual dark mode state based on preference\n */\nfunction resolveDarkMode(preference: ThemePreference): boolean {\n\tif (!browser) return true; // Default dark for SSR\n\n\tconst systemPrefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;\n\n\tswitch (preference) {\n\t\tcase 'dark':\n\t\t\treturn true;\n\t\tcase 'light':\n\t\t\treturn false;\n\t\tcase 'system':\n\t\tcase 'unknown':\n\t\tdefault:\n\t\t\t// Priority System: if light is preferred, use it. Otherwise dark.\n\t\t\treturn !systemPrefersLight;\n\t}\n}\n\n/**\n * Initializes the dark mode state from cookie/DOM and syncs Skeleton.\n * The DOM state is set pre-render by the script in app.html.\n * This MUST be called from a component's onMount lifecycle hook.\n */\nexport function initializeDarkMode() {\n\tif (!browser) return;\n\n\t// 1. Read theme preference from cookie\n\tconst cookieValue = document.cookie\n\t\t.split('; ')\n\t\t.find((c) => c.startsWith(`${THEME_COOKIE_KEY}=`))\n\t\t?.split('=')[1] as ThemePreference | undefined;\n\n\t// 2. Check current DOM state (already set by SSR script)\n\tconst currentlyDark = document.documentElement.classList.contains('dark');\n\n\t// 3. Determine user's preference (default to 'system' if no cookie)\n\tlet preference: ThemePreference = 'system';\n\n\tif (cookieValue === 'dark' || cookieValue === 'light' || cookieValue === 'system') {\n\t\tpreference = cookieValue;\n\t} else if (cookieValue) {\n\t\tconsole.warn('[Theme Init] Unknown cookie value, defaulting to system:', cookieValue);\n\t\tpreference = 'system';\n\t} else {\n\t\t// No cookie: use system preference as default\n\t\tpreference = 'system';\n\t}\n\n\t// 4. Update state WITHOUT touching the DOM (SSR script already set it correctly)\n\tstate.themePreference = preference;\n\tstate.resolvedDarkMode = currentlyDark; // Use current DOM state\n\n\t// 5. Save preference if not set\n\tif (!cookieValue) {\n\t\t_setCookie(preference);\n\t\tlogger.debug('[Theme Init] Set cookie to default dark mode:', preference);\n\t}\n\n\t// 6. Clean up old 'darkMode' cookie if it exists\n\tif (document.cookie.includes('darkMode=')) {\n\t\tdocument.cookie = 'darkMode=; path=/; max-age=0';\n\t\tlogger.debug('[Theme Init] Cleaned up old darkMode cookie');\n\t}\n\n\t// 7. Listen for system preference changes (only if using 'system' preference)\n\t_setupSystemListener();\n} /**\n * Apply dark mode state to DOM\n */\nfunction _applyThemeToDOM(isDark: boolean) {\n\tif (!browser) return;\n\n\tconst h = document.documentElement;\n\n\tif (isDark) {\n\t\th.classList.add('dark');\n\t\th.classList.remove('light');\n\t\tlogger.debug('[Theme] Applied dark/removed light from DOM');\n\t} else {\n\t\th.classList.add('light');\n\t\th.classList.remove('dark');\n\t\tlogger.debug('[Theme] Applied light/removed dark from DOM');\n\t}\n\n\t// Ensure the base theme attribute is always present for Skeleton v4\n\tif (document.body.getAttribute('data-theme') !== 'sveltycms') {\n\t\tdocument.body.setAttribute('data-theme', 'sveltycms');\n\t}\n}\n\n/**\n * Set the theme cookie\n */\nfunction _setCookie(preference: ThemePreference) {\n\tif (!browser) return;\n\n\t// Overwrite cookie with explicit path and max-age\n\t// Note: We don't need to explicitly delete it first; overwriting with the same name and path works.\n\tdocument.cookie = `${THEME_COOKIE_KEY}=${preference}; path=/; max-age=31536000; SameSite=Lax`;\n\tlogger.debug('[Theme] Updated cookie to:', preference);\n}\n\n/**\n * Setup listener for system preference changes\n */\nfunction _setupSystemListener() {\n\tif (!browser) return;\n\n\tconst mq = window.matchMedia('(prefers-color-scheme: dark)');\n\n\t// Remove old listener if exists\n\tif (systemThemeListener) {\n\t\tmq.removeEventListener('change', systemThemeListener);\n\t}\n\n\tsystemThemeListener = (e: MediaQueryListEvent) => {\n\t\t// Only react to system changes if user has 'system' preference\n\t\tif (state.themePreference === 'system') {\n\t\t\tlogger.debug('[Theme] System preference changed to:', e.matches ? 'dark' : 'light');\n\t\t\tstate.resolvedDarkMode = e.matches;\n\t\t\t_applyThemeToDOM(e.matches);\n\t\t}\n\t};\n\n\tmq.addEventListener('change', systemThemeListener);\n}\n\n/**\n * Set theme preference explicitly\n * @param preference - 'system', 'light', or 'dark'\n */\nexport function setThemePreference(preference: ThemePreference) {\n\tif (!browser) return;\n\tif (preference === 'unknown') {\n\t\tconsole.warn('[Theme] Cannot set preference to \"unknown\", defaulting to \"system\"');\n\t\tpreference = 'system';\n\t}\n\n\tlogger.debug('[Theme] Setting preference to:', preference);\n\n\t// Update state\n\tstate.themePreference = preference;\n\tstate.resolvedDarkMode = resolveDarkMode(preference);\n\n\t// Apply to DOM\n\t_applyThemeToDOM(state.resolvedDarkMode);\n\n\t// Save to cookie\n\t_setCookie(preference);\n\n\t// Re-setup system listener (in case preference changed to/from 'system')\n\t_setupSystemListener();\n}\n\n/**\n * Toggle between light and dark modes (ignoring system preference)\n * If currently on 'system', will switch to explicit light/dark\n */\nexport function toggleDarkMode(force?: boolean) {\n\tif (!browser) return;\n\n\tlet newPreference: ThemePreference;\n\n\tif (force !== undefined) {\n\t\t// Force specific mode\n\t\tnewPreference = force ? 'dark' : 'light';\n\t} else {\n\t\t// Toggle current state\n\t\tif (state.themePreference === 'system') {\n\t\t\t// If on system, toggle to opposite of current resolved state\n\t\t\tnewPreference = state.resolvedDarkMode ? 'light' : 'dark';\n\t\t} else {\n\t\t\t// Toggle between light and dark\n\t\t\tnewPreference = state.themePreference === 'dark' ? 'light' : 'dark';\n\t\t}\n\t}\n\n\tsetThemePreference(newPreference);\n}\n\n/**\n * Reset to system preference\n */\nexport function useSystemPreference() {\n\tsetThemePreference('system');\n} // ... (Rest of your themeStore.svelte.ts file) ...\nexport async function initializeThemeStore() {\n\tstate.isLoading = true;\n\tstate.error = null;\n\ttry {\n\t\tconst response = await fetch('/api/theme/default');\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(`Failed to fetch theme: ${response.statusText}`);\n\t\t}\n\t\tconst themeData: Theme = await response.json();\n\t\tstate.currentTheme = themeData ?? null;\n\t\tstate.lastUpdateAttempt = nowISODateString();\n\t\treturn themeData;\n\t} catch (err) {\n\t\tstate.error = err instanceof Error ? err.message : 'Failed to initialize theme';\n\t\tthrow err;\n\t} finally {\n\t\tstate.isLoading = false;\n\t}\n}\n\nexport async function updateTheme(newThemeName: string) {\n\tstate.isLoading = true;\n\tstate.error = null;\n\ttry {\n\t\tconst response = await fetch('/api/theme/update-theme', {\n\t\t\tmethod: 'POST',\n\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\tbody: JSON.stringify({ themeName: newThemeName })\n\t\t});\n\t\tif (!response.ok) throw new Error(`Failed to update theme: ${response.statusText}`);\n\n\t\tconst updatedTheme: Theme = await response.json();\n\t\tstate.currentTheme = updatedTheme;\n\t\tstate.lastUpdateAttempt = nowISODateString();\n\t\treturn updatedTheme;\n\t} catch (err) {\n\t\tconst errorMessage = err instanceof Error ? err.message : 'Failed to update theme';\n\t\tstate.error = errorMessage;\n\t\tthrow new Error(errorMessage);\n\t} finally {\n\t\tstate.isLoading = false;\n\t}\n}\n\nexport function clearError() {\n\tstate.error = null;\n}\n\n// --- 6. Auto-Refresh Management ---\nexport function startAutoRefresh() {\n\tstate.autoRefreshEnabled = true;\n}\n\nexport function stopAutoRefresh() {\n\tstate.autoRefreshEnabled = false;\n}\n"],"names":["state","currentTheme","$.derived","themePreference","isDarkMode","autoRefreshEnabled","themeStore","systemThemeListener","THEME_COOKIE_KEY","resolveDarkMode","preference","systemPrefersLight","initializeDarkMode","cookieValue","c","currentlyDark","_setCookie","logger","_setupSystemListener","_applyThemeToDOM","isDark","h","mq","e","setThemePreference","useSystemPreference","initializeThemeStore","response","themeData","nowISODateString","err","updateTheme","newThemeName","updatedTheme","errorMessage"],"mappings":"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"}