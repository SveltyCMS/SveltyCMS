{"version":3,"mappings":"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","names":["onselect","$.prop","$$props","multiple","viewMode","THUMBNAIL_SIZES","DEBOUNCE_MS","files","$.state","$.proxy","search","isLoading","error","showInfoSet","selectedFiles","currentViewMode","sortBy","sortAscending","debounceTimer","prefersReducedMotion","$.user_effect","$.set","filteredFiles","$.derived","result","searchLower","$.get","file","a","b","comparison","hasFiles","selectedCount","isInfoShown","index","toggleInfo","event","newSet","isSelected","filename","toggleSelection","handleSelect","fetchMedia","res","axios","err","logger","selected","f","confirmSelection","clearSelection","handleKeydown","getThumbnailUrl","size","getThumbnailDimensions","thumbnail","handleSearch","onMount","mediaQuery","handleChange","e","onDestroy","div","root","div_1","label","span","root_1","$.template_effect","$.set_text","text","$$render","consequent","input","$.sibling","$.remove_input_defaults","div_2","button","$.child","iconify_icon","$.reset","button_1","iconify_icon_1","button_2","iconify_icon_2","select","option","option_1","option_2","button_3","iconify_icon_3","$.set_custom_element_data","div_3","root_2","span_1","div_4","button_4","button_5","text_1","$.transition","fade","$.append","$$anchor","consequent_1","div_5","root_3","div_6","root_5","div_7","iconify_icon_4","p","button_6","div_8","root_7","div_9","iconify_icon_5","p_1","m.mediagallery_nomedia","div_10","root_8","div_11","root_9","node_5","label_1","root_10","input_1","$.set_checked","consequent_5","div_12","button_7","iconify_icon_6","p_2","button_8","node_6","img","root_11","$.set_attribute","$0","div_13","root_12","table","tbody","$.each","tr","root_14","td","td_1","consequent_7","alternate","consequent_6","$.set_class","$1","text_4","scale","alternate_1","consequent_4","consequent_3","alternate_2","consequent_2","alternate_3","$$value","value","show","className","showMedia","handleMediaSelect","data","handleFileChange","handleDrop","handleDragOver","target","handleDragLeave","openFileInput","toggleMedia","showMediaValue","$.first_child","fragment_1","m.widget_ImageUpload_Upload","m.widget_ImageUpload_Drag","m.widget_ImageUpload_Replace","node_1","text_5","text_6","node_2","root_4","p_3","Media","text_7","m.widget_ImageUpload_SelectImage","$2","$4","twMerge","m.widget_ImageUpload_Allowed","m.widget_ImageUpload_BrowseNew","m.widget_ImageUpload_SelectMedia","$.event","$$args","iconify_icon_7","classes","classes_1","classes_2","classes_3","AnnotationItem","id","node","layer","kind","cb","createText","x","y","fontSize","color","t","Konva","createRect","w","h","stroke","fill","strokeWidth","r","createCircle","radius","c","createLine","points","l","createArrow","TRANSFORMER_STYLE_DEFAULT","TRANSFORMER_STYLE_CROP","TRANSFORMER_STYLE","GRID_STYLE","TRANSFORMER_DEFAULTS","oldBox","newBox","createStyledTransformer","options","attachStyledTransformer","createTransformer","attachTransformer","enableTextEdit","stage","textNode","onComplete","stageBox","textPosition","scrollX","scrollY","area","done","handleKey","NS","names","transformer","annotations","currentTool","strokeColor","fillColor","isDrawing","tempNode","startPos","_toolBound","imageEditorStore","bindTool","AnnotateControls","deselect","v","deleteSelected","apply","unbindTool","onMouseDown","onMouseMove","onMouseUp","onStageClick","onDblClick","pos","txt","draw.createText","item","finalizeNode","startTextEdit","draw.createRect","draw.createCircle","draw.createLine","draw.createArrow","newValue","cleanupAnnotations","destroy","cleanup","saveState","beforeExit","index$4","Tool","hasActiveRegion","handleStrengthInput","iconify_icon_8","button_9","iconify_icon_9","button_10","iconify_icon_10","button_11","iconify_icon_11","$.set_value","BlurRegion","opts","init","n","localPt","bounds","padding","cacheRect","shape","ctx","m","pattern","strength","start","width","height","toolbarY","toolbarX","bg","addGroup","deleteGroup","isActive","deg","blurStrength","regions","activeId","strengthDebounceTimer","bindStageEvents","Controls","s","deleteRegion","createRegion","reset","unbindStageEvents","handleStageClick","imageNode","imageGroup","newR","selectRegion","cleanupBlurElements","destroyRegions","region","index$3","parseAspectRatio","ratio","parts","syncHighlight","overlayGroup","cropTool","shouldCache","cut","CropRegion","sw","sh","dark","groupRect","cx","cy","shapeWidth","shapeHeight","i","lx","vLine","ly","hLine","rect","keepRatio","cropShape","aspectRatio","CropControls","rotateLeft","rotateRight","flipHorizontal","showToast","initDefaultRegion","newRegion","newRotation","__vitePreload","stageRectToImageRect","cropRect","imageCrop","containerWidth","containerHeight","scaleX","scaleY","newScale","index$2","adjustments","handleSliderInput","$.index","adj","span_2","$.clsx","DEFAULT_ADJUSTMENTS","applyBaseFilters","combinedSaturation","createCustomFilter","expFactor","highFactor","shadowFactor","clarityFactor","mid","imageData","g","brightness","highAmount","factor","shadowAmount","shift","activeAdjustment","adjustments_list","filterDebounceTimer","FineTuneControls","key","resetAdjustment","currentAdjustments","activeFilters","index$1","focalX","focalY","onReset","onApply","onCancel","focalPoint","gridLayer","crosshair","FocalPointControls","resetFocalPoint","metadata","createGridOverlay","createCrosshair","imageWidth","imageHeight","imageX","imageY","originX","originY","lineColor","lineWidth","opacity","line","circle","updateCrosshair","editorWidget","handleAngleInput","displayAngle","angle","rotationAngle","RotateControls","setRotation","flipVertical","widget","positions","fragment","WatermarkItem","resolve","reject","position","imageRect","nodeBox","finalPos","watermarks","fileInput","_presetLoaded","getWatermarkPreset","getContext","preset","loadPresetWatermark","WatermarkControls","response","blob","presetOpacity","addWatermark","cleanupWatermarks","modules","__vite_glob_0_0","__vite_glob_0_1","__vite_glob_0_2","__vite_glob_0_3","__vite_glob_0_4","__vite_glob_0_5","__vite_glob_0_6","editorWidgets","mod","hasImage","tools","handleToolClick","tool","isToolActive","text_2","loadingMessage","containerRef","mounted","imageFile","initialImageSrc","onsave","oncancel","selectedImage","initialImageLoaded","isProcessing","preToolSnapshot","storeState","activeState","activeToolComponent","loadImageAndSetupKonva","imageSrc","currentOrigin","existingStage","handleResize","handleKeyDown","cmdOrCtrl","currentState","handleUndo","handleRedo","stateData","restoreFromStateData","rawData","isNewFormat","stateJSON","findImageGroupState","nodes","found","imageGroupState","imageNodeState","handleSave","dataURL","mimeType","fileExtension","newFileName","editedFile","handleCancel","toggleTool","expectedX","expectedY","currentX","currentY","newState","handleCancelTool","EditorSidebar","EditorCanvas","node_3","Component","Component_1","toolbarControls","$.spread_props","image","watermarkPreset","close","setContext","editorComponent","activeWidget","subInfo","props","handleClose","handleCancelClick","header","h2","fragment_2","span_3","h2_1","root_6","main","Editor","node_4","detail","EditorToolbar","updateMediaMetadata","patch","getWidgetData","_data","field","mode","meta_data","isFlipped","validationError","debounceTimeout","showEditor","collectionValue","getFieldName","validImageTypes","fileSchema","pipe","instance","check","thumbnailSchema","object","number","string","mediaImageSchema","record","widgetSchema","union","validateSchema","parse","validationStore","errorMessage","validateInput","handleEditorSave","formData","saveResponse","errorData","isDraggingFocalPoint","handleGlobalMouseMove","handleFocalPointDrag","handleGlobalMouseUp","saveFocalPoint","container","WidgetDataExport","getTimestamp","date","isoDateStringToDate","FileInput","$.set_style","p_4","p_5","p_6","p_7","p_8","m.widget_ImageUpload_Type","m.widget_ImageUpload_Uploaded","convertTimestampToDateString","m.widget_ImageUpload_LastModified","m.widget_ImageUpload_Name","m.widget_ImageUpload_Size","p_9","ImageEditorModal"],"ignoreList":[],"sources":["../../../../../../../../shared/components/src/Media.svelte","../../../../../../../../shared/components/src/system/inputs/FileInput.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/Controls.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/regions.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/draw.ts","../../../../../../../../shared/components/src/imageEditor/widgets/transformerConfig.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/transformer.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/editText.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/events.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/Tool.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Annotate/index.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Blur/Controls.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Blur/regions.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Blur/Tool.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Blur/index.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Crop/Controls.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Crop/aspect.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Crop/highlight.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Crop/regions.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Crop/Tool.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Crop/index.ts","../../../../../../../../shared/components/src/imageEditor/widgets/FineTune/Controls.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/FineTune/adjustments.ts","../../../../../../../../shared/components/src/imageEditor/widgets/FineTune/baseFilters.ts","../../../../../../../../shared/components/src/imageEditor/widgets/FineTune/customFilters.ts","../../../../../../../../shared/components/src/imageEditor/widgets/FineTune/Tool.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/FineTune/index.ts","../../../../../../../../shared/components/src/imageEditor/widgets/FocalPoint/Controls.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/FocalPoint/Tool.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/FocalPoint/index.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Rotate/Controls.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Rotate/Tool.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Rotate/index.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Watermark/Controls.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Watermark/regions.ts","../../../../../../../../shared/components/src/imageEditor/widgets/Watermark/Tool.svelte","../../../../../../../../shared/components/src/imageEditor/widgets/Watermark/index.ts","../../../../../../../../shared/components/src/imageEditor/widgets/registry.ts","../../../../../../../../shared/components/src/imageEditor/EditorSidebar.svelte","../../../../../../../../shared/components/src/imageEditor/EditorCanvas.svelte","../../../../../../../../shared/components/src/imageEditor/Editor.svelte","../../../../../../../../shared/components/src/imageEditor/EditorToolbar.svelte","../../../../../../../../shared/components/src/imageEditor/ImageEditorModal.svelte","../../../../../../../../shared/utils/src/media/api.ts","../../../../../../src/widgets/core/MediaUpload/widgetData.ts","../../../../../../src/widgets/core/MediaUpload/MediaUpload.svelte"],"sourcesContent":["<!--\n@file src/components/Media.svelte\n@component\n**Enhanced Media Gallery - Svelte 5 Optimized**\n\nAdvanced media gallery with search, thumbnails, grid/list views, and selection.\n\n@example\n<Media onselect={(file) => handleFileSelection(file)} />\n\n### Props\n- `onselect` (function): Callback when a file is selected\n- `multiple` (boolean): Allow multiple selections\n- `viewMode` ('grid' | 'list'): Initial view mode\n\n### Features\n- Searchable media library with debounced input\n- Grid and list view modes\n- Thumbnail previews with lazy loading\n- Detailed file information panel\n- Multiple selection support\n- Keyboard navigation\n- Image preview modal\n- File filtering by type\n- Sort by name, date, size\n- Full ARIA accessibility\n- Reduced motion support\n-->\n\n<script lang=\"ts\">\n\timport { logger } from '@shared/utils/logger';\n\timport type { MediaImage } from '@shared/utils/media/mediaModels';\n\timport axios from 'axios';\n\timport { onMount, onDestroy } from 'svelte';\n\timport { fade, scale } from 'svelte/transition';\n\timport * as m from '@shared/paraglide/messages';\n\n\ttype ThumbnailSize = 'sm' | 'md' | 'lg';\n\ttype ViewMode = 'grid' | 'list';\n\ttype SortBy = 'name' | 'date' | 'size';\n\n\tinterface Props {\n\t\tonselect?: (file: MediaImage | MediaImage[]) => void;\n\t\tmultiple?: boolean;\n\t\tviewMode?: ViewMode;\n\t}\n\n\tconst { onselect = () => {}, multiple = false, viewMode = 'grid' }: Props = $props();\n\n\t// Constants\n\tconst THUMBNAIL_SIZES: ThumbnailSize[] = ['sm', 'md', 'lg'];\n\tconst DEBOUNCE_MS = 300;\n\n\t// State\n\tlet files = $state<MediaImage[]>([]);\n\tlet search = $state('');\n\tlet isLoading = $state(true);\n\tlet error = $state<string | null>(null);\n\tlet showInfoSet = $state(new Set<number>());\n\tlet selectedFiles = $state(new Set<string>());\n\tlet currentViewMode = $state<ViewMode>('grid'); // Default, synced from prop below\n\tlet sortBy = $state<SortBy>('name');\n\tlet sortAscending = $state(true);\n\tlet debounceTimer: ReturnType<typeof setTimeout> | null = null;\n\tlet prefersReducedMotion = $state(false);\n\n\t// Sync viewMode prop to local state on mount\n\t$effect(() => {\n\t\tcurrentViewMode = viewMode;\n\t});\n\n\t// Filtered and sorted files\n\tconst filteredFiles = $derived.by(() => {\n\t\tlet result = files;\n\n\t\t// Apply search filter\n\t\tif (search.trim()) {\n\t\t\tconst searchLower = search.toLowerCase();\n\t\t\tresult = result.filter((file) => file.filename.toLowerCase().includes(searchLower));\n\t\t}\n\n\t\t// Apply sorting\n\t\tresult = [...result].sort((a, b) => {\n\t\t\tlet comparison = 0;\n\n\t\t\tswitch (sortBy) {\n\t\t\t\tcase 'name':\n\t\t\t\t\tcomparison = a.filename.localeCompare(b.filename);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'date':\n\t\t\t\t\t// Assuming files have a created/modified date\n\t\t\t\t\tcomparison = 0; // Implement based on your data structure\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'size':\n\t\t\t\t\t// Implement size comparison if available\n\t\t\t\t\tcomparison = 0;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn sortAscending ? comparison : -comparison;\n\t\t});\n\n\t\treturn result;\n\t});\n\n\tconst hasFiles = $derived(filteredFiles.length > 0);\n\tconst selectedCount = $derived(selectedFiles.size);\n\n\t// Check if info is shown\n\tfunction isInfoShown(index: number): boolean {\n\t\treturn showInfoSet.has(index);\n\t}\n\n\t// Toggle info display\n\tfunction toggleInfo(event: Event, index: number): void {\n\t\tevent.stopPropagation();\n\t\tevent.preventDefault();\n\n\t\tconst newSet = new Set(showInfoSet);\n\t\tif (newSet.has(index)) {\n\t\t\tnewSet.delete(index);\n\t\t} else {\n\t\t\tnewSet.add(index);\n\t\t}\n\t\tshowInfoSet = newSet;\n\t}\n\n\t// Check if file is selected\n\tfunction isSelected(filename: string): boolean {\n\t\treturn selectedFiles.has(filename);\n\t}\n\n\t// Toggle file selection\n\tfunction toggleSelection(file: MediaImage, event?: Event): void {\n\t\tevent?.stopPropagation();\n\n\t\tconst newSet = new Set(selectedFiles);\n\n\t\tif (multiple) {\n\t\t\tif (newSet.has(file.filename)) {\n\t\t\t\tnewSet.delete(file.filename);\n\t\t\t} else {\n\t\t\t\tnewSet.add(file.filename);\n\t\t\t}\n\t\t\tselectedFiles = newSet;\n\t\t} else {\n\t\t\t// Single selection mode\n\t\t\tselectedFiles = new Set([file.filename]);\n\t\t\thandleSelect(file);\n\t\t}\n\t}\n\n\t// Fetch all media files\n\tasync function fetchMedia(): Promise<void> {\n\t\tisLoading = true;\n\t\terror = null;\n\n\t\ttry {\n\t\t\tconst res = await axios.get<MediaImage[]>('/media/getAll');\n\t\t\tfiles = res.data;\n\t\t\tshowInfoSet = new Set();\n\t\t\tselectedFiles = new Set();\n\t\t} catch (err) {\n\t\t\terror = err instanceof Error ? err.message : 'Failed to load media';\n\t\t\tlogger.error('Error fetching media:', err);\n\t\t} finally {\n\t\t\tisLoading = false;\n\t\t}\n\t}\n\n\t// Handle file selection\n\tfunction handleSelect(file: MediaImage): void {\n\t\tif (multiple) {\n\t\t\tconst selected = files.filter((f) => selectedFiles.has(f.filename));\n\t\t\tonselect(selected);\n\t\t} else {\n\t\t\tonselect(file);\n\t\t}\n\t}\n\n\t// Confirm multiple selection\n\tfunction confirmSelection(): void {\n\t\tconst selected = files.filter((f) => selectedFiles.has(f.filename));\n\t\tonselect(selected);\n\t}\n\n\t// Clear selection\n\tfunction clearSelection(): void {\n\t\tselectedFiles = new Set();\n\t}\n\n\t// Handle keyboard selection\n\tfunction handleKeydown(event: KeyboardEvent, file: MediaImage): void {\n\t\tif (event.key === 'Enter' || event.key === ' ') {\n\t\t\tevent.preventDefault();\n\t\t\ttoggleSelection(file);\n\t\t}\n\t}\n\n\t// Get thumbnail URL\n\tfunction getThumbnailUrl(file: MediaImage, size: ThumbnailSize = 'sm'): string {\n\t\treturn file.thumbnails?.[size]?.url || '';\n\t}\n\n\t// Get thumbnail dimensions\n\tfunction getThumbnailDimensions(file: MediaImage, size: ThumbnailSize): string {\n\t\tconst thumbnail = file.thumbnails?.[size];\n\t\treturn thumbnail ? `${thumbnail.width}${thumbnail.height}` : 'N/A';\n\t}\n\n\t// Debounced search\n\tfunction handleSearch(): void {\n\t\tif (debounceTimer) {\n\t\t\tclearTimeout(debounceTimer);\n\t\t}\n\n\t\tdebounceTimer = setTimeout(() => {\n\t\t\t// Search is handled by filteredFiles derived state\n\t\t}, DEBOUNCE_MS);\n\t}\n\n\t// Lifecycle\n\tonMount(() => {\n\t\tconst mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');\n\t\tprefersReducedMotion = mediaQuery.matches;\n\n\t\tconst handleChange = (e: MediaQueryListEvent) => {\n\t\t\tprefersReducedMotion = e.matches;\n\t\t};\n\n\t\tmediaQuery.addEventListener('change', handleChange);\n\t\tfetchMedia();\n\n\t\treturn () => mediaQuery.removeEventListener('change', handleChange);\n\t});\n\n\tonDestroy(() => {\n\t\tif (debounceTimer) {\n\t\t\tclearTimeout(debounceTimer);\n\t\t}\n\t});\n</script>\n\n<div class=\"flex h-full flex-col gap-4\" role=\"region\" aria-label=\"Media gallery\">\n\t<!-- Header with controls -->\n\t<div class=\"flex flex-wrap items-center gap-2\">\n\t\t<label for=\"media-search\" class=\"font-bold text-tertiary-500 dark:text-primary-500\">\n\t\t\tMedia\n\t\t\t{#if hasFiles}\n\t\t\t\t<span class=\"text-sm font-normal opacity-70\">({filteredFiles.length})</span>\n\t\t\t{/if}\n\t\t</label>\n\n\t\t<!-- Search -->\n\t\t<input\n\t\t\ttype=\"search\"\n\t\t\tbind:value={search}\n\t\t\toninput={handleSearch}\n\t\t\tplaceholder=\"Search files...\"\n\t\t\tclass=\"input flex-1\"\n\t\t\tid=\"media-search\"\n\t\t\taria-label=\"Search media files\"\n\t\t\tdisabled={isLoading}\n\t\t/>\n\n\t\t<!-- View mode toggle -->\n\t\t<div class=\"flex gap-1 rounded-lg border border-surface-300 p-1 dark:border-surface-600\" role=\"group\" aria-label=\"View mode\">\n\t\t\t<button\n\t\t\t\tonclick={() => (currentViewMode = 'grid')}\n\t\t\t\tclass=\"btn-icon btn-icon-sm {currentViewMode === 'grid' ? 'preset-filled-primary-500' : 'preset-outlined-surface-500'}\"\n\t\t\t\taria-label=\"Grid view\"\n\t\t\t\taria-pressed={currentViewMode === 'grid'}\n\t\t\t>\n\t\t\t\t<iconify-icon icon=\"mdi:view-grid\" width=\"18\"></iconify-icon>\n\t\t\t</button>\n\t\t\t<button\n\t\t\t\tonclick={() => (currentViewMode = 'list')}\n\t\t\t\tclass=\"btn-icon btn-icon-sm {currentViewMode === 'list' ? 'preset-filled-primary-500' : 'preset-outlined-surface-500'}\"\n\t\t\t\taria-label=\"List view\"\n\t\t\t\taria-pressed={currentViewMode === 'list'}\n\t\t\t>\n\t\t\t\t<iconify-icon icon=\"mdi:view-list\" width=\"18\"></iconify-icon>\n\t\t\t</button>\n\t\t</div>\n\n\t\t<!-- Refresh -->\n\t\t<button onclick={fetchMedia} class=\"preset-outlined-primary-500 btn-sm\" disabled={isLoading} aria-label=\"Refresh media\">\n\t\t\t<iconify-icon icon=\"mdi:refresh\" width=\"20\" class={isLoading && !prefersReducedMotion ? 'animate-spin' : ''}></iconify-icon>\n\t\t</button>\n\n\t\t<!-- Sort dropdown -->\n\t\t<select bind:value={sortBy} class=\"input w-auto\" aria-label=\"Sort by\" disabled={isLoading}>\n\t\t\t<option value=\"name\">Sort by Name</option>\n\t\t\t<option value=\"date\">Sort by Date</option>\n\t\t\t<option value=\"size\">Sort by Size</option>\n\t\t</select>\n\n\t\t<button\n\t\t\tonclick={() => (sortAscending = !sortAscending)}\n\t\t\tclass=\"btn-icon btn-icon-sm preset-outlined-surface-500\"\n\t\t\taria-label={sortAscending ? 'Sort descending' : 'Sort ascending'}\n\t\t>\n\t\t\t<iconify-icon icon={sortAscending ? 'mdi:sort-ascending' : 'mdi:sort-descending'} width=\"20\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<!-- Selection toolbar (multiple mode) -->\n\t{#if multiple && selectedCount > 0}\n\t\t<div\n\t\t\tclass=\"flex items-center justify-between rounded-lg border-l-4 border-primary-500 bg-primary-50 p-3 dark:bg-primary-900/20\"\n\t\t\ttransition:fade={{ duration: prefersReducedMotion ? 0 : 200 }}\n\t\t>\n\t\t\t<span class=\"text-sm font-medium\">\n\t\t\t\t{selectedCount} file{selectedCount !== 1 ? 's' : ''} selected\n\t\t\t</span>\n\t\t\t<div class=\"flex gap-2\">\n\t\t\t\t<button onclick={clearSelection} class=\"preset-outlined-surface-500btn btn-sm\"> Clear </button>\n\t\t\t\t<button onclick={confirmSelection} class=\"preset-filled-primary-500 btn-sm\"> Confirm Selection </button>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<!-- Loading state -->\n\t{#if isLoading}\n\t\t<div class=\"flex flex-1 items-center justify-center\" transition:fade={{ duration: prefersReducedMotion ? 0 : 200 }}>\n\t\t\t<div class=\"flex flex-col items-center gap-3\">\n\t\t\t\t<div class=\"h-12 w-12 animate-spin rounded-full border-4 border-primary-500 border-t-transparent\"></div>\n\t\t\t\t<p class=\"text-lg text-primary-500\">Loading media...</p>\n\t\t\t</div>\n\t\t</div>\n\t{:else if error}\n\t\t<!-- Error state -->\n\t\t<div class=\"flex flex-1 items-center justify-center\" transition:fade={{ duration: prefersReducedMotion ? 0 : 200 }}>\n\t\t\t<div class=\"flex flex-col items-center gap-3\">\n\t\t\t\t<iconify-icon icon=\"mdi:alert-circle\" width=\"48\" class=\"text-error-500\"></iconify-icon>\n\t\t\t\t<p class=\"text-lg text-error-500\">Error: {error}</p>\n\t\t\t\t<button onclick={fetchMedia} class=\"preset-filled-primary-500 btn-sm\"> Try Again </button>\n\t\t\t</div>\n\t\t</div>\n\t{:else if !hasFiles}\n\t\t<!-- Empty state -->\n\t\t<div class=\"flex flex-1 items-center justify-center\" transition:fade={{ duration: prefersReducedMotion ? 0 : 200 }}>\n\t\t\t<div class=\"flex flex-col items-center gap-3\">\n\t\t\t\t<iconify-icon icon=\"mdi:image-off\" width=\"48\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t<p class=\"text-lg text-surface-600 dark:text-surface-50\">\n\t\t\t\t\t{search ? `No media found for \"${search}\"` : m.mediagallery_nomedia()}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</div>\n\t{:else}\n\t\t<!-- Media grid/list -->\n\t\t<div\n\t\t\tclass=\"flex-1 overflow-auto {currentViewMode === 'grid'\n\t\t\t\t? 'grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'\n\t\t\t\t: 'flex flex-col gap-2'}\"\n\t\t\trole=\"list\"\n\t\t\taria-label=\"Media files\"\n\t\t>\n\t\t\t{#each filteredFiles as file, index (file.filename)}\n\t\t\t\t{@const selected = isSelected(file.filename)}\n\t\t\t\t<div\n\t\t\t\t\tclass=\"group card relative flex {currentViewMode === 'list'\n\t\t\t\t\t\t? 'flex-row items-center'\n\t\t\t\t\t\t: 'flex-col'} overflow-hidden transition-all duration-200 {selected ? 'ring-4 ring-primary-500' : ''}\"\n\t\t\t\t\trole=\"listitem\"\n\t\t\t\t\ttransition:scale={{ duration: prefersReducedMotion ? 0 : 200, start: 0.95 }}\n\t\t\t\t>\n\t\t\t\t\t{#if multiple}\n\t\t\t\t\t\t<!-- Selection checkbox -->\n\t\t\t\t\t\t<label class=\"absolute left-2 top-2 z-10\">\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\t\t\tchecked={selected}\n\t\t\t\t\t\t\t\tonchange={(e) => toggleSelection(file, e)}\n\t\t\t\t\t\t\t\tclass=\"checkbox\"\n\t\t\t\t\t\t\t\taria-label={`Select ${file.filename}`}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t{/if}\n\n\t\t\t\t\t<!-- Header -->\n\t\t\t\t\t<div class=\"relative z-10 flex w-full items-center bg-surface-700/90 backdrop-blur-sm\">\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonclick={(e) => toggleInfo(e, index)}\n\t\t\t\t\t\t\taria-label={`${isInfoShown(index) ? 'Hide' : 'Show'} info for ${file.filename}`}\n\t\t\t\t\t\t\taria-pressed={isInfoShown(index)}\n\t\t\t\t\t\t\tclass=\"btn-sm m-1 p-1 hover:bg-surface-600\"\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<iconify-icon icon={isInfoShown(index) ? 'mdi:information-off' : 'mdi:information'} width=\"20\" class=\"text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<p class=\"flex-1 truncate pr-2 text-center text-sm text-white\" title={file.filename}>\n\t\t\t\t\t\t\t{file.filename}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<!-- Content -->\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => toggleSelection(file)}\n\t\t\t\t\t\tonkeydown={(e) => handleKeydown(e, file)}\n\t\t\t\t\t\taria-label={`${selected ? 'Deselect' : 'Select'} ${file.filename}`}\n\t\t\t\t\t\tclass=\"flex flex-1 items-center justify-center p-4 transition-transform hover:scale-[1.02] focus:scale-[1.02] focus:outline-2 focus:outline-primary-500\"\n\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{#if !isInfoShown(index)}\n\t\t\t\t\t\t\t<!-- Thumbnail view -->\n\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\tsrc={getThumbnailUrl(file, currentViewMode === 'list' ? 'sm' : 'md')}\n\t\t\t\t\t\t\t\talt={file.filename}\n\t\t\t\t\t\t\t\tclass=\"max-h-full max-w-full rounded-md object-contain\"\n\t\t\t\t\t\t\t\tloading=\"lazy\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t<!-- Info view -->\n\t\t\t\t\t\t\t<div class=\"w-full text-left\">\n\t\t\t\t\t\t\t\t<h4 class=\"mb-2 text-sm font-semibold\">Thumbnail Sizes</h4>\n\t\t\t\t\t\t\t\t<table class=\"table w-full text-xs\">\n\t\t\t\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t<th class=\"text-left\">Size</th>\n\t\t\t\t\t\t\t\t\t\t\t<th class=\"text-left\">Dimensions</th>\n\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t{#each THUMBNAIL_SIZES as size (size)}\n\t\t\t\t\t\t\t\t\t\t\t{#if file.thumbnails?.[size]}\n\t\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<td class=\"uppercase\">{size}</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<td>{getThumbnailDimensions(file, size)}</td>\n\t\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t\t{/each}\n\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t{/each}\n\t\t</div>\n\t{/if}\n</div>\n","<!-- \n@file src/components/system/inputs/FileInput.svelte\n@component\n**FileInput component**\n\n### Props\n- `value`: File | MediaImage | undefined - Currently selected file or media image.\n- `multiple`: boolean - Allow multiple file selection.\n- `show`: boolean - Whether to show the file input area.\n- `className`: string - Additional CSS classes for styling.\n\n### Features\n- File input \n- Multiple file input\n- Drag and drop\n-->\n\n<script lang=\"ts\">\n\timport type { MediaImage } from '@shared/utils/media/mediaModels';\n\timport { twMerge } from 'tailwind-merge';\n\t// Component\n\timport Media from '@cms/components/Media.svelte';\n\n\t// ParaglideJS\n\timport * as m from '@shared/paraglide/messages';\n\n\t// Props\n\tlet { value = $bindable(), multiple = $bindable(false), show = $bindable(true), className = '', onChange } = $props();\n\n\t// Declare reactive state with $state\n\tlet input: HTMLInputElement | null = $state(null);\n\tlet showMedia = $state(false);\n\n\t// Handle media selection\n\tfunction handleMediaSelect(data: MediaImage | MediaImage[]) {\n\t\tshow = false;\n\t\tshowMedia = false;\n\t\t// If multiple support is added later, this logic will need update\n\t\tconst selected = Array.isArray(data) ? data[0] : data;\n\t\tif (selected) {\n\t\t\tvalue = selected;\n\t\t\tonChange?.(selected);\n\t\t}\n\t}\n\n\t// Handle file change\n\tfunction handleFileChange() {\n\t\tif (!input?.files || input.files.length === 0) return;\n\t\tconst file = input.files[0];\n\t\tvalue = file;\n\t\tshow = false;\n\t\tonChange?.(file);\n\t}\n\n\t// Handle file drop\n\tfunction handleDrop(e: DragEvent) {\n\t\te.preventDefault();\n\t\tconst file = e?.dataTransfer?.files[0];\n\t\tif (file) {\n\t\t\tvalue = file;\n\t\t\tonChange?.(file);\n\t\t}\n\t}\n\n\t// Handle drag over\n\tfunction handleDragOver(e: DragEvent) {\n\t\te.preventDefault();\n\t\tconst target = e.target as HTMLElement;\n\t\ttarget.style.borderColor = '#6bdfff';\n\t}\n\n\t// Handle drag leave\n\tfunction handleDragLeave(e: DragEvent) {\n\t\te.preventDefault();\n\t\tconst target = e.target as HTMLElement;\n\t\ttarget.style.removeProperty('border-color');\n\t}\n\n\t// Open file input dialog\n\tfunction openFileInput() {\n\t\tinput?.click();\n\t}\n\n\t// Toggle media selection modal\n\tfunction toggleMedia(showMediaValue: boolean) {\n\t\tshowMedia = showMediaValue;\n\t}\n</script>\n\n{#if show}\n\t<!-- Upload Dropzone -->\n\t<div\n\t\tondrop={handleDrop}\n\t\tondragover={handleDragOver}\n\t\tondragleave={handleDragLeave}\n\t\trole=\"cell\"\n\t\ttabindex=\"0\"\n\t\tclass={twMerge(\n\t\t\t'relative mt-2 flex h-[200px] w-full max-w-full select-none flex-col items-center justify-center gap-4 rounded border-2 border-dashed border-surface-600 bg-surface-200 dark:border-surface-500 dark:bg-surface-700',\n\t\t\tclassName\n\t\t)}\n\t>\n\t\t<div class=\"grid grid-cols-6 items-center p-4\">\n\t\t\t<iconify-icon icon=\"fa6-solid:file-arrow-up\" width=\"40\"></iconify-icon>\n\t\t\t<span class=\"text-white\"> test</span>\n\n\t\t\t<div class=\"col-span-5\">\n\t\t\t\t{#if !show}\n\t\t\t\t\t<p class=\"font-bold\">\n\t\t\t\t\t\t<span class=\"text-tertiary-500 dark:text-primary-500\">{m.widget_ImageUpload_Upload()}</span>\n\t\t\t\t\t\t{m.widget_ImageUpload_Drag()}\n\t\t\t\t\t</p>\n\t\t\t\t{:else}\n\t\t\t\t\t<p class=\"font-bold\">\n\t\t\t\t\t\t<span class=\"text-tertiary-500 dark:text-primary-500\">{m.widget_ImageUpload_Replace()}</span>\n\t\t\t\t\t\t{m.widget_ImageUpload_Drag()}\n\t\t\t\t\t</p>\n\t\t\t\t{/if}\n\t\t\t\t<p class=\"text-sm opacity-75\">{m.widget_ImageUpload_Allowed()}.</p>\n\n\t\t\t\t<div class=\"flex w-full justify-center gap-2\">\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={openFileInput}\n\t\t\t\t\t\taria-label={m.widget_ImageUpload_BrowseNew()}\n\t\t\t\t\t\tclass=\"preset-filled-tertiary-500 btn mt-3 dark:preset-filled-primary-500\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{m.widget_ImageUpload_BrowseNew()}\n\t\t\t\t\t</button>\n\n\t\t\t\t\t<button\n\t\t\t\t\t\tonclick={() => toggleMedia(true)}\n\t\t\t\t\t\taria-label={m.widget_ImageUpload_SelectMedia()}\n\t\t\t\t\t\tclass=\"preset-filled-tertiary-500 btn mt-3 dark:preset-filled-primary-500\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{m.widget_ImageUpload_SelectMedia()}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<!-- File Input -->\n\t\t<input bind:this={input} type=\"file\" accept=\"image/*,image/webp,image/avif,image/svg+xml\" hidden {multiple} onchange={handleFileChange} />\n\t</div>\n\n\t<!-- Show existing Media Images -->\n\t{#if showMedia}\n\t\t<div\n\t\t\tclass=\"bg-surface-100-800-token fixed left-[50%] top-[50%] z-999999999 flex h-[90%] w-[95%] translate-x-[-50%] translate-y-[-50%] flex-col rounded border border-surface-400 p-2\"\n\t\t>\n\t\t\t<div class=\"bg-surface-100-800-token flex items-center justify-between border-b p-2\">\n\t\t\t\t<p class=\"ml-auto font-bold text-black dark:text-primary-500\">\n\t\t\t\t\t{m.widget_ImageUpload_SelectImage()}\n\t\t\t\t</p>\n\t\t\t\t<button onclick={() => toggleMedia(false)} aria-label=\"Close\" class=\"preset-outlined-secondary-500 btn-icon ml-auto\">\n\t\t\t\t\t<iconify-icon icon=\"material-symbols:close\" width=\"24\" class=\"text-tertiary-500 dark:text-primary-500\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t<Media onselect={handleMediaSelect} />\n\t\t</div>\n\t{/if}\n{/if}\n","<!--\n@file: src/components/imageEditor/toolbars/AnnotateControls.svelte\n@component\nControls for the Annotate tool: tool selection (text, arrow, shapes) and styling (colors).\n-->\n<script lang=\"ts\">\n\ttype ToolType = 'text' | 'arrow' | 'rectangle' | 'circle' | null;\n\n\tlet {\n\t\tcurrentTool,\n\t\tstrokeColor,\n\t\tfillColor,\n\t\tonSetTool,\n\t\tonStrokeColorChange,\n\t\tonFillColorChange,\n\t\tonDelete,\n\t\tonApply\n\t}: {\n\t\tcurrentTool: ToolType;\n\t\tstrokeColor: string;\n\t\tfillColor: string;\n\t\tonSetTool: (tool: ToolType) => void;\n\t\tonStrokeColorChange: (color: string) => void;\n\t\tonFillColorChange: (color: string) => void;\n\t\tonDelete: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<!-- Tool Selection -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={currentTool === 'text'} onclick={() => onSetTool(currentTool === 'text' ? null : 'text')} title=\"Add Text\">\n\t\t\t<iconify-icon icon=\"mdi:format-text\"></iconify-icon>\n\t\t</button>\n\t\t<button\n\t\t\tclass=\"btn-sm\"\n\t\t\tclass:active={currentTool === 'arrow'}\n\t\t\tonclick={() => onSetTool(currentTool === 'arrow' ? null : 'arrow')}\n\t\t\ttitle=\"Draw Arrow\"\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:arrow-top-right\"></iconify-icon>\n\t\t</button>\n\t\t<button\n\t\t\tclass=\"btn-sm\"\n\t\t\tclass:active={currentTool === 'rectangle'}\n\t\t\tonclick={() => onSetTool(currentTool === 'rectangle' ? null : 'rectangle')}\n\t\t\ttitle=\"Draw Rectangle\"\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:rectangle-outline\"></iconify-icon>\n\t\t</button>\n\t\t<button\n\t\t\tclass=\"btn-sm\"\n\t\t\tclass:active={currentTool === 'circle'}\n\t\t\tonclick={() => onSetTool(currentTool === 'circle' ? null : 'circle')}\n\t\t\ttitle=\"Draw Circle\"\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:circle-outline\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Color Pickers -->\n\t<label class=\"flex items-center gap-2 text-sm\" title=\"Stroke Color\">\n\t\t<iconify-icon icon=\"mdi:water-opacity\"></iconify-icon>\n\t\t<input type=\"color\" class=\"input-color\" oninput={(e) => onStrokeColorChange(e.currentTarget.value)} value={strokeColor} />\n\t</label>\n\t<label class=\"flex items-center gap-2 text-sm\" title=\"Fill Color\">\n\t\t<iconify-icon icon=\"mdi:format-color-fill\"></iconify-icon>\n\t\t<input type=\"color\" class=\"input-color\" oninput={(e) => onFillColorChange(e.currentTarget.value)} value={fillColor} />\n\t</label>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Actions -->\n\t<button onclick={onDelete} class=\"btn preset-outlined-error-500\">\n\t\t<iconify-icon icon=\"mdi:delete-outline\"></iconify-icon>\n\t\t<span>Delete</span>\n\t</button>\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Done</span>\n\t</button>\n</div>\n\n<style>\n\t.input-color {\n\t\theight: var(--spacing-8, 2rem);\n\t\twidth: var(--spacing-8, 2rem);\n\t\tcursor: pointer;\n\t\tappearance: none;\n\t\tborder-radius: var(--radius-base, 0.375rem);\n\t\tborder: none;\n\t\tbackground-color: transparent;\n\t\tpadding: 0;\n\t}\n\t.input-color::-webkit-color-swatch-wrapper {\n\t\tpadding: 0;\n\t}\n\t.input-color::-webkit-color-swatch {\n\t\tborder-color: var(--color-surface-400);\n\t\tborder-radius: var(--radius-base, 0.375rem);\n\t\tborder-width: 1px;\n\t\tborder-style: solid;\n\t}\n</style>\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/regions.ts\n * @description Regions for Annotate tool\n *\n * Features:\n * - Text\n * - Rectangle\n * - Circle\n * - Line\n * - Arrow\n * - Text editing\n * - Namespacing events to avoid conflicts with other tools\n */\nimport Konva from 'konva';\n\nexport type AnnotationKind = 'text' | 'rect' | 'circle' | 'arrow' | 'line';\n\n/**\n * AnnotationItem encapsulates one annotation (node) and provides lifecycle methods.\n */\nexport class AnnotationItem {\n\tid: string;\n\tnode: Konva.Node;\n\tlayer: Konva.Layer;\n\tkind: AnnotationKind;\n\n\tprivate _onSelect: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\n\tconstructor(id: string, node: Konva.Node, layer: Konva.Layer, kind: AnnotationKind) {\n\t\tthis.id = id;\n\t\tthis.node = node;\n\t\tthis.layer = layer;\n\t\tthis.kind = kind;\n\n\t\t// attach selection handler\n\t\tthis.node.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onSelect?.();\n\t\t});\n\t}\n\n\t// one-line: make node draggable and focusable\n\tenableInteraction() {\n\t\t(this.node as any).draggable(true);\n\t}\n\n\t// one-line: disable interaction\n\tdisableInteraction() {\n\t\t(this.node as any).draggable(false);\n\t}\n\n\t// one-line: attach a generic event listener\n\ton(event: string, cb: Function) {\n\t\tthis.node.on(event, cb as any);\n\t}\n\n\t// one-line: remove a generic event listener\n\toff(event: string) {\n\t\tthis.node.off(event);\n\t}\n\n\t// one-line: destroy node and call destructor\n\tdestroy() {\n\t\ttry {\n\t\t\tthis.node.destroy();\n\t\t} catch (e) {}\n\t\tthis._onDestroy?.();\n\t}\n\n\tonSelect(cb: () => void) {\n\t\tthis._onSelect = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n}\n\nexport default AnnotationItem;\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/draw.ts\n * @description Draw tools for Konva\n *\n * Features:\n * - Text\n * - Rectangle\n * - Circle\n * - Line\n * - Arrow\n */\n\nimport Konva from 'konva';\n\n/** Create a Text node ready for editing */\nexport function createText(layer: Konva.Layer, x: number, y: number, text = 'Text', fontSize = 20, color = '#000') {\n\tconst t = new Konva.Text({ x, y, text, fontSize, fontFamily: 'Arial', fill: color, draggable: true, name: 'annotation-text' });\n\tlayer.add(t);\n\treturn t;\n}\n\n/** Create rect */\nexport function createRect(layer: Konva.Layer, x: number, y: number, w = 0, h = 0, stroke = '#f00', fill = 'transparent', strokeWidth = 2) {\n\tconst r = new Konva.Rect({ x, y, width: w, height: h, stroke, fill, strokeWidth, draggable: true, name: 'annotation-rect' });\n\tlayer.add(r);\n\treturn r;\n}\n\n/** Create circle */\nexport function createCircle(layer: Konva.Layer, x: number, y: number, radius = 0, stroke = '#f00', fill = 'transparent', strokeWidth = 2) {\n\tconst c = new Konva.Circle({ x, y, radius, stroke, fill, strokeWidth, draggable: true, name: 'annotation-circle' });\n\tlayer.add(c);\n\treturn c;\n}\n\n/** Create line */\nexport function createLine(layer: Konva.Layer, points: number[], stroke = '#f00', strokeWidth = 2) {\n\tconst l = new Konva.Line({ points, stroke, strokeWidth, lineCap: 'round', lineJoin: 'round', name: 'annotation-line', draggable: false });\n\tlayer.add(l);\n\treturn l;\n}\n\n/** Create arrow */\nexport function createArrow(layer: Konva.Layer, points: number[], stroke = '#f00', strokeWidth = 2) {\n\tconst a = new Konva.Arrow({\n\t\tpoints,\n\t\tstroke,\n\t\tfill: stroke,\n\t\tstrokeWidth,\n\t\tpointerLength: 10,\n\t\tpointerWidth: 8,\n\t\tname: 'annotation-arrow',\n\t\tdraggable: false\n\t});\n\tlayer.add(a);\n\treturn a;\n}\n","/**\n * @file src/components/imageEditor/widgets/transformerConfig.ts\n * @description Shared transformer configuration for consistent styling\n *\n * All image editor widgets (Crop, Blur, Annotate, Watermark) should use these\n * shared styles for uniform appearance of resize handles and borders.\n */\nimport Konva from 'konva';\n\n/**\n * Unified transformer configuration\n * - Blue circular handles with white border\n * - Solid blue border around selection\n * - Consistent sizing across all widgets\n */\nexport const TRANSFORMER_STYLE_DEFAULT: Partial<Konva.TransformerConfig> = {\n\t// Handle appearance\n\tanchorFill: '#3b82f6', // Tailwind blue-500\n\tanchorStroke: '#ffffff',\n\tanchorStrokeWidth: 2,\n\tanchorSize: 12,\n\tanchorCornerRadius: 6, // Makes handles circular\n\n\t// Border appearance\n\tborderStroke: '#3b82f6',\n\tborderStrokeWidth: 2,\n\tborderDash: [] // Solid line\n};\n\n/**\n * Specialized style for Crop tool\n */\nexport const TRANSFORMER_STYLE_CROP: Partial<Konva.TransformerConfig> = {\n\t...TRANSFORMER_STYLE_DEFAULT,\n\tanchorFill: '#3b82f6',\n\tanchorStroke: '#ffffff',\n\tanchorSize: 14,\n\tanchorCornerRadius: 7, // Circular\n\tborderStroke: '#ffffff',\n\tborderStrokeWidth: 1.5\n};\n\n/**\n * Specialized style for Redact/Blur tool (White thin borders, blue handles)\n */\nexport const TRANSFORMER_STYLE_REDACT: Partial<Konva.TransformerConfig> = {\n\t...TRANSFORMER_STYLE_DEFAULT,\n\tborderStroke: '#ffffff',\n\tborderStrokeWidth: 1.5,\n\tanchorFill: '#3b82f6',\n\tanchorStroke: '#ffffff',\n\tanchorSize: 12,\n\tanchorCornerRadius: 6\n};\n\n/** Legacy alias to keep compatibility while transitioning */\nexport const TRANSFORMER_STYLE = TRANSFORMER_STYLE_DEFAULT;\n\n/**\n * Style for rule-of-thirds grid\n */\nexport const GRID_STYLE = {\n\tstroke: 'rgba(255, 255, 255, 0.4)',\n\tstrokeWidth: 1,\n\tlistening: false\n};\n\n/**\n * Default transformer behavior options\n */\nexport const TRANSFORMER_DEFAULTS: Partial<Konva.TransformerConfig> = {\n\tkeepRatio: true,\n\trotateEnabled: true,\n\trotationSnaps: [0, 90, 180, 270],\n\trotateAnchorOffset: 40,\n\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\tboundBoxFunc: (oldBox, newBox) => {\n\t\t// Minimum size constraint\n\t\tif (newBox.width < 20 || newBox.height < 20) return oldBox;\n\t\treturn newBox;\n\t}\n};\n\n/**\n * Creates a styled transformer with unified appearance.\n *\n * @param layer - Konva layer to add transformer to\n * @param options - Optional overrides for specific widget needs\n * @returns Configured Konva.Transformer\n *\n * @example\n * ```ts\n * const tr = createStyledTransformer(layer);\n * tr.nodes([myShape]);\n * ```\n */\nexport function createStyledTransformer(layer: Konva.Layer, options?: Partial<Konva.TransformerConfig>): Konva.Transformer {\n\tconst tr = new Konva.Transformer({\n\t\t...TRANSFORMER_STYLE,\n\t\t...TRANSFORMER_DEFAULTS,\n\t\t...options\n\t});\n\tlayer.add(tr);\n\ttr.moveToTop();\n\treturn tr;\n}\n\n/**\n * Safely attaches transformer to a node with error handling.\n *\n * @param tr - Konva transformer instance\n * @param node - Node to attach, or null to detach\n */\nexport function attachStyledTransformer(tr: Konva.Transformer, node?: Konva.Node | null): void {\n\ttry {\n\t\tif (!node) {\n\t\t\ttr.nodes([]);\n\t\t\ttr.hide();\n\t\t\treturn;\n\t\t}\n\t\ttr.nodes([node]);\n\t\ttr.show();\n\t\ttr.forceUpdate();\n\t\ttr.moveToTop();\n\t} catch {\n\t\ttry {\n\t\t\ttr.nodes([]);\n\t\t\ttr.hide();\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t}\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/transformer.ts\n * @description Transformer utilities for Annotate tool\n *\n * Re-exports shared transformer config for consistent styling across widgets.\n */\nimport Konva from 'konva';\nimport { createStyledTransformer, attachStyledTransformer } from '../transformerConfig';\n\n/**\n * Create a transformer for annotations with consistent styling.\n * Uses more anchors than other tools for flexible annotation resizing.\n */\nexport function createTransformer(layer: Konva.Layer): Konva.Transformer {\n\treturn createStyledTransformer(layer, {\n\t\tkeepRatio: false,\n\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right', 'middle-left', 'middle-right']\n\t});\n}\n\n/**\n * Re-export attach function for convenience\n */\nexport const attachTransformer = attachStyledTransformer;\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/editText.ts\n * @description Text editor for Konva.Text nodes\n *\n * Features:\n * - HTML textarea overlay\n * - Accounts for stage position and page scroll\n * - Maintains Konva.Text properties\n * - Responsive to user input\n * - Clean up on completion\n */\n\nimport type Konva from 'konva';\n\n/**\n * Create an HTML textarea over stage for editing Konva.Text.\n * This correctly accounts for stage position and page scroll.\n */\nexport function enableTextEdit(stage: Konva.Stage, textNode: Konva.Text, onComplete: (txt: string) => void) {\n\t// Get stage container's position relative to viewport\n\tconst stageBox = stage.container().getBoundingClientRect();\n\n\t// Get text node's position relative to stage\n\tconst textPosition = textNode.absolutePosition();\n\n\t// Get current page scroll\n\tconst scrollX = window.scrollX;\n\tconst scrollY = window.scrollY;\n\n\tconst area = document.createElement('textarea');\n\tdocument.body.appendChild(area);\n\n\tarea.value = textNode.text();\n\tarea.style.position = 'absolute';\n\n\t// ** FIX: Add scroll offsets **\n\tarea.style.top = `${stageBox.top + textPosition.y + scrollY}px`;\n\tarea.style.left = `${stageBox.left + textPosition.x + scrollX}px`;\n\n\t// Apply styles from Konva node\n\tarea.style.width = `${textNode.width()}px`;\n\tarea.style.height = `${textNode.height() + 10}px`; // Add padding\n\tarea.style.fontSize = `${textNode.fontSize()}px`;\n\tarea.style.fontFamily = String(textNode.fontFamily()) || 'Arial';\n\tarea.style.color = String(textNode.fill()) || '#000';\n\tarea.style.lineHeight = String(textNode.lineHeight());\n\tarea.style.padding = textNode.padding() + 'px';\n\n\t// General styles\n\tarea.style.background = 'white';\n\tarea.style.border = '1px solid #0066ff';\n\tarea.style.boxShadow = '0 0 5px rgba(0,0,0,0.2)';\n\tarea.style.margin = '0';\n\tarea.style.resize = 'none';\n\tarea.style.overflow = 'hidden';\n\tarea.style.zIndex = '10000';\n\n\tarea.focus();\n\tarea.select();\n\n\tfunction done() {\n\t\tonComplete(area.value);\n\t\tdocument.body.removeChild(area);\n\t\twindow.removeEventListener('keydown', handleKey);\n\t\tarea.removeEventListener('blur', done);\n\t}\n\n\tfunction handleKey(e: KeyboardEvent) {\n\t\t// Finish on Escape\n\t\tif (e.key === 'Escape') {\n\t\t\tdone();\n\t\t}\n\t\t// Finish on Enter (without Shift)\n\t\tif (e.key === 'Enter' && !e.shiftKey) {\n\t\t\tdone();\n\t\t}\n\t}\n\n\twindow.addEventListener('keydown', handleKey);\n\tarea.addEventListener('blur', done);\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/events.ts\n * @description Event namespacing for Annotate tool\n *\n * Features:\n * - Namespacing events to avoid conflicts with other tools\n */\nexport const NS = 'annotate';\n// Namespacing events to avoid conflicts with other tools\nexport function names(event: string) {\n\treturn [`${event}.${NS}`, `${event}.annotate`].join(' ');\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Annotate/Tool.svelte\n@component\n**Annotate Tool \"Controller\"**\n\nOrchestrates the annotation lifecycle:\n- Manages the $state list of AnnotationItem instances\n- Handles stage drawing events (mousedown, mousemove, mouseup)\n- Manages the active selection and transformer\n- Registers the toolbar UI\n- Implements the critical 'apply' (bake) logic\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport AnnotateControls from './Controls.svelte';\n\timport { AnnotationItem, type AnnotationKind } from './regions';\n\timport * as draw from './draw';\n\timport { createTransformer, attachTransformer } from './transformer';\n\timport { enableTextEdit } from './editText';\n\timport { names } from './events';\n\n\t// --- Svelte 5 State ---\n\tlet transformer = $state<Konva.Transformer | null>(null);\n\tlet annotations = $state<AnnotationItem[]>([]);\n\tlet selected = $state<AnnotationItem | null>(null);\n\tlet currentTool = $state<AnnotationKind | null>(null);\n\tlet strokeColor = $state('#ff0000');\n\tlet fillColor = $state('transparent');\n\tlet strokeWidth = $state(2);\n\tlet fontSize = $state(20);\n\n\t// Drawing state machine\n\tlet isDrawing = $state(false);\n\tlet tempNode = $state<Konva.Node | null>(null);\n\tlet startPos = $state<{ x: number; y: number } | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// --- Lifecycle $effect ---\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'annotate') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: AnnotateControls,\n\t\t\t\tprops: {\n\t\t\t\t\tcurrentTool,\n\t\t\t\t\tstrokeColor,\n\t\t\t\t\tfillColor,\n\t\t\t\t\tonSetTool: (t: AnnotationKind | null) => {\n\t\t\t\t\t\tcurrentTool = t;\n\t\t\t\t\t\tdeselect(); // Deselect to allow drawing\n\t\t\t\t\t},\n\t\t\t\t\tonStrokeColorChange: (v: string) => {\n\t\t\t\t\t\tstrokeColor = v;\n\t\t\t\t\t\tselected?.node.setAttrs({ stroke: v });\n\t\t\t\t\t},\n\t\t\t\t\tonFillColorChange: (v: string) => {\n\t\t\t\t\t\tfillColor = v;\n\t\t\t\t\t\tselected?.node.setAttrs({ fill: v });\n\t\t\t\t\t},\n\t\t\t\t\tonDelete: () => deleteSelected(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === AnnotateControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\tif (!transformer) {\n\t\t\ttransformer = createTransformer(layer);\n\t\t}\n\t\tstage.on(names('mousedown'), onMouseDown);\n\t\tstage.on(names('mousemove'), onMouseMove);\n\t\tstage.on(names('mouseup'), onMouseUp);\n\t\tstage.on(names('click'), onStageClick);\n\t\tstage.on(names('dblclick'), onDblClick);\n\t\tstage.container().style.cursor = 'crosshair';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off(names('mousedown'));\n\t\tstage.off(names('mousemove'));\n\t\tstage.off(names('mouseup'));\n\t\tstage.off(names('click'));\n\t\tstage.off(names('dblclick'));\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\tdeselect();\n\t\tcurrentTool = null;\n\t\tisDrawing = false;\n\t\ttempNode = null;\n\t}\n\n\t// --- Drawing Handlers ---\n\tfunction onMouseDown(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\t// Don't draw if clicking on existing node\n\t\tif (e.target !== e.target.getStage()) return;\n\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer) return;\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\t\tif (!currentTool) return;\n\n\t\tdeselect();\n\t\tisDrawing = true;\n\t\tstartPos = pos;\n\n\t\tswitch (currentTool) {\n\t\t\tcase 'text': {\n\t\t\t\tconst txt = draw.createText(layer, pos.x, pos.y, 'Text', fontSize, strokeColor);\n\t\t\t\tconst item = finalizeNode(txt, 'text');\n\t\t\t\tselect(item);\n\t\t\t\tisDrawing = false; // Text is one-click\n\t\t\t\tcurrentTool = null; // Exit tool\n\t\t\t\tstartTextEdit(item.node as Konva.Text); // Immediately edit\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'rect':\n\t\t\t\ttempNode = draw.createRect(layer, pos.x, pos.y, 0, 0, strokeColor, fillColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'circle':\n\t\t\t\ttempNode = draw.createCircle(layer, pos.x, pos.y, 0, strokeColor, fillColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'line':\n\t\t\t\ttempNode = draw.createLine(layer, [pos.x, pos.y, pos.x, pos.y], strokeColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t\tcase 'arrow':\n\t\t\t\ttempNode = draw.createArrow(layer, [pos.x, pos.y, pos.x, pos.y], strokeColor, strokeWidth);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tfunction onMouseMove() {\n\t\tif (!isDrawing || !tempNode || !startPos) return;\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer) return;\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\n\t\tif (tempNode instanceof Konva.Rect) {\n\t\t\ttempNode.width(pos.x - startPos.x);\n\t\t\ttempNode.height(pos.y - startPos.y);\n\t\t} else if (tempNode instanceof Konva.Circle) {\n\t\t\tconst r = Math.hypot(pos.x - startPos.x, pos.y - startPos.y);\n\t\t\ttempNode.radius(r);\n\t\t} else if (tempNode instanceof Konva.Line || tempNode instanceof Konva.Arrow) {\n\t\t\t(tempNode as Konva.Line).points([startPos.x, startPos.y, pos.x, pos.y]);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction onMouseUp() {\n\t\tif (!isDrawing || !tempNode || !currentTool) return;\n\t\tisDrawing = false;\n\n\t\t// Finalize node\n\t\tconst item = finalizeNode(tempNode, currentTool);\n\t\tselect(item);\n\n\t\ttempNode = null;\n\t\tcurrentTool = null;\n\t\tstartPos = null;\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\tfunction onStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tif (isDrawing || currentTool) return;\n\t\t// Deselect if clicking on stage background\n\t\tif (e.target === e.target.getStage()) {\n\t\t\tdeselect();\n\t\t}\n\t}\n\n\tfunction onDblClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tconst node = e.target;\n\t\tif (node instanceof Konva.Text) {\n\t\t\tconst item = annotations.find((a) => a.node === node);\n\t\t\tif (item) {\n\t\t\t\tselect(item);\n\t\t\t\tstartTextEdit(item.node as Konva.Text);\n\t\t\t}\n\t\t}\n\t}\n\n\t// --- Helper Functions ---\n\tfunction finalizeNode(node: Konva.Node, kind: AnnotationKind): AnnotationItem {\n\t\tconst { layer } = imageEditorStore.state;\n\t\tif (!layer) throw new Error('No layer');\n\t\tnode.name(`annotation-${kind}`);\n\t\tnode.draggable(true);\n\t\tconst item = new AnnotationItem(crypto.randomUUID(), node, layer, kind);\n\t\titem.onSelect(() => select(item));\n\t\tannotations = [...annotations, item];\n\t\treturn item;\n\t}\n\n\tfunction startTextEdit(textNode: Konva.Text) {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage) return;\n\t\ttextNode.hide();\n\t\ttransformer?.hide();\n\t\tenableTextEdit(stage, textNode, (newValue) => {\n\t\t\ttextNode.text(newValue);\n\t\t\ttextNode.show();\n\t\t\ttransformer?.show();\n\t\t\ttransformer?.forceUpdate();\n\t\t\timageEditorStore.state.layer?.batchDraw();\n\t\t});\n\t}\n\n\tfunction select(item: AnnotationItem) {\n\t\tselected = item;\n\t\tif (!transformer) return;\n\t\tattachTransformer(transformer, item.node);\n\t}\n\n\tfunction deselect() {\n\t\tselected = null;\n\t\tif (!transformer) return;\n\t\tattachTransformer(transformer, null);\n\t}\n\n\tfunction deleteSelected() {\n\t\tif (!selected) return;\n\t\tconst id = selected.id;\n\t\tselected.destroy();\n\t\tannotations = annotations.filter((a) => a.id !== id);\n\t\tselected = null;\n\t\tdeselect(); // Hides transformer\n\t}\n\n\tfunction cleanupAnnotations(destroy = true) {\n\t\tdeselect();\n\t\tisDrawing = false;\n\t\tcurrentTool = null;\n\t\ttempNode = null;\n\t\tif (destroy) {\n\t\t\t[...annotations].forEach((a) => a.destroy());\n\t\t\tannotations = [];\n\t\t} else {\n\t\t\t// Hide UI for baking\n\t\t\tannotations.forEach((a) => a.disableInteraction());\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t\tcleanupAnnotations(true);\n\t\t\ttransformer?.destroy();\n\t\t\ttransformer = null;\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Annotate/index.ts\n * @description Annotate tool for Konva\n *\n * Features:\n * - Text\n * - Rectangle\n * - Circle\n * - Line\n * - Arrow\n * - Text editing\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'annotate',\n\ttitle: 'Annotate',\n\ticon: 'mdi:draw',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/BlurControls.svelte\n@component\nPintura-style controls for the Blur tool with add/delete/rotate/flip functionality.\n-->\n<script lang=\"ts\">\n\timport type { BlurPattern, BlurShape } from '@cms/components/imageEditor/widgets/Blur/regions';\n\n\tlet {\n\t\tblurStrength,\n\t\tshape,\n\t\tpattern,\n\t\thasActiveRegion = false,\n\t\tonStrengthChange,\n\t\tonShapeChange,\n\t\tonPatternChange,\n\t\tonAddRegion,\n\t\tonDeleteRegion,\n\t\tonRotateLeft,\n\t\tonRotateRight,\n\t\tonFlipHorizontal,\n\t\tonReset,\n\t\tonCancel,\n\t\tonApply\n\t}: {\n\t\tblurStrength: number;\n\t\tshape: BlurShape;\n\t\tpattern: BlurPattern;\n\t\thasActiveRegion?: boolean;\n\t\tonStrengthChange: (value: number) => void;\n\t\tonShapeChange: (value: BlurShape) => void;\n\t\tonPatternChange: (value: BlurPattern) => void;\n\t\tonAddRegion: () => void;\n\t\tonDeleteRegion: () => void;\n\t\tonRotateLeft: () => void;\n\t\tonRotateRight: () => void;\n\t\tonFlipHorizontal: () => void;\n\t\tonReset: () => void;\n\t\tonCancel: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n\n\tfunction handleStrengthInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tonStrengthChange(parseInt(target.value, 10));\n\t}\n</script>\n\n<div class=\"flex w-full items-center gap-3\">\n\t<!-- Add Region -->\n\t<button class=\"btn btn-sm preset-filled-primary-500\" onclick={onAddRegion} title=\"Add Blur Region\">\n\t\t<iconify-icon icon=\"mdi:plus\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Add</span>\n\t</button>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Shape Selection -->\n\t<span class=\"hidden text-sm sm:inline\">Shape:</span>\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={shape === 'rectangle'} onclick={() => onShapeChange('rectangle')} title=\"Rectangle\">\n\t\t\t<iconify-icon icon=\"mdi:crop-square\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn-sm\" class:active={shape === 'ellipse'} onclick={() => onShapeChange('ellipse')} title=\"Ellipse\">\n\t\t\t<iconify-icon icon=\"mdi:circle-outline\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Pattern Selection -->\n\t<span class=\"hidden text-sm sm:inline\">Pattern:</span>\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={pattern === 'blur'} onclick={() => onPatternChange('blur')} title=\"Blur\">\n\t\t\t<iconify-icon icon=\"mdi:blur\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn-sm\" class:active={pattern === 'pixelate'} onclick={() => onPatternChange('pixelate')} title=\"Pixelate\">\n\t\t\t<iconify-icon icon=\"mdi:grid\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Strength Slider -->\n\t<label class=\"flex items-center gap-2 text-sm\">\n\t\t<span class=\"hidden sm:inline\">{pattern === 'pixelate' ? 'Size:' : 'Strength:'}</span>\n\t\t<input\n\t\t\ttype=\"range\"\n\t\t\tmin=\"5\"\n\t\t\tmax={pattern === 'pixelate' ? 50 : 100}\n\t\t\tstep=\"1\"\n\t\t\tvalue={blurStrength}\n\t\t\toninput={handleStrengthInput}\n\t\t\tclass=\"range range-primary w-24\"\n\t\t/>\n\t\t<span class=\"w-6 text-right text-xs\">{blurStrength}</span>\n\t</label>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Transform Controls (Rotate/Flip) - Only enabled when region is active -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn btn-icon btn-sm\" onclick={onRotateLeft} title=\"Rotate Region Left\" disabled={!hasActiveRegion}>\n\t\t\t<iconify-icon icon=\"mdi:rotate-left\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm\" onclick={onRotateRight} title=\"Rotate Region Right\" disabled={!hasActiveRegion}>\n\t\t\t<iconify-icon icon=\"mdi:rotate-right\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm\" onclick={onFlipHorizontal} title=\"Flip Region\" disabled={!hasActiveRegion}>\n\t\t\t<iconify-icon icon=\"mdi:flip-horizontal\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<!-- Delete Selected Region -->\n\t<button class=\"btn btn-sm preset-outlined-error-500\" onclick={onDeleteRegion} title=\"Delete Selected Region\" disabled={!hasActiveRegion}>\n\t\t<iconify-icon icon=\"mdi:delete\"></iconify-icon>\n\t</button>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Action Buttons -->\n\t<button onclick={onReset} class=\"btn btn-sm preset-outlined-surface-500\">\n\t\t<iconify-icon icon=\"mdi:restore\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Reset</span>\n\t</button>\n\n\t<button onclick={onCancel} class=\"btn btn-sm preset-outlined-error-500\">\n\t\t<iconify-icon icon=\"mdi:close\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Cancel</span>\n\t</button>\n\n\t<button class=\"btn btn-sm preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span class=\"hidden sm:inline\">Apply</span>\n\t</button>\n</div>\n","/**\n * @files src/routes/(app)/imageEditor/widgets/Blur/regions.ts\n * @description BlurRegion encapsulates Konva nodes, clip mapping, caching strategy,\n * and lifecycle for one blur/pixelate region.\n *\n * Features:\n * - Rectangle and ellipse shapes\n * - Blur and pixelate patterns\n * - Interactive resizing and dragging\n * - Caching strategy for performance\n * - Fast updates for interactive feel\n */\n\nimport Konva from 'konva';\nimport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\nexport type BlurShape = 'rectangle' | 'ellipse';\nexport type BlurPattern = 'blur' | 'pixelate';\nexport type RegionInit = { x?: number; y?: number; width?: number; height?: number; shape?: BlurShape; pattern?: BlurPattern; strength?: number };\n\n/**\n * BlurRegion encapsulates Konva nodes, clip mapping, caching strategy,\n * and lifecycle for one blur/pixelate region.\n */\nexport class BlurRegion {\n\tid: string;\n\tshapeNode: Konva.Rect | Konva.Ellipse;\n\toverlay: Konva.Image;\n\toverlayGroup: Konva.Group;\n\ttransformer?: Konva.Transformer;\n\ttoolbar?: Konva.Group;\n\tprivate layer: Konva.Layer;\n\tprivate imageNode: Konva.Image;\n\tprivate imageGroup: Konva.Group;\n\tprivate currentPattern: BlurPattern;\n\tprivate currentStrength: number;\n\n\tprivate _onSelect: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\tprivate _onClone: (() => void) | null = null;\n\n\t// cache debounce timer per-region\n\tprivate _cacheTimer: number | null = null;\n\n\tconstructor(opts: { id: string; layer: Konva.Layer; imageNode: Konva.Image; imageGroup: Konva.Group; init?: RegionInit }) {\n\t\tthis.id = opts.id;\n\t\tthis.layer = opts.layer;\n\t\tthis.imageNode = opts.imageNode;\n\t\tthis.imageGroup = opts.imageGroup;\n\t\tconst init = opts.init || {};\n\t\tthis.currentPattern = init.pattern || 'blur';\n\t\tthis.currentStrength = init.strength || 20;\n\n\t\tconst w = init.width ?? 160;\n\t\tconst h = init.height ?? 120;\n\n\t\t// Positing relative to imageGroup center (0,0 is group center usually)\n\t\t// But imageNode is at (-w/2, -h/2).\n\t\t// Let's place it at 0,0 (center of image)\n\t\tconst x = init.x ?? 0;\n\t\tconst y = init.y ?? 0;\n\n\t\t// create visible wireframe shape\n\t\tif (init.shape === 'ellipse') {\n\t\t\tthis.shapeNode = new Konva.Ellipse({\n\t\t\t\tx,\n\t\t\t\ty,\n\t\t\t\tradiusX: w / 2,\n\t\t\t\tradiusY: h / 2,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1.5,\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'blurShape'\n\t\t\t});\n\t\t} else {\n\t\t\tthis.shapeNode = new Konva.Rect({\n\t\t\t\tx: x - w / 2,\n\t\t\t\ty: y - h / 2,\n\t\t\t\twidth: w,\n\t\t\t\theight: h,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1.5,\n\t\t\t\tfill: 'rgba(59, 130, 246, 0.2)', // style blue selection\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'blurShape'\n\t\t\t});\n\t\t}\n\t\tthis.shapeNode.id(this.id);\n\t\t// ADD SHAPE TO GROUP\n\t\tthis.imageGroup.add(this.shapeNode);\n\n\t\t// create overlay image (ideally a clone of current state)\n\t\tthis.overlay = new Konva.Image({\n\t\t\timage: this.imageNode.image(),\n\t\t\tlistening: false,\n\t\t\tname: 'blurOverlay',\n\t\t\t// Copy all visual attributes from the main image node\n\t\t\tx: this.imageNode.x(),\n\t\t\ty: this.imageNode.y(),\n\t\t\twidth: this.imageNode.width(),\n\t\t\theight: this.imageNode.height(),\n\t\t\tscaleX: this.imageNode.scaleX(),\n\t\t\tscaleY: this.imageNode.scaleY(),\n\t\t\trotation: this.imageNode.rotation(),\n\t\t\tcornerRadius: this.imageNode.cornerRadius()\n\t\t});\n\n\t\t// Create Group for clipping\n\t\tthis.overlayGroup = new Konva.Group({ listening: false });\n\t\tthis.overlayGroup.add(this.overlay);\n\n\t\t// ensure no filters initially\n\t\tthis.overlay.filters([]);\n\t\t// install clipFunc on GROUP\n\t\tthis.overlayGroup.clipFunc(this.makeClipFunc());\n\t\tthis.imageGroup.add(this.overlayGroup);\n\n\t\t// set predictable zIndex ordering within group\n\t\tthis.imageNode.zIndex(0);\n\t\tthis.overlayGroup.zIndex(1);\n\t\tthis.shapeNode.zIndex(2); // Shape node is now in imageGroup\n\t\tthis.layer.batchDraw();\n\n\t\t// bind events (fast updates only)\n\t\tthis.shapeNode.on('dragmove transform', () => {\n\t\t\tthis.updateToolbarPosition();\n\t\t\tthis.updateOverlayClip();\n\t\t\tthis.layer.batchDraw();\n\t\t});\n\n\t\t// Trigger initial pattern/strength for immediate feedback\n\t\tthis.setPattern(this.currentPattern);\n\t\tthis.setStrength(this.currentStrength);\n\t\tthis.shapeNode.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onSelect?.();\n\t\t});\n\t}\n\n\t// Update toolbar position (local space within imageGroup)\n\tprivate updateToolbarPosition() {\n\t\tif (!this.toolbar) return;\n\t\tconst n = this.shapeNode;\n\n\t\tlet localPt = { x: 0, y: 0 };\n\t\tif (n instanceof Konva.Rect) {\n\t\t\t// Bottom center of rect\n\t\t\tlocalPt = { x: n.width() / 2, y: n.height() + 20 };\n\t\t} else {\n\t\t\t// Bottom center of ellipse (radiusY is half-height)\n\t\t\tlocalPt = { x: 0, y: (n as Konva.Ellipse).radiusY() + 20 };\n\t\t}\n\n\t\t// Transform local point to parent (imageGroup) space\n\t\t// This accounts for rotation, scaling, and position of the shape\n\t\tconst pos = n.getTransform().point(localPt);\n\n\t\tthis.toolbar.position(pos);\n\t\tthis.toolbar.rotation(n.rotation());\n\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// Update overlay clip and cache (local group logic)\n\tprivate updateOverlayClip() {\n\t\t// Both shape and overlay are in imageGroup, at same root level\n\t\t// They share the same coordinate system.\n\t\tconst bounds = this.shapeNode.getSelfRect();\n\n\t\t// Buffer for the blur radius\n\t\tconst padding = this.currentStrength * 2;\n\n\t\t// Since overlay and shape are siblings in imageGroup,\n\t\t// and overlay is matched to imageNode position...\n\t\t// We need the shape relative to overlay.\n\t\tconst x = this.shapeNode.x() - this.overlay.x();\n\t\tconst y = this.shapeNode.y() - this.overlay.y();\n\n\t\tconst cacheRect = {\n\t\t\tx: x - padding,\n\t\t\ty: y - padding,\n\t\t\twidth: bounds.width + padding * 2,\n\t\t\theight: bounds.height + padding * 2\n\t\t};\n\n\t\tif (this._cacheTimer) window.clearTimeout(this._cacheTimer);\n\t\tthis._cacheTimer = window.setTimeout(() => {\n\t\t\ttry {\n\t\t\t\tthis.overlayGroup.clearCache();\n\t\t\t\tthis.overlayGroup.cache(cacheRect);\n\t\t\t\tthis.layer.batchDraw();\n\t\t\t} catch (e) {\n\t\t\t\t/* ignore cache errors */\n\t\t\t}\n\t\t\tthis._cacheTimer = null;\n\t\t}, 0);\n\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// create a clipFunc (local sibling logic)\n\tprivate makeClipFunc(): (ctx: CanvasRenderingContext2D) => void {\n\t\tconst shape = this.shapeNode;\n\t\t// const overlay = this.overlay;\n\t\treturn (ctx: CanvasRenderingContext2D) => {\n\t\t\t// They are siblings in imageGroup.\n\t\t\t// Offset shape's local transform by overlay's position.\n\t\t\tconst tr = shape.getTransform().copy();\n\t\t\t// tr.translate(-overlay.x(), -overlay.y()); // No longer needed as overlayGroup is at 0,0 relative to imageGroup parent\n\n\t\t\tconst m = tr.m;\n\t\t\tctx.setTransform(m[0], m[1], m[2], m[3], m[4], m[5]);\n\n\t\t\tif (shape instanceof Konva.Ellipse) {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.ellipse(0, 0, shape.radiusX(), shape.radiusY(), 0, 0, Math.PI * 2);\n\t\t\t\tctx.closePath();\n\t\t\t} else {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.rect(0, 0, shape.width(), shape.height());\n\t\t\t\tctx.closePath();\n\t\t\t}\n\t\t};\n\t}\n\n\t// set filter pattern and perform necessary re-cache (slow)\n\tsetPattern(pattern: BlurPattern) {\n\t\tthis.currentPattern = pattern;\n\t\tthis.overlay.filters([]);\n\t\tif (pattern === 'blur') {\n\t\t\tthis.overlay.filters([Konva.Filters.Blur]);\n\t\t} else {\n\t\t\tthis.overlay.filters([Konva.Filters.Pixelate]);\n\t\t}\n\t\tthis.setStrength(this.currentStrength);\n\t\tthis.updateOverlayClip(); // Triggers re-cache\n\t}\n\n\t// apply strength (fast)\n\tsetStrength(strength: number) {\n\t\tthis.currentStrength = strength;\n\t\tif (this.currentPattern === 'blur') {\n\t\t\tthis.overlay.blurRadius(strength);\n\t\t} else {\n\t\t\tthis.overlay.pixelSize(Math.max(1, Math.round(strength / 2)));\n\t\t}\n\t\tthis.updateOverlayClip(); // Fast debounce cache\n\t}\n\n\t// fast resize during drawing (no cache)\n\tresizeFromStart(start: { x: number; y: number }, pos: { x: number; y: number }) {\n\t\tconst width = pos.x - start.x;\n\t\tconst height = pos.y - start.y;\n\t\tif (this.shapeNode instanceof Konva.Ellipse) {\n\t\t\tthis.shapeNode.setAttrs({\n\t\t\t\tx: start.x + width / 2,\n\t\t\t\ty: start.y + height / 2,\n\t\t\t\tradiusX: Math.abs(width / 2),\n\t\t\t\tradiusY: Math.abs(height / 2)\n\t\t\t});\n\t\t} else {\n\t\t\tthis.shapeNode.setAttrs({\n\t\t\t\tx: width > 0 ? start.x : pos.x,\n\t\t\t\ty: height > 0 ? start.y : pos.y,\n\t\t\t\twidth: Math.abs(width),\n\t\t\t\theight: Math.abs(height)\n\t\t\t});\n\t\t}\n\t}\n\n\t// finalize region and attach a transformer (fast)\n\tfinalize() {\n\t\tthis.transformer = new Konva.Transformer({\n\t\t\tnodes: [this.shapeNode],\n\t\t\t// EXPLICIT HANDLES - Blue Circles\n\t\t\tanchorFill: '#3b82f6',\n\t\t\tanchorStroke: '#ffffff',\n\t\t\tanchorStrokeWidth: 2,\n\t\t\tanchorSize: 12, // Standard size\n\t\t\tanchorCornerRadius: 6,\n\n\t\t\t// EXPLICIT BORDER - Solid White\n\t\t\tborderStroke: '#ffffff',\n\t\t\tborderStrokeWidth: 1.5,\n\t\t\tborderDash: [],\n\n\t\t\trotateEnabled: true,\n\t\t\trotationSnaps: [0, 45, 90, 135, 180, 225, 270, 315],\n\t\t\trotateAnchorOffset: 25,\n\t\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\t\t\tkeepRatio: false,\n\t\t\tignoreStroke: true,\n\t\t\tboundBoxFunc: (oldBox, newBox) => {\n\t\t\t\treturn newBox.width < 10 || newBox.height < 10 ? oldBox : newBox;\n\t\t\t}\n\t\t});\n\t\tthis.transformer.on('dragend transformend', () => {\n\t\t\timageEditorStore.takeSnapshot();\n\t\t});\n\n\t\tthis.imageGroup.add(this.transformer); // ADDED TO GROUP\n\t\tthis.transformer.moveToTop();\n\n\t\t// Add dragend/transformend to take snapshot\n\t\tthis.shapeNode.on('dragend transformend', () => {\n\t\t\timageEditorStore.takeSnapshot();\n\t\t});\n\n\t\t// Create toolbar above the region\n\t\tthis.createToolbar();\n\t}\n\n\t// Create toolbar with clone/delete icons\n\tprivate createToolbar() {\n\t\tif (this.toolbar) this.toolbar.destroy();\n\n\t\tconst bounds = this.shapeNode.getClientRect();\n\t\tconst toolbarY = bounds.y - 45;\n\t\tconst toolbarX = bounds.x + bounds.width / 2;\n\n\t\tthis.toolbar = new Konva.Group({\n\t\t\tx: toolbarX,\n\t\t\ty: toolbarY,\n\t\t\tname: 'blurToolbar'\n\t\t});\n\n\t\t// Background\n\t\tconst bg = new Konva.Rect({\n\t\t\tx: -45,\n\t\t\ty: 0,\n\t\t\twidth: 90,\n\t\t\theight: 36,\n\t\t\tfill: '#1f2937',\n\t\t\tcornerRadius: 8,\n\t\t\tshadowColor: 'black',\n\t\t\tshadowBlur: 10,\n\t\t\tshadowOpacity: 0.4\n\t\t});\n\t\tthis.toolbar.add(bg);\n\n\t\t// Add icon (Plus)\n\t\tconst addGroup = new Konva.Group({ x: -22, y: 18, cursor: 'pointer' });\n\t\taddGroup.add(\n\t\t\tnew Konva.Path({\n\t\t\t\tdata: 'M12 4v16m8-8H4',\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 2,\n\t\t\t\tlineCap: 'round',\n\t\t\t\tscale: { x: 0.8, y: 0.8 },\n\t\t\t\toffset: { x: 12, y: 12 }\n\t\t\t})\n\t\t);\n\t\taddGroup.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onClone?.();\n\t\t});\n\t\taddGroup.on('mouseenter', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'pointer';\n\t\t});\n\t\taddGroup.on('mouseleave', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'crosshair';\n\t\t});\n\t\tthis.toolbar.add(addGroup);\n\n\t\t// Delete icon (Trash)\n\t\tconst deleteGroup = new Konva.Group({ x: 22, y: 18, cursor: 'pointer' });\n\t\tdeleteGroup.add(\n\t\t\tnew Konva.Path({\n\t\t\t\tdata: 'M3 6h18M9 6v12M15 6v12M5 6v14a2 2 0 002 2h10a2 2 0 002-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2',\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 2,\n\t\t\t\tscale: { x: 0.7, y: 0.7 },\n\t\t\t\toffset: { x: 12, y: 12 }\n\t\t\t})\n\t\t);\n\t\tdeleteGroup.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis.destroy();\n\t\t});\n\t\tdeleteGroup.on('mouseenter', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'pointer';\n\t\t});\n\t\tdeleteGroup.on('mouseleave', () => {\n\t\t\tconst stage = this.layer.getStage();\n\t\t\tif (stage) stage.container().style.cursor = 'crosshair';\n\t\t});\n\t\tthis.toolbar.add(deleteGroup);\n\n\t\tthis.imageGroup.add(this.toolbar); // ADDED TO GROUP\n\t\tthis.toolbar.zIndex(10);\n\t\tthis.updateToolbarPosition();\n\t}\n\n\t// detect tiny regions\n\tisTooSmall(): boolean {\n\t\tconst n = this.shapeNode;\n\t\tif (n instanceof Konva.Ellipse) return n.radiusX() < 10 || n.radiusY() < 10;\n\t\treturn n.width() < 20 || n.height() < 20;\n\t}\n\n\t// set active UI state\n\tsetActive(isActive: boolean) {\n\t\tif (this.transformer) this.transformer.visible(isActive);\n\t\tif (this.toolbar) this.toolbar.visible(isActive);\n\t\tif (isActive) {\n\t\t\tthis.transformer?.moveToTop();\n\t\t\tthis.toolbar?.moveToTop();\n\t\t\tthis.updateToolbarPosition();\n\t\t}\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// hide UI but keep overlay for baking\n\thideUI() {\n\t\tthis.transformer?.visible(false);\n\t\tthis.toolbar?.visible(false);\n\t\tthis.shapeNode.visible(false);\n\t}\n\n\t// clone overlay and its clipFunc for offscreen baking\n\tcloneForBake(): Konva.Group | null {\n\t\ttry {\n\t\t\tconst c = this.overlayGroup.clone();\n\t\t\treturn c;\n\t\t} catch (e) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tpublic rotate(deg: number) {\n\t\tthis.shapeNode.rotate(deg);\n\t\tthis.updateToolbarPosition();\n\t\tthis.updateOverlayClip();\n\t\tthis.layer.batchDraw();\n\t}\n\n\tpublic flipX() {\n\t\tthis.shapeNode.scaleX(this.shapeNode.scaleX() * -1);\n\t\tthis.updateToolbarPosition();\n\t\tthis.updateOverlayClip();\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// explicit destruction with listener removal\n\tdestroy() {\n\t\tthis.shapeNode.off('dragmove transform click tap');\n\t\tthis.transformer?.destroy();\n\t\tthis.toolbar?.destroy();\n\t\tthis.overlayGroup.destroy();\n\t\tthis.shapeNode.destroy();\n\t\tthis._onDestroy?.();\n\t}\n\n\t// callbacks\n\tonSelect(cb: () => void) {\n\t\tthis._onSelect = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n\tonClone(cb: () => void) {\n\t\tthis._onClone = cb;\n\t}\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Blur/Tool.svelte\n@component\nController for Blur tool: binds stage, manages BlurRegion instances,\nhandles drawing, applies/bakes effects, and registers toolbar.\n-->\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport Controls from './Controls.svelte';\n\timport { BlurRegion, type RegionInit, type BlurPattern, type BlurShape } from './regions';\n\n\t// reactive tool state (Svelte 5 runes)\n\tlet blurStrength = $state(20);\n\tlet pattern = $state<BlurPattern>('blur');\n\tlet shape = $state<BlurShape>('rectangle');\n\tlet regions = $state<BlurRegion[]>([]);\n\tlet activeId = $state<string | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// debounce timer for strength slider updates\n\tlet strengthDebounceTimer: number | null = null;\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'blur') {\n\t\t\tbindStageEvents();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: Controls,\n\t\t\t\tprops: {\n\t\t\t\t\tblurStrength,\n\t\t\t\t\tpattern,\n\t\t\t\t\tshape,\n\t\t\t\t\tonAdd: undefined, // Remove duplicates\n\t\t\t\t\tonDelete: undefined, // Remove duplicates\n\t\t\t\t\tonStrengthChange: (v: number) => {\n\t\t\t\t\t\tblurStrength = v;\n\t\t\t\t\t\tif (strengthDebounceTimer) clearTimeout(strengthDebounceTimer);\n\t\t\t\t\t\tstrengthDebounceTimer = window.setTimeout(() => {\n\t\t\t\t\t\t\t// ALWAYS update activeId if exists, or all regions\n\t\t\t\t\t\t\tif (activeId) {\n\t\t\t\t\t\t\t\tregions.find((r) => r.id === activeId)?.setStrength(v);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tregions.forEach((r) => r.setStrength(v));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\timageEditorStore.state.layer?.batchDraw();\n\t\t\t\t\t\t}, 30); // Fast feedback\n\t\t\t\t\t},\n\t\t\t\t\tonPatternChange: (p: BlurPattern) => {\n\t\t\t\t\t\tpattern = p;\n\t\t\t\t\t\tregions.forEach((r) => r.setPattern(p));\n\t\t\t\t\t},\n\t\t\t\t\tonShapeChange: (s: BlurShape) => {\n\t\t\t\t\t\tshape = s;\n\t\t\t\t\t\t// If there's an active region, change its shape\n\t\t\t\t\t\tif (activeId) {\n\t\t\t\t\t\t\tconst r = regions.find((x) => x.id === activeId);\n\t\t\t\t\t\t\tif (r) {\n\t\t\t\t\t\t\t\t// Remove old region and create new one with same position but new shape\n\t\t\t\t\t\t\t\tconst oldShape = r.shapeNode;\n\t\t\t\t\t\t\t\tconst bounds = oldShape.getClientRect();\n\t\t\t\t\t\t\t\tdeleteRegion(r.id);\n\t\t\t\t\t\t\t\tcreateRegion({\n\t\t\t\t\t\t\t\t\tx: bounds.x,\n\t\t\t\t\t\t\t\t\ty: bounds.y,\n\t\t\t\t\t\t\t\t\twidth: bounds.width,\n\t\t\t\t\t\t\t\t\theight: bounds.height,\n\t\t\t\t\t\t\t\t\tshape: s\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t// NEW: Add, Delete, Rotate, Flip handlers\n\t\t\t\t\tonAddRegion: () => {\n\t\t\t\t\t\tconst stage = imageEditorStore.state.stage;\n\t\t\t\t\t\tconst x = stage ? stage.width() / 2 : 100;\n\t\t\t\t\t\tconst y = stage ? stage.height() / 2 : 100;\n\t\t\t\t\t\tcreateRegion({ x, y });\n\t\t\t\t\t},\n\t\t\t\t\tonDeleteRegion: () => {\n\t\t\t\t\t\tif (activeId) deleteRegion(activeId);\n\t\t\t\t\t},\n\t\t\t\t\tonRotateLeft: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.rotate(-90);\n\t\t\t\t\t},\n\t\t\t\t\tonRotateRight: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.rotate(90);\n\t\t\t\t\t},\n\t\t\t\t\tonFlipHorizontal: () => {\n\t\t\t\t\t\tif (activeId) regions.find((x) => x.id === activeId)?.flipX();\n\t\t\t\t\t},\n\t\t\t\t\tonReset: () => reset(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: apply\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindStageEvents();\n\t\t\t// only clear toolbar if ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === Controls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// Auto-initialize first region if empty\n\t$effect(() => {\n\t\tif (_toolBound && regions.length === 0) {\n\t\t\tcreateRegion();\n\t\t}\n\t});\n\n\t// add stage event listeners once\n\tfunction bindStageEvents() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || _toolBound) return;\n\t\tstage.on('click tap', handleStageClick);\n\t\tif (stage.container()) stage.container().style.cursor = 'crosshair';\n\t\t_toolBound = true;\n\t}\n\n\t// remove stage event listeners once\n\tfunction unbindStageEvents() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\tstage.off('click tap', handleStageClick);\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\t_toolBound = false;\n\t}\n\n\t// deselect all regions when clicking outside overlays\n\tfunction handleStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tconst t = e.target;\n\t\tif (!stage) return;\n\t\t// If clicking on stage, base image, or its group - create a new region\n\t\tif (t === stage || t === imageNode || t === imageGroup) {\n\t\t\tconst pos = stage.getPointerPosition();\n\t\t\tif (pos) {\n\t\t\t\t// Create a new region at click position with default size\n\t\t\t\tcreateRegion({\n\t\t\t\t\tx: pos.x - 100,\n\t\t\t\t\ty: pos.y - 75,\n\t\t\t\t\twidth: 200,\n\t\t\t\t\theight: 150,\n\t\t\t\t\tshape\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t// create a new region and wire lifecycle hooks\n\tfunction createRegion(init?: Partial<RegionInit>) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\tconst newR = new BlurRegion({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageNode,\n\t\t\timageGroup,\n\t\t\tinit: { shape, pattern, strength: blurStrength, ...init }\n\t\t});\n\n\t\tregions = [...regions, newR];\n\t\tactiveId = newR.id;\n\n\t\tnewR.onSelect(() => selectRegion(newR.id));\n\t\tnewR.onClone(() => {\n\t\t\tconst bounds = newR.shapeNode.getClientRect();\n\t\t\tcreateRegion({\n\t\t\t\tx: bounds.x + 20,\n\t\t\t\ty: bounds.y + 20,\n\t\t\t\twidth: bounds.width,\n\t\t\t\theight: bounds.height,\n\t\t\t\tshape: newR.shapeNode instanceof Konva.Ellipse ? 'ellipse' : 'rectangle',\n\t\t\t\tpattern: pattern,\n\t\t\t\tstrength: blurStrength\n\t\t\t});\n\t\t});\n\t\tnewR.onDestroy(() => {\n\t\t\tregions = regions.filter((x) => x.id !== newR.id);\n\t\t\tif (activeId === newR.id) activeId = null;\n\t\t});\n\n\t\t// Always finalize and apply effects for click-created regions\n\t\tnewR.setPattern(pattern);\n\t\tnewR.setStrength(blurStrength);\n\t\tnewR.finalize();\n\n\t\t// Make the new region active to show handles\n\t\tselectRegion(newR.id);\n\t}\n\n\t// make specified region active and hide others\n\tfunction selectRegion(id: string) {\n\t\tactiveId = id;\n\t\tregions.forEach((r) => r.setActive(r.id === id));\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// delete a region instance\n\tfunction deleteRegion(id: string) {\n\t\tconst r = regions.find((x) => x.id === id);\n\t\tr?.destroy();\n\t}\n\n\t// hide or destroy all regions (used before bake and during reset)\n\tfunction cleanupBlurElements(destroyRegions = true) {\n\t\tif (destroyRegions) {\n\t\t\t[...regions].forEach((region) => region.destroy());\n\t\t\tregions = [];\n\t\t} else {\n\t\t\tregions.forEach((region) => region.hideUI());\n\t\t}\n\t\tactiveId = null;\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// reset tool state and remove regions\n\texport function reset() {\n\t\tcleanupBlurElements(true);\n\t}\n\n\t// Apply blur: bake all blur regions into the image\n\texport function apply() {\n\t\t// Hide UI elements before baking\n\t\tcleanupBlurElements(false);\n\n\t\t// Take snapshot with blur regions visible\n\t\timageEditorStore.takeSnapshot();\n\n\t\t// Clean up and exit\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// cleanup invoked by parent store\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindStageEvents();\n\t\t\tcleanupBlurElements(true);\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Blur/index.ts\n * @description Blur tool for Konva\n *\n * Features:\n * - Blur\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'blur',\n\ttitle: 'Blur',\n\ticon: 'mdi:blur',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/CropControls.svelte\n@component\nModern controls for the Crop tool. Injected into the master toolbar.\n-->\n<script lang=\"ts\">\n\tlet {\n\t\tonRotateLeft,\n\t\tonRotateRight,\n\t\tonFlipHorizontal,\n\t\tonCropShapeChange,\n\t\tonAspectRatio,\n\t\tonApply,\n\t\tonCancel,\n\t\tcropShape\n\t}: {\n\t\tonRotateLeft: () => void;\n\t\tonRotateRight: () => void;\n\t\tonFlipHorizontal: () => void;\n\t\tonCropShapeChange: (shape: 'rectangle' | 'circular') => void;\n\t\tonAspectRatio: (ratio: number | null) => void;\n\t\tonApply: () => void;\n\t\tonCancel: () => void;\n\t\tcropShape: 'rectangle' | 'circular';\n\t} = $props();\n</script>\n\n<div class=\"flex items-center gap-3\">\n\t<!-- Aspect Ratio Presets -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(null)}>Free</button>\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(1)}>1:1</button>\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(16 / 9)}>16:9</button>\n\t\t<button class=\"btn-sm\" onclick={() => onAspectRatio(4 / 3)}>4:3</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Shape -->\n\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t<button class=\"btn-sm\" class:active={cropShape === 'rectangle'} onclick={() => onCropShapeChange('rectangle')} title=\"Rectangle\">\n\t\t\t<iconify-icon icon=\"mdi:rectangle-outline\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn-sm\" class:active={cropShape === 'circular'} onclick={() => onCropShapeChange('circular')} title=\"Circle\">\n\t\t\t<iconify-icon icon=\"mdi:circle-outline\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Rotate & Flip -->\n\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateLeft} title=\"Rotate Left\">\n\t\t<iconify-icon icon=\"mdi:rotate-left\"></iconify-icon>\n\t</button>\n\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateRight} title=\"Rotate Right\">\n\t\t<iconify-icon icon=\"mdi:rotate-right\"></iconify-icon>\n\t</button>\n\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipHorizontal} title=\"Flip Horizontal\">\n\t\t<iconify-icon icon=\"mdi:flip-horizontal\"></iconify-icon>\n\t</button>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Cancel -->\n\t<button class=\"btn preset-outlined-error-500\" onclick={onCancel}>\n\t\t<iconify-icon icon=\"mdi:close\"></iconify-icon>\n\t\t<span>Cancel</span>\n\t</button>\n\n\t<!-- Apply -->\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Apply Crop</span>\n\t</button>\n</div>\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/aspect.ts\n * @description Aspect ratio parser for Konva\n *\n * Features:\n * - Parse aspect ratio string into numeric ratio or null\n */\nexport function parseAspectRatio(ratio: string | null): number | null {\n\tif (!ratio || ratio === 'free') return null;\n\tconst parts = ratio.split(':').map((p) => Number(p));\n\tif (parts.length !== 2 || Number.isNaN(parts[0]) || Number.isNaN(parts[1]) || parts[1] === 0) return null;\n\treturn parts[0] / parts[1];\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/highlight.ts\n * @description Highlight for Konva\n *\n * Features:\n * - Syncs the overlay cutout with the visible crop tool; optionally re-cache\n */\nimport Konva from 'konva';\n\n/** Syncs the overlay cutout with the visible crop tool; optionally re-cache */\nexport function syncHighlight(overlayGroup: Konva.Group, cropTool: Konva.Shape, shouldCache = true) {\n\tconst cut = overlayGroup.findOne('.cropCut') as Konva.Shape | undefined;\n\tif (!cut) return;\n\tif (cropTool instanceof Konva.Circle && cut instanceof Konva.Circle) {\n\t\tcut.position(cropTool.position());\n\t\tcut.radius((cropTool as Konva.Circle).radius());\n\t\tcut.rotation(cropTool.rotation());\n\t} else if (cropTool instanceof Konva.Rect && cut instanceof Konva.Rect) {\n\t\tcut.setAttrs({\n\t\t\tx: cropTool.x(),\n\t\t\ty: cropTool.y(),\n\t\t\twidth: cropTool.width() * cropTool.scaleX(),\n\t\t\theight: cropTool.height() * cropTool.scaleY(),\n\t\t\trotation: cropTool.rotation()\n\t\t});\n\t}\n\tif (shouldCache) {\n\t\tconst s = overlayGroup.getStage();\n\t\toverlayGroup.cache({ x: 0, y: 0, width: s?.width() ?? 0, height: s?.height() ?? 0, pixelRatio: 1 });\n\t}\n\toverlayGroup.getLayer()?.batchDraw();\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/region.ts\n * @description Regions for Crop tool\n *\n * Features:\n * - CropRegion encapsulates a single crop UI: overlay (cutout), tool border, transformer.\n */\nimport Konva from 'konva';\nimport { parseAspectRatio } from './aspect';\nimport { syncHighlight } from './highlight';\nimport { TRANSFORMER_STYLE_CROP, GRID_STYLE } from '../transformerConfig';\n\nexport type CropShape = 'rectangle' | 'square' | 'circular';\nexport type RegionInit = { x?: number; y?: number; width?: number; height?: number; shape?: CropShape; aspect?: string };\n\n/**\n * CropRegion encapsulates a single crop UI: overlay (cutout), tool border, transformer.\n */\nexport class CropRegion {\n\tid: string; // region id\n\tlayer: Konva.Layer; // owning layer\n\timageNode: Konva.Image; // reference to image node\n\timageGroup: Konva.Group; // reference to image group\n\n\tshape: Konva.Rect | Konva.Circle; // visible crop tool\n\toverlayGroup: Konva.Group; // cached overlay group that holds dark overlay + cutout\n\tgridGroup?: Konva.Group; // rule-of-thirds grid\n\ttransformer?: Konva.Transformer; // transformer for resize/rotate\n\tprivate aspect: string | null = null; // aspect ratio string\n\n\t// --- FIX: Event callback properties ---\n\tprivate _onTransform: (() => void) | null = null;\n\tprivate _onTransformEnd: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\n\tconstructor(opts: { id: string; layer: Konva.Layer; imageNode: Konva.Image; imageGroup: Konva.Group; init?: RegionInit }) {\n\t\tthis.id = opts.id;\n\t\tthis.layer = opts.layer;\n\t\tthis.imageNode = opts.imageNode;\n\t\tthis.imageGroup = opts.imageGroup;\n\t\tconst init = opts.init || {};\n\n\t\tthis.aspect = init.aspect ?? null;\n\n\t\t// create overlay group and shape\n\t\tthis.overlayGroup = new Konva.Group({ name: 'cropOverlayGroup' });\n\n\t\t// create dark full-screen rect (will be cached)\n\t\tconst stage = this.layer.getStage();\n\t\tconst sw = stage?.width() ?? 0;\n\t\tconst sh = stage?.height() ?? 0;\n\n\t\tconst dark = new Konva.Rect({ x: 0, y: 0, width: sw, height: sh, fill: 'rgba(0,0,0,0.8)', listening: false, name: 'cropOverlay' });\n\t\tthis.overlayGroup.add(dark);\n\n\t\t// compute initial size & center inside imageGroup visible area\n\t\tconst groupRect = this.imageGroup.getClientRect();\n\t\tconst size = Math.min(groupRect.width, groupRect.height) * 0.8;\n\t\tconst cx = groupRect.x + groupRect.width / 2;\n\t\tconst cy = groupRect.y + groupRect.height / 2;\n\n\t\tlet shapeWidth: number, shapeHeight: number;\n\t\tconst ratio = parseAspectRatio(this.aspect);\n\n\t\tif (ratio) {\n\t\t\tshapeWidth = size;\n\t\t\tshapeHeight = size / ratio;\n\t\t} else {\n\t\t\tshapeWidth = size;\n\t\t\tshapeHeight = size * 0.75; // Default freeform\n\t\t}\n\n\t\t// create cutout as circle or rect inside overlay group\n\t\tif (init.shape === 'circular') {\n\t\t\tconst radius = size / 2;\n\t\t\tconst cut = new Konva.Circle({\n\t\t\t\tx: cx,\n\t\t\t\ty: cy,\n\t\t\t\tradius: radius,\n\t\t\t\tfill: 'black',\n\t\t\t\tglobalCompositeOperation: 'destination-out',\n\t\t\t\tlistening: false,\n\t\t\t\tname: 'cropCut'\n\t\t\t});\n\t\t\tthis.overlayGroup.add(cut);\n\t\t\tthis.shape = new Konva.Circle({ x: cx, y: cy, radius: radius, stroke: 'white', strokeWidth: 3, draggable: true, name: 'cropTool' });\n\t\t} else {\n\t\t\tconst cut = new Konva.Rect({\n\t\t\t\tx: cx - shapeWidth / 2,\n\t\t\t\ty: cy - shapeHeight / 2,\n\t\t\t\twidth: shapeWidth,\n\t\t\t\theight: shapeHeight,\n\t\t\t\tfill: 'black',\n\t\t\t\tglobalCompositeOperation: 'destination-out',\n\t\t\t\tlistening: false,\n\t\t\t\tname: 'cropCut'\n\t\t\t});\n\t\t\tthis.overlayGroup.add(cut);\n\t\t\tthis.shape = new Konva.Rect({\n\t\t\t\tx: cx - shapeWidth / 2,\n\t\t\t\ty: cy - shapeHeight / 2,\n\t\t\t\twidth: shapeWidth,\n\t\t\t\theight: shapeHeight,\n\t\t\t\tstroke: 'white',\n\t\t\t\tstrokeWidth: 1,\n\t\t\t\tdraggable: true,\n\t\t\t\tname: 'cropTool'\n\t\t\t});\n\n\t\t\t// Create Grid for Rect\n\t\t\tthis.createGrid();\n\t\t}\n\n\t\t// cache overlay group to make globalCompositeOperation effect efficient\n\t\tthis.overlayGroup.cache({ x: 0, y: 0, width: sw, height: sh, pixelRatio: 1 });\n\t\tthis.layer.add(this.overlayGroup);\n\t\tthis.layer.add(this.shape);\n\n\t\t// layering: ensure imageGroup at bottom, overlay above image and shape above overlay\n\t\tthis.imageGroup.zIndex(0);\n\t\tthis.overlayGroup.zIndex(1);\n\t\tthis.gridGroup?.zIndex(2);\n\t\tthis.shape.zIndex(3);\n\n\t\t// ** FIX: Event wiring **\n\t\t// Wire up events to the internal callbacks\n\t\tthis.shape.on('dragmove transform', () => {\n\t\t\tthis._onTransform?.();\n\t\t\tthis.updateCutout(false); // Immediate shade update\n\t\t\tthis.updateGrid();\n\t\t});\n\t\tthis.shape.on('dragend transformend', () => {\n\t\t\tthis._onTransformEnd?.();\n\t\t});\n\t}\n\n\t/** Create 3x3 rule-of-thirds grid */\n\tprivate createGrid() {\n\t\tif (!(this.shape instanceof Konva.Rect)) return;\n\t\tif (this.gridGroup) this.gridGroup.destroy();\n\n\t\tthis.gridGroup = new Konva.Group({ listening: false });\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tthis.gridGroup.add(new Konva.Line({ name: `v${i}`, points: [0, 0, 0, 0], ...GRID_STYLE }));\n\t\t\tthis.gridGroup.add(new Konva.Line({ name: `h${i}`, points: [0, 0, 0, 0], ...GRID_STYLE }));\n\t\t}\n\t\tthis.layer.add(this.gridGroup);\n\t\tthis.updateGrid();\n\t}\n\n\t/** Update grid lines to match shape bounds */\n\tprivate updateGrid() {\n\t\tif (!this.gridGroup || !(this.shape instanceof Konva.Rect)) return;\n\n\t\tconst x = this.shape.x();\n\t\tconst y = this.shape.y();\n\t\tconst w = this.shape.width() * this.shape.scaleX();\n\t\tconst h = this.shape.height() * this.shape.scaleY();\n\n\t\t// Vertical lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst lx = x + (w * i) / 3;\n\t\t\tconst vLine = this.gridGroup.findOne(`.v${i}`) as Konva.Line;\n\t\t\tif (vLine) vLine.points([lx, y, lx, y + h]);\n\n\t\t\tconst ly = y + (h * i) / 3;\n\t\t\tconst hLine = this.gridGroup.findOne(`.h${i}`) as Konva.Line;\n\t\t\tif (hLine) hLine.points([x, ly, x + w, ly]);\n\t\t}\n\t}\n\n\t// ** FIX: Use the 'highlight.ts' util **\n\t// one-line comment: update cutout to match shape transform\n\tupdateCutout(shouldCache = true) {\n\t\tsyncHighlight(this.overlayGroup, this.shape, shouldCache);\n\t}\n\n\t// ** NEW: Helper to re-center region **\n\tcenterIn(rect: { x: number; y: number; width: number; height: number }) {\n\t\tconst cx = rect.x + rect.width / 2;\n\t\tconst cy = rect.y + rect.height / 2;\n\t\tthis.shape.position({ x: cx, y: cy });\n\t\tthis.transformer?.forceUpdate();\n\t}\n\n\t// one-line comment: attach transformer with aspect handling\n\tattachTransformer() {\n\t\tif (this.transformer) this.transformer.destroy();\n\t\tconst ratio = parseAspectRatio(this.aspect ?? 'free');\n\t\tconst keepRatio = this.shape instanceof Konva.Circle || this.aspect === '1:1' || (ratio !== null && typeof ratio === 'number');\n\n\t\tthis.transformer = new Konva.Transformer({\n\t\t\tnodes: [this.shape],\n\t\t\t...TRANSFORMER_STYLE_CROP,\n\t\t\tkeepRatio: keepRatio,\n\t\t\tenabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n\t\t\trotateEnabled: false, // Rotation is handled by the main tool\n\t\t\tboundBoxFunc: (oldBox, newBox) => {\n\t\t\t\tif (newBox.width < 30 || newBox.height < 30) return oldBox;\n\t\t\t\t// Enforce aspect ratio if set\n\t\t\t\tif (ratio && keepRatio && this.shape instanceof Konva.Rect) {\n\t\t\t\t\tnewBox.height = newBox.width / ratio;\n\t\t\t\t}\n\t\t\t\treturn newBox;\n\t\t\t}\n\t\t});\n\t\tthis.layer.add(this.transformer);\n\t\tthis.transformer.zIndex(4);\n\t\tthis.transformer.moveToTop();\n\t}\n\n\t// one-line comment: hide UI for baking\n\thideUI() {\n\t\tthis.transformer?.visible(false);\n\t\tthis.shape.visible(false);\n\t\tthis.gridGroup?.visible(false);\n\t\tthis.overlayGroup.visible(false); // Hide the whole overlay\n\t\tthis.layer.batchDraw();\n\t}\n\n\t// one-line comment: destroy region and call destructor\n\tdestroy() {\n\t\tthis.shape.off('dragmove transform dragend transformend');\n\t\tthis.transformer?.destroy();\n\t\tthis.gridGroup?.destroy();\n\t\tthis.overlayGroup.destroy();\n\t\tthis.shape.destroy();\n\t\tthis._onDestroy?.();\n\t}\n\n\t// --- FIX: Expose event setters ---\n\tonTransform(cb: () => void) {\n\t\tthis._onTransform = cb;\n\t}\n\tonTransformEnd(cb: () => void) {\n\t\tthis._onTransformEnd = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n}\n\nexport default CropRegion;\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Crop/Tool.svelte\n@component\n**Crop Tool \"Controller\"**\n\nOrchestrates the CropRegion, handles rotations/flips,\nand implements the correct 'apply' logic by setting the\nimageNode's 'crop' properties.\n-->\n<script lang=\"ts\">\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport CropControls from './Controls.svelte';\n\timport CropRegion, { type CropShape } from './regions';\n\timport { showToast } from '@shared/utils/toast';\n\n\tlet cropShape = $state<CropShape>('rectangle');\n\tlet aspectRatio = $state('free');\n\n\t// This is the *only* region. We don't use an array for crop.\n\tlet region = $state<CropRegion | null>(null);\n\n\tconst { onCancel }: { onCancel: () => void } = $props();\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'crop') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: CropControls,\n\t\t\t\tprops: {\n\t\t\t\t\tcropShape,\n\t\t\t\t\tonRotateLeft: rotateLeft,\n\t\t\t\t\tonRotateRight: rotateRight,\n\t\t\t\t\tonFlipHorizontal: flipHorizontal,\n\t\t\t\t\tonCropShapeChange: (s: CropShape) => {\n\t\t\t\t\t\tcropShape = s;\n\t\t\t\t\t\tif (s === 'square' || s === 'circular') {\n\t\t\t\t\t\t\taspectRatio = '1:1';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (s === 'circular') {\n\t\t\t\t\t\t\tshowToast('Round Crop selected. Image will be saved with transparency.', 'info');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tinitDefaultRegion();\n\t\t\t\t\t},\n\t\t\t\t\tonAspectRatio: (r: number | null) => {\n\t\t\t\t\t\taspectRatio = r === null ? 'free' : `${r}`;\n\t\t\t\t\t\tif (r === 1) {\n\t\t\t\t\t\t\tcropShape = cropShape === 'circular' ? 'circular' : 'square';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcropShape = 'rectangle';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tinitDefaultRegion();\n\t\t\t\t\t},\n\t\t\t\t\tonApply: apply,\n\t\t\t\t\tonCancel: () => onCancel()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\t// Only clear controls if they are ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === CropControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// add stage event listeners once\n\tfunction bindTool() {\n\t\tif (_toolBound) return;\n\t\t_toolBound = true;\n\t\t// Initialize the crop region when tool is activated\n\t\tinitDefaultRegion();\n\t}\n\n\t// remove stage event listeners once\n\tfunction unbindTool() {\n\t\tif (!_toolBound) return;\n\t\t_toolBound = false;\n\t\tcleanup(); // Destroy region when tool is deactivated\n\t}\n\n\t// create a new region and wire lifecycle hooks\n\tfunction initDefaultRegion() {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\t// Clean up old region first\n\t\tif (region) {\n\t\t\tregion.destroy();\n\t\t\tregion = null;\n\t\t}\n\n\t\tconst newRegion = new CropRegion({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageNode,\n\t\t\timageGroup,\n\t\t\tinit: { shape: cropShape as CropShape, aspect: aspectRatio }\n\t\t});\n\n\t\t// Wire event to update cutout on drag/transform\n\t\t// ** FIX 1: This is the 'desync' fix **\n\t\tnewRegion.onTransform(() => {\n\t\t\tnewRegion.updateCutout(false); // fast update, no cache\n\t\t});\n\t\tnewRegion.onTransformEnd(() => {\n\t\t\tnewRegion.updateCutout(true); // slow update, with cache\n\t\t});\n\n\t\tnewRegion.attachTransformer();\n\t\tregion = newRegion;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateLeft() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\t// Get current rotation and add -90\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation - 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipHorizontal() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleX(imageGroup.scaleX() * -1);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateRight() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\t// Get current rotation and add +90\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation + 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\n\t\t// We must also re-center the crop region\n\t\tif (region) {\n\t\t\tregion.centerIn(imageGroup.getClientRect());\n\t\t\tregion.updateCutout(true);\n\t\t}\n\t\tlayer.batchDraw();\n\t}\n\n\t// Apply crop: calculate the crop rect and set it on the imageNode\n\tfunction apply() {\n\t\tconst { imageNode, imageGroup, layer, stage } = imageEditorStore.state;\n\t\tif (!imageNode || !imageGroup || !region || !layer || !stage) return;\n\n\t\t// Import the cropMath utility\n\t\timport('./cropMath').then(({ stageRectToImageRect }) => {\n\t\t\t// Get the crop region's bounding box in stage coordinates\n\t\t\tconst cropRect = region!.shape.getClientRect();\n\n\t\t\t// Convert to image-local coordinates\n\t\t\tconst imageCrop = stageRectToImageRect(cropRect, imageNode, imageGroup);\n\n\t\t\t// Apply crop to the image node\n\t\t\timageNode.cropX(imageCrop.x);\n\t\t\timageNode.cropY(imageCrop.y);\n\t\t\timageNode.cropWidth(imageCrop.width);\n\t\t\timageNode.cropHeight(imageCrop.height);\n\n\t\t\t// Update image dimensions to match crop\n\t\t\timageNode.width(imageCrop.width);\n\t\t\timageNode.height(imageCrop.height);\n\n\t\t\t// Reset image position to center within the group\n\t\t\timageNode.x(-imageCrop.width / 2);\n\t\t\timageNode.y(-imageCrop.height / 2);\n\n\t\t\t// Handle round crop transparency\n\t\t\tif (cropShape === 'circular') {\n\t\t\t\timageNode.cornerRadius(Math.max(imageCrop.width, imageCrop.height));\n\t\t\t} else {\n\t\t\t\timageNode.cornerRadius(0);\n\t\t\t}\n\n\t\t\t// Recalculate scale to fit the cropped image in the viewport\n\t\t\tconst containerWidth = stage.width();\n\t\t\tconst containerHeight = stage.height();\n\t\t\tconst scaleX = (containerWidth * 0.8) / imageCrop.width;\n\t\t\tconst scaleY = (containerHeight * 0.8) / imageCrop.height;\n\t\t\tconst newScale = Math.min(scaleX, scaleY);\n\n\t\t\t// Reset imageGroup transform\n\t\t\timageGroup.scaleX(newScale);\n\t\t\timageGroup.scaleY(newScale);\n\t\t\timageGroup.rotation(0); // Reset rotation\n\t\t\timageGroup.x(containerWidth / 2);\n\t\t\timageGroup.y(containerHeight / 2);\n\n\t\t\t// Hide the crop UI\n\t\t\tregion!.hideUI();\n\n\t\t\t// Redraw and take snapshot\n\t\t\tlayer.batchDraw();\n\t\t\timageEditorStore.takeSnapshot();\n\t\t\timageEditorStore.setActiveState('');\n\t\t});\n\t}\n\n\t// cleanup invoked by parent store\n\texport function cleanup() {\n\t\tif (region) {\n\t\t\tregion.destroy();\n\t\t\tregion = null;\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n\n\t// --- Expose functions for Controls ---\n\t// These are now part of the props passed to setToolbarControls\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Crop/index.ts\n * @description Crop tool for Konva\n *\n * Features:\n * - Crop\n * - Namespacing events to avoid conflicts with other tools\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'crop',\n\ttitle: 'Crop',\n\ticon: 'mdi:crop',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/FineTuneControls.svelte\n@component\nControls for the FineTune tool, including a dropdown for adjustment type and a slider.\n-->\n<script lang=\"ts\">\n\timport type { Adjustments } from '@cms/components/imageEditor/widgets/FineTune/adjustments';\n\n\tconst {\n\t\tactiveAdjustment,\n\t\tvalue,\n\t\tonChange,\n\t\tonAdjustmentChange,\n\t\tonReset,\n\t\tonCancel,\n\t\tonApply\n\t}: {\n\t\tactiveAdjustment: keyof Adjustments;\n\t\tvalue: number;\n\t\tonChange: (value: number) => void;\n\t\tonAdjustmentChange: (key: keyof Adjustments) => void;\n\t\tonReset: () => void;\n\t\tonCancel: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n\n\tconst adjustments: { key: keyof Adjustments; label: string; icon: string }[] = [\n\t\t{ key: 'brightness', label: 'Brightness', icon: 'mdi:brightness-6' },\n\t\t{ key: 'contrast', label: 'Contrast', icon: 'mdi:contrast-box' },\n\t\t{ key: 'saturation', label: 'Saturation', icon: 'mdi:palette' },\n\t\t{ key: 'exposure', label: 'Exposure', icon: 'mdi:brightness-7' },\n\t\t{ key: 'highlights', label: 'Highlights', icon: 'mdi:white-balance-sunny' },\n\t\t{ key: 'shadows', label: 'Shadows', icon: 'mdi:weather-night' },\n\t\t{ key: 'temperature', label: 'Temperature', icon: 'mdi:thermometer' },\n\t\t{ key: 'clarity', label: 'Clarity', icon: 'mdi:crystal-ball' },\n\t\t{ key: 'vibrance', label: 'Vibrance', icon: 'mdi:vibrate' }\n\t];\n\n\tfunction handleSliderInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tonChange(parseInt(target.value, 10));\n\t}\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<!-- Adjustment Selector (Horizontal Scroll) -->\n\t<div class=\"flex-1 overflow-x-auto no-scrollbar py-1\">\n\t\t<div class=\"flex items-center gap-1 min-w-max px-2\">\n\t\t\t{#each adjustments as adj}\n\t\t\t\t<button\n\t\t\t\t\tclass=\"btn-sm preset-outlined-surface-500flex flex-col items-center gap-1 w-20 h-14\"\n\t\t\t\t\tclass:preset-filled-primary-500={activeAdjustment === adj.key}\n\t\t\t\t\tonclick={() => onAdjustmentChange(adj.key)}\n\t\t\t\t\ttitle={adj.label}\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon={adj.icon} width=\"18\"></iconify-icon>\n\t\t\t\t\t<span class=\"text-[10px] uppercase tracking-tighter leading-none\">{adj.label}</span>\n\t\t\t\t</button>\n\t\t\t{/each}\n\t\t</div>\n\t</div>\n\n\t<!-- Slider -->\n\t<div class=\"w-48 px-2 flex flex-col gap-1\">\n\t\t<div class=\"flex justify-between text-[10px] text-surface-500 uppercase font-bold\">\n\t\t\t<span>{adjustments.find((a) => a.key === activeAdjustment)?.label}</span>\n\t\t\t<span class={value !== 0 ? 'text-primary-500' : ''}>{value}</span>\n\t\t</div>\n\t\t<input type=\"range\" min=\"-100\" max=\"100\" step=\"1\" {value} oninput={handleSliderInput} class=\"range range-primary range-sm\" />\n\t</div>\n\n\t<!-- Reset -->\n\t<button onclick={onReset} class=\"btn-sm btn-icon preset-outlined-surface-500\" title=\"Reset this adjustment\" disabled={value === 0}>\n\t\t<iconify-icon icon=\"mdi:restore\"></iconify-icon>\n\t</button>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Cancel -->\n\t<button class=\"btn preset-outlined-error-500\" onclick={onCancel}>\n\t\t<iconify-icon icon=\"mdi:close\"></iconify-icon>\n\t\t<span>Cancel</span>\n\t</button>\n\n\t<!-- Apply -->\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Apply</span>\n\t</button>\n</div>\n\n<style>\n\t.no-scrollbar::-webkit-scrollbar {\n\t\tdisplay: none;\n\t}\n\t.no-scrollbar {\n\t\t-ms-overflow-style: none;\n\t\tscrollbar-width: none;\n\t}\n</style>\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/controls/adjustments.ts\n * @description Central adjustment definitions used by FineTune tool.\n *\n * Features:\n * - Central adjustment definitions used by FineTune tool.\n */\nexport interface Adjustments {\n\tbrightness: number;\n\tcontrast: number;\n\tsaturation: number;\n\ttemperature: number;\n\texposure: number;\n\thighlights: number;\n\tshadows: number;\n\tclarity: number;\n\tvibrance: number;\n}\n\nexport const DEFAULT_ADJUSTMENTS: Adjustments = {\n\tbrightness: 0,\n\tcontrast: 0,\n\tsaturation: 0,\n\ttemperature: 0,\n\texposure: 0,\n\thighlights: 0,\n\tshadows: 0,\n\tclarity: 0,\n\tvibrance: 0\n};\n\nexport const ADJUSTMENT_OPTIONS = [\n\t{ key: 'brightness', label: 'Brightness' },\n\t{ key: 'contrast', label: 'Contrast' },\n\t{ key: 'saturation', label: 'Saturation' },\n\t{ key: 'temperature', label: 'Temperature' },\n\t{ key: 'exposure', label: 'Exposure' },\n\t{ key: 'highlights', label: 'Highlights' },\n\t{ key: 'shadows', label: 'Shadows' },\n\t{ key: 'clarity', label: 'Clarity' },\n\t{ key: 'vibrance', label: 'Vibrance' }\n] as const;\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/filters/baseFilters.ts\n * @description Applies standard Konva provided filters.\n *\n * Features:\n * - Applies standard Konva provided filters.\n */\nimport Konva from 'konva';\nimport type { Adjustments } from './adjustments';\n\n/**\n * Applies fast, Konva-native filters (non-pixel-looping)\n * to the image node.\n */\nexport function applyBaseFilters(node: Konva.Image, adj: Adjustments) {\n\tnode.brightness(adj.brightness / 100);\n\tnode.contrast(adj.contrast / 100);\n\n\t// Combine saturation and vibrance\n\t// Vibrance is a \"smart\" saturation, apply it at a lower intensity\n\tconst combinedSaturation = (adj.saturation + adj.vibrance * 0.7) / 100;\n\tnode.saturation(combinedSaturation);\n\n\t// Konva has HSL filters, but they are often less intuitive\n\t// for 'saturation' than the built-in property.\n}\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/filters/customFilters.ts\n * @description Custom pixel-level filter logic for exposure, shadows, clarity.\n *\n * Features:\n * - Custom pixel-level filter logic for exposure, shadows, clarity.\n */\nimport type { Adjustments } from './adjustments';\n\n/**\n * Creates a slow, pixel-looping filter function for Konva\n * to handle adjustments not built-in (exposure, shadows, etc.).\n */\nexport function createCustomFilter(adj: Adjustments) {\n\t// Pre-calculate factors for performance\n\tconst expFactor = 1 + adj.exposure / 100;\n\tconst highFactor = 1 + adj.highlights / 100;\n\tconst shadowFactor = 1 + adj.shadows / 100;\n\tconst clarityFactor = 1 + adj.clarity / 100;\n\tconst mid = 128;\n\n\treturn function (imageData: ImageData) {\n\t\tconst data = imageData.data;\n\n\t\tfor (let i = 0; i < data.length; i += 4) {\n\t\t\tlet r = data[i];\n\t\t\tlet g = data[i + 1];\n\t\t\tlet b = data[i + 2];\n\n\t\t\t// 1. Exposure (simple multiply)\n\t\t\tif (adj.exposure !== 0) {\n\t\t\t\tr *= expFactor;\n\t\t\t\tg *= expFactor;\n\t\t\t\tb *= expFactor;\n\t\t\t}\n\n\t\t\t// Get perceived brightness (luminance)\n\t\t\tconst brightness = 0.299 * r + 0.587 * g + 0.114 * b;\n\n\t\t\t// 2. Highlights (affect bright areas)\n\t\t\tif (adj.highlights !== 0 && brightness > 150) {\n\t\t\t\t// Target brights\n\t\t\t\tconst highAmount = (brightness - 150) / 105; // 0..1\n\t\t\t\tconst factor = 1 + (highFactor - 1) * highAmount;\n\t\t\t\tr *= factor;\n\t\t\t\tg *= factor;\n\t\t\t\tb *= factor;\n\t\t\t}\n\n\t\t\t// 3. Shadows (affect dark areas)\n\t\t\tif (adj.shadows !== 0 && brightness < 100) {\n\t\t\t\t// Target darks\n\t\t\t\tconst shadowAmount = (100 - brightness) / 100; // 0..1\n\t\t\t\tconst factor = 1 + (shadowFactor - 1) * shadowAmount;\n\t\t\t\tr *= factor;\n\t\t\t\tg *= factor;\n\t\t\t\tb *= factor;\n\t\t\t}\n\n\t\t\t// 4. Clarity (increases mid-tone contrast)\n\t\t\tif (adj.clarity !== 0) {\n\t\t\t\tr = mid + (r - mid) * clarityFactor;\n\t\t\t\tg = mid + (g - mid) * clarityFactor;\n\t\t\t\tb = mid + (b - mid) * clarityFactor;\n\t\t\t}\n\n\t\t\t// 5. Temperature (Warm/Cool)\n\t\t\tif (adj.temperature !== 0) {\n\t\t\t\tconst shift = (adj.temperature / 100) * 20; // Max 20 unit shift\n\t\t\t\tr += shift;\n\t\t\t\tb -= shift;\n\t\t\t}\n\n\t\t\t// Clamp values\n\t\t\tdata[i] = Math.min(255, Math.max(0, r));\n\t\t\tdata[i + 1] = Math.min(255, Math.max(0, g));\n\t\t\tdata[i + 2] = Math.min(255, Math.max(0, b));\n\t\t}\n\t};\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/FineTune/Tool.svelte\n@component\n**Fine-Tune \"Controller\" Component**\n\nOrchestrates the filter modules:\n- Manages $state for all adjustments.\n- Registers the toolbar UI.\n- Applies filters (base + custom) in a debounced $effect.\n- Handles \"Compare\" logic using Konva's cache.\n- Implements the final 'apply' (bake) logic.\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport FineTuneControls from './Controls.svelte';\n\timport { type Adjustments, DEFAULT_ADJUSTMENTS } from './adjustments';\n\timport { applyBaseFilters } from './baseFilters';\n\timport { createCustomFilter } from './customFilters';\n\n\t// --- Svelte 5 State ---\n\tlet adjustments = $state({ ...DEFAULT_ADJUSTMENTS });\n\tlet activeAdjustment = $state<keyof Adjustments>('brightness');\n\n\tconst adjustments_list = [\n\t\t{ key: 'brightness', label: 'Brightness', icon: 'mdi:brightness-6' },\n\t\t{ key: 'contrast', label: 'Contrast', icon: 'mdi:contrast-box' },\n\t\t{ key: 'saturation', label: 'Saturation', icon: 'mdi:palette' },\n\t\t{ key: 'exposure', label: 'Exposure', icon: 'mdi:brightness-7' },\n\t\t{ key: 'highlights', label: 'Highlights', icon: 'mdi:white-balance-sunny' },\n\t\t{ key: 'shadows', label: 'Shadows', icon: 'mdi:weather-night' },\n\t\t{ key: 'temperature', label: 'Temperature', icon: 'mdi:thermometer' },\n\t\t{ key: 'clarity', label: 'Clarity', icon: 'mdi:crystal-ball' },\n\t\t{ key: 'vibrance', label: 'Vibrance', icon: 'mdi:vibrate' }\n\t];\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\n\t// debounce timer for slider updates\n\tlet filterDebounceTimer: number | null = null;\n\n\t// --- Lifecycle $effect ---\n\t// Binds/unbounds the tool and registers the toolbar\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'finetune') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: FineTuneControls,\n\t\t\t\tprops: {\n\t\t\t\t\tactiveAdjustment: activeAdjustment,\n\t\t\t\t\tactiveIcon: adjustments_list.find((a) => a.key === activeAdjustment)?.icon,\n\t\t\t\t\tvalue: adjustments[activeAdjustment],\n\t\t\t\t\tonChange: (value: number) => {\n\t\t\t\t\t\tadjustments[activeAdjustment] = value;\n\t\t\t\t\t},\n\t\t\t\t\tonAdjustmentChange: (key: keyof Adjustments) => {\n\t\t\t\t\t\tactiveAdjustment = key;\n\t\t\t\t\t},\n\t\t\t\t\tonReset: () => resetAdjustment(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === FineTuneControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Core Filter Logic ---\n\t// This $effect watches for adjustment changes,\n\t// debounces them, and applies the Konva filters.\n\t$effect(() => {\n\t\tif (!_toolBound) return;\n\n\t\t// Force dependency tracking by reading adjustments state here\n\t\tconst currentAdjustments = JSON.parse(JSON.stringify(adjustments));\n\n\t\t// Debounce to prevent thrashing on slider drag\n\t\tif (filterDebounceTimer) clearTimeout(filterDebounceTimer);\n\n\t\tfilterDebounceTimer = window.setTimeout(() => {\n\t\t\tconst { imageNode, layer } = imageEditorStore.state;\n\t\t\tif (!imageNode || !layer) return;\n\n\t\t\t// Log for debugging\n\t\t\tconsole.log('Applying FineTune adjustments:', currentAdjustments);\n\n\t\t\t// 1. Prepare filter list\n\t\t\tconst activeFilters = [];\n\n\t\t\t// Base Konva filters (Brighten, Contrast, HSL for saturation/hue)\n\t\t\tactiveFilters.push(Konva.Filters.Brighten);\n\t\t\tactiveFilters.push(Konva.Filters.Contrast);\n\t\t\tactiveFilters.push(Konva.Filters.HSL);\n\n\t\t\t// 2. Check for slow, custom pixel-looping filters\n\t\t\tconst needsCustom =\n\t\t\t\tadjustments.exposure !== 0 ||\n\t\t\t\tadjustments.highlights !== 0 ||\n\t\t\t\tadjustments.shadows !== 0 ||\n\t\t\t\tadjustments.clarity !== 0 ||\n\t\t\t\tadjustments.temperature !== 0;\n\t\t\tif (needsCustom) {\n\t\t\t\tactiveFilters.push(createCustomFilter(currentAdjustments));\n\t\t\t}\n\n\t\t\t// 3. Set filters on node\n\t\t\timageNode.filters(activeFilters);\n\n\t\t\t// 4. Update the actual properties (brightness, contrast, saturation, hue)\n\t\t\tapplyBaseFilters(imageNode, currentAdjustments);\n\n\t\t\t// 5. Re-cache the node to apply all filters\n\t\t\timageNode.clearCache();\n\t\t\timageNode.cache();\n\t\t\tlayer.batchDraw();\n\t\t}, 100); // 100ms debounce\n\t});\n\n\tfunction bindTool() {\n\t\tif (_toolBound) return;\n\t\t_toolBound = true;\n\t\t// Save the current state (which should be 0s) as the 'reset' point\n\t\tadjustments = { ...DEFAULT_ADJUSTMENTS };\n\t}\n\n\tfunction unbindTool() {\n\t\tif (!_toolBound) return;\n\t\t_toolBound = false;\n\t\tif (filterDebounceTimer) clearTimeout(filterDebounceTimer);\n\t}\n\n\t/**\n\t * Toggles comparison view.\n\t * This is the *most efficient* way:\n\t * - clearCache() reverts to the pre-filter image.\n\t * - cache() re-applies the filters.\n\t */\n\tfunction resetAdjustment() {\n\t\tadjustments[activeAdjustment] = 0;\n\t}\n\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/FineTune/index.ts\n * @description Registers the FineTune tool and its controls.\n *\n * Features:\n * - Registers the FineTune tool and its controls.\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'finetune',\n\ttitle: 'Fine-Tune',\n\ticon: 'mdi:tune',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","<!--\n@file src/components/imageEditor/toolbars/FocalPointControls.svelte\n@component\nToolbar controls for the FocalPoint widget\n-->\n\n<script lang=\"ts\">\n\tinterface Props {\n\t\tfocalX?: number;\n\t\tfocalY?: number;\n\t\tonReset?: () => void;\n\t\tonApply?: () => void;\n\t\tonCancel?: () => void;\n\t}\n\n\tconst { focalX = 50, focalY = 50, onReset = () => {}, onApply = () => {}, onCancel = () => {} }: Props = $props();\n</script>\n\n<div class=\"flex items-center gap-4 flex-wrap\">\n\t<!-- Focal Point Coordinates -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm font-medium\">Focal Point:</span>\n\t\t<div class=\"flex items-center gap-1\">\n\t\t\t<span class=\"badge variant-soft-primary text-xs\">X: {focalX}%</span>\n\t\t\t<span class=\"badge variant-soft-primary text-xs\">Y: {focalY}%</span>\n\t\t</div>\n\t</div>\n\n\t<!-- Instructions -->\n\t<span class=\"text-xs text-surface-600 dark:text-surface-50\"> Click on the image to set focal point </span>\n\n\t<!-- Spacer -->\n\t<div class=\"flex-1\"></div>\n\n\t<!-- Actions -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<button onclick={onReset} class=\"btn preset-outlined-surface-500btn-sm\" title=\"Reset to center\">\n\t\t\t<iconify-icon icon=\"mdi:restore\" width=\"18\"></iconify-icon>\n\t\t\t<span>Reset</span>\n\t\t</button>\n\n\t\t<button onclick={onCancel} class=\"btn preset-outlined-error-500 btn-sm\" title=\"Discard changes\">\n\t\t\t<iconify-icon icon=\"mdi:close\" width=\"18\"></iconify-icon>\n\t\t\t<span>Cancel</span>\n\t\t</button>\n\n\t\t<button onclick={onApply} class=\"btn preset-filled-primary-500 btn-sm\" title=\"Apply focal point\">\n\t\t\t<iconify-icon icon=\"mdi:check\" width=\"18\"></iconify-icon>\n\t\t\t<span>Apply</span>\n\t\t</button>\n\t</div>\n</div>\n","<!--\n@file src/components/imageEditor/widgets/FocalPoint/Tool.svelte\n@component\n**FocalPoint Tool**\n\nAllows users to set the focal point of an image with rule of thirds grid overlay.\n- Displays rule of thirds grid\n- Click to set focal point\n- Shows crosshair at focal point\n- Updates toolbar with X/Y coordinates\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport FocalPointControls from './Controls.svelte';\n\n\t// --- Svelte 5 State ---\n\tlet focalPoint = $state<{ x: number; y: number }>({ x: 0.5, y: 0.5 }); // Normalized 0-1\n\tlet gridLayer = $state<Konva.Layer | null>(null);\n\tlet crosshair = $state<Konva.Group | null>(null);\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\tlet { onCancel }: { onCancel: () => void } = $props();\n\n\t// --- Lifecycle $effect ---\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'focalpoint') {\n\t\t\tbindTool();\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: FocalPointControls,\n\t\t\t\tprops: {\n\t\t\t\t\tfocalX: Math.round(focalPoint.x * 100),\n\t\t\t\t\tfocalY: Math.round(focalPoint.y * 100),\n\t\t\t\t\tonReset: () => resetFocalPoint(),\n\t\t\t\t\tonCancel: () => onCancel(),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === FocalPointControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, imageNode } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\t// Get existing focal point from metadata\n\t\tconst metadata = (imageNode as any).metadata;\n\t\tif (metadata?.focalPoint) {\n\t\t\tfocalPoint = { ...metadata.focalPoint };\n\t\t}\n\n\t\t// Create grid overlay\n\t\tcreateGridOverlay();\n\t\tcreateCrosshair();\n\n\t\t// Bind click event\n\t\tstage.on('click.focalpoint tap.focalpoint', onStageClick);\n\t\tstage.container().style.cursor = 'crosshair';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off('click.focalpoint tap.focalpoint');\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\n\t\t// Remove grid overlay\n\t\tgridLayer?.destroy();\n\t\tgridLayer = null;\n\t\tcrosshair = null;\n\t}\n\n\t// --- Grid Overlay ---\n\tfunction createGridOverlay() {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || !imageGroup) return;\n\n\t\t// Create a new layer for the grid (on top of everything)\n\t\tgridLayer = new Konva.Layer();\n\t\tstage.add(gridLayer);\n\t\tgridLayer.moveToTop();\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst imageX = imageGroup.x();\n\t\tconst imageY = imageGroup.y();\n\n\t\t// Calculate actual top-left of image (accounting for centering in group)\n\t\tconst originX = imageX - imageWidth / 2;\n\t\tconst originY = imageY - imageHeight / 2;\n\n\t\t// Draw rule of thirds grid\n\t\tconst lineColor = '#00ff00';\n\t\tconst lineWidth = 1;\n\t\tconst opacity = 0.7;\n\n\t\t// Vertical lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst x = originX + (imageWidth / 3) * i;\n\t\t\tconst line = new Konva.Line({\n\t\t\t\tpoints: [x, originY, x, originY + imageHeight],\n\t\t\t\tstroke: lineColor,\n\t\t\t\tstrokeWidth: lineWidth,\n\t\t\t\topacity: opacity,\n\t\t\t\tlistening: false\n\t\t\t});\n\t\t\tgridLayer.add(line);\n\t\t}\n\n\t\t// Horizontal lines\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tconst y = originY + (imageHeight / 3) * i;\n\t\t\tconst line = new Konva.Line({\n\t\t\t\tpoints: [originX, y, originX + imageWidth, y],\n\t\t\t\tstroke: lineColor,\n\t\t\t\tstrokeWidth: lineWidth,\n\t\t\t\topacity: opacity,\n\t\t\t\tlistening: false\n\t\t\t});\n\t\t\tgridLayer.add(line);\n\t\t}\n\n\t\tgridLayer.batchDraw();\n\t}\n\n\tfunction createCrosshair() {\n\t\tconst { imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!gridLayer || !imageNode || !imageGroup) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst imageX = imageGroup.x();\n\t\tconst imageY = imageGroup.y();\n\n\t\t// Calculate actual top-left of image (accounting for centering in group)\n\t\tconst originX = imageX - imageWidth / 2;\n\t\tconst originY = imageY - imageHeight / 2;\n\n\t\t// Calculate crosshair position\n\t\tconst x = originX + imageWidth * focalPoint.x;\n\t\tconst y = originY + imageHeight * focalPoint.y;\n\n\t\t// Create crosshair group\n\t\tcrosshair = new Konva.Group({\n\t\t\tx: x,\n\t\t\ty: y,\n\t\t\tlistening: false\n\t\t});\n\n\t\t// Crosshair lines\n\t\tconst size = 20;\n\t\tconst color = '#ff0000';\n\t\tconst width = 2;\n\n\t\tconst hLine = new Konva.Line({\n\t\t\tpoints: [-size, 0, size, 0],\n\t\t\tstroke: color,\n\t\t\tstrokeWidth: width\n\t\t});\n\n\t\tconst vLine = new Konva.Line({\n\t\t\tpoints: [0, -size, 0, size],\n\t\t\tstroke: color,\n\t\t\tstrokeWidth: width\n\t\t});\n\n\t\t// Center circle\n\t\tconst circle = new Konva.Circle({\n\t\t\tradius: 4,\n\t\t\tfill: color,\n\t\t\tstroke: '#ffffff',\n\t\t\tstrokeWidth: 2\n\t\t});\n\n\t\tcrosshair.add(hLine, vLine, circle);\n\t\tgridLayer.add(crosshair);\n\t\tgridLayer.batchDraw();\n\t}\n\n\t// --- Event Handlers ---\n\tfunction onStageClick() {\n\t\tconst { stage, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !imageNode || !imageGroup) return;\n\n\t\tconst pos = stage.getPointerPosition();\n\t\tif (!pos) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst originX = imageGroup.x() - imageWidth / 2;\n\t\tconst originY = imageGroup.y() - imageHeight / 2;\n\n\t\t// Check if click is within image bounds\n\t\tif (pos.x < originX || pos.x > originX + imageWidth || pos.y < originY || pos.y > originY + imageHeight) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Calculate normalized focal point (0-1)\n\t\tfocalPoint = {\n\t\t\tx: (pos.x - originX) / imageWidth,\n\t\t\ty: (pos.y - originY) / imageHeight\n\t\t};\n\n\t\t// Update crosshair position\n\t\tupdateCrosshair();\n\n\t\t// Update toolbar (reactive)\n\t\timageEditorStore.setToolbarControls({\n\t\t\tcomponent: FocalPointControls,\n\t\t\tprops: {\n\t\t\t\tfocalX: Math.round(focalPoint.x * 100),\n\t\t\t\tfocalY: Math.round(focalPoint.y * 100),\n\t\t\t\tonReset: () => resetFocalPoint(),\n\t\t\t\tonApply: () => apply()\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction updateCrosshair() {\n\t\tconst { imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!crosshair || !imageNode || !imageGroup) return;\n\n\t\tconst imageWidth = imageNode.width() * imageNode.scaleX();\n\t\tconst imageHeight = imageNode.height() * imageNode.scaleY();\n\t\tconst originX = imageGroup.x() - imageWidth / 2;\n\t\tconst originY = imageGroup.y() - imageHeight / 2;\n\n\t\tconst x = originX + imageWidth * focalPoint.x;\n\t\tconst y = originY + imageHeight * focalPoint.y;\n\n\t\tcrosshair.position({ x, y });\n\t\tgridLayer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction resetFocalPoint() {\n\t\tfocalPoint = { x: 0.5, y: 0.5 };\n\t\tupdateCrosshair();\n\t}\n\n\tfunction apply() {\n\t\tconst { imageNode } = imageEditorStore.state;\n\t\tif (!imageNode) return;\n\n\t\t// Save focal point to image metadata\n\t\t(imageNode as any).metadata = {\n\t\t\t...(imageNode as any).metadata,\n\t\t\tfocalPoint: { ...focalPoint }\n\t\t};\n\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\n\texport function saveState() {}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<!-- No UI needed, all controls in toolbar and grid overlay -->\n","/**\n * @file src/components/imageEditor/widgets/FocalPoint/index.ts\n * @description FocalPoint widget registration\n */\n\nimport type { EditorWidget } from '../registry';\nimport Tool from './Tool.svelte';\n\nexport const editorWidget: EditorWidget = {\n\tkey: 'focalpoint',\n\ttitle: 'Focal',\n\ticon: 'mdi:target',\n\n\ttool: Tool as unknown as import('svelte').Component<Record<string, unknown>>,\n\tcontrols: null as unknown as import('svelte').Component<Record<string, unknown>>\n};\n","<!--\n@file: src/components/imageEditor/toolbars/RotateControls.svelte\n@component\nControls for the Rotate tool\n-->\n<script lang=\"ts\">\n\tlet {\n\t\trotationAngle,\n\t\tonRotateLeft,\n\t\tonRotateRight,\n\t\tonRotationChange,\n\t\tonFlipHorizontal,\n\t\tonFlipVertical,\n\t\tonReset,\n\t\tonApply\n\t}: {\n\t\trotationAngle: number;\n\t\tonRotateLeft: () => void;\n\t\tonRotateRight: () => void;\n\t\tonRotationChange: (angle: number) => void;\n\t\tonFlipHorizontal: () => void;\n\t\tonFlipVertical: () => void;\n\t\tonReset: () => void;\n\t\tonApply: () => void;\n\t} = $props();\n\n\tfunction handleAngleInput(e: Event) {\n\t\tconst target = e.currentTarget as HTMLInputElement;\n\t\tonRotationChange(parseInt(target.value, 10));\n\t}\n\n\t// Normalize angle to -180 to 180 for display\n\tconst displayAngle = $derived(() => {\n\t\tlet angle = rotationAngle % 360;\n\t\tif (angle > 180) angle -= 360;\n\t\tif (angle < -180) angle += 360;\n\t\treturn Math.round(angle);\n\t});\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<span class=\"text-sm font-medium\">Rotate & Flip Image</span>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Rotate Controls -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm\">Rotate:</span>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateLeft} title=\"Rotate Left 90\">\n\t\t\t<iconify-icon icon=\"mdi:rotate-left\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onRotateRight} title=\"Rotate Right 90\">\n\t\t\t<iconify-icon icon=\"mdi:rotate-right\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Fine-tune Angle -->\n\t<label class=\"flex items-center gap-2 text-sm\">\n\t\t<span>Angle:</span>\n\t\t<input type=\"range\" min=\"-180\" max=\"180\" step=\"1\" value={rotationAngle} oninput={handleAngleInput} class=\"range range-primary w-32\" />\n\t\t<span class=\"w-12 text-right\">{displayAngle()}</span>\n\t</label>\n\n\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\n\t<!-- Flip Controls -->\n\t<div class=\"flex items-center gap-2\">\n\t\t<span class=\"text-sm\">Flip:</span>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipHorizontal} title=\"Flip Horizontal\">\n\t\t\t<iconify-icon icon=\"mdi:flip-horizontal\"></iconify-icon>\n\t\t</button>\n\t\t<button class=\"btn btn-icon btn-sm preset-outlined-surface-500\" onclick={onFlipVertical} title=\"Flip Vertical\">\n\t\t\t<iconify-icon icon=\"mdi:flip-vertical\"></iconify-icon>\n\t\t</button>\n\t</div>\n\n\t<div class=\"grow\"></div>\n\n\t<!-- Actions -->\n\t<button onclick={onReset} class=\"btn preset-outlined-surface-500\">\n\t\t<iconify-icon icon=\"mdi:restore\"></iconify-icon>\n\t\t<span>Reset</span>\n\t</button>\n\n\t<button class=\"btn preset-filled-success-500\" onclick={onApply}>\n\t\t<iconify-icon icon=\"mdi:check\"></iconify-icon>\n\t\t<span>Apply</span>\n\t</button>\n</div>\n","<script lang=\"ts\">\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport RotateControls from './Controls.svelte';\n\n\tlet rotationAngle = $state(0);\n\n\t// bind/unbind the tool when active state changes\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'rotate') {\n\t\t\t// Get current rotation when tool activates\n\t\t\tconst { imageGroup } = imageEditorStore.state;\n\t\t\tif (imageGroup) {\n\t\t\t\trotationAngle = imageGroup.rotation();\n\t\t\t}\n\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: RotateControls,\n\t\t\t\tprops: {\n\t\t\t\t\trotationAngle,\n\t\t\t\t\tonRotateLeft: rotateLeft,\n\t\t\t\t\tonRotateRight: rotateRight,\n\t\t\t\t\tonRotationChange: setRotation,\n\t\t\t\t\tonFlipHorizontal: flipHorizontal,\n\t\t\t\t\tonFlipVertical: flipVertical,\n\t\t\t\t\tonReset: reset,\n\t\t\t\t\tonApply: apply\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\t// Only clear controls if they are ours\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === RotateControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\tfunction rotateLeft() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation - 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\t\trotationAngle = newRotation;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction rotateRight() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\tconst currentRotation = imageGroup.rotation();\n\t\tconst newRotation = (currentRotation + 90) % 360;\n\t\timageGroup.rotation(newRotation);\n\t\trotationAngle = newRotation;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction setRotation(angle: number) {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.rotation(angle);\n\t\trotationAngle = angle;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipHorizontal() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleX(imageGroup.scaleX() * -1);\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction flipVertical() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.scaleY(imageGroup.scaleY() * -1);\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction reset() {\n\t\tconst { imageGroup, layer } = imageEditorStore.state;\n\t\tif (!imageGroup || !layer) return;\n\n\t\timageGroup.rotation(0);\n\t\timageGroup.scaleX(Math.abs(imageGroup.scaleX()));\n\t\timageGroup.scaleY(Math.abs(imageGroup.scaleY()));\n\t\trotationAngle = 0;\n\t\tlayer.batchDraw();\n\t}\n\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\texport function cleanup() {\n\t\t/* no cleanup needed */\n\t}\n\n\texport function saveState() {\n\t\t/* state captured by parent snapshots */\n\t}\n\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n// imageEditor/widgets/Rotate/Tool.svelte /** * @file src/components/imageEditor/widgets/Rotate/Tool.svelte * @component * Rotate tool for rotating\nand flipping images */\n<!-- No UI needed, all controls in toolbar -->\n","/**\n * @file src/components/imageEditor/widgets/Rotate/index.ts\n * @description Rotate widget registration\n */\nimport type { EditorWidget } from '../registry';\nimport Tool from './Tool.svelte';\nimport Controls from './Controls.svelte';\n\nconst widget = {\n\tkey: 'rotate',\n\ttitle: 'Rotate',\n\ticon: 'mdi:rotate-right',\n\ttool: Tool,\n\tcontrols: Controls\n};\n\nexport const editorWidget = widget as unknown as EditorWidget;\n\nexport default editorWidget;\n","<!--\n@file: src/components/imageEditor/toolbars/WatermarkControls.svelte\n@component\nControls for the Watermark tool. Allows adding, deleting, and positioning watermarks.\n-->\n<script lang=\"ts\">\n\tlet {\n\t\tonAddWatermark,\n\t\tonDeleteWatermark,\n\t\tonPositionChange,\n\t\thasSelection\n\t}: {\n\t\tonAddWatermark: () => void;\n\t\tonDeleteWatermark: () => void;\n\t\tonPositionChange: (position: string) => void;\n\t\thasSelection: boolean;\n\t} = $props();\n\n\tconst positions = [\n\t\t{ value: 'top-left', icon: 'mdi:align-vertical-top' },\n\t\t{ value: 'top-center', icon: 'mdi:align-vertical-center' },\n\t\t{ value: 'top-right', icon: 'mdi:align-vertical-top' },\n\t\t{ value: 'center-left', icon: 'mdi:align-horizontal-left' },\n\t\t{ value: 'center', icon: 'mdi:align-horizontal-center' },\n\t\t{ value: 'center-right', icon: 'mdi:align-horizontal-right' },\n\t\t{ value: 'bottom-left', icon: 'mdi:align-vertical-bottom' },\n\t\t{ value: 'bottom-center', icon: 'mdi:align-vertical-center' },\n\t\t{ value: 'bottom-right', icon: 'mdi:align-vertical-bottom' }\n\t];\n</script>\n\n<div class=\"flex w-full items-center gap-4\">\n\t<button onclick={onAddWatermark} class=\"btn preset-outlined-surface-500\">\n\t\t<iconify-icon icon=\"mdi:plus-box-outline\"></iconify-icon>\n\t\t<span>Add Watermark</span>\n\t</button>\n\n\t{#if hasSelection}\n\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t<span class=\"text-sm\">Position:</span>\n\t\t<div class=\"btn-group preset-outlined-surface-500\">\n\t\t\t{#each positions as pos}\n\t\t\t\t<button class=\"btn-sm\" onclick={() => onPositionChange(pos.value)} title={pos.value}>\n\t\t\t\t\t<iconify-icon icon={pos.icon}></iconify-icon>\n\t\t\t\t</button>\n\t\t\t{/each}\n\t\t</div>\n\n\t\t<div class=\"grow\"></div>\n\n\t\t<button onclick={onDeleteWatermark} class=\"btn preset-outlined-error-500\">\n\t\t\t<iconify-icon icon=\"mdi:delete-outline\"></iconify-icon>\n\t\t\t<span>Delete</span>\n\t\t</button>\n\t{/if}\n</div>\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Watermark/region.ts\n * @description Regions for Watermark tool\n *\n * Features:\n * - WatermarkItem encapsulates a Konva.Image node, its transformer,\n * and the async logic to load an image from a File.\n */\n\nimport Konva from 'konva';\n\nexport class WatermarkItem {\n\tid: string;\n\tnode: Konva.Image;\n\tlayer: Konva.Layer;\n\timageGroup: Konva.Group;\n\tprivate objectUrl: string | null = null; // To revoke on destroy\n\n\tprivate _onSelect: (() => void) | null = null;\n\tprivate _onDestroy: (() => void) | null = null;\n\n\tconstructor(opts: { id: string; layer: Konva.Layer; imageGroup: Konva.Group }) {\n\t\tthis.id = opts.id;\n\t\tthis.layer = opts.layer;\n\t\tthis.imageGroup = opts.imageGroup;\n\n\t\t// Create an empty Konva.Image node as a placeholder\n\t\tthis.node = new Konva.Image({\n\t\t\timage: undefined,\n\t\t\tdraggable: true,\n\t\t\tname: 'watermark'\n\t\t});\n\t\tthis.layer.add(this.node);\n\t\tthis.node.zIndex(5); // Watermarks go on top of annotations\n\n\t\t// Attach selection handler\n\t\tthis.node.on('click tap', (e) => {\n\t\t\te.cancelBubble = true;\n\t\t\tthis._onSelect?.();\n\t\t});\n\t}\n\n\t/**\n\t * Asynchronously loads an image from a File object into the\n\t * Konva.Image node.\n\t */\n\tloadImage(file: File, options: { opacity: number; stageWidth: number; stageHeight: number }): Promise<void> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.objectUrl = URL.createObjectURL(file);\n\t\t\tconst img = new Image();\n\t\t\timg.onload = () => {\n\t\t\t\t// Calculate initial size (e.g., 20% of stage width)\n\t\t\t\tconst scale = (options.stageWidth * 0.2) / img.width;\n\t\t\t\tconst w = img.width * scale;\n\t\t\t\tconst h = img.height * scale;\n\n\t\t\t\t// Position in center\n\t\t\t\tconst x = options.stageWidth / 2 - w / 2;\n\t\t\t\tconst y = options.stageHeight / 2 - h / 2;\n\n\t\t\t\tthis.node.setAttrs({\n\t\t\t\t\timage: img,\n\t\t\t\t\tx: x,\n\t\t\t\t\ty: y,\n\t\t\t\t\twidth: w,\n\t\t\t\t\theight: h,\n\t\t\t\t\topacity: options.opacity\n\t\t\t\t});\n\n\t\t\t\tthis.layer.batchDraw();\n\t\t\t\tresolve();\n\t\t\t};\n\t\t\timg.onerror = (err) => {\n\t\t\t\treject(err);\n\t\t\t};\n\t\t\timg.src = this.objectUrl;\n\t\t});\n\t}\n\n\tsetOpacity(opacity: number) {\n\t\tthis.node.opacity(opacity);\n\t\tthis.layer.batchDraw();\n\t}\n\n\t/**\n\t * Snaps the watermark to a predefined position.\n\t * (tl, tc, tr, cl, c, cr, bl, bc, br)\n\t */\n\tsnapTo(position: string) {\n\t\tconst stage = this.layer.getStage();\n\t\tconst imageRect = this.imageGroup.getClientRect();\n\t\tconst nodeBox = this.node.getClientRect();\n\n\t\tconst padding = 10; // 10px padding from edge\n\n\t\tlet x: number, y: number;\n\n\t\t// Y-position\n\t\tif (position.startsWith('t')) {\n\t\t\ty = imageRect.y + padding;\n\t\t} else if (position.startsWith('c')) {\n\t\t\ty = imageRect.y + imageRect.height / 2 - nodeBox.height / 2;\n\t\t} else {\n\t\t\t// 'b'\n\t\t\ty = imageRect.y + imageRect.height - nodeBox.height - padding;\n\t\t}\n\n\t\t// X-position\n\t\tif (position.endsWith('l')) {\n\t\t\tx = imageRect.x + padding;\n\t\t} else if (position.endsWith('c')) {\n\t\t\tx = imageRect.x + imageRect.width / 2 - nodeBox.width / 2;\n\t\t} else {\n\t\t\t// 'r'\n\t\t\tx = imageRect.x + imageRect.width - nodeBox.width - padding;\n\t\t}\n\n\t\t// Need to account for stage transform\n\t\tconst stageAbs = stage.getAbsoluteTransform().copy().invert();\n\t\tconst finalPos = stageAbs.point({ x, y });\n\n\t\tthis.node.position(finalPos);\n\t\tthis.layer.batchDraw();\n\t}\n\n\tdisableInteraction() {\n\t\tthis.node.draggable(false);\n\t}\n\n\tdestroy() {\n\t\tthis.node.off('click tap');\n\t\tthis.node.destroy();\n\t\tif (this.objectUrl) {\n\t\t\tURL.revokeObjectURL(this.objectUrl);\n\t\t}\n\t\tthis._onDestroy?.();\n\t}\n\n\t// --- Event Callbacks ---\n\tonSelect(cb: () => void) {\n\t\tthis._onSelect = cb;\n\t}\n\tonDestroy(cb: () => void) {\n\t\tthis._onDestroy = cb;\n\t}\n}\n","<!--\n@file: src/routes/(app)/imageEditor/widgets/Watermark/Tool.svelte\n@component\n**Watermark Tool \"Controller\"**\n\nOrchestrates the watermark lifecycle:\n- Manages the $state list of WatermarkItem instances\n- Handles selection and transformer\n- Registers the toolbar UI\n- Implements the 'apply' (bake) logic\n-->\n\n<script lang=\"ts\">\n\timport Konva from 'konva';\n\timport { getContext } from 'svelte';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport WatermarkControls from './Controls.svelte';\n\timport { WatermarkItem } from './regions';\n\timport { createStyledTransformer, attachStyledTransformer } from '../transformerConfig';\n\timport type { WatermarkOptions } from '@shared/utils/media/mediaModels';\n\n\t// --- Svelte 5 State ---\n\tlet watermarks: WatermarkItem[] = $state([]);\n\tlet selected: WatermarkItem | null = $state(null);\n\tlet transformer: Konva.Transformer | null = $state(null);\n\tlet opacity = $state(0.8);\n\tlet fileInput: HTMLInputElement;\n\n\t// guard to avoid duplicate event bindings\n\tlet _toolBound = $state(false);\n\t// guard to prevent loading preset multiple times\n\tlet _presetLoaded = $state(false);\n\n\t// Get watermark preset from parent context (set by ImageEditorModal)\n\tconst getWatermarkPreset = getContext<(() => WatermarkOptions | null) | undefined>('watermarkPreset');\n\n\t// --- Lifecycle $effect ---\n\t// Binds/unbounds the tool and registers the toolbar\n\t$effect(() => {\n\t\tconst activeState = imageEditorStore.state.activeState;\n\t\tif (activeState === 'watermark') {\n\t\t\tbindTool();\n\n\t\t\t// Auto-load preset watermark if available and not already loaded\n\t\t\tconst preset = getWatermarkPreset?.();\n\t\t\tif (preset?.url && watermarks.length === 0 && !_presetLoaded) {\n\t\t\t\t_presetLoaded = true;\n\t\t\t\tloadPresetWatermark(preset);\n\t\t\t}\n\n\t\t\timageEditorStore.setToolbarControls({\n\t\t\t\tcomponent: WatermarkControls,\n\t\t\t\tprops: {\n\t\t\t\t\thasSelection: !!selected,\n\t\t\t\t\tonAddWatermark: () => fileInput?.click(),\n\t\t\t\t\tonDeleteWatermark: () => deleteSelected(),\n\t\t\t\t\tonPositionChange: (position: string) => selected?.snapTo(position),\n\t\t\t\t\tonApply: () => apply()\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tunbindTool();\n\t\t\t_presetLoaded = false; // Reset for next activation\n\t\t\tif (imageEditorStore.state.toolbarControls?.component === WatermarkControls) {\n\t\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\t}\n\t\t}\n\t});\n\n\t// --- Event Binding ---\n\tfunction bindTool() {\n\t\tconst { stage, layer } = imageEditorStore.state;\n\t\tif (!stage || !layer || _toolBound) return;\n\t\t_toolBound = true;\n\n\t\tif (!transformer) {\n\t\t\ttransformer = createStyledTransformer(layer);\n\t\t}\n\t\tstage.on('click.watermark tap.watermark', onStageClick);\n\t\tstage.container().style.cursor = 'default';\n\t}\n\n\tfunction unbindTool() {\n\t\tconst { stage } = imageEditorStore.state;\n\t\tif (!stage || !_toolBound) return;\n\t\t_toolBound = false;\n\n\t\tstage.off('click.watermark tap.watermark');\n\t\tif (stage.container()) stage.container().style.cursor = 'default';\n\t\tdeselect();\n\t}\n\n\t// --- Event Handlers ---\n\tfunction onStageClick(e: Konva.KonvaEventObject<MouseEvent>) {\n\t\t// Deselect if clicking on stage background\n\t\tif (e.target === e.target.getStage()) {\n\t\t\tdeselect();\n\t\t}\n\t}\n\n\t// --- Preset Watermark Loading ---\n\tasync function loadPresetWatermark(preset: WatermarkOptions) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\ttry {\n\t\t\t// Fetch the watermark image from the preset URL\n\t\t\tconst response = await fetch(preset.url);\n\t\t\tif (!response.ok) {\n\t\t\t\tconsole.warn('Failed to fetch preset watermark:', preset.url);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst blob = await response.blob();\n\t\t\tconst filename = preset.url.split('/').pop() || 'preset-watermark.png';\n\t\t\tconst file = new File([blob], filename, { type: blob.type || 'image/png' });\n\n\t\t\tconst item = new WatermarkItem({\n\t\t\t\tid: crypto.randomUUID(),\n\t\t\t\tlayer,\n\t\t\t\timageGroup\n\t\t\t});\n\n\t\t\titem.onSelect(() => select(item));\n\t\t\titem.onDestroy(() => {\n\t\t\t\twatermarks = watermarks.filter((w) => w.id !== item.id);\n\t\t\t\tif (selected?.id === item.id) deselect();\n\t\t\t});\n\n\t\t\twatermarks = [...watermarks, item];\n\t\t\tselect(item);\n\n\t\t\t// Load with preset opacity (convert percentage scale to 0-1 if needed)\n\t\t\tconst presetOpacity = typeof preset.scale === 'number' && preset.scale > 1 ? preset.scale / 100 : (preset.scale ?? 0.8);\n\n\t\t\tawait item.loadImage(file, {\n\t\t\t\topacity: presetOpacity,\n\t\t\t\tstageWidth: stage.width(),\n\t\t\t\tstageHeight: stage.height()\n\t\t\t});\n\n\t\t\t// Apply preset position if specified\n\t\t\tif (preset.position) {\n\t\t\t\titem.snapTo(preset.position);\n\t\t\t}\n\n\t\t\tattachStyledTransformer(transformer!, item.node);\n\t\t\tlayer.batchDraw();\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to load preset watermark', err);\n\t\t}\n\t}\n\n\t// --- Watermark Lifecycle ---\n\tasync function addWatermark(file: File) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\tconst item = new WatermarkItem({\n\t\t\tid: crypto.randomUUID(),\n\t\t\tlayer,\n\t\t\timageGroup\n\t\t});\n\n\t\titem.onSelect(() => select(item));\n\t\titem.onDestroy(() => {\n\t\t\twatermarks = watermarks.filter((w) => w.id !== item.id);\n\t\t\tif (selected?.id === item.id) deselect();\n\t\t});\n\n\t\twatermarks = [...watermarks, item];\n\t\tselect(item);\n\n\t\ttry {\n\t\t\t// Asynchronously load the image file\n\t\t\tawait item.loadImage(file, {\n\t\t\t\topacity: opacity,\n\t\t\t\tstageWidth: stage.width(),\n\t\t\t\tstageHeight: stage.height()\n\t\t\t});\n\t\t\t// Attach transformer *after* image is loaded and sized\n\t\t\tattachStyledTransformer(transformer!, item.node);\n\t\t\tlayer.batchDraw();\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to load watermark image', err);\n\t\t\titem.destroy(); // Clean up if load fails\n\t\t}\n\t}\n\n\tfunction select(item: WatermarkItem) {\n\t\tselected = item;\n\t\tif (!transformer) return;\n\t\tattachStyledTransformer(transformer, item.node);\n\t\t// Update controls to match selected item's opacity\n\t\topacity = item.node.opacity();\n\t}\n\n\tfunction deselect() {\n\t\tselected = null;\n\t\tif (!transformer) return;\n\t\tattachStyledTransformer(transformer, null);\n\t}\n\n\tfunction deleteSelected() {\n\t\tif (!selected) return;\n\t\tselected.destroy();\n\t\t// State update is handled by the 'onDestroy' callback\n\t}\n\n\tfunction cleanupWatermarks(destroy = true) {\n\t\tdeselect();\n\t\tif (destroy) {\n\t\t\t[...watermarks].forEach((w) => w.destroy());\n\t\t\twatermarks = [];\n\t\t} else {\n\t\t\t// Hide UI for baking\n\t\t\twatermarks.forEach((w) => w.disableInteraction());\n\t\t}\n\t\timageEditorStore.state.layer?.batchDraw();\n\t}\n\n\t// --- Tool Actions ---\n\tfunction apply() {\n\t\timageEditorStore.takeSnapshot();\n\t\timageEditorStore.setActiveState('');\n\t}\n\n\tfunction handleFileChange(e: Event) {\n\t\tconst target = e.target as HTMLInputElement;\n\t\tif (target.files && target.files.length > 0) {\n\t\t\taddWatermark(target.files[0]);\n\t\t}\n\t\t// Reset input so the same file can be chosen again\n\t\ttarget.value = '';\n\t}\n\n\t// --- Parent Store API ---\n\texport function cleanup() {\n\t\ttry {\n\t\t\tunbindTool();\n\t\t\tcleanupWatermarks(true);\n\t\t\ttransformer?.destroy();\n\t\t\ttransformer = null;\n\t\t} catch (e) {\n\t\t\t/* ignore */\n\t\t}\n\t}\n\texport function saveState() {}\n\texport function beforeExit() {\n\t\tcleanup();\n\t}\n</script>\n\n<input type=\"file\" accept=\"image/png, image/svg+xml\" class=\"hidden\" bind:this={fileInput} onchange={handleFileChange} />\n\n<!-- Controls registered to master toolbar; no DOM toolbar here -->\n","/**\n * @file src/routes/(app)/imageEditor/widgets/Watermark/index.ts\n * @description Registers the Watermark tool and its controls.\n *\n * Features:\n * - Registers the Watermark tool and its controls.\n */\nimport type { Component } from 'svelte';\nimport Tool from './Tool.svelte';\n\nexport default {\n\tkey: 'watermark',\n\ttitle: 'Watermark',\n\ticon: 'mdi:copyright',\n\ttool: Tool as unknown as Component<Record<string, unknown>>\n};\n","/**\n * @file src/routes/(app)/imageEditor/widgets/registry.ts\n * @description Dynamic widgets registry using import.meta.glob for discoverability\n *\n * Features:\n * - Dynamic widgets registry using import.meta.glob for discoverability\n */\nimport type { Component } from 'svelte';\n\nexport interface EditorWidget {\n\tkey: string;\n\ttitle: string;\n\ticon?: string;\n\ttool: Component<Record<string, unknown>>;\n\tcontrols?: Component<Record<string, unknown>>; // Optional: widgets register controls dynamically via imageEditorStore\n}\n\n// Load all widgets declared under ./<Widget>/index.ts (PascalCase folders only)\nconst modules = import.meta.glob('./[A-Z]*/index.ts', { eager: true }) as Record<string, unknown>;\n\nexport const editorWidgets: EditorWidget[] = Object.values(modules)\n\t.map((m) => {\n\t\tconst mod = m as { default?: EditorWidget; editorWidget?: EditorWidget };\n\t\treturn mod.default ?? mod.editorWidget;\n\t})\n\t.filter((w): w is EditorWidget => !!w);\n","<!--\n@file: /src/routes/(app)/imageEditor/EditorSidebar.svelte\n@component\n**Left sidebar with vertical tool layout**\nProvides easy access to all editing tools with clean, minimal design\nand proper active state indication.\n\n#### Props\n- `activeState`: Currently active tool state\n- `onToolSelect`: Function called when a tool is selected\n- `hasImage`: Whether an image is loaded for conditional tool availability\n-->\n\n<script lang=\"ts\">\n\t// Props\n\tconst {\n\t\tactiveState,\n\t\tonToolSelect,\n\t\thasImage = false\n\t}: {\n\t\tactiveState: string;\n\t\tonToolSelect: (tool: string) => void;\n\t\thasImage?: boolean;\n\t} = $props();\n\n\t// Drive tools from the widgets registry, with a focalpoint fallback\n\timport { editorWidgets, type EditorWidget } from './widgets/registry';\n\n\tconst tools = [...editorWidgets.map((w: EditorWidget) => ({ id: w.key, name: w.title, icon: w.icon ?? 'mdi:cog', description: '' }))];\n\n\tfunction handleToolClick(tool: any) {\n\t\tif (!hasImage) return;\n\t\tonToolSelect(tool.id);\n\t}\n\n\tfunction isToolActive(tool: any): boolean {\n\t\treturn activeState === tool.id;\n\t}\n</script>\n\n<div class=\"editor-sidebar flex w-20 flex-col border-r lg:w-24\">\n\t<div class=\"sidebar-tools flex flex-1 flex-col gap-1 p-1.5 lg:p-2 max-lg:gap-0.5 max-lg:p-1\">\n\t\t{#each tools as tool}\n\t\t\t<button\n\t\t\t\tclass=\"btn preset-filled-primary-500 group relative flex flex-col items-center justify-center gap-1 py-2\"\n\t\t\t\tclass:active={isToolActive(tool)}\n\t\t\t\tclass:disabled={!hasImage}\n\t\t\t\tclass:bg-primary-500={isToolActive(tool)}\n\t\t\t\tclass:text-white={isToolActive(tool)}\n\t\t\t\tclass:shadow-md={isToolActive(tool)}\n\t\t\t\tclass:hover:bg-primary-600={isToolActive(tool)}\n\t\t\t\tclass:cursor-not-allowed={!hasImage}\n\t\t\t\tclass:opacity-50={!hasImage}\n\t\t\t\tclass:bg-transparent={!hasImage}\n\t\t\t\tonclick={() => handleToolClick(tool)}\n\t\t\t\taria-label={tool.name}\n\t\t\t\tdisabled={!hasImage}\n\t\t\t>\n\t\t\t\t<div class=\"tool-icon flex items-center justify-center\">\n\t\t\t\t\t<iconify-icon icon={tool.icon} width=\"24\"></iconify-icon>\n\t\t\t\t</div>\n\t\t\t\t<span class=\"tool-label text-[10px] font-medium leading-none lg:text-xs\">{tool.name}</span>\n\n\t\t\t\t<!-- Tooltip -->\n\t\t\t\t<div\n\t\t\t\t\tclass=\"tooltip pointer-events-none absolute left-full top-1/2 z-50 ml-2 -translate-y-1/2 whitespace-nowrap rounded bg-surface-900 px-2 py-1 text-xs text-white opacity-0 transition-opacity duration-200 group-hover:opacity-100 dark:bg-surface-700 shadow-lg\"\n\t\t\t\t>\n\t\t\t\t\t<div class=\"font-medium\">{tool.name}</div>\n\t\t\t\t\t{#if tool.description}\n\t\t\t\t\t\t<div class=\"text-[10px] text-surface-300\">{tool.description}</div>\n\t\t\t\t\t{/if}\n\t\t\t\t\t<!-- Arrow -->\n\t\t\t\t\t<div class=\"absolute -left-1 top-1/2 -mt-1 h-2 w-2 -rotate-45 bg-surface-900 dark:bg-surface-700\"></div>\n\t\t\t\t</div>\n\n\t\t\t\t<!-- coming soon badge removed; driven by registry now -->\n\t\t\t</button>\n\t\t{/each}\n\t</div>\n\n\t<div class=\"sidebar-footer border-t p-2\">\n\t\t{#if !hasImage}\n\t\t\t<div class=\"no-image-hint flex flex-col items-center gap-1 p-2 text-center\">\n\t\t\t\t<iconify-icon icon=\"mdi:information-outline\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50\"> Upload an image to enable tools </span>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n</div>\n\n<style>\n\t.editor-sidebar {\n\t\tbackground-color: rgb(var(--color-surface-100) / 1);\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t\tmin-height: 100%;\n\t}\n\n\t:global(.dark) .editor-sidebar {\n\t\tbackground-color: rgb(var(--color-surface-800) / 1);\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n\n\t.sidebar-footer {\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t}\n\n\t:global(.dark) .sidebar-footer {\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n</style>\n","<!--\n@file: src/components/imageEditor/EditorCanvas.svelte\n@component\n**Responsive canvas wrapper for the Konva stage**\nHandles canvas sizing, empty states, and provides proper container\nfor the image editor canvas with responsive behavior.\n\n#### Props\n- `hasImage`: Whether an image is currently loaded\n- `containerRef`: Reference to bind the container element\n-->\n\n<script lang=\"ts\">\n\timport { fade } from 'svelte/transition';\n\timport type { Snippet } from 'svelte';\n\n\t// Props\n\tlet {\n\t\thasImage = false,\n\t\tisLoading = false,\n\t\tloadingMessage = 'Loading...',\n\t\tcontainerRef = $bindable(),\n\t\tchildren\n\t}: {\n\t\thasImage?: boolean;\n\t\tisLoading?: boolean;\n\t\tloadingMessage?: string;\n\t\tcontainerRef?: HTMLDivElement;\n\t\tchildren?: Snippet;\n\t} = $props();\n\n\tlet mounted = $state(false);\n\n\t$effect(() => {\n\t\tmounted = true;\n\t});\n</script>\n\n<div\n\tclass=\"editor-canvas-wrapper relative flex-1 overflow-hidden rounded-lg border border-surface-200 transition-all duration-300 ease-in-out focus-within:ring-2 focus-within:ring-primary-500 focus-within:ring-offset-2 focus-within:ring-offset-surface-50 dark:focus-within:ring-offset-surface-900 md:rounded-lg md:border md:border-surface-200 max-md:rounded-none max-md:border-0 max-md:border-b max-md:border-t\"\n>\n\t<!-- Canvas container - ALWAYS present for Konva stage -->\n\t<div class=\"canvas-container h-full w-full transition-all duration-300 ease-in-out\" bind:this={containerRef}>\n\t\t<!-- Konva stage will be mounted here by ImageEditor -->\n\t</div>\n\n\t<!-- Empty state overlay - shown when no image -->\n\t{#if !hasImage}\n\t\t<div class=\"empty-state pointer-events-none absolute inset-0 z-10 flex items-center justify-center\">\n\t\t\t<div class=\"empty-state-content flex max-w-md flex-col items-center gap-6 p-8 text-center max-md:p-6\">\n\t\t\t\t<div\n\t\t\t\t\tclass=\"empty-icon flex h-20 w-20 items-center justify-center rounded-full bg-surface-200 ring-4 ring-surface-300 dark:bg-surface-700 dark:ring-surface-600 max-md:h-16 max-md:w-16\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:image-plus\" width=\"48\" class=\"text-surface-400 dark:text-surface-500\"></iconify-icon>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"empty-text\">\n\t\t\t\t\t<h3 class=\"mb-2 text-lg font-medium text-surface-700 dark:text-surface-300 max-md:text-base\">No Image Selected</h3>\n\t\t\t\t\t<p class=\"text-sm text-surface-500 dark:text-surface-50 max-md:text-xs\">Upload an image to start editing</p>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"empty-hints flex flex-col gap-2\">\n\t\t\t\t\t<div class=\"hint-item flex items-center justify-center gap-2\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:gesture-tap\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50 max-md:text-[10px]\"> Drag & drop supported </span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"hint-item flex items-center justify-center gap-2\">\n\t\t\t\t\t\t<iconify-icon icon=\"mdi:file-image\" width=\"16\" class=\"text-surface-400\"></iconify-icon>\n\t\t\t\t\t\t<span class=\"text-xs text-surface-500 dark:text-surface-50 max-md:text-[10px]\"> PNG, JPG, WebP, GIF </span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<!-- Slot for overlays (like crop toolbar) -->\n\t{@render children?.()}\n\n\t<!-- Loading overlay -->\n\t{#if (hasImage && !mounted) || isLoading}\n\t\t<div\n\t\t\tclass=\"loading-overlay absolute inset-0 flex flex-col items-center justify-center gap-3 bg-surface-50/80 backdrop-blur-sm dark:bg-surface-900/80 z-20\"\n\t\t\ttransition:fade={{ duration: 200 }}\n\t\t>\n\t\t\t<div class=\"loading-spinner flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-lg dark:bg-surface-800\">\n\t\t\t\t<iconify-icon icon=\"mdi:loading\" width=\"32\" class=\"animate-spin text-primary-500\"></iconify-icon>\n\t\t\t</div>\n\t\t\t<span class=\"text-sm text-surface-600 dark:text-surface-300\">{loadingMessage}</span>\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t.editor-canvas-wrapper {\n\t\tbackground-color: rgb(var(--color-surface-50) / 1);\n\t\tborder-color: rgb(var(--color-surface-200) / 1);\n\t\tmin-height: 400px;\n\t}\n\n\t:global(.dark) .editor-canvas-wrapper {\n\t\tbackground-color: rgb(var(--color-surface-900) / 1);\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n\n\t.canvas-container {\n\t\tbackground-color: rgb(var(--color-surface-100) / 1);\n\t\t/* Checkered pattern for transparency visualization */\n\t\tbackground-image:\n\t\t\tlinear-gradient(45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%), linear-gradient(-45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%),\n\t\t\tlinear-gradient(45deg, transparent 75%, rgba(0, 0, 0, 0.05) 75%), linear-gradient(-45deg, transparent 75%, rgba(0, 0, 0, 0.05) 75%);\n\t\tbackground-size: 20px 20px;\n\t\tbackground-position:\n\t\t\t0 0,\n\t\t\t0 10px,\n\t\t\t10px -10px,\n\t\t\t-10px 0px;\n\t}\n\n\t:global(.dark) .canvas-container {\n\t\tbackground-color: rgb(var(--color-surface-800) / 1);\n\t\tbackground-image:\n\t\t\tlinear-gradient(45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%), linear-gradient(-45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%),\n\t\t\tlinear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.03) 75%), linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.03) 75%);\n\t}\n\n\t.empty-state {\n\t\tbackground: linear-gradient(to bottom right, rgb(var(--color-surface-50) / 0.95), rgb(var(--color-surface-100) / 0.95));\n\t}\n\n\t:global(.dark) .empty-state {\n\t\tbackground: linear-gradient(to bottom right, rgb(var(--color-surface-900) / 1), rgb(var(--color-surface-800) / 1));\n\t}\n\n\t/* Responsive adjustments */\n\t@media (max-width: 768px) {\n\t\t.editor-canvas-wrapper {\n\t\t\tmin-height: 50vh;\n\t\t}\n\t}\n</style>\n","<!--\n@file: src/components/imageEditor/Editor.svelte\n@component\n**Enhanced Image Editor - Svelte 5 Optimized**\n\nComprehensive image editing interface with Konva.js integration.\n\n@example\n<Editor \n  initialImageSrc={image.url}\n  mediaId={image._id}\n  {onsave}\n  {oncancel}\n/>\n\n### Props\n- `imageFile` (File): Image file object\n- `initialImageSrc` (string): Initial image URL\n- `mediaId` (string): Media ID for saving\n- `focalPoint` (object): Initial focal point coordinates\n- `onsave` (function): Save callback\n- `oncancel` (function): Cancel callback\n\n### Features\n- Full Konva.js integration\n- Undo/redo support with history\n- Multiple editing tools (crop, filters, text, shapes)\n- Keyboard shortcuts\n- Responsive canvas\n- AVIF/WebP export\n- Accessibility compliant\n- Error boundaries\n-->\n\n<script lang=\"ts\">\n\timport { onMount, onDestroy } from 'svelte';\n\timport { logger } from '@shared/utils/logger';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\n\timport EditorSidebar from './EditorSidebar.svelte';\n\timport EditorCanvas from './EditorCanvas.svelte';\n\n\timport Konva from 'konva';\n\timport { editorWidgets } from './widgets/registry';\n\n\tinterface Props {\n\t\timageFile?: File | null;\n\t\tinitialImageSrc?: string;\n\t\tfocalPoint?: { x: number; y: number };\n\t\tonsave?: (detail: { dataURL: string; file: File }) => void;\n\t\toncancel?: () => void;\n\t}\n\n\tconst { imageFile = null, initialImageSrc = '', onsave = () => {}, oncancel = () => {} }: Props = $props();\n\n\t// State\n\tlet selectedImage = $state('');\n\tlet containerRef = $state<HTMLDivElement | undefined>(undefined);\n\tlet initialImageLoaded = $state(false);\n\tlet isProcessing = $state(false);\n\tlet error = $state<string | null>(null);\n\tlet preToolSnapshot = $state<string | null>(null);\n\n\t// Derived values\n\tconst storeState = imageEditorStore.state;\n\tconst activeState = $derived(imageEditorStore.state.activeState);\n\tconst hasImage = $derived(!!storeState.imageNode);\n\n\t// Active tool component\n\tconst activeToolComponent = $derived.by(() => {\n\t\tif (!activeState) return null;\n\n\t\tconst widget = editorWidgets.find((w) => w.key === activeState);\n\t\tif (widget?.tool) return widget.tool;\n\n\t\tif (activeState === 'focalpoint') return null; // Handled separately\n\n\t\tlogger.warn(`Tool not found for state: ${activeState}`);\n\t\treturn null;\n\t});\n\n\t// Cleanup effect for selected image\n\t$effect(() => {\n\t\treturn () => {\n\t\t\tif (selectedImage && selectedImage.startsWith('blob:')) {\n\t\t\t\tURL.revokeObjectURL(selectedImage);\n\t\t\t}\n\t\t};\n\t});\n\n\t// Load initial image effect\n\t$effect(() => {\n\t\tif (containerRef && !initialImageLoaded && (initialImageSrc || imageFile)) {\n\t\t\tif (initialImageSrc) {\n\t\t\t\tlogger.debug('Loading initial image from src:', initialImageSrc);\n\t\t\t\tselectedImage = initialImageSrc;\n\t\t\t\tloadImageAndSetupKonva(selectedImage);\n\t\t\t} else if (imageFile) {\n\t\t\t\tlogger.debug('Loading initial image from file');\n\t\t\t\tselectedImage = URL.createObjectURL(imageFile);\n\t\t\t\tloadImageAndSetupKonva(selectedImage, imageFile);\n\t\t\t}\n\t\t\tinitialImageLoaded = true;\n\t\t}\n\t});\n\n\t// Load image and setup Konva\n\tfunction loadImageAndSetupKonva(imageSrc: string, file?: File) {\n\t\tif (!containerRef) {\n\t\t\tlogger.error('Container ref not available');\n\t\t\terror = 'Container not ready';\n\t\t\treturn;\n\t\t}\n\n\t\tisProcessing = true;\n\t\terror = null;\n\n\t\tconst img = new Image();\n\n\t\t// Determine crossOrigin\n\t\ttry {\n\t\t\tconst currentOrigin = window.location.origin;\n\t\t\tconst imageOrigin = new URL(imageSrc, currentOrigin).origin;\n\n\t\t\tif (imageOrigin !== currentOrigin) {\n\t\t\t\timg.crossOrigin = 'anonymous';\n\t\t\t}\n\t\t\t// For same-origin (including local relative paths), we don't set crossOrigin\n\t\t\t// to ensure cookies/auth headers are sent if needed.\n\t\t} catch (e) {\n\t\t\t// Fallback for invalid URLs or other parsing errors\n\t\t\timg.crossOrigin = 'anonymous';\n\t\t}\n\n\t\timg.onerror = () => {\n\t\t\terror = 'Failed to load image';\n\t\t\tisProcessing = false;\n\t\t\tlogger.error('Image load error');\n\t\t};\n\n\t\timg.onload = () => {\n\t\t\ttry {\n\t\t\t\tconst containerWidth = containerRef!.clientWidth;\n\t\t\t\tconst containerHeight = containerRef!.clientHeight;\n\n\t\t\t\t// Clear existing stage\n\t\t\t\tconst existingStage = imageEditorStore.state.stage;\n\t\t\t\tif (existingStage) {\n\t\t\t\t\texistingStage.destroy();\n\t\t\t\t}\n\n\t\t\t\t// Create stage\n\t\t\t\tconst stage = new Konva.Stage({\n\t\t\t\t\tcontainer: containerRef!,\n\t\t\t\t\twidth: containerWidth,\n\t\t\t\t\theight: containerHeight\n\t\t\t\t});\n\n\t\t\t\tconst layer = new Konva.Layer();\n\t\t\t\tstage.add(layer);\n\n\t\t\t\t// Calculate scale\n\t\t\t\tconst scaleX = (containerWidth * 0.8) / img.width;\n\t\t\t\tconst scaleY = (containerHeight * 0.8) / img.height;\n\t\t\t\tconst scale = Math.min(scaleX, scaleY);\n\n\t\t\t\t// Create image node\n\t\t\t\tconst imageNode = new Konva.Image({\n\t\t\t\t\timage: img,\n\t\t\t\t\twidth: img.width,\n\t\t\t\t\theight: img.height,\n\t\t\t\t\tx: -img.width / 2,\n\t\t\t\t\ty: -img.height / 2\n\t\t\t\t});\n\n\t\t\t\t// Create group for transforms\n\t\t\t\tconst imageGroup = new Konva.Group({\n\t\t\t\t\tx: containerWidth / 2,\n\t\t\t\t\ty: containerHeight / 2,\n\t\t\t\t\tscaleX: scale,\n\t\t\t\t\tscaleY: scale\n\t\t\t\t});\n\n\t\t\t\timageGroup.add(imageNode);\n\t\t\t\tlayer.add(imageGroup);\n\t\t\t\tlayer.draw();\n\n\t\t\t\t// Update store\n\t\t\t\timageEditorStore.setStage(stage);\n\t\t\t\timageEditorStore.setLayer(layer);\n\t\t\t\timageEditorStore.setImageNode(imageNode);\n\t\t\t\timageEditorStore.setImageGroup(imageGroup);\n\n\t\t\t\tif (file) {\n\t\t\t\t\timageEditorStore.setFile(file);\n\t\t\t\t}\n\n\t\t\t\t// Initial snapshot\n\t\t\t\timageEditorStore.takeSnapshot();\n\n\t\t\t\tisProcessing = false;\n\t\t\t} catch (err) {\n\t\t\t\terror = 'Failed to setup editor';\n\t\t\t\tisProcessing = false;\n\t\t\t\tlogger.error('Konva setup error:', err);\n\t\t\t}\n\t\t};\n\n\t\timg.src = imageSrc;\n\t}\n\n\t// Handle resize\n\tfunction handleResize() {\n\t\tconst { stage, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !containerRef) return;\n\n\t\tconst containerWidth = containerRef.clientWidth;\n\t\tconst containerHeight = containerRef.clientHeight;\n\n\t\tstage.width(containerWidth);\n\t\tstage.height(containerHeight);\n\n\t\t// Recenter image\n\t\tif (imageGroup) {\n\t\t\timageGroup.position({\n\t\t\t\tx: containerWidth / 2,\n\t\t\t\ty: containerHeight / 2\n\t\t\t});\n\t\t}\n\n\t\tstage.batchDraw();\n\t}\n\n\t// Handle keyboard shortcuts\n\tfunction handleKeyDown(event: KeyboardEvent) {\n\t\t// Skip if typing in input\n\t\tconst target = event.target as HTMLElement;\n\t\tconst isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.contentEditable === 'true';\n\t\tif (isInput) return;\n\n\t\tconst cmdOrCtrl = event.metaKey || event.ctrlKey;\n\t\tconst shift = event.shiftKey;\n\n\t\t// Escape: Exit tool\n\t\tif (event.key === 'Escape') {\n\t\t\tconst currentState = imageEditorStore.state.activeState;\n\t\t\tif (currentState) {\n\t\t\t\timageEditorStore.saveToolState();\n\t\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\t\timageEditorStore.setActiveState('');\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// Ctrl/Cmd+Z: Undo\n\t\tif (cmdOrCtrl && !shift && event.key === 'z') {\n\t\t\tevent.preventDefault();\n\t\t\thandleUndo();\n\t\t\treturn;\n\t\t}\n\n\t\t// Ctrl/Cmd+Shift+Z: Redo\n\t\tif (cmdOrCtrl && shift && event.key === 'z') {\n\t\t\tevent.preventDefault();\n\t\t\thandleRedo();\n\t\t\treturn;\n\t\t}\n\n\t\t// Delete: Remove selected\n\t\tif (event.key === 'Delete') {\n\t\t\tconst currentState = imageEditorStore.state.activeState;\n\t\t\tif (currentState === 'textoverlay' || currentState === 'shapeoverlay') {\n\t\t\t\tconst deleteBtn = document.querySelector('.preset-filled-error-500.btn') as HTMLButtonElement;\n\t\t\t\tdeleteBtn?.click();\n\t\t\t}\n\t\t}\n\t}\n\n\t// Undo/Redo\n\texport function handleUndo() {\n\t\tif (!imageEditorStore.canUndoState) return;\n\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (currentState) {\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t}\n\n\t\tconst stateData = imageEditorStore.undoState();\n\t\tif (stateData) {\n\t\t\trestoreFromStateData(stateData);\n\t\t}\n\t}\n\n\texport function handleRedo() {\n\t\tif (!imageEditorStore.canRedoState) return;\n\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (currentState) {\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t}\n\n\t\tconst stateData = imageEditorStore.redoState();\n\t\tif (stateData) {\n\t\t\trestoreFromStateData(stateData);\n\t\t}\n\t}\n\n\t// Restore state\n\tfunction restoreFromStateData(stateData: string) {\n\t\tconst { stage, layer, imageNode, imageGroup } = imageEditorStore.state;\n\t\tif (!stage || !layer || !imageNode || !imageGroup) return;\n\n\t\ttry {\n\t\t\t// Deep cleanup before restoration\n\t\t\timageEditorStore.cleanupTempNodes();\n\n\t\t\tconst rawData = JSON.parse(stateData);\n\t\t\t// Support both legacy (pure stage JSON) and new format (snapshot object)\n\t\t\tconst isNewFormat = rawData.stage && rawData.activeState !== undefined;\n\t\t\tconst stateJSON = isNewFormat ? JSON.parse(rawData.stage) : rawData;\n\n\t\t\tif (isNewFormat) {\n\t\t\t\timageEditorStore.setActiveState(rawData.activeState);\n\t\t\t}\n\n\t\t\t// Clear filters to ensure a clean slate\n\t\t\timageNode.filters([]);\n\t\t\timageNode.clearCache();\n\n\t\t\t// The JSON structure is typically Stage -> Layer -> [Children]\n\t\t\t// We look for our expected hierarchy: imageGroup -> imageNode\n\t\t\tconst findImageGroupState = (nodes: any[]): any => {\n\t\t\t\tfor (const node of nodes) {\n\t\t\t\t\tif (node.className === 'Group' && node.children?.some((c: any) => c.className === 'Image')) {\n\t\t\t\t\t\treturn node;\n\t\t\t\t\t}\n\t\t\t\t\tif (node.children) {\n\t\t\t\t\t\tconst found = findImageGroupState(node.children);\n\t\t\t\t\t\tif (found) return found;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\n\t\t\tconst imageGroupState = findImageGroupState(stateJSON.children || []);\n\n\t\t\tif (imageGroupState && imageGroupState.attrs) {\n\t\t\t\t// Restore image group transforms\n\t\t\t\timageGroup.setAttrs({\n\t\t\t\t\tx: imageGroupState.attrs.x ?? stage.width() / 2,\n\t\t\t\t\ty: imageGroupState.attrs.y ?? stage.height() / 2,\n\t\t\t\t\tscaleX: imageGroupState.attrs.scaleX ?? 1,\n\t\t\t\t\tscaleY: imageGroupState.attrs.scaleY ?? 1,\n\t\t\t\t\trotation: imageGroupState.attrs.rotation ?? 0\n\t\t\t\t});\n\n\t\t\t\tconst imageNodeState = imageGroupState.children.find((c: any) => c.className === 'Image');\n\t\t\t\tif (imageNodeState && imageNodeState.attrs) {\n\t\t\t\t\t// Restore image node properties\n\t\t\t\t\timageNode.setAttrs({\n\t\t\t\t\t\tcropX: imageNodeState.attrs.cropX,\n\t\t\t\t\t\tcropY: imageNodeState.attrs.cropY,\n\t\t\t\t\t\tcropWidth: imageNodeState.attrs.cropWidth,\n\t\t\t\t\t\tcropHeight: imageNodeState.attrs.cropHeight,\n\t\t\t\t\t\twidth: imageNodeState.attrs.width,\n\t\t\t\t\t\theight: imageNodeState.attrs.height,\n\t\t\t\t\t\tx: imageNodeState.attrs.x,\n\t\t\t\t\t\ty: imageNodeState.attrs.y,\n\t\t\t\t\t\tcornerRadius: imageNodeState.attrs.cornerRadius ?? 0\n\t\t\t\t\t} as any);\n\n\t\t\t\t\t// Restore Filters\n\t\t\t\t\tif (imageNodeState.attrs.filters?.length > 0) {\n\t\t\t\t\t\t// Convert filter names to actual Konva filter functions if needed\n\t\t\t\t\t\t// but usually Konva restores them if registered.\n\t\t\t\t\t\t// To be safe, we re-apply based on attrs\n\t\t\t\t\t\tconst activeFilters = [];\n\t\t\t\t\t\tif (imageNodeState.attrs.brightness !== undefined) activeFilters.push(Konva.Filters.Brighten);\n\t\t\t\t\t\tif (imageNodeState.attrs.contrast !== undefined) activeFilters.push(Konva.Filters.Contrast);\n\t\t\t\t\t\tif (imageNodeState.attrs.saturation !== undefined || imageNodeState.attrs.luminance !== undefined) activeFilters.push(Konva.Filters.HSL);\n\n\t\t\t\t\t\timageNode.filters(activeFilters);\n\t\t\t\t\t\timageNode.setAttrs(imageNodeState.attrs);\n\t\t\t\t\t\timageNode.cache();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlayer.batchDraw();\n\t\t\tstage.batchDraw();\n\t\t} catch (err) {\n\t\t\tlogger.error('Failed to restore state:', err);\n\t\t\terror = 'Failed to restore state';\n\t\t}\n\t}\n\n\t// Save\n\texport async function handleSave() {\n\t\tconst { stage, file } = imageEditorStore.state;\n\t\tif (!stage || !file) {\n\t\t\terror = 'Nothing to save';\n\t\t\treturn;\n\t\t}\n\n\t\tisProcessing = true;\n\t\terror = null;\n\n\t\ttry {\n\t\t\t// CRITICAL: Hide all UI elements before taking the snapshot\n\t\t\t// to avoid baking handles/toolbars into the image.\n\t\t\timageEditorStore.hideAllUI();\n\n\t\t\tlet dataURL: string;\n\t\t\tlet mimeType: string;\n\t\t\tlet fileExtension: string;\n\n\t\t\t// Try AVIF first, fallback to WebP\n\t\t\ttry {\n\t\t\t\tdataURL = stage.toDataURL({\n\t\t\t\t\tmimeType: 'image/avif',\n\t\t\t\t\tquality: 0.85,\n\t\t\t\t\tpixelRatio: 1\n\t\t\t\t});\n\n\t\t\t\tif (dataURL.startsWith('data:image/avif')) {\n\t\t\t\t\tmimeType = 'image/avif';\n\t\t\t\t\tfileExtension = 'avif';\n\t\t\t\t\tlogger.debug('Using AVIF format');\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error('AVIF not supported');\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\tlogger.warn('AVIF not supported, using WebP');\n\t\t\t\tdataURL = stage.toDataURL({\n\t\t\t\t\tmimeType: 'image/webp',\n\t\t\t\t\tquality: 0.95,\n\t\t\t\t\tpixelRatio: 1\n\t\t\t\t});\n\t\t\t\tmimeType = 'image/webp';\n\t\t\t\tfileExtension = 'webp';\n\t\t\t}\n\n\t\t\tconst response = await fetch(dataURL);\n\t\t\tconst blob = await response.blob();\n\n\t\t\tconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n\t\t\tconst newFileName = `edited-${timestamp}.${fileExtension}`;\n\t\t\tconst editedFile = new File([blob], newFileName, { type: mimeType });\n\n\t\t\tonsave({ dataURL, file: editedFile });\n\t\t} catch (err) {\n\t\t\tlogger.error('Save error:', err);\n\t\t\terror = 'Failed to save image';\n\t\t} finally {\n\t\t\tisProcessing = false;\n\t\t}\n\t}\n\n\t// Cancel\n\texport function handleCancel() {\n\t\toncancel();\n\t}\n\n\t// Toggle tool\n\tfunction toggleTool(tool: string) {\n\t\tconst currentState = imageEditorStore.state.activeState;\n\n\t\tif (currentState && currentState !== tool) {\n\t\t\timageEditorStore.saveToolState();\n\t\t\timageEditorStore.cleanupToolSpecific(currentState);\n\n\t\t\t// Recenter if drifted\n\t\t\tconst { stage, imageGroup } = imageEditorStore.state;\n\t\t\tif (stage && imageGroup) {\n\t\t\t\tconst expectedX = stage.width() / 2;\n\t\t\t\tconst expectedY = stage.height() / 2;\n\t\t\t\tconst currentX = imageGroup.x();\n\t\t\t\tconst currentY = imageGroup.y();\n\n\t\t\t\tif (Math.abs(currentX - expectedX) > 5 || Math.abs(currentY - expectedY) > 5) {\n\t\t\t\t\timageGroup.position({ x: expectedX, y: expectedY });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst newState = currentState === tool ? '' : tool;\n\n\t\t// Capture snapshot before entering a new tool for 'Cancel' functionality\n\t\tif (newState !== '' && newState !== currentState) {\n\t\t\tpreToolSnapshot = imageEditorStore.undoState(true); // Get current state without undoing\n\t\t}\n\n\t\timageEditorStore.setActiveState(newState);\n\n\t\tif (newState === '') {\n\t\t\timageEditorStore.setToolbarControls(null);\n\t\t\tpreToolSnapshot = null;\n\t\t}\n\t}\n\n\t// Cancel tool (Discard changes)\n\texport function handleCancelTool() {\n\t\tconst currentState = imageEditorStore.state.activeState;\n\t\tif (!currentState) return;\n\n\t\tif (preToolSnapshot) {\n\t\t\trestoreFromStateData(preToolSnapshot);\n\t\t\t// Also clear history forward if needed? No, undoState(true) just returns top.\n\t\t}\n\n\t\timageEditorStore.cleanupToolSpecific(currentState);\n\t\timageEditorStore.setActiveState('');\n\t\timageEditorStore.setToolbarControls(null);\n\t\tpreToolSnapshot = null;\n\t}\n\n\t// Lifecycle\n\tonMount(() => {\n\t\timageEditorStore.reset();\n\t\twindow.addEventListener('resize', handleResize);\n\t\twindow.addEventListener('keydown', handleKeyDown);\n\n\t\treturn () => {\n\t\t\twindow.removeEventListener('resize', handleResize);\n\t\t\twindow.removeEventListener('keydown', handleKeyDown);\n\t\t\timageEditorStore.cleanupTempNodes();\n\t\t\timageEditorStore.reset();\n\t\t};\n\t});\n\n\tonDestroy(() => {\n\t\tif (selectedImage && selectedImage.startsWith('blob:')) {\n\t\t\tURL.revokeObjectURL(selectedImage);\n\t\t}\n\t});\n</script>\n\n<div class=\"image-editor flex h-full w-full flex-col overflow-hidden\" role=\"application\" aria-label=\"Image editor\" aria-busy={isProcessing}>\n\t{#if error}\n\t\t<div class=\"error-banner bg-error-50 border-l-4 border-error-500 p-4 text-error-700 dark:bg-error-900/20 dark:text-error-300\" role=\"alert\">\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<iconify-icon icon=\"mdi:alert-circle\" width=\"20\"></iconify-icon>\n\t\t\t\t<span>{error}</span>\n\t\t\t\t<button onclick={() => (error = null)} class=\"ml-auto text-error-600 hover:text-error-800\" aria-label=\"Dismiss error\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"18\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<div class=\"editor-layout flex h-full overflow-hidden\">\n\t\t<EditorSidebar activeState={activeState ?? ''} onToolSelect={toggleTool} {hasImage} />\n\n\t\t<div class=\"editor-main flex min-w-0 flex-1 flex-col\">\n\t\t\t<div class=\"canvas-wrapper relative flex flex-1 flex-col\">\n\t\t\t\t<EditorCanvas bind:containerRef {hasImage}>\n\t\t\t\t\t{#if storeState.stage && storeState.layer && storeState.imageNode && storeState.imageGroup}\n\t\t\t\t\t\t{#if activeToolComponent}\n\t\t\t\t\t\t\t{@const Component = activeToolComponent}\n\t\t\t\t\t\t\t<Component onCancel={handleCancelTool} />\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t{/if}\n\t\t\t\t</EditorCanvas>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n\n<style>\n\t:global(.crop-bottom-bar) {\n\t\tposition: absolute;\n\t\tbottom: 1rem;\n\t\tleft: 50%;\n\t\ttransform: translateX(-50%);\n\t\tz-index: 10;\n\t}\n</style>\n","<!--\n@file: src/components/imageEditor/EditorToolbar.svelte\n@component\nThe new single, intelligent bottom toolbar for the image editor.\nIt dynamically renders controls based on the active tool.\n-->\n<script lang=\"ts\">\n\timport { fade } from 'svelte/transition';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\n\tconst toolbarControls = $derived(imageEditorStore.state.toolbarControls);\n</script>\n\n<div class=\"border-t border-surface-300 bg-surface-100 p-2 shadow-lg dark:text-surface-50 dark:bg-surface-800\">\n\t<div class=\"mx-auto flex h-16 max-w-7xl items-center gap-4 px-4\">\n\t\t<!-- Tool-Specific Controls (Dynamic) -->\n\t\t<div class=\"flex h-full flex-1 items-center gap-3\">\n\t\t\t{#if toolbarControls?.component}\n\t\t\t\t{@const Component = toolbarControls.component}\n\t\t\t\t{#if Component}\n\t\t\t\t\t<Component {...toolbarControls.props} />\n\t\t\t\t{/if}\n\t\t\t{/if}\n\t\t</div>\n\t</div>\n\n\t<!-- Validation Error Banner -->\n\t{#if imageEditorStore.state.error}\n\t\t<div\n\t\t\tclass=\"absolute bottom-full left-0 right-0 flex items-center justify-center bg-error-500 py-1 text-xs font-medium text-white\"\n\t\t\ttransition:fade={{ duration: 200 }}\n\t\t>\n\t\t\t<iconify-icon icon=\"mdi:alert-circle\" width=\"14\" class=\"mr-1\"></iconify-icon>\n\t\t\t{imageEditorStore.state.error}\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t:global(.dark) .border-t {\n\t\tborder-color: rgb(var(--color-surface-700) / 1);\n\t}\n</style>\n","<!--\n@file: src/components/imageEditor/ImageEditorModal.svelte\n@component\nA reusable modal that wraps the main Image Editor.\n-->\n<script lang=\"ts\">\n\timport type { MediaImage, WatermarkOptions } from '@shared/utils/media/mediaModels';\n\timport { setContext } from 'svelte';\n\timport Editor from './Editor.svelte';\n\timport EditorToolbar from './EditorToolbar.svelte';\n\timport { imageEditorStore } from '@shared/stores/imageEditorStore.svelte';\n\timport { editorWidgets } from './widgets/registry';\n\n\tlet {\n\t\timage = null,\n\t\twatermarkPreset = null,\n\t\tonsave = () => {},\n\t\tclose = () => {}\n\t}: {\n\t\timage: MediaImage | null;\n\t\t/** Optional watermark preset to auto-apply when editing */\n\t\twatermarkPreset?: WatermarkOptions | null;\n\t\tonsave?: (detail: any) => void;\n\t\tclose?: () => void;\n\t} = $props();\n\n\t// Provide watermark preset to child widgets via context\n\tsetContext('watermarkPreset', () => watermarkPreset);\n\n\tlet editorComponent: Editor | undefined = $state();\n\n\tconst activeState = $derived(imageEditorStore.state.activeState);\n\tconst activeWidget = $derived(editorWidgets.find((w: any) => w.key === activeState));\n\n\t// For Fine-Tune, we want to show the specific adjustment (e.g. contrast)\n\t// We'll peek into the toolbar props if available\n\tconst subInfo = $derived.by(() => {\n\t\tif (activeState === 'finetune') {\n\t\t\tconst props = imageEditorStore.state.toolbarControls?.props;\n\t\t\tif (props?.activeAdjustment) {\n\t\t\t\t// Capitalize first letter\n\t\t\t\tconst adj = props.activeAdjustment;\n\t\t\t\treturn {\n\t\t\t\t\tlabel: adj.charAt(0).toUpperCase() + adj.slice(1),\n\t\t\t\t\ticon: props.activeIcon\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t});\n\n\tfunction handleClose() {\n\t\tif (imageEditorStore.canUndoState) {\n\t\t\tif (!confirm('You have unsaved changes. Are you sure you want to close?')) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tclose();\n\t}\n\n\tfunction handleCancelClick() {\n\t\t// If a tool is active, exit the tool first\n\t\tif (activeState) {\n\t\t\timageEditorStore.cleanupToolSpecific(activeState);\n\t\t\timageEditorStore.setActiveState('');\n\t\t} else {\n\t\t\t// No tool active, ask for confirmation if dirty\n\t\t\tif (imageEditorStore.canUndoState) {\n\t\t\t\tif (!confirm('You have unsaved changes. Are you sure you want to discard them?')) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\thandleClose();\n\t\t}\n\t}\n\n</script>\n\n{#if image}\n\t<div class=\"relative flex h-full min-h-[500px] w-full flex-col overflow-hidden bg-surface-100 shadow-xl dark:bg-surface-800\">\n\t\t<header\n\t\t\tclass=\"flex items-center justify-between border-b border-surface-300 p-3 lg:p-4 dark:text-surface-50 bg-surface-100/80 dark:bg-surface-800/80 sticky top-0 z-10\"\n\t\t>\n\t\t\t<div class=\"flex items-center gap-3 overflow-hidden\">\n\t\t\t\t{#if activeWidget}\n\t\t\t\t\t<div class=\"flex items-center gap-2 text-primary-500 shrink-0\">\n\t\t\t\t\t\t<iconify-icon icon={activeWidget.icon} width=\"24\" class=\"max-sm:width-[20px]\"></iconify-icon>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"flex flex-col min-w-0\">\n\t\t\t\t\t\t<h2 id=\"image-editor-title\" class=\"text-sm lg:text-lg font-bold truncate leading-tight flex items-center gap-1.5\">\n\t\t\t\t\t\t\t<span class=\"max-sm:hidden\">{activeWidget.title}</span>\n\t\t\t\t\t\t\t{#if subInfo}\n\t\t\t\t\t\t\t\t<span class=\"max-sm:hidden text-surface-400\">:</span>\n\t\t\t\t\t\t\t\t<span class=\"flex items-center gap-1 text-primary-600 dark:text-primary-400 font-extrabold\">\n\t\t\t\t\t\t\t\t\t{#if subInfo.icon}\n\t\t\t\t\t\t\t\t\t\t<iconify-icon icon={subInfo.icon} width=\"16\" class=\"lg:width-[20px]\"></iconify-icon>\n\t\t\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t\t\t\t<span>{subInfo.label}</span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t{:else}\n\t\t\t\t\t\t\t\t<span class=\"sm:hidden\">{activeWidget.title}</span>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t</div>\n\t\t\t\t{:else}\n\t\t\t\t\t<h2 id=\"image-editor-title\" class=\"text-tertiary-500 dark:text-primary-400 text-lg font-semibold shrink-0\">Image Editor</h2>\n\t\t\t\t{/if}\n\t\t\t</div>\n\n\t\t\t<!-- Global Actions -->\n\t\t\t<div class=\"flex items-center gap-2\">\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => editorComponent?.handleUndo()}\n\t\t\t\t\tdisabled={!imageEditorStore.canUndoState}\n\t\t\t\t\tclass=\"btn-icon preset-outlined-surface-500\"\n\t\t\t\t\ttitle=\"Undo (Ctrl+Z)\"\n\t\t\t\t\taria-label=\"Undo\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:undo\" width=\"20\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t\t<button\n\t\t\t\t\tonclick={() => editorComponent?.handleRedo()}\n\t\t\t\t\tdisabled={!imageEditorStore.canRedoState}\n\t\t\t\t\tclass=\"btn-icon preset-outlined-surface-500\"\n\t\t\t\t\ttitle=\"Redo (Ctrl+Shift+Z)\"\n\t\t\t\t\taria-label=\"Redo\"\n\t\t\t\t>\n\t\t\t\t\t<iconify-icon icon=\"mdi:redo\" width=\"20\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t\t\t<button onclick={handleCancelClick} class=\"btn preset-outlined-surface-500\">\n\t\t\t\t\t{activeState ? 'Exit Tool' : 'Cancel'}\n\t\t\t\t</button>\n\t\t\t\t<button onclick={() => editorComponent?.handleSave()} class=\"btn preset-filled-tertiary-500 dark:preset-filled-primary-500\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:content-save\" width=\"18\"></iconify-icon>\n\t\t\t\t\t<span>Save</span>\n\t\t\t\t</button>\n\t\t\t\t<div class=\"h-6 w-px bg-surface-300 dark:bg-surface-600\"></div>\n\t\t\t\t<button onclick={handleClose} class=\"btn-icon preset-outlined-surface-500\" aria-label=\"Close\">\n\t\t\t\t\t<iconify-icon icon=\"mdi:close\" width=\"24\"></iconify-icon>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</header>\n\n\t\t<main class=\"flex-1 overflow-auto bg-surface-50/50 dark:bg-surface-900/50\">\n\t\t\t<Editor\n\t\t\t\tbind:this={editorComponent}\n\t\t\t\tinitialImageSrc={image.url}\n\t\t\t\tfocalPoint={image?.metadata?.focalPoint as { x: number; y: number } | undefined}\n\t\t\t\tonsave={(detail) => onsave(detail)}\n\t\t\t\toncancel={handleClose}\n\t\t\t/>\n\t\t</main>\n\t\t<EditorToolbar />\n\t</div>\n{/if}\n","/**\n * @file src/utils/media/api.ts\n * @description Media API client utilities\n */\n\nimport { logger } from '@shared/utils/logger';\n\ninterface Watermark {\n\tid: string;\n\tname: string;\n\turl?: string;\n}\n\n/** Update media metadata */\nexport async function updateMediaMetadata(id: string, patch: Record<string, unknown>): Promise<unknown> {\n\ttry {\n\t\tconst res = await fetch(`/api/media/${encodeURIComponent(id)}`, {\n\t\t\tmethod: 'PATCH',\n\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\tbody: JSON.stringify({ metadata: patch })\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tconst text = await res.text();\n\t\t\tthrow new Error(`HTTP ${res.status}: ${text}`);\n\t\t}\n\n\t\treturn await res.json();\n\t} catch (err) {\n\t\tlogger.error('updateMediaMetadata failed', { id, error: err });\n\t\tthrow err;\n\t}\n}\n\n/** Fetch watermarks from collection (fallback URLs) */\nexport async function fetchWatermarks(collectionId = 'Watermarks'): Promise<Watermark[]> {\n\tconst urls = [\n\t\t`/api/collections/${collectionId}?limit=100`,\n\t\t`/api/collections/${collectionId.toLowerCase()}?limit=100`,\n\t\t`/api/collections/${collectionId}/entries?limit=100`\n\t];\n\n\tfor (const url of urls) {\n\t\ttry {\n\t\t\tconst res = await fetch(url);\n\t\t\tif (!res.ok) continue;\n\n\t\t\tconst json = await res.json();\n\t\t\tconst items = Array.isArray(json) ? json : Array.isArray(json.data) ? json.data : Array.isArray(json.items) ? json.items : [];\n\n\t\t\treturn items.map((it: any) => ({\n\t\t\t\tid: it._id ?? it.id,\n\t\t\t\tname: it.name ?? it.title ?? `Watermark ${it._id ?? it.id}`,\n\t\t\t\turl: it.url ?? it.image?.url\n\t\t\t}));\n\t\t} catch (e) {\n\t\t\t// continue to next\n\t\t}\n\t}\n\n\tlogger.warn('No watermarks found', { collectionId });\n\treturn [];\n}\n","import type { MediaImage } from '@shared/utils/media/mediaModels';\nimport { mode } from '@shared/stores/collectionStore.svelte';\nimport { meta_data } from '@shared/utils/utils';\n\nexport const getWidgetData = async (\n\t_data: File | MediaImage | undefined,\n\tfield: any,\n\tvalue: any\n): Promise<File | MediaImage | { _id: string | undefined } | undefined> => {\n\tif (_data && _data instanceof File) {\n\t\t(_data as any).path = field.path;\n\t}\n\n\tif (value && !(value instanceof File) && _data && !(_data instanceof File) && _data?._id !== value?._id && value?._id && mode.value === 'edit') {\n\t\tmeta_data.add('media_images_remove', [value._id.toString()]);\n\t}\n\n\t// Assuming validateInput is defined in MediaUpload.svelte and needs to be called there\n\t// This function only returns the data, not handles validation directly\n\n\treturn _data || mode.value === 'create' ? _data : { _id: (value as MediaImage)?._id };\n};\n","<!--\n@file src/widgets/core/MediaUpload/MediaUpload.svelte\n@component\n**Media Upload Widget Component**\n\nThis component allows users to upload and manage single media files (images).\nIt integrates with a media library modal for selecting existing assets and provides\nfunctionality for image editing and basic file information display.\n\n### Props\n- `field`: FieldType & { path: string } - Configuration for the media upload field, including validation rules and storage path.\n- `value`: File | MediaImage - The currently selected file or media image object.\n\n### Features\n- **File Upload**: Allows direct file uploads via a file input.\n- **Media Library Integration**: Opens a modal to select existing media from the library.\n- **Image Preview**: Displays a preview of the selected image.\n- **Image Editing**: Provides an option to open a modal for image manipulation.\n- **File Information Display**: Shows details like file name, size, type, and timestamps.\n- **Validation**: Integrates with Valibot for client-side validation of file types.\n- **Reactivity**: Uses Svelte 5 runes (`$state`, `$props`, `$effect`) for efficient state management.\n- **Styling**: Adheres to the project's style guide using Tailwind CSS utility classes and semantic colors.\n-->\n<script lang=\"ts\">\n\timport type { ISODateString } from '@cms-types';\n\timport { convertTimestampToDateString, getFieldName } from '@shared/utils/utils';\n\timport { isoDateStringToDate } from '@shared/utils/dateUtils';\n\timport { logger } from '@shared/utils/logger';\n\n\t// ParaglideJS\n\timport * as m from '@shared/paraglide/messages';\n\n\t// Stores\n\timport { validationStore } from '@shared/stores/store.svelte';\n\timport { collectionValue } from '@shared/stores/collectionStore.svelte';\n\n\t// Components\n\timport type { MediaImage, WatermarkOptions } from '@shared/utils/media/mediaModels';\n\timport FileInput from '@cms/components/system/inputs/FileInput.svelte';\n\timport ImageEditorModal from '@cms/components/imageEditor/ImageEditorModal.svelte';\n\timport { updateMediaMetadata } from '@shared/utils/media/api';\n\n\t// Define reactive state\n\tlet isFlipped = $state(false);\n\n\tlet validationError: string | null = $state(null);\n\tlet debounceTimeout: number | undefined;\n\tlet showEditor = $state(false);\n\n\t// Define props\n\tlet { field, value = $bindable<File | MediaImage | undefined>() } = $props(); // 'value' is the bindable prop\n\n\t// Extract watermark preset from field configuration\n\tconst watermarkPreset = $derived((field as any).watermark as WatermarkOptions | undefined);\n\n\t// Effect to initialize 'value' if it's undefined and a default is available\n\t// This runs after the component has initialized and 'value' would have received its initial binding\n\t$effect(() => {\n\t\tif (value === undefined && (collectionValue.value as any)[getFieldName(field)] !== undefined) {\n\t\t\tvalue = (collectionValue.value as any)[getFieldName(field)];\n\t\t}\n\t});\n\n\t// Define validation schema\n\timport { object, string, number, union, instance, check, pipe, record, parse, type ValiError } from 'valibot';\n\n\tconst validImageTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp', 'image/avif', 'image/svg+xml'];\n\n\tconst fileSchema = pipe(\n\t\tinstance(File),\n\t\tcheck((input: File) => validImageTypes.includes(input.type), 'Invalid file format')\n\t);\n\n\tconst thumbnailSchema = object({\n\t\twidth: number(),\n\t\theight: number(),\n\t\turl: string()\n\t});\n\n\tconst mediaImageSchema = object({\n\t\t_id: string(),\n\t\tname: string(),\n\t\ttype: string(),\n\t\tsize: number(),\n\t\tpath: string(),\n\t\tthumbnails: record(string(), thumbnailSchema),\n\t\tcreatedAt: number(),\n\t\tupdatedAt: number()\n\t});\n\n\tconst widgetSchema = union([fileSchema, mediaImageSchema]);\n\n\t// Validation function\n\tfunction validateSchema(data: unknown): string | null {\n\t\ttry {\n\t\t\tparse(widgetSchema, data);\n\t\t\tvalidationStore.clearError(getFieldName(field));\n\t\t\treturn null;\n\t\t} catch (error) {\n\t\t\tif ((error as ValiError<any>).issues) {\n\t\t\t\tconst valiError = error as ValiError<any>;\n\t\t\t\tconst errorMessage = valiError.issues[0]?.message || 'Invalid input';\n\t\t\t\tvalidationStore.setError(getFieldName(field), errorMessage);\n\t\t\t\treturn errorMessage;\n\t\t\t}\n\t\t\treturn 'Invalid input';\n\t\t}\n\t}\n\n\t// Validate input with debounce\n\tfunction validateInput() {\n\t\tif (debounceTimeout) clearTimeout(debounceTimeout);\n\t\tdebounceTimeout = window.setTimeout(() => {\n\t\t\tvalidationError = validateSchema(value);\n\t\t}, 300);\n\t}\n\n\tasync function handleEditorSave(detail: { dataURL: string; file: File }) {\n\t\tconst { file: editedFile } = detail;\n\t\t// Create form data for the API request\n\t\tconst formData = new FormData();\n\t\tformData.append('processType', 'save');\n\t\tformData.append('files', editedFile);\n\n\t\t// Pass watermark options from field config if configured\n\t\tif (watermarkPreset) {\n\t\t\tformData.append('watermarkOptions', JSON.stringify(watermarkPreset));\n\t\t}\n\n\t\ttry {\n\t\t\t// Send to media API\n\t\t\tconst saveResponse = await fetch('/api/media/process', {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tbody: formData\n\t\t\t});\n\n\t\t\tif (!saveResponse.ok) {\n\t\t\t\tconst errorData = await saveResponse.json();\n\t\t\t\tthrow new Error(errorData.error || 'Failed to save edited image');\n\t\t\t}\n\n\t\t\tconst result = await saveResponse.json();\n\t\t\tif (!result.success || !result.data.data[0]?.success) {\n\t\t\t\tthrow new Error(result.data.data[0]?.error || 'Failed to process edited image');\n\t\t\t}\n\n\t\t\t// Update the widget data with the new persisted image data\n\t\t\tvalue = result.data.data[0].data; // Assign directly to the bindable prop\n\t\t\tshowEditor = false;\n\t\t} catch (error) {\n\t\t\tlogger.error('Error saving edited image:', error);\n\t\t}\n\t}\n\n\tlet focalPoint = $state({ x: 50, y: 50 });\n\tlet isDraggingFocalPoint = $state(false);\n\tlet containerRef: HTMLDivElement | undefined = $state(undefined); // Changed to $state\n\n\t// Global event handlers\n\tfunction handleGlobalMouseMove(event: MouseEvent) {\n\t\tif (isDraggingFocalPoint && containerRef) {\n\t\t\thandleFocalPointDrag(event, containerRef);\n\t\t}\n\t}\n\n\tfunction handleGlobalMouseUp() {\n\t\tif (isDraggingFocalPoint) {\n\t\t\tsaveFocalPoint();\n\t\t}\n\t}\n\n\t$effect(() => {\n\t\tif (value && !(value instanceof File) && value.metadata?.focalPoint) {\n\t\t\tfocalPoint = value.metadata.focalPoint;\n\t\t} else {\n\t\t\tfocalPoint = { x: 50, y: 50 };\n\t\t}\n\t});\n\n\t// Effect to attach/detach global listeners\n\t$effect(() => {\n\t\tif (isDraggingFocalPoint) {\n\t\t\twindow.addEventListener('mousemove', handleGlobalMouseMove);\n\t\t\twindow.addEventListener('mouseup', handleGlobalMouseUp);\n\t\t} else {\n\t\t\twindow.removeEventListener('mousemove', handleGlobalMouseMove);\n\t\t\twindow.removeEventListener('mouseup', handleGlobalMouseUp);\n\t\t}\n\n\t\t// Cleanup on component destroy\n\t\treturn () => {\n\t\t\twindow.removeEventListener('mousemove', handleGlobalMouseMove);\n\t\t\twindow.removeEventListener('mouseup', handleGlobalMouseUp);\n\t\t};\n\t});\n\n\tfunction handleFocalPointDrag(event: MouseEvent, container: HTMLDivElement) {\n\t\tif (!isDraggingFocalPoint) return;\n\t\tconst rect = container.getBoundingClientRect();\n\t\tlet x = ((event.clientX - rect.left) / rect.width) * 100;\n\t\tlet y = ((event.clientY - rect.top) / rect.height) * 100;\n\n\t\t// Clamp values between 0 and 100\n\t\tfocalPoint.x = Math.max(0, Math.min(100, x));\n\t\tfocalPoint.y = Math.max(0, Math.min(100, y));\n\t}\n\n\tasync function saveFocalPoint() {\n\t\tisDraggingFocalPoint = false;\n\t\tif (value && !(value instanceof File) && value._id) {\n\t\t\ttry {\n\t\t\t\tawait updateMediaMetadata(value._id, { focalPoint });\n\t\t\t\t// Optionally show a success toast\n\t\t\t} catch (e) {\n\t\t\t\tlogger.error('Failed to save focal point', e);\n\t\t\t\t// Optionally show an error toast\n\t\t\t}\n\t\t}\n\t}\n\n\timport { getWidgetData } from './widgetData';\n\n\t// The `WidgetData` function needs to be explicitly defined or called when needed.\n\texport async function WidgetDataExport() {\n\t\treturn getWidgetData(value, field, value);\n\t}\n\n\t// Helper function to get timestamp\n\tfunction getTimestamp(date: Date | number | ISODateString): number {\n\t\tif (typeof date === 'number') return date;\n\t\tif (typeof date === 'string') return isoDateStringToDate(date as ISODateString).getTime();\n\t\treturn date.getTime();\n\t}\n</script>\n\n<div class=\"relative mb-4 min-h-1\">\n\t{#if !value}\n\t\t<!-- File Input -->\n\t\t<div class=\"rounded-lg border-2 border-dashed border-transparent\" class:!border-error-500={!!validationError}>\n\t\t\t<FileInput bind:value bind:multiple={field.multiupload} onChange={validateInput} />\n\t\t</div>\n\t{:else}\n\t\t<div\n\t\t\tclass=\"flex w-full max-w-full flex-col border-2 border-dashed border-surface-600 bg-surface-200 dark:border-surface-500 dark:bg-surface-700\"\n\t\t\tclass:error={!!validationError}\n\t\t>\n\t\t\t<!-- Preview -->\n\t\t\t<div class=\"mx-2 flex flex-col gap-2\">\n\t\t\t\t<!-- Image Header -->\n\t\t\t\t<div class=\"flex items-center justify-between gap-2\">\n\t\t\t\t\t<p class=\"text-left\">\n\t\t\t\t\t\t{m.widget_ImageUpload_Name()}\n\t\t\t\t\t\t<span class=\"text-tertiary-500 dark:text-primary-500\">{value instanceof File ? value.name : (value as MediaImage).path}</span>\n\t\t\t\t\t</p>\n\n\t\t\t\t\t<p class=\"text-left\">\n\t\t\t\t\t\t{m.widget_ImageUpload_Size()}\n\t\t\t\t\t\t<span class=\"text-tertiary-500 dark:text-primary-500\">{((value.size ?? 0) / 1024).toFixed(2)} KB</span>\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t<!-- Image and Actions Container -->\n\t\t\t\t<div class=\"flex items-center justify-between\">\n\t\t\t\t\t{#if !isFlipped}\n\t\t\t\t\t\t<div class=\"relative col-span-11 m-auto\" bind:this={containerRef}>\n\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\tsrc={value instanceof File ? URL.createObjectURL(value) : value.thumbnails?.sm?.url || value.url}\n\t\t\t\t\t\t\t\talt=\"Preview\"\n\t\t\t\t\t\t\t\tclass=\"max-h-[200px] max-w-[500px] rounded\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t{#if value && !(value instanceof File)}\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tclass=\"absolute cursor-move\"\n\t\t\t\t\t\t\t\t\tstyle={`left: ${focalPoint.x}%; top: ${focalPoint.y}%; transform: translate(-50%, -50%);`}\n\t\t\t\t\t\t\t\t\tonmousedown={() => (isDraggingFocalPoint = true)}\n\t\t\t\t\t\t\t\t\trole=\"button\"\n\t\t\t\t\t\t\t\t\ttabindex=\"0\"\n\t\t\t\t\t\t\t\t\taria-label=\"Set focal point\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<iconify-icon icon=\"mdi:plus-circle-outline\" width=\"24\" class=\"text-primary-500 drop-shadow-lg\"></iconify-icon>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{/if}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{:else}\n\t\t\t\t\t\t<div class=\"col-span-11 ml-2 grid grid-cols-2 gap-1 text-left\">\n\t\t\t\t\t\t\t<p class=\"\">{m.widget_ImageUpload_Type()}</p>\n\t\t\t\t\t\t\t<p class=\"font-bold text-tertiary-500 dark:text-primary-500\">{(value as any).type}</p>\n\t\t\t\t\t\t\t<p class=\"\">Path:</p>\n\t\t\t\t\t\t\t<p class=\"font-bold text-tertiary-500 dark:text-primary-500\">{(value as any).path}</p>\n\t\t\t\t\t\t\t<p class=\"\">{m.widget_ImageUpload_Uploaded()}</p>\n\t\t\t\t\t\t\t<p class=\"font-bold text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t\t\t\t\t{convertTimestampToDateString(getTimestamp((value as any) instanceof File ? (value as any).lastModified : (value as any).createdAt))}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"\">{m.widget_ImageUpload_LastModified()}</p>\n\t\t\t\t\t\t\t<p class=\"font-bold text-tertiary-500 dark:text-primary-500\">\n\t\t\t\t\t\t\t\t{convertTimestampToDateString(getTimestamp((value as any) instanceof File ? (value as any).lastModified : (value as any).updatedAt))}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{/if}\n\n\t\t\t\t\t<!-- Buttons -->\n\t\t\t\t\t<div class=\"col-span-1 flex flex-col items-end justify-between gap-2 p-2\">\n\t\t\t\t\t\t<!-- Edit -->\n\t\t\t\t\t\t<button onclick={() => (showEditor = true)} aria-label=\"Edit image\" class=\"preset-outlined-surface-500 btn-icon\" title=\"Edit image\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:edit\" width=\"24\" class=\"text-primary-500\"></iconify-icon>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<!-- Flip -->\n\t\t\t\t\t\t<button onclick={() => (isFlipped = !isFlipped)} aria-label=\"Flip\" class=\"preset-outlined-surface-500 btn-icon\" title=\"Flip details\">\n\t\t\t\t\t\t\t<iconify-icon\n\t\t\t\t\t\t\t\ticon=\"uiw:reload\"\n\t\t\t\t\t\t\t\twidth=\"24\"\n\t\t\t\t\t\t\t\tclass={isFlipped ? ' rotate-90 text-yellow-500 transition-transform duration-300' : 'text-white  transition-transform duration-300'}\n\t\t\t\t\t\t\t></iconify-icon>\n\t\t\t\t\t\t</button>\n\n\t\t\t\t\t\t<!-- Delete -->\n\t\t\t\t\t\t<button onclick={() => (value = undefined)} aria-label=\"Delete\" class=\"preset-outlined-surface-500 btn-icon\" title=\"Delete image\">\n\t\t\t\t\t\t\t<iconify-icon icon=\"material-symbols:delete-outline\" width=\"30\" class=\"text-error-500\"></iconify-icon>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n\n\t<!-- Error Message -->\n\t{#if validationError}\n\t\t<p id={`${getFieldName(field)}-error`} class=\"absolute -bottom-4 left-0 w-full text-center text-xs text-error-500\" role=\"alert\">\n\t\t\t{validationError}\n\t\t</p>\n\t{/if}\n\n\t<!-- Editor Modal -->\n\t{#if showEditor}\n\t\t<ImageEditorModal image={value instanceof File ? null : value} {watermarkPreset} onsave={handleEditorSave} close={() => (showEditor = false)} />\n\t{/if}\n</div>\n"],"file":"Cq1QVEmY.js"}