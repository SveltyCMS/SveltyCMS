{"version":3,"file":"PsFRGuNZ.js","sources":["../../../../../../../../shared/database/src/auth/types.ts"],"sourcesContent":["/**\n * @file src/databases/auth/types.ts\n * @description Core types and enums for the authentication system\n *\n * This file contains the core type definitions and enums that are used\n * throughout the authentication system to avoid circular imports.\n */\n\nimport type { ISODateString } from '@cms-types/content';\n\n// Permission Actions\nexport enum PermissionAction {\n\tCREATE = 'create', // Grants the ability to create a new resource or record.\n\tREAD = 'read', // Grants the ability to read or view a resource or record.\n\tUPDATE = 'update', // Grants the ability to modify or update an existing resource or record.\n\tDELETE = 'delete', // Grants the ability to remove or delete a resource or record.\n\tWRITE = 'write', // Grants the ability to write or modify a resource or record.\n\tMANAGE = 'manage', // Grants overarching control over a resource or area, typically used for admin purposes.\n\tSHARE = 'share', // Grants the ability to share a resource or record with others, typically used for collaboration.\n\tACCESS = 'access', // Grants basic access to a resource or area, typically used for admin purposes.\n\tEXECUTE = 'execute' // Grants the ability to execute a command or function, typically used for admin purposes.\n}\n\n// Permission Types\nexport enum PermissionType {\n\tCOLLECTION = 'collection', // Collection-related permissions\n\tUSER = 'user', // User-related permissions\n\tCONFIGURATION = 'configuration', // Configuration-related permissions\n\tSYSTEM = 'system', // System-wide permissions\n\tAPI = 'api' // API-related permissions\n}\n\n// User Interface\nexport interface User {\n\t_id: string; // Unique identifier for the user\n\tid?: string; // Alias for _id, used in some contexts\n\temail: string; // Email address of the user\n\ttenantId?: string; // Identifier for the tenant the user belongs to (in multi-tenant mode)\n\tpassword?: string; // Hashed password of the user\n\trole: string; // Role of the user (e.g., admin, developer, editor, user)\n\tusername?: string; // Username of the user\n\tfirstName?: string; // First name of the user\n\tlastName?: string; // Last name of the user\n\tlocale?: string; // Locale of the user\n\tavatar?: string; // URL of the user's avatar image\n\tlastAuthMethod?: string; // The last authentication method used by the user\n\tlastActiveAt?: ISODateString; // The last time the user was active (ISO date string)\n\texpiresAt?: ISODateString; // When the reset token expires (ISO date string)\n\tisRegistered?: boolean; // Indicates if the user has completed registration\n\tfailedAttempts?: number; // Tracks the number of consecutive failed login attempts\n\tblocked?: boolean; // Indicates if the user is blocked\n\tresetRequestedAt?: ISODateString; // The last time the user requested a password reset (ISO date string)\n\tresetToken?: string; // Token for resetting the user's password\n\tlockoutUntil?: ISODateString | null; // Time until which the user is locked out of their account (ISO date string)\n\tis2FAEnabled?: boolean; // Indicates if the user has enabled two-factor authentication\n\ttotpSecret?: string; // TOTP secret for 2FA (base32 encoded)\n\tbackupCodes?: string[]; // Array of hashed backup codes for 2FA recovery\n\tlast2FAVerification?: ISODateString; // Timestamp of last successful 2FA verification\n\tpermissions: string[]; // Set of permissions associated with the user\n\tgoogleRefreshToken?: string | null; // Stores the refresh token from Google OAuth for token revocation on logout.\n\tisAdmin?: boolean; // Indicates if the user has admin privileges\n\tactiveSessions?: number; // Number of active sessions\n\tlastAccess?: ISODateString; // Last access timestamp\n}\n\n// Role Interface\nexport interface Role {\n\t_id: string; // Unique identifier for the role\n\tname: string; // Name of the role\n\tdescription?: string; // Optional description of the role\n\tisAdmin?: boolean; // Indicates if the role has admin privileges\n\tpermissions: string[]; // Array of permission IDs associated with the role\n\ttenantId?: string; // Optional tenant identifier for multi-tenant installations\n\tgroupName?: string; // Optional group name associated with the role\n\ticon?: string; // Optional icon for the role (e.g., for UI display)\n\tcolor?: string; // Optional color for the role (e.g., for UI display)\n}\n\nexport interface Permission {\n\t_id: string; // Use _id for a unique identifier\n\tname: string; // Display name of the permission\n\taction: PermissionAction; // Use the PermissionAction enum\n\ttype: PermissionType; // Type of the permission context, e.g., \"system\", \"collection\"\n\tcontextId?: string; // Identifier for the context in which the permission is used (optional)\n\tdescription?: string; // Optional description for the permission\n}\n\n// RolePermissions Interface\nexport interface RolePermissions {\n\t[role: string]: {\n\t\tcreate?: boolean;\n\t\tread?: boolean;\n\t\twrite?: boolean;\n\t\tdelete?: boolean;\n\t\tmanage?: boolean;\n\t};\n}\n\n// Session Interface\nexport interface Session {\n\t_id: string; // Unique identifier for the session\n\tuser_id: string; // The ID of the user who owns the session\n\texpires: ISODateString; // When the session expires (ISO date string)\n\ttenantId?: string; // Identifier for the tenant the session belongs to (in multi-tenant mode)\n\trotated?: boolean; // Flag to mark rotated sessions\n\trotatedTo?: string; // ID of the new session this was rotated to\n}\n\n// Token Interface\nexport interface Token {\n\t_id: string; // Unique identifier for the token\n\tuser_id: string; // The ID of the user who owns the token\n\ttoken: string; // The token string\n\temail: string; // Email associated with the token\n\texpires: ISODateString; // When the session expires (ISO date string)\n\ttype: string; // Type of the token (e.g., 'create', 'register', 'reset')\n\ttenantId?: string; // Tenant ID for multi-tenancy support\n\tblocked?: boolean; // Whether the token is blocked\n\tusername?: string; // Username associated with the token\n\trole?: string; // Role associated with the token\n\tcreatedAt?: ISODateString; // When the token was created\n\tupdatedAt?: ISODateString; // When the token was last updated\n}\n\n// Session Store Interface\nexport interface SessionStore {\n\tget(session_id: string): Promise<User | null>;\n\tset(session_id: string, user: User, expiration: ISODateString): Promise<void>;\n\tdelete(session_id: string): Promise<void>;\n\tdeletePattern(pattern: string): Promise<number>;\n\tvalidateWithDB(session_id: string, dbValidationFn: (session_id: string) => Promise<User | null>): Promise<User | null>;\n\tclose(): Promise<void>;\n}\n\n// Collection Interface\nexport interface Collection {\n\tcollection_id: string; // Unique identifier for the collection\n\tname: string; // Name of the collection\n\tpermissions: PermissionId[]; // Permissions specific to this collection\n}\n\n// Cookie Type\nexport type Cookie = {\n\tname: string; // Name of the cookie\n\tvalue: string; // Value of the cookie\n\tattributes: {\n\t\t// Attributes of the cookie\n\t\tsameSite: boolean | 'lax' | 'strict' | 'none' | undefined;\n\t\tpath: string;\n\t\thttpOnly: boolean;\n\t\texpires: ISODateString; // Expiration date of the cookie (ISO date string)\n\t\tsecure: boolean;\n\t};\n};\n\n// RateLimit Interface\nexport interface RateLimit {\n\tuser_id: string; // User ID the rate limit applies to\n\taction: ConfigPermissionAction; // Action being rate-limited\n\tlimit: number; // Maximum allowed actions\n\twindowMs: number; // Time window in milliseconds\n\tcurrent: number; // Current count of actions performed\n\tlastActionAt: string; // Last action timestamp (ISO date string)\n}\n\n// Icon and Color Mapping for Permissions\nexport const icon = {\n\tcreate: 'bi:plus-circle-fill',\n\tread: 'bi:eye-fill',\n\twrite: 'bi:pencil-fill',\n\tdelete: 'bi:trash-fill',\n\tshare: 'bi:share-fill'\n} as const;\n\nexport const color = {\n\tdisabled: {\n\t\tcreate: 'preset-outline-primary-500',\n\t\tread: 'preset-outline-tertiary-500',\n\t\twrite: 'variant-outline-warning',\n\t\tdelete: 'variant-outline-error',\n\t\tshare: 'preset-outline-secondary-500'\n\t},\n\tenabled: {\n\t\tcreate: 'preset-filled-primary-500',\n\t\tread: 'preset-filled-tertiary-500',\n\t\twrite: 'variant-filled-warning',\n\t\tdelete: 'preset-filled-error-500',\n\t\tshare: 'variant-filled-secondary'\n\t}\n} as const;\n\n// Sanitizes a permissions dictionary by removing empty roles\nexport const sanitizePermissions = (permissions: Record<string, Record<string, boolean>>) => {\n\tconst res = Object.entries(permissions).reduce(\n\t\t(acc, [role, actions]) => {\n\t\t\tconst nonEmptyActions = Object.entries(actions).reduce(\n\t\t\t\t(actionAcc, [action, value]) => {\n\t\t\t\t\tif (value !== false) {\n\t\t\t\t\t\tactionAcc[action] = value;\n\t\t\t\t\t}\n\t\t\t\t\treturn actionAcc;\n\t\t\t\t},\n\t\t\t\t{} as Record<string, boolean>\n\t\t\t);\n\n\t\t\tif (Object.keys(nonEmptyActions).length > 0) {\n\t\t\t\tacc[role] = nonEmptyActions;\n\t\t\t}\n\t\t\treturn acc;\n\t\t},\n\t\t{} as Record<string, Record<string, boolean>>\n\t);\n\n\treturn Object.keys(res).length === 0 ? undefined : res;\n};\n\n// Model Interface for Generic CRUD Operations\nexport interface Model<T> {\n\t// Creates a new document\n\tcreate(data: Partial<T>): Promise<T>;\n\n\t// Finds a single document matching the query\n\tfindOne(query: Partial<T>): Promise<T | null>;\n\n\t// Finds multiple documents matching the query\n\tfind(query: Partial<T>): Promise<T[]>;\n\n\t// Updates a single document matching the query\n\tupdateOne(query: Partial<T>, update: Partial<T>): Promise<void>;\n\n\t// Deletes a single document matching the query\n\tdeleteOne(query: Partial<T>): Promise<void>;\n\n\t// Counts the number of documents matching the query\n\tcountDocuments(query?: Partial<T>): Promise<number>;\n}\n\n// Additional Types\nexport type WidgetId = string; // Unique identifier for a widget\nexport declare const permissionMap: Map<string, Permission>;\nexport type PermissionId = string;\nexport type ConfigPermissionAction = string;\nexport type Field = unknown;\n\n// Schema Interface\nexport interface Schema {\n\ticon?: string; // Optional icon representing the schema\n\tstatus?: string; // Optional status of the schema\n\trevision?: boolean; // Indicates if the schema supports revisions\n\tpermissions?: RolePermissions; // Role-based permissions associated with the schema\n\tfields: Field[]; // Array of fields defined in the schema, using the Field type from collections/types\n}\n\n// Helper to assign all permissions to a role (e.g., admin)\nexport function assignAllPermissionsToRole(role: Role): void {\n\trole.permissions = Array.from(permissionMap.keys());\n}\n\n// Helper to assign permissions by type or action\nexport function assignPermissionsByFilter(role: Role, filter: (perm: Permission) => boolean): void {\n\trole.permissions = Array.from(permissionMap.values())\n\t\t.filter(filter)\n\t\t.map((perm) => perm._id);\n}\n"],"names":["PermissionAction","PermissionType"],"mappings":"AAWO,IAAKA,GAAAA,IACXA,EAAA,OAAS,SACTA,EAAA,KAAO,OACPA,EAAA,OAAS,SACTA,EAAA,OAAS,SACTA,EAAA,MAAQ,QACRA,EAAA,OAAS,SACTA,EAAA,MAAQ,QACRA,EAAA,OAAS,SACTA,EAAA,QAAU,UATCA,IAAAA,GAAA,CAAA,CAAA,EAaAC,GAAAA,IACXA,EAAA,WAAa,aACbA,EAAA,KAAO,OACPA,EAAA,cAAgB,gBAChBA,EAAA,OAAS,SACTA,EAAA,IAAM,MALKA,IAAAA,GAAA,CAAA,CAAA"}