{"version":3,"file":"DMJunDHd.js","sources":["../../../../../../src/widgets/custom/RemoteVideo/Input.svelte"],"sourcesContent":["<!--\n@file src/widgets/custom/RemoteVideo/Input.svelte\n@component\n**RemoteVideo Widget Input Component**\n\nProvides URL input with automatic video metadata fetching and preview from multiple platforms.\nPart of the Three Pillars Architecture for widget system.\n\n@example\n<RemoteVideoInput bind:value={videoData} field={{ allowedPlatforms: [\"youtube\", \"vimeo\"] }} />\n<!-- User enters URL → fetches metadata → shows preview with thumbnail and details\n\n### Props\n- `field: FieldType` - Widget field definition with allowed platforms configuration\n- `value: RemoteVideoData | null | undefined` - Video metadata object (bindable)\n- `error?: string | null` - Validation error message for display\n\n### Features\n- **Multi-Platform Support**: YouTube, Vimeo, Twitch, TikTok integration\n- **Automatic Metadata Fetching**: Debounced API calls for video information\n- **Rich Preview**: Thumbnail, title, channel, and duration display\n- **Security First**: Server-side metadata fetching with platform validation\n- **Loading States**: Visual feedback during API requests with spinner\n- **Error Handling**: Comprehensive error display for failed requests\n- **URL Validation**: HTML5 URL input with platform-specific validation\n- **Debounced Input**: Performance-optimized API calls (500ms delay)\n- **Accessibility**: Full ARIA support with loading and error states\n-->\n\n<script lang=\"ts\">\n\timport type { FieldType } from './';\n\timport { logger } from '@shared/utils/logger';\n\timport type { RemoteVideoData } from './types';\n\n\timport { debounce } from '@shared/utils/utils';\n\n\tlet { field, value, error }: { field: FieldType; value: RemoteVideoData | null | undefined; error?: string | null } = $props();\n\n\t// Local state for the URL input.\n\tlet urlInput = $state('');\n\t// Local state to temporarily hold fetched metadata before it's set to `value`.\n\tlet fetchedMetadata = $state<RemoteVideoData | null>(null);\n\tlet isLoading = $state(false);\n\tlet fetchError = $state<string | null>(null);\n\n\t// Effect to update local `urlInput` when parent `value` changes externally.\n\t$effect(() => {\n\t\tif (value?.url && value.url !== urlInput) {\n\t\t\turlInput = value.url;\n\t\t\tfetchedMetadata = value; // Also update fetchedMetadata if parent provides it.\n\t\t} else if (!value) {\n\t\t\turlInput = '';\n\t\t\tfetchedMetadata = null;\n\t\t}\n\t});\n\n\t// SECURITY: URL validation patterns to prevent SSRF attacks\n\tconst ALLOWED_PLATFORMS: Record<string, RegExp> = {\n\t\tyoutube: /^https?:\\/\\/(www\\.)?(youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]{11})/,\n\t\tvimeo: /^https?:\\/\\/(www\\.)?vimeo\\.com\\/\\d+$/,\n\t\ttwitch: /^https?:\\/\\/(www\\.)?twitch\\.tv\\/videos\\/\\d+$/,\n\t\ttiktok: /^https?:\\/\\/(www\\.)?tiktok\\.com\\/@[\\w.-]+\\/video\\/\\d+$/\n\t};\n\n\tfunction validateVideoUrl(url: string): { valid: boolean; error?: string } {\n\t\tconst rawPlatforms = field.allowedPlatforms || ['youtube', 'vimeo', 'twitch', 'tiktok'];\n\t\tconst allowedPlatforms: string[] = Array.isArray(rawPlatforms)\n\t\t\t? rawPlatforms\n\t\t\t: typeof rawPlatforms === 'string'\n\t\t\t\t? rawPlatforms.split(',').map((p: string) => p.trim())\n\t\t\t\t: [];\n\n\t\tconst isValid = allowedPlatforms.some((platform) => ALLOWED_PLATFORMS[platform]?.test(url));\n\n\t\tif (!isValid) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\terror: `Invalid or disallowed video URL. Allowed platforms: ${allowedPlatforms.join(', ')}`\n\t\t\t};\n\t\t}\n\t\treturn { valid: true };\n\t}\n\n\t// Debounced function to fetch video metadata from the server.\n\tconst fetchVideoMetadata = debounce.create((...args: unknown[]) => {\n\t\tconst url = typeof args[0] === 'string' ? args[0] : '';\n\t\tisLoading = true;\n\t\tfetchError = null;\n\t\tfetchedMetadata = null;\n\n\t\tif (!url) {\n\t\t\tisLoading = false;\n\t\t\treturn;\n\t\t}\n\n\t\t// SECURITY: Validate URL before making API call\n\t\tconst validation = validateVideoUrl(url);\n\t\tif (!validation.valid) {\n\t\t\tfetchError = validation.error || 'Invalid video URL';\n\t\t\tisLoading = false;\n\t\t\tvalue = null;\n\t\t\treturn;\n\t\t}\n\n\t\t// Async fetch wrapped in promise\n\t\t(async () => {\n\t\t\ttry {\n\t\t\t\t// Call API endpoint to fetch metadata securely\n\t\t\t\tconst response = await fetch('/api/remoteVideo', {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\t\t// Send a JSON object\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\turl,\n\t\t\t\t\t\tallowedPlatforms: field.allowedPlatforms\n\t\t\t\t\t})\n\t\t\t\t});\n\n\t\t\t\tconst result = await response.json();\n\n\t\t\t\tif (response.ok && result.success) {\n\t\t\t\t\tfetchedMetadata = result.data;\n\t\t\t\t\tvalue = result.data; // Bind the full metadata object back to the parent.\n\t\t\t\t} else {\n\t\t\t\t\tfetchError = result.error || 'Failed to fetch video metadata.';\n\t\t\t\t\tvalue = null; // Clear parent value on error.\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tlogger.error('Error fetching video metadata:', e);\n\t\t\t\tfetchError = 'An unexpected error occurred while fetching video data.';\n\t\t\t\tvalue = null;\n\t\t\t} finally {\n\t\t\t\tisLoading = false;\n\t\t\t}\n\t\t})();\n\t}, 500);\n\n\t// Trigger fetch when the URL input changes.\n\tfunction handleUrlInput() {\n\t\tfetchVideoMetadata(urlInput);\n\t}\n</script>\n\n<div class=\"input-container\" class:invalid={error || fetchError}>\n\t<label for={field.db_fieldName} class=\"label\">Video URL</label>\n\t<input\n\t\ttype=\"url\"\n\t\tid={field.db_fieldName}\n\t\tname={field.db_fieldName}\n\t\trequired={field.required}\n\t\tplaceholder={typeof field.placeholder === 'string' ? field.placeholder : 'e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ'}\n\t\tbind:value={urlInput}\n\t\toninput={handleUrlInput}\n\t\tclass=\"input\"\n\t\tclass:loading={isLoading}\n\t\taria-invalid={!!error || !!fetchError}\n\t\taria-describedby={error || fetchError ? `${field.db_fieldName}-error` : undefined}\n\t/>\n\n\t{#if error || fetchError}\n\t\t<p id={`${field.db_fieldName}-error`} class=\"error-message\" role=\"alert\">\n\t\t\t{error || fetchError}\n\t\t</p>\n\t{/if}\n\n\t{#if fetchedMetadata && !isLoading && !fetchError}\n\t\t<div class=\"video-preview\">\n\t\t\t<img src={fetchedMetadata.thumbnailUrl} alt={fetchedMetadata.title} class=\"thumbnail\" />\n\t\t\t<div class=\"details\">\n\t\t\t\t<h3>{fetchedMetadata.title}</h3>\n\t\t\t\t{#if fetchedMetadata.channelTitle}\n\t\t\t\t\t<p>By: {fetchedMetadata.channelTitle}</p>\n\t\t\t\t{/if}\n\t\t\t\t{#if fetchedMetadata.duration}\n\t\t\t\t\t<p>Duration: {fetchedMetadata.duration}</p>\n\t\t\t\t{/if}\n\t\t\t\t<a href={fetchedMetadata.url} target=\"_blank\" rel=\"noopener noreferrer\" class=\"watch-link\">Watch on {fetchedMetadata.platform}</a>\n\t\t\t</div>\n\t\t</div>\n\t{/if}\n</div>\n\n<style>\n\t/* Add styles for input, preview, thumbnail, details, and error messages */\n\t.input-container {\n\t\tposition: relative;\n\t\tpadding-bottom: 1.5rem;\n\t\twidth: 100%;\n\t}\n\t.input.loading {\n\t\t/* Add a loading spinner or indicator to the input */\n\t\tbackground-image: url('data:image/svg+xml;charset=utf8,<svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zM12 4V2c-5.523 0-10 4.477-10 10s4.477 10 10 10v-2c-4.411 0-8-3.589-8-8s3.589-8 8-8z\" fill=\"%234A90E2\"/></svg>'); /* Replace with actual spinner SVG */\n\t\tbackground-repeat: no-repeat;\n\t\tbackground-position: right 8px center;\n\t\tbackground-size: 20px;\n\t\tanimation: spin 1s linear infinite;\n\t}\n\t@keyframes spin {\n\t\tfrom {\n\t\t\ttransform: rotate(0deg);\n\t\t}\n\t\tto {\n\t\t\ttransform: rotate(360deg);\n\t\t}\n\t}\n\t.video-preview {\n\t\tdisplay: flex;\n\t\tgap: 1rem;\n\t\tmargin-top: 1rem;\n\t\tborder: 1px solid #eee;\n\t\tpadding: 1rem;\n\t\tborder-radius: 8px;\n\t\talign-items: flex-start;\n\t}\n\t.thumbnail {\n\t\twidth: 120px;\n\t\theight: auto;\n\t\tflex-shrink: 0;\n\t}\n\t.details h3 {\n\t\tfont-size: 1.1em;\n\t\tfont-weight: bold;\n\t\tmargin-top: 0;\n\t\tmargin-bottom: 0.5rem;\n\t}\n\t.details p {\n\t\tfont-size: 0.9em;\n\t\tcolor: #555;\n\t\tmargin-bottom: 0.25rem;\n\t}\n\t.watch-link {\n\t\tcolor: #007bff;\n\t\ttext-decoration: underline;\n\t\tfont-size: 0.9em;\n\t}\n\t.error-message {\n\t\tposition: absolute;\n\t\tbottom: 0;\n\t\tleft: 0;\n\t\twidth: 100%;\n\t\ttext-align: center;\n\t\tfont-size: 0.75rem;\n\t\tcolor: #ef4444;\n\t}\n</style>\n"],"names":["value","$.prop","$$props","urlInput","$.state","fetchedMetadata","isLoading","fetchError","$.user_effect","$.get","$.set","ALLOWED_PLATFORMS","validateVideoUrl","url","rawPlatforms","allowedPlatforms","p","platform","fetchVideoMetadata","debounce","args","validation","response","result","e","logger","handleUrlInput","div","root","label","input","$.sibling","$.remove_input_defaults","node","p_1","root_1","$.set_attribute","$$render","consequent","div_1","root_2","img","div_2","h3","p_2","root_3","$.template_effect","$.set_text","text_2","consequent_1","p_3","root_4","text_3","consequent_2","a","node_3","text_1","text_4","consequent_3","classes","$.set_class","classes_1","$$value"],"mappings":"82BA6BA,aAOcA,EAAKC,GAAAC,EAAA,QAAA,CAAA,EAGdC,EAAWC,EAAO,EAAE,EAEpBC,EAAkBD,EAA+B,IAAI,EACrDE,EAAYF,EAAO,EAAK,EACxBG,EAAaH,EAAsB,IAAI,EAG3CI,EAAO,IAAO,CACTR,EAAK,GAAE,KAAOA,EAAK,EAAC,MAAGS,EAAKN,CAAQ,KACvCA,EAAWH,IAAM,IAAG,EAAA,IACpBK,EAAkBL,EAAK,OACZA,MACXU,EAAAP,EAAW,EAAE,EACbO,EAAAL,EAAkB,IAAI,EAExB,CAAC,QAGKM,EAAyC,CAC9C,QAAS,+EACT,MAAO,uCACP,OAAQ,+CACR,OAAQ,mEAGAC,EAAiBC,EAAiD,OACpEC,EAAYZ,EAAA,MAAS,kBAAgB,CAAK,UAAW,QAAS,SAAU,QAAQ,EAChFa,EAA6B,MAAM,QAAQD,CAAY,EAC1DA,EACO,OAAAA,GAAiB,SACvBA,EAAa,MAAM,GAAG,EAAE,IAAKE,GAAcA,EAAE,KAAI,CAAA,EAAA,CAAA,EAKhD,OAFWD,EAAiB,KAAME,GAAaN,EAAkBM,CAAQ,GAAG,KAAKJ,CAAG,CAAA,EAQhF,CAAA,MAAO,EAAI,GAJlB,MAAO,GACP,MAAK,uDAAyDE,EAAiB,KAAK,IAAI,CAAA,GAI3F,OAGMG,EAAqBC,GAAS,OAAW,IAAAC,IAAoB,OAC5DP,EAAG,OAAUO,EAAK,CAAC,GAAM,SAAWA,EAAK,CAAC,EAAI,GAK/C,GAJLV,EAAAJ,EAAY,EAAI,EAChBI,EAAAH,EAAa,IAAI,EACjBG,EAAAL,EAAkB,IAAI,EAEjB,CAAAQ,EAAK,CACTH,EAAAJ,EAAY,EAAK,QAElB,OAGMe,EAAaT,EAAiBC,CAAG,MAClCQ,EAAW,MAAO,CACtBX,EAAAH,EAAac,EAAW,OAAS,oBAAmB,EAAA,EACpDX,EAAAJ,EAAY,EAAK,EACjBN,EAAQ,IAAI,QAEb,EAGa,SAAA,CACR,GAAA,OAEGsB,EAAQ,MAAS,MAAM,mBAAkB,CAC9C,OAAQ,OACR,QAAO,CAAI,eAAgB,kBAAkB,EAE7C,KAAM,KAAK,WACV,IAAAT,EACA,iBAAgBX,EAAA,MAAQ,gBAAA,CAAA,IAIpBqB,EAAM,MAASD,EAAS,KAAI,EAE9BA,EAAS,IAAMC,EAAO,WACzBlB,EAAkBkB,EAAO,KAAI,EAAA,EAC7BvB,EAAQuB,EAAO,QAEfb,EAAAH,EAAagB,EAAO,OAAS,kCAAiC,EAAA,EAC9DvB,EAAQ,MAEV,OAASwB,EAAG,CACXC,GAAO,MAAM,iCAAkCD,CAAC,EAChDd,EAAAH,EAAa,yDAAyD,EACtEP,EAAQ,IAAI,CACb,QAAC,CACAU,EAAAJ,EAAY,EAAK,CAClB,CACD,GAAC,CACF,EAAG,KAGM,SAAAoB,GAAiB,CACzBR,IAAmBf,CAAQ,CAAA,CAC5B,KAGAwB,EAAGC,GAAA,QACF,IAAAC,IADDF,CAAG,EAEFG,EAAAC,EADAF,EAAK,CAAA,EACLG,EAAAF,CAAA,EAAAA,EAOA,QAASJ,QAPT,IAAAO,EAAAF,EAAAD,EAAA,CAAA,iBAeCI,EAACC,GAAA,MAADD,EAAC,EAAA,IAADA,CAAC,SAADE,EAAAF,kBAAe,YAAY,QAAA,iBACjB3B,CAAU,CAAA,QADpB2B,CAAC,uBADW3B,CAAU,IAAA8B,EAAAC,CAAA,gCAOtBC,EAAGC,GAAA,EACFC,IADDF,CAAG,EAEFG,IADAD,EAAG,CAAA,EAEFE,IADDD,CAAG,MACFC,EAAE,EAAA,IAAFA,CAAE,UAAFA,EAAE,CAAA,iBAEDC,EAACC,GAAA,MAADD,CAAC,IAADA,CAAC,EAAME,EAAA,IAAAC,EAAAC,EAAA,OAAAvC,EAAAJ,CAAe,EAAC,cAAY,EAAA,EAAA,CAAA,MAAnCuC,CAAC,WADEnC,EAAAJ,CAAe,EAAC,cAAYgC,EAAAY,CAAA,gCAI/BC,EAACC,GAAA,MAADD,CAAC,IAADA,CAAC,EAAYJ,EAAA,IAAAC,EAAAK,EAAA,aAAA3C,EAAAJ,CAAe,EAAC,UAAQ,EAAA,EAAA,CAAA,MAArC6C,CAAC,WADEzC,EAAAJ,CAAe,EAAC,UAAQgC,EAAAgB,CAAA,QAG5BC,EAACvB,EAAAwB,EAAA,CAAA,MAADD,CAAC,IAADA,CAAC,IARFZ,CAAG,IAFJH,CAAG,WACFE,EAAG,MAAAhC,EAAMJ,CAAe,EAAC,YAAY,IAArCoC,EAAG,MAAAhC,EAAyCJ,CAAe,EAAC,KAAK,EAE5D0C,EAAAS,EAAA/C,EAAAJ,CAAe,EAAC,KAAK,IAOzBiD,EAAC,OAAA7C,EAAOJ,CAAe,EAAC,GAAG,EAAyE0C,EAAAU,EAAA,YAAAhD,EAAAJ,CAAe,EAAC,UAAQ,EAAA,EAAA,QAV9HkC,CAAG,aADAlC,CAAe,GAAA,CAAAI,EAAKH,CAAS,GAAA,CAAAG,EAAKF,CAAU,GAAA8B,EAAAqB,CAAA,MAtBjD/B,CAAG,SAAHgC,EAAAC,EAAAjC,+DAAoDpB,CAAU,CAAA,CAAA,EAC7D6B,EAAAP,gBAAiB,YAAY,EAC7BO,EAAAN,EAAA,KAAA5B,EAAA,MAEU,YAAY,EAFtBkC,EAAAN,EAAA,OAAA5B,EAAA,MAGY,YAAY,EAHxB4B,EAAA,SAAA5B,EAAA,MAIgB,WAJhB4B,EAAA,cAAA,OAAA5B,EAAA,MAK0B,aAAgB,iBAAiB,YAAc,mDAAmD,EAL5H2D,EAAAD,EAAA9B,EAAA,EAAA,sBAAA,KAAA+B,EAAA,CAAA,QAAApD,EASeH,CAAS,CAAA,CAAA,EATxB8B,EAAAN,EAAA,eAAA,CAAA,CAAA5B,EAAA,OAAA,CAAA,CAAAO,EAU2BF,CAAU,CAAA,EAVrC6B,EAAAN,EAAA,mBAAA5B,EAAA,OAAAO,EAW2BF,CAAU,EAAA,GAAAL,EAAA,MAAY,YAAY,SAAW,MAAS,MAXjF4B,EAAA,IAAArB,EAMYN,CAAQ,OAARA,EAAQ2D,CAAA,CAAA,MARrBnC,CAAG,KAFI"}