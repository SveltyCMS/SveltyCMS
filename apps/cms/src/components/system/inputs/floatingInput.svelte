<!-- 
 @file src/components/system/inputs/floatingInput.svelte
 @component 
 **FloatingInput component for handling text and password inputs with floating labels**
 #### Props
 - `value` {string}: The input value (bindable)
 - `showPassword` {boolean}: Initial visibility of password (bindable, default: false)
 - `disabled` {boolean}: Whether the input is disabled (default: false)
 - `icon` {string}: Icon next to the input (default: '')
 - `iconColor` {string}: Icon color (default: 'gray-500')
 - `inputClass` {string}: Additional input classes (default: '')
 - `label` {string}: Input label (default: '')
 - `labelClass` {string}: Additional label classes (default: '')
 - `minlength` {number}: Minimum input length (optional)
 - `maxlength` {number}: Maximum input length (optional)
 - `name` {string}: Input name (default: '')
 - `required` {boolean}: Whether input is required (default: false)
 - `showPasswordBackgroundColor` {'light' | 'dark'}: Password toggle color (default: 'light')
 - `textColor` {string}: Text color class (default: '!text-error-500')
 - `type` {'text' | 'email' | 'password'}: Input type (default: 'text')
 - `tabindex` {number}: Input tabindex (default: 0)
 - `id` {string}: Input ID (default: derived from label or 'defaultInputId')
 - `autocomplete` {string}: Autocomplete attribute (default: null)
 - `onClick` {function}: Click event handler (optional)
 - `onInput` {function}: Input event handler (optional)
 - `onkeydown` {function}: Keydown event handler (optional)
-->

<script lang="ts">
	// Define the specific, allowed values for the HTML autocomplete attribute.
	// This is a selection of common values. For a full list, see the MDN Web Docs.
	type FullAutoFill =
		| 'on'
		| 'off'
		| 'name'
		| 'honorific-prefix'
		| 'given-name'
		| 'additional-name'
		| 'family-name'
		| 'honorific-suffix'
		| 'nickname'
		| 'email'
		| 'username'
		| 'new-password'
		| 'current-password'
		| 'one-time-code'
		| 'organization-title'
		| 'organization'
		| 'street-address'
		| 'address-line1'
		| 'address-line2'
		| 'address-line3'
		| 'address-level1'
		| 'address-level2'
		| 'address-level3'
		| 'country'
		| 'country-name'
		| 'postal-code'
		| 'cc-name'
		| 'cc-given-name'
		| 'cc-additional-name'
		| 'cc-family-name'
		| 'cc-number'
		| 'cc-exp'
		| 'cc-exp-month'
		| 'cc-exp-year'
		| 'cc-csc'
		| 'cc-type'
		| 'transaction-currency'
		| 'transaction-amount'
		| 'language'
		| 'bday'
		| 'bday-day'
		| 'bday-month'
		| 'bday-year'
		| 'sex'
		| 'tel'
		| 'url'
		| 'photo';

	type InputType = 'text' | 'email' | 'password';

	type AutoCapitalize = 'off' | 'none' | 'on' | 'sentences' | 'words' | 'characters';

	interface Props {
		value?: string;
		showPassword?: boolean;
		disabled?: boolean;
		icon?: string;
		iconColor?: string; // CSS color string, e.g., '#888' or 'gray'
		inputClass?: string;
		label?: string;
		labelClass?: string;
		minlength?: number;
		maxlength?: number;
		name?: string;
		required?: boolean;
		passwordIconColor?: string; // Renamed for clarity. CSS color string.
		textColor?: string; // CSS color string
		type?: InputType;
		tabindex?: number;
		id?: string;
		autocomplete?: FullAutoFill;
		autocapitalize?: AutoCapitalize;
		spellcheck?: boolean;
		autofocus?: boolean;
		invalid?: boolean; // New: For validation state
		errorMessage?: string; // New: For accessibility
		onClick?: (event: MouseEvent) => void;
		onInput?: (value: string) => void;
		onkeydown?: (event: KeyboardEvent) => void;
		onPaste?: (event: ClipboardEvent) => void;
	}

	let {
		value = $bindable(''),
		showPassword = $bindable(false),
		disabled = false,
		icon = '',
		iconColor = 'gray',
		inputClass = '',
		label = '',
		labelClass = '',
		minlength,
		maxlength,
		name = '',
		required = false,
		passwordIconColor = 'gray',
		textColor = 'black',
		type = 'text',
		tabindex = 0,
		id = '',
		autocomplete,
		autocapitalize = 'none',
		spellcheck = false,
		autofocus = false,
		invalid = false,
		errorMessage = '',
		onClick,
		onInput,
		onkeydown,
		onPaste
	}: Props = $props();

	let inputElement = $state<HTMLInputElement>();
	let currentId = $derived(id || (label ? label.toLowerCase().replace(/\s+/g, '-') : 'defaultInputId'));
	const errorId = $derived(errorMessage ? `error-${currentId}` : undefined);
	const effectiveType = $derived(showPassword && type === 'password' ? 'text' : type);

	$effect(() => {
		if (autofocus && inputElement) {
			inputElement.focus();
		}
	});

	function togglePasswordVisibility(event: Event): void {
		event.preventDefault();
		showPassword = !showPassword;
	}

	function handleIconKeyDown(event: KeyboardEvent): void {
		if (event.key === 'Enter' || event.key === ' ') {
			event.preventDefault();
			togglePasswordVisibility(event);
		}
	}
</script>

<div class="relative w-full">
	<div class="group relative flex w-full items-center" role="group" aria-labelledby={currentId}>
		<input
			bind:this={inputElement}
			bind:value
			{name}
			{minlength}
			{maxlength}
			{disabled}
			{tabindex}
			autocomplete={autocomplete ?? undefined}
			{autocapitalize}
			{spellcheck}
			aria-required={required}
			aria-invalid={invalid}
			aria-describedby={errorId}
			onclick={onClick}
			oninput={(e) => onInput?.(e.currentTarget.value)}
			onpaste={onPaste}
			{onkeydown}
			type={effectiveType}
			style="color: {textColor};"
			class="peer block w-full appearance-none border-0 border-b-2 border-surface-300 bg-transparent px-6 text-base focus:border-tertiary-600 focus:outline-none focus:ring-0 disabled:opacity-50 dark:border-surface-400 dark:focus:border-tertiary-500 {inputClass}"
			class:!border-error-500={invalid}
			class:dark:!border-error-500={invalid}
			class:pr-10={type === 'password'}
			placeholder=" "
			id={currentId}
		/>

		{#if icon}
			<iconify-icon {icon} width="1.125em" class="absolute left-0 top-3" style="color: {iconColor};" aria-hidden="true"></iconify-icon>
		{/if}

		{#if type === 'password'}
			<iconify-icon
				tabindex="0"
				role="button"
				icon={showPassword ? 'bi:eye-fill' : 'bi:eye-slash-fill'}
				aria-label={showPassword ? 'Hide password' : 'Show password'}
				aria-pressed={showPassword}
				class="absolute right-2 top-3 cursor-pointer hover:opacity-75 focus:outline-none"
				width="24"
				style="color: {passwordIconColor};"
				onkeydown={handleIconKeyDown}
				onclick={togglePasswordVisibility}
			></iconify-icon>
		{/if}

		{#if label}
			<label
				for={currentId}
				class="pointer-events-none absolute left-6 top-3 origin-[0] -translate-y-4 transform text-base text-surface-400 transition-all duration-200 ease-in-out peer-placeholder-shown:translate-y-0 peer-placeholder-shown:text-base peer-focus:-translate-y-4 peer-focus:text-xs peer-focus:text-tertiary-500 peer-disabled:text-surface-500 {invalid &&
				value
					? '!text-error-500'
					: ''} {value ? '-translate-y-4 text-xs' : ''} {labelClass}"
			>
				{label}
				{#if required}
					<span class="text-error-500" aria-hidden="true">*</span>
				{/if}
			</label>
		{/if}
	</div>

	{#if invalid && errorMessage}
		<p id={errorId} class="mt-1 text-xs text-error-500" role="alert">
			{errorMessage}
		</p>
	{/if}
</div>
