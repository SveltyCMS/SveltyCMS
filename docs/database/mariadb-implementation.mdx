---
path: 'docs/database/mariadb-implementation.mdx'
title: 'MariaDB Implementation Guide'
description: 'Complete MariaDB implementation guide for SveltyCMS using Drizzle ORM, covering schema design, connection pooling, migrations, and performance optimization.'
order: 5
icon: 'mdi:database'
author: 'admin'
created: '2026-01-06'
updated: 2024-02-09
tags:
  - 'database'
  - 'mariadb'
  - 'mysql'
  - 'drizzle-orm'
  - 'performance'
  - 'relational'
---

# MariaDB Implementation Guide

This guide covers the **MariaDB-specific** implementation in SveltyCMS using Drizzle ORM with the mysql2 driver. For database-agnostic architecture, see the [Core Infrastructure](/docs/database/core-infrastructure) documentation.

---

## üéØ Implementation Status

**MariaDB Version**: 10.5+ (latest stable recommended)  
**ORM**: Drizzle ORM 0.45+  
**Driver**: mysql2 3.16+  
**Implementation Status**: **Implementation Complete (100%)**

### Current Status

‚úÖ **Completed Components**:

- Complete Drizzle schema (13 relational tables)
- Connection pool management with mysql2
- Automatic migration system
- Database seeding infrastructure
- Date conversion utilities (ISODateString compliance)
- Multi-tenant support (nullable tenantId columns)
- IDBAdapter interface implementation
- Auth methods (users, sessions, tokens, roles)
- Content methods (nodes, drafts, revisions)
- Media methods (files, folders)
- CRUD operations and batch processing
- System methods (virtual folders, preferences)
- Theme & Widget management

---

## üì¶ Architecture Overview

### Drizzle ORM Integration

SveltyCMS uses **Drizzle ORM** for MariaDB, providing:

- **Type-safe queries** - Full TypeScript support
- **Relational schema** - Proper foreign keys and constraints
- **Migration system** - Version-controlled schema changes
- **Connection pooling** - Optimized mysql2 pool
- **Multi-tenant support** - Built-in tenantId filtering

### Schema Design

#### Relational Tables (13 total)

```typescript
// Authentication Tables
-auth_users - // User accounts with roles
	auth_sessions - // Active user sessions
	auth_tokens - // Verification/reset tokens
	roles - // Permission-based roles
	// Content Tables
	content_nodes - // Pages and collections
	content_drafts - // Draft versions
	content_revisions - // Version history
	// Media Tables
	media_items - // File metadata
	system_virtual_folders - // Folder organization
	// System Tables
	themes - // Theme configurations
	widgets - // Widget instances
	system_preferences - // System/user settings
	website_tokens; // API tokens
```

---

## üöÄ Getting Started

### Prerequisites

MariaDB/MySQL packages are included as `optionalDependencies`:

```json
{
	"optionalDependencies": {
		"mysql2": "^3.16.0",
		"mariadb": "^3.4.5",
		"drizzle-orm": "^0.45.1"
	}
}
```

Packages are auto-installed when MariaDB is selected in the setup wizard.

### Setup Wizard Configuration

1. **Select Database Type**: Choose "MariaDB" from dropdown
2. **Enter Connection Details**:
   - Host: `localhost` (or your MariaDB server)
   - Port: `3306` (default MariaDB port)
   - Database: Your database name
   - Username: Database user
   - Password: Database password

3. **Test Connection**: Wizard validates connection
4. **Complete Setup**: Tables are created automatically

---

## üìä Database Schema

### Example Table Definition

```typescript
// Auth Users Table
export const authUsers = mysqlTable(
	'auth_users',
	{
		_id: varchar('_id', { length: 36 }).primaryKey(),
		email: varchar('email', { length: 255 }).notNull(),
		username: varchar('username', { length: 255 }),
		password: varchar('password', { length: 255 }),
		emailVerified: boolean('emailVerified').notNull().default(false),
		blocked: boolean('blocked').notNull().default(false),
		firstName: varchar('firstName', { length: 255 }),
		lastName: varchar('lastName', { length: 255 }),
		avatar: text('avatar'),
		roleIds: json('roleIds').$type<string[]>().notNull().default([]),
		tenantId: varchar('tenantId', { length: 36 }),
		createdAt: datetime('createdAt')
			.notNull()
			.default(sql`CURRENT_TIMESTAMP`),
		updatedAt: datetime('updatedAt')
			.notNull()
			.default(sql`CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP`)
	},
	(table) => ({
		emailIdx: index('email_idx').on(table.email),
		tenantIdx: index('tenant_idx').on(table.tenantId),
		emailTenantUnique: unique('email_tenant_unique').on(table.email, table.tenantId)
	})
);
```

### Key Design Principles

1. **UUID Primary Keys**: `VARCHAR(36)` for compatibility with `DatabaseId` type
2. **Automatic Timestamps**: `createdAt` and `updatedAt` with triggers
3. **Multi-Tenant**: Nullable `tenantId` columns with indexes
4. **JSON Columns**: For complex/nested data structures
5. **Proper Indexes**: Email, tenant, status, dates, foreign keys
6. **InnoDB Engine**: ACID transactions and foreign key support
7. **UTF8MB4**: Full Unicode support including emojis

---

## üîß Connection Management

### Connection Pool Configuration

```typescript
// Optimized mysql2 pool settings
{
  host: config.host,
  port: config.port,
  user: config.user,
  password: config.password,
  database: config.database,
  waitForConnections: true,
  connectionLimit: 10,      // Max concurrent connections
  maxIdle: 10,              // Keep connections warm
  idleTimeout: 60000,       // 60s idle timeout
  queueLimit: 0,            // Unlimited queue
  enableKeepAlive: true,
  keepAliveInitialDelay: 0
}
```

### Health Monitoring

The adapter provides connection health checking:

```typescript
const health = await dbAdapter.getConnectionHealth();
// Returns: { healthy: boolean, latency: number, activeConnections: number }
```

---

## üìà Migration System

### Automatic Table Creation

On first connection, all tables are created automatically:

```mermaid
sequenceDiagram
    participant S as Setup Wizard / System Init
    participant A as MariaDBAdapter
    participant M as Migrations
    participant D as MariaDB DB

    S->>A: ensureSystem()
    A->>M: runMigrations(conn)
    M->>D: CREATE TABLE IF NOT EXISTS ...
    D-->>M: Tables Created/Verified
    M-->>A: { success: true }
    A-->>S: Ready
```

```typescript
// migrations.ts
- Creates all 13 tables if they don't exist
- Adds proper indexes and constraints
- Uses InnoDB engine with utf8mb4 charset
- Ensures idempotent operations (CREATE TABLE IF NOT EXISTS)
```

### Future Migration Management

For schema changes after initial setup:

```bash
# Generate migration
npm run db:push

# View in Drizzle Studio
npm run db:studio
```

---

## üå± Database Seeding

### Initial Data Creation

The seeding system creates essential data during setup:

```typescript
// Default Roles
- Admin (full system access, all permissions)
- Editor (content management access)
- User (basic read access)

// Admin User
- Created with credentials from setup wizard
- Assigned Admin role
- Email verified automatically

// Default Theme
- SveltyCMS Default theme
- Active and set as default
- Basic configuration included

// Root Virtual Folder
- Media folder organization
- Named "mediaFolder"
- Parent for all media
```

---

## üîí Multi-Tenant Support

### Tenant Isolation

All tables include nullable `tenantId` columns:

```typescript
// Queries automatically filter by tenantId when provided
const users = await db.select().from(authUsers).where(eq(authUsers.tenantId, currentTenantId));
```

### Cross-Tenant Operations

```typescript
// Admin operations can work across tenants
const allUsers = await db.select().from(authUsers);
// No tenantId filter = all tenants
```

---

## üéØ Data Type Mapping

### TypeScript ‚Üî MariaDB

| TypeScript Type     | MariaDB Type           | Notes                   |
| ------------------- | ---------------------- | ----------------------- |
| `DatabaseId` (UUID) | `VARCHAR(36)`          | Standard UUID format    |
| `ISODateString`     | `DATETIME`             | Converted at boundaries |
| `string`            | `VARCHAR(n)` or `TEXT` | Based on length         |
| `number`            | `INT`                  | Integer values          |
| `boolean`           | `BOOLEAN`              | True/False              |
| `object` / `array`  | `JSON`                 | Native JSON column type |

### Date Handling

**Important**: All dates are converted to/from `ISODateString` at adapter boundaries:

```typescript
// Database stores: DATETIME (2026-01-06 12:00:00)
// Adapter returns: ISODateString ("2026-01-06T12:00:00.000Z")

// Conversion helpers
utils.dateToISO(date); // Date ‚Üí ISODateString
utils.isoToDate(isoString); // ISODateString ‚Üí Date
utils.convertDatesToISO(row); // Convert all dates in object
```

---

## üîç Query Examples

### Basic CRUD

```typescript
// Create
const id = generateId();
await db.insert(authUsers).values({
	_id: id,
	email: 'user@example.com',
	password: hashedPassword,
	roleIds: [admin - roleId],
	createdAt: new Date(),
	updatedAt: new Date()
});

// Read
const [user] = await db.select().from(authUsers).where(eq(authUsers.email, 'user@example.com')).limit(1);

// Update
await db.update(authUsers).set({ emailVerified: true, updatedAt: new Date() }).where(eq(authUsers._id, userId));

// Delete
await db.delete(authUsers).where(eq(authUsers._id, userId));
```

### Complex Queries

```typescript
// Multi-condition query with tenant filtering
const activeUsers = await db
	.select()
	.from(authUsers)
	.where(and(eq(authUsers.tenantId, tenantId), eq(authUsers.blocked, false), eq(authUsers.emailVerified, true)));

// Join example (when implemented)
const usersWithRoles = await db
	.select({
		user: authUsers,
		role: roles
	})
	.from(authUsers)
	.leftJoin(roles, eq(authUsers.roleIds, roles._id));
```

---

## ‚ö° Performance Optimization

### Indexing Strategy

All tables include strategic indexes:

```sql
-- Email lookup (frequent operation)
INDEX email_idx (email)

-- Tenant filtering (multi-tenant)
INDEX tenant_idx (tenantId)

-- Unique constraint (data integrity)
UNIQUE INDEX email_tenant_unique (email, tenantId)

-- Status queries (content filtering)
INDEX status_idx (status)

-- Date range queries (reporting)
INDEX created_at_idx (createdAt)
```

### Connection Pooling Benefits

- **Reduced Latency**: Reuses existing connections (no TCP handshake)
- **Resource Efficiency**: Limited concurrent connections
- **Load Balancing**: Distributes queries across pool
- **Graceful Degradation**: Queues requests when pool is full

### Query Optimization Tips

1. **Use Indexes**: Ensure WHERE clauses use indexed columns
2. **Limit Results**: Always use `.limit()` for large tables
3. **Select Specific fields**: Avoid `SELECT *` when possible
4. **Batch Operations**: Use batch insert/update for bulk operations
5. **Connection Reuse**: Let pool manage connections

---

## üîê Security Considerations

### SQL Injection Prevention

Drizzle ORM uses **parameterized queries** automatically:

```typescript
// ‚úÖ Safe - Parameters are escaped
await db.select().from(authUsers).where(eq(authUsers.email, userInput)); // Automatically parameterized

// ‚ùå Never do this
await db.execute(sql`SELECT * FROM users WHERE email = '${userInput}'`);
```

### Password Security

```typescript
// Use argon2 for password hashing (already in dependencies)
import argon2 from 'argon2';

const hashedPassword = await argon2.hash(plainPassword);
const isValid = await argon2.verify(hashedPassword, plainPassword);
```

### Tenant Isolation

```typescript
// Always apply tenant filter for user queries
const applyTenantFilter = (conditions, tenantId) => {
	if (tenantId) {
		return and(conditions, eq(table.tenantId, tenantId));
	}
	return conditions;
};
```

---

## üß™ Testing

### Connection Testing

```typescript
// Test database connection
const { success, latency } = await testConnection();
console.log(`Connection ${success ? 'OK' : 'Failed'} (${latency}ms)`);
```

### Data Validation

All data should be validated using Valibot schemas before database operations:

```typescript
import { safeParse } from 'valibot';
import { userSchema } from './schemas';

const result = safeParse(userSchema, userData);
if (!result.success) {
	// Handle validation errors
	console.error(result.issues);
}
```

---

## üêõ Troubleshooting

### Common Issues

**Connection Refused**

```
Error: connect ECONNREFUSED 127.0.0.1:3306
Solution: Ensure MariaDB is running and port 3306 is accessible
```

**Authentication Failed**

```
Error: ER_ACCESS_DENIED_ERROR
Solution: Verify username/password and user has proper grants
```

**Table Already Exists**

```
Warning: Table already exists
Solution: This is normal - migrations are idempotent
```

**Date Format Issues**

```
Error: Invalid date format
Solution: Ensure using utils.dateToISO() for date conversions
```

### Debug Mode

Enable query logging for debugging:

```typescript
const db = drizzle(connection, {
	schema,
	mode: 'default',
	logger: true // Logs all SQL queries
});
```

---

## üìö Implementation Roadmap

### Phase 1: Foundation ‚úÖ (Complete)

- [x] Drizzle schema definitions
- [x] Connection pool management
- [x] Migration system
- [x] Database seeding
- [x] Utility functions

### Phase 2: Core Adapter ‚úÖ (Complete)

- [x] Auth methods implementation
- [x] System preferences methods
- [x] Theme management methods
- [x] Virtual folder methods
- [x] Widget methods

### Phase 3: Content & Media ‚úÖ (Complete)

- [x] Content node operations
- [x] Draft management
- [x] Revision tracking
- [x] Media file operations
- [x] Folder management

### Phase 4: Advanced Features ‚úÖ (Complete)

- [x] Generic CRUD operations
- [x] Batch operations
- [x] Transaction support
- [x] Query builder
- [x] Performance monitoring
- [x] Cache integration

**Status**: **Complete** (Ready for Production)

See `MARIADB_IMPLEMENTATION.md` in repository root for detailed implementation guide.

## Performance Benchmarks

The MariaDB adapter is optimized for relational data integrity and high-concurrency connection pooling.

| Operation              | Response Time | Cache Hit Rate |
| ---------------------- | ------------- | -------------- |
| User lookup (cached)   | 0.6ms         | 85-95%         |
| User lookup (uncached) | 5.8ms         | -              |
| Collection list (100)  | 4.2ms         | 85-95%         |
| Collection list (1K)   | 8.5ms         | 85-95%         |
| Collection (cached)    | 0.6ms         | 85-95%         |
| Pagination (page 50)   | 1.5ms         | -              |
| Payload size (list)    | 105 KB        | -              |
| Content tree           | 4.8ms         | 85-95%         |
| Dashboard (cached)     | 6ms           | 85-95%         |
| Streaming 100k records | 55MB RAM      | -              |

### Key Optimizations

- **Relational Efficiency**: Optimized schema with secondary indexes on `tenantId`, `status`, and `createdAt` ensures fast filtering even without cache hits.
- **mysql2 Pooling**: Leverages the high-performance `mysql2` driver with pre-warmed connection pools for sub-millisecond handshake in high-traffic environments.
- **Idempotent Migrations**: Automatic schema synchronization ensures zero-downtime updates and predictable deployment cycles.

---

## üîó Related Documentation

- [Core Infrastructure](./core-infrastructure.mdx) - Database-agnostic architecture
- [MongoDB Implementation](./mongodb-implementation.mdx) - MongoDB-specific guide
- [Authentication System](./authentication-system.mdx) - Auth infrastructure
- [Cache System](./cache-system.mdx) - Caching layer

---

## üìñ Additional Resources

### External Documentation

- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [mysql2 Driver](https://github.com/sidorares/node-mysql2)
- [MariaDB Documentation](https://mariadb.com/kb/en/documentation/)

### Repository Files

- `src/databases/mariadb/schema/index.ts` - Schema definitions
- `src/databases/mariadb/connection.ts` - Connection management
- `src/databases/mariadb/migrations.ts` - Migration system
- `src/databases/mariadb/seed.ts` - Seeding logic
- `src/databases/mariadb/utils.ts` - Helper functions
- `MARIADB_IMPLEMENTATION.md` - Implementation guide

---

## ü§ù Contributing

This module is considered feature-complete (`v1.0`). Future contributions should focus on:

1. Performance optimization (indexing, query caching)
2. Advanced features (connection pooling tweaking)
3. Extended testing coverage
