---
path: 'docs/guides/development/media-gallery.mdx'
title: 'Media Gallery Architecture'
description: 'Complete technical reference for the SveltyCMS Media Gallery including API, utilities, widgets, and performance features'
order: 7
icon: 'mdi:file-tree'
author: 'admin'
created: '2025-11-07'
updated: '2026-01-01'
tags:
  - 'media'
  - 'architecture'
  - 'development'
  - 'api'
  - 'transform'
  - 'focal-point'
---

# Media Gallery Architecture

This document provides a complete technical reference for the SveltyCMS Media Gallery ecosystem, including storage abstraction, API endpoints, utilities, and performance optimizations.

## ğŸ—ï¸ Architecture Overview

```mermaid
graph TB
    subgraph "Client Layer"
        UI[Media Gallery UI]
        UW[MediaUpload Widget]
        GRID[MediaGrid.svelte]
        TABLE[MediaTable.svelte]
        VGRID[VirtualMediaGrid.svelte]
    end

    subgraph "API Layer"
        API1[GET /api/media]
        API2[POST /api/media/process]
        API3[DELETE /api/media/delete]
        API4[POST /api/media/remote]
        API6[POST /api/media/manipulate]
    end

    subgraph "Utility Layer"
        U1[mediaProcessing.ts]
        U2[mediaStorage.ts]
        U3[advancedSearch.ts]
        U4[bulkDownload.ts]
    end

    UI --> GRID
    UI --> TABLE
    UI --> VGRID
    GRID --> API1
    TABLE --> API1

    style UI fill:#4f46e5,color:#fff
```

---

## ğŸ—‚ï¸ File Structure

```
src/
â”œâ”€â”€ routes/(app)/mediagallery/
â”‚   â”œâ”€â”€ +page.svelte              # Main gallery page
â”‚   â”œâ”€â”€ +page.server.ts           # Server-side data loading
â”‚   â”œâ”€â”€ MediaGrid.svelte          # Grid view
â”‚   â”œâ”€â”€ MediaTable.svelte         # Table view
â”‚   â”œâ”€â”€ VirtualMediaGrid.svelte   # Virtual scrolling (10k+ files)
â”‚   â”œâ”€â”€ Filter.svelte             # Search & filter
â”‚   â”œâ”€â”€ AdvancedSearchModal.svelte
â”‚   â””â”€â”€ uploadMedia/
â”‚       â”œâ”€â”€ LocalUpload.svelte
â”‚       â”œâ”€â”€ RemoteUpload.svelte
â”‚       â””â”€â”€ ModalUploadMedia.svelte
â”‚
â”œâ”€â”€ utils/media/
â”‚   â”œâ”€â”€ mediaModels.ts            # Type definitions
â”‚   â”œâ”€â”€ mediaProcessing.server.ts # Hash, EXIF extraction
â”‚   â”œâ”€â”€ mediaStorage.server.ts    # Save, resize, cloud
â”‚   â”œâ”€â”€ advancedSearch.ts         # Multi-criteria search
â”‚   â”œâ”€â”€ bulkDownload.ts           # TAR.GZ archive
â”‚   â”œâ”€â”€ sharing.ts                # Expiring share links
â”‚   â””â”€â”€ storageAnalytics.ts       # Usage insights
â”‚
â””â”€â”€ widgets/core/MediaUpload/
    â”œâ”€â”€ index.ts                  # Widget definition
    â”œâ”€â”€ MediaUpload.svelte        # Single file upload
    â”œâ”€â”€ Input.svelte              # Media selector
    â””â”€â”€ Display.svelte            # Display selected
```

---

## ğŸ”§ Core Utilities

### Storage Abstraction (`mediaStorage.server.ts`)

Switch between Local, S3, R2, and Cloudinary with zero code changes:

```typescript
import { saveFile, deleteFile } from '@utils/media/mediaStorage.server';

// Saves to configured provider (S3/Local/etc)
const url = await saveFile(buffer, 'avatars/user-123.jpg');

// Deletes from configured provider
await deleteFile(url);
```

**Configuration**:

- `MEDIA_STORAGE_TYPE`: `'local'` | `'s3'` | `'r2'` | `'cloudinary'`
- `MEDIA_BUCKET_NAME`: S3/R2 bucket name
- `MEDIA_FOLDER`: Root folder prefix

### Image Processing

All uploads are processed with Sharp:

- **Auto-Resizing**: Generates thumbnails (`sm`, `md`, `lg`)
- **Format Conversion**: Auto-convert to `avif`, `webp`
- **Metadata Extraction**: Width, height, EXIF data, dominant colors

### Advanced Search (`advancedSearch.ts`)

```typescript
import { advancedSearch } from '@utils/media/advancedSearch';

const results = advancedSearch(allFiles, {
	tags: ['nature', 'vacation'],
	minWidth: 1920,
	aspectRatio: 'landscape',
	camera: 'Canon',
	uploadedAfter: new Date('2024-01-01')
});
```

---

## âš¡ Performance Features

### Virtual Scrolling

`VirtualMediaGrid.svelte` handles 10,000+ files by rendering only visible items:

| Files Count | DOM Nodes | Reduction |
| ----------- | --------- | --------- |
| 1,000       | ~120      | 88%       |
| 10,000      | ~140      | 99%       |

Automatically enabled when `filteredFiles.length > 100`.

### Hash-Based Duplicate Prevention

Duplicates are blocked at upload time, not cleaned up after:

```typescript
const hash = await hashFileContent(buffer);
const existing = await db.crud.findOne('MediaItem', { hash });
if (existing) throw new Error('File already exists');
```

### Bulk Download

TAR.GZ archive creation with pure Node.js:

```typescript
POST /api/media/bulk-download
{ "fileIds": ["file_1", "file_2"] }
// Returns: application/gzip stream
```

---

## ğŸ“¡ API Endpoints

| Endpoint                     | Method | Description            |
| ---------------------------- | ------ | ---------------------- |
| `/api/media`                 | GET    | List media files       |
| `/api/media/process`         | POST   | Upload & process files |
| `/api/media/delete`          | DELETE | Delete files           |
| `/api/media/remote`          | POST   | Upload from URL        |
| `/api/media/search`          | POST   | Advanced search        |
| `/api/media/bulk-download`   | POST   | Download as TAR.GZ     |
| `/api/media/trash`           | POST   | Soft delete            |
| `/api/media/manipulate/[id]` | POST   | Image manipulation     |

---

## ğŸ§© MediaUpload Widget

### Single Upload (`MediaUpload.svelte`)

For collection fields like featured image:

```svelte
<MediaUpload {field} bind:value />
```

Features: Drag-and-drop, preview, image editor integration, validation.

### Multi-Select (`Input.svelte`)

For gallery fields:

```svelte
<Input {field} bind:value />
```

Features: Media library modal, multi-select, drag-to-reorder, stores media IDs.

---

## ğŸ”„ On-the-Fly Transform API

Transform images on request with Sharp.js:

```http
GET /api/media/transform/path/to/image.jpg?w=800&h=600&focal=60,30&format=webp
```

**Supported Parameters:**

| Parameter | Description         | Example       |
| --------- | ------------------- | ------------- |
| `w`       | Target width        | `w=800`       |
| `h`       | Target height       | `h=600`       |
| `fit`     | Resize mode         | `fit=cover`   |
| `focal`   | Focal point (x,y %) | `focal=60,30` |
| `format`  | Output format       | `format=webp` |
| `q`       | Quality (1-100)     | `q=85`        |

---

## ğŸ“Š Competitive Analysis

SveltyCMS media handling compared to industry leaders:

| Feature                 | SveltyCMS | Sanity | Contentful | WordPress | PayloadCMS |
| ----------------------- | --------- | ------ | ---------- | --------- | ---------- |
| Transform API           | âœ…        | âœ…     | âœ…         | âŒ Plugin | âœ…         |
| Focal point in URL      | âœ…        | âœ…     | âŒ         | âŒ        | âŒ         |
| Full canvas editor      | âœ… Konva  | âŒ     | âŒ Basic   | âŒ Basic  | âŒ         |
| Blur/Annotate/Watermark | âœ…        | âŒ     | âŒ         | âŒ        | âŒ         |
| Bulk download (TAR.GZ)  | âœ…        | âŒ     | âŒ         | âŒ        | âŒ         |
| Secure sharing links    | âœ…        | âŒ     | âŒ         | âŒ Plugin | âŒ         |
| Advanced search (EXIF)  | âœ…        | âš ï¸     | âš ï¸         | âŒ        | âš ï¸         |
| Self-hosted option      | âœ…        | âŒ     | âŒ         | âœ…        | âœ…         |

**Unique to SveltyCMS:** Full canvas editor, bulk download, secure sharing, 18+ search criteria

---

## ğŸ“š Related Documentation

- [Media Gallery Guide](/docs/guides/content/media-gallery-guide) - User guide with UX features
- [Image Editor Architecture](/docs/architecture/image-editor) - Image editing integration
- [Media API Reference](/docs/api/Media_API) - Complete 14-endpoint API documentation
