---
path: 'docs/guides/development/media-handling.mdx'
title: Media Handling
description: Comprehensive guide to the SveltyCMS media system, including upload processing, cloud storage abstraction, image optimization, secure sharing, and analytics.
author: 'admin'
created: '2025-12-29'
updated: '2025-12-29'
tags:
  - 'media'
  - 'guide'
  - 'development'
---

# Media Handling System

SveltyCMS provides an enterprise-grade media management system designed for scalability, performance, and flexibility. It features a storage-agnostic architecture, on-the-fly image optimization, secure file sharing, and deep storage analytics.

## üèóÔ∏è Core Architecture

The system is built on a modular "Storage Abstraction Layer" that decouples your application logic from the underlying storage provider.

### Components (`src/utils/media/`)

| File                            | Responsibility                                                                                                                                          |
| :------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **`mediaModels.ts`**            | **Single Source of Truth** for types (`MediaBase`, `MediaImage`, `StorageType`). Defines strict interfaces for metadata, versions, and access control.  |
| **`mediaStorage.server.ts`**    | **The Engine**. Handles file saving/deletion. Automatically routes to Local FS, S3, R2, or Cloudinary based on config. Integrates `sharp` for resizing. |
| **`cloudStorage.ts`**           | **The Driver**. Low-level implementation of S3/R2/Cloudinary protocols. Handles multipart uploads and signed URLs.                                      |
| **`mediaProcessing.server.ts`** | **The Processor**. Server-side logic for SHA-256 hashing (deduplication) and metadata extraction (EXIF, dimensions).                                    |
| **`advancedSearch.ts`**         | **The Brain**. Advanced client-side search engine. Filters by metadata, camera model, aspect ratio, dominant color, and more.                           |
| **`sharing.ts`**                | **The Gatekeeper**. Generates secure, expiring share links with password protection and download limits.                                                |
| **`storageAnalytics.ts`**       | **The Analyst**. Calculates breakdown by user/type/folder, identifies growth trends, and highlights storage hogs.                                       |

---

## üöÄ Key Features

### 1. Unified Storage Abstraction API

Switch between Local, S3, R2, and Cloudinary with **zero code changes** in your application.

```typescript
import { saveFile, deleteFile } from '@utils/media/mediaStorage.server';

// Saves to configured provider (S3/Local/etc)
const url = await saveFile(buffer, 'avatars/user-123.jpg');

// Deletes from configured provider
await deleteFile(url);
```

**Configuration (`config/public.ts` via Settings):**

- `MEDIA_STORAGE_TYPE`: `'local'` | `'s3'` | `'r2'` | `'cloudinary'`
- `MEDIA_BUCKET_NAME`: Name of your S3/R2 bucket.
- `MEDIA_FOLDER`: Root folder prefix (e.g., `cms-media`).

### 2. Intelligent Image Processing

All image uploads are automatically processed using `sharp`.

- **Auto-Resizing**: Generates thumbnails (`sm`, `md`, `lg`) based on `IMAGE_SIZES` config.
- **Format Conversion**: Can auto-convert uploads to modern web formats (`avif`, `webp`) via `MEDIA_OUTPUT_FORMAT_QUALITY`.
- **Metadata Extraction**: Automatically extracts Width, Height, EXIF data, and Dominant Colors.

### 3. Advanced Search & Filtering

The `advancedSearch` utility allows for granular file discovery:

```typescript
import { advancedSearch } from '@utils/media/advancedSearch';

const results = advancedSearch(allFiles, {
	tags: ['nature', 'vacation'],
	minWidth: 1920,
	aspectRatio: 'landscape',
	camera: 'Canon', // Fuzzy match EXIF make/model
	uploadedAfter: new Date('2024-01-01')
});
```

### 4. Secure File Sharing

Create temporary, secure links for external access without exposing your main storage bucket.

```typescript
import { createLink } from '@utils/media/sharing';

const link = createLink(fileId, userId, {
	hours: 48, // Expire in 2 days
	maxDownloads: 5, // Max 5 downloads
	passwordHash: '...', // Optional password protection
	requireEmail: true // Audit log who downloaded
});
```

### 5. Storage Analytics

Gain insights into your storage usage pattern:

```typescript
import { analyze, insights } from '@utils/media/storageAnalytics';

const stats = analyze(allFiles);
// -> Breakdown by type, user, folder, month

const smartInsights = insights(allFiles, stats);
// -> ["5 files > 50MB", "Old files > 1 year using 2GB"]
```

---

## üõ†Ô∏è Implementation Guide

### Upload Flow

1.  **Client**: Selects file ‚Üí Validates size/type (`mediaUtils.ts`).
2.  **Server**: Receives `FormData`.
3.  **Hash**: Server calculates SHA-256 hash (`mediaProcessing.server.ts`) to detect duplicates.
4.  **Process**: Server extracts metadata & resizes (`mediaStorage.server.ts`).
5.  **Storage**: Files uploaded to S3/Local/Cloudinary.
6.  **Database**: Entry created with `MediaImage` | `MediaDocument` type.

### Bulk Download

Users can download multiple files as a single archive (`.tar.gz`). This is handled via a stream to keep memory usage low.

```typescript
import { createBulkArchive, streamArchive } from '@utils/media/bulkDownload';

// Creates streaming archive
const { path } = await createBulkArchive(files, tempDir);
```

### Thumbnail Generation

You can request specific sizes of an image using the `mediaUrl` helper:

```typescript
import { mediaUrl } from '@utils/media/mediaUtils';

const thumbSrc = mediaUrl(imageItem, 'thumbnail'); // 200px
const largeSrc = mediaUrl(imageItem, 'lg'); // 1200px
```
