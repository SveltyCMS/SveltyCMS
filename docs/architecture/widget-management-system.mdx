# Widget Management System Architecture

## Overview

SveltyCMS uses a **Drupal-inspired hybrid approach** for widget management, combining filesystem-based widget discovery with database-driven state management.

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Filesystem    â”‚ â† Source of Truth (what widgets exist)
â”‚  /src/widgets/  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Widget Discovery Serviceâ”‚ â† Scans & compares on startup
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º New widgets found â†’ Auto-register in DB
         â”œâ”€â”€â–º Missing widgets â†’ Mark as unavailable
         â””â”€â”€â–º Existing widgets â†’ Load status from DB
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    Database      â”‚ â† State Management (active/inactive)
         â”‚  widgets table   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Widget Store    â”‚ â† In-memory cache for active widgets
         â”‚  (Svelte Store)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Components

### 1. Widget Discovery Service (`/src/services/widgetDiscovery.ts`)

**Responsibilities:**

- Scan filesystem for widgets on server startup
- Compare filesystem vs database state
- Identify new/missing/changed widgets
- Auto-register new widgets in database
- Provide discovery results to Widget Store

**When it runs:**

- Server startup
- Manual sync (admin action)
- Hot module reload (dev mode)

### 2. Database (Widget Model)

**Stores:**

- Widget metadata (name, description, icon)
- Activation status (per tenant)
- Configuration (widget-specific settings)
- Installation history (audit trail)

**Does NOT store:**

- Widget code/logic (filesystem only)
- Widget schemas (defined in code)

### 3. Widget Store (`/src/stores/widgetStore.svelte.ts`)

**Responsibilities:**

- Load discovery results on startup
- Cache active widgets in memory
- Provide reactive widget state to UI
- Handle widget activation/deactivation
- Validate dependencies

## Startup Flow

```
1. Server starts
   â†“
2. Widget Discovery Service scans filesystem
   â†“
3. Compare with database:
   - New widgets â†’ Auto-register as inactive (except core)
   - Missing widgets â†’ Mark as unavailable
   - Existing widgets â†’ Load status from DB
   â†“
4. Widget Store loads active widgets into memory
   â†“
5. Collections can use widgets
```

## Widget Lifecycle

### New Widget Added to Filesystem

```
1. Developer adds /src/widgets/custom/myWidget/
   â†“
2. On next server restart:
   - Discovery service finds new widget
   - Auto-registers in database as "inactive"
   - Logs: "ğŸ†• Discovered 1 new widget: MyWidget"
   â†“
3. Admin sees widget in UI as "Available"
   â†“
4. Admin clicks "Activate"
   â†“
5. Database updated, Widget Store refreshed
   â†“
6. Widget available for use in collections
```

### Widget Removed from Filesystem

```
1. Developer removes /src/widgets/custom/myWidget/
   â†“
2. On next server restart:
   - Discovery service notices missing widget
   - Database entry marked as "unavailable"
   - Logs: "âš ï¸  Widget missing from filesystem: MyWidget"
   â†“
3. Admin sees warning in UI
   â†“
4. Collections using widget show error state
   â†“
5. Admin must replace widget in collections
```

## Benefits of This Approach

âœ… **No Manual Sync** - Automatic discovery on startup
âœ… **Multi-Tenant** - Each tenant can activate different widgets
âœ… **Audit Trail** - Database tracks who/when activated widgets
âœ… **Hot Reload** - Dev mode automatically discovers new widgets
âœ… **Dependency Management** - Can't activate without dependencies
âœ… **Collection Safety** - Can't deactivate widgets in use
âœ… **Missing Widget Detection** - Warns when filesystem/DB out of sync

## API Endpoints

### GET `/api/widgets/status`

Returns widget discovery results (available, new, missing, active)

### POST `/api/widgets/status`

Activate/deactivate a widget (validates dependencies & usage)

### POST `/api/widgets/discover`

Manually trigger widget discovery (admin action)

## Configuration

### Widget Metadata (in widget's index.ts)

```typescript
export default createWidget({
	Name: 'MyWidget',
	Icon: 'mdi:puzzle',
	Description: 'My awesome widget',
	dependencies: ['Input', 'Date'] // Required widgets
	// ... other config
});
```

### Database Schema

```typescript
{
  name: string;          // 'MyWidget'
  isCore: boolean;       // true for core widgets
  isActive: boolean;     // activated by admin
  isAvailable: boolean;  // exists in filesystem
  dependencies: string[];
  tenantId?: string;     // for multi-tenant
  createdAt: Date;
  updatedAt: Date;
}
```

## Comparison with Other CMS

| Feature                  | SveltyCMS       | Drupal      | WordPress       |
| ------------------------ | --------------- | ----------- | --------------- |
| Widget discovery         | Auto on startup | Manual scan | Auto on startup |
| State storage            | Database        | Database    | Database        |
| Multi-tenant support     | âœ… Yes          | âœ… Yes      | âŒ No           |
| Dependency management    | âœ… Yes          | âœ… Yes      | âš ï¸ Partial      |
| Hot reload               | âœ… Yes (dev)    | âŒ No       | âŒ No           |
| Missing widget detection | âœ… Yes          | âœ… Yes      | âš ï¸ Partial      |

## Future Enhancements

- **Widget Marketplace**: Download/install widgets from registry
- **Version Management**: Track widget versions, allow updates
- **Rollback**: Revert to previous widget version
- **Testing**: Sandbox mode to test widgets before activation
- **Analytics**: Track widget usage across collections
