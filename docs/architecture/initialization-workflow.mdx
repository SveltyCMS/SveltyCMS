---
path: 'docs/architecture/initialization-workflow.mdx'
title: 'SveltyCMS Initialization Workflow'
description: 'Complete guide to the first-time setup and server restart workflows in SveltyCMS'
order: 10
icon: 'mdi:workflow'
author: 'admin'
created: '2025-10-14'
updated: '2025-10-14'
tags:
  - 'architecture'
  - 'initialization'
  - 'setup'
  - 'workflow'
  - 'collections'
---

# SveltyCMS Initialization Workflow

This document explains the complete initialization workflow for SveltyCMS, covering both **first-time setup** and **server restart** scenarios. The system is designed to be intelligent, avoiding unnecessary recompilation and maintaining UUID consistency for collections.

---

## Table of Contents

1. [Visual Overview](#visual-overview)
2. [First-Time Setup Flow](#first-time-setup-flow)
3. [Server Restart Flow](#server-restart-flow)
4. [Collection UUID Management](#collection-uuid-management)
5. [Key Components](#key-components)
6. [State Machine](#state-machine)
7. [Known Issues](#known-issues)

---

## Visual Overview

### Complete System Lifecycle

```mermaid
graph TB
    subgraph "First-Time Setup"
        A1[Fresh Install] -->|No private.ts| A2[Vite: Setup Mode]
        A2 --> A3[Create Blank Config]
        A3 --> A4[Open /setup Wizard]
        A4 --> A5[User: Enter DB Config]
        A5 --> A6[API: test-database]
        A6 -->|âœ“ Valid| A7[User: Select Language]
        A7 --> A8[API: seed]
        A8 --> A9[Write Credentials]
        A8 --> A10[Seed Settings/Themes]
        A8 --> A11[Create Collections]
        A11 --> A12[User: Admin Form]
        A12 --> A13[API: complete]
        A13 --> A14[Create Admin + Session]
        A13 --> A15[Init Global System]
        A13 --> A16[ContentManager Init]
        A16 --> A17[READY State]
    end

    subgraph "Server Restart"
        B1[Server Start] -->|private.ts exists| B2[Vite: Normal Mode]
        B2 --> B3[Scan Compiled Collections]
        B3 --> B4{For Each Collection}
        B4 --> B5{Hash Changed?}
        B5 -->|No| B6[Skip - Preserve UUID]
        B5 -->|Yes| B7[Recompile - Keep UUID]
        B6 --> B8[First Request]
        B7 --> B8
        B8 --> B9[handleSystemState]
        B9 --> B10[dbInitPromise]
        B10 --> B11[Connect Database]
        B11 --> B12[Load Settings]
        B12 --> B13[Init Services]
        B13 --> B14[READY State]
    end

    A17 -.->|Restart Server| B1

    style A1 fill:#f0f0f0,stroke:#333,stroke-width:3px
    style A4 fill:#e0e0e0,stroke:#333,stroke-width:2px
    style A8 fill:#e0e0e0,stroke:#333,stroke-width:2px
    style A13 fill:#e0e0e0,stroke:#333,stroke-width:2px
    style A17 fill:#d0d0d0,stroke:#333,stroke-width:4px
    style B1 fill:#f0f0f0,stroke:#333,stroke-width:3px
    style B7 fill:#e0e0e0,stroke:#333,stroke-width:2px
    style B14 fill:#d0d0d0,stroke:#333,stroke-width:4px
```

### First-Time Setup Architecture

```mermaid
graph TB
    A[Vite Startup] -->|No private.ts| B[setupWizardPlugin]
    B --> C[Create Blank private.ts]
    B --> D[Compile Collections]
    B --> E[Open /setup in Browser]

    E --> F[User: DB Config]
    F --> G[API: test-database]
    G -->|Success| H[User: System Language]

    H --> I[API: seed]
    I --> J[Write private.ts]
    I --> K[Seed Settings]
    I --> L[Seed Themes]
    I --> M[Seed Collections]

    M --> N[User: Admin Form]
    N --> O[API: complete]
    O --> P[Create Admin User]
    O --> Q[Initialize Global System]
    O --> R[Initialize ContentManager]
    O --> S[Set Session Cookie]

    S --> T[Redirect to CMS]

    style A fill:#f0f0f0,stroke:#333,stroke-width:3px
    style E fill:#e0e0e0,stroke:#333,stroke-width:2px
    style I fill:#e0e0e0,stroke:#333,stroke-width:2px
    style O fill:#e0e0e0,stroke:#333,stroke-width:2px
    style T fill:#d0d0d0,stroke:#333,stroke-width:4px
```

### Server Restart Architecture

```mermaid
graph TB
    A[Vite Startup] -->|private.ts exists| B[cmsWatcherPlugin]
    B --> C[Scan Compiled Collections]
    C --> D{For Each Collection}

    D --> E{Hash Changed?}
    E -->|No| F[Skip Compilation]
    E -->|Yes| G[Recompile]

    F --> H[Preserve UUID]
    G --> H

    H --> I[First HTTP Request]
    I --> J[handleSystemState]
    J --> K[dbInitPromise]
    K --> L[Load private.ts]
    K --> M[Connect to Database]
    K --> N[Load Settings]
    K --> O[Initialize Services]

    O --> P[READY State]
    P --> Q[ContentManager Auto-Init]
    Q --> R[Register Collections]

    style A fill:#f0f0f0,stroke:#333,stroke-width:3px
    style B fill:#e0e0e0,stroke:#333,stroke-width:2px
    style G fill:#e0e0e0,stroke:#333,stroke-width:2px
    style H fill:#d0d0d0,stroke:#333,stroke-width:3px
    style P fill:#d0d0d0,stroke:#333,stroke-width:4px
```

---

## First-Time Setup Flow

### Phase 1: Vite Startup (Build Time)

**File: `vite.config.ts`**

```mermaid
sequenceDiagram
    participant Vite
    participant FS as Filesystem
    participant Browser

    Note over Vite: Startup Check
    Vite->>FS: Check config/private.ts exists?
    FS-->>Vite: âŒ Not found

    Note over Vite: Setup Mode Activated
    Vite->>FS: Create blank private.ts
    Vite->>FS: Create placeholder collections
    Vite->>FS: Compile any existing collections

    Note over Vite: Open Setup Wizard
    Vite->>Browser: Open http://localhost:5173/setup

    Note over Browser: User sees setup wizard
```

**Created `config/private.ts`:**

```typescript
export const privateEnv = createPrivateConfig({
	DB_TYPE: 'mongodb',
	DB_HOST: '', // â† Empty values
	DB_PORT: 27017,
	DB_NAME: '', // â† Empty values
	DB_USER: '',
	DB_PASSWORD: '',
	JWT_SECRET_KEY: '', // â† Empty
	ENCRYPTION_KEY: '', // â† Empty
	MULTI_TENANT: false
});
```

### Phase 2: Server Hooks (Runtime)

**File: `src/hooks.server.ts`**

> **ğŸ“š For detailed middleware architecture, see [Server Hooks & Middleware](./server-hooks.mdx)**

```mermaid
flowchart TB
    A[Incoming Request] --> B{handleSystemState}
    B -->|System: IDLE| C{handleSetup}

    C -->|Check Config| D{private.ts valid?}
    D -->|No DB creds| E[isSetupComplete = false]

    E --> F{Path check}
    F -->|/setup or /api/setup| G[Allow Request]
    F -->|Other paths| H[Redirect to /setup]

    C -->|Check Database| I{hasAdminUsers?}
    I -->|No| E
    I -->|Yes| J[Allow Request - Setup Complete]

    style E fill:#d0d0d0,stroke:#333,stroke-width:3px
    style G fill:#e0e0e0,stroke:#333,stroke-width:2px
    style J fill:#e0e0e0,stroke:#333,stroke-width:2px
```

### Phase 3: Setup GUI Interaction

**File: `src/routes/setup/+page.svelte`**

```mermaid
stateDiagram-v2
    [*] --> DatabaseConfig: Step 1
    DatabaseConfig --> DatabaseTest: User fills DB form
    DatabaseTest --> SystemLanguage: Test passed âœ“
    SystemLanguage --> SeedData: Language selected
    SeedData --> AdminUser: Database seeded âœ“
    AdminUser --> Complete: Admin form submitted
    Complete --> [*]: Redirect to CMS

    DatabaseTest --> DatabaseConfig: Test failed âœ—

    note right of DatabaseTest
        POST /api/setup/test-database
        - Validates connection
        - Installs drivers if needed
    end note

    note right of SeedData
        POST /api/setup/seed
        - Writes private.ts
        - Seeds settings/themes
        - Creates collections
    end note

    note right of Complete
        POST /api/setup/complete
        - Creates admin user
        - Initializes system
        - Sets session cookie
    end note
```

User completes setup wizard:

```
Step 1: Database Configuration
  â†“
Step 2: Database Test â†’ /api/setup/test-database
  â†“
Step 3: System Language Selection
  â†“
Step 4: Seed Data â†’ /api/setup/seed
  â†“
Step 5: Admin User Creation â†’ /api/setup/complete
```

---

### Phase 4: Database Test

**Endpoint: `/api/setup/test-database/+server.ts`**

```mermaid
sequenceDiagram
    participant Client as Browser
    participant API as /api/setup/test-database
    participant PM as Package Manager
    participant Mongoose
    participant DB as MongoDB

    Client->>API: POST {host, port, name, user, pass}

    Note over API: Check Driver
    API->>Mongoose: Try import mongoose

    alt Driver Missing
        API->>PM: Detect package manager (bun/npm/pnpm/yarn)
        API->>PM: Install mongoose
        PM-->>API: Installation complete
    end

    Note over API: Build Connection
    API->>API: buildConnectionString()

    Note over API: Test Connection
    API->>DB: Connect with 15s timeout

    alt Success
        DB-->>API: Connected âœ“
        API->>DB: Authenticate
        DB-->>API: Auth OK âœ“
        API->>DB: Get database stats
        DB-->>API: {collections: 0, dataSize: 0}
        API-->>Client: {success: true, details: {...}}
    else Failure
        DB-->>API: Connection error
        API-->>Client: {success: false, error: "..."}
    end
```

```typescript
POST /api/setup/test-database
Body: {
  type: "mongodb",
  host: "localhost",
  port: 27017,
  name: "sveltycms",
  user: "admin",
  password: "secret123"
}
```

**Process:**

1. Detects package manager (bun/npm/pnpm/yarn)
2. Installs MongoDB driver if missing (`mongoose`)
3. Builds connection string
4. Tests connection with 15s timeout
5. Returns detailed validation results

**Response:**

```json
{
	"success": true,
	"message": "Connection successful",
	"details": {
		"authenticated": true,
		"dbStats": { "collections": 0, "dataSize": 0 },
		"warnings": []
	}
}
```

---

### Phase 5: Seed Database

**Endpoint: `/api/setup/seed/+server.ts`**

Called when user clicks "Next" after successful DB test.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Write config/private.ts                         â”‚
â”‚    - Writes DB credentials from test step          â”‚
â”‚    - Generates JWT_SECRET_KEY (32 bytes base64)    â”‚
â”‚    - Generates ENCRYPTION_KEY (32 bytes base64)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Initialize database adapter (setup mode)        â”‚
â”‚    - getSetupDatabaseAdapter(dbConfig)             â”‚
â”‚    - Creates MongoDBAdapter                        â”‚
â”‚    - Connects to database                          â”‚
â”‚    - Calls setupAuthModels()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Seed default data (seed.ts)                     â”‚
â”‚    A. seedSettings(adapter)                        â”‚
â”‚       - Creates system_settings collection         â”‚
â”‚       - Seeds defaultPublicSettings (53 keys)      â”‚
â”‚       - Seeds defaultPrivateSettings (23 keys)     â”‚
â”‚    B. seedDefaultTheme(adapter)                    â”‚
â”‚       - Creates system_themes collection           â”‚
â”‚       - Seeds SveltyCMSTheme                       â”‚
â”‚    C. seedCollectionsForSetup(adapter) âš ï¸          â”‚
â”‚       - Scans compiledCollections folder           â”‚
â”‚       - Creates collection models in MongoDB       â”‚
â”‚       - Returns firstCollection info               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Function: `seedCollectionsForSetup()`**

```typescript
// File: src/routes/api/setup/seed.ts

export async function seedCollectionsForSetup(dbAdapter) {
	// 1. Scan filesystem for compiled collections
	const { scanCompiledCollections } = await import('@src/content/collectionScanner');
	const collections = await scanCompiledCollections();

	// 2. Register each collection as a model
	for (const schema of collections) {
		await dbAdapter.collection.createModel(schema);
		// âš ï¸ Creates MongoDB collection: collection_<uuid>
	}

	// 3. Return first collection for fast redirect
	return { firstCollection: { name: 'Posts', path: '/Collections/Posts' } };
}
```

**Database Collections Created:**

```
system_settings          â† Public/private settings
system_themes            â† Theme configurations
system_content_structure â† Navigation/hierarchy (empty for now)
collection_<uuid_1>      â† First collection (e.g., Posts)
collection_<uuid_2>      â† Second collection (e.g., Names)
```

âš ï¸ **KNOWN ISSUE:** Only one `collection_<uuid>` table gets created instead of one per collection. This may be due to async race conditions in the `createModel()` method.

---

### Phase 6: Complete Setup

**Endpoint: `/api/setup/complete/+server.ts`**

Called when user submits admin user form.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Parse private.ts from filesystem                 â”‚
â”‚    - Bypasses Vite's import cache                  â”‚
â”‚    - Uses regex to extract config values           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Create setup database adapter                   â”‚
â”‚    - getSetupDatabaseAdapter(dbConfig)             â”‚
â”‚    - Creates Auth instance                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Create admin user + session (single transaction)â”‚
â”‚    - setupAuth.createUserAndSession({              â”‚
â”‚        username, email, password,                  â”‚
â”‚        role: 'admin', isRegistered: true           â”‚
â”‚      })                                            â”‚
â”‚    - Inserts into auth_users collection           â”‚
â”‚    - Creates session in auth_sessions collection  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Initialize global system (db.ts)               â”‚
â”‚    - initializeWithFreshConfig()                   â”‚
â”‚    - Reloads private.ts from filesystem            â”‚
â”‚    - Connects global dbAdapter                     â”‚
â”‚    - Loads settings from database                  â”‚
â”‚    - Initializes ThemeManager                      â”‚
â”‚    - Initializes MediaFolder                       â”‚
â”‚    - State: IDLE â†’ INITIALIZING â†’ READY           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Initialize ContentManager                       â”‚
â”‚    - contentManager.initialize(undefined, true)    â”‚
â”‚    - Loads collections from database               â”‚
â”‚    - Builds content structure cache                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Invalidate caches                               â”‚
â”‚    - invalidateSettingsCache()                     â”‚
â”‚    - invalidateSetupCache()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Send welcome email (optional, non-fatal)       â”‚
â”‚    - POST /api/sendMail                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Set session cookie                              â”‚
â”‚    - Creates httpOnly session cookie               â”‚
â”‚    - Sets theme cookies                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Return redirect path                            â”‚
â”‚    - Uses firstCollection from seed step (fast!)  â”‚
â”‚    - Redirects to /{lang}/{firstCollection.path}  â”‚
â”‚    - NO SERVER RESTART REQUIRED! âœ¨                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Response:**

```json
{
	"success": true,
	"message": "Setup complete! Welcome to SveltyCMS! ğŸ‰",
	"redirectPath": "/en/Collections/Posts",
	"loggedIn": true,
	"requiresHardReload": false,
	"requiresServerRestart": false
}
```

---

## Server Restart Flow

### Phase 1: Vite Startup (Build Time)

**File: `vite.config.ts`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Vite starts                                      â”‚
â”‚    - Checks if config/private.ts exists            â”‚
â”‚    - isSetupComplete() â†’ true (config exists +     â”‚
â”‚      has valid DB credentials)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. cmsWatcherPlugin() activates                     â”‚
â”‚    - Initializes collection structure              â”‚
â”‚    - Compiles collections intelligently            â”‚
â”‚    - Sets up file watchers                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: Intelligent Collection Compilation

**File: `src/utils/compilation/compile.ts`**

The compilation system uses **content hashing** and **UUID preservation** to avoid unnecessary recompilation:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Scan existing compiled collections              â”‚
â”‚    - Builds map: path â†’ { jsPath, uuid, hash }    â”‚
â”‚    - Extracts UUID and hash from JS files          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Scan source collections (config/collections)    â”‚
â”‚    - Gets list of .ts files                        â”‚
â”‚    - Calculates content hash for each              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Smart recompilation decision                    â”‚
â”‚    For each collection:                            â”‚
â”‚    IF hash matches existing compiled file          â”‚
â”‚      â†’ SKIP (no changes detected)                  â”‚
â”‚      â†’ PRESERVE existing UUID                      â”‚
â”‚    ELSE                                            â”‚
â”‚      â†’ RECOMPILE                                   â”‚
â”‚      â†’ PRESERVE existing UUID (if found)           â”‚
â”‚      â†’ GENERATE new UUID (if new file)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. AST transformation                              â”‚
â”‚    - Converts TypeScript to JavaScript             â”‚
â”‚    - Adds .js extensions to imports                â”‚
â”‚    - Injects _id (UUID) into schema                â”‚
â”‚    - Injects __HASH__ comment                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Cleanup orphaned files                          â”‚
â”‚    - Removes .js files without .ts source          â”‚
â”‚    - Removes empty directories                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Example Compiled Collection:**

```javascript
// compiledCollections/Collections/Posts.js
// __HASH__:a7f3e9c2d8b1f4a6e3c9d2b8f1a4e6c3

export const schema = {
	_id: '550e8400-e29b-41d4-a716-446655440000', // â† UUID preserved!
	name: 'Posts',
	icon: 'bi:file-text',
	fields: [
		{ label: 'Title', db_fieldName: 'title', widget: 'text' },
		{ label: 'Content', db_fieldName: 'content', widget: 'richtext' }
	]
};
```

### Phase 3: Server Initialization

**File: `src/hooks.server.ts` + `src/databases/db.ts`**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handleSystemState                                   â”‚
â”‚  - System state: IDLE                              â”‚
â”‚  - First request triggers: await dbInitPromise     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ initializeOnRequest() (db.ts)                       â”‚
â”‚  1. Load private config (privateEnv)               â”‚
â”‚  2. Connect to database                            â”‚
â”‚  3. Load adapters (MongoDBAdapter)                 â”‚
â”‚  4. Setup auth models                              â”‚
â”‚  5. Load settings from database                    â”‚
â”‚  6. Initialize default theme                       â”‚
â”‚  7. Initialize theme manager                       â”‚
â”‚  8. Initialize media folder                        â”‚
â”‚  9. Initialize virtual folders                     â”‚
â”‚  State: IDLE â†’ INITIALIZING â†’ READY               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ContentManager auto-initializes on first access    â”‚
â”‚  - Scans compiledCollections                       â”‚
â”‚  - Registers collection models in database         â”‚
â”‚  - Builds content structure cache                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Collection UUID Management

### UUID Assignment Strategy

**The Problem:**
Collections need stable, persistent IDs for:

- Database table names (`collection_<uuid>`)
- Content references (foreign keys)
- API routes
- Permissions/roles

**The Solution:**
UUIDs are assigned **once** at compilation and **preserved** across restarts.

### UUID Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. New Collection Created                          â”‚
â”‚    config/collections/Posts.ts                     â”‚
â”‚    export const schema = { name: "Posts", ... }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. First Compilation                               â”‚
â”‚    - Generates new UUID                            â”‚
â”‚    - Injects into schema._id                       â”‚
â”‚    - Saves to compiledCollections/Collections/     â”‚
â”‚      Posts.js                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Collection Modified                             â”‚
â”‚    config/collections/Posts.ts changed             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Smart Recompilation                             â”‚
â”‚    - Detects hash change                           â”‚
â”‚    - PRESERVES existing UUID from compiled file    â”‚
â”‚    - Recompiles with same UUID                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Server Restart                                  â”‚
â”‚    - Reads compiled collections                    â”‚
â”‚    - UUIDs remain stable                           â”‚
â”‚    - Database tables remain consistent             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### UUID Extraction Logic

**File: `src/utils/compilation/compile.ts`**

```typescript
// Extract UUID from compiled JS file
function extractUUIDFromJs(content: string): string | null {
	const match = content.match(/_id:\s*["']([^"']+)["']/);
	return match ? match[1] : null;
}

// Extract hash from compiled JS file
function extractHashFromJs(content: string): string | null {
	const match = content.match(/__HASH__:(\w+)/);
	return match ? match[1] : null;
}
```

**AST Transformation:**

```typescript
// Injects UUID into schema during compilation
const schemaUuidTransformer =
	(uuid: string): ts.TransformerFactory<ts.SourceFile> =>
	(context) =>
	(sourceFile) => {
		// Finds: export const schema = { ... }
		// Injects: _id: "uuid-here"
		// Result: export const schema = { _id: "uuid-here", ... }
	};
```

---

## Key Components

### 1. Configuration Files

| File                          | Purpose                                  | Created When                                 |
| ----------------------------- | ---------------------------------------- | -------------------------------------------- |
| `config/private.ts`           | Database credentials, security keys      | Vite startup (empty) â†’ Seed step (populated) |
| `config/collections/*.ts`     | Collection definitions (TypeScript)      | User-created                                 |
| `compiledCollections/**/*.js` | Compiled collections (JavaScript + UUID) | Build time                                   |

### 2. API Endpoints

| Endpoint                   | Purpose                                | Called When           |
| -------------------------- | -------------------------------------- | --------------------- |
| `/api/setup/test-database` | Validates DB connection                | Setup wizard (Step 2) |
| `/api/setup/seed`          | Seeds settings, themes, collections    | Setup wizard (Step 4) |
| `/api/setup/complete`      | Creates admin user, initializes system | Setup wizard (Step 5) |

### 3. Hooks & Middleware

| Hook                   | Purpose                            | Order |
| ---------------------- | ---------------------------------- | ----- |
| `handleSystemState`    | Blocks requests if system FAILED   | 1st   |
| `handleSetup`          | Redirects to /setup if incomplete  | 2nd   |
| `handleAuthentication` | Validates session, identifies user | 6th   |

### 4. Core Services

| Service           | Purpose                      | File                              |
| ----------------- | ---------------------------- | --------------------------------- |
| `dbAdapter`       | Database abstraction layer   | `src/databases/db.ts`             |
| `ContentManager`  | Collection management        | `src/content/ContentManager.ts`   |
| `Auth`            | Authentication/authorization | `src/databases/auth/index.ts`     |
| `SettingsService` | Settings cache management    | `src/services/settingsService.ts` |

---

## State Machine

### System States

```
IDLE â†’ INITIALIZING â†’ READY â†’ DEGRADED â†’ FAILED
  â†‘                      â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         (reinit)
```

| State            | Description                           | Allowed Routes                    |
| ---------------- | ------------------------------------- | --------------------------------- |
| **IDLE**         | No valid config or not initialized    | `/setup`, `/api/setup`, `/static` |
| **INITIALIZING** | Loading config, connecting to DB      | `/api/system/health`              |
| **READY**        | Fully operational                     | All routes                        |
| **DEGRADED**     | Some services failed, but operational | All routes (with warnings)        |
| **FAILED**       | Critical failure, unusable            | None (503 errors)                 |

### Transition Triggers

```typescript
// File: src/stores/system.ts

export function transitionTo(newState: SystemState, reason?: string) {
	const oldState = state.overallState;
	state.overallState = newState;
	state.performanceMetrics.stateTransitions.push({
		from: oldState,
		to: newState,
		timestamp: Date.now(),
		reason
	});
}
```

---

## Known Issues

### Issue #1: Collection UUID Tables

**Problem:**
During `seedCollectionsForSetup()`, only one `collection_<uuid>` table gets created in MongoDB instead of one per collection.

**Expected Behavior:**

```
collection_550e8400-e29b-41d4-a716-446655440000  (Posts)
collection_7c9e6679-7425-40de-944b-e07fc1f90ae7  (Names)
collection_a8098c1a-f86e-11da-bd1a-00112444be1e  (WidgetTest)
```

**Actual Behavior:**

```
collection_550e8400-e29b-41d4-a716-446655440000  (Only one table)
```

**Root Cause (Suspected):**

1. **Race Condition:** Multiple `createModel()` calls execute in parallel without proper locking
2. **Mongoose Model Registry:** Mongoose may be caching models by name, causing conflicts
3. **MongoDB Collection Creation:** MongoDB creates collections lazily on first insert, but the model registration may be conflicting

**Location:**

```typescript
// File: src/routes/api/setup/seed.ts

for (const schema of collections) {
	await dbAdapter.collection.createModel(schema);
	// âš ï¸ Potential race condition here
}
```

**Suggested Fix:**

```typescript
// Add mutex or serial execution
const results = [];
for (const schema of collections) {
	const result = await dbAdapter.collection.createModel(schema);
	results.push(result);
	// Add small delay to avoid race conditions
	await new Promise((resolve) => setTimeout(resolve, 100));
}
```

**Alternative Fix (Better):**

```typescript
// Use batch operation with proper transaction
await dbAdapter.collection.createModels(collections);
// Implement atomic batch creation in MongoCollectionMethods
```

### Issue #2: Vite Cache Invalidation

**Problem:**
After `writePrivateConfig()` creates/updates `config/private.ts`, Vite's import cache may serve the old version.

**Current Workaround:**

- `/api/setup/complete` reads private.ts directly from filesystem using `fs.readFile()`
- Bypasses Vite's import cache with regex parsing
- `initializeWithFreshConfig()` forces fresh import with dynamic import

**Better Solution:**

- Implement proper Vite HMR invalidation for config files
- Use Vite's `server.moduleGraph.invalidateModule()` API

---

## Flow Diagrams

### First-Time Setup (Complete Flow)

```mermaid
sequenceDiagram
    participant V as Vite
    participant H as Hooks
    participant U as User (Browser)
    participant API as Setup API
    participant DB as Database
    participant CM as ContentManager

    V->>V: Check private.ts (missing)
    V->>V: Create blank private.ts
    V->>V: Compile collections
    V->>U: Open /setup in browser

    U->>API: POST /api/setup/test-database
    API->>DB: Test connection
    DB-->>API: Success
    API-->>U: Connection valid

    U->>API: POST /api/setup/seed
    API->>API: Write private.ts (with credentials)
    API->>DB: Seed settings
    API->>DB: Seed themes
    API->>DB: Seed collections (create models)
    API-->>U: Seed complete + firstCollection

    U->>API: POST /api/setup/complete
    API->>DB: Create admin user + session
    API->>API: initializeWithFreshConfig()
    API->>CM: Initialize ContentManager
    API->>API: Invalidate caches
    API-->>U: Setup complete + redirect + session cookie

    U->>H: GET /en/Collections/Posts
    H->>H: handleSetup: isSetupComplete() â†’ true
    H->>CM: Load collection
    CM-->>U: Render collection view
```

### Server Restart (Smart Compilation)

```mermaid
sequenceDiagram
    participant V as Vite
    participant FS as Filesystem
    participant CM as Compilation
    participant DB as Database

    V->>V: Check private.ts (exists + valid)
    V->>CM: Trigger intelligent compilation

    CM->>FS: Scan compiledCollections/
    FS-->>CM: {path â†’ {jsPath, uuid, hash}}

    CM->>FS: Scan config/collections/
    FS-->>CM: List of .ts files

    loop For each collection
        CM->>CM: Calculate content hash
        alt Hash matches
            CM->>CM: SKIP (no changes)
        else Hash differs
            CM->>CM: RECOMPILE
            CM->>CM: PRESERVE UUID
            CM->>FS: Write updated .js file
        end
    end

    CM->>V: Compilation complete
    V->>DB: Initialize database connection
    V->>CM: Initialize ContentManager
    CM->>DB: Register collection models
```

---

## Best Practices

### For Developers

1. **Never manually edit compiled collections** (`compiledCollections/`)
   - Always edit source files (`config/collections/`)
   - Let the compilation system handle UUID preservation

2. **Don't delete compiled collections during development**
   - UUIDs would be regenerated, breaking database references
   - Use `git clean` carefully

3. **Use content hashing for change detection**
   - The system automatically detects changes via SHA-256 hash
   - No manual intervention needed

### For System Administrators

1. **Backup compiled collections before migrations**

   ```bash
   tar -czf compiledCollections.backup.tar.gz compiledCollections/
   ```

2. **Database migrations preserve UUIDs**
   - Collection IDs are stored in `_id` field
   - Never modify `_id` in database or compiled files

3. **Setup completion is atomic**
   - If setup fails, system reverts to setup mode
   - No partial state left behind

---

## Troubleshooting

### Setup wizard loops infinitely

**Cause:** `isSetupCompleteAsync()` returns false due to missing users

**Fix:**

```bash
# Check if admin users exist
mongo sveltycms --eval "db.auth_users.find().pretty()"

# If empty, complete setup wizard again
# or manually create admin user via MongoDB shell
```

### Collections not appearing after setup

**Cause:** `seedCollectionsForSetup()` failed silently

**Fix:**

```bash
# Check logs for collection seeding errors
tail -f logs/app.log | grep "seedCollections"

# Manually trigger collection initialization
# Restart server with DEBUG=true
```

### UUID changed after recompilation

**Cause:** Compiled collection was deleted or corrupted

**Fix:**

```bash
# Restore from backup
tar -xzf compiledCollections.backup.tar.gz

# Or manually restore UUID in MongoDB
mongo sveltycms --eval 'db.system_content_structure.find({name: "Posts"})'
# Copy _id, then update compiled file
```

---

## Summary

SveltyCMS uses a sophisticated initialization workflow that:

âœ… **Avoids server restarts** after initial setup  
âœ… **Preserves collection UUIDs** across restarts  
âœ… **Intelligently recompiles** only changed collections  
âœ… **Seeds database atomically** with all required data  
âœ… **Provides fast redirects** using cached first collection  
âœ… **Handles errors gracefully** with detailed logging

âš ï¸ **Known Issue:** Collection UUID table creation may have race conditions during `seedCollectionsForSetup()`

The system is production-ready but requires monitoring during the seeding phase to ensure all collection models are created correctly.

---

## Related Documentation

### Architecture

- [Collection Store Data Flow](/docs/architecture/collection-store-dataflow.mdx) - How data flows through the collection store
- [State Management](/docs/architecture/state-management.mdx) - System state machine details
- [Cache System](/docs/architecture/cache-system.mdx) - Caching strategy and TTLs

### API References

- [Setup API](/docs/api/Setup_API.mdx) - Complete setup API reference
- [Collection API](/docs/api/Collection_API.mdx) - Collection CRUD operations
- [Authentication API](/docs/api/Authentication_2FA_API.mdx) - User authentication

### Database

- [Core Infrastructure](/docs/database/Core_Infrastructure.mdx) - Database adapter system
- [MongoDB Methods](/docs/database/MongoDB_Methods.mdx) - MongoDB-specific implementation

### Guides

- [Installation Guide](/docs/installation.mdx) - Step-by-step installation
- [Troubleshooting](/docs/troubleshooting.mdx) - Common issues and solutions

---

## Quick Reference

### Key Files

| File                               | Purpose                    | When Modified                   |
| ---------------------------------- | -------------------------- | ------------------------------- |
| `vite.config.ts`                   | Build-time setup detection | Rarely                          |
| `src/hooks.server.ts`              | Runtime request gatekeeper | When adding middleware          |
| `src/databases/db.ts`              | Database initialization    | When adding adapters            |
| `src/content/ContentManager.ts`    | Collection management      | When changing collection logic  |
| `src/utils/compilation/compile.ts` | Smart compilation          | When changing collection format |

### Key Concepts

- **Setup Mode**: System state when no admin users exist
- **UUID Preservation**: Collections keep the same ID across restarts
- **Smart Compilation**: Only recompiles changed collections using content hashing
- **Zero-Restart Setup**: System becomes operational without server restart
- **State Machine**: IDLE â†’ INITIALIZING â†’ READY â†’ DEGRADED â†’ FAILED

### Performance Benchmarks

| Operation          | Expected Time     | Notes                           |
| ------------------ | ----------------- | ------------------------------- |
| Vite Startup       | 2-5 seconds       | Includes TypeScript compilation |
| Database Test      | 1-3 seconds       | May include driver installation |
| Seed Database      | 3-8 seconds       | Depends on collection count     |
| Complete Setup     | 4-6 seconds       | Includes full system init       |
| **Total Setup**    | **10-25 seconds** | Excluding user input            |
| Collection Compile | 50-200ms per file | With UUID preservation          |
| Server Restart     | 3-5 seconds       | To READY state                  |
