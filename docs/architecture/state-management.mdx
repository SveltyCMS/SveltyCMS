---
path: 'docs/architecture/state-management.mdx'
title: 'System State & Health Architecture'
description: 'Technical documentation of the SveltyCMS state machine, request gating middleware, and health monitoring system.'
order: 30
icon: 'mdi:state-machine'
author: 'SveltyCMS Team'
created: '2025-11-26'
updated: '2025-11-26'
tags:
  - 'architecture'
  - 'state-machine'
  - 'middleware'
  - 'health'
---

# System State & Health Architecture

SveltyCMS employs a robust **State Machine** to manage the application's lifecycle, ensure data integrity, and handle system failures gracefully. This system acts as a gatekeeper for all incoming requests.

## üß† Core Concepts

The system state is managed by a central store (`@stores/system`) and enforced by the `handleSystemState` server hook.

### Initialization Stages (Granular Control)

Beyond simple states, the system tracks precise initialization progress:

1.  **`starting`**: Process begun.
2.  **`db_connecting`**: Critical. Establishing database pool.
3.  **`auth_initializing`**: Critical. Setting up authentication models.
4.  **`api_ready`**: **API Prioritization Point.** Database and Auth are ready. API endpoints can serve requests.
5.  **`services_starting`**: Background services (Themes, Widgets) initializing lazily or in background.
6.  **`active`**: Full system ready.

### System States

The application can be in one of the following states:

| State              | Description                                                       | Request Handling                                  |
| :----------------- | :---------------------------------------------------------------- | :------------------------------------------------ |
| **`IDLE`**         | Initial state. System is waiting for setup or initialization.     | **Blocked** (except Setup Wizard & Health Checks) |
| **`INITIALIZING`** | Database connection and core services are starting up.            | **Blocked** (requests wait for completion)        |
| **`READY`**        | Normal operational state. All systems go.                         | **Allowed**                                       |
| **`DEGRADED`**     | System is operational but some non-critical services are failing. | **Allowed** (with warning logs)                   |
| **`FAILED`**       | Critical failure (e.g., DB down). System cannot function.         | **Blocked** (503 Service Unavailable)             |

---

## üõ°Ô∏è Request Gating Middleware

The `handleSystemState` hook (`src/hooks/handleSystemState.ts`) intercepts every request to ensure the system is ready to handle it.

### Logic Flow

### Logic Flow

1.  **Health Checks & Static Assets**: Always allowed.
2.  **IDLE State**: Setup mode only (`/setup`, `/api/setup`).
3.  **INITIALIZING State**:
    - **Gradual API Unlocking**: As soon as the `api_ready` stage is reached, API endpoints become accessible, even if `Themes` or `Widgets` are still loading. This utilizes **Lazy Loading** to prioritize data availability.
    - Full system waits for `active` stage for UI rendering.
4.  **FAILED State**: 503 Service Unavailable.
5.  **READY / DEGRADED**: Normal operation.

---

## üöÄ Smart Architecture Features

We have implemented an advanced, resilient state machine:

### 1. Resource Optimization (Lazy Loading)

To save resources (CPU/RAM) and improve startup speed, non-critical services are initialized **Lazily or in Background**:

- **Themes & Widgets**: Initialized only when requested or after critical paths.
- **Media System**: Virtual folders verified in background.

This decoupling allows the API to respond milliseconds after DB connection, without waiting for filesystem scans.

### 2. Event-Driven Architecture

The system uses a `SystemEventBus` (`systemEvents`) to broadcast state changes, replacing rigid polling:

- `SYSTEM:READY`
- `BREAKER:TRIPPED`
- `STAGE:CHANGED`

### 3. Circuit Breakers (Resilience)

To prevent cascading failures, individual services (e.g., `widgets`) have **Circuit Breakers**:

- If a service fails repeatedly (default 5 times), the breaker **TRIPS**.
- The service enters `breaker_tripped` status.
- Traffic to that service is fast-failed, while the rest of the CMS remains `READY`.
- System attempts auto-reset after a cooldown.

---

---

## üîç Related Documentation

- **[Server Hooks](./server-hooks.mdx)** - Overview of the middleware pipeline.
- **[Database Core](./database/Core_Infrastructure.mdx)** - Database connection management.
- **[UI & Screen State](./ui-and-screen-state.mdx)** - Responsive layout and visibility management.
