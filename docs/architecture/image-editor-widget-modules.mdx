---
path: 'docs/architecture/image-editor-widget-modules.mdx'
title: 'Image Editor Widget Modules'
description: 'Detailed documentation of the modularized widget architecture, utility files, and class structures'
order: 12
icon: 'mdi:puzzle'
author: 'admin'
created: '2025-11-16'
updated: '2025-11-16'
tags:
  - 'image-editor'
  - 'widgets'
  - 'modules'
  - 'architecture'
  - 'refactoring'
---

# Image Editor Widget Modules

## ðŸ“¦ Modularization Overview

All Image Editor widgets have been refactored into a modular architecture for better code organization, reusability, and maintainability. Each widget now separates concerns into dedicated utility files.

## ðŸ—‚ï¸ Standard Module Structure

```
widgets/[WidgetName]/
â”œâ”€â”€ index.ts          # Widget metadata & registration
â”œâ”€â”€ Tool.svelte       # Main controller (canvas logic)
â”œâ”€â”€ Controls.svelte   # Toolbar UI component
â””â”€â”€ [utility files]   # Modular helper functions/classes
```

---

## ðŸŒ«ï¸ Blur Widget Modules

### File Structure

```
Blur/
â”œâ”€â”€ index.ts
â”œâ”€â”€ Tool.svelte
â”œâ”€â”€ Controls.svelte
â””â”€â”€ regions.ts       # BlurRegion class
```

### regions.ts

**Purpose**: Encapsulates all Konva nodes, clip mapping, caching strategy, and lifecycle for blur regions.

```typescript
export type BlurShape = 'rectangle' | 'ellipse';
export type BlurPattern = 'blur' | 'pixelate';
export type RegionInit = {
	x?: number;
	y?: number;
	width?: number;
	height?: number;
	shape?: BlurShape;
	pattern?: BlurPattern;
	strength?: number;
};

export class BlurRegion {
	id: string;
	shapeNode: Konva.Rect | Konva.Ellipse; // Visible wireframe
	overlay: Konva.Image; // Filtered overlay image
	transformer?: Konva.Transformer;
	toolbar?: Konva.Group;
	private layer: Konva.Layer;
	private imageNode: Konva.Image;
	private imageGroup: Konva.Group;
	private currentPattern: BlurPattern;
	private currentStrength: number;
	private _cacheTimer: number | null;

	constructor(opts: { id: string; layer: Konva.Layer; imageNode: Konva.Image; imageGroup: Konva.Group; init?: RegionInit });

	// Pattern and strength control
	setPattern(pattern: BlurPattern): void;
	setStrength(strength: number): void;

	// Drawing lifecycle
	resizeFromStart(start: { x: number; y: number }, pos: { x: number; y: number }): void;
	finalize(): void;

	// State management
	setActive(isActive: boolean): void;
	hideUI(): void;
	isTooSmall(): boolean;

	// Baking
	cloneForBake(): Konva.Image | null;

	// Cleanup
	destroy(): void;

	// Event callbacks
	onSelect(cb: () => void): void;
	onDestroy(cb: () => void): void;
}
```

**Key Methods**:

- `setPattern()` - Switches between blur and pixelate filters
- `setStrength()` - Updates blur radius/pixel size with debounced caching
- `resizeFromStart()` - Fast resize during initial drawing (no cache)
- `finalize()` - Attaches transformer after drawing complete
- `cloneForBake()` - Creates clone with clipFunc for offscreen baking
- `makeClipFunc()` - Maps shape absolute transform to overlay space

**Caching Strategy**:

- Initial setup: No cache (fast)
- During transform: No cache (fast batch draw)
- After strength change: Debounced cache (140ms delay)
- Pattern change: Immediate cache (filter array changed)

---

## âœï¸ Annotate Widget Modules

### File Structure

```
Annotate/
â”œâ”€â”€ index.ts
â”œâ”€â”€ Tool.svelte
â”œâ”€â”€ Controls.svelte
â”œâ”€â”€ regions.ts       # AnnotationItem class
â”œâ”€â”€ draw.ts          # Drawing factory functions
â”œâ”€â”€ editText.ts      # Text editing utilities
â”œâ”€â”€ events.ts        # Event namespacing
â””â”€â”€ transformer.ts   # Transformer utilities
```

### regions.ts

**Purpose**: Encapsulates one annotation node with lifecycle management.

```typescript
export type AnnotationKind = 'text' | 'rect' | 'circle' | 'arrow' | 'line';

export class AnnotationItem {
	id: string;
	node: Konva.Node;
	layer: Konva.Layer;
	kind: AnnotationKind;
	private _onSelect: (() => void) | null;
	private _onDestroy: (() => void) | null;

	constructor(id: string, node: Konva.Node, layer: Konva.Layer, kind: AnnotationKind);

	enableInteraction(): void;
	disableInteraction(): void;
	on(event: string, cb: Function): void;
	off(event: string): void;
	destroy(): void;

	onSelect(cb: () => void): void;
	onDestroy(cb: () => void): void;
}
```

### draw.ts

**Purpose**: Factory functions for creating Konva annotation nodes.

```typescript
export function createText(layer: Konva.Layer, x: number, y: number, text?: string, fontSize?: number, color?: string): Konva.Text;

export function createRect(
	layer: Konva.Layer,
	x: number,
	y: number,
	w?: number,
	h?: number,
	stroke?: string,
	fill?: string,
	strokeWidth?: number
): Konva.Rect;

export function createCircle(
	layer: Konva.Layer,
	x: number,
	y: number,
	radius?: number,
	stroke?: string,
	fill?: string,
	strokeWidth?: number
): Konva.Circle;

export function createLine(layer: Konva.Layer, points: number[], stroke?: string, strokeWidth?: number): Konva.Line;

export function createArrow(layer: Konva.Layer, points: number[], stroke?: string, strokeWidth?: number): Konva.Arrow;
```

### editText.ts

**Purpose**: Creates HTML textarea overlay for editing Konva.Text nodes.

```typescript
export function enableTextEdit(stage: Konva.Stage, textNode: Konva.Text, onComplete: (txt: string) => void): void;
```

**Handles**:

- Correct positioning with page scroll offsets (`window.scrollX`, `window.scrollY`)
- Style matching (fontSize, fontFamily, color, etc.)
- Keyboard events (Enter to finish, Shift+Enter for newline, Escape to cancel)
- Cleanup on blur

### events.ts

**Purpose**: Event namespacing to avoid conflicts.

```typescript
export const NS = 'annotate';
export function names(event: string): string;
```

Usage: `stage.on(names('mousedown'), handler)` â†’ `'mousedown.annotate mousedown.annotate'`

### transformer.ts

**Purpose**: Safe transformer creation with conservative defaults.

```typescript
export function createTransformer(layer: Konva.Layer): Konva.Transformer;

export function attachTransformer(tr: Konva.Transformer, node?: Konva.Node | null): void;
```

**Features**:

- Error handling for invalid nodes
- Bound box validation (min 5x5 pixels)
- Auto-hide when no node attached

---

## ðŸŒ¾ Crop Widget Modules

### File Structure

```
Crop/
â”œâ”€â”€ index.ts
â”œâ”€â”€ Tool.svelte
â”œâ”€â”€ Controls.svelte
â”œâ”€â”€ regions.ts       # CropRegion class
â”œâ”€â”€ aspect.ts        # Aspect ratio parsing
â”œâ”€â”€ cropMath.ts      # Coordinate transformations
â”œâ”€â”€ highlight.ts     # Overlay cutout sync
â””â”€â”€ overlay.ts       # Overlay group factory
```

### regions.ts

**Purpose**: Encapsulates crop UI with overlay, tool border, and transformer.

```typescript
export type CropShape = 'rectangle' | 'square' | 'circular';
export type RegionInit = {
	x?: number;
	y?: number;
	width?: number;
	height?: number;
	shape?: CropShape;
	aspect?: string;
};

export class CropRegion {
	id: string;
	layer: Konva.Layer;
	imageNode: Konva.Image;
	imageGroup: Konva.Group;
	shape: Konva.Rect | Konva.Circle; // Visible crop tool
	overlayGroup: Konva.Group; // Cached dark overlay + cutout
	transformer?: Konva.Transformer;
	private aspect: string | null;
	private _onTransform: (() => void) | null;
	private _onTransformEnd: (() => void) | null;
	private _onDestroy: (() => void) | null;

	constructor(opts: { id: string; layer: Konva.Layer; imageNode: Konva.Image; imageGroup: Konva.Group; init?: RegionInit });

	updateCutout(shouldCache?: boolean): void;
	centerIn(rect: { x: number; y: number; width: number; height: number }): void;
	attachTransformer(): void;
	hideUI(): void;
	destroy(): void;

	onTransform(cb: () => void): void;
	onTransformEnd(cb: () => void): void;
	onDestroy(cb: () => void): void;
}
```

**Key Methods**:

- `updateCutout()` - Syncs cutout shape with tool position/size (uses highlight.ts)
- `centerIn()` - Re-centers crop region in a given rect
- `attachTransformer()` - Creates transformer with aspect ratio enforcement
- `hideUI()` - Hides transformer, shape, and overlay for baking

**Overlay Architecture**:

- Full-screen dark rectangle (rgba(0,0,0,0.7))
- Cutout shape with `globalCompositeOperation: 'destination-out'`
- Cached as single group for performance

### aspect.ts

**Purpose**: Parse aspect ratio strings into numeric ratios.

```typescript
export function parseAspectRatio(ratio: string | null): number | null;
```

Examples:

- `'free'` â†’ `null`
- `'16:9'` â†’ `1.777...`
- `'1:1'` â†’ `1.0`
- `'invalid'` â†’ `null`

### cropMath.ts

**Purpose**: Convert stage coordinates to image-local pixel coordinates.

```typescript
export function stageRectToImageRect(
	rect: { x: number; y: number; width: number; height: number },
	imageNode: Konva.Image,
	imageGroup: Konva.Group
): { x: number; y: number; width: number; height: number };
```

**Algorithm**:

1. Get imageGroup absolute transform
2. Invert transform matrix
3. Transform stage rect corners to image space
4. Account for image offsetX/offsetY (center pivot)
5. Clamp to image bounds
6. Return pixel-perfect crop rect

### highlight.ts

**Purpose**: Synchronize overlay cutout with crop tool transform.

```typescript
export function syncHighlight(overlayGroup: Konva.Group, cropTool: Konva.Shape, shouldCache?: boolean): void;
```

**Steps**:

1. Find cutout shape inside overlay group (`.cropCut`)
2. Copy position, size, rotation from crop tool
3. Re-cache overlay group if `shouldCache === true`
4. Batch draw layer

### overlay.ts

**Purpose**: Factory for creating cached overlay groups.

```typescript
export function createOverlayGroup(stage: Konva.Stage, cutout: Konva.Shape): Konva.Group;
```

---

## ðŸŽ¨ FineTune Widget Modules

### File Structure

```
FineTune/
â”œâ”€â”€ index.ts
â”œâ”€â”€ Tool.svelte
â”œâ”€â”€ Controls.svelte
â”œâ”€â”€ adjustments.ts    # Adjustment definitions
â”œâ”€â”€ baseFilters.ts    # Konva built-in filters
â””â”€â”€ customFilters.ts  # Custom pixel filters
```

### adjustments.ts

**Purpose**: Central adjustment type definitions and defaults.

```typescript
export interface Adjustments {
	brightness: number; // -100 to +100
	contrast: number;
	saturation: number;
	temperature: number;
	exposure: number;
	highlights: number;
	shadows: number;
	clarity: number;
	vibrance: number;
}

export const DEFAULT_ADJUSTMENTS: Adjustments = {
	brightness: 0,
	contrast: 0,
	saturation: 0,
	temperature: 0,
	exposure: 0,
	highlights: 0,
	shadows: 0,
	clarity: 0,
	vibrance: 0
};

export const ADJUSTMENT_OPTIONS = [
	{ key: 'brightness', label: 'Brightness' },
	{ key: 'contrast', label: 'Contrast' }
	// ... etc
] as const;
```

### baseFilters.ts

**Purpose**: Apply Konva's fast, built-in filters.

```typescript
export function applyBaseFilters(node: Konva.Image, adj: Adjustments): void;
```

**Applies**:

- `node.brightness()` - Brightness adjustment
- `node.contrast()` - Contrast adjustment
- `node.saturation()` - Combined saturation + vibrance
- `node.hue()` - Temperature (hue shift)

**Performance**: Fast (native Konva filters, no pixel looping)

### customFilters.ts

**Purpose**: Custom pixel-level filters for advanced adjustments.

```typescript
export function createCustomFilter(adj: Adjustments): (imageData: ImageData) => void;
```

**Implements**:

- **Exposure**: Multiply RGB by exposure factor
- **Highlights**: Target bright pixels (luminance > 150)
- **Shadows**: Target dark pixels (luminance < 100)
- **Clarity**: Increase mid-tone contrast around 128

**Performance**: Slow (pixel-by-pixel manipulation) - applied via Konva custom filter

**Usage Pattern**:

```typescript
const customFilter = createCustomFilter(adjustments);
imageNode.filters([Konva.Filters.Brighten, customFilter]);
imageNode.cache();
```

---

## ðŸ·ï¸ Watermark Widget Modules

### File Structure

```
Watermark/
â”œâ”€â”€ index.ts
â”œâ”€â”€ Tool.svelte
â”œâ”€â”€ Controls.svelte
â””â”€â”€ regions.ts       # WatermarkItem class
```

### regions.ts

**Purpose**: Encapsulates watermark image loading, positioning, and lifecycle.

```typescript
export class WatermarkItem {
	id: string;
	node: Konva.Image;
	layer: Konva.Layer;
	imageGroup: Konva.Group;
	private objectUrl: string | null; // For URL cleanup
	private _onSelect: (() => void) | null;
	private _onDestroy: (() => void) | null;

	constructor(opts: { id: string; layer: Konva.Layer; imageGroup: Konva.Group });

	loadImage(file: File, options: { opacity: number; stageWidth: number; stageHeight: number }): Promise<void>;

	setOpacity(opacity: number): void;

	snapTo(position: string): void; // 'tl', 'tc', 'tr', 'cl', 'c', 'cr', 'bl', 'bc', 'br'

	disableInteraction(): void;

	destroy(): void;

	onSelect(cb: () => void): void;
	onDestroy(cb: () => void): void;
}
```

**Key Methods**:

- `loadImage()` - Async load from File object, auto-size to 20% of stage width
- `snapTo()` - Snap watermark to 9 predefined positions with padding
- `setOpacity()` - Update watermark transparency
- `destroy()` - Cleanup with URL.revokeObjectURL()

**Snap Positions**:

```
tl  tc  tr
cl  c   cr
bl  bc  br
```

---

## ðŸ”‘ Key Design Patterns

### 1. Class-Based Region Management

All multi-instance widgets (Blur, Annotate, Watermark) use class-based region/item management:

```typescript
class RegionClass {
	// Core Konva nodes
	node: Konva.Node;
	transformer?: Konva.Transformer;

	// Lifecycle
	constructor(opts);
	destroy();

	// Event callbacks
	onSelect(cb: () => void);
	onDestroy(cb: () => void);
}
```

**Benefits**:

- Encapsulated state
- Clear lifecycle hooks
- Event-driven architecture
- Easy memory cleanup

### 2. Factory Pattern for Node Creation

Annotate uses factory functions instead of classes:

```typescript
// Instead of: new TextAnnotation(x, y, text)
// Use: createText(layer, x, y, text)
```

**Benefits**:

- Functional style
- No need to track instances
- Direct Konva node return

### 3. Modular Utilities

Separate complex logic into dedicated files:

```typescript
// Bad: All math in Tool.svelte
// Good: Import from cropMath.ts
import { stageRectToImageRect } from './cropMath';
```

**Benefits**:

- Testable in isolation
- Reusable across widgets
- Clear single responsibility

### 4. Type-Safe Configurations

All modules export strict TypeScript types:

```typescript
export type CropShape = 'rectangle' | 'square' | 'circular'; // Not string!
export type BlurPattern = 'blur' | 'pixelate';
export type AnnotationKind = 'text' | 'rect' | 'circle' | 'arrow' | 'line';
```

### 5. Event Callback Pattern

All region classes use callback setters instead of event emitters:

```typescript
region.onSelect(() => {
	console.log('Region selected!');
});

region.onDestroy(() => {
	console.log('Region destroyed!');
});
```

**Benefits**:

- Simple API
- No event name strings
- Type-safe callbacks

---

## ðŸ§ª Testing Strategy

### Unit Testing Utilities

Each utility file should be independently testable:

```typescript
// aspect.test.ts
import { parseAspectRatio } from './aspect';

test('parses valid ratios', () => {
	expect(parseAspectRatio('16:9')).toBeCloseTo(1.777);
	expect(parseAspectRatio('1:1')).toBe(1.0);
});

test('handles invalid input', () => {
	expect(parseAspectRatio('free')).toBeNull();
	expect(parseAspectRatio('invalid')).toBeNull();
});
```

### Integration Testing Classes

Test region classes with Konva mocks:

```typescript
// BlurRegion.test.ts
import { BlurRegion } from './regions';

test('creates blur region', () => {
	const region = new BlurRegion({
		id: 'test',
		layer: mockLayer,
		imageNode: mockImage,
		imageGroup: mockGroup
	});

	expect(region.shapeNode).toBeDefined();
	expect(region.overlay).toBeDefined();
});
```

---

## ðŸ“Š Module Dependencies

```
Tool.svelte
  â”œâ”€â”€ Controls.svelte
  â”œâ”€â”€ regions.ts (Blur, Crop, Annotate, Watermark)
  â”œâ”€â”€ adjustments.ts (FineTune)
  â”œâ”€â”€ baseFilters.ts (FineTune)
  â”œâ”€â”€ customFilters.ts (FineTune)
  â”œâ”€â”€ draw.ts (Annotate)
  â”œâ”€â”€ editText.ts (Annotate)
  â”œâ”€â”€ events.ts (Annotate)
  â”œâ”€â”€ transformer.ts (Annotate)
  â”œâ”€â”€ aspect.ts (Crop)
  â”œâ”€â”€ cropMath.ts (Crop)
  â”œâ”€â”€ highlight.ts (Crop)
  â””â”€â”€ overlay.ts (Crop)
```

**No Circular Dependencies** âœ…

All utility modules are pure functions or standalone classes with no imports from Tool.svelte or Controls.svelte.

---

## ðŸš€ Migration Guide

### Before (Monolithic)

```svelte
<!-- Tool.svelte -->
<script>
	// 500+ lines of mixed concerns
	function createBlurRegion() {
		/* ... */
	}
	function parseAspectRatio() {
		/* ... */
	}
	function createText() {
		/* ... */
	}
	// ... etc
</script>
```

### After (Modular)

```svelte
<!-- Tool.svelte -->
<script>
	import { BlurRegion } from './regions';
	import { parseAspectRatio } from './aspect';
	import { createText } from './draw';

	// Clean, focused controller logic
	const region = new BlurRegion({ id, layer, imageNode, imageGroup });
</script>
```

---

## ðŸ“š Related Documentation

- [Image Editor Architecture](/docs/architecture/image-editor-architecture)
- [Image Editor Widgets Reference](/docs/architecture/image-editor-widgets)
- [Widget System Overview](/docs/widgets/widget-system-overview)

---

**Last Updated**: 2025-11-16  
**Status**: âœ… Production Ready
