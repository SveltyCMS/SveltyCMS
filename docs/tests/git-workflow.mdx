---
path: 'docs/tests/git-workflow.mdx'
title: 'Git Workflow & Automated Testing'
description: 'Complete guide to branching strategy, commit conventions, automated testing with Bun and Playwright, and semantic releases with GitHub Actions.'
order: 3
icon: 'mdi:git'
author: 'admin'
created: '2025-09-28'
updated: '2025-11-21'
tags:
  - 'git'
  - 'workflow'
  - 'testing'
  - 'ci-cd'
  - 'release'
  - 'development'
---

# Git Workflow & Automated Testing

## Introduction

SveltyCMS uses a comprehensive Git workflow with automated testing and semantic versioning to ensure code quality and streamline the release process. Understanding this workflow is essential for all contributors.

Our CI/CD pipeline uses:

- **Bun Tests** for fast unit & integration testing (~575 tests)
- **Playwright** for comprehensive E2E testing (~40 tests)
- **Semantic Release** for automated versioning
- **GitHub Actions** for CI/CD automation
- **Test Gating** to ensure releases only happen when tests pass
- **Future**: Matrix testing across multiple databases (MongoDB, PostgreSQL, MariaDB, MySQL)

## Table of Contents

1. [Branching Strategy](#branching-strategy)
2. [Commit Message Convention](#commit-message-convention)
3. [GitHub Actions Workflows](#github-actions-workflows)
4. [Automated Testing](#automated-testing)
5. [Release Process](#release-process)
6. [Development Workflow](#development-workflow)
7. [Best Practices](#best-practices)

---

## Branching Strategy

We have two primary, long-lived branches: `main` and `next`.

### `main` Branch (Production)

- **Purpose**: Production-ready, stable code. This branch represents the latest official release.
- **Protection**:
  - Protected branch requiring pull request reviews
  - All code must first be merged into `next`
  - Promoted to `main` only after thorough testing
  - Tests must pass before any release is created
- **Automated Actions**:
  - âœ… Runs full Playwright + Bun test suite
  - âœ… Only releases if tests pass
  - âœ… Creates stable semantic version (e.g., `v1.3.0`)
  - âœ… Automatically cleans `/config/collections` directory
  - âœ… Generates changelog and release notes
- **Key Rule**: This branch must never contain test configurations. The `/config/collections` directory is automatically removed during the release process.

### `next` Branch (Development)

- **Purpose**: Development and staging. This is the primary branch for all new features, bug fixes, and ongoing work.
- **Pull Requests**: All contributions should be made to feature branches and then submitted as pull requests targeting `next`.
- **Automated Actions**:
  - âœ… Runs full test suite on every push
  - âœ… Tests both dev and preview modes
  - âœ… Matrix testing across multiple browsers
  - âœ… No automatic releases (tests only)
- **Testing Strategy**:
  - Every push triggers comprehensive E2E and unit tests
  - Tests run in both development and production build modes
  - MongoDB service container for database testing
  - Automated database seeding before tests

---

## Commit Message Convention

Our automated release process depends on a strict commit message format. We use the **Conventional Commits** specification. The release automation analyzes these messages to determine if a new version should be released and what the version number should be.

### Format

Each commit message consists of a **type**, a **scope** (optional), and a **subject**:

```
<type>(<scope>): <subject>

[optional body]

[optional footer]
```

### Common Commit Types

| Type              | Description              | Version Impact            | Example                           |
| ----------------- | ------------------------ | ------------------------- | --------------------------------- |
| `feat`            | A new feature            | **MINOR** (1.2.0 â†’ 1.3.0) | `feat(auth): add OAuth2 login`    |
| `fix`             | A bug fix                | **PATCH** (1.2.0 â†’ 1.2.1) | `fix(api): resolve memory leak`   |
| `docs`            | Documentation only       | None                      | `docs: update installation guide` |
| `style`           | Code style changes       | None                      | `style: fix indentation`          |
| `refactor`        | Code refactoring         | None                      | `refactor: simplify auth logic`   |
| `perf`            | Performance improvements | **PATCH**                 | `perf(db): optimize query speed`  |
| `test`            | Adding or updating tests | None                      | `test: add collection tests`      |
| `chore`           | Build/tooling changes    | None                      | `chore: update dependencies`      |
| `ci`              | CI/CD configuration      | None                      | `ci: update GitHub Actions`       |
| `BREAKING CHANGE` | Breaking API change      | **MAJOR** (1.2.0 â†’ 2.0.0) | See below                         |

### Breaking Changes

To trigger a **MAJOR** version release, use one of these methods:

**Method 1: Add `!` after type**

```
feat!: redesign collection API
```

**Method 2: Add `BREAKING CHANGE:` footer**

```
feat(api): redesign collection endpoints

BREAKING CHANGE: The collection API now uses different parameter names
```

> âš ï¸ **IMPORTANT**: If your commit doesn't use `feat`, `fix`, or `BREAKING CHANGE`, the automated system will not create a new version.

---

## GitHub Actions Workflows

SveltyCMS uses two main workflows for CI/CD automation.

### Workflow 1: Playwright Tests

**File**: `.github/workflows/playwright.yml`

**Triggers**:

- Push to `main` or `next`
- Pull requests to `main`
- Called by auto-release workflow

**What it does**:

1. **Unit Tests Job**: Runs Bun unit tests (~350 tests, ~2s)
2. **Integration Tests Job**:
   - Starts MongoDB service container
   - Cleans `config/` directory for fresh state
   - Starts dev server
   - Seeds test database via `scripts/seed-test-db.ts`
   - Runs Bun integration tests (~225 tests, ~15s)
3. **E2E Tests Job**:
   - Starts MongoDB service container
   - Cleans `config/` directory
   - Installs Playwright browsers
   - Starts dev server
   - Seeds test database
   - Runs Playwright E2E tests (~40 tests, ~60s)
   - Uploads test results and artifacts on failure

> [!NOTE]
> **Future Enhancement**: Matrix testing across multiple databases
>
> ```yaml
> strategy:
>   matrix:
>     database: [mongodb, postgresql, mariadb, mysql]
> ```
>
> This will ensure SveltyCMS works with all supported databases via Drizzle ORM.

**Test Matrix**:

```yaml
strategy:
  matrix:
    browser: [chromium, firefox, webkit]
    mode: [dev, preview]
```

### Workflow 2: Auto-Release

**File**: `.github/workflows/auto-release.yaml`

**Triggers**:

- Push to `main` branch only

**What it does**:

1. Runs tests first (calls `playwright.yml`)
2. Only releases if tests pass
3. Cleans `/config/collections` directory
4. Runs semantic-release (version bump, changelog, GitHub release)

**Test Gating**:

```yaml
jobs:
  test:
    # Run all tests
  release:
    needs: test # Only runs if tests pass
    if: success()
```

---

## Automated Testing

SveltyCMS uses a dual-testing strategy combining fast unit tests with comprehensive E2E testing.

### Testing Architecture

#### ðŸ§ª Bun Tests (Unit & Integration)

- **Speed**: âš¡ Lightning fast (<5s for full suite)
- **Purpose**: Business logic, services, widgets, security, API endpoints
- **Location**: `tests/unit/`
- **Run**: `bun test tests/bun`
- **Framework**: Bun Test v1.3.1

#### ðŸŽ­ Playwright Tests (E2E)

- **Speed**: Thorough (30-60s per suite)
- **Purpose**: User flows, UI interactions, cross-browser
- **Location**: `tests/e2e/`
- **Run**: `bun x playwright test`
- **Browsers**: Chromium, Firefox, WebKit

### Current Test Status (November 21, 2025)

- âœ… **403 passing tests** (~65%)
- âŒ **172 failing tests** (Setup Actions integration)
- â­ï¸ **40 skipped tests** (placeholders)
- ðŸ“Š **615 total tests**
- âš¡ **Unit tests**: ~2s | **Integration**: ~15s | **E2E**: ~60s

**Recently Fixed**:

- âœ… `authorization.test.ts` (22 tests) - Fixed mock database adapter
- âœ… `theme.test.ts` (40 tests) - Fixed mockResolve signature
- âœ… `firewall.test.ts` (27 tests) - Fixed logger import
- âœ… `user.test.ts` (Integration) - Fixed auth flow & helpers
- âœ… `collections.test.ts` (Integration) - Fixed dynamic config cleanup
- âœ… `setup.test.ts` (Hooks) - Fixed mocking of `node:fs` & redirects

**Fully Passing Test Suites**:

- âœ… Security (8/8 tests) - XSS detection, HTML sanitization
- âœ… Widget Validation (8/8 tests) - RichText, form validation
- âœ… Cache System (17/17 tests) - Redis, metrics, multi-tenant
- âœ… UI Components (5/5 tests) - Store management
- âœ… Content Utilities (6/6 tests) - Normalization, helpers
- âœ… Server Hooks (89/89 tests) - All middleware hooks passing

**âš ï¸ API Endpoints (Mixed)** - Some integration test failures
**âŒ Setup Actions (0/45 tests)** - Requires fixes

[See full test report](/docs/tests/test-status)

### Running Tests Locally

**Quick feedback (recommended):**

```bash
# Fast unit tests
bun test tests/bun

# Specific test file
bun test tests/unit/services/security-response-service.test.ts
bun test tests/unit/api/user.test.ts

# Specific test suite
bun test tests/unit/api/user.test.ts -t "createUser"
```

**E2E testing:**

```bash
# All E2E tests
bun x playwright test

# Interactive mode
bun x playwright test --ui

# Specific browser
bun x playwright test --project=chromium
```

**Complete test suite:**

```bash
# Bun + Playwright
bun run test:all
```

### Test Infrastructure

**Test Configuration**:

- `bunfig.toml` - Bun test configuration with Svelte preload
- `tests/unit/svelte-loader.js` - Svelte component loader
- `tests/unit/mocks/setup.ts` - Environment mocks (500+ lines)
- `playwright.config.ts` - E2E test configuration

**Test Helpers**:

- `tests/unit/helpers/testSetup.ts` - Fixtures, database cleanup, role resolution
- `tests/unit/helpers/server.ts` - Server wait utility (prevents timeouts)
- `tests/unit/helpers/auth.ts` - Real authentication helpers (FormData support)
- `tests/unit/helpers/db-helper.ts` - API-based verification (no direct DB access)
- `tests/unit/mocks/setup.ts` - Comprehensive environment mocking

**Mocked Services**:

- SvelteKit environment (`$app/environment`)
- Global settings (`publicEnv`, `privateEnv`)
- Svelte 5 runes (`$state`, `$derived`, `$effect`)
- Widget factory with 30+ widgets
- Paraglide i18n messages (100+ translations)
- Setup wizard store
- Skeleton UI components

**CI Integration**:

- Tests run on every push to `main` and `next`
- Release blocked if tests fail
- Matrix testing across 3 browsers Ã— 2 modes = 6 configurations
- MongoDB service container for E2E tests
- Automatic database seeding

---

## Release Process

### Complete Flow

**Development (â†’ `next`)**:

1. **Create feature branch from 'next'**
   ```bash
   git checkout -b feat/my-feature next
   ```
2. **Make changes with conventional commits**
   ```bash
   git commit -m "feat(auth): add OAuth2 support"
   ```
3. **Push and create PR to 'next'**
   ```bash
   git push origin feat/my-feature
   ```
4. **Tests run automatically** (Bun + Playwright)
5. **Merge after approval**
   - Tests must pass
   - PR requires approval
6. **Tests run on 'next'** (no release created)

**Release (â†’ `main`)**:

1. **Create PR from 'next' to 'main'**
   - Ensure all features are stable
   - Review CHANGELOG
2. **Tests run automatically**
   - Full Playwright suite
   - All Bun tests
   - Matrix testing
3. **Merge after approval**
   - Requires maintainer approval
   - All checks must pass
4. **Tests run on 'main'**
   - Complete test suite
   - Database seeding
   - Cross-browser testing
5. **If tests pass**:
   - âœ… semantic-release analyzes commits
   - âœ… Determines version bump
   - âœ… Updates `package.json`
   - âœ… Generates `CHANGELOG.md`
   - âœ… Creates GitHub release
   - âœ… Cleans `/config/collections`
6. **If tests fail**:
   - âŒ No release created
   - âŒ Maintainers notified
   - âŒ Fix required before retry

### Version Determination

Based on commit messages since last release:

| Commits                    | Version Change | Example       |
| -------------------------- | -------------- | ------------- |
| `fix:` only                | **PATCH**      | 1.2.0 â†’ 1.2.1 |
| `feat:` present            | **MINOR**      | 1.2.0 â†’ 1.3.0 |
| `BREAKING CHANGE:` or `!`  | **MAJOR**      | 1.2.0 â†’ 2.0.0 |
| No `feat`/`fix`/`BREAKING` | No release     | -             |

---

## Development Workflow

### Step-by-Step Guide

**1. Start a new feature:**

```bash
# Update local next branch
git checkout next
git pull origin next

# Create feature branch
git checkout -b feat/my-feature

# Or for bug fix
git checkout -b fix/bug-description
```

**2. Make changes:**

```bash
# Write code
# Add tests

# Run tests locally
bun test
bun x playwright test

# Commit with conventional format
git add .
git commit -m "feat(auth): add OAuth2 support"
```

**3. Push and create PR:**

```bash
# Push to remote
git push origin feat/my-feature

# Create PR to 'next' on GitHub
# - Fill in PR template
# - Link related issues
# - Request reviewers
```

**4. Address review comments:**

```bash
# Make changes
git add .
git commit -m "fix(auth): address review comments"

# Push updates
git push origin feat/my-feature
```

**5. Merge and cleanup:**

```bash
# After PR is merged
git checkout next
git pull origin next

# Delete feature branch
git branch -d feat/my-feature
git push origin --delete feat/my-feature
```

---

## Best Practices

### Commit Messages

âœ… **Good Examples**:

- `feat(auth): add OAuth2 support`
- `fix(api): resolve memory leak in user endpoint`
- `docs: update testing guide`
- `test(user): add avatar upload tests`
- `perf(cache): optimize Redis queries`
- `refactor(widget): simplify factory logic`

âŒ **Bad Examples**:

- `fixed stuff`
- `WIP`
- `changes`
- `update`
- `asdf`

### Pull Requests

**Before creating a PR:**

- âœ… Run tests locally (`bun test`)
- âœ… Update relevant documentation
- âœ… Add tests for new features
- âœ… Follow code style guidelines
- âœ… Use conventional commit messages

**PR Guidelines:**

- Keep PRs focused and small (< 500 lines preferred)
- Write clear descriptions
- Link related issues
- Respond to reviews promptly
- Ensure CI passes before requesting review

### Testing

**Test-Driven Development:**

```bash
# 1. Write failing test
bun test tests/unit/api/my-feature.test.ts

# 2. Implement feature
# ... code ...

# 3. Verify test passes
bun test tests/unit/api/my-feature.test.ts

# 4. Run full suite
bun test
```

**Before pushing:**

```bash
# Run all tests
bun test tests/bun

# Run E2E tests for affected features
bun x playwright test tests/my-feature.spec.ts

# Check for linting errors
bun run lint
```

---

## Troubleshooting

### Tests Failing in CI but Passing Locally

**Common causes:**

- **Different Node/Bun versions**
  - _Solution_: Use `.nvmrc` or check CI version
- **Missing environment variables**
  - _Solution_: Check GitHub Secrets configuration
- **Database state issues**
  - _Solution_: Ensure tests clean up properly
- **Timing issues**
  - _Solution_: Use `waitForServer()` helper

### Release Not Created

**Check:**

1. **Did tests pass?**
   - View GitHub Actions logs
2. **Did commits use conventional format?**
   - Must have `feat:`, `fix:`, or `BREAKING CHANGE:`
3. **Are you on `main` branch?**
   - Releases only happen on `main`
4. **Is semantic-release configured?**
   - Check `.releaserc` configuration

---

## Related Documentation

See [Setup Actions API](/docs/api/setup-actions-api.mdx) for complete API reference and status

- [Test Status Report](/docs/tests/test-status) - Current test coverage and status
- [User API Tests](/docs/tests/api/user) - Complete user API test documentation
- [Contributing Guide](/docs/contributing) - How to contribute
- [Troubleshooting](/docs/troubleshooting) - Common issues

Follow these workflows for smooth development and reliable releases! ðŸš€
