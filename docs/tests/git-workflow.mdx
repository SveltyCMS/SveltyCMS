---
path: 'docs/tests/git-workflow.mdx'
title: 'Git Workflow & Automated Testing'
description: 'Complete guide to branching strategy, commit conventions, automated testing, and semantic releases with GitHub Actions.'
order: 3
icon: 'mdi:git'
author: 'admin'
created: '2025-09-28'
updated: '2025-11-08'
tags:
  - 'git'
  - 'workflow'
  - 'testing'
  - 'ci-cd'
  - 'release'
  - 'development'
---

# Git Workflow & Automated Testing

## Introduction

SveltyCMS uses a comprehensive Git workflow with **automated testing** and **semantic versioning** to ensure code quality and streamline the release process. Understanding this workflow is essential for all contributors.

Our CI/CD pipeline uses:

- **Bun Tests** for fast unit & integration testing
- **Playwright** for comprehensive E2E testing
- **Semantic Release** for automated versioning
- **GitHub Actions** for CI/CD automation
- **Test Gating** to ensure releases only happen when tests pass

---

## Table of Contents

1. [Branching Strategy](#branching-strategy)
2. [Commit Message Convention](#commit-message-convention)
3. [GitHub Actions Workflows](#github-actions-workflows)
4. [Automated Testing](#automated-testing)
5. [Release Process](#release-process)
6. [Development Workflow](#development-workflow)
7. [Best Practices](#best-practices)

---

## Branching Strategy

We have two primary, long-lived branches: **main** and **next**.

### `main` Branch (Production)

**Purpose:** Production-ready, stable code. This branch represents the latest official release.

**Protection:**

- Protected branch requiring pull request reviews
- All code must first be merged into `next`
- Promoted to `main` only after thorough testing
- **Tests must pass** before any release is created

**Automated Actions:**

- ‚úÖ Runs full Playwright + Bun test suite
- ‚úÖ Only releases if tests pass
- ‚úÖ Creates stable semantic version (e.g., `v1.3.0`)
- ‚úÖ Automatically cleans `/config/collections` directory
- ‚úÖ Generates changelog and release notes

**Key Rule:** This branch must never contain test configurations. The `/config/collections` directory is automatically removed during the release process.

### `next` Branch (Development)

**Purpose:** Development and staging. This is the primary branch for all new features, bug fixes, and ongoing work.

**Pull Requests:** All contributions should be made to feature branches and then submitted as pull requests targeting `next`.

**Automated Actions:**

- ‚úÖ Runs full test suite on every push
- ‚úÖ Tests both dev and preview modes
- ‚úÖ Matrix testing across multiple browsers
- ‚úÖ No automatic releases (tests only)

**Testing Strategy:**

- Every push triggers comprehensive E2E and unit tests
- Tests run in both development and production build modes
- MongoDB service container for database testing
- Automated database seeding before tests

---

## Commit Message Convention

Our automated release process depends on a strict commit message format. We use the **Conventional Commits** specification. The release automation analyzes these messages to determine if a new version should be released and what the version number should be.

### Format

Each commit message consists of a **type**, a **scope** (optional), and a **subject**:

```
<type>(<scope>): <subject>

[optional body]

[optional footer]
```

### Common Commit Types

| Type              | Description              | Version Impact        | Example                           |
| ----------------- | ------------------------ | --------------------- | --------------------------------- |
| `feat`            | A new feature            | MINOR (1.2.0 ‚Üí 1.3.0) | `feat(auth): add OAuth2 login`    |
| `fix`             | A bug fix                | PATCH (1.2.0 ‚Üí 1.2.1) | `fix(api): resolve memory leak`   |
| `docs`            | Documentation only       | None                  | `docs: update installation guide` |
| `style`           | Code style changes       | None                  | `style: fix indentation`          |
| `refactor`        | Code refactoring         | None                  | `refactor: simplify auth logic`   |
| `perf`            | Performance improvements | PATCH                 | `perf(db): optimize query speed`  |
| `test`            | Adding or updating tests | None                  | `test: add collection tests`      |
| `chore`           | Build/tooling changes    | None                  | `chore: update dependencies`      |
| `ci`              | CI/CD configuration      | None                  | `ci: update GitHub Actions`       |
| `BREAKING CHANGE` | Breaking API change      | MAJOR (1.2.0 ‚Üí 2.0.0) | See below                         |

### Breaking Changes

To trigger a **MAJOR** version release, use one of these methods:

**Method 1: Add `!` after type**

```
feat!: redesign collection API
```

**Method 2: Add `BREAKING CHANGE:` footer**

```
feat(api): redesign collection endpoints

BREAKING CHANGE: The collection API now uses different parameter names
```

**‚ö†Ô∏è IMPORTANT:** If your commit doesn't use `feat`, `fix`, or `BREAKING CHANGE`, the automated system will **not** create a new version.

---

## GitHub Actions Workflows

SveltyCMS uses two main workflows for CI/CD automation.

### Workflow 1: Playwright Tests

**File:** `.github/workflows/playwright.yml`

**Triggers:**

- Push to `main` or `next`
- Pull requests to `main`
- Called by auto-release workflow

**What it does:**

1. Sets up environment (Bun, Node, Playwright)
2. Starts MongoDB service container
3. **Seeds database** (`scripts/seed-cms.js`)
4. **Creates admin user** (`scripts/create-admin.js`)
5. Runs tests in dev and preview modes
6. Uploads test results and artifacts

**Test Matrix:**

```yaml
strategy:
  matrix:
    browser: [chromium, firefox, webkit]
    mode: [dev, preview]
```

### Workflow 2: Auto-Release

**File:** `.github/workflows/auto-release.yaml`

**Triggers:**

- Push to `main` branch only

**What it does:**

1. **Runs tests first** (calls playwright.yml)
2. **Only releases if tests pass**
3. Cleans `/config/collections` directory
4. Runs semantic-release (version bump, changelog, GitHub release)

**Test Gating:**

```yaml
jobs:
  test:
    # Run all tests
  release:
    needs: test # Only runs if tests pass
    if: success()
```

---

## Automated Testing

SveltyCMS uses a **dual-testing strategy** combining fast unit tests with comprehensive E2E testing.

### Testing Architecture

**üß™ Bun Tests** (Unit & Integration)

- **Speed:** ‚ö° Lightning fast (<5s for full suite)
- **Purpose:** Business logic, services, widgets, security, API endpoints
- **Location:** `tests/bun/`
- **Run:** `bun test tests/bun`
- **Framework:** Bun Test v1.3.1

**üé≠ Playwright Tests** (E2E)

- **Speed:** Thorough (30-60s per suite)
- **Purpose:** User flows, UI interactions, cross-browser
- **Location:** `tests/playwright/`
- **Run:** `bun x playwright test`
- **Browsers:** Chromium, Firefox, WebKit

### Current Test Status

```
‚úÖ 97+ passing tests (77%+)
‚ö° ~25s execution time
üéØ 150+ assertions
üìä 8 categories fully tested
```

**Fully Passing Test Suites:**

- ‚úÖ **Security** (8/8 tests) - XSS detection, HTML sanitization
- ‚úÖ **Widget Validation** (8/8 tests) - RichText, form validation
- ‚úÖ **Cache System** (17/17 tests) - Redis, metrics, multi-tenant
- ‚úÖ **UI Components** (5/5 tests) - Store management
- ‚úÖ **Content Utilities** (6/6 tests) - normalization, helpers
- ‚úÖ **User API** (47/47 tests) - Complete endpoint coverage
- ‚ö†Ô∏è **Collection Builder** (4/7 tests) - Partial coverage
- ‚ùå **Other APIs** (0/4 tests) - Needs database setup

**See full test report:** [Test Status](./test-status.mdx)

### Running Tests Locally

**Quick feedback (recommended):**

```bash
# Fast unit tests
bun test tests/bun

# Specific test file
bun test tests/bun/services/SecurityResponseService.test.ts
bun test tests/bun/api/user.test.ts

# Specific test suite
bun test tests/bun/api/user.test.ts -t "createUser"
```

**E2E testing:**

```bash
# All E2E tests
bun x playwright test

# Interactive mode
bun x playwright test --ui

# Specific browser
bun x playwright test --project=chromium
```

**Complete test suite:**

```bash
# Bun + Playwright
bun run test:all
```

### Test Infrastructure

**Test Configuration:**

- `bunfig.toml` - Bun test configuration with Svelte preload
- `tests/bun/svelte-loader.js` - Svelte component loader
- `tests/bun/mocks/setup.ts` - Environment mocks (500+ lines)
- `playwright.config.ts` - E2E test configuration

**Test Helpers:**

- `tests/bun/helpers/testSetup.ts` - Fixtures, database cleanup, role resolution
- `tests/bun/helpers/server.ts` - Server wait utility (prevents timeouts)
- `tests/bun/mocks/setup.ts` - Comprehensive environment mocking

**Mocked Services:**

- SvelteKit environment (`$app/environment`)
- Global settings (publicEnv, privateEnv)
- Svelte 5 runes (`$state`, `$derived`, `$effect`)
- Widget factory with 30+ widgets
- Paraglide i18n messages (100+ translations)
- Setup wizard store
- Skeleton UI components

**CI Integration:**

- Tests run on every push to `main` and `next`
- Release blocked if tests fail
- Matrix testing across 3 browsers √ó 2 modes = 6 configurations
- MongoDB service container for E2E tests
- Automatic database seeding

---

## Release Process

### Complete Flow

**Development (‚Üí `next`):**

```
1. Create feature branch from 'next'
   git checkout -b feat/my-feature next

2. Make changes with conventional commits
   git commit -m "feat(auth): add OAuth2 support"

3. Push and create PR to 'next'
   git push origin feat/my-feature

4. Tests run automatically (Bun + Playwright)

5. Merge after approval
   - Tests must pass
   - PR requires approval

6. Tests run on 'next' (no release created)
```

**Release (‚Üí `main`):**

```
1. Create PR from 'next' to 'main'
   - Ensure all features are stable
   - Review CHANGELOG

2. Tests run automatically
   - Full Playwright suite
   - All Bun tests
   - Matrix testing

3. Merge after approval
   - Requires maintainer approval
   - All checks must pass

4. Tests run on 'main'
   - Complete test suite
   - Database seeding
   - Cross-browser testing

5. If tests pass:
   ‚úÖ semantic-release analyzes commits
   ‚úÖ Determines version bump
   ‚úÖ Updates package.json
   ‚úÖ Generates CHANGELOG.md
   ‚úÖ Creates GitHub release
   ‚úÖ Cleans /config/collections

6. If tests fail:
   ‚ùå No release created
   ‚ùå Maintainers notified
   ‚ùå Fix required before retry
```

### Version Determination

Based on commit messages since last release:

| Commits                    | Version Change | Example       |
| -------------------------- | -------------- | ------------- |
| `fix:` only                | PATCH          | 1.2.0 ‚Üí 1.2.1 |
| `feat:` present            | MINOR          | 1.2.0 ‚Üí 1.3.0 |
| `BREAKING CHANGE:` or `!`  | MAJOR          | 1.2.0 ‚Üí 2.0.0 |
| No `feat`/`fix`/`BREAKING` | No release     | -             |

---

## Development Workflow

### Step-by-Step Guide

**1. Start a new feature:**

```bash
# Update local next branch
git checkout next
git pull origin next

# Create feature branch
git checkout -b feat/my-feature

# Or for bug fix
git checkout -b fix/bug-description
```

**2. Make changes:**

```bash
# Write code
# Add tests

# Run tests locally
bun test
bun x playwright test

# Commit with conventional format
git add .
git commit -m "feat(auth): add OAuth2 support"
```

**3. Push and create PR:**

```bash
# Push to remote
git push origin feat/my-feature

# Create PR to 'next' on GitHub
# - Fill in PR template
# - Link related issues
# - Request reviewers
```

**4. Address review comments:**

```bash
# Make changes
git add .
git commit -m "fix(auth): address review comments"

# Push updates
git push origin feat/my-feature
```

**5. Merge and cleanup:**

```bash
# After PR is merged
git checkout next
git pull origin next

# Delete feature branch
git branch -d feat/my-feature
git push origin --delete feat/my-feature
```

---

## Best Practices

### Commit Messages

**‚úÖ Good Examples:**

```bash
feat(auth): add OAuth2 support
fix(api): resolve memory leak in user endpoint
docs: update testing guide
test(user): add avatar upload tests
perf(cache): optimize Redis queries
refactor(widget): simplify factory logic
```

**‚ùå Bad Examples:**

```bash
fixed stuff
WIP
changes
update
asdf
```

### Pull Requests

**Before creating a PR:**

- ‚úÖ Run tests locally (`bun test`)
- ‚úÖ Update relevant documentation
- ‚úÖ Add tests for new features
- ‚úÖ Follow code style guidelines
- ‚úÖ Use conventional commit messages

**PR Guidelines:**

- Keep PRs focused and small (< 500 lines preferred)
- Write clear descriptions
- Link related issues
- Respond to reviews promptly
- Ensure CI passes before requesting review

### Testing

**Test-Driven Development:**

```bash
# 1. Write failing test
bun test tests/bun/api/my-feature.test.ts

# 2. Implement feature
# ... code ...

# 3. Verify test passes
bun test tests/bun/api/my-feature.test.ts

# 4. Run full suite
bun test
```

**Before pushing:**

```bash
# Run all tests
bun test tests/bun

# Run E2E tests for affected features
bun x playwright test tests/my-feature.spec.ts

# Check for linting errors
bun run lint
```

---

## Troubleshooting

### Tests Failing in CI but Passing Locally

**Common causes:**

1. **Different Node/Bun versions**
   - Solution: Use `.nvmrc` or check CI version

2. **Missing environment variables**
   - Solution: Check GitHub Secrets configuration

3. **Database state issues**
   - Solution: Ensure tests clean up properly

4. **Timing issues**
   - Solution: Use `waitForServer()` helper

### Release Not Created

**Check:**

1. **Did tests pass?**
   - View GitHub Actions logs

2. **Did commits use conventional format?**
   - Must have `feat:`, `fix:`, or `BREAKING CHANGE:`

3. **Are you on `main` branch?**
   - Releases only happen on `main`

4. **Is semantic-release configured?**
   - Check `.releaserc` configuration

---

## Related Documentation

- [Test Status Report](./test-status.mdx) - Current test coverage and status
- [User API Tests](./user-api-tests.mdx) - Complete user API test documentation
- [Contributing Guide](/docs/contributing/contributing-docs.mdx) - How to contribute
- [Troubleshooting](/docs/troubleshooting.mdx) - Common issues

---

**Follow these workflows for smooth development and reliable releases! üöÄ**
