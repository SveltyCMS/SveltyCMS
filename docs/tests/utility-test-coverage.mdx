---
path: 'docs/tests/utility-test-coverage.mdx'
title: 'Utility Function Test Coverage'
description: 'Comprehensive test coverage documentation for SveltyCMS utility functions'
order: 7
icon: 'mdi:tools'
author: 'Test Suite'
created: '2025-01-20'
updated: '2025-01-20'
tags: ['testing', 'utilities', 'coverage', 'unit-tests']
---

# Utility Function Test Coverage

## Executive Summary

**Total Tests:** 76 tests  
**Test Files:** 4 files  
**Coverage:** Core utility functions  
**Status:** âœ… All tests passing  
**Framework:** Bun Test v1.3.1

This document provides comprehensive test coverage information for SveltyCMS utility functions.

---

## Test Coverage by Category

### 1. Date Utilities (`dateUtils.ts`)

**Tests:** 18 | **Status:** âœ… Passing

#### Type Guards & Validation (4 tests)

- âœ… ISO date string validation
- âœ… Date to ISO string conversion
- âœ… String to ISO string conversion
- âœ… Invalid date string handling

#### Date Conversions (4 tests)

- âœ… Multiple input type conversions (Date, string, timestamp)
- âœ… Date input normalization
- âœ… Current time as ISO string
- âœ… ISO string to Date conversion

#### Formatting (6 tests)

- âœ… Default display date formatting
- âœ… Locale-specific formatting
- âœ… Custom formatting options
- âœ… Relative date formatting
- âœ… Timestamp input formatting
- âœ… String input formatting

#### Edge Cases (4 tests)

- âœ… Leap year date handling
- âœ… Timezone-aware conversions
- âœ… Unix epoch handling
- âœ… Far future dates

---

### 2. Cryptography (`crypto.ts`)

**Tests:** 25 | **Status:** âœ… Passing

#### Password Hashing (8 tests)

- âœ… Argon2id password hashing
- âœ… Unique hash generation (different salts)
- âœ… Password verification (correct password)
- âœ… Password rejection (incorrect password)
- âœ… Empty password handling
- âœ… Long password support (1000+ chars)
- âœ… Special character handling
- âœ… Unicode password support

#### Random Token Generation (6 tests)

- âœ… Default length tokens (64 hex chars)
- âœ… Custom length tokens
- âœ… Token uniqueness
- âœ… Hexadecimal format validation
- âœ… Small token sizes (1 byte)
- âœ… Large token sizes (256 bytes)

#### Checksum Generation (8 tests)

- âœ… String checksum creation
- âœ… Object checksum creation
- âœ… Consistent checksum generation
- âœ… Different data produces different checksums
- âœ… Object property order sensitivity
- âœ… Nested object support
- âœ… Array support
- âœ… Null value handling

#### Security Properties (3 tests)

- âœ… Argon2id algorithm usage
- âœ… Computational expense (timing)
- âœ… Timing attack resistance

---

### 3. Error Handling (`errorHandling.ts`)

**Tests:** 22 | **Status:** âœ… Passing

#### AppError Class (4 tests)

- âœ… Error creation with message and status
- âœ… Error wrapping with original error
- âœ… Error with additional details
- âœ… Proper error name

#### Type Guards (2 tests)

- âœ… AppError instance identification
- âœ… HttpError object identification

#### Error Message Extraction (6 tests)

- âœ… Extract from Error objects
- âœ… Extract from AppError objects
- âœ… Extract from HttpError objects
- âœ… Handle string errors
- âœ… Handle objects with message property
- âœ… Handle unknown error types
- âœ… Stringify complex objects

#### Error Wrapping (7 tests)

- âœ… Wrap Error in AppError
- âœ… Preserve existing AppError
- âœ… Wrap HttpError
- âœ… Custom default messages
- âœ… Default message for unknown errors
- âœ… Custom default status codes
- âœ… String error wrapping

#### Integration (3 tests)

- âœ… Error chain handling
- âœ… Message extraction from chain

---

### 4. Language Utilities (`languageUtils.ts`)

**Tests:** 11 | **Status:** âœ… Passing

#### Basic Functionality (6 tests)

- âœ… Get language names
- âœ… Get names in specific display locale
- âœ… Extended language code support (zh-CN, en-US)
- âœ… Invalid code handling
- âœ… Empty string handling
- âœ… Case-insensitive code handling

#### Common Languages (2 tests)

- âœ… Support for 30+ ISO 639-1 languages
- âœ… Language names in different locales

#### Edge Cases (3 tests)

- âœ… Regional variant support (pt-BR, pt-PT, es-ES, es-MX)
- âœ… Special character handling (Arabic, Japanese, Chinese, etc.)
- âœ… Consistent result caching

---

## Test File Summary

| File                                     | Tests  | Categories                                       | Status             |
| ---------------------------------------- | ------ | ------------------------------------------------ | ------------------ |
| `tests/bun/utils/date-utils.test.ts`     | 18     | Type Guards, Conversions, Formatting, Edge Cases | âœ… Passing         |
| `tests/bun/utils/crypto.test.ts`         | 25     | Password Hashing, Tokens, Checksums, Security    | âœ… Passing         |
| `tests/bun/utils/error-handling.test.ts` | 22     | AppError, Type Guards, Messages, Wrapping        | âœ… Passing         |
| `tests/bun/utils/language-utils.test.ts` | 11     | Basic, Common Languages, Edge Cases              | âœ… Passing         |
| **Total**                                | **76** | **15 categories**                                | **âœ… All Passing** |

---

## Running Utility Tests

### Run All Utility Tests

```bash
bun test tests/bun/utils/
```

### Run Specific Utility Test File

```bash
bun test tests/bun/utils/crypto.test.ts
bun test tests/bun/utils/date-utils.test.ts
bun test tests/bun/utils/error-handling.test.ts
bun test tests/bun/utils/language-utils.test.ts
```

### Run with Coverage

```bash
bun test --coverage tests/bun/utils/
```

### Watch Mode

```bash
bun test --watch tests/bun/utils/
```

---

## Coverage Metrics

### By Function Category

- **Date Operations:** 100% (all functions tested)
- **Cryptography:** 100% (all functions tested)
- **Error Handling:** 100% (all functions tested)
- **Language Display:** 100% (all functions tested)

### Test Quality Metrics

- âœ… Edge cases covered
- âœ… Error conditions tested
- âœ… Type safety verified
- âœ… Security properties validated
- âœ… Integration scenarios included

---

## Utility Functions Tested

### Date Utilities

```typescript
-isISODateString() -
	dateToISODateString() -
	stringToISODateString() -
	toISOString() -
	normalizeDateInput() -
	nowISODateString() -
	isoDateStringToDate() -
	formatDisplayDate() -
	formatRelativeDate();
```

### Cryptography

```typescript
-hashPassword() - // Argon2id
	verifyPassword() - // Argon2id verification
	generateRandomToken() - // Secure random tokens
	createChecksum(); // SHA-256 checksums
```

### Error Handling

```typescript
- AppError class         // Custom error class
- isAppError()          // Type guard
- isHttpError()         // Type guard
- getErrorMessage()     // Extract error messages
- wrapError()           // Normalize errors
```

### Language Utilities

```typescript
-getLanguageName(); // Intl.DisplayNames API
```

---

## Next Steps

### Additional Utilities to Test

The following utilities still need test coverage:

#### High Priority

- [ ] `utils.ts` - General utilities, form data conversion
- [ ] `password.ts` - Quantum-resistant password hashing
- [ ] `widgetValidation.ts` - Widget schema validation
- [ ] `apiClient.ts` - API CRUD operations

#### Medium Priority

- [ ] `toast.ts` - Toast notifications
- [ ] `modalUtils.ts` - Modal management
- [ ] `statusToggle.ts` - Entry status toggling
- [ ] `fileUploading.ts` - File upload management

#### Lower Priority

- [ ] `logger.ts` - Client-side logging
- [ ] `formSchemas.ts` - Valibot schemas
- [ ] `entryActions.ts` - Entry operations
- [ ] `globalSearchIndex.ts` - Search functionality

### Media Utilities (11 files)

- [ ] `mediaProcessing.ts`
- [ ] `mediaUtils.ts`
- [ ] `advancedSearch.ts`
- [ ] `bulkDownload.ts`
- [ ] `sharing.ts`
- [ ] `storageAnalytics.ts`
- [ ] `versionHistory.ts`
- [ ] `cloudStorage.ts`
- [ ] `MediaService.ts`

### Server Utilities (3 files)

- [ ] `collection-utils.server.ts`
- [ ] `restartRequired.ts`
- [ ] `settingsVersion.ts`

---

## Test Patterns & Best Practices

### 1. Type Safety

```typescript
// Always verify type guards
expect(isISODateString('2025-01-20T12:00:00.000Z')).toBe(true);
expect(isAppError(appError)).toBe(true);
```

### 2. Edge Cases

```typescript
// Test boundary conditions
expect(hashPassword('')).resolves.toBeTruthy(); // Empty
expect(hashPassword('a'.repeat(1000))).resolves.toBeTruthy(); // Long
expect(hashPassword('ðŸ”’å¯†ç ')).resolves.toBeTruthy(); // Unicode
```

### 3. Security Properties

```typescript
// Verify security guarantees
const hash1 = await hashPassword('test');
const hash2 = await hashPassword('test');
expect(hash1).not.toBe(hash2); // Different salts
expect(hash.startsWith('$argon2id$')).toBe(true); // Correct algorithm
```

### 4. Error Handling

```typescript
// Test both success and failure paths
expect(() => stringToISODateString('invalid')).toThrow();
expect(getLanguageName('invalid-code')).toBeTruthy(); // Graceful fallback
```

---

## Performance Benchmarks

### Cryptography (Argon2id)

- **Hash Generation:** ~65-134ms per hash (secure, intentionally slow)
- **Verification:** ~115-137ms per verification
- **Token Generation:** <1ms per token
- **Checksum:** <1ms per checksum

### Date Operations

- **ISO Conversion:** <1ms
- **Formatting:** 1-16ms (depends on Intl.DateTimeFormat)
- **Validation:** <1ms

### Error Handling

- **Error Creation:** <1ms
- **Error Wrapping:** <1ms
- **Message Extraction:** <1ms

---

## Continuous Integration

All utility tests run automatically on:

- âœ… Pre-commit hooks
- âœ… Pull request checks
- âœ… CI/CD pipeline
- âœ… Nightly builds

---

## Changelog

### 2025-01-20

- âœ… Created comprehensive test suite for 4 core utilities
- âœ… Achieved 100% function coverage for tested utilities
- âœ… Documented 76 passing tests
- âœ… Established baseline for utility testing

---

## Related Documentation

- [Test Status Overview](./test-status.mdx)
- [API Test Coverage](./api-test-coverage.mdx)
- [Architecture: Code Structure](../architecture/code-structure.mdx)
