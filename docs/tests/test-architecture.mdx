---
path: 'docs/tests/test-architecture.mdx'
title: 'SveltyCMS Test Architecture'
description: 'Comprehensive guide to SveltyCMS testing architecture, including test types, user management, lifecycle, and implemented improvements for better test reliability.'
order: 2
icon: 'mdi:test-tube'
author: 'SveltyCMS Team'
created: '2026-01-24'
updated: '2026-01-24'
tags:
  - 'testing'
  - 'architecture'
  - 'test-infrastructure'
  - 'ci-cd'
  - 'rbac'
  - 'fixtures'
---

# SveltyCMS Test Architecture

This document describes how SveltyCMS testing works, including the complete test lifecycle, user management, test isolation strategy, and the improvements implemented to enhance test reliability.

**Last Updated:** January 24, 2026  
**Author:** SveltyCMS Team

---

## Table of Contents

1. [Test Types](#test-types)
2. [Test User Management](#test-user-management)
3. [Test Lifecycle](#test-lifecycle)
4. [GitHub Actions Workflow](#github-actions-workflow)
5. [Configuration Isolation](#configuration-isolation)
6. [Comparison with Existing Documentation](#comparison-with-existing-documentation)
7. [Suggested Improvements](#suggested-improvements)

---

## Test Types

SveltyCMS uses a multi-layered testing approach:

### 1. Unit Tests (‚ö° Fast)
- **Framework:** Bun Test
- **Location:** `tests/bun/services`, `tests/bun/utils`, `tests/bun/stores`, `tests/bun/widgets`
- **Count:** ~222 tests
- **Duration:** ~2-5 seconds
- **Dependencies:** None (no server, no database)
- **Purpose:** Test individual functions, services, and utilities in isolation

**Example:**
```bash
bun run test:unit
```

### 2. Integration Tests (üîå Medium)
- **Framework:** Bun Test
- **Location:** `tests/bun/api`, `tests/bun/databases`, `tests/bun/hooks`
- **Count:** ~50+ tests
- **Duration:** ~15-30 seconds
- **Dependencies:** Running server (port 4173), Database (MongoDB/MariaDB)
- **Purpose:** Test API endpoints, database operations, and middleware hooks

**Example:**
```bash
bun run test:integration
```

### 3. End-to-End Tests (üé≠ Slow)
- **Framework:** Playwright
- **Location:** `tests/playwright`
- **Count:** ~10+ tests
- **Duration:** ~2-3 minutes
- **Dependencies:** Running server (port 4173), Database, Browser (Chromium)
- **Purpose:** Test complete user workflows and UI interactions

**Example:**
```bash
bun run test:e2e
```

---

## Test User Management

### Default Users

SveltyCMS creates different users for different test scenarios:

| User | Email | Password | Role | Created By | Purpose |
|------|-------|----------|------|------------|---------|
| **Admin** | `admin@example.com` | `Admin123!` | `admin` | Setup Wizard | Full system access, created during initial setup |
| **Developer** | `developer@example.com` | `Developer123!` | `developer` | Seed Script | API + config access, no user management |
| **Editor** | `editor@example.com` | `Editor123!` | `editor` | Seed Script | Content management only, no settings |

### User Creation Flow

#### 1. Admin User (Setup Wizard)
The admin user is created by the **Setup Wizard** during the first test run:

```typescript
// tests/playwright/setup-wizard.spec.ts
await page.locator('#admin-username').fill('admin');
await page.locator('#admin-email').fill('admin@example.com');
await page.locator('#admin-password').fill('Admin123!');
```

This creates:
- The first user in the system
- Database tables and initial schema
- System configuration file (`config/private.ts`)

#### 2. Developer & Editor Users (Seed Script)
Additional test users are created by the **seed script** after setup completes:

```typescript
// tests/bun/helpers/auth.ts
export async function createTestUsers(): Promise<void> {
  const users = [
    testFixtures.users.admin,      // Admin (may already exist)
    testFixtures.users.developer,  // Developer user
    testFixtures.users.editor      // Editor user
  ];
  
  // Create each user via API
  for (const user of users) {
    await fetch(`${BASE_URL}/api/user/createUser`, {
      method: 'POST',
      body: JSON.stringify({
        email: user.email,
        password: user.password,
        role: user.role,
        username: user.username
      })
    });
  }
}
```

The seed script is called in GitHub Actions:
```yaml
- name: üë• Seed Test Users
  run: bun run scripts/seed-test-db.ts
  env:
    API_BASE_URL: 'http://localhost:4173'
```

### Test Fixtures

All test user credentials are centralized in `tests/bun/helpers/testSetup.ts`:

```typescript
export const testFixtures = {
  users: {
    admin: {
      username: 'admin',
      email: 'admin@example.com',
      password: 'Admin123!',
      role: 'admin'
    },
    developer: {
      username: 'developer',
      email: 'developer@example.com',
      password: 'Developer123!',
      role: 'developer'
    },
    editor: {
      username: 'editor',
      email: 'editor@example.com',
      password: 'Editor123!',
      role: 'editor'
    }
  }
};
```

---

## Test Lifecycle

### Local Development

1. **Fresh Install** (First Run)
   ```bash
   # 1. Clean state
   rm -rf config/private.ts config/collections
   
   # 2. Start server
   bun run dev
   
   # 3. Run setup wizard test
   bunx playwright test tests/playwright/setup-wizard.spec.ts
   
   # 4. Seed additional users
   bun run scripts/seed-test-db.ts
   
   # 5. Run full test suite
   bunx playwright test
   ```

2. **Subsequent Runs** (System Already Configured)
   ```bash
   # Server already configured, just run tests
   bun run test:e2e
   ```

### GitHub Actions (CI/CD)

The CI workflow follows this sequence:

```mermaid
graph TD
    A[Start] --> B[Clean Config]
    B --> C[Build Production]
    C --> D[Start Preview Server]
    D --> E[Run Setup Wizard Test]
    E --> F[Wait for Seeding]
    F --> G[Seed Test Users]
    G --> H[Run RBAC Tests]
    H --> I[Run Main E2E Suite]
    I --> J[End]
```

#### Detailed Workflow Steps

1. **Clean Config**
   ```yaml
   - name: Clean config
     run: |
       rm -rf config/collections
       rm -f config/private.ts
   ```
   Ensures fresh install state

2. **Build Production**
   ```yaml
   - name: Build Production
     run: bun run build
   ```
   Creates optimized production build

3. **Start Preview Server**
   ```yaml
   - name: Start Preview Server
     run: |
       nohup bun run preview > preview-e2e.log 2>&1 &
       bun x wait-on http://localhost:4173
   ```
   Starts server in background

4. **Run Setup Wizard Test**
   ```yaml
   - name: üßô‚Äç‚ôÇÔ∏è Run Setup Wizard Test (Seeds DB)
     run: bunx playwright test tests/playwright/setup-wizard.spec.ts
   ```
   - Creates database connection
   - Creates admin user
   - Seeds initial data

5. **Wait for Seeding**
   ```yaml
   - name: ‚è≥ Wait for Seeding
     run: |
       for i in {1..30}; do
         STATUS=$(curl -s http://localhost:4173/api/setup/status)
         IS_SEEDING=$(echo $STATUS | jq -r '.isSeeding // true')
         if [ "$IS_SEEDING" = "false" ]; then
           break
         fi
         sleep 2
       done
   ```
   Waits for async seeding to complete

6. **Seed Test Users**
   ```yaml
   - name: üë• Seed Test Users
     run: bun run scripts/seed-test-db.ts
   ```
   Creates developer and editor users

7. **Run RBAC Tests**
   ```yaml
   - name: üîê Run RBAC Tests
     run: bunx playwright test tests/playwright/role-based-access.spec.ts
   ```
   Tests role-based permissions

8. **Run Main E2E Suite**
   ```yaml
   - name: üß™ Run Main E2E Suite
     run: bunx playwright test --grep-invert "setup-wizard|role-based"
   ```
   Runs remaining E2E tests

---

## Configuration Isolation

### Production vs Test Configuration

SveltyCMS uses different configuration files for production and testing:

| Environment | Config File | Purpose | Safety |
|-------------|-------------|---------|--------|
| **Production** | `config/private.ts` | Real database connection | Never touched by tests |
| **Test** | `config/private.test.ts` | Test database connection | Auto-generated, disposable |

### Vite Alias Resolution

The system uses a Vite alias to automatically load the correct config:

```typescript
// vite.config.ts
resolve: {
  alias: {
    '@config/private': process.env.TEST_MODE === 'true'
      ? path.resolve(__dirname, 'config/private.test.ts')
      : path.resolve(__dirname, 'config/private.ts')
  }
}
```

### Environment Variables

| Variable | Purpose | Example |
|----------|---------|---------|
| `TEST_MODE` | Enables test mode | `true` |
| `API_BASE_URL` | Server URL for tests | `http://localhost:4173` |
| `DB_TYPE` | Database type | `mongodb`, `mariadb` |
| `DB_HOST` | Database host | `localhost` |
| `DB_PORT` | Database port | `27017`, `3306` |
| `DB_NAME` | Database name | `sveltycms_test` |
| `DB_USER` | Database user | `admin`, `testuser` |
| `DB_PASSWORD` | Database password | `admin`, `testpass` |

### Safety Mechanisms

1. **Test Mode Check**
   ```typescript
   if (process.env.TEST_MODE !== 'true') {
     throw new Error('Cannot run tests without TEST_MODE=true');
   }
   ```

2. **Database Name Check**
   ```typescript
   if (!dbName.includes('test')) {
     throw new Error('Database name must contain "test"');
   }
   ```

3. **Auto-cleanup**
   ```typescript
   // Clean up after tests
   await cleanupTestDatabase();
   await fs.unlink('config/private.ts');
   await fs.unlink('config/private.test.ts');
   ```

---

## Comparison with Existing Documentation

### What's Already Documented

The existing documentation (`docs/testing.mdx`, `docs/tests/index.mdx`) covers:

‚úÖ **Test Types** - Unit, Integration, E2E  
‚úÖ **Test Frameworks** - Bun, Playwright  
‚úÖ **Running Tests** - Commands and scripts  
‚úÖ **Test Coverage** - Current status and counts  
‚úÖ **Best Practices** - Writing and organizing tests  
‚úÖ **Troubleshooting** - Common issues and fixes  

### What Was Missing (Now Added)

This document adds critical information that was missing:

üÜï **Test User Management** - How admin, developer, and editor users are created  
üÜï **Test Lifecycle** - Step-by-step flow from fresh install to test execution  
üÜï **GitHub Actions Workflow** - Detailed CI/CD test orchestration  
üÜï **Configuration Isolation** - How test config is separated from production  
üÜï **User Creation Flow** - Diagram and explanation of when each user is created  

### Relationship to Other Docs

- **`docs/testing.mdx`** - High-level overview, should link to this document
- **`docs/tests/index.mdx`** - Test catalog, should reference this for architecture
- **`docs/tests/e2e-testing-guide.mdx`** - Playwright-specific, complements this doc
- **`docs/tests/test-status.mdx`** - Current status, separate concern

---

## Implemented Improvements

The following improvements have been implemented to enhance test reliability and maintainability:

### 1. Improve Test User Creation ‚è≥ Partially Implemented

**Status:** Partially implemented (user verification added)

**Issue:** Test users are created in a separate seed script that runs after setup wizard, which can cause race conditions.

**Implemented Solution:**
- ‚úÖ Added user verification step in CI workflow to fail fast if users don't exist
- ‚úÖ Verification checks that developer and editor users can login before RBAC tests run

**Future Enhancement:** Create a unified seeding approach with `completeTestSetup()` function.

### 2. Add Test User Verification ‚úÖ Implemented

**Status:** ‚úÖ Fully implemented

**Solution:** Added verification step in GitHub Actions before running RBAC tests.

**Implementation:**
```yaml
- name: ‚úÖ Verify Test Users
  run: |
    echo "Verifying developer user..."
    curl -f http://localhost:4173/api/user/login \
      -X POST \
      -H "Content-Type: application/json" \
      -d '{"email":"developer@example.com","password":"Developer123!"}' \
      || (echo "‚ùå Developer user login failed!" && exit 1)
    
    echo "‚úÖ Developer user verified"
```

**Files Changed:**
- `.github/workflows/ci.yml` - Added verification steps for MongoDB and MariaDB E2E tests

### 3. Improve Configuration Management ‚è≥ Partially Implemented

**Status:** Partially implemented (DB_TYPE environment variable)

**Issue:** Multiple config files can get out of sync.

**Implemented Solution:**
- ‚úÖ Using `DB_TYPE` environment variable to skip MongoDB cleanup for other databases
- ‚úÖ Added safety check in `cleanupTestDatabase()` function

**Future Enhancement:** Migrate to environment variables exclusively for test configuration.

### 4. Add Test Data Fixtures ‚úÖ Implemented

**Status:** ‚úÖ Fully implemented

**Solution:** Created reusable test data fixtures with centralized user definitions.

**Implementation:**
```typescript
// tests/fixtures/users.ts
export const testUsers = {
  admin: {
    username: 'admin',
    email: 'admin@example.com',
    password: 'Admin123!',
    confirmPassword: 'Admin123!',
    role: 'admin'
  },
  developer: {
    username: 'developer',
    email: 'developer@example.com',
    password: 'Developer123!',
    confirmPassword: 'Developer123!',
    role: 'developer'
  },
  editor: {
    username: 'editor',
    email: 'editor@example.com',
    password: 'Editor123!',
    confirmPassword: 'Editor123!',
    role: 'editor'
  }
};
```

**Files Created:**
- `tests/fixtures/users.ts` - Centralized test user fixtures with helper functions

**Files Updated:**
- `tests/bun/helpers/testSetup.ts` - Migrated to use centralized fixtures

### 5. Add Signed-Out User Tests ‚úÖ Implemented

**Status:** ‚úÖ Fully implemented

**Solution:** Created comprehensive test suite for unauthenticated (signed-out) user access.

**Implementation:**
```typescript
// tests/playwright/public-access.spec.ts
test.describe('Signed Out User Access', () => {
  test('should redirect to login when accessing dashboard', async ({ page }) => {
    await page.goto('/dashboard');
    await expect(page).toHaveURL(/\/login/);
  });
  
  test('should block access to protected API endpoints', async ({ page }) => {
    const response = await page.request.get('/api/user/profile');
    expect(response.status()).toBe(401);
  });
});
```

**Files Created:**
- `tests/playwright/public-access.spec.ts` - 7 test scenarios for public access

**Test Coverage:**
- Dashboard access (redirects to login)
- Config pages access (redirects to login)
- User management access (redirects to login)
- Login page access (allowed)
- Protected API endpoints (returns 401)
- Collections API (returns 401)
- Health check endpoint (accessible)

### 6. Add Role Permission Matrix ‚úÖ Implemented

**Status:** ‚úÖ Fully implemented

**Solution:** Created a central permission matrix defining role-based access to routes and APIs.

**Implementation:**
```typescript
// src/databases/auth/permissionMatrix.ts
export const routePermissions: Record<string, Role[]> = {
  '/config/systemsetting': ['admin', 'developer'],
  '/config/user': ['admin'],
  '/config/accessManagement': ['admin'],
  '/collection': ['admin', 'developer', 'editor'],
  '/api/collections': ['admin', 'developer', 'editor']
};

export function hasRoutePermission(route: string, role: Role): boolean {
  const allowedRoles = routePermissions[route];
  if (!allowedRoles) return role === 'admin';
  return allowedRoles.includes(role);
}
```

**Files Created:**
- `src/databases/auth/permissionMatrix.ts` - Central permission matrix with helper functions

**Features:**
- Route-based permissions
- API endpoint permissions
- Wildcard pattern matching
- Helper functions: `hasRoutePermission()`, `hasApiPermission()`, `getRoutesForRole()`, `getApisForRole()`

### 7. Improve Test Isolation ‚úÖ Implemented

**Status:** ‚úÖ Fully implemented

**Solution:** Created test isolation utilities to ensure tests don't interfere with each other.

**Implementation:**
```typescript
// tests/playwright/helpers/isolation.ts
export async function cleanupBrowserState(page: Page): Promise<void> {
  // Clear cookies
  await page.context().clearCookies();
  
  // Clear localStorage and sessionStorage
  await page.evaluate(() => {
    localStorage.clear();
    sessionStorage.clear();
  });
  
  // Clear service worker caches
  await page.evaluate(() => {
    if ('caches' in window) {
      caches.keys().then((names) => {
        names.forEach((name) => caches.delete(name));
      });
    }
  });
}
```

**Files Created:**
- `tests/playwright/helpers/isolation.ts` - Browser state cleanup utilities

**Usage:**
```typescript
test.beforeEach(async ({ page }) => {
  await cleanupBrowserState(page);
});
```

### 8. Add Performance Benchmarks ‚úÖ Implemented

**Status:** ‚úÖ Fully implemented

**Solution:** Created performance benchmark tests for API endpoints.

**Implementation:**
```typescript
// tests/performance/api-benchmarks.test.ts
test('GET /api/systemInfo should respond within 100ms', async () => {
  const start = Date.now();
  const response = await fetch(`${API_BASE_URL}/api/systemInfo`, {
    headers: adminCookie ? { Cookie: adminCookie } : {}
  });
  const duration = Date.now() - start;
  
  expect(response.ok).toBe(true);
  expect(duration).toBeLessThan(100);
});
```

**Files Created:**
- `tests/performance/api-benchmarks.test.ts` - API performance benchmarks

**Benchmarks:**
- `/api/systemInfo` - should respond within 100ms
- `/api/collections` - should respond within 500ms
- `/api/user/login` - should respond within 500ms
- `/health` - should respond within 50ms
- Collection list query - should respond within 300ms

**Benefits:**
- Detect performance regressions in PRs
- Track performance trends over time
- Ensure SLA compliance

---

## Summary of Improvements

| # | Improvement | Status | Files Created | Files Modified |
|---|-------------|--------|---------------|----------------|
| 1 | Test User Creation | ‚è≥ Partial | - | `.github/workflows/ci.yml` |
| 2 | Test User Verification | ‚úÖ Full | - | `.github/workflows/ci.yml` |
| 3 | Configuration Management | ‚è≥ Partial | - | `tests/bun/helpers/testSetup.ts` |
| 4 | Test Data Fixtures | ‚úÖ Full | `tests/fixtures/users.ts` | `tests/bun/helpers/testSetup.ts` |
| 5 | Signed-Out User Tests | ‚úÖ Full | `tests/playwright/public-access.spec.ts` | - |
| 6 | Permission Matrix | ‚úÖ Full | `src/databases/auth/permissionMatrix.ts` | - |
| 7 | Test Isolation | ‚úÖ Full | `tests/playwright/helpers/isolation.ts` | - |
| 8 | Performance Benchmarks | ‚úÖ Full | `tests/performance/api-benchmarks.test.ts` | - |

**Total:** 6 fully implemented, 2 partially implemented

---

## Test Strategy Summary

### For Fresh Install Testing

1. ‚úÖ **Start with clean state** - Remove all config files
2. ‚úÖ **Run setup wizard** - Create admin user and database connection
3. ‚úÖ **Seed additional users** - Create developer and editor users
4. ‚úÖ **Run tests** - Execute full test suite

### For Signed-Out User Testing

1. üÜï **Test public endpoints** - Ensure they're accessible
2. üÜï **Test protected endpoints** - Ensure they return 401
3. üÜï **Test login flow** - Ensure users can sign in
4. üÜï **Test redirects** - Ensure unauthorized access redirects to login

### For Signed-In Admin Testing

1. ‚úÖ **Test full system access** - Admin can access everything
2. ‚úÖ **Test user management** - Admin can create/edit/delete users
3. ‚úÖ **Test system settings** - Admin can modify configuration
4. ‚úÖ **Test API access** - Admin can use all API endpoints

### For Signed-In Developer/Editor Testing

1. ‚úÖ **Test permitted access** - Users can access allowed routes
2. ‚úÖ **Test forbidden access** - Users are blocked from restricted routes
3. ‚úÖ **Test API permissions** - Users can only access permitted endpoints
4. ‚úÖ **Test role-specific features** - Each role has appropriate capabilities

---

## Conclusion

SveltyCMS uses a comprehensive testing strategy that balances speed, reliability, and comprehensive coverage. The test architecture is designed to:

- ‚úÖ **Isolate test data** from production data
- ‚úÖ **Support multiple databases** (MongoDB, MariaDB, PostgreSQL, MySQL)
- ‚úÖ **Test role-based permissions** (Admin, Developer, Editor)
- ‚úÖ **Run efficiently in CI/CD** (GitHub Actions)
- ‚úÖ **Enable fast local development** (Unit tests in ~2 seconds)

By following this architecture and implementing the suggested improvements, we can ensure SveltyCMS remains reliable, secure, and maintainable.
