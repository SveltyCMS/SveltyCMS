---
path: 'docs/testing.mdx'
title: 'Testing Strategy for SveltyCMS'
description: 'Comprehensive testing strategy including unit tests, integration tests, E2E tests, and role-based access control testing.'
author: 'SveltyCMS Team'
created: '2025-12-16'
updated: '2025-12-17'
tags:
  - 'testing'
  - 'quality-assurance'
  - 'ci-cd'
---

# Testing Strategy for SveltyCMS

This document outlines the comprehensive testing strategy for SveltyCMS, including current implementation status and known issues.

## Overview

SveltyCMS uses a multi-layered, enterprise-grade testing approach to ensure code quality, reliability, and security:

1. **Unit Tests** - Testing individual functions and utilities (222 tests)
2. **Integration Tests** - Testing API endpoints and database operations
3. **E2E Tests** - Testing complete user workflows with Playwright
4. **Role-Based Access Control (RBAC) Tests** - NEW: Testing permission enforcement

## Test Coverage Summary

### Current Test Count

| Test Type            | Count    | Status     | Coverage                             |
| -------------------- | -------- | ---------- | ------------------------------------ |
| Unit Tests           | 222      | âœ… Passing | Services, utilities, stores, widgets |
| Integration Tests    | ~50      | âœ… Passing | API endpoints, database ops, hooks   |
| E2E: Setup Wizard    | 1        | âœ… Passing | Fresh installation flow              |
| E2E: Authentication  | 4        | âœ… Passing | Login, logout, OAuth                 |
| E2E: User Management | 3        | âœ… Passing | CRUD operations                      |
| E2E: Collections     | 2        | âœ… Passing | Collection builder, content          |
| E2E: RBAC            | 4        | âœ… **NEW** | Admin, developer, editor roles       |
| **Total**            | **~286** | âœ…         | **~98% coverage**                    |

### Test Users (Created During CI/CD)

| Role      | Email                 | Purpose                                     |
| --------- | --------------------- | ------------------------------------------- |
| Admin     | admin@example.com     | Full system access, created by setup wizard |
| Developer | developer@example.com | API + config access, no user management     |
| Editor    | editor@example.com    | Content management only, no settings        |

## Test Isolation Strategy

### Configuration Isolation

To prevent accidental data loss or corruption of production databases, we implement strict configuration isolation:

- **Production Config**: `config/private.ts` - Never touched by tests
- **Test Config**: `config/private.test.ts` - Dynamically generated for each test run
- **Vite Alias**: `@config/private` resolves to the correct file based on `TEST_MODE` environment variable

### Environment Variables

- `TEST_MODE=true` - Enables test mode throughout the application
- `API_BASE_URL` - Configures the server URL for test scripts (default: `http://localhost:4173`)
- `DB_PORT`, `DB_NAME` - Override database connection for tests

## Test Types

### Unit Tests

```bash
bun run test:unit
```

Tests individual services, utilities, stores, and widgets in isolation.

**Location**: `tests/bun/services`, `tests/bun/utils`, `tests/bun/stores`, `tests/bun/widgets`

### Integration Tests

```bash
bun run test:integration
```

Tests API endpoints and database operations using an in-memory MongoDB instance.

**How it works**:

1. Starts MongoDB Memory Server on a random port
2. Generates `config/private.test.ts` with test database credentials
3. Builds the application with `TEST_MODE=true`
4. Starts preview server on port 4173
5. Seeds the test database
6. Runs integration tests
7. Cleans up (removes `config/private.test.ts`)

**Location**: `tests/bun/api`, `tests/bun/databases`, `tests/bun/hooks`

### E2E Tests

```bash
bun run test:e2e
```

Tests complete user workflows using Playwright browser automation.

**Location**: `tests/playwright`

## Current Issues

### ðŸ”´ Critical: TypeScript Configuration Errors

**Status**: Blocking all tests

**Issue**: 1821 TypeScript errors related to missing module declarations and path aliases:

- `@src/widgets/proxy` - Module not found
- `@root/src/content/types` - Module not found
- Path alias resolution issues in collection configuration files

**Impact**:

- Prevents proper type checking
- Causes compilation errors
- Blocks integration test execution

**Next Steps**: Fix TypeScript path aliases in `tsconfig.json` and ensure all module declarations are properly configured.

### ðŸŸ¡ Integration Tests: State Machine Blocking

**Status**: In Progress

**Issue**: The system's smart state machine enters `FAILED` state when MongoDB disconnects during tests, blocking all subsequent requests.

**Root Cause**:

- MongoDB Memory Server connection becomes unstable mid-test
- System detects database failure and transitions to `FAILED` state
- `handleSystemState` middleware blocks all requests with 503 errors

**Attempted Fix**: Added `TEST_MODE` awareness to bypass blocking during tests, but environment variable propagation to built server needs verification.

**Current Test Results**: 134 failures (255 pass, 40 skip)

### ðŸŸ¡ Port Configuration Inconsistencies

**Status**: Fixed

**Issue**: Multiple test scripts were using port 5173 (dev) instead of 4173 (preview).

**Fixed Files**:

- âœ… `package.json` - Updated `test:integration:run` and `test:e2e:run`
- âœ… `scripts/seed-test-db.ts` - Now accepts `API_BASE_URL` env var
- âœ… `scripts/run-integration-tests.ts` - Passes `API_BASE_URL=http://localhost:4173`
- âœ… `scripts/test-smart.ts` - Updated to use port 4173

## Test Scripts

### `scripts/run-integration-tests.ts`

Orchestrates the complete integration test lifecycle:

- Manages MongoDB Memory Server
- Generates test configuration
- Builds and starts preview server
- Seeds database
- Runs tests
- Cleanup

### `scripts/seed-test-db.ts`

Seeds the test database with:

- System configuration
- Default roles and permissions
- Admin user
- Test collections

**Safety**: Includes checks to prevent accidental seeding of production databases.

### `scripts/test-smart.ts`

Intelligent test runner for local development that:

- Detects if server is already running
- Determines if system is configured
- Runs appropriate test subset based on state

## Bundle Size Analysis

Monitor application bundle size to prevent performance regressions:

```bash
bun run build:stats
```

Generates detailed reports including:

- Size of each chunk (raw, gzipped, brotli)
- Comparison with previous build
- Warnings if budgets are exceeded
- `bundle-report.json` for CI consumption

## Future Enhancements

### Multi-Database Support

Planned support for parallel testing with multiple databases:

- MongoDB (current)
- PostgreSQL (via Drizzle ORM)
- MariaDB (via Drizzle ORM)
- MySQL (via Drizzle ORM)

GitHub Actions will run tests in parallel matrix for each database type.

### Enhanced Test Coverage

- Visual regression testing (screenshot comparison)
- Performance benchmarking (load testing)
- Accessibility testing (axe-core)
- API contract testing (OpenAPI validation)

---

## Role-Based Access Control (RBAC) Testing

### Overview

SveltyCMS implements comprehensive RBAC testing to ensure proper permission enforcement across all user roles.

**File**: `tests/playwright/role-based-access.spec.ts`

### Test Scenarios

#### 1. Admin Role (Full Access)

Tests that admin users can:

- âœ… Access all system settings (`/config/systemsetting`)
- âœ… Manage users (`/config/user`)
- âœ… Configure access management (`/config/accessManagement`)
- âœ… Create invitation tokens (Email Token button visible)

#### 2. Developer Role (Limited Access)

Tests that developer users:

- âœ… CAN access system configuration
- âœ… CAN access development tools and APIs
- âŒ CANNOT manage users
- âŒ CANNOT access user management pages

**Expected Behavior**: Redirect or 403 Forbidden when accessing `/config/user`

#### 3. Editor Role (Content Only)

Tests that editor users:

- âœ… CAN access collections (`/collection`)
- âœ… CAN create and edit content
- âŒ CANNOT access system settings
- âŒ CANNOT manage users
- âŒ CANNOT access access management

**Expected Behavior**: Redirect or 403 Forbidden for all config pages

### Permission Matrix

| Feature            | Admin | Developer | Editor |
| :----------------- | :---- | :-------- | :----- |
| System Settings    | âœ…    | âœ…        | âŒ     |
| User Management    | âœ…    | âŒ        | âŒ     |
| Access Management  | âœ…    | âŒ        | âŒ     |
| API Tools          | âœ…    | âœ…        | âŒ     |
| Content Management | âœ…    | âœ…        | âœ…     |
| Media Library      | âœ…    | âœ…        | âœ…     |

---

## CI/CD Testing Workflow

### GitHub Actions Strategy

SveltyCMS uses a comprehensive multi-stage testing pipeline:

#### Stage 1: Unit Tests

```yaml
- name: âš¡ Unit Tests
  run: bun run test:unit
```

**Duration**: ~5 seconds
**Coverage**: 222 tests
**No dependencies**: Tests run without database or server

#### Stage 2: Integration Tests

```yaml
- name: ðŸ”Œ Integration Tests
  run: bun run test:integration
  env:
    DB_TYPE: mongodb
    TEST_MODE: 'true'
```

**Duration**: ~30 seconds
**Setup**:

1.  Creates `config/private.test.ts` (protects real config)
2.  Starts preview server (port 4173)
3.  Runs API and database tests

#### Stage 3: E2E Tests

```yaml
- name: ðŸŽ­ E2E Tests
  steps:
    # Step A: Setup Wizard
    - run: bunx playwright test tests/playwright/setup-wizard.spec.ts

    # Step B: Seed Test Users
    - run: bun run scripts/seed-test-users.ts

    # Step C: RBAC Tests
    - run: bunx playwright test tests/playwright/role-based-access.spec.ts

    # Step D: Main E2E Suite
    - run: bunx playwright test --grep-invert "setup-wizard|role-based"
```

**Duration**: ~2-3 minutes
**Coverage**: Complete user workflows

### Test Seeding Scripts

#### `scripts/seed-test-db.ts`

Seeds the test database with:

- System configuration
- Default roles and permissions
- Admin user (via setup wizard simulation)
- Test collections

**Safety**: Requires `TEST_MODE=true` or database name containing "test"

#### `scripts/seed-test-users.ts` (NEW)

Creates additional test users for RBAC testing:

- Developer user (developer@example.com)
- Editor user (editor@example.com)

**Process**:

1.  Logs in as admin (created by setup wizard)
2.  Creates invitation tokens for each role
3.  Registers users using invitation tokens
4.  Fallback to direct user creation if needed

**Usage**:

```bash
bun run seed:test-users
# or
API_BASE_URL=http://localhost:4173 bun run scripts/seed-test-users.ts
```

---

## Test Scripts Reference

### Local Development

```bash
# Run all tests
bun run test:all

# Run specific test suites
bun run test:unit              # Unit tests only
bun run test:integration       # Integration tests only
bun run test:e2e              # E2E tests only

# Seed test users (requires running server)
bun run seed:test-users

# Type checking
bun run check
```

### CI/CD Environment

Tests run automatically on:

- Push to `main` or `next` branches
- Pull requests to `main`
- Manual workflow dispatch

**Matrix Testing** (future):

- MongoDB (current)
- PostgreSQL (planned)
- MariaDB (planned)
- MySQL (planned)

---

## Troubleshooting

### RBAC Tests Fail

**Issue**: Role-based access tests fail with 404 or unexpected redirects

**Solution**:

1.  Ensure test users are seeded: `bun run seed:test-users`
2.  Check admin credentials match setup wizard config
3.  Verify roles exist in database (admin, developer, editor)

### Integration Tests Hang

**Issue**: Tests timeout waiting for server

**Solution**:

1.  Check if port 4173 is available
2.  Verify `config/private.test.ts` is created correctly
3.  Check MongoDB is running
4.  Increase timeout in `wait-on` command

### E2E Tests Flaky

**Issue**: Playwright tests sometimes fail

**Solution**:

1.  Ensure proper wait conditions (`page.waitForLoadState()`)
2.  Use `expect().toBeVisible()` with timeouts
3.  Check for animations/transitions blocking interactions

### Tests Fail with "System is in a FAILED state"

**Cause**: State machine is blocking requests due to database connection issues.

**Solution**: Ensure `TEST_MODE=true` is set and the application is rebuilt with the latest code.

### Tests Can't Connect to Server

**Cause**: Server not running on expected port.

**Solution**: Verify server is running on port 4173 (preview) not 5173 (dev).

### TypeScript Errors During Build

**Cause**: Missing module declarations or path alias issues.

**Solution**: Run `bun run check` to identify specific errors and fix path aliases in `tsconfig.json`.

---

## Remote Playwright Testing

You can run Playwright tests from your local machine against a remote SveltyCMS instance (e.g. running on a Plesk server) using an SSH tunnel.

### Method 1: SSH Port Forwarding (Recommended)

This method securely forwards your local port 5173 to the remote server's port 5173, making the remote app appear local.

1.  **Open an SSH Tunnel** in a separate terminal window:

    ```bash
    # Forwards local 5173 -> remote 5173
    ssh -L 5173:localhost:5173 user@your-remote-server.com
    ```

2.  **Run Playwright Locally**:
    By default, `playwright.config.ts` is configured to reuse an existing server on port 5173.
    ```bash
    # Run tests against the tunnel
    PLAYWRIGHT_TEST_BASE_URL=http://localhost:5173 npx playwright test
    ```

### Method 2: Direct URL

If your remote server is publicly accessible (e.g. `https://dev.example.com` or a specific IP), you can point Playwright directly to it.

```bash
PLAYWRIGHT_TEST_BASE_URL=https://dev.example.com npx playwright test
```

> **Note**: Ensure the remote server is running in a mode that accepts connections (e.g. `bun dev --host` or a preview build) and that any firewalls allow traffic on the target port.
