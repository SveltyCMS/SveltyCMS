name: Unit, Integration & E2E Tests

on:
  push:
    branches: [main, next]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main, next]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # ------------------------------------------------------------------
  # 1. Unit Tests (Fastest, no server needed) - TEMPORARILY SKIPPED
  # ------------------------------------------------------------------
  unit-tests:
    name: âš¡ Unit Tests
    if: false # Temporarily skipped
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync || true # Best effort

      - name: Run Unit Tests
        run: bun run test:unit

  # ------------------------------------------------------------------
  # 2. Integration Tests (Requires Server + MongoDB)
  # ------------------------------------------------------------------
  integration-tests:
    name: ðŸ”Œ Integration Tests
    timeout-minutes: 15
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports: [27017:27017]
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DB_TYPE: mongodb
      DB_HOST: localhost
      DB_PORT: 27017
      DB_NAME: sveltycms_test
      DB_USER: admin
      DB_PASSWORD: admin
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Clean config
      - name: Clean config
        run: |
          rm -rf config/collections
          rm -f config/private.ts

      # Create private.test.ts (Expected by test runner/setup.test.ts to know what DB to use)
      - name: Create config/private.test.ts
        run: |
          cat > config/private.test.ts <<EOF
          export const privateEnv = {
            DB_TYPE: '${{ env.DB_TYPE }}',
            DB_HOST: '${{ env.DB_HOST }}',
            DB_PORT: ${{ env.DB_PORT }},
            DB_NAME: '${{ env.DB_NAME }}',
            DB_USER: '${{ env.DB_USER }}',
            DB_PASSWORD: '${{ env.DB_PASSWORD }}',
            JWT_SECRET_KEY: 'test_jwt_secret',
            ENCRYPTION_KEY: 'test_encryption_key',
            MULTI_TENANT: false
          } as const;
          EOF

      # Note: We do NOT create config/private.ts here.
      # We want the server to start in "Fresh Install" mode (Setup Wizard).
      # tests/bun/api/setup.test.ts will call the API to "install" the system and create private.ts.

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Build Production
        run: bun run build

      - name: Cleanup Port 4173
        run: |
          pkill -f "vite preview" || true
          fuser -k 4173/tcp 2>/dev/null || echo "Port 4173 is free"
        continue-on-error: true

      - name: Start Preview Server
        run: |
          nohup bun run preview > preview-integration.log 2>&1 &
          echo $! > preview.pid
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000
          curl -f http://localhost:4173 || (cat preview-integration.log; exit 1)

      # Phase 1: Run Setup Test (Installs the system via API)
      - name: ðŸŸ¢ Run Setup API Test
        run: bun test tests/bun/api/setup.test.ts
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      # Phase 2: Run Integration Tests (System is now installed)
      # Verified passing tests - add more as they pass CI
      - name: ðŸ§ª Run Main Integration Suite
        run: |
          bun test \
            tests/bun/api/telemetry.test.ts \
            tests/bun/api/collections.test.ts \
            tests/bun/api/dashboard.test.ts \
            tests/bun/api/security.test.ts \
            tests/bun/api/settings.test.ts \
            tests/bun/api/system.test.ts \
            tests/bun/api/theme.test.ts \
            tests/bun/api/widgets.test.ts \
            tests/bun/databases/auth-system.test.ts \
            tests/bun/databases/cache-integration.test.ts \
            tests/bun/databases/db-interface.test.ts \
            tests/bun/databases/mongodb-adapter.test.ts \
            tests/bun/databases/resilience-load.test.ts \
            tests/bun/api/media.test.ts \
            tests/bun/api/user.test.ts \
            tests/bun/api/graphql.test.ts \
            tests/bun/api/auth-2fa.test.ts
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      - name: Upload Integration Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-server-logs
          path: preview-integration.log
          retention-days: 7
