name: Unit, Integration & E2E Tests

on:
  push:
    branches: [main, next]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main, next]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # ------------------------------------------------------------------
  # 2. Build (Single build, shared by all integration/E2E tests)
  # ------------------------------------------------------------------
  build:
    name: ðŸ—ï¸ Build Production
#    needs: unit-tests
    timeout-minutes: 10
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Build Production
        run: bun run build

      # Upload build artifacts for integration/E2E tests
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: sveltycms-build
          path: |
            .svelte-kit/output
            build
            package.json
            bun.lock
          retention-days: 1

  # ------------------------------------------------------------------
  # 3. Integration Tests - MongoDB
  # ------------------------------------------------------------------
  integration-tests-mongodb:
    name: ðŸ”Œ Integration (MongoDB)
    needs: build
    timeout-minutes: 15
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports: [27017:27017]
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mailhog:
        image: mailhog/mailhog:latest
        ports:
          - 1025:1025
          - 8025:8025
    env:
      DB_TYPE: mongodb
      DB_HOST: 127.0.0.1
      DB_PORT: 27017
      DB_NAME: sveltycms_test
      DB_USER: admin
      DB_PASSWORD: admin
      SMTP_HOST: localhost
      SMTP_PORT: 1025
      SMTP_MAIL_FROM: test@sveltycms.local
      SMTP_SECURE: 'false'
      NODE_ENV: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Wait for MongoDB
        run: |
          attempt=0
          until [ $attempt -ge 10 ]
          do
            docker exec ${{ job.services.mongodb.id }} mongosh \
              -u admin -p admin \
              --authenticationDatabase admin \
              --eval "db.adminCommand('ping')" && break
            attempt=$((attempt+1))
            echo "Waiting for MongoDB... ($attempt/10)"
            sleep 3
          done
          echo "MongoDB is ready, waiting 5 more seconds for full initialization..."
          sleep 5

      # Download pre-built artifact
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sveltycms-build

      - name: Clean config
        run: |
          rm -rf config/collections
          rm -f config/private.ts

      - name: Create config/private.ts
        run: |
          cat > config/private.ts <<EOF
          export const privateEnv = {
            DB_TYPE: '${{ env.DB_TYPE }}',
            DB_HOST: '${{ env.DB_HOST }}',
            DB_PORT: ${{ env.DB_PORT }},
            DB_NAME: '${{ env.DB_NAME }}',
            DB_USER: '${{ env.DB_USER }}',
            DB_PASSWORD: '${{ env.DB_PASSWORD }}',
            JWT_SECRET_KEY: 'test_jwt_secret',
            ENCRYPTION_KEY: 'test_encryption_key',
            MULTI_TENANT: false,
            SMTP_HOST: '${{ env.SMTP_HOST }}',
            SMTP_PORT: ${{ env.SMTP_PORT }},
            SMTP_USER: '${{ env.SMTP_USER }}',
            SMTP_PASS: '${{ env.SMTP_PASS }}',
            SMTP_MAIL_FROM: '${{ env.SMTP_MAIL_FROM }}',
            SMTP_SECURE: ${{ env.SMTP_SECURE }},
          } as const;
          EOF

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Cleanup Port 4173
        run: fuser -k 4173/tcp 2>/dev/null || echo "Port 4173 is free"
        continue-on-error: true

      - name: Start Preview Server
        run: |
          nohup bun run preview > preview.log 2>&1 &
          echo $! > preview.pid
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000
          curl -f http://localhost:4173 || (cat preview.log; exit 1)

      - name: ðŸŸ¢ Run Setup API Test
        run: bun test tests/bun/api/setup-actions.test.ts
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      - name: ðŸ§ª Run Integration Suite
        run: bun test $(find tests/bun/api -name "*.test.ts" ! -name "setup.test.ts") tests/bun/databases
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      - name: ðŸ§ª Run Hooks Tests
        run: bun run test:hooks
        env:
          TEST_MODE: 'true'

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mongodb-integration-logs
          path: preview.log
          retention-days: 7
