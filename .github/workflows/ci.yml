name: Unit, Integration & E2E Tests

on:
  push:
    branches: [main, next]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main, next]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # ------------------------------------------------------------------
  # 1. Unit Tests (Fastest, no server needed)
  # ------------------------------------------------------------------
  unit-tests:
    name: ‚ö° Unit Tests
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync || true

      - name: Run Unit Tests
        run: bun run test:unit

  # ------------------------------------------------------------------
  # 2. Build (Single build, shared by all integration/E2E tests)
  # ------------------------------------------------------------------
  build:
    name: üèóÔ∏è Build Production
    needs: unit-tests
    timeout-minutes: 10
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports: [27017:27017]
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Create minimal config for build (actual DB config injected at runtime)
      - name: Create build config
        run: |
          cat > config/private.ts <<EOF
          export const privateEnv = {
            DB_TYPE: 'mongodb',
            DB_HOST: 'localhost',
            DB_PORT: 27017,
            DB_NAME: 'sveltycms_build',
            DB_USER: 'admin',
            DB_PASSWORD: 'admin',
            JWT_SECRET_KEY: 'build_jwt_secret',
            ENCRYPTION_KEY: 'build_encryption_key_32b',
            MULTI_TENANT: false
          } as const;
          EOF

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Build Production
        run: bun run build

      - name: üîç Preview Smoke Test
        run: |
          nohup bun run preview --host > preview.log 2>&1 &
          echo $! > preview.pid
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000
          curl -f http://localhost:4173 || (cat preview.log; exit 1)
          kill $(cat preview.pid) || true
          rm preview.pid preview.log

      - name: Remove build config
        run: rm -f config/private.ts

      # Upload build artifacts for integration/E2E tests
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: sveltycms-build
          path: |
            .svelte-kit/output
            build
            package.json
            bun.lock
          retention-days: 1

  # ------------------------------------------------------------------
  # 3. Integration Tests - MongoDB
  # ------------------------------------------------------------------
  integration-tests-mongodb:
    name: üîå Integration (MongoDB)
    needs: build
    timeout-minutes: 15
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports: [27017:27017]
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mailhog:
        image: mailhog/mailhog:latest
        ports:
          - 1025:1025
          - 8025:8025
    env:
      DB_TYPE: mongodb
      DB_HOST: localhost
      DB_PORT: 27017
      DB_NAME: sveltycms_test
      DB_USER: admin
      DB_PASSWORD: admin
      SMTP_HOST: localhost
      SMTP_PORT: 1025
      SMTP_MAIL_FROM: test@sveltycms.local
      SMTP_SECURE: 'false'
      NODE_ENV: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Download pre-built artifact
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sveltycms-build

      - name: Clean config
        run: |
          rm -rf config/collections
          rm -f config/private.ts

      - name: Create config/private.test.ts
        run: |
          cat > config/private.test.ts <<EOF
          export const privateEnv = {
            DB_TYPE: '${{ env.DB_TYPE }}',
            DB_HOST: '${{ env.DB_HOST }}',
            DB_PORT: ${{ env.DB_PORT }},
            DB_NAME: '${{ env.DB_NAME }}',
            DB_USER: '${{ env.DB_USER }}',
            DB_PASSWORD: '${{ env.DB_PASSWORD }}',
            JWT_SECRET_KEY: 'test_jwt_secret',
            ENCRYPTION_KEY: 'test_encryption_key',
            MULTI_TENANT: false,
            SMTP_HOST: '${{ env.SMTP_HOST }}',
            SMTP_PORT: ${{ env.SMTP_PORT }},
            SMTP_USER: '${{ env.SMTP_USER }}',
            SMTP_PASS: '${{ env.SMTP_PASS }}',
            SMTP_MAIL_FROM: '${{ env.SMTP_MAIL_FROM }}',
            SMTP_SECURE: ${{ env.SMTP_SECURE }},
          } as const;
          EOF

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Cleanup Port 4173
        run: fuser -k 4173/tcp 2>/dev/null || echo "Port 4173 is free"
        continue-on-error: true

      - name: Start Preview Server
        env:
          TEST_MODE: 'true'
        run: |
          nohup bun run preview > preview.log 2>&1 &
          echo $! > preview.pid
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000
          curl -f http://localhost:4173 || (cat preview.log; exit 1)

      - name: üü¢ Run Setup API Test
        run: bun test tests/bun/api/setup-actions.test.ts
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      - name: üß™ Run Integration Suite
        run: bun test $(find tests/bun/api -name "*.test.ts" ! -name "setup.test.ts" ! -name "setup-actions.test.ts") tests/bun/databases
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      - name: üß™ Run Hooks Tests
        run: bun run test:hooks
        env:
          TEST_MODE: 'true'

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mongodb-integration-logs
          path: preview.log
          retention-days: 7

  # ------------------------------------------------------------------
  # 4. Integration Tests - MariaDB (Beta)
  # ------------------------------------------------------------------
  integration-tests-mariadb:
    name: üîå Integration (MariaDB) [Beta]
    needs: build
    timeout-minutes: 15
    runs-on: ubuntu-latest
    services:
      mariadb:
        image: mariadb:11
        ports: [3306:3306]
        env:
          MARIADB_ROOT_PASSWORD: rootpass
          MARIADB_DATABASE: sveltycms_test
          MARIADB_USER: testuser
          MARIADB_PASSWORD: testpass
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DB_TYPE: mariadb
      DB_HOST: localhost
      DB_PORT: 3306
      DB_NAME: sveltycms_test
      DB_USER: testuser
      DB_PASSWORD: testpass
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sveltycms-build

      - name: Clean config
        run: |
          rm -rf config/collections
          rm -f config/private.ts

      - name: Create config files
        run: |
          cat > config/private.test.ts <<EOF
          export const privateEnv = {
            DB_TYPE: '${{ env.DB_TYPE }}',
            DB_HOST: '${{ env.DB_HOST }}',
            DB_PORT: ${{ env.DB_PORT }},
            DB_NAME: '${{ env.DB_NAME }}',
            DB_USER: '${{ env.DB_USER }}',
            DB_PASSWORD: '${{ env.DB_PASSWORD }}',
            JWT_SECRET_KEY: 'test_jwt_secret',
            ENCRYPTION_KEY: 'test_encryption_key',
            MULTI_TENANT: false
          } as const;
          EOF
          cp config/private.test.ts config/private.ts

      - name: Wait for MariaDB
        run: |
          for i in {1..30}; do
            if nc -z localhost 3306 2>/dev/null; then
              echo "‚úÖ MariaDB ready"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Cleanup Port 4173
        run: lsof -ti:4173 | xargs kill -9 2>/dev/null || true

      - name: Start Preview Server
        env:
          TEST_MODE: 'true'
        run: |
          nohup bun run preview > preview.log 2>&1 &
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000

      - name: Run Integration Tests
        run: bun run test:integration:run
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mariadb-integration-logs
          path: preview.log
          retention-days: 7

  # ------------------------------------------------------------------
  # 5. Integration Tests - PostgreSQL (Beta)
  # ------------------------------------------------------------------
  integration-tests-postgresql:
    name: üîå Integration (PostgreSQL) [Beta]
    needs: build
    timeout-minutes: 15
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports: [5432:5432]
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: sveltycms_test
        options: >-
          --health-cmd="pg_isready -U testuser -d sveltycms_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DB_TYPE: postgresql
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: sveltycms_test
      DB_USER: testuser
      DB_PASSWORD: testpass
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sveltycms-build

      - name: Clean config
        run: |
          rm -rf config/collections
          rm -f config/private.ts

      - name: Create config files
        run: |
          cat > config/private.test.ts <<EOF
          export const privateEnv = {
            DB_TYPE: '${{ env.DB_TYPE }}',
            DB_HOST: '${{ env.DB_HOST }}',
            DB_PORT: ${{ env.DB_PORT }},
            DB_NAME: '${{ env.DB_NAME }}',
            DB_USER: '${{ env.DB_USER }}',
            DB_PASSWORD: '${{ env.DB_PASSWORD }}',
            JWT_SECRET_KEY: 'test_jwt_secret',
            ENCRYPTION_KEY: 'test_encryption_key',
            MULTI_TENANT: false
          } as const;
          EOF
          cp config/private.test.ts config/private.ts

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if nc -z localhost 5432 2>/dev/null; then
              echo "‚úÖ PostgreSQL ready"
              sleep 2
              break
            fi
            sleep 1
          done

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Cleanup Port 4173
        run: lsof -ti:4173 | xargs kill -9 2>/dev/null || true

      - name: Start Preview Server
        env:
          TEST_MODE: 'true'
        run: |
          nohup bun run preview > preview.log 2>&1 &
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000

      - name: Run Integration Tests
        run: bun run test:integration:run
        env:
          TEST_MODE: 'true'
          API_BASE_URL: 'http://localhost:4173'

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: postgresql-integration-logs
          path: preview.log
          retention-days: 7

  # ------------------------------------------------------------------
  # 6. E2E Tests - MongoDB
  # ------------------------------------------------------------------
  e2e-tests-mongodb:
    name: üé≠ E2E (MongoDB)
    needs: build
    timeout-minutes: 30
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports: [27017:27017]
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DB_TYPE: mongodb
      DB_HOST: localhost
      DB_PORT: 27017
      DB_NAME: sveltycms_test
      DB_USER: admin
      DB_PASSWORD: admin
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sveltycms-build

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(bun x playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps chromium

      - name: Install jq
        run: sudo apt-get install -y -qq jq

      - name: Remove config
        run: rm -f config/private.ts

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Cleanup Port 4173
        run: fuser -k 4173/tcp 2>/dev/null || true
        continue-on-error: true

      - name: Start Preview Server
        env:
          TEST_MODE: 'true'
        run: |
          nohup bun run preview > preview.log 2>&1 &
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000

      - name: üßô‚Äç‚ôÇÔ∏è Run Setup Wizard
        run: bunx playwright test tests/playwright/setup-wizard.spec.ts --project=chromium --reporter=list
        env:
          ADMIN_EMAIL: admin@example.com
          ADMIN_PASS: Admin123!

      - name: ‚è≥ Wait for Seeding
        run: |
          for i in {1..30}; do
            STATUS=$(curl -s http://localhost:4173/api/setup/status || echo '{"isSeeding":true}')
            IS_SEEDING=$(echo $STATUS | jq -r '.isSeeding // true')
            [ "$IS_SEEDING" = "false" ] && break
            sleep 2
          done

      - name: üîê Run RBAC Tests
        run: bunx playwright test tests/playwright/role-based-access.spec.ts --project=chromium --reporter=list

      - name: üß™ Run Main E2E Suite
        run: bunx playwright test --project=chromium --reporter=list --grep-invert "setup-wizard|role-based"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-mongodb
          path: playwright-report/
          retention-days: 14

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mongodb-e2e-logs
          path: preview.log
          retention-days: 7

  # ------------------------------------------------------------------
  # 7. E2E Tests - MariaDB
  # ------------------------------------------------------------------
  e2e-tests-mariadb:
    name: üé≠ E2E (MariaDB) [Beta]
    needs: build
    timeout-minutes: 30
    runs-on: ubuntu-latest
    services:
      mariadb:
        image: mariadb:11
        ports: [3306:3306]
        env:
          MARIADB_ROOT_PASSWORD: rootpass
          MARIADB_DATABASE: sveltycms_test
          MARIADB_USER: testuser
          MARIADB_PASSWORD: testpass
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DB_TYPE: mariadb
      DB_HOST: localhost
      DB_PORT: 3306
      DB_NAME: sveltycms_test
      DB_USER: testuser
      DB_PASSWORD: testpass
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sveltycms-build

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(bun x playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps chromium

      - name: Install jq
        run: sudo apt-get install -y -qq jq

      - name: Create config
        run: |
          cat > config/private.ts <<EOF
          export const privateEnv = {
            DB_TYPE: '${{ env.DB_TYPE }}',
            DB_HOST: '${{ env.DB_HOST }}',
            DB_PORT: ${{ env.DB_PORT }},
            DB_NAME: '${{ env.DB_NAME }}',
            DB_USER: '${{ env.DB_USER }}',
            DB_PASSWORD: '${{ env.DB_PASSWORD }}',
            JWT_SECRET_KEY: 'test_jwt_secret',
            ENCRYPTION_KEY: 'test_encryption_key',
            MULTI_TENANT: false
          } as const;
          EOF

      - name: Wait for MariaDB
        run: |
          for i in {1..30}; do
            nc -z localhost 3306 2>/dev/null && break
            sleep 1
          done

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Cleanup Port 4173
        run: lsof -ti:4173 | xargs kill -9 2>/dev/null || true

      - name: Start Preview Server
        run: |
          nohup bun run preview > preview.log 2>&1 &
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000

      - name: üßô‚Äç‚ôÇÔ∏è Run Setup Wizard
        run: bunx playwright test tests/playwright/setup-wizard.spec.ts --project=chromium --reporter=list
        env:
          ADMIN_EMAIL: admin@example.com
          ADMIN_PASS: Admin123!
          DB_TYPE: mariadb

      - name: ‚è≥ Wait for Seeding
        run: |
          for i in {1..30}; do
            STATUS=$(curl -s http://localhost:4173/api/setup/status || echo '{"isSeeding":true}')
            IS_SEEDING=$(echo $STATUS | jq -r '.isSeeding // true')
            [ "$IS_SEEDING" = "false" ] && break
            sleep 2
          done

      - name: üîê Run RBAC Tests
        run: bunx playwright test tests/playwright/role-based-access.spec.ts --project=chromium --reporter=list

      - name: üß™ Run Main E2E Suite
        run: bunx playwright test --project=chromium --reporter=list --grep-invert "setup-wizard|role-based"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-mariadb
          path: playwright-report/
          retention-days: 14

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mariadb-e2e-logs
          path: preview.log
          retention-days: 7

  # ------------------------------------------------------------------
  # 8. E2E Tests - PostgreSQL (Beta)
  # ------------------------------------------------------------------
  e2e-tests-postgresql:
    name: üé≠ E2E (PostgreSQL) [Beta]
    needs: build
    timeout-minutes: 30
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports: [5432:5432]
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: sveltycms_test
        options: >-
          --health-cmd="pg_isready -U testuser -d sveltycms_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DB_TYPE: postgresql
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: sveltycms_test
      DB_USER: testuser
      DB_PASSWORD: testpass
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: sveltycms-build

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(bun x playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps chromium

      - name: Install jq
        run: sudo apt-get install -y -qq jq

      - name: Create config
        run: |
          cat > config/private.ts <<EOF
          export const privateEnv = {
            DB_TYPE: '${{ env.DB_TYPE }}',
            DB_HOST: '${{ env.DB_HOST }}',
            DB_PORT: ${{ env.DB_PORT }},
            DB_NAME: '${{ env.DB_NAME }}',
            DB_USER: '${{ env.DB_USER }}',
            DB_PASSWORD: '${{ env.DB_PASSWORD }}',
            JWT_SECRET_KEY: 'test_jwt_secret',
            ENCRYPTION_KEY: 'test_encryption_key',
            MULTI_TENANT: false
          } as const;
          EOF

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            nc -z localhost 5432 2>/dev/null && break
            sleep 1
          done

      - name: Generate SvelteKit types
        run: bunx svelte-kit sync

      - name: Cleanup Port 4173
        run: lsof -ti:4173 | xargs kill -9 2>/dev/null || true

      - name: Start Preview Server
        run: |
          nohup bun run preview > preview.log 2>&1 &
          bun x wait-on http://localhost:4173 -t 90000 --interval 1000

      - name: üßô‚Äç‚ôÇÔ∏è Run Setup Wizard
        run: bunx playwright test tests/playwright/setup-wizard.spec.ts --project=chromium --reporter=list
        env:
          ADMIN_EMAIL: admin@example.com
          ADMIN_PASS: Admin123!
          DB_TYPE: postgresql

      - name: ‚è≥ Wait for Seeding
        run: |
          for i in {1..30}; do
            STATUS=$(curl -s http://localhost:4173/api/setup/status || echo '{"isSeeding":true}')
            IS_SEEDING=$(echo $STATUS | jq -r '.isSeeding // true')
            [ "$IS_SEEDING" = "false" ] && break
            sleep 2
          done

      - name: üîê Run RBAC Tests
        run: bunx playwright test tests/playwright/role-based-access.spec.ts --project=chromium --reporter=list

      - name: üß™ Run Main E2E Suite
        run: bunx playwright test --project=chromium --reporter=list --grep-invert "setup-wizard|role-based"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-postgresql
          path: playwright-report/
          retention-days: 14

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: postgresql-e2e-logs
          path: preview.log
          retention-days: 7
